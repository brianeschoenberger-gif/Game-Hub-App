import{T as B,R as ts,O as se,L as I,D as Ze,A as ns,a as Bn,b as ss,E as rs,M as z,V as os,c as S,d as Ue,e as $,f as Ie,S as Fn,C as Gn,g as $n,h as qt,i as Wt,j as F,k as de,l as Te,m as T,Q as Z,H as Dn,n as Yt,P as jt,o as _e,F as Gt,p as Vn,q as Pe,B as Je,r as as,s as M,t as is,G as Hn,u as ls,v as xn,w as cs,x as us,y as hs,_ as $t,z as ds,I as q,J as Ve,K as fs,N as ps,U as ms,W as ue,X as _s,Y as gs,Z as ys,$ as bs,a0 as As,a1 as Kn,a2 as wn,a3 as Ts,a4 as xs,a5 as ws,a6 as vs,a7 as Es,a8 as Bt,a9 as Cs,aa as Os,ab as Ns,ac as Is,ad as vn}from"./babylon-core-DLTSUY03.js";function Dt(s,e,t,n){const r={externalResourceFunction:n};return t&&(r.uri=e==="file:"?t:e+t),ArrayBuffer.isView(s)?GLTFValidator.validateBytes(s,r):GLTFValidator.validateString(s,r)}function Ss(){const s=[];onmessage=e=>{const t=e.data;switch(t.id){case"init":{importScripts(t.url);break}case"validate":{Dt(t.data,t.rootUrl,t.fileName,n=>new Promise((r,o)=>{const a=s.length;s.push({resolve:r,reject:o}),postMessage({id:"getExternalResource",index:a,uri:n})})).then(n=>{postMessage({id:"validate.resolve",value:n})},n=>{postMessage({id:"validate.reject",reason:n})});break}case"getExternalResource.resolve":{s[t.index].resolve(t.value);break}case"getExternalResource.reject":{s[t.index].reject(t.reason);break}}}}class Un{static ValidateAsync(e,t,n,r){return typeof Worker=="function"?new Promise((o,a)=>{const i=`${Dt}(${Ss})()`,l=URL.createObjectURL(new Blob([i],{type:"application/javascript"})),c=new Worker(l),u=d=>{c.removeEventListener("error",u),c.removeEventListener("message",h),a(d)},h=d=>{const f=d.data;switch(f.id){case"getExternalResource":{r(f.uri).then(m=>{c.postMessage({id:"getExternalResource.resolve",index:f.index,value:m},[m.buffer])},m=>{c.postMessage({id:"getExternalResource.reject",index:f.index,reason:m})});break}case"validate.resolve":{c.removeEventListener("error",u),c.removeEventListener("message",h),o(f.value),c.terminate();break}case"validate.reject":c.removeEventListener("error",u),c.removeEventListener("message",h),a(f.reason),c.terminate()}};if(c.addEventListener("error",u),c.addEventListener("message",h),c.postMessage({id:"init",url:B.GetBabylonScriptURL(this.Configuration.url)}),ArrayBuffer.isView(e)){const d=e.slice();c.postMessage({id:"validate",data:d,rootUrl:t,fileName:n},[d.buffer])}else c.postMessage({id:"validate",data:e,rootUrl:t,fileName:n})}):(this._LoadScriptPromise||(this._LoadScriptPromise=B.LoadBabylonScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then(()=>Dt(e,t,n,r)))}}Un.Configuration={url:`${B._DefaultCdnUrl}/gltf_validator.js`};const we="Z2xURg",Qe={name:"gltf",extensions:{".gltf":{isBinary:!1,mimeType:"model/gltf+json"},".glb":{isBinary:!0,mimeType:"model/gltf-binary"}},canDirectLoad(s){return s.indexOf("asset")!==-1&&s.indexOf("version")!==-1||s.startsWith("data:base64,"+we)||s.startsWith("data:;base64,"+we)||s.startsWith("data:application/octet-stream;base64,"+we)||s.startsWith("data:model/gltf-binary;base64,"+we)}};function En(s,e,t){try{return Promise.resolve(new Uint8Array(s,e,t))}catch(n){return Promise.reject(n)}}function Ms(s,e,t){try{if(e<0||e>=s.byteLength)throw new RangeError("Offset is out of range.");if(e+t>s.byteLength)throw new RangeError("Length is out of range.");return Promise.resolve(new Uint8Array(s.buffer,s.byteOffset+e,t))}catch(n){return Promise.reject(n)}}var qe;(function(s){s[s.AUTO=0]="AUTO",s[s.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED"})(qe||(qe={}));var ke;(function(s){s[s.NONE=0]="NONE",s[s.FIRST=1]="FIRST",s[s.ALL=2]="ALL"})(ke||(ke={}));var ie;(function(s){s[s.LOADING=0]="LOADING",s[s.READY=1]="READY",s[s.COMPLETE=2]="COMPLETE"})(ie||(ie={}));class ks{constructor(){this.coordinateSystemMode=qe.AUTO,this.animationStartMode=ke.FIRST,this.loadNodeAnimations=!0,this.loadSkins=!0,this.loadMorphTargets=!0,this.compileMaterials=!1,this.useClipPlane=!1,this.compileShadowGenerators=!1,this.transparencyAsCoverage=!1,this.useRangeRequests=!1,this.createInstances=!0,this.alwaysComputeBoundingBox=!1,this.loadAllMaterials=!1,this.loadOnlyMaterials=!1,this.skipMaterials=!1,this.useSRGBBuffers=!0,this.targetFps=60,this.alwaysComputeSkeletonRootNode=!1,this.useGltfTextureNames=!1,this.preprocessUrlAsync=e=>Promise.resolve(e),this.extensionOptions={}}copyFrom(e){e&&(this.onParsed=e.onParsed,this.coordinateSystemMode=e.coordinateSystemMode??this.coordinateSystemMode,this.animationStartMode=e.animationStartMode??this.animationStartMode,this.loadNodeAnimations=e.loadNodeAnimations??this.loadNodeAnimations,this.loadSkins=e.loadSkins??this.loadSkins,this.loadMorphTargets=e.loadMorphTargets??this.loadMorphTargets,this.compileMaterials=e.compileMaterials??this.compileMaterials,this.useClipPlane=e.useClipPlane??this.useClipPlane,this.compileShadowGenerators=e.compileShadowGenerators??this.compileShadowGenerators,this.transparencyAsCoverage=e.transparencyAsCoverage??this.transparencyAsCoverage,this.useRangeRequests=e.useRangeRequests??this.useRangeRequests,this.createInstances=e.createInstances??this.createInstances,this.alwaysComputeBoundingBox=e.alwaysComputeBoundingBox??this.alwaysComputeBoundingBox,this.loadAllMaterials=e.loadAllMaterials??this.loadAllMaterials,this.loadOnlyMaterials=e.loadOnlyMaterials??this.loadOnlyMaterials,this.skipMaterials=e.skipMaterials??this.skipMaterials,this.useSRGBBuffers=e.useSRGBBuffers??this.useSRGBBuffers,this.targetFps=e.targetFps??this.targetFps,this.alwaysComputeSkeletonRootNode=e.alwaysComputeSkeletonRootNode??this.alwaysComputeSkeletonRootNode,this.useGltfTextureNames=e.useGltfTextureNames??this.useGltfTextureNames,this.preprocessUrlAsync=e.preprocessUrlAsync??this.preprocessUrlAsync,this.customRootNode=e.customRootNode,this.onMeshLoaded=e.onMeshLoaded,this.onSkinLoaded=e.onSkinLoaded,this.onTextureLoaded=e.onTextureLoaded,this.onMaterialLoaded=e.onMaterialLoaded,this.onCameraLoaded=e.onCameraLoaded,this.extensionOptions=e.extensionOptions??this.extensionOptions)}}class X extends ks{constructor(e){super(),this.onParsedObservable=new se,this.onMeshLoadedObservable=new se,this.onSkinLoadedObservable=new se,this.onTextureLoadedObservable=new se,this.onMaterialLoadedObservable=new se,this.onCameraLoadedObservable=new se,this.onCompleteObservable=new se,this.onErrorObservable=new se,this.onDisposeObservable=new se,this.onExtensionLoadedObservable=new se,this.validate=!1,this.onValidatedObservable=new se,this._loader=null,this._state=null,this._requests=new Array,this.name=Qe.name,this.extensions=Qe.extensions,this.onLoaderStateChangedObservable=new se,this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled,this.copyFrom(e)}set onParsed(e){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),e&&(this._onParsedObserver=this.onParsedObservable.add(e))}set onMeshLoaded(e){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),e&&(this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(e))}set onSkinLoaded(e){this._onSkinLoadedObserver&&this.onSkinLoadedObservable.remove(this._onSkinLoadedObserver),e&&(this._onSkinLoadedObserver=this.onSkinLoadedObservable.add(t=>e(t.node,t.skinnedNode)))}set onTextureLoaded(e){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),e&&(this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(e))}set onMaterialLoaded(e){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),e&&(this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(e))}set onCameraLoaded(e){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),e&&(this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(e))}set onComplete(e){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(e)}set onError(e){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(e)}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set onExtensionLoaded(e){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(e)}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled!==e&&(this._loggingEnabled=e,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled)}get capturePerformanceCounters(){return this._capturePerformanceCounters}set capturePerformanceCounters(e){this._capturePerformanceCounters!==e&&(this._capturePerformanceCounters=e,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))}set onValidated(e){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(e)}dispose(){this._loader&&(this._loader.dispose(),this._loader=null);for(const e of this._requests)e.abort();this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable.clear(),this.onSkinLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()}loadFile(e,t,n,r,o,a,i,l){if(ArrayBuffer.isView(t))return this._loadBinary(e,t,n,r,i,l),null;this._progressCallback=o;const c=t.name||B.GetFilename(t);if(a){if(this.useRangeRequests){this.validate&&I.Warn("glTF validation is not supported when range requests are enabled");const u={abort:()=>{},onCompleteObservable:new se},h={readAsync:(d,f)=>new Promise((m,b)=>{this._loadFile(e,t,E=>{m(new Uint8Array(E))},!0,E=>{b(E)},E=>{E.setRequestHeader("Range",`bytes=${d}-${d+f-1}`)})}),byteLength:0};return this._unpackBinaryAsync(new Ze(h)).then(d=>{u.onCompleteObservable.notifyObservers(u),r(d)},i?d=>i(void 0,d):void 0),u}return this._loadFile(e,t,u=>{this._validate(e,new Uint8Array(u,0,u.byteLength),n,c),this._unpackBinaryAsync(new Ze({readAsync:(h,d)=>En(u,h,d),byteLength:u.byteLength})).then(h=>{r(h)},i?h=>i(void 0,h):void 0)},!0,i)}else return this._loadFile(e,t,u=>{try{this._validate(e,u,n,c),r({json:this._parseJson(u)})}catch{i&&i()}},!1,i)}_loadBinary(e,t,n,r,o,a){this._validate(e,new Uint8Array(t.buffer,t.byteOffset,t.byteLength),n,a),this._unpackBinaryAsync(new Ze({readAsync:(i,l)=>Ms(t,i,l),byteLength:t.byteLength})).then(i=>{r(i)},o?i=>o(void 0,i):void 0)}importMeshAsync(e,t,n,r,o,a){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(n),this.onParsedObservable.clear(),this._log(`Loading ${a||""}`),this._loader=this._getLoader(n),this._loader.importMeshAsync(e,t,null,n,r,o,a)))}loadAsync(e,t,n,r,o){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${o||""}`),this._loader=this._getLoader(t),this._loader.loadAsync(e,t,n,r,o)))}loadAssetContainerAsync(e,t,n,r,o){return Promise.resolve().then(()=>{this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${o||""}`),this._loader=this._getLoader(t);const a=new ns(e),i=[];this.onMaterialLoadedObservable.add(h=>{i.push(h)});const l=[];this.onTextureLoadedObservable.add(h=>{l.push(h)});const c=[];this.onCameraLoadedObservable.add(h=>{c.push(h)});const u=[];return this.onMeshLoadedObservable.add(h=>{h.morphTargetManager&&u.push(h.morphTargetManager)}),this._loader.importMeshAsync(null,e,a,t,n,r,o).then(h=>(Array.prototype.push.apply(a.geometries,h.geometries),Array.prototype.push.apply(a.meshes,h.meshes),Array.prototype.push.apply(a.particleSystems,h.particleSystems),Array.prototype.push.apply(a.skeletons,h.skeletons),Array.prototype.push.apply(a.animationGroups,h.animationGroups),Array.prototype.push.apply(a.materials,i),Array.prototype.push.apply(a.textures,l),Array.prototype.push.apply(a.lights,h.lights),Array.prototype.push.apply(a.transformNodes,h.transformNodes),Array.prototype.push.apply(a.cameras,c),Array.prototype.push.apply(a.morphTargetManagers,u),a))})}canDirectLoad(e){return Qe.canDirectLoad(e)}directLoad(e,t){if(t.startsWith("base64,"+we)||t.startsWith(";base64,"+we)||t.startsWith("application/octet-stream;base64,"+we)||t.startsWith("model/gltf-binary;base64,"+we)){const n=Bn(t);return this._validate(e,new Uint8Array(n,0,n.byteLength)),this._unpackBinaryAsync(new Ze({readAsync:(r,o)=>En(n,r,o),byteLength:n.byteLength}))}return this._validate(e,t),Promise.resolve({json:this._parseJson(t)})}createPlugin(e){return new X(e[Qe.name])}get loaderState(){return this._state}whenCompleteAsync(){return new Promise((e,t)=>{this.onCompleteObservable.addOnce(()=>{e()}),this.onErrorObservable.addOnce(n=>{t(n)})})}_setState(e){this._state!==e&&(this._state=e,this.onLoaderStateChangedObservable.notifyObservers(this._state),this._log(ie[this._state]))}_loadFile(e,t,n,r,o,a){const i=e._loadFile(t,n,l=>{this._onProgress(l,i)},!0,r,o,a);return i.onCompleteObservable.add(()=>{i._lengthComputable=!0,i._total=i._loaded}),this._requests.push(i),i}_onProgress(e,t){if(!this._progressCallback)return;t._lengthComputable=e.lengthComputable,t._loaded=e.loaded,t._total=e.total;let n=!0,r=0,o=0;for(const a of this._requests){if(a._lengthComputable===void 0||a._loaded===void 0||a._total===void 0)return;n=n&&a._lengthComputable,r+=a._loaded,o+=a._total}this._progressCallback({lengthComputable:n,loaded:r,total:n?o:0})}_validate(e,t,n="",r=""){this.validate&&(this._startPerformanceCounter("Validate JSON"),Un.ValidateAsync(t,n,r,o=>this.preprocessUrlAsync(n+o).then(a=>e._loadFileAsync(a,void 0,!0,!0).then(i=>new Uint8Array(i,0,i.byteLength)))).then(o=>{this._endPerformanceCounter("Validate JSON"),this.onValidatedObservable.notifyObservers(o),this.onValidatedObservable.clear()},o=>{this._endPerformanceCounter("Validate JSON"),B.Warn(`Failed to validate: ${o.message}`),this.onValidatedObservable.clear()}))}_getLoader(e){const t=e.json.asset||{};this._log(`Asset version: ${t.version}`),t.minVersion&&this._log(`Asset minimum version: ${t.minVersion}`),t.generator&&this._log(`Asset generator: ${t.generator}`);const n=X._parseVersion(t.version);if(!n)throw new Error("Invalid version: "+t.version);if(t.minVersion!==void 0){const a=X._parseVersion(t.minVersion);if(!a)throw new Error("Invalid minimum version: "+t.minVersion);if(X._compareVersion(a,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+t.minVersion)}const o={1:X._CreateGLTF1Loader,2:X._CreateGLTF2Loader}[n.major];if(!o)throw new Error("Unsupported version: "+t.version);return o(this)}_parseJson(e){this._startPerformanceCounter("Parse JSON"),this._log(`JSON length: ${e.length}`);const t=JSON.parse(e);return this._endPerformanceCounter("Parse JSON"),t}_unpackBinaryAsync(e){return this._startPerformanceCounter("Unpack Binary"),e.loadAsync(20).then(()=>{const t={Magic:1179937895},n=e.readUint32();if(n!==t.Magic)throw new ss("Unexpected magic: "+n,rs.GLTFLoaderUnexpectedMagicError);const r=e.readUint32();this.loggingEnabled&&this._log(`Binary version: ${r}`);const o=e.readUint32();!this.useRangeRequests&&o!==e.buffer.byteLength&&I.Warn(`Length in header does not match actual data length: ${o} != ${e.buffer.byteLength}`);let a;switch(r){case 1:{a=this._unpackBinaryV1Async(e,o);break}case 2:{a=this._unpackBinaryV2Async(e,o);break}default:throw new Error("Unsupported version: "+r)}return this._endPerformanceCounter("Unpack Binary"),a})}_unpackBinaryV1Async(e,t){const n={JSON:0},r=e.readUint32(),o=e.readUint32();if(o!==n.JSON)throw new Error(`Unexpected content format: ${o}`);const a=t-e.byteOffset,i={json:this._parseJson(e.readString(r)),bin:null};if(a!==0){const l=e.byteOffset;i.bin={readAsync:(c,u)=>e.buffer.readAsync(l+c,u),byteLength:a}}return Promise.resolve(i)}_unpackBinaryV2Async(e,t){const n={JSON:1313821514,BIN:5130562},r=e.readUint32();if(e.readUint32()!==n.JSON)throw new Error("First chunk format is not JSON");return e.byteOffset+r===t?e.loadAsync(r).then(()=>({json:this._parseJson(e.readString(r)),bin:null})):e.loadAsync(r+8).then(()=>{const a={json:this._parseJson(e.readString(r)),bin:null},i=()=>{const l=e.readUint32();switch(e.readUint32()){case n.JSON:throw new Error("Unexpected JSON chunk");case n.BIN:{const u=e.byteOffset;a.bin={readAsync:(h,d)=>e.buffer.readAsync(u+h,d),byteLength:l},e.skipBytes(l);break}default:{e.skipBytes(l);break}}return e.byteOffset!==t?e.loadAsync(8).then(i):Promise.resolve(a)};return i()})}static _parseVersion(e){if(e==="1.0"||e==="1.0.1")return{major:1,minor:0};const t=(e+"").match(/^(\d+)\.(\d+)/);return t?{major:parseInt(t[1]),minor:parseInt(t[2])}:null}static _compareVersion(e,t){return e.major>t.major?1:e.major<t.major?-1:e.minor>t.minor?1:e.minor<t.minor?-1:0}_logOpen(e){this._log(e),this._logIndentLevel++}_logClose(){--this._logIndentLevel}_logEnabled(e){const t=X._logSpaces.substring(0,this._logIndentLevel*2);I.Log(`${t}${e}`)}_logDisabled(e){}_startPerformanceCounterEnabled(e){B.StartPerformanceCounter(e)}_startPerformanceCounterDisabled(e){}_endPerformanceCounterEnabled(e){B.EndPerformanceCounter(e)}_endPerformanceCounterDisabled(e){}}X.IncrementalLoading=!0;X.HomogeneousCoordinates=!1;X._logSpaces="                                ";ts(new X);var ve;(function(s){s[s.BYTE=5120]="BYTE",s[s.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",s[s.SHORT=5122]="SHORT",s[s.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",s[s.FLOAT=5126]="FLOAT"})(ve||(ve={}));var Vt;(function(s){s[s.FRAGMENT=35632]="FRAGMENT",s[s.VERTEX=35633]="VERTEX"})(Vt||(Vt={}));var ae;(function(s){s[s.BYTE=5120]="BYTE",s[s.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",s[s.SHORT=5122]="SHORT",s[s.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",s[s.INT=5124]="INT",s[s.UNSIGNED_INT=5125]="UNSIGNED_INT",s[s.FLOAT=5126]="FLOAT",s[s.FLOAT_VEC2=35664]="FLOAT_VEC2",s[s.FLOAT_VEC3=35665]="FLOAT_VEC3",s[s.FLOAT_VEC4=35666]="FLOAT_VEC4",s[s.INT_VEC2=35667]="INT_VEC2",s[s.INT_VEC3=35668]="INT_VEC3",s[s.INT_VEC4=35669]="INT_VEC4",s[s.BOOL=35670]="BOOL",s[s.BOOL_VEC2=35671]="BOOL_VEC2",s[s.BOOL_VEC3=35672]="BOOL_VEC3",s[s.BOOL_VEC4=35673]="BOOL_VEC4",s[s.FLOAT_MAT2=35674]="FLOAT_MAT2",s[s.FLOAT_MAT3=35675]="FLOAT_MAT3",s[s.FLOAT_MAT4=35676]="FLOAT_MAT4",s[s.SAMPLER_2D=35678]="SAMPLER_2D"})(ae||(ae={}));var He;(function(s){s[s.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",s[s.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",s[s.REPEAT=10497]="REPEAT"})(He||(He={}));var pe;(function(s){s[s.NEAREST=9728]="NEAREST",s[s.LINEAR=9728]="LINEAR",s[s.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",s[s.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",s[s.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",s[s.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"})(pe||(pe={}));var Cn;(function(s){s[s.ALPHA=6406]="ALPHA",s[s.RGB=6407]="RGB",s[s.RGBA=6408]="RGBA",s[s.LUMINANCE=6409]="LUMINANCE",s[s.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA"})(Cn||(Cn={}));var Ht;(function(s){s[s.FRONT=1028]="FRONT",s[s.BACK=1029]="BACK",s[s.FRONT_AND_BACK=1032]="FRONT_AND_BACK"})(Ht||(Ht={}));var K;(function(s){s[s.ZERO=0]="ZERO",s[s.ONE=1]="ONE",s[s.SRC_COLOR=768]="SRC_COLOR",s[s.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",s[s.DST_COLOR=774]="DST_COLOR",s[s.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",s[s.SRC_ALPHA=770]="SRC_ALPHA",s[s.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",s[s.DST_ALPHA=772]="DST_ALPHA",s[s.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",s[s.CONSTANT_COLOR=32769]="CONSTANT_COLOR",s[s.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",s[s.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",s[s.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",s[s.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE"})(K||(K={}));class W{static SetMatrix(e,t,n,r,o){let a=null;if(n.semantic==="MODEL"?a=t.getWorldMatrix():n.semantic==="PROJECTION"?a=e.getProjectionMatrix():n.semantic==="VIEW"?a=e.getViewMatrix():n.semantic==="MODELVIEWINVERSETRANSPOSE"?a=z.Transpose(t.getWorldMatrix().multiply(e.getViewMatrix()).invert()):n.semantic==="MODELVIEW"?a=t.getWorldMatrix().multiply(e.getViewMatrix()):n.semantic==="MODELVIEWPROJECTION"?a=t.getWorldMatrix().multiply(e.getTransformMatrix()):n.semantic==="MODELINVERSE"?a=t.getWorldMatrix().invert():n.semantic==="VIEWINVERSE"?a=e.getViewMatrix().invert():n.semantic==="PROJECTIONINVERSE"?a=e.getProjectionMatrix().invert():n.semantic==="MODELVIEWINVERSE"?a=t.getWorldMatrix().multiply(e.getViewMatrix()).invert():n.semantic==="MODELVIEWPROJECTIONINVERSE"?a=t.getWorldMatrix().multiply(e.getTransformMatrix()).invert():n.semantic==="MODELINVERSETRANSPOSE"&&(a=z.Transpose(t.getWorldMatrix().invert())),a)switch(n.type){case ae.FLOAT_MAT2:o.setMatrix2x2(r,z.GetAsMatrix2x2(a));break;case ae.FLOAT_MAT3:o.setMatrix3x3(r,z.GetAsMatrix3x3(a));break;case ae.FLOAT_MAT4:o.setMatrix(r,a);break}}static SetUniform(e,t,n,r){switch(r){case ae.FLOAT:return e.setFloat(t,n),!0;case ae.FLOAT_VEC2:return e.setVector2(t,Ue.FromArray(n)),!0;case ae.FLOAT_VEC3:return e.setVector3(t,S.FromArray(n)),!0;case ae.FLOAT_VEC4:return e.setVector4(t,os.FromArray(n)),!0;default:return!1}}static GetWrapMode(e){switch(e){case He.CLAMP_TO_EDGE:return $.CLAMP_ADDRESSMODE;case He.MIRRORED_REPEAT:return $.MIRROR_ADDRESSMODE;case He.REPEAT:return $.WRAP_ADDRESSMODE;default:return $.WRAP_ADDRESSMODE}}static GetByteStrideFromType(e){switch(e.type){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}}static GetTextureFilterMode(e){switch(e){case pe.LINEAR:case pe.LINEAR_MIPMAP_NEAREST:case pe.LINEAR_MIPMAP_LINEAR:return $.TRILINEAR_SAMPLINGMODE;case pe.NEAREST:case pe.NEAREST_MIPMAP_NEAREST:return $.NEAREST_SAMPLINGMODE;default:return $.BILINEAR_SAMPLINGMODE}}static GetBufferFromBufferView(e,t,n,r,o){n=t.byteOffset+n;const a=e.loadedBufferViews[t.buffer];if(n+r>a.byteLength)throw new Error("Buffer access is out of range");const i=a.buffer;switch(n+=a.byteOffset,o){case ve.BYTE:return new Int8Array(i,n,r);case ve.UNSIGNED_BYTE:return new Uint8Array(i,n,r);case ve.SHORT:return new Int16Array(i,n,r);case ve.UNSIGNED_SHORT:return new Uint16Array(i,n,r);default:return new Float32Array(i,n,r)}}static GetBufferFromAccessor(e,t){const n=e.bufferViews[t.bufferView],r=t.count*W.GetByteStrideFromType(t);return W.GetBufferFromBufferView(e,n,t.byteOffset,r,t.componentType)}static DecodeBufferToText(e){let t="";const n=e.byteLength;for(let r=0;r<n;++r)t+=String.fromCharCode(e[r]);return t}static GetDefaultMaterial(e){if(!W._DefaultMaterial){Ie.ShadersStore.GLTFDefaultMaterialVertexShader=["precision highp float;","","uniform mat4 worldView;","uniform mat4 projection;","","attribute vec3 position;","","void main(void)","{","    gl_Position = projection * worldView * vec4(position, 1.0);","}"].join(`
`),Ie.ShadersStore.GLTFDefaultMaterialPixelShader=["precision highp float;","","uniform vec4 u_emission;","","void main(void)","{","    gl_FragColor = u_emission;","}"].join(`
`);const t={vertex:"GLTFDefaultMaterial",fragment:"GLTFDefaultMaterial"},n={attributes:["position"],uniforms:["worldView","projection","u_emission"],samplers:new Array,needAlphaBlending:!1};W._DefaultMaterial=new Fn("GLTFDefaultMaterial",e,t,n),W._DefaultMaterial.setColor4("u_emission",new Gn(.5,.5,.5,1))}return W._DefaultMaterial}}W._DefaultMaterial=null;var Ee;(function(s){s[s.IDENTIFIER=1]="IDENTIFIER",s[s.UNKNOWN=2]="UNKNOWN",s[s.END_OF_INPUT=3]="END_OF_INPUT"})(Ee||(Ee={}));class On{constructor(e){this._pos=0,this.currentToken=Ee.UNKNOWN,this.currentIdentifier="",this.currentString="",this.isLetterOrDigitPattern=/^[a-zA-Z0-9]+$/,this._toParse=e,this._maxPos=e.length}getNextToken(){if(this.isEnd())return Ee.END_OF_INPUT;if(this.currentString=this.read(),this.currentToken=Ee.UNKNOWN,this.currentString==="_"||this.isLetterOrDigitPattern.test(this.currentString))for(this.currentToken=Ee.IDENTIFIER,this.currentIdentifier=this.currentString;!this.isEnd()&&(this.isLetterOrDigitPattern.test(this.currentString=this.peek())||this.currentString==="_");)this.currentIdentifier+=this.currentString,this.forward();return this.currentToken}peek(){return this._toParse[this._pos]}read(){return this._toParse[this._pos++]}forward(){this._pos++}isEnd(){return this._pos>=this._maxPos}}const qn=["MODEL","VIEW","PROJECTION","MODELVIEW","MODELVIEWPROJECTION","JOINTMATRIX"],Wn=["world","view","projection","worldView","worldViewProjection","mBones"],Ps=["translation","rotation","scale"],Ls=["position","rotationQuaternion","scaling"],Rs=(s,e)=>{for(const t in s){const n=s[t];e.buffers[t]=n,e.buffersCount++}},Bs=(s,e)=>{for(const t in s){const n=s[t];e.shaders[t]=n,e.shaderscount++}},ne=(s,e,t)=>{for(const n in s){const r=s[n];t[e][n]=r}},Fs=s=>{if(s)for(let e=0;e<s.length/2;e++)s[e*2+1]=1-s[e*2+1]},Nn=s=>{if(s.semantic==="NORMAL")return"normal";if(s.semantic==="POSITION")return"position";if(s.semantic==="JOINT")return"matricesIndices";if(s.semantic==="WEIGHT")return"matricesWeights";if(s.semantic==="COLOR")return"color";if(s.semantic&&s.semantic.indexOf("TEXCOORD_")!==-1){const e=Number(s.semantic.split("_")[1]);return"uv"+(e===0?"":e+1)}return null},Gs=s=>{for(const e in s.animations){const t=s.animations[e];if(!t.channels||!t.samplers)continue;let n=null;for(let r=0;r<t.channels.length;r++){const o=t.channels[r],a=t.samplers[o.sampler];if(!a)continue;let i=null,l=null;t.parameters?(i=t.parameters[a.input],l=t.parameters[a.output]):(i=a.input,l=a.output);const c=W.GetBufferFromAccessor(s,s.accessors[i]),u=W.GetBufferFromAccessor(s,s.accessors[l]),h=o.target.id;let d=s.scene.getNodeById(h);if(d===null&&(d=s.scene.getNodeByName(h)),d===null){B.Warn("Creating animation named "+e+". But cannot find node named "+h+" to attach to");continue}const f=d instanceof Je;let m=o.target.path;const b=Ps.indexOf(m);b!==-1&&(m=Ls[b]);let E=T.ANIMATIONTYPE_MATRIX;f||(m==="rotationQuaternion"?(E=T.ANIMATIONTYPE_QUATERNION,d.rotationQuaternion=new Z):E=T.ANIMATIONTYPE_VECTOR3);let v=null;const D=[];let k=0,N=!1;f&&n&&n.getKeys().length===c.length&&(v=n,N=!0),N||(s.scene._blockEntityCollection=!!s.assetContainer,v=new T(e,f?"_matrix":m,1,E,T.ANIMATIONLOOPMODE_CYCLE),s.scene._blockEntityCollection=!1);for(let w=0;w<c.length;w++){let C=null;if(m==="rotationQuaternion"?(C=Z.FromArray([u[k],u[k+1],u[k+2],u[k+3]]),k+=4):(C=S.FromArray([u[k],u[k+1],u[k+2]]),k+=3),f){const x=d;let O=S.Zero(),V=new Z,H=S.Zero(),U=x.getBaseMatrix();N&&n&&(U=n.getKeys()[w].value),U.decompose(H,V,O),m==="position"?O=C:m==="rotationQuaternion"?V=C:H=C,C=z.Compose(H,V,O)}N?n&&(n.getKeys()[w].value=C):D.push({frame:c[w],value:C})}!N&&v&&(v.setKeys(D),d.animations.push(v)),n=v,s.scene.stopAnimation(d),s.scene.beginAnimation(d,0,c[c.length-1],!0,1)}}},Jt=s=>{let e=null;if(s.translation||s.rotation||s.scale){const t=S.FromArray(s.scale||[1,1,1]),n=Z.FromArray(s.rotation||[0,0,0,1]),r=S.FromArray(s.translation||[0,0,0]);e=z.Compose(t,n,r)}else e=z.FromArray(s.matrix);return e},Yn=(s,e,t,n)=>{for(let o=0;o<n.bones.length;o++)if(n.bones[o].name===t)return n.bones[o];const r=s.nodes;for(const o in r){const a=r[o];if(!a.jointName)continue;const i=a.children;for(let l=0;l<i.length;l++){const c=s.nodes[i[l]];if(c.jointName&&c.jointName===t){const u=Jt(a),h=new Je(a.name||"",n,Yn(s,e,a.jointName,n),u);return h.id=o,h}}}return null},$s=(s,e)=>{for(let t=0;t<s.length;t++){const n=s[t];for(let r=0;r<n.node.children.length;r++)if(n.node.children[r]===e)return n.bone}return null},Ft=(s,e)=>{const t=s.nodes;let n=t[e];if(n)return{node:n,id:e};for(const r in t)if(n=t[r],n.jointName===e)return{node:n,id:r};return null},Ds=(s,e)=>{for(let t=0;t<s.jointNames.length;t++)if(s.jointNames[t]===e)return!0;return!1},Vs=(s,e,t,n)=>{for(const r in s.nodes){const o=s.nodes[r],a=r;if(!o.jointName||Ds(t,o.jointName))continue;const i=Jt(o),l=new Je(o.name||"",e,null,i);l.id=a,n.push({bone:l,node:o,id:a})}for(let r=0;r<n.length;r++){const o=n[r],a=o.node.children;for(let i=0;i<a.length;i++){let l=null;for(let c=0;c<n.length;c++)if(n[c].id===a[i]){l=n[c];break}l&&(l.bone._parent=o.bone,o.bone.children.push(l.bone))}}},Hs=(s,e,t,n)=>{if(n||(n=new qt(e.name||"","",s.scene)),!e.babylonSkeleton)return n;const r=[],o=[];Vs(s,n,e,r),n.bones=[];for(let i=0;i<e.jointNames.length;i++){const l=Ft(s,e.jointNames[i]);if(!l)continue;const c=l.node;if(!c){B.Warn("Joint named "+e.jointNames[i]+" does not exist");continue}const u=l.id,h=s.scene.getBoneById(u);if(h){n.bones.push(h);continue}let d=!1,f=null;for(let E=0;E<i;E++){const v=Ft(s,e.jointNames[E]);if(!v)continue;const D=v.node;if(!D){B.Warn("Joint named "+e.jointNames[E]+" does not exist when looking for parent");continue}const k=D.children;if(k){d=!1;for(let N=0;N<k.length;N++)if(k[N]===u){f=Yn(s,e,e.jointNames[E],n),d=!0;break}if(d)break}}const m=Jt(c);!f&&r.length>0&&(f=$s(r,u),f&&o.indexOf(f)===-1&&o.push(f));const b=new Je(c.jointName||"",n,f,m);b.id=u}const a=n.bones;n.bones=[];for(let i=0;i<e.jointNames.length;i++){const l=Ft(s,e.jointNames[i]);if(l){for(let c=0;c<a.length;c++)if(a[c].id===l.id){n.bones.push(a[c]);break}}}n.prepare();for(let i=0;i<o.length;i++)n.bones.push(o[i]);return n},In=(s,e,t,n,r)=>{if(r||(s.scene._blockEntityCollection=!!s.assetContainer,r=new Pe(e.name||"",s.scene),r._parentContainer=s.assetContainer,s.scene._blockEntityCollection=!1,r.id=n),!e.babylonNode)return r;const o=[];let a=null;const i=[],l=[],c=[],u=[];for(let f=0;f<t.length;f++){const m=t[f],b=s.meshes[m];if(b)for(let E=0;E<b.primitives.length;E++){const v=new as,D=b.primitives[E];D.mode;const k=D.attributes;let N=null,w=null;for(const x in k)if(N=s.accessors[k[x]],w=W.GetBufferFromAccessor(s,N),x==="NORMAL")v.normals=new Float32Array(w.length),v.normals.set(w);else if(x==="POSITION"){if(X.HomogeneousCoordinates){v.positions=new Float32Array(w.length-w.length/4);for(let O=0;O<w.length;O+=4)v.positions[O]=w[O],v.positions[O+1]=w[O+1],v.positions[O+2]=w[O+2]}else v.positions=new Float32Array(w.length),v.positions.set(w);l.push(v.positions.length)}else if(x.indexOf("TEXCOORD_")!==-1){const O=Number(x.split("_")[1]),V=M.UVKind+(O===0?"":O+1),H=new Float32Array(w.length);H.set(w),Fs(H),v.set(H,V)}else x==="JOINT"?(v.matricesIndices=new Float32Array(w.length),v.matricesIndices.set(w)):x==="WEIGHT"?(v.matricesWeights=new Float32Array(w.length),v.matricesWeights.set(w)):x==="COLOR"&&(v.colors=new Float32Array(w.length),v.colors.set(w));if(N=s.accessors[D.indices],N)w=W.GetBufferFromAccessor(s,N),v.indices=new Int32Array(w.length),v.indices.set(w),u.push(v.indices.length);else{const x=[];for(let O=0;O<v.positions.length/3;O++)x.push(O);v.indices=new Int32Array(x),u.push(v.indices.length)}a?a.merge(v):a=v;const C=s.scene.getMaterialById(D.material);o.push(C===null?W.GetDefaultMaterial(s.scene):C),i.push(i.length===0?0:i[i.length-1]+l[l.length-2]),c.push(c.length===0?0:c[c.length-1]+u[u.length-2])}}let h;s.scene._blockEntityCollection=!!s.assetContainer,o.length>1?(h=new is("multimat"+n,s.scene),h.subMaterials=o):h=new Wt("multimat"+n,s.scene),o.length===1&&(h=o[0]),h._parentContainer=s.assetContainer,r.material||(r.material=h),new Hn(n,s.scene,a,!1,r),r.computeWorldMatrix(!0),s.scene._blockEntityCollection=!1,r.subMeshes=[];let d=0;for(let f=0;f<t.length;f++){const m=t[f],b=s.meshes[m];if(b)for(let E=0;E<b.primitives.length;E++)b.primitives[E].mode,ls.AddToMesh(d,i[d],l[d],c[d],u[d],r,r,!0),d++}return r},Kt=(s,e,t,n)=>{s.position&&(s.position=e),(s.rotationQuaternion||s.rotation)&&(s.rotationQuaternion=t),s.scaling&&(s.scaling=n)},Ks=(s,e)=>{if(e.matrix){const t=new S(0,0,0),n=new Z,r=new S(0,0,0);z.FromArray(e.matrix).decompose(r,n,t),Kt(s,t,n,r)}else e.translation&&e.rotation&&e.scale&&Kt(s,S.FromArray(e.translation),Z.FromArray(e.rotation),S.FromArray(e.scale));s.computeWorldMatrix(!0)},Us=(s,e,t)=>{let n=null;if(s.importOnlyMeshes&&(e.skin||e.meshes)&&s.importMeshesNames&&s.importMeshesNames.length>0&&s.importMeshesNames.indexOf(e.name||"")===-1)return null;if(e.skin){if(e.meshes){const r=s.skins[e.skin],o=In(s,e,e.meshes,t,e.babylonNode);o.skeleton=s.scene.getLastSkeletonById(e.skin),o.skeleton===null&&(o.skeleton=Hs(s,r,o,r.babylonSkeleton),r.babylonSkeleton||(r.babylonSkeleton=o.skeleton)),n=o}}else if(e.meshes)n=In(s,e,e.mesh?[e.mesh]:e.meshes,t,e.babylonNode);else if(e.light&&!e.babylonNode&&!s.importOnlyMeshes){const r=s.lights[e.light];if(r){if(r.type==="ambient"){const o=r[r.type],a=new Dn(e.light,S.Zero(),s.scene);a.name=e.name||"",o.color&&(a.diffuse=F.FromArray(o.color)),n=a}else if(r.type==="directional"){const o=r[r.type],a=new Yt(e.light,S.Zero(),s.scene);a.name=e.name||"",o.color&&(a.diffuse=F.FromArray(o.color)),n=a}else if(r.type==="point"){const o=r[r.type],a=new jt(e.light,S.Zero(),s.scene);a.name=e.name||"",o.color&&(a.diffuse=F.FromArray(o.color)),n=a}else if(r.type==="spot"){const o=r[r.type],a=new _e(e.light,S.Zero(),S.Zero(),0,0,s.scene);a.name=e.name||"",o.color&&(a.diffuse=F.FromArray(o.color)),o.fallOfAngle&&(a.angle=o.fallOfAngle),o.fallOffExponent&&(a.exponent=o.fallOffExponent),n=a}}}else if(e.camera&&!e.babylonNode&&!s.importOnlyMeshes){const r=s.cameras[e.camera];if(r){if(s.scene._blockEntityCollection=!!s.assetContainer,r.type==="orthographic"){const o=new Gt(e.camera,S.Zero(),s.scene,!1);o.name=e.name||"",o.mode=Vn.ORTHOGRAPHIC_CAMERA,o.attachControl(),n=o,o._parentContainer=s.assetContainer}else if(r.type==="perspective"){const o=r[r.type],a=new Gt(e.camera,S.Zero(),s.scene,!1);a.name=e.name||"",a.attachControl(),o.aspectRatio||(o.aspectRatio=s.scene.getEngine().getRenderWidth()/s.scene.getEngine().getRenderHeight()),o.znear&&o.zfar&&(a.maxZ=o.zfar,a.minZ=o.znear),n=a,a._parentContainer=s.assetContainer}s.scene._blockEntityCollection=!1}}if(!e.jointName){if(e.babylonNode)return e.babylonNode;if(n===null){s.scene._blockEntityCollection=!!s.assetContainer;const r=new Pe(e.name||"",s.scene);r._parentContainer=s.assetContainer,s.scene._blockEntityCollection=!1,e.babylonNode=r,n=r}}if(n!==null){if(e.matrix&&n instanceof Pe)Ks(n,e);else{const r=e.translation||[0,0,0],o=e.rotation||[0,0,0,1],a=e.scale||[1,1,1];Kt(n,S.FromArray(r),Z.FromArray(o),S.FromArray(a))}n.updateCache(!0),e.babylonNode=n}return n},We=(s,e,t,n=!1)=>{const r=s.nodes[e];let o=null;if(s.importOnlyMeshes&&!n&&s.importMeshesNames?s.importMeshesNames.indexOf(r.name||"")!==-1||s.importMeshesNames.length===0?n=!0:n=!1:n=!0,!r.jointName&&n&&(o=Us(s,r,e),o!==null&&(o.id=e,o.parent=t)),r.children)for(let a=0;a<r.children.length;a++)We(s,r.children[a],o,n)},Sn=s=>{let e=s.currentScene;if(e)for(let t=0;t<e.nodes.length;t++)We(s,e.nodes[t],null);else for(const t in s.scenes){e=s.scenes[t];for(let n=0;n<e.nodes.length;n++)We(s,e.nodes[n],null)}Gs(s);for(let t=0;t<s.scene.skeletons.length;t++){const n=s.scene.skeletons[t];s.scene.beginAnimation(n,0,Number.MAX_VALUE,!0,1)}},qs=(s,e,t,n,r,o,a)=>{const i=o.values||r.parameters;for(const l in t){const c=t[l],u=c.type;if(u===ae.FLOAT_MAT2||u===ae.FLOAT_MAT3||u===ae.FLOAT_MAT4){if(c.semantic&&!c.source&&!c.node)W.SetMatrix(e.scene,s,c,l,n.getEffect());else if(c.semantic&&(c.source||c.node)){let h=e.scene.getNodeByName(c.source||c.node||"");if(h===null&&(h=e.scene.getNodeById(c.source||c.node||"")),h===null)continue;W.SetMatrix(e.scene,h,c,l,n.getEffect())}}else{const h=i[r.uniforms[l]];if(!h)continue;if(u===ae.SAMPLER_2D){const d=e.textures[o.values?h:c.value].babylonTexture;if(d==null)continue;n.getEffect().setTexture(l,d)}else W.SetUniform(n.getEffect(),l,h,u)}}a(n)},Ws=(s,e,t,n,r)=>{const o=n.values||t.parameters,a=t.uniforms;for(const i in r){const l=r[i],c=l.type;let u=o[a[i]];if(u===void 0&&(u=l.value),!u)continue;const h=d=>f=>{l.value&&d&&(e.setTexture(d,f),delete r[d])};c===ae.SAMPLER_2D?J.LoadTextureAsync(s,n.values?u:l.value,h(i),()=>h(null)):l.value&&W.SetUniform(e,i,n.values?u:l.value,c)&&delete r[i]}},Ys=(s,e,t)=>(n,r)=>{e.dispose(!0),t("Cannot compile program named "+s.name+". Error: "+r+". Default material will be applied")},js=(s,e,t,n,r,o)=>a=>{Ws(s,e,t,n,r),e.onBind=i=>{qs(i,s,r,e,t,n,o)}},Mn=(s,e,t)=>{for(const n in e.uniforms){const r=e.uniforms[n],o=e.parameters[r];if(s.currentIdentifier===n&&o.semantic&&!o.source&&!o.node){const a=qn.indexOf(o.semantic);if(a!==-1)return delete t[n],Wn[a]}}return s.currentIdentifier},kn=s=>{for(const e in s.materials)J.LoadMaterialAsync(s,e,()=>{},()=>{})};class ge{static CreateRuntime(e,t,n){const r={extensions:{},accessors:{},buffers:{},bufferViews:{},meshes:{},lights:{},cameras:{},nodes:{},images:{},textures:{},shaders:{},programs:{},samplers:{},techniques:{},materials:{},animations:{},skins:{},extensionsUsed:[],scenes:{},buffersCount:0,shaderscount:0,scene:t,rootUrl:n,loadedBufferCount:0,loadedBufferViews:{},loadedShaderCount:0,importOnlyMeshes:!1,dummyNodes:[],assetContainer:null};return e.extensions&&ne(e.extensions,"extensions",r),e.extensionsUsed&&ne(e.extensionsUsed,"extensionsUsed",r),e.buffers&&Rs(e.buffers,r),e.bufferViews&&ne(e.bufferViews,"bufferViews",r),e.accessors&&ne(e.accessors,"accessors",r),e.meshes&&ne(e.meshes,"meshes",r),e.lights&&ne(e.lights,"lights",r),e.cameras&&ne(e.cameras,"cameras",r),e.nodes&&ne(e.nodes,"nodes",r),e.images&&ne(e.images,"images",r),e.textures&&ne(e.textures,"textures",r),e.shaders&&Bs(e.shaders,r),e.programs&&ne(e.programs,"programs",r),e.samplers&&ne(e.samplers,"samplers",r),e.techniques&&ne(e.techniques,"techniques",r),e.materials&&ne(e.materials,"materials",r),e.animations&&ne(e.animations,"animations",r),e.skins&&ne(e.skins,"skins",r),e.scenes&&(r.scenes=e.scenes),e.scene&&e.scenes&&(r.currentScene=e.scenes[e.scene]),r}static LoadBufferAsync(e,t,n,r,o){const a=e.buffers[t];B.IsBase64(a.uri)?setTimeout(()=>n(new Uint8Array(B.DecodeBase64(a.uri)))):B.LoadFile(e.rootUrl+a.uri,i=>n(new Uint8Array(i)),o,void 0,!0,i=>{i&&r(i.status+" "+i.statusText)})}static LoadTextureBufferAsync(e,t,n,r){const o=e.textures[t];if(!o||!o.source){r("");return}if(o.babylonTexture){n(null);return}const a=e.images[o.source];B.IsBase64(a.uri)?setTimeout(()=>n(new Uint8Array(B.DecodeBase64(a.uri)))):B.LoadFile(e.rootUrl+a.uri,i=>n(new Uint8Array(i)),void 0,void 0,!0,i=>{i&&r(i.status+" "+i.statusText)})}static CreateTextureAsync(e,t,n,r){const o=e.textures[t];if(o.babylonTexture){r(o.babylonTexture);return}const a=e.samplers[o.sampler],i=a.minFilter===pe.NEAREST_MIPMAP_NEAREST||a.minFilter===pe.NEAREST_MIPMAP_LINEAR||a.minFilter===pe.LINEAR_MIPMAP_NEAREST||a.minFilter===pe.LINEAR_MIPMAP_LINEAR,l=$.BILINEAR_SAMPLINGMODE,c=n==null?new Blob:new Blob([n]),u=URL.createObjectURL(c),h=()=>URL.revokeObjectURL(u),d=new $(u,e.scene,!i,!0,l,h,h);a.wrapS!==void 0&&(d.wrapU=W.GetWrapMode(a.wrapS)),a.wrapT!==void 0&&(d.wrapV=W.GetWrapMode(a.wrapT)),d.name=t,o.babylonTexture=d,r(d)}static LoadShaderStringAsync(e,t,n,r){const o=e.shaders[t];if(B.IsBase64(o.uri)){const a=atob(o.uri.split(",")[1]);n&&n(a)}else B.LoadFile(e.rootUrl+o.uri,n,void 0,void 0,!1,a=>{a&&r&&r(a.status+" "+a.statusText)})}static LoadMaterialAsync(e,t,n,r){const o=e.materials[t];if(!o.technique){r&&r("No technique found.");return}const a=e.techniques[o.technique];if(!a){e.scene._blockEntityCollection=!!e.assetContainer;const C=new Wt(t,e.scene);C._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,C.diffuseColor=new F(.5,.5,.5),C.sideOrientation=de.CounterClockWiseSideOrientation,n(C);return}const i=e.programs[a.program],l=a.states,c=Ie.ShadersStore[i.vertexShader+"VertexShader"],u=Ie.ShadersStore[i.fragmentShader+"PixelShader"];let h="",d="";const f=new On(c),m=new On(u),b={},E=[],v=[],D=[];for(const C in a.uniforms){const x=a.uniforms[C],O=a.parameters[x];if(b[C]=O,O.semantic&&!O.node&&!O.source){const V=qn.indexOf(O.semantic);V!==-1?(E.push(Wn[V]),delete b[C]):E.push(C)}else O.type===ae.SAMPLER_2D?D.push(C):E.push(C)}for(const C in a.attributes){const x=a.attributes[C],O=a.parameters[x];if(O.semantic){const V=Nn(O);V&&v.push(V)}}for(;!f.isEnd()&&f.getNextToken();){if(f.currentToken!==Ee.IDENTIFIER){h+=f.currentString;continue}let x=!1;for(const O in a.attributes){const V=a.attributes[O],H=a.parameters[V];if(f.currentIdentifier===O&&H.semantic){h+=Nn(H),x=!0;break}}x||(h+=Mn(f,a,b))}for(;!m.isEnd()&&m.getNextToken();){if(m.currentToken!==Ee.IDENTIFIER){d+=m.currentString;continue}d+=Mn(m,a,b)}const k={vertex:i.vertexShader+t,fragment:i.fragmentShader+t},N={attributes:v,uniforms:E,samplers:D,needAlphaBlending:l&&l.enable&&l.enable.indexOf(3042)!==-1};Ie.ShadersStore[i.vertexShader+t+"VertexShader"]=h,Ie.ShadersStore[i.fragmentShader+t+"PixelShader"]=d;const w=new Fn(t,e.scene,k,N);if(w.onError=Ys(i,w,r),w.onCompiled=js(e,w,a,o,b,n),w.sideOrientation=de.CounterClockWiseSideOrientation,l&&l.functions){const C=l.functions;C.cullFace&&C.cullFace[0]!==Ht.BACK&&(w.backFaceCulling=!1);const x=C.blendFuncSeparate;x&&(x[0]===K.SRC_ALPHA&&x[1]===K.ONE_MINUS_SRC_ALPHA&&x[2]===K.ONE&&x[3]===K.ONE?w.alphaMode=Te.ALPHA_COMBINE:x[0]===K.ONE&&x[1]===K.ONE&&x[2]===K.ZERO&&x[3]===K.ONE?w.alphaMode=Te.ALPHA_ONEONE:x[0]===K.SRC_ALPHA&&x[1]===K.ONE&&x[2]===K.ZERO&&x[3]===K.ONE?w.alphaMode=Te.ALPHA_ADD:x[0]===K.ZERO&&x[1]===K.ONE_MINUS_SRC_COLOR&&x[2]===K.ONE&&x[3]===K.ONE?w.alphaMode=Te.ALPHA_SUBTRACT:x[0]===K.DST_COLOR&&x[1]===K.ZERO&&x[2]===K.ONE&&x[3]===K.ONE?w.alphaMode=Te.ALPHA_MULTIPLY:x[0]===K.SRC_ALPHA&&x[1]===K.ONE_MINUS_SRC_COLOR&&x[2]===K.ONE&&x[3]===K.ONE&&(w.alphaMode=Te.ALPHA_MAXIMIZED))}}}let Le=class Ut{static RegisterExtension(e){if(Ut.Extensions[e.name]){B.Error('Tool with the same name "'+e.name+'" already exists');return}Ut.Extensions[e.name]=e}dispose(){}_importMeshAsync(e,t,n,r,o,a,i,l){return t.useRightHandedSystem=!0,J.LoadRuntimeAsync(t,n,r,c=>{c.assetContainer=o,c.importOnlyMeshes=!0,e===""?c.importMeshesNames=[]:typeof e=="string"?c.importMeshesNames=[e]:e&&!(e instanceof Array)?c.importMeshesNames=[e]:(c.importMeshesNames=[],B.Warn("Argument meshesNames must be of type string or string[]")),this._createNodes(c);const u=[],h=[];for(const d in c.nodes){const f=c.nodes[d];f.babylonNode instanceof $n&&u.push(f.babylonNode)}for(const d in c.skins){const f=c.skins[d];f.babylonSkeleton instanceof qt&&h.push(f.babylonSkeleton)}this._loadBuffersAsync(c,()=>{this._loadShadersAsync(c,()=>{kn(c),Sn(c),!X.IncrementalLoading&&a&&a(u,h)})}),X.IncrementalLoading&&a&&a(u,h)},l),!0}importMeshAsync(e,t,n,r,o,a){return new Promise((i,l)=>{this._importMeshAsync(e,t,r,o,n,(c,u)=>{i({meshes:c,particleSystems:[],skeletons:u,animationGroups:[],lights:[],transformNodes:[],geometries:[],spriteManagers:[]})},a,c=>{l(new Error(c))})})}_loadAsync(e,t,n,r,o,a){e.useRightHandedSystem=!0,J.LoadRuntimeAsync(e,t,n,i=>{J.LoadRuntimeExtensionsAsync(i,()=>{this._createNodes(i),this._loadBuffersAsync(i,()=>{this._loadShadersAsync(i,()=>{kn(i),Sn(i),X.IncrementalLoading||r()})}),X.IncrementalLoading&&r()},a)},a)}loadAsync(e,t,n,r){return new Promise((o,a)=>{this._loadAsync(e,t,n,()=>{o()},r,i=>{a(new Error(i))})})}_loadShadersAsync(e,t){let n=!1;const r=(o,a)=>{J.LoadShaderStringAsync(e,o,i=>{i instanceof ArrayBuffer||(e.loadedShaderCount++,i&&(Ie.ShadersStore[o+(a.type===Vt.VERTEX?"VertexShader":"PixelShader")]=i),e.loadedShaderCount===e.shaderscount&&t())},()=>{B.Error("Error when loading shader program named "+o+" located at "+a.uri)})};for(const o in e.shaders){n=!0;const a=e.shaders[o];a?r.bind(this,o,a)():B.Error("No shader named: "+o)}n||t()}_loadBuffersAsync(e,t){let n=!1;const r=(o,a)=>{J.LoadBufferAsync(e,o,i=>{e.loadedBufferCount++,i&&(i.byteLength!=e.buffers[o].byteLength&&B.Error("Buffer named "+o+" is length "+i.byteLength+". Expected: "+a.byteLength),e.loadedBufferViews[o]=i),e.loadedBufferCount===e.buffersCount&&t()},()=>{B.Error("Error when loading buffer named "+o+" located at "+a.uri)})};for(const o in e.buffers){n=!0;const a=e.buffers[o];a?r.bind(this,o,a)():B.Error("No buffer named: "+o)}n||t()}_createNodes(e){let t=e.currentScene;if(t)for(let n=0;n<t.nodes.length;n++)We(e,t.nodes[n],null);else for(const n in e.scenes){t=e.scenes[n];for(let r=0;r<t.nodes.length;r++)We(e,t.nodes[r],null)}}};Le.Extensions={};class J{constructor(e){this._name=e}get name(){return this._name}loadRuntimeAsync(e,t,n,r,o){return!1}loadRuntimeExtensionsAsync(e,t,n){return!1}loadBufferAsync(e,t,n,r,o){return!1}loadTextureBufferAsync(e,t,n,r){return!1}createTextureAsync(e,t,n,r,o){return!1}loadShaderStringAsync(e,t,n,r){return!1}loadMaterialAsync(e,t,n,r){return!1}static LoadRuntimeAsync(e,t,n,r,o){J._ApplyExtensions(a=>a.loadRuntimeAsync(e,t,n,r,o),()=>{setTimeout(()=>{r&&r(ge.CreateRuntime(t.json,e,n))})})}static LoadRuntimeExtensionsAsync(e,t,n){J._ApplyExtensions(r=>r.loadRuntimeExtensionsAsync(e,t,n),()=>{setTimeout(()=>{t()})})}static LoadBufferAsync(e,t,n,r,o){J._ApplyExtensions(a=>a.loadBufferAsync(e,t,n,r,o),()=>{ge.LoadBufferAsync(e,t,n,r,o)})}static LoadTextureAsync(e,t,n,r){J._LoadTextureBufferAsync(e,t,o=>{o&&J._CreateTextureAsync(e,t,o,n,r)},r)}static LoadShaderStringAsync(e,t,n,r){J._ApplyExtensions(o=>o.loadShaderStringAsync(e,t,n,r),()=>{ge.LoadShaderStringAsync(e,t,n,r)})}static LoadMaterialAsync(e,t,n,r){J._ApplyExtensions(o=>o.loadMaterialAsync(e,t,n,r),()=>{ge.LoadMaterialAsync(e,t,n,r)})}static _LoadTextureBufferAsync(e,t,n,r){J._ApplyExtensions(o=>o.loadTextureBufferAsync(e,t,n,r),()=>{ge.LoadTextureBufferAsync(e,t,n,r)})}static _CreateTextureAsync(e,t,n,r,o){J._ApplyExtensions(a=>a.createTextureAsync(e,t,n,r,o),()=>{ge.CreateTextureAsync(e,t,n,r)})}static _ApplyExtensions(e,t){for(const n in Le.Extensions){const r=Le.Extensions[n];if(e(r))return}t()}}X._CreateGLTF1Loader=()=>new Le;const Js="binary_glTF";class Xs extends J{constructor(){super("KHR_binary_glTF")}loadRuntimeAsync(e,t,n,r){const o=t.json.extensionsUsed;return!o||o.indexOf(this.name)===-1||!t.bin?!1:(this._bin=t.bin,r(ge.CreateRuntime(t.json,e,n)),!0)}loadBufferAsync(e,t,n,r){return e.extensionsUsed.indexOf(this.name)===-1||t!==Js?!1:(this._bin.readAsync(0,this._bin.byteLength).then(n,o=>r(o.message)),!0)}loadTextureBufferAsync(e,t,n){const r=e.textures[t],o=e.images[r.source];if(!o.extensions||!(this.name in o.extensions))return!1;const a=o.extensions[this.name],i=e.bufferViews[a.bufferView],l=W.GetBufferFromBufferView(e,i,0,i.byteLength,ve.UNSIGNED_BYTE);return n(l),!0}loadShaderStringAsync(e,t,n){const r=e.shaders[t];if(!r.extensions||!(this.name in r.extensions))return!1;const o=r.extensions[this.name],a=e.bufferViews[o.bufferView],i=W.GetBufferFromBufferView(e,a,0,a.byteLength,ve.UNSIGNED_BYTE);return setTimeout(()=>{const l=W.DecodeBufferToText(i);n(l)}),!0}}Le.RegisterExtension(new Xs);class Zs extends J{constructor(){super("KHR_materials_common")}loadRuntimeExtensionsAsync(e){if(!e.extensions)return!1;const t=e.extensions[this.name];if(!t)return!1;const n=t.lights;if(n)for(const r in n){const o=n[r];switch(o.type){case"ambient":{const a=new Dn(o.name,new S(0,1,0),e.scene),i=o.ambient;i&&(a.diffuse=F.FromArray(i.color||[1,1,1]));break}case"point":{const a=new jt(o.name,new S(10,10,10),e.scene),i=o.point;i&&(a.diffuse=F.FromArray(i.color||[1,1,1]));break}case"directional":{const a=new Yt(o.name,new S(0,-1,0),e.scene),i=o.directional;i&&(a.diffuse=F.FromArray(i.color||[1,1,1]));break}case"spot":{const a=o.spot;if(a){const i=new _e(o.name,new S(0,10,0),new S(0,-1,0),a.fallOffAngle||Math.PI,a.fallOffExponent||0,e.scene);i.diffuse=F.FromArray(a.color||[1,1,1])}break}default:B.Warn('GLTF Material Common extension: light type "'+o.type+"â€ not supported");break}}return!1}loadMaterialAsync(e,t,n,r){const o=e.materials[t];if(!o||!o.extensions)return!1;const a=o.extensions[this.name];if(!a)return!1;const i=new Wt(t,e.scene);return i.sideOrientation=de.CounterClockWiseSideOrientation,a.technique==="CONSTANT"&&(i.disableLighting=!0),i.backFaceCulling=a.doubleSided===void 0?!1:!a.doubleSided,i.alpha=a.values.transparency===void 0?1:a.values.transparency,i.specularPower=a.values.shininess===void 0?0:a.values.shininess,typeof a.values.ambient=="string"?this._loadTexture(e,a.values.ambient,i,"ambientTexture",r):i.ambientColor=F.FromArray(a.values.ambient||[0,0,0]),typeof a.values.diffuse=="string"?this._loadTexture(e,a.values.diffuse,i,"diffuseTexture",r):i.diffuseColor=F.FromArray(a.values.diffuse||[0,0,0]),typeof a.values.emission=="string"?this._loadTexture(e,a.values.emission,i,"emissiveTexture",r):i.emissiveColor=F.FromArray(a.values.emission||[0,0,0]),typeof a.values.specular=="string"?this._loadTexture(e,a.values.specular,i,"specularTexture",r):i.specularColor=F.FromArray(a.values.specular||[0,0,0]),!0}_loadTexture(e,t,n,r,o){ge.LoadTextureBufferAsync(e,t,a=>{ge.CreateTextureAsync(e,t,a,i=>n[r]=i)},o)}}Le.RegisterExtension(new Zs);const Xt=new Map,Qs=Xt;function L(s,e,t){P(s)&&I.Warn(`Extension with the name '${s}' already exists`),Xt.set(s,{isGLTFExtension:e,factory:t})}function P(s){return Xt.delete(s)}class zs{constructor(e,t){this._gltf=e,this._infoTree=t}convert(e){let t=this._gltf,n=this._infoTree,r;if(!e.startsWith("/"))throw new Error("Path must start with a /");const o=e.split("/");if(o.shift(),o[o.length-1].includes(".length")){const l=o[o.length-1].split(".");o.pop(),o.push(...l)}let a=!1;for(const i of o){const l=i==="length";if(l&&!n.__array__)throw new Error(`Path ${e} is invalid`);if(n.__ignoreObjectTree__&&(a=!0),n.__array__&&!l)n=n.__array__;else if(n=n[i],!n)throw new Error(`Path ${e} is invalid`);if(!a){if(t===void 0)throw new Error(`Path ${e} is invalid`);l||(t=t==null?void 0:t[i])}(n.__target__||l)&&(r=t)}return{object:r,info:n}}}const er={length:{type:"number",get:s=>s.length,getTarget:s=>s.map(e=>e._babylonTransformNode),getPropertyName:[()=>"length"]},__array__:{__target__:!0,translation:{type:"Vector3",get:s=>{var e;return(e=s._babylonTransformNode)==null?void 0:e.position},set:(s,e)=>{var t;return(t=e._babylonTransformNode)==null?void 0:t.position.copyFrom(s)},getTarget:s=>s._babylonTransformNode,getPropertyName:[()=>"position"]},rotation:{type:"Quaternion",get:s=>{var e;return(e=s._babylonTransformNode)==null?void 0:e.rotationQuaternion},set:(s,e)=>{var t,n;return(n=(t=e._babylonTransformNode)==null?void 0:t.rotationQuaternion)==null?void 0:n.copyFrom(s)},getTarget:s=>s._babylonTransformNode,getPropertyName:[()=>"rotationQuaternion"]},scale:{type:"Vector3",get:s=>{var e;return(e=s._babylonTransformNode)==null?void 0:e.scaling},set:(s,e)=>{var t;return(t=e._babylonTransformNode)==null?void 0:t.scaling.copyFrom(s)},getTarget:s=>s._babylonTransformNode,getPropertyName:[()=>"scaling"]},weights:{length:{type:"number",get:s=>s._numMorphTargets,getTarget:s=>s._babylonTransformNode,getPropertyName:[()=>"influence"]},__array__:{__target__:!0,type:"number",get:(s,e)=>{var t,n;return e!==void 0?(n=(t=s._primitiveBabylonMeshes)==null?void 0:t[0].morphTargetManager)==null?void 0:n.getTarget(e).influence:void 0},getTarget:s=>s._babylonTransformNode,getPropertyName:[()=>"influence"]},type:"number[]",get:(s,e)=>[0],getTarget:s=>s._babylonTransformNode,getPropertyName:[()=>"influence"]},matrix:{type:"Matrix",get:s=>{var e,t,n;return z.Compose((e=s._babylonTransformNode)==null?void 0:e.scaling,(t=s._babylonTransformNode)==null?void 0:t.rotationQuaternion,(n=s._babylonTransformNode)==null?void 0:n.position)},getTarget:s=>s._babylonTransformNode,isReadOnly:!0},globalMatrix:{type:"Matrix",get:s=>{var r,o,a,i,l,c,u;const e=z.Identity();let t=s.parent;for(;t&&t.parent;)t=t.parent;const n=((r=s._babylonTransformNode)==null?void 0:r.position._isDirty)||((a=(o=s._babylonTransformNode)==null?void 0:o.rotationQuaternion)==null?void 0:a._isDirty)||((i=s._babylonTransformNode)==null?void 0:i.scaling._isDirty);if(t){const h=(l=t._babylonTransformNode)==null?void 0:l.computeWorldMatrix(!0).invert();h&&((u=(c=s._babylonTransformNode)==null?void 0:c.computeWorldMatrix(n))==null||u.multiplyToRef(h,e))}else s._babylonTransformNode&&e.copyFrom(s._babylonTransformNode.computeWorldMatrix(n));return e},getTarget:s=>s._babylonTransformNode,isReadOnly:!0},extensions:{EXT_lights_ies:{multiplier:{type:"number",get:s=>{var e,t;return(t=(e=s._babylonTransformNode)==null?void 0:e.getChildren(n=>n instanceof _e,!0)[0])==null?void 0:t.intensity},getTarget:s=>{var e;return(e=s._babylonTransformNode)==null?void 0:e.getChildren(t=>t instanceof _e,!0)[0]},set:(s,e)=>{if(e._babylonTransformNode){const t=e._babylonTransformNode.getChildren(n=>n instanceof _e,!0)[0];t&&(t.intensity=s)}}},color:{type:"Color3",get:s=>{var e,t;return(t=(e=s._babylonTransformNode)==null?void 0:e.getChildren(n=>n instanceof _e,!0)[0])==null?void 0:t.diffuse},getTarget:s=>{var e;return(e=s._babylonTransformNode)==null?void 0:e.getChildren(t=>t instanceof _e,!0)[0]},set:(s,e)=>{if(e._babylonTransformNode){const t=e._babylonTransformNode.getChildren(n=>n instanceof _e,!0)[0];t&&(t.diffuse=s)}}}}}}},tr={length:{type:"number",get:s=>s.length,getTarget:s=>s.map(e=>e._babylonAnimationGroup),getPropertyName:[()=>"length"]},__array__:{}},nr={length:{type:"number",get:s=>s.length,getTarget:s=>s.map(e=>{var t;return(t=e.primitives[0]._instanceData)==null?void 0:t.babylonSourceMesh}),getPropertyName:[()=>"length"]},__array__:{}},sr={__array__:{__target__:!0,orthographic:{xmag:{componentsCount:2,type:"Vector2",get:s=>{var e,t;return new Ue(((e=s._babylonCamera)==null?void 0:e.orthoLeft)??0,((t=s._babylonCamera)==null?void 0:t.orthoRight)??0)},set:(s,e)=>{e._babylonCamera&&(e._babylonCamera.orthoLeft=s.x,e._babylonCamera.orthoRight=s.y)},getTarget:s=>s,getPropertyName:[()=>"orthoLeft",()=>"orthoRight"]},ymag:{componentsCount:2,type:"Vector2",get:s=>{var e,t;return new Ue(((e=s._babylonCamera)==null?void 0:e.orthoBottom)??0,((t=s._babylonCamera)==null?void 0:t.orthoTop)??0)},set:(s,e)=>{e._babylonCamera&&(e._babylonCamera.orthoBottom=s.x,e._babylonCamera.orthoTop=s.y)},getTarget:s=>s,getPropertyName:[()=>"orthoBottom",()=>"orthoTop"]},zfar:{type:"number",get:s=>{var e;return(e=s._babylonCamera)==null?void 0:e.maxZ},set:(s,e)=>{e._babylonCamera&&(e._babylonCamera.maxZ=s)},getTarget:s=>s,getPropertyName:[()=>"maxZ"]},znear:{type:"number",get:s=>{var e;return(e=s._babylonCamera)==null?void 0:e.minZ},set:(s,e)=>{e._babylonCamera&&(e._babylonCamera.minZ=s)},getTarget:s=>s,getPropertyName:[()=>"minZ"]}},perspective:{aspectRatio:{type:"number",get:s=>{var e;return(e=s._babylonCamera)==null?void 0:e.getEngine().getAspectRatio(s._babylonCamera)},getTarget:s=>s,getPropertyName:[()=>"aspectRatio"],isReadOnly:!0},yfov:{type:"number",get:s=>{var e;return(e=s._babylonCamera)==null?void 0:e.fov},set:(s,e)=>{e._babylonCamera&&(e._babylonCamera.fov=s)},getTarget:s=>s,getPropertyName:[()=>"fov"]},zfar:{type:"number",get:s=>{var e;return(e=s._babylonCamera)==null?void 0:e.maxZ},set:(s,e)=>{e._babylonCamera&&(e._babylonCamera.maxZ=s)},getTarget:s=>s,getPropertyName:[()=>"maxZ"]},znear:{type:"number",get:s=>{var e;return(e=s._babylonCamera)==null?void 0:e.minZ},set:(s,e)=>{e._babylonCamera&&(e._babylonCamera.minZ=s)},getTarget:s=>s,getPropertyName:[()=>"minZ"]}}}},rr={__array__:{__target__:!0,emissiveFactor:{type:"Color3",get:(s,e,t)=>_(s,e,t).emissiveColor,set:(s,e,t,n)=>_(e,t,n).emissiveColor.copyFrom(s),getTarget:(s,e,t)=>_(s,e,t),getPropertyName:[()=>"emissiveColor"]},emissiveTexture:{extensions:{KHR_texture_transform:j("emissiveTexture")}},normalTexture:{scale:{type:"number",get:(s,e,t)=>{var n;return(n=xe(s,t,"bumpTexture"))==null?void 0:n.level},set:(s,e,t,n)=>{const r=xe(e,n,"bumpTexture");r&&(r.level=s)},getTarget:(s,e,t)=>_(s,e,t),getPropertyName:[()=>"level"]},extensions:{KHR_texture_transform:j("bumpTexture")}},occlusionTexture:{strength:{type:"number",get:(s,e,t)=>_(s,e,t).ambientTextureStrength,set:(s,e,t,n)=>{const r=_(e,t,n);r&&(r.ambientTextureStrength=s)},getTarget:(s,e,t)=>_(s,e,t),getPropertyName:[()=>"ambientTextureStrength"]},extensions:{KHR_texture_transform:j("ambientTexture")}},pbrMetallicRoughness:{baseColorFactor:{type:"Color4",get:(s,e,t)=>{const n=_(s,e,t);return Gn.FromColor3(n.albedoColor,n.alpha)},set:(s,e,t,n)=>{const r=_(e,t,n);r.albedoColor.set(s.r,s.g,s.b),r.alpha=s.a},getTarget:(s,e,t)=>_(s,e,t),getPropertyName:[()=>"albedoColor",()=>"alpha"]},baseColorTexture:{extensions:{KHR_texture_transform:j("albedoTexture")}},metallicFactor:{type:"number",get:(s,e,t)=>_(s,e,t).metallic,set:(s,e,t,n)=>{const r=_(e,t,n);r&&(r.metallic=s)},getTarget:(s,e,t)=>_(s,e,t),getPropertyName:[()=>"metallic"]},roughnessFactor:{type:"number",get:(s,e,t)=>_(s,e,t).roughness,set:(s,e,t,n)=>{const r=_(e,t,n);r&&(r.roughness=s)},getTarget:(s,e,t)=>_(s,e,t),getPropertyName:[()=>"roughness"]},metallicRoughnessTexture:{extensions:{KHR_texture_transform:j("metallicTexture")}}},extensions:{KHR_materials_anisotropy:{anisotropyStrength:{type:"number",get:(s,e,t)=>_(s,e,t).anisotropy.intensity,set:(s,e,t,n)=>{_(e,t,n).anisotropy.intensity=s},getTarget:(s,e,t)=>_(s,e,t),getPropertyName:[()=>"anisotropy.intensity"]},anisotropyRotation:{type:"number",get:(s,e,t)=>_(s,e,t).anisotropy.angle,set:(s,e,t,n)=>{_(e,t,n).anisotropy.angle=s},getTarget:(s,e,t)=>_(s,e,t),getPropertyName:[()=>"anisotropy.angle"]},anisotropyTexture:{extensions:{KHR_texture_transform:j("anisotropy","texture")}}},KHR_materials_clearcoat:{clearcoatFactor:{type:"number",get:(s,e,t)=>_(s,e,t).clearCoat.intensity,set:(s,e,t,n)=>{_(e,t,n).clearCoat.intensity=s},getTarget:(s,e,t)=>_(s,e,t),getPropertyName:[()=>"clearCoat.intensity"]},clearcoatRoughnessFactor:{type:"number",get:(s,e,t)=>_(s,e,t).clearCoat.roughness,set:(s,e,t,n)=>{_(e,t,n).clearCoat.roughness=s},getTarget:(s,e,t)=>_(s,e,t),getPropertyName:[()=>"clearCoat.roughness"]},clearcoatTexture:{extensions:{KHR_texture_transform:j("clearCoat","texture")}},clearcoatNormalTexture:{scale:{type:"number",get:(s,e,t)=>{var n;return(n=_(s,e,t).clearCoat.bumpTexture)==null?void 0:n.level},getTarget:_,set:(s,e,t,n)=>_(e,t,n).clearCoat.bumpTexture.level=s},extensions:{KHR_texture_transform:j("clearCoat","bumpTexture")}},clearcoatRoughnessTexture:{extensions:{KHR_texture_transform:j("clearCoat","textureRoughness")}}},KHR_materials_dispersion:{dispersion:{type:"number",get:(s,e,t)=>_(s,e,t).subSurface.dispersion,getTarget:_,set:(s,e,t,n)=>_(e,t,n).subSurface.dispersion=s}},KHR_materials_emissive_strength:{emissiveStrength:{type:"number",get:(s,e,t)=>_(s,e,t).emissiveIntensity,getTarget:_,set:(s,e,t,n)=>_(e,t,n).emissiveIntensity=s}},KHR_materials_ior:{ior:{type:"number",get:(s,e,t)=>_(s,e,t).indexOfRefraction,getTarget:_,set:(s,e,t,n)=>_(e,t,n).indexOfRefraction=s}},KHR_materials_iridescence:{iridescenceFactor:{type:"number",get:(s,e,t)=>_(s,e,t).iridescence.intensity,getTarget:_,set:(s,e,t,n)=>_(e,t,n).iridescence.intensity=s},iridescenceIor:{type:"number",get:(s,e,t)=>_(s,e,t).iridescence.indexOfRefraction,getTarget:_,set:(s,e,t,n)=>_(e,t,n).iridescence.indexOfRefraction=s},iridescenceTexture:{extensions:{KHR_texture_transform:j("iridescence","texture")}},iridescenceThicknessMaximum:{type:"number",get:(s,e,t)=>_(s,e,t).iridescence.maximumThickness,getTarget:_,set:(s,e,t,n)=>_(e,t,n).iridescence.maximumThickness=s},iridescenceThicknessMinimum:{type:"number",get:(s,e,t)=>_(s,e,t).iridescence.minimumThickness,getTarget:_,set:(s,e,t,n)=>_(e,t,n).iridescence.minimumThickness=s},iridescenceThicknessTexture:{extensions:{KHR_texture_transform:j("iridescence","thicknessTexture")}}},KHR_materials_sheen:{sheenColorFactor:{type:"Color3",get:(s,e,t)=>_(s,e,t).sheen.color,getTarget:_,set:(s,e,t,n)=>_(e,t,n).sheen.color.copyFrom(s)},sheenColorTexture:{extensions:{KHR_texture_transform:j("sheen","texture")}},sheenRoughnessFactor:{type:"number",get:(s,e,t)=>_(s,e,t).sheen.intensity,getTarget:_,set:(s,e,t,n)=>_(e,t,n).sheen.intensity=s},sheenRoughnessTexture:{extensions:{KHR_texture_transform:j("sheen","thicknessTexture")}}},KHR_materials_specular:{specularFactor:{type:"number",get:(s,e,t)=>_(s,e,t).metallicF0Factor,getTarget:_,set:(s,e,t,n)=>_(e,t,n).metallicF0Factor=s,getPropertyName:[()=>"metallicF0Factor"]},specularColorFactor:{type:"Color3",get:(s,e,t)=>_(s,e,t).metallicReflectanceColor,getTarget:_,set:(s,e,t,n)=>_(e,t,n).metallicReflectanceColor.copyFrom(s),getPropertyName:[()=>"metallicReflectanceColor"]},specularTexture:{extensions:{KHR_texture_transform:j("metallicReflectanceTexture")}},specularColorTexture:{extensions:{KHR_texture_transform:j("reflectanceTexture")}}},KHR_materials_transmission:{transmissionFactor:{type:"number",get:(s,e,t)=>_(s,e,t).subSurface.refractionIntensity,getTarget:_,set:(s,e,t,n)=>_(e,t,n).subSurface.refractionIntensity=s,getPropertyName:[()=>"subSurface.refractionIntensity"]},transmissionTexture:{extensions:{KHR_texture_transform:j("subSurface","refractionIntensityTexture")}}},KHR_materials_diffuse_transmission:{diffuseTransmissionFactor:{type:"number",get:(s,e,t)=>_(s,e,t).subSurface.translucencyIntensity,getTarget:_,set:(s,e,t,n)=>_(e,t,n).subSurface.translucencyIntensity=s},diffuseTransmissionTexture:{extensions:{KHR_texture_transform:j("subSurface","translucencyIntensityTexture")}},diffuseTransmissionColorFactor:{type:"Color3",get:(s,e,t)=>_(s,e,t).subSurface.translucencyColor,getTarget:_,set:(s,e,t,n)=>{var r;return s&&((r=_(e,t,n).subSurface.translucencyColor)==null?void 0:r.copyFrom(s))}},diffuseTransmissionColorTexture:{extensions:{KHR_texture_transform:j("subSurface","translucencyColorTexture")}}},KHR_materials_volume:{attenuationColor:{type:"Color3",get:(s,e,t)=>_(s,e,t).subSurface.tintColor,getTarget:_,set:(s,e,t,n)=>_(e,t,n).subSurface.tintColor.copyFrom(s)},attenuationDistance:{type:"number",get:(s,e,t)=>_(s,e,t).subSurface.tintColorAtDistance,getTarget:_,set:(s,e,t,n)=>_(e,t,n).subSurface.tintColorAtDistance=s},thicknessFactor:{type:"number",get:(s,e,t)=>_(s,e,t).subSurface.maximumThickness,getTarget:_,set:(s,e,t,n)=>_(e,t,n).subSurface.maximumThickness=s},thicknessTexture:{extensions:{KHR_texture_transform:j("subSurface","thicknessTexture")}}}}}},or={KHR_lights_punctual:{lights:{length:{type:"number",get:s=>s.length,getTarget:s=>s.map(e=>e._babylonLight),getPropertyName:[s=>"length"]},__array__:{__target__:!0,color:{type:"Color3",get:s=>{var e;return(e=s._babylonLight)==null?void 0:e.diffuse},set:(s,e)=>{var t;return(t=e._babylonLight)==null?void 0:t.diffuse.copyFrom(s)},getTarget:s=>s._babylonLight,getPropertyName:[s=>"diffuse"]},intensity:{type:"number",get:s=>{var e;return(e=s._babylonLight)==null?void 0:e.intensity},set:(s,e)=>e._babylonLight?e._babylonLight.intensity=s:void 0,getTarget:s=>s._babylonLight,getPropertyName:[s=>"intensity"]},range:{type:"number",get:s=>{var e;return(e=s._babylonLight)==null?void 0:e.range},set:(s,e)=>e._babylonLight?e._babylonLight.range=s:void 0,getTarget:s=>s._babylonLight,getPropertyName:[s=>"range"]},spot:{innerConeAngle:{type:"number",get:s=>{var e;return(e=s._babylonLight)==null?void 0:e.innerAngle},set:(s,e)=>e._babylonLight?e._babylonLight.innerAngle=s:void 0,getTarget:s=>s._babylonLight,getPropertyName:[s=>"innerConeAngle"]},outerConeAngle:{type:"number",get:s=>{var e;return(e=s._babylonLight)==null?void 0:e.angle},set:(s,e)=>e._babylonLight?e._babylonLight.angle=s:void 0,getTarget:s=>s._babylonLight,getPropertyName:[s=>"outerConeAngle"]}}}}},EXT_lights_ies:{lights:{length:{type:"number",get:s=>s.length,getTarget:s=>s.map(e=>e._babylonLight),getPropertyName:[s=>"length"]}}},EXT_lights_image_based:{lights:{length:{type:"number",get:s=>s.length,getTarget:s=>s.map(e=>e._babylonTexture),getPropertyName:[s=>"length"]},__array__:{__target__:!0,intensity:{type:"number",get:s=>{var e;return(e=s._babylonTexture)==null?void 0:e.level},set:(s,e)=>{e._babylonTexture&&(e._babylonTexture.level=s)},getTarget:s=>s._babylonTexture},rotation:{type:"Quaternion",get:s=>{var e;return s._babylonTexture&&Z.FromRotationMatrix((e=s._babylonTexture)==null?void 0:e.getReflectionTextureMatrix())},set:(s,e)=>{var t;e._babylonTexture&&((t=e._babylonTexture.getScene())!=null&&t.useRightHandedSystem||(s=Z.Inverse(s)),z.FromQuaternionToRef(s,e._babylonTexture.getReflectionTextureMatrix()))},getTarget:s=>s._babylonTexture}}}}};function xe(s,e,t,n){const r=_(s);return n?r[t][n]:r[t]}function _(s,e,t){var n,r;return(r=(n=s._data)==null?void 0:n[(t==null?void 0:t.fillMode)??Te.MATERIAL_TriangleFillMode])==null?void 0:r.babylonMaterial}function j(s,e){return{offset:{componentsCount:2,type:"Vector2",get:(t,n,r)=>{const o=xe(t,r,s,e);return new Ue(o==null?void 0:o.uOffset,o==null?void 0:o.vOffset)},getTarget:_,set:(t,n,r,o)=>{const a=xe(n,o,s,e);a.uOffset=t.x,a.vOffset=t.y},getPropertyName:[()=>`${s}${e?"."+e:""}.uOffset`,()=>`${s}${e?"."+e:""}.vOffset`]},rotation:{type:"number",get:(t,n,r)=>{var o;return(o=xe(t,r,s,e))==null?void 0:o.wAng},getTarget:_,set:(t,n,r,o)=>xe(n,o,s,e).wAng=t,getPropertyName:[()=>`${s}${e?"."+e:""}.wAng`]},scale:{componentsCount:2,type:"Vector2",get:(t,n,r)=>{const o=xe(t,r,s,e);return new Ue(o==null?void 0:o.uScale,o==null?void 0:o.vScale)},getTarget:_,set:(t,n,r,o)=>{const a=xe(n,o,s,e);a.uScale=t.x,a.vScale=t.y},getPropertyName:[()=>`${s}${e?"."+e:""}.uScale`,()=>`${s}${e?"."+e:""}.vScale`]}}}const kt={cameras:sr,nodes:er,materials:rr,extensions:or,animations:tr,meshes:nr};function jn(s){return new zs(s,kt)}function ze(s){const e=s.split("/").map(n=>n.replace(/{}/g,"__array__"));let t=kt;for(const n of e)n&&(t=t[n]);if(t&&t.type&&t.get)return t}function p(s,e){const t=s.split("/").map(r=>r.replace(/{}/g,"__array__"));let n=kt;for(const r of t)r&&(n=n[r]);n&&n.type&&n.get&&(n.interpolation=e)}function me(s,e){const t=s.split("/").map(r=>r.replace(/{}/g,"__array__"));let n=kt;for(const r of t)if(r){if(!n[r]){if(r==="?"){n.__ignoreObjectTree__=!0;continue}n[r]={},r==="__array__"&&(n[r].__target__=!0)}n=n[r]}Object.assign(n,e)}class g{static Get(e,t,n){if(!t||n==null||!t[n])throw new Error(`${e}: Failed to find index (${n})`);return t[n]}static TryGet(e,t){return!e||t==null||!e[t]?null:e[t]}static Assign(e){if(e)for(let t=0;t<e.length;t++)e[t].index=t}}function Jn(s){if(s.min&&s.max){const e=s.min,t=s.max,n=ue.Vector3[0].copyFromFloats(e[0],e[1],e[2]),r=ue.Vector3[1].copyFromFloats(t[0],t[1],t[2]);if(s.normalized&&s.componentType!==5126){let o=1;switch(s.componentType){case 5120:o=127;break;case 5121:o=255;break;case 5122:o=32767;break;case 5123:o=65535;break}const a=1/o;n.scaleInPlace(a),r.scaleInPlace(a)}return new _s(n,r)}return null}class A{static RegisterExtension(e,t){L(e,!1,t)}static UnregisterExtension(e){return P(e)}get gltf(){if(!this._gltf)throw new Error("glTF JSON is not available");return this._gltf}get bin(){return this._bin}get parent(){return this._parent}get babylonScene(){if(!this._babylonScene)throw new Error("Scene is not available");return this._babylonScene}get rootBabylonMesh(){return this._rootBabylonMesh}get rootUrl(){return this._rootUrl}constructor(e){this._completePromises=new Array,this._assetContainer=null,this._babylonLights=[],this._disableInstancedMesh=0,this._allMaterialsDirtyRequired=!1,this._skipStartAnimationStep=!1,this._extensions=new Array,this._disposed=!1,this._rootUrl=null,this._fileName=null,this._uniqueRootUrl=null,this._bin=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions=new Array,this._parent=e}dispose(){this._disposed||(this._disposed=!0,this._completePromises.length=0,this._extensions.forEach(e=>e.dispose&&e.dispose()),this._extensions.length=0,this._gltf=null,this._bin=null,this._babylonScene=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions.length=0,this._parent.dispose())}importMeshAsync(e,t,n,r,o,a,i=""){return Promise.resolve().then(()=>{this._babylonScene=t,this._assetContainer=n,this._loadData(r);let l=null;if(e){const c={};if(this._gltf.nodes)for(const h of this._gltf.nodes)h.name&&(c[h.name]=h.index);l=(e instanceof Array?e:[e]).map(h=>{const d=c[h];if(d===void 0)throw new Error(`Failed to find node '${h}'`);return d})}return this._loadAsync(o,i,l,()=>({meshes:this._getMeshes(),particleSystems:[],skeletons:this._getSkeletons(),animationGroups:this._getAnimationGroups(),lights:this._babylonLights,transformNodes:this._getTransformNodes(),geometries:this._getGeometries(),spriteManagers:[]}))})}loadAsync(e,t,n,r,o=""){return Promise.resolve().then(()=>(this._babylonScene=e,this._loadData(t),this._loadAsync(n,o,null,()=>{})))}_loadAsync(e,t,n,r){return Promise.resolve().then(async()=>{this._rootUrl=e,this._uniqueRootUrl=!e.startsWith("file:")&&t?e:`${e}${Date.now()}/`,this._fileName=t,this._allMaterialsDirtyRequired=!1,await this._loadExtensionsAsync();const o=`${ie[ie.LOADING]} => ${ie[ie.READY]}`,a=`${ie[ie.LOADING]} => ${ie[ie.COMPLETE]}`;this._parent._startPerformanceCounter(o),this._parent._startPerformanceCounter(a),this._parent._setState(ie.LOADING),this._extensionsOnLoading();const i=new Array,l=this._babylonScene.blockMaterialDirtyMechanism;if(this._babylonScene.blockMaterialDirtyMechanism=!0,!this.parent.loadOnlyMaterials){if(n)i.push(this.loadSceneAsync("/nodes",{nodes:n,index:-1}));else if(this._gltf.scene!=null||this._gltf.scenes&&this._gltf.scenes[0]){const u=g.Get("/scene",this._gltf.scenes,this._gltf.scene||0);i.push(this.loadSceneAsync(`/scenes/${u.index}`,u))}}if(!this.parent.skipMaterials&&this.parent.loadAllMaterials&&this._gltf.materials)for(let u=0;u<this._gltf.materials.length;++u){const h=this._gltf.materials[u],d="/materials/"+u,f=de.TriangleFillMode;i.push(this._loadMaterialAsync(d,h,null,f,()=>{}))}return this._allMaterialsDirtyRequired?this._babylonScene.blockMaterialDirtyMechanism=l:this._babylonScene._forceBlockMaterialDirtyMechanism(l),this._parent.compileMaterials&&i.push(this._compileMaterialsAsync()),this._parent.compileShadowGenerators&&i.push(this._compileShadowGeneratorsAsync()),Promise.all(i).then(()=>{this._rootBabylonMesh&&this._rootBabylonMesh!==this._parent.customRootNode&&this._rootBabylonMesh.setEnabled(!0);for(const u of this._babylonScene.materials){const h=u;h.maxSimultaneousLights!==void 0&&(h.maxSimultaneousLights=Math.max(h.maxSimultaneousLights,this._babylonScene.lights.length))}return this._extensionsOnReady(),this._parent._setState(ie.READY),this._skipStartAnimationStep||this._startAnimations(),r()}).then(u=>(this._parent._endPerformanceCounter(o),B.SetImmediate(()=>{this._disposed||Promise.all(this._completePromises).then(()=>{this._parent._endPerformanceCounter(a),this._parent._setState(ie.COMPLETE),this._parent.onCompleteObservable.notifyObservers(void 0),this._parent.onCompleteObservable.clear(),this.dispose()},h=>{this._parent.onErrorObservable.notifyObservers(h),this._parent.onErrorObservable.clear(),this.dispose()})}),u))}).catch(o=>{throw this._disposed||(this._parent.onErrorObservable.notifyObservers(o),this._parent.onErrorObservable.clear(),this.dispose()),o})}_loadData(e){if(this._gltf=e.json,this._setupData(),e.bin){const t=this._gltf.buffers;if(t&&t[0]&&!t[0].uri){const n=t[0];(n.byteLength<e.bin.byteLength-3||n.byteLength>e.bin.byteLength)&&I.Warn(`Binary buffer length (${n.byteLength}) from JSON does not match chunk length (${e.bin.byteLength})`),this._bin=e.bin}else I.Warn("Unexpected BIN chunk")}}_setupData(){if(g.Assign(this._gltf.accessors),g.Assign(this._gltf.animations),g.Assign(this._gltf.buffers),g.Assign(this._gltf.bufferViews),g.Assign(this._gltf.cameras),g.Assign(this._gltf.images),g.Assign(this._gltf.materials),g.Assign(this._gltf.meshes),g.Assign(this._gltf.nodes),g.Assign(this._gltf.samplers),g.Assign(this._gltf.scenes),g.Assign(this._gltf.skins),g.Assign(this._gltf.textures),this._gltf.nodes){const e={};for(const n of this._gltf.nodes)if(n.children)for(const r of n.children)e[r]=n.index;const t=this._createRootNode();for(const n of this._gltf.nodes){const r=e[n.index];n.parent=r===void 0?t:this._gltf.nodes[r]}}}async _loadExtensionsAsync(){var t;const e=[];if(Qs.forEach((n,r)=>{var o;((o=this.parent.extensionOptions[r])==null?void 0:o.enabled)===!1?n.isGLTFExtension&&this.isExtensionUsed(r)&&I.Warn(`Extension ${r} is used but has been explicitly disabled.`):(!n.isGLTFExtension||this.isExtensionUsed(r))&&e.push((async()=>{const a=await n.factory(this);return a.name!==r&&I.Warn(`The name of the glTF loader extension instance does not match the registered name: ${a.name} !== ${r}`),this._parent.onExtensionLoadedObservable.notifyObservers(a),a})())}),this._extensions.push(...await Promise.all(e)),this._extensions.sort((n,r)=>(n.order||Number.MAX_VALUE)-(r.order||Number.MAX_VALUE)),this._parent.onExtensionLoadedObservable.clear(),this._gltf.extensionsRequired){for(const n of this._gltf.extensionsRequired)if(!this._extensions.some(o=>o.name===n&&o.enabled))throw((t=this.parent.extensionOptions[n])==null?void 0:t.enabled)===!1?new Error(`Required extension ${n} is disabled`):new Error(`Required extension ${n} is not available`)}}_createRootNode(){if(this._parent.customRootNode!==void 0)return this._rootBabylonMesh=this._parent.customRootNode,{_babylonTransformNode:this._rootBabylonMesh===null?void 0:this._rootBabylonMesh,index:-1};this._babylonScene._blockEntityCollection=!!this._assetContainer;const e=new Pe("__root__",this._babylonScene);this._rootBabylonMesh=e,this._rootBabylonMesh._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);const t={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case qe.AUTO:{this._babylonScene.useRightHandedSystem||(t.rotation=[0,1,0,0],t.scale=[1,1,-1],A._LoadTransform(t,this._rootBabylonMesh));break}case qe.FORCE_RIGHT_HANDED:{this._babylonScene.useRightHandedSystem=!0;break}default:throw new Error(`Invalid coordinate system mode (${this._parent.coordinateSystemMode})`)}return this._parent.onMeshLoadedObservable.notifyObservers(e),t}loadSceneAsync(e,t){const n=this._extensionsLoadSceneAsync(e,t);if(n)return n;const r=new Array;if(this.logOpen(`${e} ${t.name||""}`),t.nodes)for(const o of t.nodes){const a=g.Get(`${e}/nodes/${o}`,this._gltf.nodes,o);r.push(this.loadNodeAsync(`/nodes/${a.index}`,a,i=>{i.parent=this._rootBabylonMesh}))}for(const o of this._postSceneLoadActions)o();return r.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(r).then(()=>{})}_forEachPrimitive(e,t){if(e._primitiveBabylonMeshes)for(const n of e._primitiveBabylonMeshes)t(n)}_getGeometries(){const e=[],t=this._gltf.nodes;if(t)for(const n of t)this._forEachPrimitive(n,r=>{const o=r.geometry;o&&e.indexOf(o)===-1&&e.push(o)});return e}_getMeshes(){const e=[];this._rootBabylonMesh instanceof $n&&e.push(this._rootBabylonMesh);const t=this._gltf.nodes;if(t)for(const n of t)this._forEachPrimitive(n,r=>{e.push(r)});return e}_getTransformNodes(){const e=[],t=this._gltf.nodes;if(t)for(const n of t)n._babylonTransformNode&&n._babylonTransformNode.getClassName()==="TransformNode"&&e.push(n._babylonTransformNode),n._babylonTransformNodeForSkin&&e.push(n._babylonTransformNodeForSkin);return e}_getSkeletons(){const e=[],t=this._gltf.skins;if(t)for(const n of t)n._data&&e.push(n._data.babylonSkeleton);return e}_getAnimationGroups(){const e=[],t=this._gltf.animations;if(t)for(const n of t)n._babylonAnimationGroup&&e.push(n._babylonAnimationGroup);return e}_startAnimations(){switch(this._parent.animationStartMode){case ke.NONE:break;case ke.FIRST:{const e=this._getAnimationGroups();e.length!==0&&e[0].start(!0);break}case ke.ALL:{const e=this._getAnimationGroups();for(const t of e)t.start(!0);break}default:{I.Error(`Invalid animation start mode (${this._parent.animationStartMode})`);return}}}loadNodeAsync(e,t,n=()=>{}){const r=this._extensionsLoadNodeAsync(e,t,n);if(r)return r;if(t._babylonTransformNode)throw new Error(`${e}: Invalid recursive node hierarchy`);const o=new Array;this.logOpen(`${e} ${t.name||""}`);const a=c=>{if(A.AddPointerMetadata(c,e),A._LoadTransform(t,c),t.camera!=null){const u=g.Get(`${e}/camera`,this._gltf.cameras,t.camera);o.push(this.loadCameraAsync(`/cameras/${u.index}`,u,h=>{h.parent=c}))}if(t.children)for(const u of t.children){const h=g.Get(`${e}/children/${u}`,this._gltf.nodes,u);o.push(this.loadNodeAsync(`/nodes/${h.index}`,h,d=>{d.parent=c}))}n(c)},i=t.mesh!=null,l=this._parent.loadSkins&&t.skin!=null;if(!i||l){const c=t.name||`node${t.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const u=new xn(c,this._babylonScene);u._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t.mesh==null?t._babylonTransformNode=u:t._babylonTransformNodeForSkin=u,a(u)}if(i)if(l){const c=g.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);o.push(this._loadMeshAsync(`/meshes/${c.index}`,t,c,u=>{const h=t._babylonTransformNodeForSkin;u.metadata=cs(h.metadata,u.metadata||{});const d=g.Get(`${e}/skin`,this._gltf.skins,t.skin);o.push(this._loadSkinAsync(`/skins/${d.index}`,t,d,f=>{this._forEachPrimitive(t,m=>{m.skeleton=f}),this._postSceneLoadActions.push(()=>{if(d.skeleton!=null){const m=g.Get(`/skins/${d.index}/skeleton`,this._gltf.nodes,d.skeleton).parent;t.index===m.index?u.parent=h.parent:u.parent=m._babylonTransformNode}else u.parent=this._rootBabylonMesh;this._parent.onSkinLoadedObservable.notifyObservers({node:h,skinnedNode:u})})}))}))}else{const c=g.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);o.push(this._loadMeshAsync(`/meshes/${c.index}`,t,c,a))}return this.logClose(),Promise.all(o).then(()=>(this._forEachPrimitive(t,c=>{const u=c;!u.isAnInstance&&u.geometry&&u.geometry.useBoundingInfoFromGeometry?c._updateBoundingInfo():c.refreshBoundingInfo(!0,!0)}),t._babylonTransformNode))}_loadMeshAsync(e,t,n,r){const o=n.primitives;if(!o||!o.length)throw new Error(`${e}: Primitives are missing`);o[0].index==null&&g.Assign(o);const a=new Array;this.logOpen(`${e} ${n.name||""}`);const i=t.name||`node${t.index}`;if(o.length===1){const l=n.primitives[0];a.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${l.index}`,i,t,n,l,c=>{t._babylonTransformNode=c,t._primitiveBabylonMeshes=[c]}))}else{this._babylonScene._blockEntityCollection=!!this._assetContainer,t._babylonTransformNode=new xn(i,this._babylonScene),t._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._primitiveBabylonMeshes=[];for(const l of o)a.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${l.index}`,`${i}_primitive${l.index}`,t,n,l,c=>{c.parent=t._babylonTransformNode,t._primitiveBabylonMeshes.push(c)}))}return r(t._babylonTransformNode),this.logClose(),Promise.all(a).then(()=>t._babylonTransformNode)}_loadMeshPrimitiveAsync(e,t,n,r,o,a){const i=this._extensionsLoadMeshPrimitiveAsync(e,t,n,r,o,a);if(i)return i;this.logOpen(`${e}`);const l=this._disableInstancedMesh===0&&this._parent.createInstances&&n.skin==null&&!r.primitives[0].targets;let c,u;if(l&&o._instanceData)this._babylonScene._blockEntityCollection=!!this._assetContainer,c=o._instanceData.babylonSourceMesh.createInstance(t),c._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,u=o._instanceData.promise;else{const h=new Array;this._babylonScene._blockEntityCollection=!!this._assetContainer;const d=new Pe(t,this._babylonScene);d._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,d.sideOrientation=this._babylonScene.useRightHandedSystem?de.CounterClockWiseSideOrientation:de.ClockWiseSideOrientation,this._createMorphTargets(e,n,r,o,d),h.push(this._loadVertexDataAsync(e,o,d).then(m=>this._loadMorphTargetsAsync(e,o,d,m).then(()=>{this._disposed||(this._babylonScene._blockEntityCollection=!!this._assetContainer,m.applyToMesh(d),m._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1)})));const f=A._GetDrawMode(e,o.mode);if(o.material==null){let m=this._defaultBabylonMaterialData[f];m||(m=this._createDefaultMaterial("__GLTFLoader._default",f),this._parent.onMaterialLoadedObservable.notifyObservers(m),this._defaultBabylonMaterialData[f]=m),d.material=m}else if(!this.parent.skipMaterials){const m=g.Get(`${e}/material`,this._gltf.materials,o.material);h.push(this._loadMaterialAsync(`/materials/${m.index}`,m,d,f,b=>{d.material=b}))}u=Promise.all(h),l&&(o._instanceData={babylonSourceMesh:d,promise:u}),c=d}return A.AddPointerMetadata(c,e),this._parent.onMeshLoadedObservable.notifyObservers(c),a(c),this.logClose(),u.then(()=>c)}_loadVertexDataAsync(e,t,n){const r=this._extensionsLoadVertexDataAsync(e,t,n);if(r)return r;const o=t.attributes;if(!o)throw new Error(`${e}: Attributes are missing`);const a=new Array,i=new Hn(n.name,this._babylonScene);if(t.indices==null)n.isUnIndexed=!0;else{const c=g.Get(`${e}/indices`,this._gltf.accessors,t.indices);a.push(this._loadIndicesAccessorAsync(`/accessors/${c.index}`,c).then(u=>{i.setIndices(u)}))}const l=(c,u,h)=>{if(o[c]==null)return;n._delayInfo=n._delayInfo||[],n._delayInfo.indexOf(u)===-1&&n._delayInfo.push(u);const d=g.Get(`${e}/attributes/${c}`,this._gltf.accessors,o[c]);a.push(this._loadVertexAccessorAsync(`/accessors/${d.index}`,d,u).then(f=>{if(f.getKind()===M.PositionKind&&!this.parent.alwaysComputeBoundingBox&&!n.skeleton){const m=Jn(d);m&&(i._boundingInfo=m,i.useBoundingInfoFromGeometry=!0)}i.setVerticesBuffer(f,d.count)})),u==M.MatricesIndicesExtraKind&&(n.numBoneInfluencers=8),h&&h(d)};return l("POSITION",M.PositionKind),l("NORMAL",M.NormalKind),l("TANGENT",M.TangentKind),l("TEXCOORD_0",M.UVKind),l("TEXCOORD_1",M.UV2Kind),l("TEXCOORD_2",M.UV3Kind),l("TEXCOORD_3",M.UV4Kind),l("TEXCOORD_4",M.UV5Kind),l("TEXCOORD_5",M.UV6Kind),l("JOINTS_0",M.MatricesIndicesKind),l("WEIGHTS_0",M.MatricesWeightsKind),l("JOINTS_1",M.MatricesIndicesExtraKind),l("WEIGHTS_1",M.MatricesWeightsExtraKind),l("COLOR_0",M.ColorKind,c=>{c.type==="VEC4"&&(n.hasVertexAlpha=!0)}),Promise.all(a).then(()=>i)}_createMorphTargets(e,t,n,r,o){if(!r.targets||!this._parent.loadMorphTargets)return;if(t._numMorphTargets==null)t._numMorphTargets=r.targets.length;else if(r.targets.length!==t._numMorphTargets)throw new Error(`${e}: Primitives do not have the same number of targets`);const a=n.extras?n.extras.targetNames:null;this._babylonScene._blockEntityCollection=!!this._assetContainer,o.morphTargetManager=new us(this._babylonScene),o.morphTargetManager._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,o.morphTargetManager.areUpdatesFrozen=!0;for(let i=0;i<r.targets.length;i++){const l=t.weights?t.weights[i]:n.weights?n.weights[i]:0,c=a?a[i]:`morphTarget${i}`;o.morphTargetManager.addTarget(new hs(c,l,o.getScene()))}}_loadMorphTargetsAsync(e,t,n,r){if(!t.targets||!this._parent.loadMorphTargets)return Promise.resolve();const o=new Array,a=n.morphTargetManager;for(let i=0;i<a.numTargets;i++){const l=a.getTarget(i);o.push(this._loadMorphTargetVertexDataAsync(`${e}/targets/${i}`,r,t.targets[i],l))}return Promise.all(o).then(()=>{a.areUpdatesFrozen=!1})}_loadMorphTargetVertexDataAsync(e,t,n,r){const o=new Array,a=(i,l,c)=>{if(n[i]==null)return;const u=t.getVertexBuffer(l);if(!u)return;const h=g.Get(`${e}/${i}`,this._gltf.accessors,n[i]);o.push(this._loadFloatAccessorAsync(`/accessors/${h.index}`,h).then(d=>{c(u,d)}))};return a("POSITION",M.PositionKind,(i,l)=>{const c=new Float32Array(l.length);i.forEach(l.length,(u,h)=>{c[h]=l[h]+u}),r.setPositions(c)}),a("NORMAL",M.NormalKind,(i,l)=>{const c=new Float32Array(l.length);i.forEach(c.length,(u,h)=>{c[h]=l[h]+u}),r.setNormals(c)}),a("TANGENT",M.TangentKind,(i,l)=>{const c=new Float32Array(l.length/3*4);let u=0;i.forEach(l.length/3*4,(h,d)=>{(d+1)%4!==0&&(c[u]=l[u]+h,u++)}),r.setTangents(c)}),a("TEXCOORD_0",M.UVKind,(i,l)=>{const c=new Float32Array(l.length);i.forEach(l.length,(u,h)=>{c[h]=l[h]+u}),r.setUVs(c)}),a("TEXCOORD_1",M.UV2Kind,(i,l)=>{const c=new Float32Array(l.length);i.forEach(l.length,(u,h)=>{c[h]=l[h]+u}),r.setUV2s(c)}),a("COLOR_0",M.ColorKind,(i,l)=>{let c=null;const u=i.getSize();if(u===3){c=new Float32Array(l.length/3*4),i.forEach(l.length,(h,d)=>{const f=Math.floor(d/3),m=d%3;c[4*f+m]=l[3*f+m]+h});for(let h=0;h<l.length/3;++h)c[4*h+3]=1}else if(u===4)c=new Float32Array(l.length),i.forEach(l.length,(h,d)=>{c[d]=l[d]+h});else throw new Error(`${e}: Invalid number of components (${u}) for COLOR_0 attribute`);r.setColors(c)}),Promise.all(o).then(()=>{})}static _LoadTransform(e,t){if(e.skin!=null)return;let n=S.Zero(),r=Z.Identity(),o=S.One();e.matrix?z.FromArray(e.matrix).decompose(o,r,n):(e.translation&&(n=S.FromArray(e.translation)),e.rotation&&(r=Z.FromArray(e.rotation)),e.scale&&(o=S.FromArray(e.scale))),t.position=n,t.rotationQuaternion=r,t.scaling=o}_loadSkinAsync(e,t,n,r){if(!this._parent.loadSkins)return Promise.resolve();const o=this._extensionsLoadSkinAsync(e,t,n);if(o)return o;if(n._data)return r(n._data.babylonSkeleton),n._data.promise;const a=`skeleton${n.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const i=new qt(n.name||a,a,this._babylonScene);i._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._loadBones(e,n,i);const l=this._loadSkinInverseBindMatricesDataAsync(e,n).then(c=>{this._updateBoneMatrices(i,c)});return n._data={babylonSkeleton:i,promise:l},r(i),l}_loadBones(e,t,n){if(t.skeleton==null||this._parent.alwaysComputeSkeletonRootNode){const o=this._findSkeletonRootNode(`${e}/joints`,t.joints);if(o)if(t.skeleton===void 0)t.skeleton=o.index;else{const a=(l,c)=>{for(;c.parent;c=c.parent)if(c.parent===l)return!0;return!1},i=g.Get(`${e}/skeleton`,this._gltf.nodes,t.skeleton);i!==o&&!a(i,o)&&(I.Warn(`${e}/skeleton: Overriding with nearest common ancestor as skeleton node is not a common root`),t.skeleton=o.index)}else I.Warn(`${e}: Failed to find common root`)}const r={};for(const o of t.joints){const a=g.Get(`${e}/joints/${o}`,this._gltf.nodes,o);this._loadBone(a,t,n,r)}}_findSkeletonRootNode(e,t){if(t.length===0)return null;const n={};for(const o of t){const a=[];let i=g.Get(`${e}/${o}`,this._gltf.nodes,o);for(;i.index!==-1;)a.unshift(i),i=i.parent;n[o]=a}let r=null;for(let o=0;;++o){let a=n[t[0]];if(o>=a.length)return r;const i=a[o];for(let l=1;l<t.length;++l)if(a=n[t[l]],o>=a.length||i!==a[o])return r;r=i}}_loadBone(e,t,n,r){e._isJoint=!0;let o=r[e.index];if(o)return o;let a=null;e.index!==t.skeleton&&(e.parent&&e.parent.index!==-1?a=this._loadBone(e.parent,t,n,r):t.skeleton!==void 0&&I.Warn(`/skins/${t.index}/skeleton: Skeleton node is not a common root`));const i=t.joints.indexOf(e.index);return o=new Je(e.name||`joint${e.index}`,n,a,this._getNodeMatrix(e),null,null,i),r[e.index]=o,this._postSceneLoadActions.push(()=>{o.linkTransformNode(e._babylonTransformNode)}),o}_loadSkinInverseBindMatricesDataAsync(e,t){if(t.inverseBindMatrices==null)return Promise.resolve(null);const n=g.Get(`${e}/inverseBindMatrices`,this._gltf.accessors,t.inverseBindMatrices);return this._loadFloatAccessorAsync(`/accessors/${n.index}`,n)}_updateBoneMatrices(e,t){for(const n of e.bones){const r=z.Identity(),o=n._index;t&&o!==-1&&(z.FromArrayToRef(t,o*16,r),r.invertToRef(r));const a=n.getParent();a&&r.multiplyToRef(a.getAbsoluteInverseBindMatrix(),r),n.updateMatrix(r,!1,!1),n._updateAbsoluteBindMatrices(void 0,!1)}}_getNodeMatrix(e){return e.matrix?z.FromArray(e.matrix):z.Compose(e.scale?S.FromArray(e.scale):S.One(),e.rotation?Z.FromArray(e.rotation):Z.Identity(),e.translation?S.FromArray(e.translation):S.Zero())}loadCameraAsync(e,t,n=()=>{}){const r=this._extensionsLoadCameraAsync(e,t,n);if(r)return r;const o=new Array;this.logOpen(`${e} ${t.name||""}`),this._babylonScene._blockEntityCollection=!!this._assetContainer;const a=new Gt(t.name||`camera${t.index}`,S.Zero(),this._babylonScene,!1);switch(a._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,a.ignoreParentScaling=!0,t._babylonCamera=a,a.rotation.set(0,Math.PI,0),t.type){case"perspective":{const i=t.perspective;if(!i)throw new Error(`${e}: Camera perspective properties are missing`);a.fov=i.yfov,a.minZ=i.znear,a.maxZ=i.zfar||0;break}case"orthographic":{if(!t.orthographic)throw new Error(`${e}: Camera orthographic properties are missing`);a.mode=Vn.ORTHOGRAPHIC_CAMERA,a.orthoLeft=-t.orthographic.xmag,a.orthoRight=t.orthographic.xmag,a.orthoBottom=-t.orthographic.ymag,a.orthoTop=t.orthographic.ymag,a.minZ=t.orthographic.znear,a.maxZ=t.orthographic.zfar;break}default:throw new Error(`${e}: Invalid camera type (${t.type})`)}return A.AddPointerMetadata(a,e),this._parent.onCameraLoadedObservable.notifyObservers(a),n(a),this.logClose(),Promise.all(o).then(()=>a)}_loadAnimationsAsync(){const e=this._gltf.animations;if(!e)return Promise.resolve();const t=new Array;for(let n=0;n<e.length;n++){const r=e[n];t.push(this.loadAnimationAsync(`/animations/${r.index}`,r).then(o=>{o.targetedAnimations.length===0&&o.dispose()}))}return Promise.all(t).then(()=>{})}loadAnimationAsync(e,t){const n=this._extensionsLoadAnimationAsync(e,t);return n||$t(async()=>{const{AnimationGroup:r}=await import("./babylon-core-DLTSUY03.js").then(o=>o.an);return{AnimationGroup:r}},[],import.meta.url).then(({AnimationGroup:r})=>{this._babylonScene._blockEntityCollection=!!this._assetContainer;const o=new r(t.name||`animation${t.index}`,this._babylonScene);o._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._babylonAnimationGroup=o;const a=new Array;g.Assign(t.channels),g.Assign(t.samplers);for(const i of t.channels)a.push(this._loadAnimationChannelAsync(`${e}/channels/${i.index}`,e,t,i,(l,c)=>{l.animations=l.animations||[],l.animations.push(c),o.addTargetedAnimation(c,l)}));return Promise.all(a).then(()=>(o.normalize(0),o))})}async _loadAnimationChannelAsync(e,t,n,r,o){var d,f,m,b;const a=this._extensionsLoadAnimationChannelAsync(e,t,n,r,o);if(a)return a;if(r.target.node==null)return Promise.resolve();const i=g.Get(`${e}/target/node`,this._gltf.nodes,r.target.node),l=r.target.path,c=l==="weights";if(c&&!i._numMorphTargets||!c&&!i._babylonTransformNode||!this._parent.loadNodeAnimations&&!c&&!i._isJoint)return Promise.resolve();await $t(()=>Promise.resolve().then(()=>ar),void 0,import.meta.url);let u;switch(l){case"translation":{u=(d=ze("/nodes/{}/translation"))==null?void 0:d.interpolation;break}case"rotation":{u=(f=ze("/nodes/{}/rotation"))==null?void 0:f.interpolation;break}case"scale":{u=(m=ze("/nodes/{}/scale"))==null?void 0:m.interpolation;break}case"weights":{u=(b=ze("/nodes/{}/weights"))==null?void 0:b.interpolation;break}default:throw new Error(`${e}/target/path: Invalid value (${r.target.path})`)}if(!u)throw new Error(`${e}/target/path: Could not find interpolation properties for target path (${r.target.path})`);const h={object:i,info:u};return this._loadAnimationChannelFromTargetInfoAsync(e,t,n,r,h,o)}_loadAnimationChannelFromTargetInfoAsync(e,t,n,r,o,a){const i=this.parent.targetFps,l=1/i,c=g.Get(`${e}/sampler`,n.samplers,r.sampler);return this._loadAnimationSamplerAsync(`${t}/samplers/${r.sampler}`,c).then(u=>{let h=0;const d=o.object,f=o.info;for(const m of f){const b=m.getStride(d),E=u.input,v=u.output,D=new Array(E.length);let k=0;switch(u.interpolation){case"STEP":{for(let N=0;N<E.length;N++){const w=m.getValue(d,v,k,1);k+=b,D[N]={frame:E[N]*i,value:w,interpolation:1}}break}case"CUBICSPLINE":{for(let N=0;N<E.length;N++){const w=m.getValue(d,v,k,l);k+=b;const C=m.getValue(d,v,k,1);k+=b;const x=m.getValue(d,v,k,l);k+=b,D[N]={frame:E[N]*i,inTangent:w,value:C,outTangent:x}}break}case"LINEAR":{for(let N=0;N<E.length;N++){const w=m.getValue(d,v,k,1);k+=b,D[N]={frame:E[N]*i,value:w}}break}}if(k>0){const N=`${n.name||`animation${n.index}`}_channel${r.index}_${h}`,w=m.buildAnimations(d,N,i,D);for(const C of w)h++,a(C.babylonAnimatable,C.babylonAnimation)}}})}_loadAnimationSamplerAsync(e,t){if(t._data)return t._data;const n=t.interpolation||"LINEAR";switch(n){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw new Error(`${e}/interpolation: Invalid value (${t.interpolation})`)}const r=g.Get(`${e}/input`,this._gltf.accessors,t.input),o=g.Get(`${e}/output`,this._gltf.accessors,t.output);return t._data=Promise.all([this._loadFloatAccessorAsync(`/accessors/${r.index}`,r),this._loadFloatAccessorAsync(`/accessors/${o.index}`,o)]).then(([a,i])=>({input:a,interpolation:n,output:i})),t._data}loadBufferAsync(e,t,n,r){const o=this._extensionsLoadBufferAsync(e,t,n,r);if(o)return o;if(!t._data)if(t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{if(!this._bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);t._data=this._bin.readAsync(0,t.byteLength)}return t._data.then(a=>{try{return new Uint8Array(a.buffer,a.byteOffset+n,r)}catch(i){throw new Error(`${e}: ${i.message}`)}})}loadBufferViewAsync(e,t){const n=this._extensionsLoadBufferViewAsync(e,t);if(n)return n;if(t._data)return t._data;const r=g.Get(`${e}/buffer`,this._gltf.buffers,t.buffer);return t._data=this.loadBufferAsync(`/buffers/${r.index}`,r,t.byteOffset||0,t.byteLength),t._data}_loadAccessorAsync(e,t,n){if(t._data)return t._data;const r=A._GetNumComponents(e,t.type),o=r*M.GetTypeByteLength(t.componentType),a=r*t.count;if(t.bufferView==null)t._data=Promise.resolve(new n(a));else{const i=g.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${i.index}`,i).then(l=>{if(t.componentType===5126&&!t.normalized&&(!i.byteStride||i.byteStride===o))return A._GetTypedArray(e,t.componentType,l,t.byteOffset,a);{const c=new n(a);return M.ForEach(l,t.byteOffset||0,i.byteStride||o,r,t.componentType,c.length,t.normalized||!1,(u,h)=>{c[h]=u}),c}})}if(t.sparse){const i=t.sparse;t._data=t._data.then(l=>{const c=l,u=g.Get(`${e}/sparse/indices/bufferView`,this._gltf.bufferViews,i.indices.bufferView),h=g.Get(`${e}/sparse/values/bufferView`,this._gltf.bufferViews,i.values.bufferView);return Promise.all([this.loadBufferViewAsync(`/bufferViews/${u.index}`,u),this.loadBufferViewAsync(`/bufferViews/${h.index}`,h)]).then(([d,f])=>{const m=A._GetTypedArray(`${e}/sparse/indices`,i.indices.componentType,d,i.indices.byteOffset,i.count),b=r*i.count;let E;if(t.componentType===5126&&!t.normalized)E=A._GetTypedArray(`${e}/sparse/values`,t.componentType,f,i.values.byteOffset,b);else{const D=A._GetTypedArray(`${e}/sparse/values`,t.componentType,f,i.values.byteOffset,b);E=new n(b),M.ForEach(D,0,o,r,t.componentType,E.length,t.normalized||!1,(k,N)=>{E[N]=k})}let v=0;for(let D=0;D<m.length;D++){let k=m[D]*r;for(let N=0;N<r;N++)c[k++]=E[v++]}return c})})}return t._data}_loadFloatAccessorAsync(e,t){return this._loadAccessorAsync(e,t,Float32Array)}_loadIndicesAccessorAsync(e,t){if(t.type!=="SCALAR")throw new Error(`${e}/type: Invalid value ${t.type}`);if(t.componentType!==5121&&t.componentType!==5123&&t.componentType!==5125)throw new Error(`${e}/componentType: Invalid value ${t.componentType}`);if(t._data)return t._data;if(t.sparse){const n=A._GetTypedArrayConstructor(`${e}/componentType`,t.componentType);t._data=this._loadAccessorAsync(e,t,n)}else{const n=g.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${n.index}`,n).then(r=>A._GetTypedArray(e,t.componentType,r,t.byteOffset,t.count))}return t._data}_loadVertexBufferViewAsync(e){if(e._babylonBuffer)return e._babylonBuffer;const t=this._babylonScene.getEngine();return e._babylonBuffer=this.loadBufferViewAsync(`/bufferViews/${e.index}`,e).then(n=>new ds(t,n,!1)),e._babylonBuffer}_loadVertexAccessorAsync(e,t,n){var o;if((o=t._babylonVertexBuffer)!=null&&o[n])return t._babylonVertexBuffer[n];t._babylonVertexBuffer||(t._babylonVertexBuffer={});const r=this._babylonScene.getEngine();if(t.sparse||t.bufferView==null)t._babylonVertexBuffer[n]=this._loadFloatAccessorAsync(e,t).then(a=>new M(r,a,n,!1));else{const a=g.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._babylonVertexBuffer[n]=this._loadVertexBufferViewAsync(a).then(i=>{const l=A._GetNumComponents(e,t.type);return new M(r,i,n,!1,void 0,a.byteStride,void 0,t.byteOffset,l,t.componentType,t.normalized,!0,void 0,!0)})}return t._babylonVertexBuffer[n]}_loadMaterialMetallicRoughnessPropertiesAsync(e,t,n){if(!(n instanceof q))throw new Error(`${e}: Material type not supported`);const r=new Array;return t&&(t.baseColorFactor?(n.albedoColor=F.FromArray(t.baseColorFactor),n.alpha=t.baseColorFactor[3]):n.albedoColor=F.White(),n.metallic=t.metallicFactor==null?1:t.metallicFactor,n.roughness=t.roughnessFactor==null?1:t.roughnessFactor,t.baseColorTexture&&r.push(this.loadTextureInfoAsync(`${e}/baseColorTexture`,t.baseColorTexture,o=>{o.name=`${n.name} (Base Color)`,n.albedoTexture=o})),t.metallicRoughnessTexture&&(t.metallicRoughnessTexture.nonColorData=!0,r.push(this.loadTextureInfoAsync(`${e}/metallicRoughnessTexture`,t.metallicRoughnessTexture,o=>{o.name=`${n.name} (Metallic Roughness)`,n.metallicTexture=o})),n.useMetallnessFromMetallicTextureBlue=!0,n.useRoughnessFromMetallicTextureGreen=!0,n.useRoughnessFromMetallicTextureAlpha=!1)),Promise.all(r).then(()=>{})}_loadMaterialAsync(e,t,n,r,o=()=>{}){const a=this._extensionsLoadMaterialAsync(e,t,n,r,o);if(a)return a;t._data=t._data||{};let i=t._data[r];if(!i){this.logOpen(`${e} ${t.name||""}`);const l=this.createMaterial(e,t,r);i={babylonMaterial:l,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(e,t,l)},t._data[r]=i,A.AddPointerMetadata(l,e),this._parent.onMaterialLoadedObservable.notifyObservers(l),this.logClose()}return n&&(i.babylonMeshes.push(n),n.onDisposeObservable.addOnce(()=>{const l=i.babylonMeshes.indexOf(n);l!==-1&&i.babylonMeshes.splice(l,1)})),o(i.babylonMaterial),i.promise.then(()=>i.babylonMaterial)}_createDefaultMaterial(e,t){this._babylonScene._blockEntityCollection=!!this._assetContainer;const n=new q(e,this._babylonScene);return n._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,n.fillMode=t,n.enableSpecularAntiAliasing=!0,n.useRadianceOverAlpha=!this._parent.transparencyAsCoverage,n.useSpecularOverAlpha=!this._parent.transparencyAsCoverage,n.transparencyMode=q.PBRMATERIAL_OPAQUE,n.metallic=1,n.roughness=1,n}createMaterial(e,t,n){const r=this._extensionsCreateMaterial(e,t,n);if(r)return r;const o=t.name||`material${t.index}`;return this._createDefaultMaterial(o,n)}loadMaterialPropertiesAsync(e,t,n){const r=this._extensionsLoadMaterialPropertiesAsync(e,t,n);if(r)return r;const o=new Array;return o.push(this.loadMaterialBasePropertiesAsync(e,t,n)),t.pbrMetallicRoughness&&o.push(this._loadMaterialMetallicRoughnessPropertiesAsync(`${e}/pbrMetallicRoughness`,t.pbrMetallicRoughness,n)),this.loadMaterialAlphaProperties(e,t,n),Promise.all(o).then(()=>{})}loadMaterialBasePropertiesAsync(e,t,n){if(!(n instanceof q))throw new Error(`${e}: Material type not supported`);const r=new Array;return n.emissiveColor=t.emissiveFactor?F.FromArray(t.emissiveFactor):new F(0,0,0),t.doubleSided&&(n.backFaceCulling=!1,n.twoSidedLighting=!0),t.normalTexture&&(t.normalTexture.nonColorData=!0,r.push(this.loadTextureInfoAsync(`${e}/normalTexture`,t.normalTexture,o=>{o.name=`${n.name} (Normal)`,n.bumpTexture=o})),n.invertNormalMapX=!this._babylonScene.useRightHandedSystem,n.invertNormalMapY=this._babylonScene.useRightHandedSystem,t.normalTexture.scale!=null&&n.bumpTexture&&(n.bumpTexture.level=t.normalTexture.scale),n.forceIrradianceInFragment=!0),t.occlusionTexture&&(t.occlusionTexture.nonColorData=!0,r.push(this.loadTextureInfoAsync(`${e}/occlusionTexture`,t.occlusionTexture,o=>{o.name=`${n.name} (Occlusion)`,n.ambientTexture=o})),n.useAmbientInGrayScale=!0,t.occlusionTexture.strength!=null&&(n.ambientTextureStrength=t.occlusionTexture.strength)),t.emissiveTexture&&r.push(this.loadTextureInfoAsync(`${e}/emissiveTexture`,t.emissiveTexture,o=>{o.name=`${n.name} (Emissive)`,n.emissiveTexture=o})),Promise.all(r).then(()=>{})}loadMaterialAlphaProperties(e,t,n){if(!(n instanceof q))throw new Error(`${e}: Material type not supported`);switch(t.alphaMode||"OPAQUE"){case"OPAQUE":{n.transparencyMode=q.PBRMATERIAL_OPAQUE,n.alpha=1;break}case"MASK":{n.transparencyMode=q.PBRMATERIAL_ALPHATEST,n.alphaCutOff=t.alphaCutoff==null?.5:t.alphaCutoff,n.albedoTexture&&(n.albedoTexture.hasAlpha=!0);break}case"BLEND":{n.transparencyMode=q.PBRMATERIAL_ALPHABLEND,n.albedoTexture&&(n.albedoTexture.hasAlpha=!0,n.useAlphaFromAlbedoTexture=!0);break}default:throw new Error(`${e}/alphaMode: Invalid value (${t.alphaMode})`)}}loadTextureInfoAsync(e,t,n=()=>{}){const r=this._extensionsLoadTextureInfoAsync(e,t,n);if(r)return r;if(this.logOpen(`${e}`),t.texCoord>=6)throw new Error(`${e}/texCoord: Invalid value (${t.texCoord})`);const o=g.Get(`${e}/index`,this._gltf.textures,t.index);o._textureInfo=t;const a=this._loadTextureAsync(`/textures/${t.index}`,o,i=>{i.coordinatesIndex=t.texCoord||0,A.AddPointerMetadata(i,e),this._parent.onTextureLoadedObservable.notifyObservers(i),n(i)});return this.logClose(),a}_loadTextureAsync(e,t,n=()=>{}){const r=this._extensionsLoadTextureAsync(e,t,n);if(r)return r;this.logOpen(`${e} ${t.name||""}`);const o=t.sampler==null?A.DefaultSampler:g.Get(`${e}/sampler`,this._gltf.samplers,t.sampler),a=g.Get(`${e}/source`,this._gltf.images,t.source),i=this._createTextureAsync(e,o,a,n,void 0,!t._textureInfo.nonColorData);return this.logClose(),i}_createTextureAsync(e,t,n,r=()=>{},o,a){const i=this._loadSampler(`/samplers/${t.index}`,t),l=new Array,c=new Ve;this._babylonScene._blockEntityCollection=!!this._assetContainer;const u={noMipmap:i.noMipMaps,invertY:!1,samplingMode:i.samplingMode,onLoad:()=>{this._disposed||c.resolve()},onError:(d,f)=>{this._disposed||c.reject(new Error(`${e}: ${f&&f.message?f.message:d||"Failed to load texture"}`))},mimeType:n.mimeType,loaderOptions:o,useSRGBBuffer:!!a&&this._parent.useSRGBBuffers},h=new $(null,this._babylonScene,u);return h._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,l.push(c.promise),l.push(this.loadImageAsync(`/images/${n.index}`,n).then(d=>{const f=n.uri||`${this._fileName}#image${n.index}`,m=`data:${this._uniqueRootUrl}${f}`;h.updateURL(m,d);const b=h.getInternalTexture();b&&(b.label=n.name)})),h.wrapU=i.wrapU,h.wrapV=i.wrapV,r(h),this._parent.useGltfTextureNames&&(h.name=n.name||n.uri||`image${n.index}`),Promise.all(l).then(()=>h)}_loadSampler(e,t){return t._data||(t._data={noMipMaps:t.minFilter===9728||t.minFilter===9729,samplingMode:A._GetTextureSamplingMode(e,t),wrapU:A._GetTextureWrapMode(`${e}/wrapS`,t.wrapS),wrapV:A._GetTextureWrapMode(`${e}/wrapT`,t.wrapT)}),t._data}loadImageAsync(e,t){if(!t._data){if(this.logOpen(`${e} ${t.name||""}`),t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{const n=g.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${n.index}`,n)}this.logClose()}return t._data}loadUriAsync(e,t,n){const r=this._extensionsLoadUriAsync(e,t,n);if(r)return r;if(!A._ValidateUri(n))throw new Error(`${e}: '${n}' is invalid`);if(fs(n)){const o=new Uint8Array(Bn(n));return this.log(`${e}: Decoded ${n.substring(0,64)}... (${o.length} bytes)`),Promise.resolve(o)}return this.log(`${e}: Loading ${n}`),this._parent.preprocessUrlAsync(this._rootUrl+n).then(o=>new Promise((a,i)=>{this._parent._loadFile(this._babylonScene,o,l=>{this._disposed||(this.log(`${e}: Loaded ${n} (${l.byteLength} bytes)`),a(new Uint8Array(l)))},!0,l=>{i(new ps(`${e}: Failed to load '${n}'${l?": "+l.status+" "+l.statusText:""}`,l))})}))}static AddPointerMetadata(e,t){e.metadata=e.metadata||{};const n=e._internalMetadata=e._internalMetadata||{},r=n.gltf=n.gltf||{};(r.pointers=r.pointers||[]).push(t)}static _GetTextureWrapMode(e,t){switch(t=t??10497,t){case 33071:return $.CLAMP_ADDRESSMODE;case 33648:return $.MIRROR_ADDRESSMODE;case 10497:return $.WRAP_ADDRESSMODE;default:return I.Warn(`${e}: Invalid value (${t})`),$.WRAP_ADDRESSMODE}}static _GetTextureSamplingMode(e,t){const n=t.magFilter==null?9729:t.magFilter,r=t.minFilter==null?9987:t.minFilter;if(n===9729)switch(r){case 9728:return $.LINEAR_NEAREST;case 9729:return $.LINEAR_LINEAR;case 9984:return $.LINEAR_NEAREST_MIPNEAREST;case 9985:return $.LINEAR_LINEAR_MIPNEAREST;case 9986:return $.LINEAR_NEAREST_MIPLINEAR;case 9987:return $.LINEAR_LINEAR_MIPLINEAR;default:return I.Warn(`${e}/minFilter: Invalid value (${r})`),$.LINEAR_LINEAR_MIPLINEAR}else switch(n!==9728&&I.Warn(`${e}/magFilter: Invalid value (${n})`),r){case 9728:return $.NEAREST_NEAREST;case 9729:return $.NEAREST_LINEAR;case 9984:return $.NEAREST_NEAREST_MIPNEAREST;case 9985:return $.NEAREST_LINEAR_MIPNEAREST;case 9986:return $.NEAREST_NEAREST_MIPLINEAR;case 9987:return $.NEAREST_LINEAR_MIPLINEAR;default:return I.Warn(`${e}/minFilter: Invalid value (${r})`),$.NEAREST_NEAREST_MIPNEAREST}}static _GetTypedArrayConstructor(e,t){try{return ms(t)}catch(n){throw new Error(`${e}: ${n.message}`)}}static _GetTypedArray(e,t,n,r,o){const a=n.buffer;r=n.byteOffset+(r||0);const i=A._GetTypedArrayConstructor(`${e}/componentType`,t),l=M.GetTypeByteLength(t);return r%l!==0?(I.Warn(`${e}: Copying buffer as byte offset (${r}) is not a multiple of component type byte length (${l})`),new i(a.slice(r,r+o*l),0)):new i(a,r,o)}static _GetNumComponents(e,t){switch(t){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw new Error(`${e}: Invalid type (${t})`)}static _ValidateUri(e){return B.IsBase64(e)||e.indexOf("..")===-1}static _GetDrawMode(e,t){switch(t==null&&(t=4),t){case 0:return de.PointListDrawMode;case 1:return de.LineListDrawMode;case 2:return de.LineLoopDrawMode;case 3:return de.LineStripDrawMode;case 4:return de.TriangleFillMode;case 5:return de.TriangleStripDrawMode;case 6:return de.TriangleFanDrawMode}throw new Error(`${e}: Invalid mesh primitive mode (${t})`)}_compileMaterialsAsync(){this._parent._startPerformanceCounter("Compile materials");const e=new Array;if(this._gltf.materials){for(const t of this._gltf.materials)if(t._data)for(const n in t._data){const r=t._data[n];for(const o of r.babylonMeshes){o.computeWorldMatrix(!0);const a=r.babylonMaterial;e.push(a.forceCompilationAsync(o)),e.push(a.forceCompilationAsync(o,{useInstances:!0})),this._parent.useClipPlane&&(e.push(a.forceCompilationAsync(o,{clipPlane:!0})),e.push(a.forceCompilationAsync(o,{clipPlane:!0,useInstances:!0})))}}}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile materials")})}_compileShadowGeneratorsAsync(){this._parent._startPerformanceCounter("Compile shadow generators");const e=new Array,t=this._babylonScene.lights;for(const n of t){const r=n.getShadowGenerator();r&&e.push(r.forceCompilationAsync())}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile shadow generators")})}_forEachExtensions(e){for(const t of this._extensions)t.enabled&&e(t)}_applyExtensions(e,t,n){for(const r of this._extensions)if(r.enabled){const o=`${r.name}.${t}`,a=e;a._activeLoaderExtensionFunctions=a._activeLoaderExtensionFunctions||{};const i=a._activeLoaderExtensionFunctions;if(!i[o]){i[o]=!0;try{const l=n(r);if(l)return l}finally{delete i[o]}}}return null}_extensionsOnLoading(){this._forEachExtensions(e=>e.onLoading&&e.onLoading())}_extensionsOnReady(){this._forEachExtensions(e=>e.onReady&&e.onReady())}_extensionsLoadSceneAsync(e,t){return this._applyExtensions(t,"loadScene",n=>n.loadSceneAsync&&n.loadSceneAsync(e,t))}_extensionsLoadNodeAsync(e,t,n){return this._applyExtensions(t,"loadNode",r=>r.loadNodeAsync&&r.loadNodeAsync(e,t,n))}_extensionsLoadCameraAsync(e,t,n){return this._applyExtensions(t,"loadCamera",r=>r.loadCameraAsync&&r.loadCameraAsync(e,t,n))}_extensionsLoadVertexDataAsync(e,t,n){return this._applyExtensions(t,"loadVertexData",r=>r._loadVertexDataAsync&&r._loadVertexDataAsync(e,t,n))}_extensionsLoadMeshPrimitiveAsync(e,t,n,r,o,a){return this._applyExtensions(o,"loadMeshPrimitive",i=>i._loadMeshPrimitiveAsync&&i._loadMeshPrimitiveAsync(e,t,n,r,o,a))}_extensionsLoadMaterialAsync(e,t,n,r,o){return this._applyExtensions(t,"loadMaterial",a=>a._loadMaterialAsync&&a._loadMaterialAsync(e,t,n,r,o))}_extensionsCreateMaterial(e,t,n){return this._applyExtensions(t,"createMaterial",r=>r.createMaterial&&r.createMaterial(e,t,n))}_extensionsLoadMaterialPropertiesAsync(e,t,n){return this._applyExtensions(t,"loadMaterialProperties",r=>r.loadMaterialPropertiesAsync&&r.loadMaterialPropertiesAsync(e,t,n))}_extensionsLoadTextureInfoAsync(e,t,n){return this._applyExtensions(t,"loadTextureInfo",r=>r.loadTextureInfoAsync&&r.loadTextureInfoAsync(e,t,n))}_extensionsLoadTextureAsync(e,t,n){return this._applyExtensions(t,"loadTexture",r=>r._loadTextureAsync&&r._loadTextureAsync(e,t,n))}_extensionsLoadAnimationAsync(e,t){return this._applyExtensions(t,"loadAnimation",n=>n.loadAnimationAsync&&n.loadAnimationAsync(e,t))}_extensionsLoadAnimationChannelAsync(e,t,n,r,o){return this._applyExtensions(n,"loadAnimationChannel",a=>a._loadAnimationChannelAsync&&a._loadAnimationChannelAsync(e,t,n,r,o))}_extensionsLoadSkinAsync(e,t,n){return this._applyExtensions(n,"loadSkin",r=>r._loadSkinAsync&&r._loadSkinAsync(e,t,n))}_extensionsLoadUriAsync(e,t,n){return this._applyExtensions(t,"loadUri",r=>r._loadUriAsync&&r._loadUriAsync(e,t,n))}_extensionsLoadBufferViewAsync(e,t){return this._applyExtensions(t,"loadBufferView",n=>n.loadBufferViewAsync&&n.loadBufferViewAsync(e,t))}_extensionsLoadBufferAsync(e,t,n,r){return this._applyExtensions(t,"loadBuffer",o=>o.loadBufferAsync&&o.loadBufferAsync(e,t,n,r))}static LoadExtensionAsync(e,t,n,r){if(!t.extensions)return null;const a=t.extensions[n];return a?r(`${e}/extensions/${n}`,a):null}static LoadExtraAsync(e,t,n,r){if(!t.extras)return null;const a=t.extras[n];return a?r(`${e}/extras/${n}`,a):null}isExtensionUsed(e){return!!this._gltf.extensionsUsed&&this._gltf.extensionsUsed.indexOf(e)!==-1}logOpen(e){this._parent._logOpen(e)}logClose(){this._parent._logClose()}log(e){this._parent._log(e)}startPerformanceCounter(e){this._parent._startPerformanceCounter(e)}endPerformanceCounter(e){this._parent._endPerformanceCounter(e)}}A.DefaultSampler={index:-1};X._CreateGLTF2Loader=s=>new A(s);function Zt(s,e,t,n){return S.FromArray(e,t).scaleInPlace(n)}function Xn(s,e,t,n){return Z.FromArray(e,t).scaleInPlace(n)}function Zn(s,e,t,n){const r=new Array(s._numMorphTargets);for(let o=0;o<r.length;o++)r[o]=e[t++]*n;return r}class Be{constructor(e,t,n,r){this.type=e,this.name=t,this.getValue=n,this.getStride=r}_buildAnimation(e,t,n){const r=new T(e,this.name,t,this.type);return r.setKeys(n),r}}class Pt extends Be{buildAnimations(e,t,n,r){const o=[];return o.push({babylonAnimatable:e._babylonTransformNode,babylonAnimation:this._buildAnimation(t,n,r)}),o}}class Qn extends Be{buildAnimations(e,t,n,r){const o=[];if(e._numMorphTargets)for(let a=0;a<e._numMorphTargets;a++){const i=new T(`${t}_${a}`,this.name,n,this.type);if(i.setKeys(r.map(l=>({frame:l.frame,inTangent:l.inTangent?l.inTangent[a]:void 0,value:l.value[a],outTangent:l.outTangent?l.outTangent[a]:void 0,interpolation:l.interpolation}))),e._primitiveBabylonMeshes){for(const l of e._primitiveBabylonMeshes)if(l.morphTargetManager){const c=l.morphTargetManager.getTarget(a),u=i.clone();c.animations.push(u),o.push({babylonAnimatable:c,babylonAnimation:u})}}}return o}}p("/nodes/{}/translation",[new Pt(T.ANIMATIONTYPE_VECTOR3,"position",Zt,()=>3)]);p("/nodes/{}/rotation",[new Pt(T.ANIMATIONTYPE_QUATERNION,"rotationQuaternion",Xn,()=>4)]);p("/nodes/{}/scale",[new Pt(T.ANIMATIONTYPE_VECTOR3,"scaling",Zt,()=>3)]);p("/nodes/{}/weights",[new Qn(T.ANIMATIONTYPE_FLOAT,"influence",Zn,s=>s._numMorphTargets)]);const ar=Object.freeze(Object.defineProperty({__proto__:null,AnimationPropertyInfo:Be,TransformNodeAnimationPropertyInfo:Pt,WeightAnimationPropertyInfo:Qn,getQuaternion:Xn,getVector3:Zt,getWeights:Zn},Symbol.toStringTag,{value:"Module"})),tt="EXT_lights_image_based";class ir{constructor(e){this.name=tt,this._loader=e,this.enabled=this._loader.isExtensionUsed(tt)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights}}loadSceneAsync(e,t){return A.LoadExtensionAsync(e,t,this.name,(n,r)=>{this._loader._allMaterialsDirtyRequired=!0;const o=new Array;o.push(this._loader.loadSceneAsync(e,t)),this._loader.logOpen(`${n}`);const a=g.Get(`${n}/light`,this._lights,r.light);return o.push(this._loadLightAsync(`/extensions/${this.name}/lights/${r.light}`,a).then(i=>{this._loader.babylonScene.environmentTexture=i})),this._loader.logClose(),Promise.all(o).then(()=>{})})}_loadLightAsync(e,t){if(!t._loaded){const n=new Array;this._loader.logOpen(`${e}`);const r=new Array(t.specularImages.length);for(let o=0;o<t.specularImages.length;o++){const a=t.specularImages[o];r[o]=new Array(a.length);for(let i=0;i<a.length;i++){const l=`${e}/specularImages/${o}/${i}`;this._loader.logOpen(`${l}`);const c=a[i],u=g.Get(l,this._loader.gltf.images,c);n.push(this._loader.loadImageAsync(`/images/${c}`,u).then(h=>{r[o][i]=h})),this._loader.logClose()}}this._loader.logClose(),t._loaded=Promise.all(n).then(()=>{const o=new gs(this._loader.babylonScene,null,t.specularImageSize);if(o.name=t.name||"environment",t._babylonTexture=o,t.intensity!=null&&(o.level=t.intensity),t.rotation){let c=Z.FromArray(t.rotation);this._loader.babylonScene.useRightHandedSystem||(c=Z.Inverse(c)),z.FromQuaternionToRef(c,o.getReflectionTextureMatrix())}if(!t.irradianceCoefficients)throw new Error(`${e}: Irradiance coefficients are missing`);const a=ys.FromArray(t.irradianceCoefficients);a.scaleInPlace(t.intensity),a.convertIrradianceToLambertianRadiance();const i=bs.FromHarmonics(a),l=(r.length-1)/Math.log2(t.specularImageSize);return o.updateRGBDAsync(r,i,l)})}return t._loaded.then(()=>t._babylonTexture)}}P(tt);L(tt,!0,s=>new ir(s));const nt="EXT_mesh_gpu_instancing";class lr{constructor(e){this.name=nt,this._loader=e,this.enabled=this._loader.isExtensionUsed(nt)}dispose(){this._loader=null}loadNodeAsync(e,t,n){return A.LoadExtensionAsync(e,t,this.name,(r,o)=>{this._loader._disableInstancedMesh++;const a=this._loader.loadNodeAsync(`/nodes/${t.index}`,t,n);if(this._loader._disableInstancedMesh--,!t._primitiveBabylonMeshes)return a;const i=new Array;let l=0;const c=u=>{if(o.attributes[u]==null){i.push(Promise.resolve(null));return}const h=g.Get(`${r}/attributes/${u}`,this._loader.gltf.accessors,o.attributes[u]);if(i.push(this._loader._loadFloatAccessorAsync(`/accessors/${h.bufferView}`,h)),l===0)l=h.count;else if(l!==h.count)throw new Error(`${r}/attributes: Instance buffer accessors do not have the same count.`)};return c("TRANSLATION"),c("ROTATION"),c("SCALE"),a.then(u=>Promise.all(i).then(([h,d,f])=>{const m=new Float32Array(l*16);ue.Vector3[0].copyFromFloats(0,0,0),ue.Quaternion[0].copyFromFloats(0,0,0,1),ue.Vector3[1].copyFromFloats(1,1,1);for(let b=0;b<l;++b)h&&S.FromArrayToRef(h,b*3,ue.Vector3[0]),d&&Z.FromArrayToRef(d,b*4,ue.Quaternion[0]),f&&S.FromArrayToRef(f,b*3,ue.Vector3[1]),z.ComposeToRef(ue.Vector3[1],ue.Quaternion[0],ue.Vector3[0],ue.Matrix[0]),ue.Matrix[0].copyToArray(m,b*16);for(const b of t._primitiveBabylonMeshes)b.thinInstanceSetBuffer("matrix",m,16,!0);return u}))})}}P(nt);L(nt,!0,s=>new lr(s));const st="EXT_meshopt_compression";class cr{constructor(e){this.name=st,this.enabled=e.isExtensionUsed(st),this._loader=e}dispose(){this._loader=null}loadBufferViewAsync(e,t){return A.LoadExtensionAsync(e,t,this.name,(n,r)=>{const o=t;if(o._meshOptData)return o._meshOptData;const a=g.Get(`${e}/buffer`,this._loader.gltf.buffers,r.buffer);return o._meshOptData=this._loader.loadBufferAsync(`/buffers/${a.index}`,a,r.byteOffset||0,r.byteLength).then(i=>As.Default.decodeGltfBufferAsync(i,r.count,r.byteStride,r.mode,r.filter)),o._meshOptData})}}P(st);L(st,!0,s=>new cr(s));const rt="EXT_texture_webp";class ur{constructor(e){this.name=rt,this._loader=e,this.enabled=e.isExtensionUsed(rt)}dispose(){this._loader=null}_loadTextureAsync(e,t,n){return A.LoadExtensionAsync(e,t,this.name,(r,o)=>{const a=t.sampler==null?A.DefaultSampler:g.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),i=g.Get(`${r}/source`,this._loader.gltf.images,o.source);return this._loader._createTextureAsync(e,a,i,l=>{n(l)},void 0,!t._textureInfo.nonColorData)})}}P(rt);L(rt,!0,s=>new ur(s));const ot="EXT_texture_avif";class hr{constructor(e){this.name=ot,this._loader=e,this.enabled=e.isExtensionUsed(ot)}dispose(){this._loader=null}_loadTextureAsync(e,t,n){return A.LoadExtensionAsync(e,t,this.name,(r,o)=>{const a=t.sampler==null?A.DefaultSampler:g.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),i=g.Get(`${r}/source`,this._loader.gltf.images,o.source);return this._loader._createTextureAsync(e,a,i,l=>{n(l)},void 0,!t._textureInfo.nonColorData)})}}P(ot);L(ot,!0,s=>new hr(s));const at="EXT_lights_ies";class dr{constructor(e){this.name=at,this._loader=e,this.enabled=this._loader.isExtensionUsed(at)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights,g.Assign(this._lights)}}loadNodeAsync(e,t,n){return A.LoadExtensionAsync(e,t,this.name,async(r,o)=>{this._loader._allMaterialsDirtyRequired=!0;let a,i;const l=await this._loader.loadNodeAsync(e,t,u=>{i=g.Get(r,this._lights,o.light);const h=i.name||u.name;this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,a=new _e(h,S.Zero(),S.Backward(),0,1,this._loader.babylonScene),a.angle=Math.PI/2,a.innerAngle=0,a._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,i._babylonLight=a,a.falloffType=Kn.FALLOFF_GLTF,a.diffuse=o.color?F.FromArray(o.color):F.White(),a.intensity=o.multiplier||1,a.range=Number.MAX_VALUE,a.parent=u,this._loader._babylonLights.push(a),A.AddPointerMetadata(a,r),n(u)});let c;if(i.uri)c=await this._loader.loadUriAsync(e,i,i.uri);else{const u=g.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,i.bufferView);c=await this._loader.loadBufferViewAsync(`/bufferViews/${u.index}`,u)}return a.iesProfileTexture=new $(name+"_iesProfile",this._loader.babylonScene,!0,!1,void 0,null,null,c,!0,void 0,void 0,void 0,void 0,".ies"),l})}}P(at);L(at,!0,s=>new dr(s));const it="KHR_draco_mesh_compression";class fr{constructor(e){this.name=it,this.useNormalizedFlagFromAccessor=!0,this._loader=e,this.enabled=wn.DefaultAvailable&&this._loader.isExtensionUsed(it)}dispose(){delete this.dracoDecoder,this._loader=null}_loadVertexDataAsync(e,t,n){return A.LoadExtensionAsync(e,t,this.name,(r,o)=>{if(t.mode!=null&&t.mode!==4&&t.mode!==5)throw new Error(`${e}: Unsupported mode ${t.mode}`);const a={},i={},l=(u,h)=>{const d=o.attributes[u];if(d!=null&&(n._delayInfo=n._delayInfo||[],n._delayInfo.indexOf(h)===-1&&n._delayInfo.push(h),a[h]=d,this.useNormalizedFlagFromAccessor)){const f=g.TryGet(this._loader.gltf.accessors,t.attributes[u]);f&&(i[h]=f.normalized||!1)}};l("POSITION",M.PositionKind),l("NORMAL",M.NormalKind),l("TANGENT",M.TangentKind),l("TEXCOORD_0",M.UVKind),l("TEXCOORD_1",M.UV2Kind),l("TEXCOORD_2",M.UV3Kind),l("TEXCOORD_3",M.UV4Kind),l("TEXCOORD_4",M.UV5Kind),l("TEXCOORD_5",M.UV6Kind),l("JOINTS_0",M.MatricesIndicesKind),l("WEIGHTS_0",M.MatricesWeightsKind),l("COLOR_0",M.ColorKind);const c=g.Get(r,this._loader.gltf.bufferViews,o.bufferView);return c._dracoBabylonGeometry||(c._dracoBabylonGeometry=this._loader.loadBufferViewAsync(`/bufferViews/${c.index}`,c).then(u=>{const h=this.dracoDecoder||wn.Default,d=g.TryGet(this._loader.gltf.accessors,t.attributes.POSITION),f=!this._loader.parent.alwaysComputeBoundingBox&&!n.skeleton&&d?Jn(d):null;return h._decodeMeshToGeometryForGltfAsync(n.name,this._loader.babylonScene,u,a,i,f).catch(m=>{throw new Error(`${e}: ${m.message}`)})})),c._dracoBabylonGeometry})}}P(it);L(it,!0,s=>new fr(s));const lt="KHR_lights_punctual";class pr{constructor(e){this.name=lt,this._loader=e,this.enabled=this._loader.isExtensionUsed(lt)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights,g.Assign(this._lights)}}loadNodeAsync(e,t,n){return A.LoadExtensionAsync(e,t,this.name,(r,o)=>(this._loader._allMaterialsDirtyRequired=!0,this._loader.loadNodeAsync(e,t,a=>{let i;const l=g.Get(r,this._lights,o.light),c=l.name||a.name;switch(this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,l.type){case"directional":{const u=new Yt(c,S.Backward(),this._loader.babylonScene);u.position.setAll(0),i=u;break}case"point":{i=new jt(c,S.Zero(),this._loader.babylonScene);break}case"spot":{const u=new _e(c,S.Zero(),S.Backward(),0,1,this._loader.babylonScene);u.angle=(l.spot&&l.spot.outerConeAngle||Math.PI/4)*2,u.innerAngle=(l.spot&&l.spot.innerConeAngle||0)*2,i=u;break}default:throw this._loader.babylonScene._blockEntityCollection=!1,new Error(`${r}: Invalid light type (${l.type})`)}i._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,l._babylonLight=i,i.falloffType=Kn.FALLOFF_GLTF,i.diffuse=l.color?F.FromArray(l.color):F.White(),i.intensity=l.intensity==null?1:l.intensity,i.range=l.range==null?Number.MAX_VALUE:l.range,i.parent=a,this._loader._babylonLights.push(i),A.AddPointerMetadata(i,r),n(a)})))}}P(lt);L(lt,!0,s=>new pr(s));const ct="KHR_materials_pbrSpecularGlossiness";class mr{constructor(e){this.name=ct,this.order=200,this._loader=e,this.enabled=this._loader.isExtensionUsed(ct)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return A.LoadExtensionAsync(e,t,this.name,(r,o)=>{const a=new Array;return a.push(this._loader.loadMaterialBasePropertiesAsync(e,t,n)),a.push(this._loadSpecularGlossinessPropertiesAsync(r,o,n)),this._loader.loadMaterialAlphaProperties(e,t,n),Promise.all(a).then(()=>{})})}_loadSpecularGlossinessPropertiesAsync(e,t,n){if(!(n instanceof q))throw new Error(`${e}: Material type not supported`);const r=new Array;return n.metallic=null,n.roughness=null,t.diffuseFactor?(n.albedoColor=F.FromArray(t.diffuseFactor),n.alpha=t.diffuseFactor[3]):n.albedoColor=F.White(),n.reflectivityColor=t.specularFactor?F.FromArray(t.specularFactor):F.White(),n.microSurface=t.glossinessFactor==null?1:t.glossinessFactor,t.diffuseTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTexture`,t.diffuseTexture,o=>{o.name=`${n.name} (Diffuse)`,n.albedoTexture=o})),t.specularGlossinessTexture&&(r.push(this._loader.loadTextureInfoAsync(`${e}/specularGlossinessTexture`,t.specularGlossinessTexture,o=>{o.name=`${n.name} (Specular Glossiness)`,n.reflectivityTexture=o,n.reflectivityTexture.hasAlpha=!0})),n.useMicroSurfaceFromReflectivityMapAlpha=!0),Promise.all(r).then(()=>{})}}P(ct);L(ct,!0,s=>new mr(s));const ut="KHR_materials_unlit";class _r{constructor(e){this.name=ut,this.order=210,this._loader=e,this.enabled=this._loader.isExtensionUsed(ut)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return A.LoadExtensionAsync(e,t,this.name,()=>this._loadUnlitPropertiesAsync(e,t,n))}_loadUnlitPropertiesAsync(e,t,n){if(!(n instanceof q))throw new Error(`${e}: Material type not supported`);const r=new Array;n.unlit=!0;const o=t.pbrMetallicRoughness;return o&&(o.baseColorFactor?(n.albedoColor=F.FromArray(o.baseColorFactor),n.alpha=o.baseColorFactor[3]):n.albedoColor=F.White(),o.baseColorTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/baseColorTexture`,o.baseColorTexture,a=>{a.name=`${n.name} (Base Color)`,n.albedoTexture=a}))),t.doubleSided&&(n.backFaceCulling=!1,n.twoSidedLighting=!0),this._loader.loadMaterialAlphaProperties(e,t,n),Promise.all(r).then(()=>{})}}P(ut);L(ut,!0,s=>new _r(s));const ht="KHR_materials_clearcoat";class gr{constructor(e){this.name=ht,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(ht)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return A.LoadExtensionAsync(e,t,this.name,(r,o)=>{const a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),a.push(this._loadClearCoatPropertiesAsync(r,o,n)),Promise.all(a).then(()=>{})})}_loadClearCoatPropertiesAsync(e,t,n){if(!(n instanceof q))throw new Error(`${e}: Material type not supported`);const r=new Array;return n.clearCoat.isEnabled=!0,n.clearCoat.useRoughnessFromMainTexture=!1,n.clearCoat.remapF0OnInterfaceChange=!1,t.clearcoatFactor!=null?n.clearCoat.intensity=t.clearcoatFactor:n.clearCoat.intensity=0,t.clearcoatTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatTexture`,t.clearcoatTexture,o=>{o.name=`${n.name} (ClearCoat)`,n.clearCoat.texture=o})),t.clearcoatRoughnessFactor!=null?n.clearCoat.roughness=t.clearcoatRoughnessFactor:n.clearCoat.roughness=0,t.clearcoatRoughnessTexture&&(t.clearcoatRoughnessTexture.nonColorData=!0,r.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatRoughnessTexture`,t.clearcoatRoughnessTexture,o=>{o.name=`${n.name} (ClearCoat Roughness)`,n.clearCoat.textureRoughness=o}))),t.clearcoatNormalTexture&&(t.clearcoatNormalTexture.nonColorData=!0,r.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatNormalTexture`,t.clearcoatNormalTexture,o=>{o.name=`${n.name} (ClearCoat Normal)`,n.clearCoat.bumpTexture=o})),n.invertNormalMapX=!n.getScene().useRightHandedSystem,n.invertNormalMapY=n.getScene().useRightHandedSystem,t.clearcoatNormalTexture.scale!=null&&(n.clearCoat.bumpTexture.level=t.clearcoatNormalTexture.scale)),Promise.all(r).then(()=>{})}}P(ht);L(ht,!0,s=>new gr(s));const dt="KHR_materials_iridescence";class yr{constructor(e){this.name=dt,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(dt)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return A.LoadExtensionAsync(e,t,this.name,(r,o)=>{const a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),a.push(this._loadIridescencePropertiesAsync(r,o,n)),Promise.all(a).then(()=>{})})}_loadIridescencePropertiesAsync(e,t,n){if(!(n instanceof q))throw new Error(`${e}: Material type not supported`);const r=new Array;return n.iridescence.isEnabled=!0,n.iridescence.intensity=t.iridescenceFactor??0,n.iridescence.indexOfRefraction=t.iridescenceIor??t.iridescenceIOR??1.3,n.iridescence.minimumThickness=t.iridescenceThicknessMinimum??100,n.iridescence.maximumThickness=t.iridescenceThicknessMaximum??400,t.iridescenceTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceTexture`,t.iridescenceTexture,o=>{o.name=`${n.name} (Iridescence)`,n.iridescence.texture=o})),t.iridescenceThicknessTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceThicknessTexture`,t.iridescenceThicknessTexture,o=>{o.name=`${n.name} (Iridescence Thickness)`,n.iridescence.thicknessTexture=o})),Promise.all(r).then(()=>{})}}P(dt);L(dt,!0,s=>new yr(s));const ft="KHR_materials_anisotropy";class br{constructor(e){this.name=ft,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(ft)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return A.LoadExtensionAsync(e,t,this.name,(r,o)=>{const a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),a.push(this._loadIridescencePropertiesAsync(r,o,n)),Promise.all(a).then(()=>{})})}_loadIridescencePropertiesAsync(e,t,n){if(!(n instanceof q))throw new Error(`${e}: Material type not supported`);const r=new Array;return n.anisotropy.isEnabled=!0,n.anisotropy.intensity=t.anisotropyStrength??0,n.anisotropy.angle=t.anisotropyRotation??0,t.anisotropyTexture&&(t.anisotropyTexture.nonColorData=!0,r.push(this._loader.loadTextureInfoAsync(`${e}/anisotropyTexture`,t.anisotropyTexture,o=>{o.name=`${n.name} (Anisotropy Intensity)`,n.anisotropy.texture=o}))),Promise.all(r).then(()=>{})}}P(ft);L(ft,!0,s=>new br(s));const pt="KHR_materials_emissive_strength";class Ar{constructor(e){this.name=pt,this.order=170,this._loader=e,this.enabled=this._loader.isExtensionUsed(pt)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return A.LoadExtensionAsync(e,t,this.name,(r,o)=>this._loader.loadMaterialPropertiesAsync(e,t,n).then(()=>{this._loadEmissiveProperties(r,o,n)}))}_loadEmissiveProperties(e,t,n){if(!(n instanceof q))throw new Error(`${e}: Material type not supported`);t.emissiveStrength!==void 0&&(n.emissiveIntensity=t.emissiveStrength)}}P(pt);L(pt,!0,s=>new Ar(s));const mt="KHR_materials_sheen";class Tr{constructor(e){this.name=mt,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(mt)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return A.LoadExtensionAsync(e,t,this.name,(r,o)=>{const a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),a.push(this._loadSheenPropertiesAsync(r,o,n)),Promise.all(a).then(()=>{})})}_loadSheenPropertiesAsync(e,t,n){if(!(n instanceof q))throw new Error(`${e}: Material type not supported`);const r=new Array;return n.sheen.isEnabled=!0,n.sheen.intensity=1,t.sheenColorFactor!=null?n.sheen.color=F.FromArray(t.sheenColorFactor):n.sheen.color=F.Black(),t.sheenColorTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/sheenColorTexture`,t.sheenColorTexture,o=>{o.name=`${n.name} (Sheen Color)`,n.sheen.texture=o})),t.sheenRoughnessFactor!==void 0?n.sheen.roughness=t.sheenRoughnessFactor:n.sheen.roughness=0,t.sheenRoughnessTexture&&(t.sheenRoughnessTexture.nonColorData=!0,r.push(this._loader.loadTextureInfoAsync(`${e}/sheenRoughnessTexture`,t.sheenRoughnessTexture,o=>{o.name=`${n.name} (Sheen Roughness)`,n.sheen.textureRoughness=o}))),n.sheen.albedoScaling=!0,n.sheen.useRoughnessFromMainTexture=!1,Promise.all(r).then(()=>{})}}P(mt);L(mt,!0,s=>new Tr(s));const _t="KHR_materials_specular";class xr{constructor(e){this.name=_t,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(_t)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return A.LoadExtensionAsync(e,t,this.name,(r,o)=>{const a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),a.push(this._loadSpecularPropertiesAsync(r,o,n)),Promise.all(a).then(()=>{})})}_loadSpecularPropertiesAsync(e,t,n){if(!(n instanceof q))throw new Error(`${e}: Material type not supported`);const r=new Array;return t.specularFactor!==void 0&&(n.metallicF0Factor=t.specularFactor),t.specularColorFactor!==void 0&&(n.metallicReflectanceColor=F.FromArray(t.specularColorFactor)),t.specularTexture&&(t.specularTexture.nonColorData=!0,r.push(this._loader.loadTextureInfoAsync(`${e}/specularTexture`,t.specularTexture,o=>{o.name=`${n.name} (Specular)`,n.metallicReflectanceTexture=o,n.useOnlyMetallicFromMetallicReflectanceTexture=!0}))),t.specularColorTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/specularColorTexture`,t.specularColorTexture,o=>{o.name=`${n.name} (Specular Color)`,n.reflectanceTexture=o})),Promise.all(r).then(()=>{})}}P(_t);L(_t,!0,s=>new xr(s));const gt="KHR_materials_ior";class Lt{constructor(e){this.name=gt,this.order=180,this._loader=e,this.enabled=this._loader.isExtensionUsed(gt)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return A.LoadExtensionAsync(e,t,this.name,(r,o)=>{const a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),a.push(this._loadIorPropertiesAsync(r,o,n)),Promise.all(a).then(()=>{})})}_loadIorPropertiesAsync(e,t,n){if(!(n instanceof q))throw new Error(`${e}: Material type not supported`);return t.ior!==void 0?n.indexOfRefraction=t.ior:n.indexOfRefraction=Lt._DEFAULT_IOR,Promise.resolve()}}Lt._DEFAULT_IOR=1.5;P(gt);L(gt,!0,s=>new Lt(s));const te="KHR_materials_variants";class he{constructor(e){this.name=te,this._loader=e,this.enabled=this._loader.isExtensionUsed(te)}dispose(){this._loader=null}static GetAvailableVariants(e){const t=this._GetExtensionMetadata(e);return t?Object.keys(t.variants):[]}getAvailableVariants(e){return he.GetAvailableVariants(e)}static SelectVariant(e,t){const n=this._GetExtensionMetadata(e);if(!n)throw new Error(`Cannot select variant on a glTF mesh that does not have the ${te} extension`);const r=o=>{const a=n.variants[o];if(a)for(const i of a)i.mesh.material=i.material};if(t instanceof Array)for(const o of t)r(o);else r(t);n.lastSelected=t}selectVariant(e,t){he.SelectVariant(e,t)}static Reset(e){const t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot reset on a glTF mesh that does not have the ${te} extension`);for(const n of t.original)n.mesh.material=n.material;t.lastSelected=null}reset(e){he.Reset(e)}static GetLastSelectedVariant(e){const t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot get the last selected variant on a glTF mesh that does not have the ${te} extension`);return t.lastSelected}getLastSelectedVariant(e){return he.GetLastSelectedVariant(e)}static _GetExtensionMetadata(e){var t,n;return((n=(t=e==null?void 0:e._internalMetadata)==null?void 0:t.gltf)==null?void 0:n[te])||null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._variants=t.variants}}onReady(){var t;const e=this._loader.rootBabylonMesh;if(e){const n=this._loader.parent.extensionOptions[te];n!=null&&n.defaultVariant&&he.SelectVariant(e,n.defaultVariant),(t=n==null?void 0:n.onLoaded)==null||t.call(n,{get variants(){return he.GetAvailableVariants(e)},get selectedVariant(){const r=he.GetLastSelectedVariant(e);return r?Array.isArray(r)?r[0]:r:he.GetAvailableVariants(e)[0]},set selectedVariant(r){he.SelectVariant(e,r)}})}}_loadMeshPrimitiveAsync(e,t,n,r,o,a){return A.LoadExtensionAsync(e,o,this.name,(i,l)=>{const c=new Array;return c.push(this._loader._loadMeshPrimitiveAsync(e,t,n,r,o,u=>{if(a(u),u instanceof Pe){const h=A._GetDrawMode(e,o.mode),d=this._loader.rootBabylonMesh,f=d?d._internalMetadata=d._internalMetadata||{}:{},m=f.gltf=f.gltf||{},b=m[te]=m[te]||{lastSelected:null,original:[],variants:{}};b.original.push({mesh:u,material:u.material});for(let E=0;E<l.mappings.length;++E){const v=l.mappings[E],D=g.Get(`${i}/mappings/${E}/material`,this._loader.gltf.materials,v.material);c.push(this._loader._loadMaterialAsync(`#/materials/${v.material}`,D,u,h,k=>{for(let N=0;N<v.variants.length;++N){const w=v.variants[N],C=g.Get(`/extensions/${te}/variants/${w}`,this._variants,w);b.variants[C.name]=b.variants[C.name]||[],b.variants[C.name].push({mesh:u,material:k}),u.onClonedObservable.add(x=>{const O=x;let V=null,H=O;do{if(H=H.parent,!H)return;V=he._GetExtensionMetadata(H)}while(V===null);if(d&&V===he._GetExtensionMetadata(d)){H._internalMetadata={};for(const U in d._internalMetadata)H._internalMetadata[U]=d._internalMetadata[U];H._internalMetadata.gltf=[];for(const U in d._internalMetadata.gltf)H._internalMetadata.gltf[U]=d._internalMetadata.gltf[U];H._internalMetadata.gltf[te]={lastSelected:null,original:[],variants:{}};for(const U of V.original)H._internalMetadata.gltf[te].original.push({mesh:U.mesh,material:U.material});for(const U in V.variants)if(Object.prototype.hasOwnProperty.call(V.variants,U)){H._internalMetadata.gltf[te].variants[U]=[];for(const Xe of V.variants[U])H._internalMetadata.gltf[te].variants[U].push({mesh:Xe.mesh,material:Xe.material})}V=H._internalMetadata.gltf[te]}for(const U of V.original)U.mesh===u&&(U.mesh=O);for(const U of V.variants[C.name])U.mesh===u&&(U.mesh=O)})}}))}}})),Promise.all(c).then(([u])=>u)})}}P(te);L(te,!0,s=>new he(s));class Qt{static _GetDefaultOptions(){return{renderSize:1024,samples:4,lodGenerationScale:1,lodGenerationOffset:-4,renderTargetTextureType:Te.TEXTURETYPE_HALF_FLOAT,generateMipmaps:!0}}constructor(e,t){this._opaqueRenderTarget=null,this._opaqueMeshesCache=[],this._transparentMeshesCache=[],this._materialObservers={},this._options={...Qt._GetDefaultOptions(),...e},this._scene=t,this._scene._transmissionHelper=this,this.onErrorObservable=new se,this._scene.onDisposeObservable.addOnce(()=>{this.dispose()}),this._parseScene(),this._setupRenderTargets()}updateOptions(e){if(!Object.keys(e).filter(o=>this._options[o]!==e[o]).length)return;const n={...this._options,...e},r=this._options;this._options=n,n.renderSize!==r.renderSize||n.renderTargetTextureType!==r.renderTargetTextureType||n.generateMipmaps!==r.generateMipmaps||!this._opaqueRenderTarget?this._setupRenderTargets():(this._opaqueRenderTarget.samples=n.samples,this._opaqueRenderTarget.lodGenerationScale=n.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=n.lodGenerationOffset)}getOpaqueTarget(){return this._opaqueRenderTarget}_shouldRenderAsTransmission(e){return e?!!(e instanceof q&&e.subSurface.isRefractionEnabled):!1}_addMesh(e){this._materialObservers[e.uniqueId]=e.onMaterialChangedObservable.add(this._onMeshMaterialChanged.bind(this)),B.SetImmediate(()=>{this._shouldRenderAsTransmission(e.material)?(e.material.refractionTexture=this._opaqueRenderTarget,this._transparentMeshesCache.indexOf(e)===-1&&this._transparentMeshesCache.push(e)):this._opaqueMeshesCache.indexOf(e)===-1&&this._opaqueMeshesCache.push(e)})}_removeMesh(e){e.onMaterialChangedObservable.remove(this._materialObservers[e.uniqueId]),delete this._materialObservers[e.uniqueId];let t=this._transparentMeshesCache.indexOf(e);t!==-1&&this._transparentMeshesCache.splice(t,1),t=this._opaqueMeshesCache.indexOf(e),t!==-1&&this._opaqueMeshesCache.splice(t,1)}_parseScene(){this._scene.meshes.forEach(this._addMesh.bind(this)),this._scene.onNewMeshAddedObservable.add(this._addMesh.bind(this)),this._scene.onMeshRemovedObservable.add(this._removeMesh.bind(this))}_onMeshMaterialChanged(e){const t=this._transparentMeshesCache.indexOf(e),n=this._opaqueMeshesCache.indexOf(e);this._shouldRenderAsTransmission(e.material)?(e.material instanceof q&&(e.material.subSurface.refractionTexture=this._opaqueRenderTarget),n!==-1?(this._opaqueMeshesCache.splice(n,1),this._transparentMeshesCache.push(e)):t===-1&&this._transparentMeshesCache.push(e)):t!==-1?(this._transparentMeshesCache.splice(t,1),this._opaqueMeshesCache.push(e)):n===-1&&this._opaqueMeshesCache.push(e)}_isRenderTargetValid(){var e;return((e=this._opaqueRenderTarget)==null?void 0:e.getInternalTexture())!==null}_setupRenderTargets(){var t;this._opaqueRenderTarget&&this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=new Ts("opaqueSceneTexture",this._options.renderSize,this._scene,this._options.generateMipmaps,void 0,this._options.renderTargetTextureType),this._opaqueRenderTarget.ignoreCameraViewport=!0,this._opaqueRenderTarget.renderList=this._opaqueMeshesCache,this._opaqueRenderTarget.clearColor=((t=this._options.clearColor)==null?void 0:t.clone())??this._scene.clearColor.clone(),this._opaqueRenderTarget.gammaSpace=!1,this._opaqueRenderTarget.lodGenerationScale=this._options.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=this._options.lodGenerationOffset,this._opaqueRenderTarget.samples=this._options.samples,this._opaqueRenderTarget.renderSprites=!0,this._opaqueRenderTarget.renderParticles=!0,this._opaqueRenderTarget.renderInLinearSpace=!0;let e;this._opaqueRenderTarget.onBeforeBindObservable.add(n=>{e=this._scene.environmentIntensity,this._scene.environmentIntensity=1,this._options.clearColor?n.clearColor.copyFrom(this._options.clearColor):this._scene.clearColor.toLinearSpaceToRef(n.clearColor,this._scene.getEngine().useExactSrgbConversions)}),this._opaqueRenderTarget.onAfterUnbindObservable.add(()=>{this._scene.environmentIntensity=e}),this._transparentMeshesCache.forEach(n=>{this._shouldRenderAsTransmission(n.material)&&(n.material.refractionTexture=this._opaqueRenderTarget)})}dispose(){this._scene._transmissionHelper=void 0,this._opaqueRenderTarget&&(this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=null),this._transparentMeshesCache=[],this._opaqueMeshesCache=[]}}const yt="KHR_materials_transmission";class wr{constructor(e){this.name=yt,this.order=175,this._loader=e,this.enabled=this._loader.isExtensionUsed(yt),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return A.LoadExtensionAsync(e,t,this.name,(r,o)=>{const a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),a.push(this._loadTransparentPropertiesAsync(r,t,n,o)),Promise.all(a).then(()=>{})})}_loadTransparentPropertiesAsync(e,t,n,r){var a,i;if(!(n instanceof q))throw new Error(`${e}: Material type not supported`);const o=n;if(o.subSurface.isRefractionEnabled=!0,o.subSurface.volumeIndexOfRefraction=1,o.subSurface.useAlbedoToTintRefraction=!0,r.transmissionFactor!==void 0){o.subSurface.refractionIntensity=r.transmissionFactor;const l=o.getScene();o.subSurface.refractionIntensity&&!l._transmissionHelper?new Qt({},o.getScene()):o.subSurface.refractionIntensity&&!((a=l._transmissionHelper)!=null&&a._isRenderTargetValid())&&((i=l._transmissionHelper)==null||i._setupRenderTargets())}else return o.subSurface.refractionIntensity=0,o.subSurface.isRefractionEnabled=!1,Promise.resolve();return o.subSurface.minimumThickness=0,o.subSurface.maximumThickness=0,r.transmissionTexture?(r.transmissionTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/transmissionTexture`,r.transmissionTexture,void 0).then(l=>{l.name=`${n.name} (Transmission)`,o.subSurface.refractionIntensityTexture=l,o.subSurface.useGltfStyleTextures=!0})):Promise.resolve()}}P(yt);L(yt,!0,s=>new wr(s));const bt="KHR_materials_diffuse_transmission";class vr{constructor(e){this.name=bt,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(bt),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return A.LoadExtensionAsync(e,t,this.name,(r,o)=>{const a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),a.push(this._loadTranslucentPropertiesAsync(r,t,n,o)),Promise.all(a).then(()=>{})})}_loadTranslucentPropertiesAsync(e,t,n,r){if(!(n instanceof q))throw new Error(`${e}: Material type not supported`);const o=n;if(o.subSurface.isTranslucencyEnabled=!0,o.subSurface.volumeIndexOfRefraction=1,o.subSurface.minimumThickness=0,o.subSurface.maximumThickness=0,o.subSurface.useAlbedoToTintTranslucency=!1,r.diffuseTransmissionFactor!==void 0)o.subSurface.translucencyIntensity=r.diffuseTransmissionFactor;else return o.subSurface.translucencyIntensity=0,o.subSurface.isTranslucencyEnabled=!1,Promise.resolve();const a=new Array;return o.subSurface.useGltfStyleTextures=!0,r.diffuseTransmissionTexture&&(r.diffuseTransmissionTexture.nonColorData=!0,a.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTransmissionTexture`,r.diffuseTransmissionTexture).then(i=>{i.name=`${n.name} (Diffuse Transmission)`,o.subSurface.translucencyIntensityTexture=i}))),r.diffuseTransmissionColorFactor!==void 0?o.subSurface.translucencyColor=F.FromArray(r.diffuseTransmissionColorFactor):o.subSurface.translucencyColor=F.White(),r.diffuseTransmissionColorTexture&&a.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTransmissionColorTexture`,r.diffuseTransmissionColorTexture).then(i=>{i.name=`${n.name} (Diffuse Transmission Color)`,o.subSurface.translucencyColorTexture=i})),Promise.all(a).then(()=>{})}}P(bt);L(bt,!0,s=>new vr(s));const At="KHR_materials_volume";class Er{constructor(e){this.name=At,this.order=173,this._loader=e,this.enabled=this._loader.isExtensionUsed(At),this.enabled&&this._loader._disableInstancedMesh++}dispose(){this.enabled&&this._loader._disableInstancedMesh--,this._loader=null}loadMaterialPropertiesAsync(e,t,n){return A.LoadExtensionAsync(e,t,this.name,(r,o)=>{const a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),a.push(this._loadVolumePropertiesAsync(r,t,n,o)),Promise.all(a).then(()=>{})})}_loadVolumePropertiesAsync(e,t,n,r){if(!(n instanceof q))throw new Error(`${e}: Material type not supported`);if(!n.subSurface.isRefractionEnabled&&!n.subSurface.isTranslucencyEnabled||!r.thicknessFactor)return Promise.resolve();n.subSurface.volumeIndexOfRefraction=n.indexOfRefraction;const o=r.attenuationDistance!==void 0?r.attenuationDistance:Number.MAX_VALUE;return n.subSurface.tintColorAtDistance=o,r.attenuationColor!==void 0&&r.attenuationColor.length==3&&n.subSurface.tintColor.copyFromFloats(r.attenuationColor[0],r.attenuationColor[1],r.attenuationColor[2]),n.subSurface.minimumThickness=0,n.subSurface.maximumThickness=r.thicknessFactor,n.subSurface.useThicknessAsDepth=!0,r.thicknessTexture?(r.thicknessTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/thicknessTexture`,r.thicknessTexture).then(a=>{a.name=`${n.name} (Thickness)`,n.subSurface.thicknessTexture=a,n.subSurface.useGltfStyleTextures=!0})):Promise.resolve()}}P(At);L(At,!0,s=>new Er(s));const Tt="KHR_materials_dispersion";class Cr{constructor(e){this.name=Tt,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(Tt)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return A.LoadExtensionAsync(e,t,this.name,(r,o)=>{const a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),a.push(this._loadDispersionPropertiesAsync(r,t,n,o)),Promise.all(a).then(()=>{})})}_loadDispersionPropertiesAsync(e,t,n,r){if(!(n instanceof q))throw new Error(`${e}: Material type not supported`);return!n.subSurface.isRefractionEnabled||!r.dispersion||(n.subSurface.isDispersionEnabled=!0,n.subSurface.dispersion=r.dispersion),Promise.resolve()}}P(Tt);L(Tt,!0,s=>new Cr(s));const xt="KHR_mesh_quantization";class Or{constructor(e){this.name=xt,this.enabled=e.isExtensionUsed(xt)}dispose(){}}P(xt);L(xt,!0,s=>new Or(s));const wt="KHR_texture_basisu";class Nr{constructor(e){this.name=wt,this._loader=e,this.enabled=e.isExtensionUsed(wt)}dispose(){this._loader=null}_loadTextureAsync(e,t,n){return A.LoadExtensionAsync(e,t,this.name,(r,o)=>{const a=t.sampler==null?A.DefaultSampler:g.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),i=g.Get(`${r}/source`,this._loader.gltf.images,o.source);return this._loader._createTextureAsync(e,a,i,l=>{n(l)},t._textureInfo.nonColorData?{useRGBAIfASTCBC7NotAvailableWhenUASTC:!0}:void 0,!t._textureInfo.nonColorData)})}}P(wt);L(wt,!0,s=>new Nr(s));const vt="KHR_texture_transform";class Ir{constructor(e){this.name=vt,this._loader=e,this.enabled=this._loader.isExtensionUsed(vt)}dispose(){this._loader=null}loadTextureInfoAsync(e,t,n){return A.LoadExtensionAsync(e,t,this.name,(r,o)=>this._loader.loadTextureInfoAsync(e,t,a=>{if(!(a instanceof $))throw new Error(`${r}: Texture type not supported`);o.offset&&(a.uOffset=o.offset[0],a.vOffset=o.offset[1]),a.uRotationCenter=0,a.vRotationCenter=0,o.rotation&&(a.wAng=-o.rotation),o.scale&&(a.uScale=o.scale[0],a.vScale=o.scale[1]),o.texCoord!=null&&(a.coordinatesIndex=o.texCoord),n(a)}))}}P(vt);L(vt,!0,s=>new Ir(s));const Et="KHR_xmp_json_ld";class Sr{constructor(e){this.name=Et,this.order=100,this._loader=e,this.enabled=this._loader.isExtensionUsed(Et)}dispose(){this._loader=null}onLoading(){var n,r,o;if(this._loader.rootBabylonMesh===null)return;const e=(n=this._loader.gltf.extensions)==null?void 0:n.KHR_xmp_json_ld,t=(o=(r=this._loader.gltf.asset)==null?void 0:r.extensions)==null?void 0:o.KHR_xmp_json_ld;if(e&&t){const a=+t.packet;e.packets&&a<e.packets.length&&(this._loader.rootBabylonMesh.metadata=this._loader.rootBabylonMesh.metadata||{},this._loader.rootBabylonMesh.metadata.xmp=e.packets[a])}}}P(Et);L(Et,!0,s=>new Sr(s));function Ce(s,e,t,n){return F.FromArray(e,t).scale(n)}function Mr(s,e,t,n){return e[t+3]*n}function G(s,e,t,n){return e[t]*n}function zt(s,e,t,n){return-e[t]*n}function Ct(s,e,t,n){return e[t+1]*n}function zn(s,e,t,n){return e[t]*n*2}function Q(s){return{scale:[new R(T.ANIMATIONTYPE_FLOAT,`${s}.uScale`,G,()=>2),new R(T.ANIMATIONTYPE_FLOAT,`${s}.vScale`,Ct,()=>2)],offset:[new R(T.ANIMATIONTYPE_FLOAT,`${s}.uOffset`,G,()=>2),new R(T.ANIMATIONTYPE_FLOAT,`${s}.vOffset`,Ct,()=>2)],rotation:[new R(T.ANIMATIONTYPE_FLOAT,`${s}.wAng`,zt,()=>1)]}}class ye extends Be{buildAnimations(e,t,n,r){return[{babylonAnimatable:e._babylonCamera,babylonAnimation:this._buildAnimation(t,n,r)}]}}class R extends Be{buildAnimations(e,t,n,r){const o=[];for(const a in e._data)o.push({babylonAnimatable:e._data[a].babylonMaterial,babylonAnimation:this._buildAnimation(t,n,r)});return o}}class Se extends Be{buildAnimations(e,t,n,r){return[{babylonAnimatable:e._babylonLight,babylonAnimation:this._buildAnimation(t,n,r)}]}}p("/cameras/{}/orthographic/xmag",[new ye(T.ANIMATIONTYPE_FLOAT,"orthoLeft",zt,()=>1),new ye(T.ANIMATIONTYPE_FLOAT,"orthoRight",Ct,()=>1)]);p("/cameras/{}/orthographic/ymag",[new ye(T.ANIMATIONTYPE_FLOAT,"orthoBottom",zt,()=>1),new ye(T.ANIMATIONTYPE_FLOAT,"orthoTop",Ct,()=>1)]);p("/cameras/{}/orthographic/zfar",[new ye(T.ANIMATIONTYPE_FLOAT,"maxZ",G,()=>1)]);p("/cameras/{}/orthographic/znear",[new ye(T.ANIMATIONTYPE_FLOAT,"minZ",G,()=>1)]);p("/cameras/{}/perspective/yfov",[new ye(T.ANIMATIONTYPE_FLOAT,"fov",G,()=>1)]);p("/cameras/{}/perspective/zfar",[new ye(T.ANIMATIONTYPE_FLOAT,"maxZ",G,()=>1)]);p("/cameras/{}/perspective/znear",[new ye(T.ANIMATIONTYPE_FLOAT,"minZ",G,()=>1)]);p("/materials/{}/pbrMetallicRoughness/baseColorFactor",[new R(T.ANIMATIONTYPE_COLOR3,"albedoColor",Ce,()=>4),new R(T.ANIMATIONTYPE_FLOAT,"alpha",Mr,()=>4)]);p("/materials/{}/pbrMetallicRoughness/metallicFactor",[new R(T.ANIMATIONTYPE_FLOAT,"metallic",G,()=>1)]);p("/materials/{}/pbrMetallicRoughness/metallicFactor",[new R(T.ANIMATIONTYPE_FLOAT,"roughness",G,()=>1)]);const en=Q("albedoTexture");p("/materials/{}/pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/scale",en.scale);p("/materials/{}/pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/offset",en.offset);p("/materials/{}/pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/rotation",en.rotation);const tn=Q("metallicTexture");p("//materials/{}/pbrMetallicRoughness/metallicRoughnessTexture/scale",tn.scale);p("//materials/{}/pbrMetallicRoughness/metallicRoughnessTexture/offset",tn.offset);p("//materials/{}/pbrMetallicRoughness/metallicRoughnessTexture/rotation",tn.rotation);p("/materials/{}/emissiveFactor",[new R(T.ANIMATIONTYPE_COLOR3,"emissiveColor",Ce,()=>3)]);const nn=Q("bumpTexture");p("/materials/{}/normalTexture/scale",[new R(T.ANIMATIONTYPE_FLOAT,"bumpTexture.level",G,()=>1)]);p("/materials/{}/normalTexture/extensions/KHR_texture_transform/scale",nn.scale);p("/materials/{}/normalTexture/extensions/KHR_texture_transform/offset",nn.offset);p("/materials/{}/normalTexture/extensions/KHR_texture_transform/rotation",nn.rotation);p("/materials/{}/occlusionTexture/strength",[new R(T.ANIMATIONTYPE_FLOAT,"ambientTextureStrength",G,()=>1)]);const sn=Q("ambientTexture");p("/materials/{}/occlusionTexture/extensions/KHR_texture_transform/scale",sn.scale);p("/materials/{}/occlusionTexture/extensions/KHR_texture_transform/offset",sn.offset);p("/materials/{}/occlusionTexture/extensions/KHR_texture_transform/rotation",sn.rotation);const rn=Q("emissiveTexture");p("/materials/{}/emissiveTexture/extensions/KHR_texture_transform/scale",rn.scale);p("/materials/{}/emissiveTexture/extensions/KHR_texture_transform/offset",rn.offset);p("/materials/{}/emissiveTexture/extensions/KHR_texture_transform/rotation",rn.rotation);p("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyStrength",[new R(T.ANIMATIONTYPE_FLOAT,"anisotropy.intensity",G,()=>1)]);p("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyRotation",[new R(T.ANIMATIONTYPE_FLOAT,"anisotropy.angle",G,()=>1)]);const on=Q("anisotropy.texture");p("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyTexture/extensions/KHR_texture_transform/scale",on.scale);p("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyTexture/extensions/KHR_texture_transform/offset",on.offset);p("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyTexture/extensions/KHR_texture_transform/rotation",on.rotation);p("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatFactor",[new R(T.ANIMATIONTYPE_FLOAT,"clearCoat.intensity",G,()=>1)]);p("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessFactor",[new R(T.ANIMATIONTYPE_FLOAT,"clearCoat.roughness",G,()=>1)]);const an=Q("clearCoat.texture");p("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatTexture/extensions/KHR_texture_transform/scale",an.scale);p("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatTexture/extensions/KHR_texture_transform/offset",an.offset);p("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatTexture/extensions/KHR_texture_transform/rotation",an.rotation);const ln=Q("clearCoat.bumpTexture");p("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/scale",[new R(T.ANIMATIONTYPE_FLOAT,"clearCoat.bumpTexture.level",G,()=>1)]);p("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/extensions/KHR_texture_transform/scale",ln.scale);p("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/extensions/KHR_texture_transform/offset",ln.offset);p("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/extensions/KHR_texture_transform/rotation",ln.rotation);const cn=Q("clearCoat.textureRoughness");p("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessTexture/extensions/KHR_texture_transform/scale",cn.scale);p("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessTexture/extensions/KHR_texture_transform/offset",cn.offset);p("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessTexture/extensions/KHR_texture_transform/rotation",cn.rotation);p("/materials/{}/extensions/KHR_materials_dispersion/dispersionFactor",[new R(T.ANIMATIONTYPE_FLOAT,"subSurface.dispersion",G,()=>1)]);p("/materials/{}/extensions/KHR_materials_emissive_strength/emissiveStrength",[new R(T.ANIMATIONTYPE_FLOAT,"emissiveIntensity",G,()=>1)]);p("/materials/{}/extensions/KHR_materials_ior/ior",[new R(T.ANIMATIONTYPE_FLOAT,"indexOfRefraction",G,()=>1)]);p("/materials/{}/extensions/KHR_materials_iridescence/iridescenceFactor",[new R(T.ANIMATIONTYPE_FLOAT,"iridescence.intensity",G,()=>1)]);p("/materials/{}/extensions/KHR_materials_iridescence/iridescenceIor",[new R(T.ANIMATIONTYPE_FLOAT,"iridescence.indexOfRefraction",G,()=>1)]);p("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessMinimum",[new R(T.ANIMATIONTYPE_FLOAT,"iridescence.minimumThickness",G,()=>1)]);p("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessMaximum",[new R(T.ANIMATIONTYPE_FLOAT,"iridescence.maximumThickness",G,()=>1)]);const un=Q("iridescence.texture");p("/materials/{}/extensions/KHR_materials_iridescence/iridescenceTexture/extensions/KHR_texture_transform/scale",un.scale);p("/materials/{}/extensions/KHR_materials_iridescence/iridescenceTexture/extensions/KHR_texture_transform/offset",un.offset);p("/materials/{}/extensions/KHR_materials_iridescence/iridescenceTexture/extensions/KHR_texture_transform/rotation",un.rotation);const hn=Q("iridescence.thicknessTexture");p("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessTexture/extensions/KHR_texture_transform/scale",hn.scale);p("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessTexture/extensions/KHR_texture_transform/offset",hn.offset);p("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessTexture/extensions/KHR_texture_transform/rotation",hn.rotation);p("/materials/{}/extensions/KHR_materials_sheen/sheenColorFactor",[new R(T.ANIMATIONTYPE_COLOR3,"sheen.color",Ce,()=>3)]);p("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessFactor",[new R(T.ANIMATIONTYPE_FLOAT,"sheen.roughness",G,()=>1)]);const dn=Q("sheen.texture");p("/materials/{}/extensions/KHR_materials_sheen/sheenColorTexture/extensions/KHR_texture_transform/scale",dn.scale);p("/materials/{}/extensions/KHR_materials_sheen/sheenColorTexture/extensions/KHR_texture_transform/offset",dn.offset);p("/materials/{}/extensions/KHR_materials_sheen/sheenColorTexture/extensions/KHR_texture_transform/rotation",dn.rotation);const fn=Q("sheen.textureRoughness");p("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessTexture/extensions/KHR_texture_transform/scale",fn.scale);p("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessTexture/extensions/KHR_texture_transform/offset",fn.offset);p("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessTexture/extensions/KHR_texture_transform/rotation",fn.rotation);p("/materials/{}/extensions/KHR_materials_specular/specularFactor",[new R(T.ANIMATIONTYPE_FLOAT,"metallicF0Factor",G,()=>1)]);p("/materials/{}/extensions/KHR_materials_specular/specularColorFactor",[new R(T.ANIMATIONTYPE_COLOR3,"metallicReflectanceColor",Ce,()=>3)]);const pn=Q("metallicReflectanceTexture");p("/materials/{}/extensions/KHR_materials_specular/specularTexture/extensions/KHR_texture_transform/scale",pn.scale);p("/materials/{}/extensions/KHR_materials_specular/specularTexture/extensions/KHR_texture_transform/offset",pn.offset);p("/materials/{}/extensions/KHR_materials_specular/specularTexture/extensions/KHR_texture_transform/rotation",pn.rotation);const mn=Q("reflectanceTexture");p("/materials/{}/extensions/KHR_materials_specular/specularColorTexture/extensions/KHR_texture_transform/scale",mn.scale);p("/materials/{}/extensions/KHR_materials_specular/specularColorTexture/extensions/KHR_texture_transform/offset",mn.offset);p("/materials/{}/extensions/KHR_materials_specular/specularColorTexture/extensions/KHR_texture_transform/rotation",mn.rotation);p("/materials/{}/extensions/KHR_materials_transmission/transmissionFactor",[new R(T.ANIMATIONTYPE_FLOAT,"subSurface.refractionIntensity",G,()=>1)]);const _n=Q("subSurface.refractionIntensityTexture");p("/materials/{}/extensions/KHR_materials_transmission/transmissionTexture/extensions/KHR_texture_transform/scale",_n.scale);p("/materials/{}/extensions/KHR_materials_transmission/transmissionTexture/extensions/KHR_texture_transform/offset",_n.offset);p("/materials/{}/extensions/KHR_materials_transmission/transmissionTexture/extensions/KHR_texture_transform/rotation",_n.rotation);p("/materials/{}/extensions/KHR_materials_volume/attenuationColor",[new R(T.ANIMATIONTYPE_COLOR3,"subSurface.tintColor",Ce,()=>3)]);p("/materials/{}/extensions/KHR_materials_volume/attenuationDistance",[new R(T.ANIMATIONTYPE_FLOAT,"subSurface.tintColorAtDistance",G,()=>1)]);p("/materials/{}/extensions/KHR_materials_volume/thicknessFactor",[new R(T.ANIMATIONTYPE_FLOAT,"subSurface.maximumThickness",G,()=>1)]);const gn=Q("subSurface.thicknessTexture");p("/materials/{}/extensions/KHR_materials_volume/thicknessTexture/extensions/KHR_texture_transform/scale",gn.scale);p("/materials/{}/extensions/KHR_materials_volume/thicknessTexture/extensions/KHR_texture_transform/offset",gn.offset);p("/materials/{}/extensions/KHR_materials_volume/thicknessTexture/extensions/KHR_texture_transform/rotation",gn.rotation);p("/materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionFactor",[new R(T.ANIMATIONTYPE_FLOAT,"subSurface.translucencyIntensity",G,()=>1)]);const yn=Q("subSurface.translucencyIntensityTexture");p("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionTexture/extensions/KHR_texture_transform/scale",yn.scale);p("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionTexture/extensions/KHR_texture_transform/offset",yn.offset);p("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionTexture/extensions/KHR_texture_transform/rotation",yn.rotation);p("/materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorFactor",[new R(T.ANIMATIONTYPE_COLOR3,"subSurface.translucencyColor",Ce,()=>3)]);const bn=Q("subSurface.translucencyColorTexture");p("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorTexture/extensions/KHR_texture_transform/scale",bn.scale);p("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorTexture/extensions/KHR_texture_transform/offset",bn.offset);p("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorTexture/extensions/KHR_texture_transform/rotation",bn.rotation);p("/extensions/KHR_lights_punctual/lights/{}/color",[new Se(T.ANIMATIONTYPE_COLOR3,"diffuse",Ce,()=>3)]);p("/extensions/KHR_lights_punctual/lights/{}/intensity",[new Se(T.ANIMATIONTYPE_FLOAT,"intensity",G,()=>1)]);p("/extensions/KHR_lights_punctual/lights/{}/range",[new Se(T.ANIMATIONTYPE_FLOAT,"range",G,()=>1)]);p("/extensions/KHR_lights_punctual/lights/{}/spot/innerConeAngle",[new Se(T.ANIMATIONTYPE_FLOAT,"innerAngle",zn,()=>1)]);p("/extensions/KHR_lights_punctual/lights/{}/spot/outerConeAngle",[new Se(T.ANIMATIONTYPE_FLOAT,"angle",zn,()=>1)]);p("/nodes/{}/extensions/EXT_lights_ies/color",[new Se(T.ANIMATIONTYPE_COLOR3,"diffuse",Ce,()=>3)]);p("/nodes/{}/extensions/EXT_lights_ies/multiplier",[new Se(T.ANIMATIONTYPE_FLOAT,"intensity",G,()=>1)]);const Ot="KHR_animation_pointer";class kr{constructor(e){this.name=Ot,this._loader=e,this._pathToObjectConverter=jn(this._loader.gltf)}get enabled(){return this._loader.isExtensionUsed(Ot)}dispose(){this._loader=null,delete this._pathToObjectConverter}_loadAnimationChannelAsync(e,t,n,r,o){var c;const a=(c=r.target.extensions)==null?void 0:c.KHR_animation_pointer;if(!a||!this._pathToObjectConverter)return null;r.target.path!=="pointer"&&I.Warn(`${e}/target/path: Value (${r.target.path}) must be (pointer) when using the ${this.name} extension`),r.target.node!=null&&I.Warn(`${e}/target/node: Value (${r.target.node}) must not be present when using the ${this.name} extension`);const i=`${e}/extensions/${this.name}`,l=a.pointer;if(!l)throw new Error(`${i}: Pointer is missing`);try{const u=this._pathToObjectConverter.convert(l);if(!u.info.interpolation)throw new Error(`${i}/pointer: Interpolation is missing`);return this._loader._loadAnimationChannelFromTargetInfoAsync(e,t,n,r,{object:u.object,info:u.info.interpolation},o)}catch{return I.Warn(`${i}/pointer: Invalid pointer (${l}) skipped`),null}}}P(Ot);L(Ot,!0,s=>new kr(s));const Nt="MSFT_audio_emitter";class Pr{constructor(e){this.name=Nt,this._loader=e,this.enabled=this._loader.isExtensionUsed(Nt)}dispose(){this._loader=null,this._clips=null,this._emitters=null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._clips=t.clips,this._emitters=t.emitters,g.Assign(this._clips),g.Assign(this._emitters)}}loadSceneAsync(e,t){return A.LoadExtensionAsync(e,t,this.name,(n,r)=>{const o=new Array;o.push(this._loader.loadSceneAsync(e,t));for(const a of r.emitters){const i=g.Get(`${n}/emitters`,this._emitters,a);if(i.refDistance!=null||i.maxDistance!=null||i.rolloffFactor!=null||i.distanceModel!=null||i.innerAngle!=null||i.outerAngle!=null)throw new Error(`${n}: Direction or Distance properties are not allowed on emitters attached to a scene`);o.push(this._loadEmitterAsync(`${n}/emitters/${i.index}`,i))}return Promise.all(o).then(()=>{})})}loadNodeAsync(e,t,n){return A.LoadExtensionAsync(e,t,this.name,(r,o)=>{const a=new Array;return this._loader.loadNodeAsync(r,t,i=>{for(const l of o.emitters){const c=g.Get(`${r}/emitters`,this._emitters,l);a.push(this._loadEmitterAsync(`${r}/emitters/${c.index}`,c).then(()=>{for(const u of c._babylonSounds)u.attachToMesh(i),(c.innerAngle!=null||c.outerAngle!=null)&&(u.setLocalDirectionToMesh(S.Forward()),u.setDirectionalCone(2*B.ToDegrees(c.innerAngle==null?Math.PI:c.innerAngle),2*B.ToDegrees(c.outerAngle==null?Math.PI:c.outerAngle),0))}))}n(i)}).then(i=>Promise.all(a).then(()=>i))})}loadAnimationAsync(e,t){return A.LoadExtensionAsync(e,t,this.name,(n,r)=>this._loader.loadAnimationAsync(e,t).then(o=>{const a=new Array;g.Assign(r.events);for(const i of r.events)a.push(this._loadAnimationEventAsync(`${n}/events/${i.index}`,e,t,i,o));return Promise.all(a).then(()=>o)}))}_loadClipAsync(e,t){if(t._objectURL)return t._objectURL;let n;if(t.uri)n=this._loader.loadUriAsync(e,t,t.uri);else{const r=g.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,t.bufferView);n=this._loader.loadBufferViewAsync(`/bufferViews/${r.index}`,r)}return t._objectURL=n.then(r=>URL.createObjectURL(new Blob([r],{type:t.mimeType}))),t._objectURL}_loadEmitterAsync(e,t){if(t._babylonSounds=t._babylonSounds||[],!t._babylonData){const n=new Array,r=t.name||`emitter${t.index}`,o={loop:!1,autoplay:!1,volume:t.volume==null?1:t.volume};for(let i=0;i<t.clips.length;i++){const l=`/extensions/${this.name}/clips`,c=g.Get(l,this._clips,t.clips[i].clip);n.push(this._loadClipAsync(`${l}/${t.clips[i].clip}`,c).then(u=>{const h=t._babylonSounds[i]=new xs(r,u,this._loader.babylonScene,null,o);h.refDistance=t.refDistance||1,h.maxDistance=t.maxDistance||256,h.rolloffFactor=t.rolloffFactor||1,h.distanceModel=t.distanceModel||"exponential"}))}const a=Promise.all(n).then(()=>{const i=t.clips.map(c=>c.weight||1),l=new ws(t.loop||!1,t._babylonSounds,i);t.innerAngle&&(l.directionalConeInnerAngle=2*B.ToDegrees(t.innerAngle)),t.outerAngle&&(l.directionalConeOuterAngle=2*B.ToDegrees(t.outerAngle)),t.volume&&(l.volume=t.volume),t._babylonData.sound=l});t._babylonData={loaded:a}}return t._babylonData.loaded}_getEventAction(e,t,n,r,o){switch(n){case"play":return a=>{const i=(o||0)+(a-r);t.play(i)};case"stop":return()=>{t.stop()};case"pause":return()=>{t.pause()};default:throw new Error(`${e}: Unsupported action ${n}`)}}_loadAnimationEventAsync(e,t,n,r,o){if(o.targetedAnimations.length==0)return Promise.resolve();const a=o.targetedAnimations[0],i=r.emitter,l=g.Get(`/extensions/${this.name}/emitters`,this._emitters,i);return this._loadEmitterAsync(e,l).then(()=>{const c=l._babylonData.sound;if(c){const u=new vs(r.time,this._getEventAction(e,c,r.action,r.time,r.startOffset));a.animation.addEvent(u),o.onAnimationGroupEndObservable.add(()=>{c.stop()}),o.onAnimationGroupPauseObservable.add(()=>{c.pause()})}})}}P(Nt);L(Nt,!0,s=>new Pr(s));const Ke="MSFT_lod";class Lr{constructor(e){var t;this.name=Ke,this.order=100,this.maxLODsToLoad=10,this.onNodeLODsLoadedObservable=new se,this.onMaterialLODsLoadedObservable=new se,this._bufferLODs=new Array,this._nodeIndexLOD=null,this._nodeSignalLODs=new Array,this._nodePromiseLODs=new Array,this._nodeBufferLODs=new Array,this._materialIndexLOD=null,this._materialSignalLODs=new Array,this._materialPromiseLODs=new Array,this._materialBufferLODs=new Array,this._loader=e,this.maxLODsToLoad=((t=this._loader.parent.extensionOptions[Ke])==null?void 0:t.maxLODsToLoad)??this.maxLODsToLoad,this.enabled=this._loader.isExtensionUsed(Ke)}dispose(){this._loader=null,this._nodeIndexLOD=null,this._nodeSignalLODs.length=0,this._nodePromiseLODs.length=0,this._nodeBufferLODs.length=0,this._materialIndexLOD=null,this._materialSignalLODs.length=0,this._materialPromiseLODs.length=0,this._materialBufferLODs.length=0,this.onMaterialLODsLoadedObservable.clear(),this.onNodeLODsLoadedObservable.clear()}onReady(){for(let e=0;e<this._nodePromiseLODs.length;e++){const t=Promise.all(this._nodePromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Node LOD ${e}`),this._loader.log(`Loaded node LOD ${e}`)),this.onNodeLODsLoadedObservable.notifyObservers(e),e!==this._nodePromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Node LOD ${e+1}`),this._loadBufferLOD(this._nodeBufferLODs,e+1),this._nodeSignalLODs[e]&&this._nodeSignalLODs[e].resolve())});this._loader._completePromises.push(t)}for(let e=0;e<this._materialPromiseLODs.length;e++){const t=Promise.all(this._materialPromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Material LOD ${e}`),this._loader.log(`Loaded material LOD ${e}`)),this.onMaterialLODsLoadedObservable.notifyObservers(e),e!==this._materialPromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Material LOD ${e+1}`),this._loadBufferLOD(this._materialBufferLODs,e+1),this._materialSignalLODs[e]&&this._materialSignalLODs[e].resolve())});this._loader._completePromises.push(t)}}loadSceneAsync(e,t){const n=this._loader.loadSceneAsync(e,t);return this._loadBufferLOD(this._bufferLODs,0),n}loadNodeAsync(e,t,n){return A.LoadExtensionAsync(e,t,this.name,(r,o)=>{let a;const i=this._getLODs(r,t,this._loader.gltf.nodes,o.ids);this._loader.logOpen(`${r}`);for(let l=0;l<i.length;l++){const c=i[l];l!==0&&(this._nodeIndexLOD=l,this._nodeSignalLODs[l]=this._nodeSignalLODs[l]||new Ve);const u=d=>{n(d),d.setEnabled(!1)},h=this._loader.loadNodeAsync(`/nodes/${c.index}`,c,u).then(d=>{if(l!==0){const f=i[l-1];f._babylonTransformNode&&(this._disposeTransformNode(f._babylonTransformNode),delete f._babylonTransformNode)}return d.setEnabled(!0),d});this._nodePromiseLODs[l]=this._nodePromiseLODs[l]||[],l===0?a=h:(this._nodeIndexLOD=null,this._nodePromiseLODs[l].push(h))}return this._loader.logClose(),a})}_loadMaterialAsync(e,t,n,r,o){return this._nodeIndexLOD?null:A.LoadExtensionAsync(e,t,this.name,(a,i)=>{let l;const c=this._getLODs(a,t,this._loader.gltf.materials,i.ids);this._loader.logOpen(`${a}`);for(let u=0;u<c.length;u++){const h=c[u];u!==0&&(this._materialIndexLOD=u);const d=this._loader._loadMaterialAsync(`/materials/${h.index}`,h,n,r,f=>{u===0&&o(f)}).then(f=>{if(u!==0){o(f);const m=c[u-1]._data;m[r]&&(this._disposeMaterials([m[r].babylonMaterial]),delete m[r])}return f});this._materialPromiseLODs[u]=this._materialPromiseLODs[u]||[],u===0?l=d:(this._materialIndexLOD=null,this._materialPromiseLODs[u].push(d))}return this._loader.logClose(),l})}_loadUriAsync(e,t,n){if(this._nodeIndexLOD!==null){this._loader.log("deferred");const r=this._nodeIndexLOD-1;return this._nodeSignalLODs[r]=this._nodeSignalLODs[r]||new Ve,this._nodeSignalLODs[this._nodeIndexLOD-1].promise.then(()=>this._loader.loadUriAsync(e,t,n))}else if(this._materialIndexLOD!==null){this._loader.log("deferred");const r=this._materialIndexLOD-1;return this._materialSignalLODs[r]=this._materialSignalLODs[r]||new Ve,this._materialSignalLODs[r].promise.then(()=>this._loader.loadUriAsync(e,t,n))}return null}loadBufferAsync(e,t,n,r){if(this._loader.parent.useRangeRequests&&!t.uri){if(!this._loader.bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);const o=(a,i)=>{const l=n,c=l+r-1;let u=a[i];return u?(u.start=Math.min(u.start,l),u.end=Math.max(u.end,c)):(u={start:l,end:c,loaded:new Ve},a[i]=u),u.loaded.promise.then(h=>new Uint8Array(h.buffer,h.byteOffset+n-u.start,r))};return this._loader.log("deferred"),this._nodeIndexLOD!==null?o(this._nodeBufferLODs,this._nodeIndexLOD):this._materialIndexLOD!==null?o(this._materialBufferLODs,this._materialIndexLOD):o(this._bufferLODs,0)}return null}_loadBufferLOD(e,t){const n=e[t];n&&(this._loader.log(`Loading buffer range [${n.start}-${n.end}]`),this._loader.bin.readAsync(n.start,n.end-n.start+1).then(r=>{n.loaded.resolve(r)},r=>{n.loaded.reject(r)}))}_getLODs(e,t,n,r){if(this.maxLODsToLoad<=0)throw new Error("maxLODsToLoad must be greater than zero");const o=[];for(let a=r.length-1;a>=0;a--)if(o.push(g.Get(`${e}/ids/${r[a]}`,n,r[a])),o.length===this.maxLODsToLoad)return o;return o.push(t),o}_disposeTransformNode(e){const t=[],n=e.material;n&&t.push(n);for(const o of e.getChildMeshes())o.material&&t.push(o.material);e.dispose();const r=t.filter(o=>this._loader.babylonScene.meshes.every(a=>a.material!=o));this._disposeMaterials(r)}_disposeMaterials(e){const t={};for(const n of e){for(const r of n.getActiveTextures())t[r.uniqueId]=r;n.dispose()}for(const n in t)for(const r of this._loader.babylonScene.materials)r.hasTexture(t[n])&&delete t[n];for(const n in t)t[n].dispose()}}P(Ke);L(Ke,!0,s=>new Lr(s));const It="MSFT_minecraftMesh";class Rr{constructor(e){this.name=It,this._loader=e,this.enabled=this._loader.isExtensionUsed(It)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return A.LoadExtraAsync(e,t,this.name,(r,o)=>{if(o){if(!(n instanceof q))throw new Error(`${r}: Material type not supported`);const a=this._loader.loadMaterialPropertiesAsync(e,t,n);return n.needAlphaBlending()&&(n.forceDepthWrite=!0,n.separateCullingPass=!0),n.backFaceCulling=n.forceDepthWrite,n.twoSidedLighting=!0,a}return null})}}P(It);L(It,!0,s=>new Rr(s));const St="MSFT_sRGBFactors";class Br{constructor(e){this.name=St,this._loader=e,this.enabled=this._loader.isExtensionUsed(St)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return A.LoadExtraAsync(e,t,this.name,(r,o)=>{if(o){if(!(n instanceof q))throw new Error(`${r}: Material type not supported`);const a=this._loader.loadMaterialPropertiesAsync(e,t,n),i=n.getScene().getEngine().useExactSrgbConversions;return n.albedoTexture||n.albedoColor.toLinearSpaceToRef(n.albedoColor,i),n.reflectivityTexture||n.reflectivityColor.toLinearSpaceToRef(n.reflectivityColor,i),a}return null})}}P(St);L(St,!0,s=>new Br(s));function Pn(s){const[e,t]=s.split(":");return es({op:e,extension:t})}function es(s,e=!0){var n;const t=s.extension?(n=et[s.extension])==null?void 0:n[s.op]:Fr[s.op];if(!t&&(I.Warn(`No mapping found for operation ${s.op} and extension ${s.extension||"KHR_interactivity"}`),e)){const r={},o={flows:{}};if(s.inputValueSockets){r.values={};for(const a in s.inputValueSockets)r.values[a]={name:a}}return s.outputValueSockets&&(o.values={},Object.keys(s.outputValueSockets).forEach(a=>{o.values[a]={name:a}})),{blocks:[],inputs:r,outputs:o}}return t}function An(s,e,t){et[e]||(et[e]={}),et[e][s]=t}const et={BABYLON:{"flow/log":{blocks:["FlowGraphConsoleLogBlock"],inputs:{values:{message:{name:"message"}}}}}},Fr={"event/onStart":{blocks:["FlowGraphSceneReadyEventBlock"],outputs:{flows:{out:{name:"done"}}}},"event/onTick":{blocks:["FlowGraphSceneTickEventBlock"],inputs:{},outputs:{values:{timeSinceLastTick:{name:"deltaTime",gltfType:"number"}},flows:{out:{name:"done"}}}},"event/send":{blocks:["FlowGraphSendCustomEventBlock"],outputs:{flows:{out:{name:"done"}}},extraProcessor(s,e,t,n,r){if(e.op!=="event/send"||!s.configuration||Object.keys(s.configuration).length!==1)throw new Error("Receive event should have a single configuration object, the event itself");const a=s.configuration.event.value[0];if(typeof a!="number")throw new Error("Event id should be a number");const i=n.arrays.events[a],l=r[0];return l.config||(l.config={}),l.config.eventId=i.eventId,l.config.eventData=i.eventData,r}},"event/receive":{blocks:["FlowGraphReceiveCustomEventBlock"],outputs:{flows:{out:{name:"done"}}},validation(s,e){var o;if(!s.configuration)return I.Error("Receive event should have a configuration object"),!1;const t=s.configuration.event;if(!t)return I.Error("Receive event should have a single configuration object, the event itself"),!1;const n=t.value[0];return typeof n!="number"?(I.Error("Event id should be a number"),!1):((o=e.events)==null?void 0:o[n])?!0:(I.Error(`Event with id ${n} not found`),!1)},extraProcessor(s,e,t,n,r){if(e.op!=="event/receive"||!s.configuration||Object.keys(s.configuration).length!==1)throw new Error("Receive event should have a single configuration object, the event itself");const a=s.configuration.event.value[0];if(typeof a!="number")throw new Error("Event id should be a number");const i=n.arrays.events[a],l=r[0];return l.config||(l.config={}),l.config.eventId=i.eventId,l.config.eventData=i.eventData,r}},"math/e":y("FlowGraphEBlock"),"math/pi":y("FlowGraphPIBlock"),"math/inf":y("FlowGraphInfBlock"),"math/nan":y("FlowGraphNaNBlock"),"math/abs":y("FlowGraphAbsBlock"),"math/sign":y("FlowGraphSignBlock"),"math/trunc":y("FlowGraphTruncBlock"),"math/floor":y("FlowGraphFloorBlock"),"math/ceil":y("FlowGraphCeilBlock"),"math/round":{blocks:["FlowGraphRoundBlock"],configuration:{},inputs:{values:{a:{name:"a"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(s,e,t,n,r){return r[0].config=r[0].config||{},r[0].config.roundHalfAwayFromZero=!0,r}},"math/fract":y("FlowGraphFractBlock"),"math/neg":y("FlowGraphNegationBlock"),"math/add":y("FlowGraphAddBlock",["a","b"],!0),"math/sub":y("FlowGraphSubtractBlock",["a","b"],!0),"math/mul":{blocks:["FlowGraphMultiplyBlock"],extraProcessor(s,e,t,n,r){r[0].config=r[0].config||{},r[0].config.useMatrixPerComponent=!0;let o=-1;return Object.keys(s.values||{}).find(a=>{var i;return((i=s.values)==null?void 0:i[a].type)!==void 0?(o=s.values[a].type,!0):!1}),o!==-1&&(r[0].config.type=n.arrays.types[o].flowGraphType),r}},"math/div":y("FlowGraphDivideBlock",["a","b"],!0),"math/rem":y("FlowGraphModuloBlock",["a","b"]),"math/min":y("FlowGraphMinBlock",["a","b"]),"math/max":y("FlowGraphMaxBlock",["a","b"]),"math/clamp":y("FlowGraphClampBlock",["a","b","c"]),"math/saturate":y("FlowGraphSaturateBlock"),"math/mix":y("FlowGraphMathInterpolationBlock",["a","b","c"]),"math/eq":y("FlowGraphEqualityBlock",["a","b"]),"math/lt":y("FlowGraphLessThanBlock",["a","b"]),"math/le":y("FlowGraphLessThanOrEqualBlock",["a","b"]),"math/gt":y("FlowGraphGreaterThanBlock",["a","b"]),"math/ge":y("FlowGraphGreaterThanOrEqualBlock",["a","b"]),"math/isnan":y("FlowGraphIsNaNBlock"),"math/isinf":y("FlowGraphIsInfBlock"),"math/select":{blocks:["FlowGraphConditionalBlock"],inputs:{values:{condition:{name:"condition"},a:{name:"onTrue"},b:{name:"onFalse"}}},outputs:{values:{value:{name:"output"}}}},"math/random":{blocks:["FlowGraphRandomBlock"],outputs:{values:{value:{name:"value"}}}},"math/sin":y("FlowGraphSinBlock"),"math/cos":y("FlowGraphCosBlock"),"math/tan":y("FlowGraphTanBlock"),"math/asin":y("FlowGraphASinBlock"),"math/acos":y("FlowGraphACosBlock"),"math/atan":y("FlowGraphATanBlock"),"math/atan2":y("FlowGraphATan2Block",["a","b"]),"math/sinh":y("FlowGraphSinhBlock"),"math/cosh":y("FlowGraphCoshBlock"),"math/tanh":y("FlowGraphTanhBlock"),"math/asinh":y("FlowGraphASinhBlock"),"math/acosh":y("FlowGraphACoshBlock"),"math/atanh":y("FlowGraphATanhBlock"),"math/exp":y("FlowGraphExponentialBlock"),"math/log":y("FlowGraphLogBlock"),"math/log2":y("FlowGraphLog2Block"),"math/log10":y("FlowGraphLog10Block"),"math/sqrt":y("FlowGraphSquareRootBlock"),"math/cbrt":y("FlowGraphCubeRootBlock"),"math/pow":y("FlowGraphPowerBlock",["a","b"]),"math/length":y("FlowGraphLengthBlock"),"math/normalize":y("FlowGraphNormalizeBlock"),"math/dot":y("FlowGraphDotBlock",["a","b"]),"math/cross":y("FlowGraphCrossBlock",["a","b"]),"math/rotate2d":y("FlowGraphRotate2DBlock",["a","b"]),"math/rotate3d":y("FlowGraphRotate3DBlock",["a","b","c"]),"math/transform":{blocks:["FlowGraphTransformVectorBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}}},"math/combine2":{blocks:["FlowGraphCombineVector2Block"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/combine3":{blocks:["FlowGraphCombineVector3Block"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/combine4":{blocks:["FlowGraphCombineVector4Block"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/extract2":{blocks:["FlowGraphExtractVector2Block"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"}}}},"math/extract3":{blocks:["FlowGraphExtractVector3Block"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"}}}},"math/extract4":{blocks:["FlowGraphExtractVector4Block"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"}}}},"math/transpose":y("FlowGraphTransposeBlock"),"math/determinant":y("FlowGraphDeterminantBlock"),"math/inverse":y("FlowGraphInvertMatrixBlock"),"math/matmul":y("FlowGraphMatrixMultiplicationBlock",["a","b"]),"math/matCompose":{blocks:["FlowGraphMatrixCompose"],inputs:{values:{translation:{name:"position",gltfType:"float3"},rotation:{name:"rotationQuaternion",gltfType:"float4"},scale:{name:"scaling",gltfType:"float3"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(s,e,t,n,r,o){const a=r[0].dataInputs.find(i=>i.name==="rotationQuaternion");if(!a)throw new Error("Rotation quaternion input not found");return o._connectionValues[a.uniqueId]&&(o._connectionValues[a.uniqueId].type="Quaternion"),r}},"math/matDecompose":{blocks:["FlowGraphMatrixDecompose"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{translation:{name:"position"},rotation:{name:"rotationQuaternion"},scale:{name:"scaling"}}}},"math/combine2x2":{blocks:["FlowGraphCombineMatrix2DBlock"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(s,e,t,n,r){return r[0].config=r[0].config||{},r[0].config.inputIsColumnMajor=!0,r}},"math/extract2x2":{blocks:["FlowGraphExtractMatrix2DBlock"],inputs:{values:{a:{name:"input",gltfType:"float2x2"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"}}}},"math/combine3x3":{blocks:["FlowGraphCombineMatrix3DBlock"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"},e:{name:"input_4",gltfType:"number"},f:{name:"input_5",gltfType:"number"},g:{name:"input_6",gltfType:"number"},h:{name:"input_7",gltfType:"number"},i:{name:"input_8",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(s,e,t,n,r){return r[0].config=r[0].config||{},r[0].config.inputIsColumnMajor=!0,r}},"math/extract3x3":{blocks:["FlowGraphExtractMatrix3DBlock"],inputs:{values:{a:{name:"input",gltfType:"float3x3"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"},4:{name:"output_4"},5:{name:"output_5"},6:{name:"output_6"},7:{name:"output_7"},8:{name:"output_8"}}}},"math/combine4x4":{blocks:["FlowGraphCombineMatrixBlock"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"},e:{name:"input_4",gltfType:"number"},f:{name:"input_5",gltfType:"number"},g:{name:"input_6",gltfType:"number"},h:{name:"input_7",gltfType:"number"},i:{name:"input_8",gltfType:"number"},j:{name:"input_9",gltfType:"number"},k:{name:"input_10",gltfType:"number"},l:{name:"input_11",gltfType:"number"},m:{name:"input_12",gltfType:"number"},n:{name:"input_13",gltfType:"number"},o:{name:"input_14",gltfType:"number"},p:{name:"input_15",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(s,e,t,n,r){return r[0].config=r[0].config||{},r[0].config.inputIsColumnMajor=!0,r}},"math/extract4x4":{blocks:["FlowGraphExtractMatrixBlock"],configuration:{},inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"},4:{name:"output_4"},5:{name:"output_5"},6:{name:"output_6"},7:{name:"output_7"},8:{name:"output_8"},9:{name:"output_9"},10:{name:"output_10"},11:{name:"output_11"},12:{name:"output_12"},13:{name:"output_13"},14:{name:"output_14"},15:{name:"output_15"}}}},"math/compose":{blocks:["FlowGraphMatrixCompose"],configuration:{},inputs:{values:{translation:{name:"position",gltfType:"float3"},rotation:{name:"rotationQuaternion",gltfType:"float4"},scale:{name:"scaling",gltfType:"float3"}}},outputs:{values:{value:{name:"output"}}}},"math/decompose":{blocks:["FlowGraphMatrixDecompose"],configuration:{},inputs:{values:{a:{name:"input"}}},outputs:{values:{translation:{name:"position"},rotation:{name:"rotationQuaternion"},scale:{name:"scaling"}}}},"math/not":{blocks:["FlowGraphBitwiseNotBlock"],inputs:{values:{a:{name:"a"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(s,e,t,n,r,o){var i;r[0].config=r[0].config||{};const a=r[0].dataInputs[0];return r[0].config.valueType=((i=o._connectionValues[a.uniqueId])==null?void 0:i.type)??"FlowGraphInteger",r}},"math/and":{blocks:["FlowGraphBitwiseAndBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(s,e,t,n,r,o){var l,c;r[0].config=r[0].config||{};const a=r[0].dataInputs[0],i=r[0].dataInputs[1];return r[0].config.valueType=((l=o._connectionValues[a.uniqueId])==null?void 0:l.type)??((c=o._connectionValues[i.uniqueId])==null?void 0:c.type)??"FlowGraphInteger",r}},"math/or":{blocks:["FlowGraphBitwiseOrBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(s,e,t,n,r,o){var l,c;r[0].config=r[0].config||{};const a=r[0].dataInputs[0],i=r[0].dataInputs[1];return r[0].config.valueType=((l=o._connectionValues[a.uniqueId])==null?void 0:l.type)??((c=o._connectionValues[i.uniqueId])==null?void 0:c.type)??"FlowGraphInteger",r}},"math/xor":{blocks:["FlowGraphBitwiseXorBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(s,e,t,n,r,o){var l,c;r[0].config=r[0].config||{};const a=r[0].dataInputs[0],i=r[0].dataInputs[1];return r[0].config.valueType=((l=o._connectionValues[a.uniqueId])==null?void 0:l.type)??((c=o._connectionValues[i.uniqueId])==null?void 0:c.type)??"FlowGraphInteger",r}},"math/asr":y("FlowGraphBitwiseRightShiftBlock",["a","b"]),"math/lsl":y("FlowGraphBitwiseLeftShiftBlock",["a","b"]),"math/clz":y("FlowGraphLeadingZerosBlock"),"math/ctz":y("FlowGraphTrailingZerosBlock"),"math/popcnt":y("FlowGraphOneBitsCounterBlock"),"math/rad":y("FlowGraphDegToRadBlock"),"math/deg":y("FlowGraphRadToDegBlock"),"type/boolToInt":y("FlowGraphBooleanToInt"),"type/boolToFloat":y("FlowGraphBooleanToFloat"),"type/intToBool":y("FlowGraphIntToBoolean"),"type/intToFloat":y("FlowGraphIntToFloat"),"type/floatToInt":y("FlowGraphFloatToInt"),"type/floatToBool":y("FlowGraphFloatToBoolean"),"flow/sequence":{blocks:["FlowGraphSequenceBlock"],extraProcessor(s,e,t,n,r){const o=r[0];return o.config||(o.config={}),o.config.outputSignalCount=Object.keys(s.flows||[]).length,o.signalOutputs.forEach((a,i)=>{a.name="out_"+i}),r}},"flow/branch":{blocks:["FlowGraphBranchBlock"],outputs:{flows:{true:{name:"onTrue"},false:{name:"onFalse"}}}},"flow/switch":{blocks:["FlowGraphSwitchBlock"],configuration:{cases:{name:"cases",inOptions:!0,defaultValue:[]}},inputs:{values:{selection:{name:"case"}}},validation(s){if(s.configuration&&s.configuration.cases){const e=s.configuration.cases.value;if(!e.every(r=>typeof r=="number"&&/^\d+$/.test(r.toString())))return s.configuration.cases.value=[],!0;const n=new Set(e);s.configuration.cases.value=Array.from(n)}return!0},extraProcessor(s,e,t,n,r){if(e.op!=="flow/switch"||!s.flows||Object.keys(s.flows).length===0)throw new Error("Switch should have a single configuration object, the cases array");return r[0].signalOutputs.forEach(a=>{a.name!=="default"&&(a.name="out_"+a.name)}),r}},"flow/while":{blocks:["FlowGraphWhileLoopBlock"],outputs:{flows:{loopBody:{name:"executionFlow"}}}},"flow/for":{blocks:["FlowGraphForLoopBlock"],configuration:{initialIndex:{name:"initialIndex",gltfType:"number",inOptions:!0,defaultValue:0}},inputs:{values:{startIndex:{name:"startIndex",gltfType:"number"},endIndex:{name:"endIndex",gltfType:"number"}}},outputs:{values:{index:{name:"index"}},flows:{loopBody:{name:"executionFlow"}}}},"flow/doN":{blocks:["FlowGraphDoNBlock"],configuration:{},inputs:{values:{n:{name:"maxExecutions",gltfType:"number"}}},outputs:{values:{currentCount:{name:"executionCount"}}}},"flow/multiGate":{blocks:["FlowGraphMultiGateBlock"],configuration:{isRandom:{name:"isRandom",gltfType:"boolean",inOptions:!0,defaultValue:!1},isLoop:{name:"isLoop",gltfType:"boolean",inOptions:!0,defaultValue:!1}},extraProcessor(s,e,t,n,r){if(e.op!=="flow/multiGate"||!s.flows||Object.keys(s.flows).length===0)throw new Error("MultiGate should have a single configuration object, the number of output flows");const o=r[0];return o.config||(o.config={}),o.config.outputSignalCount=Object.keys(s.flows).length,o.signalOutputs.forEach((a,i)=>{a.name="out_"+i}),r}},"flow/waitAll":{blocks:["FlowGraphWaitAllBlock"],configuration:{inputFlows:{name:"inputSignalCount",gltfType:"number",inOptions:!0,defaultValue:0}},inputs:{flows:{"[segment]":{name:"in_$1"}}},validation(s){var e,t;return typeof((t=(e=s.configuration)==null?void 0:e.inputFlows)==null?void 0:t.value[0])!="number"&&(s.configuration=s.configuration||{inputFlows:{value:[0]}},s.configuration.inputFlows.value=[0]),!0}},"flow/throttle":{blocks:["FlowGraphThrottleBlock"],outputs:{flows:{err:{name:"error"}}}},"flow/setDelay":{blocks:["FlowGraphSetDelayBlock"],outputs:{flows:{err:{name:"error"}}}},"flow/cancelDelay":{blocks:["FlowGraphCancelDelayBlock"]},"variable/get":{blocks:["FlowGraphGetVariableBlock"],validation(s){var e,t;return(t=(e=s.configuration)==null?void 0:e.variable)!=null&&t.value?!0:(I.Error("Variable get block should have a variable configuration"),!1)},configuration:{variable:{name:"variable",gltfType:"number",flowGraphType:"string",inOptions:!0,isVariable:!0,dataTransformer(s,e){return[e.getVariableName(s[0])]}}}},"variable/set":{blocks:["FlowGraphSetVariableBlock"],configuration:{variable:{name:"variable",gltfType:"number",flowGraphType:"string",inOptions:!0,isVariable:!0,dataTransformer(s,e){return[e.getVariableName(s[0])]}}}},"variable/setMultiple":{blocks:["FlowGraphSetVariableBlock"],configuration:{variables:{name:"variables",gltfType:"number",flowGraphType:"string",inOptions:!0,dataTransformer(s,e){return[s[0].map(t=>e.getVariableName(t))]}}},extraProcessor(s,e,t,n,r){return r[0].dataInputs.forEach(a=>{a.name=n.getVariableName(+a.name)}),r}},"variable/interpolate":{blocks:["FlowGraphInterpolationBlock","FlowGraphContextBlock","FlowGraphPlayAnimationBlock","FlowGraphBezierCurveEasing","FlowGraphGetVariableBlock"],configuration:{variable:{name:"propertyName",inOptions:!0,isVariable:!0,dataTransformer(s,e){return[e.getVariableName(s[0])]}},useSlerp:{name:"animationType",inOptions:!0,defaultValue:!1,dataTransformer:s=>s[0]===!0?["Quaternion"]:[void 0]}},inputs:{values:{value:{name:"value_1"},duration:{name:"duration_1",gltfType:"number"},p1:{name:"controlPoint1",toBlock:"FlowGraphBezierCurveEasing"},p2:{name:"controlPoint2",toBlock:"FlowGraphBezierCurveEasing"}},flows:{in:{name:"in",toBlock:"FlowGraphPlayAnimationBlock"}}},outputs:{flows:{err:{name:"error",toBlock:"FlowGraphPlayAnimationBlock"},out:{name:"out",toBlock:"FlowGraphPlayAnimationBlock"},done:{name:"done",toBlock:"FlowGraphPlayAnimationBlock"}}},interBlockConnectors:[{input:"object",output:"userVariables",inputBlockIndex:2,outputBlockIndex:1,isVariable:!0},{input:"animation",output:"animation",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0},{input:"easingFunction",output:"easingFunction",inputBlockIndex:0,outputBlockIndex:3,isVariable:!0},{input:"value_0",output:"value",inputBlockIndex:0,outputBlockIndex:4,isVariable:!0}],extraProcessor(s,e,t,n,r){var h;var o,a;const i=r[0],l=(h=s.configuration)==null?void 0:h.variable.value[0];if(typeof l!="number")throw I.Error("Variable index is not defined for variable interpolation block"),new Error("Variable index is not defined for variable interpolation block");const c=n.arrays.staticVariables[l];typeof i.config.animationType.value>"u"&&(n.arrays.staticVariables,i.config.animationType.value=Es(c.type));const u=r[4];return u.config||(u.config={}),(o=u.config).variable||(o.variable={}),u.config.variable.value=n.getVariableName(l),(a=r[3]).config||(a.config={}),r}},"pointer/get":{blocks:["FlowGraphGetPropertyBlock","FlowGraphJsonPointerParserBlock"],configuration:{pointer:{name:"jsonPointer",toBlock:"FlowGraphJsonPointerParserBlock"}},inputs:{values:{"[segment]":{name:"$1",toBlock:"FlowGraphJsonPointerParserBlock"}}},interBlockConnectors:[{input:"object",output:"object",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"propertyName",output:"propertyName",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"customGetFunction",output:"getFunction",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0}],extraProcessor(s,e,t,n,r){return r.forEach(o=>{o.className==="FlowGraphJsonPointerParserBlock"&&(o.config||(o.config={}),o.config.outputValue=!0)}),r}},"pointer/set":{blocks:["FlowGraphSetPropertyBlock","FlowGraphJsonPointerParserBlock"],configuration:{pointer:{name:"jsonPointer",toBlock:"FlowGraphJsonPointerParserBlock"}},inputs:{values:{value:{name:"value"},"[segment]":{name:"$1",toBlock:"FlowGraphJsonPointerParserBlock"}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"object",output:"object",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"propertyName",output:"propertyName",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"customSetFunction",output:"setFunction",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0}],extraProcessor(s,e,t,n,r){return r.forEach(o=>{o.className==="FlowGraphJsonPointerParserBlock"&&(o.config||(o.config={}),o.config.outputValue=!0)}),r}},"pointer/interpolate":{blocks:["FlowGraphInterpolationBlock","FlowGraphJsonPointerParserBlock","FlowGraphPlayAnimationBlock","FlowGraphEasingBlock"],configuration:{pointer:{name:"jsonPointer",toBlock:"FlowGraphJsonPointerParserBlock"}},inputs:{values:{value:{name:"value_1"},"[segment]":{name:"$1",toBlock:"FlowGraphJsonPointerParserBlock"},duration:{name:"duration_1",gltfType:"number"},p1:{name:"controlPoint1",toBlock:"FlowGraphEasingBlock"},p2:{name:"controlPoint2",toBlock:"FlowGraphEasingBlock"}},flows:{in:{name:"in",toBlock:"FlowGraphPlayAnimationBlock"}}},outputs:{flows:{err:{name:"error",toBlock:"FlowGraphPlayAnimationBlock"},out:{name:"out",toBlock:"FlowGraphPlayAnimationBlock"},done:{name:"done",toBlock:"FlowGraphPlayAnimationBlock"}}},interBlockConnectors:[{input:"object",output:"object",inputBlockIndex:2,outputBlockIndex:1,isVariable:!0},{input:"propertyName",output:"propertyName",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"customBuildAnimation",output:"generateAnimationsFunction",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"animation",output:"animation",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0},{input:"easingFunction",output:"easingFunction",inputBlockIndex:0,outputBlockIndex:3,isVariable:!0},{input:"value_0",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0}],extraProcessor(s,e,t,n,r){return r.forEach(o=>{o.className==="FlowGraphJsonPointerParserBlock"?(o.config||(o.config={}),o.config.outputValue=!0):o.className==="FlowGraphInterpolationBlock"&&(o.config||(o.config={}),Object.keys(s.values||[]).forEach(a=>{var l;const i=(l=s.values)==null?void 0:l[a];if(a==="value"&&i){const c=i.type;c!==void 0&&(o.config.animationType=n.arrays.types[c].flowGraphType)}}))}),r}},"animation/start":{blocks:["FlowGraphPlayAnimationBlock","FlowGraphArrayIndexBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],inputs:{values:{animation:{name:"index",gltfType:"number",toBlock:"FlowGraphArrayIndexBlock"},speed:{name:"speed",gltfType:"number"},startTime:{name:"from",gltfType:"number",dataTransformer:(s,e)=>[s[0]*e._loader.parent.targetFps]},endTime:{name:"to",gltfType:"number",dataTransformer:(s,e)=>[s[0]*e._loader.parent.targetFps]}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"animationGroup",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"animationGroups",inputBlockIndex:1,outputBlockIndex:2,isVariable:!0}],extraProcessor(s,e,t,n,r,o,a){const i=r[r.length-1];return i.config||(i.config={}),i.config.glTF=a,r}},"animation/stop":{blocks:["FlowGraphStopAnimationBlock","FlowGraphArrayIndexBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],inputs:{values:{animation:{name:"index",gltfType:"number",toBlock:"FlowGraphArrayIndexBlock"}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"animationGroup",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"animationGroups",inputBlockIndex:1,outputBlockIndex:2,isVariable:!0}],extraProcessor(s,e,t,n,r,o,a){const i=r[r.length-1];return i.config||(i.config={}),i.config.glTF=a,r}},"animation/stopAt":{blocks:["FlowGraphStopAnimationBlock","FlowGraphArrayIndexBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{},inputs:{values:{animation:{name:"index",gltfType:"number",toBlock:"FlowGraphArrayIndexBlock"},stopTime:{name:"stopAtFrame",gltfType:"number",dataTransformer:(s,e)=>[s[0]*e._loader.parent.targetFps]}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"animationGroup",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"animationGroups",inputBlockIndex:1,outputBlockIndex:2,isVariable:!0}],extraProcessor(s,e,t,n,r,o,a){const i=r[r.length-1];return i.config||(i.config={}),i.config.glTF=a,r}},"math/switch":{blocks:["FlowGraphDataSwitchBlock"],configuration:{cases:{name:"cases",inOptions:!0,defaultValue:[]}},inputs:{values:{selection:{name:"case"}}},validation(s){if(s.configuration&&s.configuration.cases){const e=s.configuration.cases.value;if(!e.every(r=>typeof r=="number"&&/^\d+$/.test(r.toString())))return s.configuration.cases.value=[],!0;const n=new Set(e);s.configuration.cases.value=Array.from(n)}return!0},extraProcessor(s,e,t,n,r){return r[0].dataInputs.forEach(a=>{a.name!=="default"&&a.name!=="case"&&(a.name="in_"+a.name)}),r}},"debug/log":{blocks:["FlowGraphConsoleLogBlock"],configuration:{message:{name:"messageTemplate",inOptions:!0}}}};function y(s,e=["a"],t){return{blocks:[s],inputs:{values:e.reduce((n,r)=>(n[r]={name:r},n),{})},outputs:{values:{value:{name:"value"}}},extraProcessor(n,r,o,a,i){if(t){i[0].config=i[0].config||{};let l=-1;Object.keys(n.values||{}).find(c=>{var u;return((u=n.values)==null?void 0:u[c].type)!==void 0?(l=n.values[c].type,!0):!1}),l!==-1&&(i[0].config.type=a.arrays.types[l].flowGraphType)}return i}}}const Gr={float:{length:1,flowGraphType:"number",elementType:"number"},bool:{length:1,flowGraphType:"boolean",elementType:"boolean"},float2:{length:2,flowGraphType:"Vector2",elementType:"number"},float3:{length:3,flowGraphType:"Vector3",elementType:"number"},float4:{length:4,flowGraphType:"Vector4",elementType:"number"},float4x4:{length:16,flowGraphType:"Matrix",elementType:"number"},float2x2:{length:4,flowGraphType:"Matrix2D",elementType:"number"},float3x3:{length:9,flowGraphType:"Matrix3D",elementType:"number"},int:{length:1,flowGraphType:"FlowGraphInteger",elementType:"number"}};class $r{constructor(e,t,n){this._interactivityGraph=e,this._gltf=t,this._loader=n,this._types=[],this._mappings=[],this._staticVariables=[],this._events=[],this._internalEventsCounter=0,this._nodes=[],this._parseTypes(),this._parseDeclarations(),this._parseVariables(),this._parseEvents(),this._parseNodes()}get arrays(){return{types:this._types,mappings:this._mappings,staticVariables:this._staticVariables,events:this._events,nodes:this._nodes}}_parseTypes(){if(this._interactivityGraph.types)for(const e of this._interactivityGraph.types)this._types.push(Gr[e.signature])}_parseDeclarations(){if(this._interactivityGraph.declarations)for(const e of this._interactivityGraph.declarations){const t=es(e);if(!t)throw I.Error(["No mapping found for declaration",e]),new Error("Error parsing declarations");this._mappings.push({flowGraphMapping:t,fullOperationName:e.extension?e.op+":"+e.extension:e.op})}}_parseVariables(){if(this._interactivityGraph.variables)for(const e of this._interactivityGraph.variables){const t=this._parseVariable(e);this._staticVariables.push(t)}}_parseVariable(e,t){const n=this._types[e.type];if(!n)throw I.Error(["No type found for variable",e]),new Error("Error parsing variables");if(e.value&&e.value.length!==n.length)throw I.Error(["Invalid value length for variable",e,n]),new Error("Error parsing variables");const r=e.value||[];if(!r.length)switch(n.flowGraphType){case"boolean":r.push(!1);break;case"FlowGraphInteger":r.push(0);break;case"number":r.push(NaN);break;case"Vector2":r.push(NaN,NaN);break;case"Vector3":r.push(NaN,NaN,NaN);break;case"Vector4":case"Matrix2D":case"Quaternion":r.fill(NaN,0,4);break;case"Matrix":r.fill(NaN,0,16);break;case"Matrix3D":r.fill(NaN,0,9);break}return{type:n.flowGraphType,value:t?t(r,this):r}}_parseEvents(){if(this._interactivityGraph.events)for(const e of this._interactivityGraph.events){const t={eventId:e.id||"internalEvent_"+this._internalEventsCounter++};e.values&&(t.eventData=Object.keys(e.values).map(n=>{var i;const r=(i=e.values)==null?void 0:i[n];if(!r)throw I.Error(["No value found for event key",n]),new Error("Error parsing events");const o=this._types[r.type];if(!o)throw I.Error(["No type found for event value",r]),new Error("Error parsing events");const a=typeof r.value<"u"?this._parseVariable(r):void 0;return{id:n,type:o.flowGraphType,eventData:!0,value:a}})),this._events.push(t)}}_parseNodes(){if(this._interactivityGraph.nodes)for(const e of this._interactivityGraph.nodes){if(typeof e.declaration!="number")throw I.Error(["No declaration found for node",e]),new Error("Error parsing nodes");const t=this._mappings[e.declaration];if(!t)throw I.Error(["No mapping found for node",e]),new Error("Error parsing nodes");if(t.flowGraphMapping.validation&&!t.flowGraphMapping.validation(e,this._interactivityGraph,this._gltf))throw new Error(`Error validating interactivity node ${e}`);const n=[];for(const r of t.flowGraphMapping.blocks){const o=this._getEmptyBlock(r,t.fullOperationName);this._parseNodeConfiguration(e,o,t.flowGraphMapping,r),n.push(o)}this._nodes.push({blocks:n,fullOperationName:t.fullOperationName})}}_getEmptyBlock(e,t){return{uniqueId:Bt(),className:e,dataInputs:[],dataOutputs:[],signalInputs:[],signalOutputs:[],config:{},type:t,metadata:{}}}_parseNodeConfiguration(e,t,n,r){const o=t.config;e.configuration&&Object.keys(e.configuration).forEach(a=>{var u,h;const i=(u=e.configuration)==null?void 0:u[a];if(!i)throw I.Error(["No value found for node configuration",a]),new Error("Error parsing node configuration");const l=(h=n.configuration)==null?void 0:h[a];if(l&&l.toBlock?l.toBlock===r:n.blocks.indexOf(r)===0){const d=(l==null?void 0:l.name)||a;(!i||typeof i.value>"u")&&typeof(l==null?void 0:l.defaultValue)<"u"?o[d]={value:l.defaultValue}:i.value.length>=1?o[d]={value:i.value.length===1?i.value[0]:i.value}:I.Warn(["Invalid value for node configuration",i]),l&&l.dataTransformer&&(o[d].value=l.dataTransformer([o[d].value],this)[0])}})}_parseNodeConnections(e){var t,n,r,o,a,i,l,c,u,h,d,f,m,b,E,v,D,k,N;for(let w=0;w<this._nodes.length;w++){const C=(t=this._interactivityGraph.nodes)==null?void 0:t[w];if(!C)throw I.Error(["No node found for interactivity node",this._nodes[w]]),new Error("Error parsing node connections");const x=this._nodes[w],O=this._mappings[C.declaration];if(!O)throw I.Error(["No mapping found for node",C]),new Error("Error parsing node connections");const V=C.flows||{},H=Object.keys(V).sort();for(const ee of H){const re=V[ee],Y=(r=(n=O.flowGraphMapping.outputs)==null?void 0:n.flows)==null?void 0:r[ee],Me=(Y==null?void 0:Y.name)||ee,Fe=this._createNewSocketConnection(Me,!0);(Y&&Y.toBlock&&x.blocks.find(fe=>fe.className===Y.toBlock)||x.blocks[0]).signalOutputs.push(Fe);const Rt=re.node,oe=this._nodes[Rt];if(!oe)throw I.Error(["No node found for input node id",Rt]),new Error("Error parsing node connections");const be=Pn(oe.fullOperationName);if(!be)throw I.Error(["No mapping found for input node",oe]),new Error("Error parsing node connections");let le=(a=(o=be.inputs)==null?void 0:o.flows)==null?void 0:a[re.socket||"in"],Oe=!1;if(!le)for(const fe in(i=be.inputs)==null?void 0:i.flows)fe.startsWith("[")&&fe.endsWith("]")&&(Oe=!0,le=(c=(l=be.inputs)==null?void 0:l.flows)==null?void 0:c[fe]);const ce=le?Oe?le.name.replace("$1",re.socket||""):le.name:re.socket||"in",$e=le&&le.toBlock&&oe.blocks.find(fe=>fe.className===le.toBlock)||oe.blocks[0];let Ae=$e.signalInputs.find(fe=>fe.name===ce);Ae||(Ae=this._createNewSocketConnection(ce),$e.signalInputs.push(Ae)),Ae.connectedPointIds.push(Fe.uniqueId),Fe.connectedPointIds.push(Ae.uniqueId)}const U=C.values||{},Xe=Object.keys(U);for(const ee of Xe){const re=U[ee];let Y=(h=(u=O.flowGraphMapping.inputs)==null?void 0:u.values)==null?void 0:h[ee],Me=!1;if(!Y)for(const oe in(d=O.flowGraphMapping.inputs)==null?void 0:d.values)oe.startsWith("[")&&oe.endsWith("]")&&(Me=!0,Y=(m=(f=O.flowGraphMapping.inputs)==null?void 0:f.values)==null?void 0:m[oe]);const Fe=Y?Me?Y.name.replace("$1",ee):Y.name:ee,Ge=this._createNewSocketConnection(Fe);if((Y&&Y.toBlock&&x.blocks.find(oe=>oe.className===Y.toBlock)||x.blocks[0]).dataInputs.push(Ge),re.value!==void 0){const oe=this._parseVariable(re,Y&&Y.dataTransformer);e._connectionValues[Ge.uniqueId]=oe}else if(typeof re.node<"u"){const oe=re.node,be=re.socket||"value",le=this._nodes[oe];if(!le)throw I.Error(["No node found for output socket reference",re]),new Error("Error parsing node connections");const Oe=Pn(le.fullOperationName);if(!Oe)throw I.Error(["No mapping found for output socket reference",re]),new Error("Error parsing node connections");let ce=(E=(b=Oe.outputs)==null?void 0:b.values)==null?void 0:E[be],$e=!1;if(!ce)for(const Ne in(v=Oe.outputs)==null?void 0:v.values)Ne.startsWith("[")&&Ne.endsWith("]")&&($e=!0,ce=(k=(D=Oe.outputs)==null?void 0:D.values)==null?void 0:k[Ne]);const Ae=ce?$e?ce.name.replace("$1",be):ce==null?void 0:ce.name:be,fe=ce&&ce.toBlock&&le.blocks.find(Ne=>Ne.className===ce.toBlock)||le.blocks[0];let De=fe.dataOutputs.find(Ne=>Ne.name===Ae);De||(De=this._createNewSocketConnection(Ae,!0),fe.dataOutputs.push(De)),Ge.connectedPointIds.push(De.uniqueId),De.connectedPointIds.push(Ge.uniqueId)}else throw I.Error(["Invalid value for value connection",re]),new Error("Error parsing node connections")}if(O.flowGraphMapping.interBlockConnectors)for(const ee of O.flowGraphMapping.interBlockConnectors){const re=ee.input,Y=ee.output,Me=ee.isVariable;this._connectFlowGraphNodes(re,Y,x.blocks[ee.inputBlockIndex],x.blocks[ee.outputBlockIndex],Me)}if(O.flowGraphMapping.extraProcessor){const ee=(N=this._interactivityGraph.declarations)==null?void 0:N[C.declaration];if(!ee)throw I.Error(["No declaration found for extra processor",C]),new Error("Error parsing node connections");x.blocks=O.flowGraphMapping.extraProcessor(C,ee,O.flowGraphMapping,this,x.blocks,e,this._gltf)}}}_createNewSocketConnection(e,t){return{uniqueId:Bt(),name:e,_connectionType:t?1:0,connectedPointIds:[]}}_connectFlowGraphNodes(e,t,n,r,o){const a=o?n.dataInputs:n.signalInputs,i=o?r.dataOutputs:r.signalOutputs,l=a.find(u=>u.name===e)||this._createNewSocketConnection(e),c=i.find(u=>u.name===t)||this._createNewSocketConnection(t,!0);a.find(u=>u.name===e)||a.push(l),i.find(u=>u.name===t)||i.push(c),l.connectedPointIds.push(c.uniqueId),c.connectedPointIds.push(l.uniqueId)}getVariableName(e){return"staticVariable_"+e}serializeToFlowGraph(){const e={uniqueId:Bt(),_userVariables:{},_connectionValues:{}};this._parseNodeConnections(e);for(let n=0;n<this._staticVariables.length;n++){const r=this._staticVariables[n];e._userVariables[this.getVariableName(n)]=r}return{rightHanded:!0,allBlocks:this._nodes.reduce((n,r)=>n.concat(r.blocks),[]),executionContexts:[e]}}}const Ye="KHR_interactivity";class Dr{constructor(e){this._loader=e,this.name=Ye,this.enabled=this._loader.isExtensionUsed(Ye),this._pathConverter=jn(this._loader.gltf),e._skipStartAnimationStep=!0;const t=e.babylonScene;t&&Vr(t)}dispose(){this._loader=null,delete this._pathConverter}async onReady(){var o;if(!this._loader.babylonScene||!this._pathConverter)return;const e=this._loader.babylonScene,t=(o=this._loader.gltf.extensions)==null?void 0:o.KHR_interactivity;if(!t)return;const n=new Os({scene:e}),r=t.graphs.map(a=>new $r(a,this._loader.gltf,this._loader).serializeToFlowGraph());await Promise.all(r.map(a=>Ns(a,{coordinator:n,pathConverter:this._pathConverter}))),n.start()}}function Vr(s){me("/extensions/KHR_interactivity/?/activeCamera/rotation",{get:()=>s.activeCamera?Z.FromRotationMatrix(s.activeCamera.getWorldMatrix()).normalize():new Z(NaN,NaN,NaN,NaN),type:"Quaternion",getTarget:()=>s.activeCamera}),me("/extensions/KHR_interactivity/?/activeCamera/position",{get:()=>s.activeCamera?s.activeCamera.position:new S(NaN,NaN,NaN),type:"Vector3",getTarget:()=>s.activeCamera}),me("/animations/{}/extensions/KHR_interactivity/isPlaying",{get:e=>{var t;return((t=e._babylonAnimationGroup)==null?void 0:t.isPlaying)??!1},type:"boolean",getTarget:e=>e._babylonAnimationGroup}),me("/animations/{}/extensions/KHR_interactivity/minTime",{get:e=>{var t;return(((t=e._babylonAnimationGroup)==null?void 0:t.from)??0)/60},type:"number",getTarget:e=>e._babylonAnimationGroup}),me("/animations/{}/extensions/KHR_interactivity/maxTime",{get:e=>{var t;return(((t=e._babylonAnimationGroup)==null?void 0:t.to)??0)/60},type:"number",getTarget:e=>e._babylonAnimationGroup}),me("/animations/{}/extensions/KHR_interactivity/playhead",{get:e=>{var t;return(((t=e._babylonAnimationGroup)==null?void 0:t.getCurrentFrame())??0)/60},type:"number",getTarget:e=>e._babylonAnimationGroup}),me("/animations/{}/extensions/KHR_interactivity/virtualPlayhead",{get:e=>{var t;return(((t=e._babylonAnimationGroup)==null?void 0:t.getCurrentFrame())??0)/60},type:"number",getTarget:e=>e._babylonAnimationGroup})}Cs(Ye,"FlowGraphGLTFDataProvider",async()=>(await $t(async()=>{const{FlowGraphGLTFDataProvider:s}=await Promise.resolve().then(()=>Yr);return{FlowGraphGLTFDataProvider:s}},void 0,import.meta.url)).FlowGraphGLTFDataProvider);P(Ye);L(Ye,!0,s=>new Dr(s));const Mt="KHR_node_visibility";me("/nodes/{}/extensions/KHR_node_visibility/visible",{get:s=>{const e=s._babylonTransformNode;return e&&e.isVisible!==void 0?e.isVisible:!0},set:(s,e)=>{var t,n;(t=e._primitiveBabylonMeshes)==null||t.forEach(r=>{r.inheritVisibility=!0}),e._babylonTransformNode&&(e._babylonTransformNode.isVisible=s),(n=e._primitiveBabylonMeshes)==null||n.forEach(r=>{r.isVisible=s})},getTarget:s=>s._babylonTransformNode,getPropertyName:[()=>"isVisible"],type:"boolean"});class Hr{constructor(e){this.name=Mt,this._loader=e,this.enabled=e.isExtensionUsed(Mt)}async onReady(){var e;(e=this._loader.gltf.nodes)==null||e.forEach(t=>{var n,r,o,a;(n=t._primitiveBabylonMeshes)==null||n.forEach(i=>{i.inheritVisibility=!0}),(r=t.extensions)!=null&&r.KHR_node_visibility&&((o=t.extensions)==null?void 0:o.KHR_node_visibility.visible)===!1&&(t._babylonTransformNode&&(t._babylonTransformNode.isVisible=!1),(a=t._primitiveBabylonMeshes)==null||a.forEach(i=>{i.isVisible=!1}))})}dispose(){this._loader=null}}P(Mt);L(Mt,!0,s=>new Hr(s));const je="KHR_node_selectability";An("event/onSelect",je,{blocks:["FlowGraphMeshPickEventBlock","FlowGraphGetVariableBlock","FlowGraphIndexOfBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{stopPropagation:{name:"stopPropagation"},nodeIndex:{name:"variable",toBlock:"FlowGraphGetVariableBlock",dataTransformer(s){return["pickedMesh_"+s[0]]}}},outputs:{values:{selectedNodeIndex:{name:"index",toBlock:"FlowGraphIndexOfBlock"},controllerIndex:{name:"pointerId"},selectionPoint:{name:"pickedPoint"},selectionRayOrigin:{name:"pickOrigin"}},flows:{out:{name:"done"}}},interBlockConnectors:[{input:"asset",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"nodes",inputBlockIndex:2,outputBlockIndex:3,isVariable:!0},{input:"object",output:"pickedMesh",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0}],extraProcessor(s,e,t,n,r,o,a){var u,h,d,f,m,b;const i=r[r.length-1];i.config=i.config||{},i.config.glTF=a;const l=(h=(u=s.configuration)==null?void 0:u.nodeIndex)==null?void 0:h.value[0];if(l===void 0||typeof l!="number")throw new Error("nodeIndex not found in configuration");const c="pickedMesh_"+l;return r[1].config.variable=c,o._userVariables[c]={className:"Mesh",id:(f=(d=a==null?void 0:a.nodes)==null?void 0:d[l]._babylonTransformNode)==null?void 0:f.id,uniqueId:(b=(m=a==null?void 0:a.nodes)==null?void 0:m[l]._babylonTransformNode)==null?void 0:b.uniqueId},r}});me("/nodes/{}/extensions/KHR_node_selectability/selectable",{get:s=>{const e=s._babylonTransformNode;return e&&e.isPickable!==void 0?e.isPickable:!0},set:(s,e)=>{var t;(t=e._primitiveBabylonMeshes)==null||t.forEach(n=>{n.isPickable=s})},getTarget:s=>s._babylonTransformNode,getPropertyName:[()=>"isPickable"],type:"boolean"});class Kr{constructor(e){this.name=je,this._loader=e,this.enabled=e.isExtensionUsed(je)}async onReady(){var e;(e=this._loader.gltf.nodes)==null||e.forEach(t=>{var n,r,o;(n=t.extensions)!=null&&n.KHR_node_selectability&&((r=t.extensions)==null?void 0:r.KHR_node_selectability.selectable)===!1&&((o=t._babylonTransformNode)==null||o.getChildMeshes().forEach(a=>{a.isPickable=!1}))})}dispose(){this._loader=null}}P(je);L(je,!0,s=>new Kr(s));const Re="KHR_node_hoverability",Ln="targetMeshPointerOver_";An("event/onHoverIn",Re,{blocks:["FlowGraphPointerOverEventBlock","FlowGraphGetVariableBlock","FlowGraphIndexOfBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{stopPropagation:{name:"stopPropagation"},nodeIndex:{name:"variable",toBlock:"FlowGraphGetVariableBlock",dataTransformer(s){return[Ln+s[0]]}}},outputs:{values:{hoverNodeIndex:{name:"index",toBlock:"FlowGraphIndexOfBlock"},controllerIndex:{name:"pointerId"}},flows:{out:{name:"done"}}},interBlockConnectors:[{input:"targetMesh",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"nodes",inputBlockIndex:2,outputBlockIndex:3,isVariable:!0},{input:"object",output:"meshUnderPointer",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0}],extraProcessor(s,e,t,n,r,o,a){var u,h,d,f,m,b;const i=r[r.length-1];i.config=i.config||{},i.config.glTF=a;const l=(h=(u=s.configuration)==null?void 0:u.nodeIndex)==null?void 0:h.value[0];if(l===void 0||typeof l!="number")throw new Error("nodeIndex not found in configuration");const c=Ln+l;return r[1].config.variable=c,o._userVariables[c]={className:"Mesh",id:(f=(d=a==null?void 0:a.nodes)==null?void 0:d[l]._babylonTransformNode)==null?void 0:f.id,uniqueId:(b=(m=a==null?void 0:a.nodes)==null?void 0:m[l]._babylonTransformNode)==null?void 0:b.uniqueId},r}});const Rn="targetMeshPointerOut_";An("event/onHoverOut",Re,{blocks:["FlowGraphPointerOutEventBlock","FlowGraphGetVariableBlock","FlowGraphIndexOfBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{stopPropagation:{name:"stopPropagation"},nodeIndex:{name:"variable",toBlock:"FlowGraphGetVariableBlock",dataTransformer(s){return[Rn+s[0]]}}},outputs:{values:{hoverNodeIndex:{name:"index",toBlock:"FlowGraphIndexOfBlock"},controllerIndex:{name:"pointerId"}},flows:{out:{name:"done"}}},interBlockConnectors:[{input:"targetMesh",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"nodes",inputBlockIndex:2,outputBlockIndex:3,isVariable:!0},{input:"object",output:"meshOutOfPointer",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0}],extraProcessor(s,e,t,n,r,o,a){var u,h,d,f,m,b;const i=r[r.length-1];i.config=i.config||{},i.config.glTF=a;const l=(h=(u=s.configuration)==null?void 0:u.nodeIndex)==null?void 0:h.value[0];if(l===void 0||typeof l!="number")throw new Error("nodeIndex not found in configuration");const c=Rn+l;return r[1].config.variable=c,o._userVariables[c]={className:"Mesh",id:(f=(d=a==null?void 0:a.nodes)==null?void 0:d[l]._babylonTransformNode)==null?void 0:f.id,uniqueId:(b=(m=a==null?void 0:a.nodes)==null?void 0:m[l]._babylonTransformNode)==null?void 0:b.uniqueId},r}});me("/nodes/{}/extensions/KHR_node_hoverability/hoverable",{get:s=>{const e=s._babylonTransformNode;return e&&e.pointerOverDisableMeshTesting!==void 0?e.pointerOverDisableMeshTesting:!0},set:(s,e)=>{var t;(t=e._primitiveBabylonMeshes)==null||t.forEach(n=>{n.pointerOverDisableMeshTesting=!s})},getTarget:s=>s._babylonTransformNode,getPropertyName:[()=>"pointerOverDisableMeshTesting"],type:"boolean"});class Ur{constructor(e){this.name=Re,this._loader=e,this.enabled=e.isExtensionUsed(Re)}async onReady(){var e;(e=this._loader.gltf.nodes)==null||e.forEach(t=>{var n,r,o;(n=t.extensions)!=null&&n.KHR_node_hoverability&&((r=t.extensions)==null?void 0:r.KHR_node_hoverability.hoverable)===!1&&((o=t._babylonTransformNode)==null||o.getChildMeshes().forEach(a=>{a.pointerOverDisableMeshTesting=!0}))})}dispose(){this._loader=null}}P(Re);L(Re,!0,s=>new Ur(s));const Tn="ExtrasAsMetadata";class qr{_assignExtras(e,t){if(t.extras&&Object.keys(t.extras).length>0){const n=e.metadata=e.metadata||{},r=n.gltf=n.gltf||{};r.extras=t.extras}}constructor(e){this.name=Tn,this.enabled=!0,this._loader=e}dispose(){this._loader=null}loadNodeAsync(e,t,n){return this._loader.loadNodeAsync(e,t,r=>{this._assignExtras(r,t),n(r)})}loadCameraAsync(e,t,n){return this._loader.loadCameraAsync(e,t,r=>{this._assignExtras(r,t),n(r)})}createMaterial(e,t,n){const r=this._loader.createMaterial(e,t,n);return this._assignExtras(r,t),r}}P(Tn);L(Tn,!1,s=>new qr(s));class Wr extends Is{constructor(e){var o,a;super();const t=e.glTF,n=((o=t.animations)==null?void 0:o.map(i=>i._babylonAnimationGroup))||[];this.animationGroups=this.registerDataOutput("animationGroups",vn,n);const r=((a=t.nodes)==null?void 0:a.map(i=>i._babylonTransformNode))||[];this.nodes=this.registerDataOutput("nodes",vn,r)}getClassName(){return"FlowGraphGLTFDataProvider"}}const Yr=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphGLTFDataProvider:Wr},Symbol.toStringTag,{value:"Module"}));
