import{E as K,S as re,a as x,C,V as l,M as L,b as T,B as ee,T as se,A as S,c as z,d as m,R as le,e as ce,H as de,D as ue}from"./babylon-core-CPh0TrEW.js";function me(){const e=document.getElementById("renderCanvas");if(!e)throw new Error("Render canvas not found.");const t={preserveDrawingBuffer:!0,stencil:!0};let o;try{o=new K(e,!0,{...t,disableWebGL2Support:!1})}catch{o=new K(e,!0,{...t,disableWebGL2Support:!0})}const n=new re(o);return{canvas:e,engine:o,scene:n}}const pe=new URL("../../Assets/Medieval Village MegaKit[Standard]/glTF/",import.meta.url).href,fe="https://cdn.jsdelivr.net/npm/babylonjs-loaders@7.54.3/babylonjs.loaders.min.js";let _=null;function he(){return T.IsPluginForExtensionAvailable(".gltf")?Promise.resolve():(_||(_=new Promise((e,t)=>{globalThis.BABYLON=globalThis.BABYLON??ee;const o=document.createElement("script");o.src=fe,o.async=!0,o.onload=()=>e(),o.onerror=()=>t(new Error("Failed to load Babylon glTF loader script.")),document.head.appendChild(o)})),_)}function j(e,t,o,n,i,r=!0){const s=L.CreateBox(t,o,e);return s.position=n,s.material=i,s.isVisible=r,s.checkCollisions=!0,s}function H(e){const t=e.getChildMeshes(!1);if(t.length===0)return null;let o=t[0].getBoundingInfo().boundingBox.minimumWorld.clone(),n=t[0].getBoundingInfo().boundingBox.maximumWorld.clone();for(let s=1;s<t.length;s+=1){const a=t[s].getBoundingInfo().boundingBox;o=l.Minimize(o,a.minimumWorld),n=l.Maximize(n,a.maximumWorld)}const i=n.subtract(o),r=o.add(n).scale(.5);return{min:o,max:n,size:i,center:r}}function we(e,t,o,n=0){e.rotation.set(0,n,0),e.scaling.set(1,1,1),e.position.set(0,0,0),e.computeWorldMatrix(!0);let i=H(e);if(!i)return;const r=new l(Math.max(i.size.x,.001),Math.max(i.size.y,.001),Math.max(i.size.z,.001)),s=Math.min(t.x/r.x,t.y/r.y,t.z/r.z);if(e.scaling.setAll(s),e.computeWorldMatrix(!0),i=H(e),!i)return;const a=new l(i.center.x,i.min.y,i.center.z);e.position.copyFrom(o.subtract(a)),e.computeWorldMatrix(!0)}async function ge(e,t){const o=new URL(t,pe).href,n=await T.LoadAssetContainerAsync("",o,e,void 0,".gltf");return n.removeAllFromScene(),n}function h(e,t,o,n,i=!1){const r=t.instantiateModelsToScene(a=>`${o}_${a}`,!1),s=new se(`${o}_root`,e);return r.rootNodes.forEach(a=>{a.parent||(a.parent=s)}),we(s,n.size,n.position,n.rotationY??0),i&&s.getChildMeshes(!1).forEach(a=>{a.checkCollisions=!0}),s}async function ye(e){const t={corner:"Corner_Exterior_Brick.gltf",wallBrick:"Wall_UnevenBrick_Straight.gltf",wallDoor:"Wall_Plaster_Door_Flat.gltf",wallWindow:"Wall_Plaster_Window_Wide_Flat.gltf",wallPlain:"Wall_Plaster_Straight.gltf",floor:"Floor_WoodDark.gltf",roofHouse:"Roof_RoundTiles_8x14.gltf",roofSide:"Roof_RoundTiles_4x8.gltf",stairs:"Stairs_Exterior_Straight.gltf",balcony:"Balcony_Simple_Straight.gltf",support:"Prop_Support.gltf",fence:"Prop_WoodenFence_Single.gltf",crate:"Prop_Crate.gltf",vine:"Prop_Vine2.gltf"},o=await Promise.all(Object.entries(t).map(async([c,f])=>[c,await ge(e,f)])),n=Object.fromEntries(o),i=new l(0,0,-10),r=6.9,s=5.9,a=0,d=3.7;h(e,n.floor,"mainBuildingFloorLower",{size:new l(14.2,.65,12),position:new l(i.x,.05,i.z),rotationY:0}),h(e,n.floor,"mainBuildingFloorUpper",{size:new l(14.6,.65,12.4),position:new l(i.x,4.1,i.z),rotationY:0}),h(e,n.wallDoor,"mainBuildingFrontDoor",{size:new l(6.2,4,1.25),position:new l(i.x,a,i.z+s),rotationY:Math.PI}),h(e,n.wallWindow,"mainBuildingFrontWindowL",{size:new l(3.8,4,1.25),position:new l(i.x-4.9,a,i.z+s),rotationY:Math.PI}),h(e,n.wallWindow,"mainBuildingFrontWindowR",{size:new l(3.8,4,1.25),position:new l(i.x+4.9,a,i.z+s),rotationY:Math.PI}),h(e,n.wallBrick,"mainBuildingBackLower",{size:new l(14.2,4.1,1.25),position:new l(i.x,a,i.z-s),rotationY:0}),h(e,n.wallPlain,"mainBuildingLeftLower",{size:new l(12.1,4.1,1.25),position:new l(i.x-r,a,i.z),rotationY:-Math.PI/2}),h(e,n.wallPlain,"mainBuildingRightLower",{size:new l(12.1,4.1,1.25),position:new l(i.x+r,a,i.z),rotationY:Math.PI/2}),h(e,n.wallWindow,"mainBuildingFrontUpper",{size:new l(14.4,3.7,1.15),position:new l(i.x,d,i.z+s+.05),rotationY:Math.PI}),h(e,n.wallWindow,"mainBuildingBackUpper",{size:new l(14.4,3.7,1.15),position:new l(i.x,d,i.z-s-.05),rotationY:0}),h(e,n.wallWindow,"mainBuildingLeftUpper",{size:new l(12.2,3.7,1.15),position:new l(i.x-r-.05,d,i.z),rotationY:-Math.PI/2}),h(e,n.wallWindow,"mainBuildingRightUpper",{size:new l(12.2,3.7,1.15),position:new l(i.x+r+.05,d,i.z),rotationY:Math.PI/2}),[new l(-r,a,-s),new l(r,a,-s),new l(-r,a,s),new l(r,a,s),new l(-r,d,-s),new l(r,d,-s),new l(-r,d,s),new l(r,d,s)].forEach((c,f)=>{h(e,n.corner,`mainBuildingCorner_${f}`,{size:new l(1.45,4.1,1.45),position:i.add(c),rotationY:f%4*(Math.PI/2)})}),h(e,n.roofHouse,"mainBuildingRoofMain",{size:new l(17.5,7.1,15.2),position:new l(i.x,7.2,i.z),rotationY:0}),h(e,n.roofSide,"mainBuildingRoofDoor",{size:new l(6.7,2.8,5.2),position:new l(i.x+3.2,3.9,i.z+s+1.7),rotationY:Math.PI}),h(e,n.balcony,"mainBuildingBalcony",{size:new l(7.2,1.8,1.6),position:new l(i.x-4.7,4.2,i.z+s+1.1),rotationY:Math.PI}),h(e,n.support,"mainBuildingSupportA",{size:new l(.9,3.8,.9),position:new l(i.x-7.2,0,i.z+s+.7),rotationY:0}),h(e,n.support,"mainBuildingSupportB",{size:new l(.9,3.8,.9),position:new l(i.x-2.2,0,i.z+s+.7),rotationY:0}),h(e,n.stairs,"mainBuildingStairs",{size:new l(6.2,3.2,4.4),position:new l(i.x+.2,0,i.z+s+4.4),rotationY:Math.PI});for(let c=-5;c<=5;c+=1)h(e,n.fence,`roadFenceLeft_${c}`,{size:new l(3.2,1.6,.7),position:new l(-7.5,0,c*4),rotationY:Math.PI/2}),h(e,n.fence,`roadFenceRight_${c}`,{size:new l(3.2,1.6,.7),position:new l(7.5,0,c*4),rotationY:-Math.PI/2});h(e,n.crate,"roadCrateA",{size:new l(1.2,1.2,1.2),position:new l(-5.4,0,9.4),rotationY:.2}),h(e,n.crate,"roadCrateB",{size:new l(1.2,1.2,1.2),position:new l(5.1,0,10.5),rotationY:-.35}),h(e,n.vine,"mainBuildingVineA",{size:new l(2.6,4.3,1.4),position:new l(i.x-5.6,.2,i.z+4.4),rotationY:.7}),h(e,n.vine,"mainBuildingVineB",{size:new l(2.6,4.3,1.4),position:new l(i.x+4.3,3.6,i.z-3.8),rotationY:-.4})}function be(e,t,o,n){const i=L.CreateGround("villageGround",{width:96,height:96},e);i.material=t,i.checkCollisions=!0;const r=L.CreateGround("mainRoad",{width:11.5,height:88},e);return r.position.y=.01,r.material=o,r.checkCollisions=!1,j(e,"mainBuildingCollider",{width:18.8,height:10.6,depth:14.8},new l(0,5.3,-10),n,!1),[{name:"boundWest",pos:new l(-48.5,3,0),size:new l(1,6,97)},{name:"boundEast",pos:new l(48.5,3,0),size:new l(1,6,97)},{name:"boundNorth",pos:new l(0,3,-48.5),size:new l(97,6,1)},{name:"boundSouth",pos:new l(0,3,48.5),size:new l(97,6,1)}].forEach(a=>{j(e,a.name,{width:a.size.x,height:a.size.y,depth:a.size.z},a.pos,n,!1)}),i}async function Ae(e){e.collisionsEnabled=!0,await he();const t=new x("terrainMaterial",e);t.diffuseColor=new C(.25,.5,.24);const o=new x("roadMaterial",e);o.diffuseColor=new C(.4,.28,.17);const n=new x("hiddenCollisionMaterial",e);n.diffuseColor=new C(.35,.35,.35),n.alpha=0;const i=new x("markerMaterial",e);i.diffuseColor=new C(.84,.67,.33);const r=new l(-4.2,0,-16.5),s=new l(0,0,42),a=new l(4.8,0,9.8),d=be(e,t,o,n);await ye(e);const u=j(e,"shrineMarker",{width:1.2,depth:1.2,height:2.8},new l(r.x,1.4,r.z),i,!1);u.checkCollisions=!1,u.isPickable=!1;const c=L.CreateSphere("incenseFlame",{diameter:.22,segments:12},e);return c.material=i,c.isVisible=!1,c.checkCollisions=!1,{ground:d,shrinePosition:r,gatePosition:s,interactablePosition:a,interactableFlame:c}}const y={movement:{walkSpeed:5.8,sprintSpeed:8.8,acceleration:24,deceleration:16,airAcceleration:7,jumpSpeed:7.6,gravity:-19,fallGravityMultiplier:1.22,lowJumpGravityMultiplier:1.1,coyoteTime:.08,jumpBufferTime:.12,rotationLerp:11,playerHeight:1.8,spawnPosition:{x:0,y:1.1,z:20}},camera:{distance:2.1,minDistance:1.2,maxDistance:3.4,heightOffset:1.9,mouseSensitivity:.0011,pitchMin:-.7,pitchMax:.95,followLerp:12,lookAheadDistance:.9,lookAheadLerp:6,cameraRotationFollowLerp:5,cameraRotationMoveThreshold:.25,collisionRadius:.34,inertia:.62},effects:{dustMotes:{count:24,radius:20,minHeight:.7,maxHeight:3.4,driftSpeed:.18,bobAmplitude:.14,size:.055}},audio:{ambientVolume:.06,bellVolume:.2},world:{shrineTriggerRadius:2.4,gateTriggerRadius:2.8,interactRange:2.2,checkpointResetCooldown:.35}},R={idle:["idle","breath","stand"],run:["run","walk","jog"],jump:["jump","fall"]};function Y(e,t){const o=t.map(n=>n.toLowerCase());return e.find(n=>{var r;const i=((r=n.name)==null?void 0:r.toLowerCase())??"";return o.some(s=>i.includes(s))})??null}function Me(e){if(!e)return null;const t=e.clone("jumpProxyGroup");return t.speedRatio=.7,t.stop(),t}function $(e=[]){const t=Y(e,R.idle),o=Y(e,R.run),n=Y(e,R.jump)??Me(o),i={idle:t,run:o,jump:n},r={idle:0,run:0,jump:0};let s="idle",a=!1;Object.values(i).forEach(c=>{!c||!(c instanceof S)||(c.play(!0),c.setWeightForAllAnimatables(0),c.enableBlending=!0,c.blendingSpeed=.08,a=!0)}),a&&i.idle&&(r.idle=1,i.idle.setWeightForAllAnimatables(1));function d(c){a&&(s=c)}function u(c,f){if(!a)return;const w={idle:s==="idle"?1:0,run:s==="run"?1:0,jump:s==="jump"?1:0},b=z.Clamp(c*10,0,1);i.idle&&(r.idle=z.Lerp(r.idle,w.idle,b),i.idle.setWeightForAllAnimatables(r.idle)),i.run&&(r.run=z.Lerp(r.run,w.run,b),i.run.speedRatio=z.Lerp(.9,1.35,z.Clamp(f.normalizedSpeed,0,1)),i.run.setWeightForAllAnimatables(r.run)),i.jump&&(r.jump=z.Lerp(r.jump,w.jump,b),i.jump.setWeightForAllAnimatables(r.jump))}return{isReady:()=>a,setState:d,update:u}}const Pe="https://cdn.jsdelivr.net/npm/babylonjs-loaders@7.54.3/babylonjs.loaders.min.js",Le=new URL(""+new URL("Meshy_AI_Monastic_Contemplatio_0223043241_texture-De5dN5g8.glb",import.meta.url).href,import.meta.url).href,ve=new URL(""+new URL("Meshy_AI_Animation_Walking_withSkin-BPaoHyrO.glb",import.meta.url).href,import.meta.url).href,Ce=new URL(""+new URL("Meshy_AI_Animation_Running_withSkin-BvKtgFaU.glb",import.meta.url).href,import.meta.url).href;let D=null,q=!1;function xe(e){if(q)return;q=!0;const t=e instanceof Error?e.message:String(e??"unknown reason");console.warn(`Falling back to procedural monk character: ${t}`)}function Te(){return T.IsPluginForExtensionAvailable(".glb")?Promise.resolve():(D||(D=new Promise((e,t)=>{globalThis.BABYLON=globalThis.BABYLON??ee;const o=document.createElement("script");o.src=Pe,o.async=!0,o.onload=()=>e(),o.onerror=()=>t(new Error("Failed to load Babylon UMD loaders script.")),document.head.appendChild(o)})),D)}function Se(e,t){const o=new x("monkSkinMaterial",t);o.diffuseColor=new C(.86,.73,.58);const n=new x("monkRobeMaterial",t);n.diffuseColor=new C(.71,.42,.2);const i=new x("monkSashMaterial",t);i.diffuseColor=new C(.6,.22,.18);const r=L.CreateBox("monkRoot",{size:.01},t);r.parent=e,r.position=new l(0,-.1,0),r.isVisible=!1;const s=L.CreateCylinder("monkRobe",{height:1.14,diameterTop:.42,diameterBottom:.76,tessellation:18},t);s.material=n,s.parent=r,s.position=new l(0,.32,0);const a=L.CreateSphere("monkHead",{diameter:.42,segments:20},t);a.material=o,a.parent=r,a.position=new l(0,1.05,0);const d=L.CreateTorus("monkSash",{diameter:.5,thickness:.08,tessellation:24},t);d.material=i,d.parent=r,d.position=new l(0,.45,0),d.rotation.x=Math.PI/2;const u=L.CreateCapsule("monkArmLeft",{radius:.08,height:.65,tessellation:12},t);u.material=n,u.parent=r,u.position=new l(-.28,.63,0),u.rotation.z=.22;const c=L.CreateCapsule("monkArmRight",{radius:.08,height:.65,tessellation:12},t);return c.material=n,c.parent=r,c.position=new l(.28,.63,0),c.rotation.z=-.22,{root:r,armLeft:u,armRight:c}}function Ie(e,t){const o=new m("idle-bob","position.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);o.setKeys([{frame:0,value:t.root.position.y},{frame:15,value:t.root.position.y+.03},{frame:30,value:t.root.position.y}]);const n=new m("run-bob","position.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);n.setKeys([{frame:0,value:t.root.position.y-.04},{frame:8,value:t.root.position.y+.06},{frame:15,value:t.root.position.y-.04},{frame:22,value:t.root.position.y+.06},{frame:30,value:t.root.position.y-.04}]);const i=new m("run-arm-left","rotation.x",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);i.setKeys([{frame:0,value:-.6},{frame:15,value:.6},{frame:30,value:-.6}]);const r=new m("run-arm-right","rotation.x",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);r.setKeys([{frame:0,value:.6},{frame:15,value:-.6},{frame:30,value:.6}]);const s=new m("jump-lift","position.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);s.setKeys([{frame:0,value:t.root.position.y},{frame:12,value:t.root.position.y+.24},{frame:22,value:t.root.position.y+.16},{frame:30,value:t.root.position.y}]);const a=new m("jump-arms","rotation.x",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);a.setKeys([{frame:0,value:0},{frame:12,value:-.8},{frame:30,value:0}]);const d=new S("idle");d.addTargetedAnimation(o,t.root);const u=new S("run");u.addTargetedAnimation(n,t.root),u.addTargetedAnimation(i,t.armLeft),u.addTargetedAnimation(r,t.armRight);const c=new S("jump");return c.addTargetedAnimation(s,t.root),c.addTargetedAnimation(a,t.armLeft),c.addTargetedAnimation(a.clone(),t.armRight),[d,u,c]}function J(e,t){const o=t.position.y,n=new m("idle-bob-proxy","position.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);n.setKeys([{frame:0,value:o},{frame:15,value:o+.025},{frame:30,value:o}]);const i=new m("run-bob-proxy","position.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);i.setKeys([{frame:0,value:o-.03},{frame:8,value:o+.045},{frame:15,value:o-.03},{frame:22,value:o+.045},{frame:30,value:o-.03}]);const r=new m("run-sway-proxy","rotation.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);r.setKeys([{frame:0,value:-.03},{frame:15,value:.03},{frame:30,value:-.03}]);const s=new m("jump-lift-proxy","position.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);s.setKeys([{frame:0,value:o},{frame:12,value:o+.16},{frame:22,value:o+.08},{frame:30,value:o}]);const a=new S("idle");a.addTargetedAnimation(n,t);const d=new S("run");d.addTargetedAnimation(i,t),d.addTargetedAnimation(r,t);const u=new S("jump");return u.addTargetedAnimation(s,t),[a,d,u]}function ze(e){return e.targetedAnimations.every(t=>!!t.target)}function N(e,t){return e.animationGroups.filter(o=>!t.has(o.name))}function Ee(e,t,o=.02){const n=t.getChildMeshes(!1);if(n.length===0)return;t.computeWorldMatrix(!0);let i=Number.POSITIVE_INFINITY;n.forEach(s=>{const a=s.getBoundingInfo().boundingBox.minimumWorld.y;a<i&&(i=a)});const r=e.position.y-.9+o;t.position.y+=r-i,t.computeWorldMatrix(!0)}async function Oe(e,t){var r,s;if(await Te(),!T.IsPluginForExtensionAvailable(".glb"))throw new Error("GLTF loader script did not register a .glb plugin.");const o=new Set(t.animationGroups.map(a=>a.name));let n=null,i=null;try{n=await T.ImportMeshAsync("","",Le,t,void 0,".glb");const a=n.meshes.find(d=>!d.parent)??n.meshes[0];if(!a)throw new Error("Unable to find GLB model root mesh for monk character.");a.parent=e,a.position=new l(0,0,0),a.scaling=new l(.9,.9,.9),a.rotationQuaternion=null,Ee(e,a),i=new Map,n.meshes.forEach(d=>i.set(d.name,d)),n.transformNodes.forEach(d=>i.set(d.name,d)),n.skeletons.forEach(d=>i.set(d.name,d))}catch(a){throw n&&(n.meshes.forEach(u=>{u&&!u.isDisposed()&&u.dispose(!1,!0)}),n.transformNodes.forEach(u=>{u&&!u.isDisposed()&&u.dispose(!1,!0)}),n.skeletons.forEach(u=>{u&&!u.isDisposed()&&u.dispose()})),N(t,o).forEach(u=>u.dispose()),a}try{const a=f=>f!=null&&f.name?i.get(f.name)??null:null;await T.ImportAnimationsAsync("",ve,t,!1,void 0,a,void 0,void 0,void 0,".glb"),await T.ImportAnimationsAsync("",Ce,t,!1,void 0,a,void 0,void 0,void 0,".glb");const u=N(t,o).filter(ze);if(u.length>0)return u;const c=n.meshes.find(f=>f.parent===e)??n.meshes[0];return c?J(t,c):[]}catch(a){N(t,o).forEach(c=>c.dispose()),console.warn(`Monk GLB loaded but animation import failed. Using static model. ${a instanceof Error?a.message:String(a)}`);const u=((r=n==null?void 0:n.meshes)==null?void 0:r.find(c=>c.parent===e))??((s=n==null?void 0:n.meshes)==null?void 0:s[0]);return u?J(t,u):[]}}async function ke(e,t){try{const o=await Oe(e,t),n=$(o);return{setAnimationState:n.setState,update:(i,r)=>n.update(i,r),loadedFromGlb:!0}}catch(o){xe(o);const n=Se(e,t),i=Ie(t,n),r=$(i);return{setAnimationState:r.setState,update:(s,a)=>r.update(s,a),loadedFromGlb:!1}}}function Be(e){const t=L.CreateCapsule("playerCapsule",{radius:.45,height:1.8,tessellation:12},e);t.isVisible=!1,t.ellipsoid=new l(.45,.9,.45),t.ellipsoidOffset=new l(0,.9,0),t.checkCollisions=!0;const o=y.movement.spawnPosition;return t.position=new l(o.x,o.y,o.z),t}async function Fe(e,t){return ke(e,t)}const E=new l,B=new l,v=new l,Q=new l,X=new l,_e=new l(0,-1,0),Z=new l(0,0,1);function Re(e,t,o){const n=Be(e),i={setAnimationState:()=>{},update:()=>{},loadedFromGlb:!1};Fe(n,e).then(p=>{i.setAnimationState=p.setAnimationState,i.update=p.update,i.loadedFromGlb=p.loadedFromGlb});const r=new l(0,0,0),s=y.movement.playerHeight/2,a=.03,d=.14,u=new le(X,_e,s+.3);let c=!1,f=0,w=0,b=0;function M(){X.set(n.position.x,n.position.y+.05,n.position.z),u.length=s+.35;const p=e.pickWithRay(u,k=>k!==n&&k.checkCollisions===!0);if(!(p!=null&&p.hit)||!p.pickedPoint){c=!1;return}const A=n.position.y-s,P=p.pickedPoint.y;c=A-P<=d,c&&r.y<=0&&(r.y=0,n.position.y=P+s+a)}function g(p){f+=p;const A=e.activeCamera;if(!A)return;E.copyFrom(A.getForwardRay().direction),E.y=0,E.normalize(),l.CrossToRef(l.UpReadOnly,E,B),B.normalize(),v.setAll(0),o.keys.forward&&v.addInPlace(E),o.keys.back&&v.subtractInPlace(E),o.keys.left&&v.subtractInPlace(B),o.keys.right&&v.addInPlace(B);const P=v.lengthSquared()>0;P&&v.normalize();const I=o.keys.sprint?y.movement.sprintSpeed:y.movement.walkSpeed,k=P?v.x*I:0,te=P?v.z*I:0;let G=P?y.movement.acceleration:y.movement.deceleration;!c&&P&&(G=y.movement.airAcceleration);const W=Math.min(1,G*p);r.x+=(k-r.x)*W,r.z+=(te-r.z)*W,M(),c?w=y.movement.coyoteTime:w=Math.max(0,w-p),o.consumeJumpPress()?b=y.movement.jumpBufferTime:b=Math.max(0,b-p),b>0&&(c||w>0)&&(r.y=y.movement.jumpSpeed,c=!1,w=0,b=0);let F=1;r.y<0?F=y.movement.fallGravityMultiplier:r.y>0&&!o.keys.jump&&(F=y.movement.lowJumpGravityMultiplier),r.y+=y.movement.gravity*F*p,Q.set(r.x*p,r.y*p,r.z*p),n.moveWithCollisions(Q),M();const V=Math.hypot(r.x,r.z),ne=V/y.movement.sprintSpeed,oe=c?V>.35?"run":"idle":"jump";if(i.setAnimationState(oe),i.update(p,{elapsedTime:f,normalizedSpeed:ne,isGrounded:c}),P){const U=Math.atan2(v.x,v.z),ie=Math.min(1,y.movement.rotationLerp*p),ae=Math.atan2(Math.sin(U-n.rotation.y),Math.cos(U-n.rotation.y));n.rotation.y+=ae*ie,Z.set(Math.sin(n.rotation.y),0,Math.cos(n.rotation.y))}}return{mesh:n,update:g,getPosition:()=>n.position,setPosition:p=>{n.position.copyFrom(p),r.set(0,0,0),c=!1},isGrounded:()=>c,getFacingDirection:()=>Z,getHorizontalSpeed:()=>Math.hypot(r.x,r.z),usesGlbCharacter:()=>i.loadedFromGlb}}function Ye(e){const t={forward:!1,back:!1,left:!1,right:!1,sprint:!1,jump:!1};let o=!1;const n=new Map([["KeyW","forward"],["KeyS","back"],["KeyA","left"],["KeyD","right"],["ShiftLeft","sprint"],["ShiftRight","sprint"]]);function i(){t.forward=!1,t.back=!1,t.left=!1,t.right=!1,t.sprint=!1,t.jump=!1,o=!1}function r(d){n.has(d.code)&&(t[n.get(d.code)]=!0),d.code==="Space"&&(d.repeat||(o=!0),t.jump=!0,d.preventDefault())}function s(d){n.has(d.code)&&(t[n.get(d.code)]=!1),d.code==="Space"&&(t.jump=!1,d.preventDefault())}function a(){i()}return window.addEventListener("keydown",r),window.addEventListener("keyup",s),window.addEventListener("blur",a),e.setAttribute("tabindex","0"),{keys:t,consumeJumpPress(){const d=o;return o=!1,d},dispose(){window.removeEventListener("keydown",r),window.removeEventListener("keyup",s),window.removeEventListener("blur",a),i()}}}function De(e,t,o){const n=y.camera,i=new l,r=new l,s=new ce("playerCamera",Math.PI*1.4,1.1,n.distance,o.getPosition(),e);s.attachControl(t,!0),s.lowerBetaLimit=n.pitchMin+Math.PI/2,s.upperBetaLimit=n.pitchMax+Math.PI/2,s.lowerRadiusLimit=n.minDistance,s.upperRadiusLimit=n.maxDistance,s.wheelDeltaPercentage=.01,s.angularSensibilityX=1/n.mouseSensitivity,s.angularSensibilityY=1/n.mouseSensitivity,s.inertia=n.inertia,s.checkCollisions=!0,s.collisionRadius=new l(n.collisionRadius,n.collisionRadius,n.collisionRadius),e.activeCamera=s;function a(){var u;document.pointerLockElement!==t&&((u=t.requestPointerLock)==null||u.call(t))}function d(u){const c=o.getPosition(),f=o.getFacingDirection();r.set(f.x*n.lookAheadDistance,0,f.z*n.lookAheadDistance);const w=Math.min(1,n.lookAheadLerp*u);if(i.x+=(c.x+r.x-i.x)*w,i.z+=(c.z+r.z-i.z)*w,i.y=c.y+n.heightOffset,o.getHorizontalSpeed()>n.cameraRotationMoveThreshold){const M=c?o.mesh.rotation.y+Math.PI:s.alpha,g=Math.atan2(Math.sin(M-s.alpha),Math.cos(M-s.alpha)),p=Math.min(1,n.cameraRotationFollowLerp*u);s.alpha+=g*p}const b=Math.min(1,n.followLerp*u);s.target=l.Lerp(s.target,i,b)}return{camera:s,activatePointerLock:a,update:d}}function Ne(){const e=document.getElementById("startScreen"),t=document.getElementById("playButton"),o=document.getElementById("hud"),n=document.getElementById("objectiveText"),i=document.getElementById("storyBox"),r=document.getElementById("interactPrompt");let s=!1,a=!1;function d(g){s||(s=!0,setTimeout(()=>{e.classList.remove("visible"),o.classList.remove("hidden"),g==null||g()},120))}function u(g){t.addEventListener("click",()=>d(g))}function c(g){i.textContent=g,i.classList.remove("hidden")}function f(g){n.textContent=`Objective: ${g}`}function w(g){r.textContent=g,r.classList.remove("hidden")}function b(){r.classList.add("hidden")}function M(g){g.code==="KeyE"&&!g.repeat&&(a=!0)}return window.addEventListener("keydown",M),{bindStart:u,showStory:c,setObjective:f,showInteractPrompt:w,hideInteractPrompt:b,consumeInteractPressed(){const g=a;return a=!1,g},isPlaying:()=>s,dispose(){window.removeEventListener("keydown",M)}}}function je(e,t,o){let n=!1,i=!1,r=t.getPosition().clone(),s=0,a=!1,d=()=>{};function u(w){d=w}function c(w){s>0&&(s=Math.max(0,s-w));const b=t.getPosition();n||l.Distance(b,e.shrinePosition)<=y.world.shrineTriggerRadius&&(n=!0,r=e.shrinePosition.clone(),r.y=b.y,o.showStory("A distant bell rings. Something calls you beyond the monastery."),o.setObjective("Find the sealed gate"),d()),!i&&e.gatePosition&&l.Distance(b,e.gatePosition)<=y.world.gateTriggerRadius&&(i=!0,r=e.gatePosition.clone(),r.y=b.y,o.showStory("Beyond the gate, mountain winds carry distant chanting. The world is waiting."),o.setObjective("Offer incense (E) and continue your journey")),a&&s<=0&&(a=!1,s=y.world.checkpointResetCooldown,t.setPosition(r),o.showStory("You center your breath and return to your last point of calm."),o.showInteractPrompt("Checkpoint restored"),window.setTimeout(()=>{o.hideInteractPrompt()},900))}function f(w){w.code==="KeyR"&&!w.repeat&&(a=!0)}return window.addEventListener("keydown",f),{update:c,setOnShrineTriggered:u,isShrineTriggered:()=>n,isGateTriggered:()=>i,dispose(){window.removeEventListener("keydown",f)}}}function O(e,t){return e+Math.random()*(t-e)}function Ge(e){const t=y.effects.dustMotes,o=[],n=new x("dustMoteMaterial",e);n.diffuseColor=new C(.95,.89,.75),n.emissiveColor=new C(.12,.1,.06),n.alpha=.5,n.disableLighting=!0;for(let r=0;r<t.count;r+=1){const s=L.CreateSphere(`dustMote${r}`,{diameter:t.size,segments:6},e),a=new l(O(-20,t.radius),O(t.minHeight,t.maxHeight),O(-20,t.radius));s.position.copyFrom(a),s.material=n,s.isPickable=!1,s.checkCollisions=!1,o.push({mesh:s,basePos:a,phase:Math.random()*Math.PI*2,driftDir:new l(O(-1,1),0,O(-1,1)).normalize()})}function i(r){const s=performance.now()*.001;for(const a of o)a.mesh.position.x+=a.driftDir.x*t.driftSpeed*r,a.mesh.position.z+=a.driftDir.z*t.driftSpeed*r,a.mesh.position.y=a.basePos.y+Math.sin(s+a.phase)*t.bobAmplitude,Math.abs(a.mesh.position.x)>t.radius&&(a.mesh.position.x=-a.mesh.position.x*.9),Math.abs(a.mesh.position.z)>t.radius&&(a.mesh.position.z=-a.mesh.position.z*.9)}return{update:i}}function We(){let e,t,o,n=!1;function i(){e||(e=new window.AudioContext),e.state==="suspended"&&e.resume()}function r(){if(n)return;i(),t=e.createOscillator(),o=e.createGain();const a=e.createBiquadFilter();t.type="triangle",t.frequency.value=110,a.type="lowpass",a.frequency.value=320,a.Q.value=.4,o.gain.value=y.audio.ambientVolume,t.connect(a),a.connect(o),o.connect(e.destination),t.start(),n=!0}function s(){if(!n)return;const a=e.currentTime,d=e.createGain(),u=e.createOscillator(),c=e.createOscillator();u.type="sine",c.type="sine",u.frequency.setValueAtTime(784,a),c.frequency.setValueAtTime(1176,a),d.gain.setValueAtTime(y.audio.bellVolume,a),d.gain.exponentialRampToValueAtTime(.001,a+2.1),u.connect(d),c.connect(d),d.connect(e.destination),u.start(a),c.start(a+.01),u.stop(a+2.2),c.stop(a+2.2)}return{start:r,playShrineBell:s}}const Ve=new l(0,1,0);function Ue(e,t,o){let n=!1;function i(){if(!e.interactablePosition||n)return;const r=t.getPosition();if(l.Distance(r,e.interactablePosition)>y.world.interactRange){o.hideInteractPrompt();return}o.showInteractPrompt("Press E to light incense"),o.consumeInteractPressed()&&(n=!0,o.hideInteractPrompt(),o.showStory("You light the incense bowl. Smoke curls upward, and the silence deepens."),e.interactableFlame&&(e.interactableFlame.isVisible=!0,e.interactableFlame.position.copyFrom(e.interactablePosition).addInPlace(Ve)))}return{update:i,isCompleted:()=>n}}function Ke(){const e=document.createElement("div");return e.style.position="fixed",e.style.right="12px",e.style.top="10px",e.style.padding="4px 8px",e.style.fontSize="12px",e.style.background="rgba(0,0,0,0.4)",e.style.border="1px solid rgba(255,255,255,0.15)",e.style.borderRadius="4px",e.style.color="#d8dde9",e.style.pointerEvents="none",e.textContent="FPS: --",document.body.appendChild(e),{update(t){e.textContent=`FPS: ${Math.round(t)}`}}}async function $e(){const{canvas:e,engine:t,scene:o}=me();o.clearColor.set(.56,.62,.72,1);const n=new de("hemiLight",new l(0,1,0),o);n.intensity=.68,n.groundColor=new C(.26,.22,.16);const i=new ue("sunLight",new l(-.4,-1,.35),o);i.intensity=1.6,i.position=new l(15,30,-10);const r=await Ae(o),s=Ye(e),a=Re(o,r,s),d=De(o,e,a),u=Ne(),c=je(r,a,u),f=Ge(o),w=We(),b=Ue(r,a,u),M=Ke();u.bindStart(()=>{e.focus(),d.activatePointerLock(),w.start()}),c.setOnShrineTriggered(()=>{w.playShrineBell()}),o.onBeforeRenderObservable.add(()=>{if(!u.isPlaying())return;const A=o.getEngine().getDeltaTime()/1e3;a.update(A),d.update(A),f.update(A),c.update(A),b.update(A),M.update(o.getEngine().getFps())}),t.runRenderLoop(()=>{o.render()}),window.addEventListener("resize",()=>{t.resize()});let g=!1;const p=()=>{var A,P,I;g||(g=!0,(A=s.dispose)==null||A.call(s),(P=c.dispose)==null||P.call(c),(I=u.dispose)==null||I.call(u))};o.onDisposeObservable.add(p),window.addEventListener("beforeunload",p,{once:!0})}export{$e as createGame};
