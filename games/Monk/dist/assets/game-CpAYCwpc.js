import{ae as U,af as ae,i as C,j as x,c as l,ag as L,ah as O,ai as re,v as se,aj as I,ak as S,m,B as le,al as ce,am as ue,H as de,n as me}from"./babylon-core-DLTSUY03.js";import"./vendor-CQX5WEA_.js";function pe(){const e=document.getElementById("renderCanvas");if(!e)throw new Error("Render canvas not found.");const t={preserveDrawingBuffer:!0,stencil:!0};let i;try{i=new U(e,!0,{...t,disableWebGL2Support:!1})}catch{i=new U(e,!0,{...t,disableWebGL2Support:!0})}const n=new ae(i);return{canvas:e,engine:i,scene:n}}const fe=new URL("../../Assets/Medieval Village MegaKit[Standard]/glTF/",import.meta.url).href,he="https://cdn.jsdelivr.net/npm/babylonjs-loaders@7.54.3/babylonjs.loaders.min.js";let _=null;function we(){return O.IsPluginForExtensionAvailable(".gltf")?Promise.resolve():(_||(_=new Promise((e,t)=>{globalThis.BABYLON=globalThis.BABYLON??re;const i=document.createElement("script");i.src=he,i.async=!0,i.onload=()=>e(),i.onerror=()=>t(new Error("Failed to load Babylon glTF loader script.")),document.head.appendChild(i)})),_)}function N(e,t,i,n,o,a=!0){const r=L.CreateBox(t,i,e);return r.position=n,r.material=o,r.isVisible=a,r.checkCollisions=!0,r}function K(e){const t=e.getChildMeshes(!1);if(t.length===0)return null;let i=t[0].getBoundingInfo().boundingBox.minimumWorld.clone(),n=t[0].getBoundingInfo().boundingBox.maximumWorld.clone();for(let r=1;r<t.length;r+=1){const s=t[r].getBoundingInfo().boundingBox;i=l.Minimize(i,s.minimumWorld),n=l.Maximize(n,s.maximumWorld)}const o=n.subtract(i),a=i.add(n).scale(.5);return{min:i,max:n,size:o,center:a}}function ge(e,t,i,n=0){e.rotation.set(0,n,0),e.scaling.set(1,1,1),e.position.set(0,0,0),e.computeWorldMatrix(!0);let o=K(e);if(!o)return;const a=new l(Math.max(o.size.x,.001),Math.max(o.size.y,.001),Math.max(o.size.z,.001)),r=Math.min(t.x/a.x,t.y/a.y,t.z/a.z);if(e.scaling.setAll(r),e.computeWorldMatrix(!0),o=K(e),!o)return;const s=new l(o.center.x,o.min.y,o.center.z);e.position.copyFrom(i.subtract(s)),e.computeWorldMatrix(!0)}async function ye(e,t){const i=new URL(t,fe).href,n=await O.LoadAssetContainerAsync("",i,e,void 0,".gltf");return n.removeAllFromScene(),n}function f(e,t,i,n,o=!1){const a=t.instantiateModelsToScene(s=>`${i}_${s}`,!1),r=new se(`${i}_root`,e);return a.rootNodes.forEach(s=>{s.parent||(s.parent=r)}),ge(r,n.size,n.position,n.rotationY??0),o&&r.getChildMeshes(!1).forEach(s=>{s.checkCollisions=!0}),r}async function be(e){const t={corner:"Corner_Exterior_Brick.gltf",wallBrick:"Wall_UnevenBrick_Straight.gltf",wallDoor:"Wall_Plaster_Door_Flat.gltf",wallWindow:"Wall_Plaster_Window_Wide_Flat.gltf",wallPlain:"Wall_Plaster_Straight.gltf",floor:"Floor_WoodDark.gltf",roofHouse:"Roof_RoundTiles_8x14.gltf",roofSide:"Roof_RoundTiles_4x8.gltf",stairs:"Stairs_Exterior_Straight.gltf",balcony:"Balcony_Simple_Straight.gltf",support:"Prop_Support.gltf",fence:"Prop_WoodenFence_Single.gltf",crate:"Prop_Crate.gltf",vine:"Prop_Vine2.gltf"},i=await Promise.all(Object.entries(t).map(async([c,y])=>[c,await ye(e,y)])),n=Object.fromEntries(i),o=new l(0,0,-10),a=6.9,r=5.9,s=0,u=3.7;f(e,n.floor,"mainBuildingFloorLower",{size:new l(14.2,.65,12),position:new l(o.x,.05,o.z),rotationY:0}),f(e,n.floor,"mainBuildingFloorUpper",{size:new l(14.6,.65,12.4),position:new l(o.x,4.1,o.z),rotationY:0}),f(e,n.wallDoor,"mainBuildingFrontDoor",{size:new l(6.2,4,1.25),position:new l(o.x,s,o.z+r),rotationY:Math.PI}),f(e,n.wallWindow,"mainBuildingFrontWindowL",{size:new l(3.8,4,1.25),position:new l(o.x-4.9,s,o.z+r),rotationY:Math.PI}),f(e,n.wallWindow,"mainBuildingFrontWindowR",{size:new l(3.8,4,1.25),position:new l(o.x+4.9,s,o.z+r),rotationY:Math.PI}),f(e,n.wallBrick,"mainBuildingBackLower",{size:new l(14.2,4.1,1.25),position:new l(o.x,s,o.z-r),rotationY:0}),f(e,n.wallPlain,"mainBuildingLeftLower",{size:new l(12.1,4.1,1.25),position:new l(o.x-a,s,o.z),rotationY:-Math.PI/2}),f(e,n.wallPlain,"mainBuildingRightLower",{size:new l(12.1,4.1,1.25),position:new l(o.x+a,s,o.z),rotationY:Math.PI/2}),f(e,n.wallWindow,"mainBuildingFrontUpper",{size:new l(14.4,3.7,1.15),position:new l(o.x,u,o.z+r+.05),rotationY:Math.PI}),f(e,n.wallWindow,"mainBuildingBackUpper",{size:new l(14.4,3.7,1.15),position:new l(o.x,u,o.z-r-.05),rotationY:0}),f(e,n.wallWindow,"mainBuildingLeftUpper",{size:new l(12.2,3.7,1.15),position:new l(o.x-a-.05,u,o.z),rotationY:-Math.PI/2}),f(e,n.wallWindow,"mainBuildingRightUpper",{size:new l(12.2,3.7,1.15),position:new l(o.x+a+.05,u,o.z),rotationY:Math.PI/2}),[new l(-a,s,-r),new l(a,s,-r),new l(-a,s,r),new l(a,s,r),new l(-a,u,-r),new l(a,u,-r),new l(-a,u,r),new l(a,u,r)].forEach((c,y)=>{f(e,n.corner,`mainBuildingCorner_${y}`,{size:new l(1.45,4.1,1.45),position:o.add(c),rotationY:y%4*(Math.PI/2)})}),f(e,n.roofHouse,"mainBuildingRoofMain",{size:new l(17.5,7.1,15.2),position:new l(o.x,7.2,o.z),rotationY:0}),f(e,n.roofSide,"mainBuildingRoofDoor",{size:new l(6.7,2.8,5.2),position:new l(o.x+3.2,3.9,o.z+r+1.7),rotationY:Math.PI}),f(e,n.balcony,"mainBuildingBalcony",{size:new l(7.2,1.8,1.6),position:new l(o.x-4.7,4.2,o.z+r+1.1),rotationY:Math.PI}),f(e,n.support,"mainBuildingSupportA",{size:new l(.9,3.8,.9),position:new l(o.x-7.2,0,o.z+r+.7),rotationY:0}),f(e,n.support,"mainBuildingSupportB",{size:new l(.9,3.8,.9),position:new l(o.x-2.2,0,o.z+r+.7),rotationY:0}),f(e,n.stairs,"mainBuildingStairs",{size:new l(6.2,3.2,4.4),position:new l(o.x+.2,0,o.z+r+4.4),rotationY:Math.PI});for(let c=-5;c<=5;c+=1)f(e,n.fence,`roadFenceLeft_${c}`,{size:new l(3.2,1.6,.7),position:new l(-7.5,0,c*4),rotationY:Math.PI/2}),f(e,n.fence,`roadFenceRight_${c}`,{size:new l(3.2,1.6,.7),position:new l(7.5,0,c*4),rotationY:-Math.PI/2});f(e,n.crate,"roadCrateA",{size:new l(1.2,1.2,1.2),position:new l(-5.4,0,9.4),rotationY:.2}),f(e,n.crate,"roadCrateB",{size:new l(1.2,1.2,1.2),position:new l(5.1,0,10.5),rotationY:-.35}),f(e,n.vine,"mainBuildingVineA",{size:new l(2.6,4.3,1.4),position:new l(o.x-5.6,.2,o.z+4.4),rotationY:.7}),f(e,n.vine,"mainBuildingVineB",{size:new l(2.6,4.3,1.4),position:new l(o.x+4.3,3.6,o.z-3.8),rotationY:-.4})}function Ae(e,t,i,n){const o=L.CreateGround("villageGround",{width:96,height:96},e);o.material=t,o.checkCollisions=!0;const a=L.CreateGround("mainRoad",{width:11.5,height:88},e);return a.position.y=.01,a.material=i,a.checkCollisions=!1,N(e,"mainBuildingCollider",{width:18.8,height:10.6,depth:14.8},new l(0,5.3,-10),n,!1),[{name:"boundWest",pos:new l(-48.5,3,0),size:new l(1,6,97)},{name:"boundEast",pos:new l(48.5,3,0),size:new l(1,6,97)},{name:"boundNorth",pos:new l(0,3,-48.5),size:new l(97,6,1)},{name:"boundSouth",pos:new l(0,3,48.5),size:new l(97,6,1)}].forEach(s=>{N(e,s.name,{width:s.size.x,height:s.size.y,depth:s.size.z},s.pos,n,!1)}),o}async function Me(e){e.collisionsEnabled=!0,await we();const t=new C("terrainMaterial",e);t.diffuseColor=new x(.25,.5,.24);const i=new C("roadMaterial",e);i.diffuseColor=new x(.4,.28,.17);const n=new C("hiddenCollisionMaterial",e);n.diffuseColor=new x(.35,.35,.35),n.alpha=0;const o=new C("markerMaterial",e);o.diffuseColor=new x(.84,.67,.33);const a=new l(-4.2,0,-16.5),r=new l(0,0,42),s=new l(4.8,0,9.8),u=Ae(e,t,i,n);await be(e);const d=N(e,"shrineMarker",{width:1.2,depth:1.2,height:2.8},new l(a.x,1.4,a.z),o,!1);d.checkCollisions=!1,d.isPickable=!1;const c=L.CreateSphere("incenseFlame",{diameter:.22,segments:12},e);return c.material=o,c.isVisible=!1,c.checkCollisions=!1,{ground:u,shrinePosition:a,gatePosition:r,interactablePosition:s,interactableFlame:c}}const g={movement:{walkSpeed:5.8,sprintSpeed:8.8,acceleration:24,deceleration:16,airAcceleration:7,jumpSpeed:7.6,gravity:-19,fallGravityMultiplier:1.22,lowJumpGravityMultiplier:1.1,coyoteTime:.08,jumpBufferTime:.12,rotationLerp:11,playerHeight:1.8,spawnPosition:{x:0,y:1.1,z:20}},camera:{distance:2.1,minDistance:1.2,maxDistance:3.4,heightOffset:1.9,mouseSensitivity:.0011,pitchMin:-.7,pitchMax:.95,followLerp:12,lookAheadDistance:.9,lookAheadLerp:6,cameraRotationFollowLerp:5,cameraRotationMoveThreshold:.25,collisionRadius:.34,inertia:.62},effects:{dustMotes:{count:24,radius:20,minHeight:.7,maxHeight:3.4,driftSpeed:.18,bobAmplitude:.14,size:.055}},audio:{ambientVolume:.06,bellVolume:.2},world:{shrineTriggerRadius:2.4,gateTriggerRadius:2.8,interactRange:2.2,checkpointResetCooldown:.35}},F={idle:["idle","breath","stand"],run:["run","walk","jog"],jump:["jump","fall"]};function Y(e,t){const i=t.map(n=>n.toLowerCase());return e.find(n=>{var a;const o=((a=n.name)==null?void 0:a.toLowerCase())??"";return i.some(r=>o.includes(r))})??null}function Pe(e){if(!e)return null;const t=e.clone("jumpProxyGroup");return t.speedRatio=.7,t.stop(),t}function H(e=[]){const t=Y(e,F.idle),i=Y(e,F.run),n=Y(e,F.jump)??Pe(i),o={idle:t,run:i,jump:n},a={idle:0,run:0,jump:0};let r="idle",s=!1;Object.values(o).forEach(c=>{!c||!(c instanceof I)||(c.play(!0),c.setWeightForAllAnimatables(0),c.enableBlending=!0,c.blendingSpeed=.08,s=!0)}),s&&o.idle&&(a.idle=1,o.idle.setWeightForAllAnimatables(1));function u(c){s&&(r=c)}function d(c,y){if(!s)return;const h={idle:r==="idle"?1:0,run:r==="run"?1:0,jump:r==="jump"?1:0},b=S.Clamp(c*10,0,1);o.idle&&(a.idle=S.Lerp(a.idle,h.idle,b),o.idle.setWeightForAllAnimatables(a.idle)),o.run&&(a.run=S.Lerp(a.run,h.run,b),o.run.speedRatio=S.Lerp(.9,1.35,S.Clamp(y.normalizedSpeed,0,1)),o.run.setWeightForAllAnimatables(a.run)),o.jump&&(a.jump=S.Lerp(a.jump,h.jump,b),o.jump.setWeightForAllAnimatables(a.jump))}return{isReady:()=>s,setState:u,update:d}}const Le=new URL(""+new URL("Meshy_AI_Monastic_Contemplatio_0223043241_texture-De5dN5g8.glb",import.meta.url).href,import.meta.url).href,ve=new URL(""+new URL("Meshy_AI_Animation_Walking_withSkin-BPaoHyrO.glb",import.meta.url).href,import.meta.url).href,xe=new URL(""+new URL("Meshy_AI_Animation_Running_withSkin-BvKtgFaU.glb",import.meta.url).href,import.meta.url).href;let $=!1;function Ce(e){if($)return;$=!0;const t=e instanceof Error?e.message:String(e??"unknown reason");console.warn(`Falling back to procedural monk character: ${t}`)}function Ie(e,t){const i=new C("monkSkinMaterial",t);i.diffuseColor=new x(.86,.73,.58);const n=new C("monkRobeMaterial",t);n.diffuseColor=new x(.71,.42,.2);const o=new C("monkSashMaterial",t);o.diffuseColor=new x(.6,.22,.18);const a=L.CreateBox("monkRoot",{size:.01},t);a.parent=e,a.position=new l(0,-.1,0),a.isVisible=!1;const r=L.CreateCylinder("monkRobe",{height:1.14,diameterTop:.42,diameterBottom:.76,tessellation:18},t);r.material=n,r.parent=a,r.position=new l(0,.32,0);const s=L.CreateSphere("monkHead",{diameter:.42,segments:20},t);s.material=i,s.parent=a,s.position=new l(0,1.05,0);const u=L.CreateTorus("monkSash",{diameter:.5,thickness:.08,tessellation:24},t);u.material=o,u.parent=a,u.position=new l(0,.45,0),u.rotation.x=Math.PI/2;const d=L.CreateCapsule("monkArmLeft",{radius:.08,height:.65,tessellation:12},t);d.material=n,d.parent=a,d.position=new l(-.28,.63,0),d.rotation.z=.22;const c=L.CreateCapsule("monkArmRight",{radius:.08,height:.65,tessellation:12},t);return c.material=n,c.parent=a,c.position=new l(.28,.63,0),c.rotation.z=-.22,{root:a,armLeft:d,armRight:c}}function ze(e,t){const i=new m("idle-bob","position.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);i.setKeys([{frame:0,value:t.root.position.y},{frame:15,value:t.root.position.y+.03},{frame:30,value:t.root.position.y}]);const n=new m("run-bob","position.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);n.setKeys([{frame:0,value:t.root.position.y-.04},{frame:8,value:t.root.position.y+.06},{frame:15,value:t.root.position.y-.04},{frame:22,value:t.root.position.y+.06},{frame:30,value:t.root.position.y-.04}]);const o=new m("run-arm-left","rotation.x",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);o.setKeys([{frame:0,value:-.6},{frame:15,value:.6},{frame:30,value:-.6}]);const a=new m("run-arm-right","rotation.x",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);a.setKeys([{frame:0,value:.6},{frame:15,value:-.6},{frame:30,value:.6}]);const r=new m("jump-lift","position.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);r.setKeys([{frame:0,value:t.root.position.y},{frame:12,value:t.root.position.y+.24},{frame:22,value:t.root.position.y+.16},{frame:30,value:t.root.position.y}]);const s=new m("jump-arms","rotation.x",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);s.setKeys([{frame:0,value:0},{frame:12,value:-.8},{frame:30,value:0}]);const u=new I("idle");u.addTargetedAnimation(i,t.root);const d=new I("run");d.addTargetedAnimation(n,t.root),d.addTargetedAnimation(o,t.armLeft),d.addTargetedAnimation(a,t.armRight);const c=new I("jump");return c.addTargetedAnimation(r,t.root),c.addTargetedAnimation(s,t.armLeft),c.addTargetedAnimation(s.clone(),t.armRight),[u,d,c]}function Se(e,t){const i=t.position.y,n=new m("idle-bob-proxy","position.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);n.setKeys([{frame:0,value:i},{frame:15,value:i+.025},{frame:30,value:i}]);const o=new m("jump-lift-proxy","position.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);o.setKeys([{frame:0,value:i},{frame:12,value:i+.16},{frame:22,value:i+.08},{frame:30,value:i}]);const a=new I("idle");a.addTargetedAnimation(n,t);const r=new I("jump");return r.addTargetedAnimation(o,t),[a,r]}function Te(e,t){const i=t.position.y,n=new m("run-bob-proxy","position.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);n.setKeys([{frame:0,value:i-.03},{frame:8,value:i+.045},{frame:15,value:i-.03},{frame:22,value:i+.045},{frame:30,value:i-.03}]);const o=new m("run-sway-proxy","rotation.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);o.setKeys([{frame:0,value:-.03},{frame:15,value:.03},{frame:30,value:-.03}]);const a=new I("run");return a.addTargetedAnimation(n,t),a.addTargetedAnimation(o,t),a}function q(e,t){return e.animationGroups.filter(i=>!t.has(i.name))}function Ee(e,t,i=.02){const n=t.getChildMeshes(!1);if(n.length===0)return;t.computeWorldMatrix(!0);let o=Number.POSITIVE_INFINITY;n.forEach(r=>{const s=r.getBoundingInfo().boundingBox.minimumWorld.y;s<o&&(o=s)});const a=e.position.y-.9+i;t.position.y+=a-o,t.computeWorldMatrix(!0)}function D(e){var t,i,n;e&&((t=e.meshes)==null||t.forEach(o=>{o&&!o.isDisposed()&&o.dispose(!1,!0)}),(i=e.transformNodes)==null||i.forEach(o=>{o&&!o.isDisposed()&&o.dispose(!1,!0)}),(n=e.skeletons)==null||n.forEach(o=>{o&&!o.isDisposed()&&o.dispose()}))}function Oe(e){const t=new Map;return e.meshes.forEach(i=>t.set(i.name,i)),e.transformNodes.forEach(i=>t.set(i.name,i)),e.skeletons.forEach(i=>t.set(i.name,i)),t}function ke(e,t){const i=t.toLowerCase();return e.find(n=>{var o;return(o=n.name)==null?void 0:o.toLowerCase().includes(i)})??e.find(n=>n.targetedAnimations.length>0)??null}function Be(e,t,i,n,o){const a=new I(i,e),r=new Map(((o==null?void 0:o.bones)??[]).map(s=>[s.name,s]));return t.targetedAnimations.forEach(s=>{var c;const u=s.target;let d=null;u instanceof le||((c=u==null?void 0:u.getClassName)==null?void 0:c.call(u))==="Bone"?d=r.get(u.name)??null:u!=null&&u.name&&(d=n.get(u.name)??null),d&&a.addTargetedAnimation(s.animation.clone(`${i}_${s.animation.name||"anim"}`),d)}),a.targetedAnimations.length===0?(a.dispose(),null):a}async function J(e,t,i,n,o){const a=new Set(e.animationGroups.map(s=>s.name));let r=null;try{r=await O.ImportMeshAsync("","",t,e,void 0,".glb");const s=q(e,a),u=ke(s,i),d=u?Be(e,u,i,n,o):null;return s.forEach(c=>c.dispose()),D(r),d}catch(s){return q(e,a).forEach(d=>d.dispose()),D(r),console.warn(`Failed to import/retarget ${i} clip. ${s instanceof Error?s.message:String(s)}`),null}}async function Re(e,t){if(!O.IsPluginForExtensionAvailable(".glb"))throw new Error("GLTF loader plugin is not available.");let i=null;try{i=await O.ImportMeshAsync("","",Le,t,void 0,".glb");const n=i.meshes.find(y=>!y.parent)??i.meshes[0];if(!n)throw new Error("Unable to find GLB model root mesh for monk character.");n.parent=e,n.position=new l(0,0,0),n.scaling=new l(.9,.9,.9),n.rotationQuaternion=null,Ee(e,n);const o=Oe(i),a=i.skeletons[0]??null,[r,s]=await Promise.all([J(t,ve,"walk",o,a),J(t,xe,"run",o,a)]),[u,d]=Se(t,n),c=s??r??Te(t,n);return c.name="run",[u,c,d]}catch(n){throw D(i),n}}async function _e(e,t){try{const i=await Re(e,t),n=H(i);return{setAnimationState:n.setState,update:(o,a)=>n.update(o,a),loadedFromGlb:!0}}catch(i){Ce(i);const n=Ie(e,t),o=ze(t,n),a=H(o);return{setAnimationState:a.setState,update:(r,s)=>a.update(r,s),loadedFromGlb:!1}}}function Fe(e){const t=L.CreateCapsule("playerCapsule",{radius:.45,height:1.8,tessellation:12},e);t.isVisible=!1,t.ellipsoid=new l(.45,.9,.45),t.ellipsoidOffset=new l(0,.9,0),t.checkCollisions=!0;const i=g.movement.spawnPosition;return t.position=new l(i.x,i.y,i.z),t}async function Ye(e,t){return _e(e,t)}const T=new l,B=new l,v=new l,Q=new l,X=new l,Ne=new l(0,-1,0),Z=new l(0,0,1);function De(e,t,i){const n=Fe(e),o={setAnimationState:()=>{},update:()=>{},loadedFromGlb:!1};Ye(n,e).then(p=>{o.setAnimationState=p.setAnimationState,o.update=p.update,o.loadedFromGlb=p.loadedFromGlb});const a=new l(0,0,0),r=g.movement.playerHeight/2,s=.03,u=.14,d=new ce(X,Ne,r+.3);let c=!1,y=0,h=0,b=0;function M(){X.set(n.position.x,n.position.y+.05,n.position.z),d.length=r+.35;const p=e.pickWithRay(d,k=>k!==n&&k.checkCollisions===!0);if(!(p!=null&&p.hit)||!p.pickedPoint){c=!1;return}const A=n.position.y-r,P=p.pickedPoint.y;c=A-P<=u,c&&a.y<=0&&(a.y=0,n.position.y=P+r+s)}function w(p){y+=p;const A=e.activeCamera;if(!A)return;T.copyFrom(A.getForwardRay().direction),T.y=0,T.normalize(),l.CrossToRef(l.UpReadOnly,T,B),B.normalize(),v.setAll(0),i.keys.forward&&v.addInPlace(T),i.keys.back&&v.subtractInPlace(T),i.keys.left&&v.subtractInPlace(B),i.keys.right&&v.addInPlace(B);const P=v.lengthSquared()>0;P&&v.normalize();const z=i.keys.sprint?g.movement.sprintSpeed:g.movement.walkSpeed,k=P?v.x*z:0,ee=P?v.z*z:0;let j=P?g.movement.acceleration:g.movement.deceleration;!c&&P&&(j=g.movement.airAcceleration);const G=Math.min(1,j*p);a.x+=(k-a.x)*G,a.z+=(ee-a.z)*G,M(),c?h=g.movement.coyoteTime:h=Math.max(0,h-p),i.consumeJumpPress()?b=g.movement.jumpBufferTime:b=Math.max(0,b-p),b>0&&(c||h>0)&&(a.y=g.movement.jumpSpeed,c=!1,h=0,b=0);let R=1;a.y<0?R=g.movement.fallGravityMultiplier:a.y>0&&!i.keys.jump&&(R=g.movement.lowJumpGravityMultiplier),a.y+=g.movement.gravity*R*p,Q.set(a.x*p,a.y*p,a.z*p),n.moveWithCollisions(Q),M();const W=Math.hypot(a.x,a.z),te=W/g.movement.sprintSpeed,ne=c?W>.35?"run":"idle":"jump";if(o.setAnimationState(ne),o.update(p,{elapsedTime:y,normalizedSpeed:te,isGrounded:c}),P){const V=Math.atan2(v.x,v.z),oe=Math.min(1,g.movement.rotationLerp*p),ie=Math.atan2(Math.sin(V-n.rotation.y),Math.cos(V-n.rotation.y));n.rotation.y+=ie*oe,Z.set(Math.sin(n.rotation.y),0,Math.cos(n.rotation.y))}}return{mesh:n,update:w,getPosition:()=>n.position,setPosition:p=>{n.position.copyFrom(p),a.set(0,0,0),c=!1},isGrounded:()=>c,getFacingDirection:()=>Z,getHorizontalSpeed:()=>Math.hypot(a.x,a.z),usesGlbCharacter:()=>o.loadedFromGlb}}function je(e){const t={forward:!1,back:!1,left:!1,right:!1,sprint:!1,jump:!1};let i=!1;const n=new Map([["KeyW","forward"],["KeyS","back"],["KeyA","left"],["KeyD","right"],["ShiftLeft","sprint"],["ShiftRight","sprint"]]);function o(){t.forward=!1,t.back=!1,t.left=!1,t.right=!1,t.sprint=!1,t.jump=!1,i=!1}function a(u){n.has(u.code)&&(t[n.get(u.code)]=!0),u.code==="Space"&&(u.repeat||(i=!0),t.jump=!0,u.preventDefault())}function r(u){n.has(u.code)&&(t[n.get(u.code)]=!1),u.code==="Space"&&(t.jump=!1,u.preventDefault())}function s(){o()}return window.addEventListener("keydown",a),window.addEventListener("keyup",r),window.addEventListener("blur",s),e.setAttribute("tabindex","0"),{keys:t,consumeJumpPress(){const u=i;return i=!1,u},dispose(){window.removeEventListener("keydown",a),window.removeEventListener("keyup",r),window.removeEventListener("blur",s),o()}}}function Ge(e,t,i){const n=g.camera,o=new l,a=new l,r=new ue("playerCamera",Math.PI*1.4,1.1,n.distance,i.getPosition(),e);r.attachControl(t,!0),r.lowerBetaLimit=n.pitchMin+Math.PI/2,r.upperBetaLimit=n.pitchMax+Math.PI/2,r.lowerRadiusLimit=n.minDistance,r.upperRadiusLimit=n.maxDistance,r.wheelDeltaPercentage=.01,r.angularSensibilityX=1/n.mouseSensitivity,r.angularSensibilityY=1/n.mouseSensitivity,r.inertia=n.inertia,r.checkCollisions=!0,r.collisionRadius=new l(n.collisionRadius,n.collisionRadius,n.collisionRadius),e.activeCamera=r;function s(){var d;document.pointerLockElement!==t&&((d=t.requestPointerLock)==null||d.call(t))}function u(d){const c=i.getPosition(),y=i.getFacingDirection();a.set(y.x*n.lookAheadDistance,0,y.z*n.lookAheadDistance);const h=Math.min(1,n.lookAheadLerp*d);if(o.x+=(c.x+a.x-o.x)*h,o.z+=(c.z+a.z-o.z)*h,o.y=c.y+n.heightOffset,i.getHorizontalSpeed()>n.cameraRotationMoveThreshold){const M=c?i.mesh.rotation.y+Math.PI:r.alpha,w=Math.atan2(Math.sin(M-r.alpha),Math.cos(M-r.alpha)),p=Math.min(1,n.cameraRotationFollowLerp*d);r.alpha+=w*p}const b=Math.min(1,n.followLerp*d);r.target=l.Lerp(r.target,o,b)}return{camera:r,activatePointerLock:s,update:u}}function We(){const e=document.getElementById("startScreen"),t=document.getElementById("playButton"),i=document.getElementById("hud"),n=document.getElementById("objectiveText"),o=document.getElementById("storyBox"),a=document.getElementById("interactPrompt");let r=!1,s=!1;function u(w){r||(r=!0,setTimeout(()=>{e.classList.remove("visible"),i.classList.remove("hidden"),w==null||w()},120))}function d(w){t.addEventListener("click",()=>u(w))}function c(w){o.textContent=w,o.classList.remove("hidden")}function y(w){n.textContent=`Objective: ${w}`}function h(w){a.textContent=w,a.classList.remove("hidden")}function b(){a.classList.add("hidden")}function M(w){w.code==="KeyE"&&!w.repeat&&(s=!0)}return window.addEventListener("keydown",M),{bindStart:d,showStory:c,setObjective:y,showInteractPrompt:h,hideInteractPrompt:b,consumeInteractPressed(){const w=s;return s=!1,w},isPlaying:()=>r,dispose(){window.removeEventListener("keydown",M)}}}function Ve(e,t,i){let n=!1,o=!1,a=t.getPosition().clone(),r=0,s=!1,u=()=>{};function d(h){u=h}function c(h){r>0&&(r=Math.max(0,r-h));const b=t.getPosition();n||l.Distance(b,e.shrinePosition)<=g.world.shrineTriggerRadius&&(n=!0,a=e.shrinePosition.clone(),a.y=b.y,i.showStory("A distant bell rings. Something calls you beyond the monastery."),i.setObjective("Find the sealed gate"),u()),!o&&e.gatePosition&&l.Distance(b,e.gatePosition)<=g.world.gateTriggerRadius&&(o=!0,a=e.gatePosition.clone(),a.y=b.y,i.showStory("Beyond the gate, mountain winds carry distant chanting. The world is waiting."),i.setObjective("Offer incense (E) and continue your journey")),s&&r<=0&&(s=!1,r=g.world.checkpointResetCooldown,t.setPosition(a),i.showStory("You center your breath and return to your last point of calm."),i.showInteractPrompt("Checkpoint restored"),window.setTimeout(()=>{i.hideInteractPrompt()},900))}function y(h){h.code==="KeyR"&&!h.repeat&&(s=!0)}return window.addEventListener("keydown",y),{update:c,setOnShrineTriggered:d,isShrineTriggered:()=>n,isGateTriggered:()=>o,dispose(){window.removeEventListener("keydown",y)}}}function E(e,t){return e+Math.random()*(t-e)}function Ue(e){const t=g.effects.dustMotes,i=[],n=new C("dustMoteMaterial",e);n.diffuseColor=new x(.95,.89,.75),n.emissiveColor=new x(.12,.1,.06),n.alpha=.5,n.disableLighting=!0;for(let a=0;a<t.count;a+=1){const r=L.CreateSphere(`dustMote${a}`,{diameter:t.size,segments:6},e),s=new l(E(-20,t.radius),E(t.minHeight,t.maxHeight),E(-20,t.radius));r.position.copyFrom(s),r.material=n,r.isPickable=!1,r.checkCollisions=!1,i.push({mesh:r,basePos:s,phase:Math.random()*Math.PI*2,driftDir:new l(E(-1,1),0,E(-1,1)).normalize()})}function o(a){const r=performance.now()*.001;for(const s of i)s.mesh.position.x+=s.driftDir.x*t.driftSpeed*a,s.mesh.position.z+=s.driftDir.z*t.driftSpeed*a,s.mesh.position.y=s.basePos.y+Math.sin(r+s.phase)*t.bobAmplitude,Math.abs(s.mesh.position.x)>t.radius&&(s.mesh.position.x=-s.mesh.position.x*.9),Math.abs(s.mesh.position.z)>t.radius&&(s.mesh.position.z=-s.mesh.position.z*.9)}return{update:o}}function Ke(){let e,t,i,n=!1;function o(){e||(e=new window.AudioContext),e.state==="suspended"&&e.resume()}function a(){if(n)return;o(),t=e.createOscillator(),i=e.createGain();const s=e.createBiquadFilter();t.type="triangle",t.frequency.value=110,s.type="lowpass",s.frequency.value=320,s.Q.value=.4,i.gain.value=g.audio.ambientVolume,t.connect(s),s.connect(i),i.connect(e.destination),t.start(),n=!0}function r(){if(!n)return;const s=e.currentTime,u=e.createGain(),d=e.createOscillator(),c=e.createOscillator();d.type="sine",c.type="sine",d.frequency.setValueAtTime(784,s),c.frequency.setValueAtTime(1176,s),u.gain.setValueAtTime(g.audio.bellVolume,s),u.gain.exponentialRampToValueAtTime(.001,s+2.1),d.connect(u),c.connect(u),u.connect(e.destination),d.start(s),c.start(s+.01),d.stop(s+2.2),c.stop(s+2.2)}return{start:a,playShrineBell:r}}const He=new l(0,1,0);function $e(e,t,i){let n=!1;function o(){if(!e.interactablePosition||n)return;const a=t.getPosition();if(l.Distance(a,e.interactablePosition)>g.world.interactRange){i.hideInteractPrompt();return}i.showInteractPrompt("Press E to light incense"),i.consumeInteractPressed()&&(n=!0,i.hideInteractPrompt(),i.showStory("You light the incense bowl. Smoke curls upward, and the silence deepens."),e.interactableFlame&&(e.interactableFlame.isVisible=!0,e.interactableFlame.position.copyFrom(e.interactablePosition).addInPlace(He)))}return{update:o,isCompleted:()=>n}}function qe(){const e=document.createElement("div");return e.style.position="fixed",e.style.right="12px",e.style.top="10px",e.style.padding="4px 8px",e.style.fontSize="12px",e.style.background="rgba(0,0,0,0.4)",e.style.border="1px solid rgba(255,255,255,0.15)",e.style.borderRadius="4px",e.style.color="#d8dde9",e.style.pointerEvents="none",e.textContent="FPS: --",document.body.appendChild(e),{update(t){e.textContent=`FPS: ${Math.round(t)}`}}}async function Xe(){const{canvas:e,engine:t,scene:i}=pe();i.clearColor.set(.56,.62,.72,1);const n=new de("hemiLight",new l(0,1,0),i);n.intensity=.68,n.groundColor=new x(.26,.22,.16);const o=new me("sunLight",new l(-.4,-1,.35),i);o.intensity=1.6,o.position=new l(15,30,-10);const a=await Me(i),r=je(e),s=De(i,a,r),u=Ge(i,e,s),d=We(),c=Ve(a,s,d),y=Ue(i),h=Ke(),b=$e(a,s,d),M=qe();d.bindStart(()=>{e.focus(),u.activatePointerLock(),h.start()}),c.setOnShrineTriggered(()=>{h.playShrineBell()}),i.onBeforeRenderObservable.add(()=>{if(!d.isPlaying())return;const A=i.getEngine().getDeltaTime()/1e3;s.update(A),u.update(A),y.update(A),c.update(A),b.update(A),M.update(i.getEngine().getFps())}),t.runRenderLoop(()=>{i.render()}),window.addEventListener("resize",()=>{t.resize()});let w=!1;const p=()=>{var A,P,z;w||(w=!0,(A=r.dispose)==null||A.call(r),(P=c.dispose)==null||P.call(c),(z=d.dispose)==null||z.call(d))};i.onDisposeObservable.add(p),window.addEventListener("beforeunload",p,{once:!0})}export{Xe as createGame};
