import{E as U,S as ae,a as x,C as z,V as r,M as P,b as C,B as Z,T as re,A as I,c as S,d as g,R as se,e as le,H as ce,D as de}from"./babylon-core-CPh0TrEW.js";function ue(){const t=document.getElementById("renderCanvas");if(!t)throw new Error("Render canvas not found.");const e={preserveDrawingBuffer:!0,stencil:!0};let o;try{o=new U(t,!0,{...e,disableWebGL2Support:!1})}catch{o=new U(t,!0,{...e,disableWebGL2Support:!0})}const n=new ae(o);return{canvas:t,engine:o,scene:n}}const me=new URL("../../Assets/Medieval Village MegaKit[Standard]/glTF/",import.meta.url).href,pe="https://cdn.jsdelivr.net/npm/babylonjs-loaders@7.54.3/babylonjs.loaders.min.js";let _=null;function fe(){return C.IsPluginForExtensionAvailable(".gltf")?Promise.resolve():(_||(_=new Promise((t,e)=>{globalThis.BABYLON=globalThis.BABYLON??Z;const o=document.createElement("script");o.src=pe,o.async=!0,o.onload=()=>t(),o.onerror=()=>e(new Error("Failed to load Babylon glTF loader script.")),document.head.appendChild(o)})),_)}function G(t,e,o,n,l,i=!0){const a=P.CreateBox(e,o,t);return a.position=n,a.material=l,a.isVisible=i,a.checkCollisions=!0,a}function H(t){const e=t.getChildMeshes(!1);if(e.length===0)return null;let o=e[0].getBoundingInfo().boundingBox.minimumWorld.clone(),n=e[0].getBoundingInfo().boundingBox.maximumWorld.clone();for(let a=1;a<e.length;a+=1){const c=e[a].getBoundingInfo().boundingBox;o=r.Minimize(o,c.minimumWorld),n=r.Maximize(n,c.maximumWorld)}const l=n.subtract(o),i=o.add(n).scale(.5);return{min:o,max:n,size:l,center:i}}function he(t,e,o,n=0){t.rotation.set(0,n,0),t.scaling.set(1,1,1),t.position.set(0,0,0),t.computeWorldMatrix(!0);let l=H(t);if(!l)return;const i=new r(Math.max(l.size.x,.001),Math.max(l.size.y,.001),Math.max(l.size.z,.001)),a=Math.min(e.x/i.x,e.y/i.y,e.z/i.z);if(t.scaling.setAll(a),t.computeWorldMatrix(!0),l=H(t),!l)return;const c=new r(l.center.x,l.min.y,l.center.z);t.position.copyFrom(o.subtract(c)),t.computeWorldMatrix(!0)}async function we(t,e){const o=new URL(e,me).href,n=await C.LoadAssetContainerAsync("",o,t,void 0,".gltf");return n.removeAllFromScene(),n}function M(t,e,o,n,l=!1){const i=e.instantiateModelsToScene(c=>`${o}_${c}`,!1),a=new re(`${o}_root`,t);return i.rootNodes.forEach(c=>{c.parent||(c.parent=a)}),he(a,n.size,n.position,n.rotationY??0),l&&a.getChildMeshes(!1).forEach(c=>{c.checkCollisions=!0}),a}async function ge(t){const e={wallWood:"Wall_Plaster_WoodGrid.gltf",wallBrick:"Wall_UnevenBrick_Straight.gltf",roofHouse:"Roof_RoundTiles_8x10.gltf",roofTower:"Roof_Tower_RoundTiles.gltf",stairs:"Stairs_Exterior_Straight.gltf",fence:"Prop_WoodenFence_Single.gltf",wagon:"Prop_Wagon.gltf",crate:"Prop_Crate.gltf",vine:"Prop_Vine2.gltf"},o=await Promise.all(Object.entries(e).map(async([s,d])=>[s,await we(t,d)])),n=Object.fromEntries(o);[{name:"houseWestA",pos:new r(-22,0,-8),size:new r(11,10,10),rot:.08},{name:"houseWestB",pos:new r(-27,0,9),size:new r(13,11,12),rot:-.1},{name:"houseWestC",pos:new r(-12,0,15),size:new r(10,9,9),rot:.04},{name:"houseEastA",pos:new r(18,0,-10),size:new r(12,10,11),rot:-.05},{name:"houseEastB",pos:new r(24,0,7),size:new r(14,11,12),rot:.1},{name:"houseEastC",pos:new r(11,0,17),size:new r(10,9,9),rot:-.04}].forEach(s=>{M(t,n.wallWood,`${s.name}_wallA`,{size:new r(s.size.x,s.size.y*.62,1.4),position:new r(s.pos.x,0,s.pos.z-s.size.z*.45),rotationY:s.rot}),M(t,n.wallBrick,`${s.name}_wallB`,{size:new r(s.size.x*.9,s.size.y*.55,1.2),position:new r(s.pos.x,0,s.pos.z+s.size.z*.44),rotationY:s.rot+Math.PI}),M(t,n.roofHouse,`${s.name}_roof`,{size:new r(s.size.x*1.1,s.size.y*.55,s.size.z*1.05),position:new r(s.pos.x,s.size.y*.46,s.pos.z),rotationY:s.rot}),M(t,n.stairs,`${s.name}_stairs`,{size:new r(4.2,2.8,3.5),position:new r(s.pos.x+1.2,0,s.pos.z-s.size.z*.57),rotationY:s.rot})}),M(t,n.roofTower,"towerCenter",{size:new r(10,15,10),position:new r(0,0,-19),rotationY:0}),[{startX:-30,z:-2.2,count:8,dir:1},{startX:-30,z:2.2,count:8,dir:1},{startX:6,z:-2.2,count:8,dir:1},{startX:6,z:2.2,count:8,dir:1}].forEach((s,d)=>{for(let u=0;u<s.count;u+=1)M(t,n.fence,`fence_${d}_${u}`,{size:new r(3.2,1.8,.7),position:new r(s.startX+s.dir*u*4.1,0,s.z),rotationY:0})}),M(t,n.wagon,"wagonCenter",{size:new r(4.2,2.5,2.8),position:new r(-3.5,0,-1.2),rotationY:.34}),[new r(-6.6,0,-.8),new r(-7.5,0,-1.8),new r(-6.3,0,-2.1)].forEach((s,d)=>{M(t,n.crate,`crate_${d}`,{size:new r(1.1,1.1,1.1),position:s,rotationY:d*.4})}),[new r(-22,.3,-13.2),new r(24,.3,1.5),new r(11,.3,12.2)].forEach((s,d)=>{M(t,n.vine,`vine_${d}`,{size:new r(2.2,4.2,1.5),position:s,rotationY:d*1.1})})}function ye(t,e){const o=P.CreateGround("villageGround",{width:110,height:90},t);return o.material=e,o.isVisible=!1,o.checkCollisions=!0,[{name:"colliderWestA",pos:new r(-22,3.4,-8),size:new r(11,6.8,10)},{name:"colliderWestB",pos:new r(-27,3.9,9),size:new r(13,7.8,12)},{name:"colliderWestC",pos:new r(-12,3.1,15),size:new r(10,6.2,9)},{name:"colliderEastA",pos:new r(18,3.5,-10),size:new r(12,7,11)},{name:"colliderEastB",pos:new r(24,3.9,7),size:new r(14,7.8,12)},{name:"colliderEastC",pos:new r(11,3.1,17),size:new r(10,6.2,9)},{name:"colliderTower",pos:new r(0,7.5,-19),size:new r(9,15,9)}].forEach(i=>{G(t,i.name,{width:i.size.x,height:i.size.y,depth:i.size.z},i.pos,e,!1)}),[{name:"boundWest",pos:new r(-44.5,3,0),size:new r(1,6,84)},{name:"boundEast",pos:new r(44.5,3,0),size:new r(1,6,84)},{name:"boundNorth",pos:new r(0,3,-36.5),size:new r(89,6,1)},{name:"boundSouth",pos:new r(0,3,36.5),size:new r(89,6,1)}].forEach(i=>{G(t,i.name,{width:i.size.x,height:i.size.y,depth:i.size.z},i.pos,e,!1)}),o}async function be(t){t.collisionsEnabled=!0,await fe();const e=new x("hiddenCollisionMaterial",t);e.diffuseColor=new z(.35,.35,.35),e.alpha=0;const o=new x("markerMaterial",t);o.diffuseColor=new z(.84,.67,.33);const n=new r(-6,0,11),l=new r(0,0,-30),i=new r(-3.8,0,-1.2),a=ye(t,e);await ge(t);const c=G(t,"shrineMarker",{width:1.2,depth:1.2,height:2.8},new r(n.x,1.4,n.z),o,!1);c.checkCollisions=!1,c.isPickable=!1;const s=P.CreateSphere("incenseFlame",{diameter:.22,segments:12},t);return s.material=o,s.isVisible=!1,s.checkCollisions=!1,{ground:a,shrinePosition:n,gatePosition:l,interactablePosition:i,interactableFlame:s}}const h={movement:{walkSpeed:5.8,sprintSpeed:8.8,acceleration:24,deceleration:16,airAcceleration:7,jumpSpeed:7.6,gravity:-19,fallGravityMultiplier:1.22,lowJumpGravityMultiplier:1.1,coyoteTime:.08,jumpBufferTime:.12,rotationLerp:11,playerHeight:1.8,spawnPosition:{x:-22,y:1.1,z:1.8}},camera:{distance:3.4,minDistance:1.7,maxDistance:6.5,heightOffset:2.2,mouseSensitivity:.0011,pitchMin:-.7,pitchMax:.95,followLerp:12,lookAheadDistance:.9,lookAheadLerp:6,cameraRotationFollowLerp:5,cameraRotationMoveThreshold:.25,collisionRadius:.34,inertia:.62},effects:{dustMotes:{count:24,radius:20,minHeight:.7,maxHeight:3.4,driftSpeed:.18,bobAmplitude:.14,size:.055}},audio:{ambientVolume:.06,bellVolume:.2},world:{shrineTriggerRadius:2.4,gateTriggerRadius:2.8,interactRange:2.2,checkpointResetCooldown:.35}},F={idle:["idle","breath","stand"],run:["run","walk","jog"],jump:["jump","fall"]};function j(t,e){const o=e.map(n=>n.toLowerCase());return t.find(n=>{var i;const l=((i=n.name)==null?void 0:i.toLowerCase())??"";return o.some(a=>l.includes(a))})??null}function Ae(t){if(!t)return null;const e=t.clone("jumpProxyGroup");return e.speedRatio=.7,e.stop(),e}function K(t=[]){const e=j(t,F.idle),o=j(t,F.run),n=j(t,F.jump)??Ae(o),l={idle:e,run:o,jump:n},i={idle:0,run:0,jump:0};let a="idle",c=!1;Object.values(l).forEach(u=>{!u||!(u instanceof I)||(u.play(!0),u.setWeightForAllAnimatables(0),u.enableBlending=!0,u.blendingSpeed=.08,c=!0)}),c&&l.idle&&(i.idle=1,l.idle.setWeightForAllAnimatables(1));function s(u){c&&(a=u)}function d(u,y){if(!c)return;const p={idle:a==="idle"?1:0,run:a==="run"?1:0,jump:a==="jump"?1:0},w=S.Clamp(u*10,0,1);l.idle&&(i.idle=S.Lerp(i.idle,p.idle,w),l.idle.setWeightForAllAnimatables(i.idle)),l.run&&(i.run=S.Lerp(i.run,p.run,w),l.run.speedRatio=S.Lerp(.9,1.35,S.Clamp(y.normalizedSpeed,0,1)),l.run.setWeightForAllAnimatables(i.run)),l.jump&&(i.jump=S.Lerp(i.jump,p.jump,w),l.jump.setWeightForAllAnimatables(i.jump))}return{isReady:()=>c,setState:s,update:d}}const Le="https://cdn.jsdelivr.net/npm/babylonjs-loaders@7.54.3/babylonjs.loaders.min.js",ve=new URL(""+new URL("Meshy_AI_Monastic_Contemplatio_0223043241_texture-De5dN5g8.glb",import.meta.url).href,import.meta.url).href,Pe=new URL(""+new URL("Meshy_AI_Animation_Walking_withSkin-BPaoHyrO.glb",import.meta.url).href,import.meta.url).href,Me=new URL(""+new URL("Meshy_AI_Animation_Running_withSkin-BvKtgFaU.glb",import.meta.url).href,import.meta.url).href;let D=null,$=!1;function ze(t){if($)return;$=!0;const e=t instanceof Error?t.message:String(t??"unknown reason");console.warn(`Falling back to procedural monk character: ${e}`)}function Ce(){return C.IsPluginForExtensionAvailable(".glb")?Promise.resolve():(D||(D=new Promise((t,e)=>{globalThis.BABYLON=globalThis.BABYLON??Z;const o=document.createElement("script");o.src=Le,o.async=!0,o.onload=()=>t(),o.onerror=()=>e(new Error("Failed to load Babylon UMD loaders script.")),document.head.appendChild(o)})),D)}function Ee(t,e){const o=new x("monkSkinMaterial",e);o.diffuseColor=new z(.86,.73,.58);const n=new x("monkRobeMaterial",e);n.diffuseColor=new z(.71,.42,.2);const l=new x("monkSashMaterial",e);l.diffuseColor=new z(.6,.22,.18);const i=P.CreateBox("monkRoot",{size:.01},e);i.parent=t,i.position=new r(0,-.1,0),i.isVisible=!1;const a=P.CreateCylinder("monkRobe",{height:1.14,diameterTop:.42,diameterBottom:.76,tessellation:18},e);a.material=n,a.parent=i,a.position=new r(0,.32,0);const c=P.CreateSphere("monkHead",{diameter:.42,segments:20},e);c.material=o,c.parent=i,c.position=new r(0,1.05,0);const s=P.CreateTorus("monkSash",{diameter:.5,thickness:.08,tessellation:24},e);s.material=l,s.parent=i,s.position=new r(0,.45,0),s.rotation.x=Math.PI/2;const d=P.CreateCapsule("monkArmLeft",{radius:.08,height:.65,tessellation:12},e);d.material=n,d.parent=i,d.position=new r(-.28,.63,0),d.rotation.z=.22;const u=P.CreateCapsule("monkArmRight",{radius:.08,height:.65,tessellation:12},e);return u.material=n,u.parent=i,u.position=new r(.28,.63,0),u.rotation.z=-.22,{root:i,armLeft:d,armRight:u}}function Se(t,e){const o=new g("idle-bob","position.y",30,g.ANIMATIONTYPE_FLOAT,g.ANIMATIONLOOPMODE_CYCLE);o.setKeys([{frame:0,value:e.root.position.y},{frame:15,value:e.root.position.y+.03},{frame:30,value:e.root.position.y}]);const n=new g("run-bob","position.y",30,g.ANIMATIONTYPE_FLOAT,g.ANIMATIONLOOPMODE_CYCLE);n.setKeys([{frame:0,value:e.root.position.y-.04},{frame:8,value:e.root.position.y+.06},{frame:15,value:e.root.position.y-.04},{frame:22,value:e.root.position.y+.06},{frame:30,value:e.root.position.y-.04}]);const l=new g("run-arm-left","rotation.x",30,g.ANIMATIONTYPE_FLOAT,g.ANIMATIONLOOPMODE_CYCLE);l.setKeys([{frame:0,value:-.6},{frame:15,value:.6},{frame:30,value:-.6}]);const i=new g("run-arm-right","rotation.x",30,g.ANIMATIONTYPE_FLOAT,g.ANIMATIONLOOPMODE_CYCLE);i.setKeys([{frame:0,value:.6},{frame:15,value:-.6},{frame:30,value:.6}]);const a=new g("jump-lift","position.y",30,g.ANIMATIONTYPE_FLOAT,g.ANIMATIONLOOPMODE_CYCLE);a.setKeys([{frame:0,value:e.root.position.y},{frame:12,value:e.root.position.y+.24},{frame:22,value:e.root.position.y+.16},{frame:30,value:e.root.position.y}]);const c=new g("jump-arms","rotation.x",30,g.ANIMATIONTYPE_FLOAT,g.ANIMATIONLOOPMODE_CYCLE);c.setKeys([{frame:0,value:0},{frame:12,value:-.8},{frame:30,value:0}]);const s=new I("idle");s.addTargetedAnimation(o,e.root);const d=new I("run");d.addTargetedAnimation(n,e.root),d.addTargetedAnimation(l,e.armLeft),d.addTargetedAnimation(i,e.armRight);const u=new I("jump");return u.addTargetedAnimation(a,e.root),u.addTargetedAnimation(c,e.armLeft),u.addTargetedAnimation(c.clone(),e.armRight),[s,d,u]}function ke(t){return t.targetedAnimations.every(e=>!!e.target)}function q(t,e){return t.animationGroups.filter(o=>!e.has(o.name))}async function xe(t,e){if(await Ce(),!C.IsPluginForExtensionAvailable(".glb"))throw new Error("GLTF loader script did not register a .glb plugin.");const o=new Set(e.animationGroups.map(l=>l.name));let n=null;try{n=await C.ImportMeshAsync("","",ve,e,void 0,".glb");const l=n.meshes.find(d=>!d.parent)??n.meshes[0];if(!l)throw new Error("Unable to find GLB model root mesh for monk character.");l.parent=t,l.position=new r(0,-.9,0),l.scaling=new r(.9,.9,.9),l.rotationQuaternion=null;const i=new Map;n.meshes.forEach(d=>i.set(d.name,d)),n.transformNodes.forEach(d=>i.set(d.name,d)),n.skeletons.forEach(d=>i.set(d.name,d));const a=d=>d!=null&&d.name?i.get(d.name)??null:null;await C.ImportAnimationsAsync("",Pe,e,!1,void 0,a,void 0,void 0,void 0,".glb"),await C.ImportAnimationsAsync("",Me,e,!1,void 0,a,void 0,void 0,void 0,".glb");const s=q(e,o).filter(ke);if(s.length===0)throw new Error("Imported GLB animations could not be retargeted to the loaded character rig.");return s}catch(l){throw n&&(n.meshes.forEach(a=>{a&&!a.isDisposed()&&a.dispose(!1,!0)}),n.transformNodes.forEach(a=>{a&&!a.isDisposed()&&a.dispose(!1,!0)}),n.skeletons.forEach(a=>{a&&!a.isDisposed()&&a.dispose()})),q(e,o).forEach(a=>a.dispose()),l}}async function Te(t,e){try{const o=await xe(t,e),n=K(o);return{setAnimationState:n.setState,update:(l,i)=>n.update(l,i),loadedFromGlb:!0}}catch(o){ze(o);const n=Ee(t,e),l=Se(e,n),i=K(l);return{setAnimationState:i.setState,update:(a,c)=>i.update(a,c),loadedFromGlb:!1}}}function Re(t){const e=P.CreateCapsule("playerCapsule",{radius:.45,height:1.8,tessellation:12},t);e.isVisible=!1,e.ellipsoid=new r(.45,.9,.45),e.ellipsoidOffset=new r(0,.9,0),e.checkCollisions=!0;const o=h.movement.spawnPosition;return e.position=new r(o.x,o.y,o.z),e}async function Oe(t,e){return Te(t,e)}const k=new r,O=new r,v=new r,X=new r,J=new r,Ie=new r(0,-1,0),Q=new r(0,0,1);function Be(t,e,o){const n=Re(t),l={setAnimationState:()=>{},update:()=>{},loadedFromGlb:!1};Oe(n,t).then(m=>{l.setAnimationState=m.setAnimationState,l.update=m.update,l.loadedFromGlb=m.loadedFromGlb});const i=new r(0,0,0),a=h.movement.playerHeight/2,c=.03,s=.14,d=new se(J,Ie,a+.3);let u=!1,y=0,p=0,w=0;function A(){J.set(n.position.x,n.position.y+.05,n.position.z),d.length=a+.35;const m=t.pickWithRay(d,R=>R!==n&&R.checkCollisions===!0);if(!(m!=null&&m.hit)||!m.pickedPoint){u=!1;return}const b=n.position.y-a,L=m.pickedPoint.y;u=b-L<=s,u&&i.y<=0&&(i.y=0,n.position.y=L+a+c)}function f(m){y+=m;const b=t.activeCamera;if(!b)return;k.copyFrom(b.getForwardRay().direction),k.y=0,k.normalize(),r.CrossToRef(r.UpReadOnly,k,O),O.normalize(),v.setAll(0),o.keys.forward&&v.addInPlace(k),o.keys.back&&v.subtractInPlace(k),o.keys.left&&v.subtractInPlace(O),o.keys.right&&v.addInPlace(O);const L=v.lengthSquared()>0;L&&v.normalize();const E=o.keys.sprint?h.movement.sprintSpeed:h.movement.walkSpeed,R=L?v.x*E:0,ee=L?v.z*E:0;let N=L?h.movement.acceleration:h.movement.deceleration;!u&&L&&(N=h.movement.airAcceleration);const W=Math.min(1,N*m);i.x+=(R-i.x)*W,i.z+=(ee-i.z)*W,A(),u?p=h.movement.coyoteTime:p=Math.max(0,p-m),o.consumeJumpPress()?w=h.movement.jumpBufferTime:w=Math.max(0,w-m),w>0&&(u||p>0)&&(i.y=h.movement.jumpSpeed,u=!1,p=0,w=0);let B=1;i.y<0?B=h.movement.fallGravityMultiplier:i.y>0&&!o.keys.jump&&(B=h.movement.lowJumpGravityMultiplier),i.y+=h.movement.gravity*B*m,X.set(i.x*m,i.y*m,i.z*m),n.moveWithCollisions(X),A();const Y=Math.hypot(i.x,i.z),te=Y/h.movement.sprintSpeed,ne=u?Y>.35?"run":"idle":"jump";if(l.setAnimationState(ne),l.update(m,{elapsedTime:y,normalizedSpeed:te,isGrounded:u}),L){const V=Math.atan2(v.x,v.z),oe=Math.min(1,h.movement.rotationLerp*m),ie=Math.atan2(Math.sin(V-n.rotation.y),Math.cos(V-n.rotation.y));n.rotation.y+=ie*oe,Q.set(Math.sin(n.rotation.y),0,Math.cos(n.rotation.y))}}return{mesh:n,update:f,getPosition:()=>n.position,setPosition:m=>{n.position.copyFrom(m),i.set(0,0,0),u=!1},isGrounded:()=>u,getFacingDirection:()=>Q,getHorizontalSpeed:()=>Math.hypot(i.x,i.z),usesGlbCharacter:()=>l.loadedFromGlb}}function _e(t){const e={forward:!1,back:!1,left:!1,right:!1,sprint:!1,jump:!1};let o=!1;const n=new Map([["KeyW","forward"],["KeyS","back"],["KeyA","left"],["KeyD","right"],["ShiftLeft","sprint"],["ShiftRight","sprint"]]);function l(){e.forward=!1,e.back=!1,e.left=!1,e.right=!1,e.sprint=!1,e.jump=!1,o=!1}function i(s){n.has(s.code)&&(e[n.get(s.code)]=!0),s.code==="Space"&&(s.repeat||(o=!0),e.jump=!0,s.preventDefault())}function a(s){n.has(s.code)&&(e[n.get(s.code)]=!1),s.code==="Space"&&(e.jump=!1,s.preventDefault())}function c(){l()}return window.addEventListener("keydown",i),window.addEventListener("keyup",a),window.addEventListener("blur",c),t.setAttribute("tabindex","0"),{keys:e,consumeJumpPress(){const s=o;return o=!1,s},dispose(){window.removeEventListener("keydown",i),window.removeEventListener("keyup",a),window.removeEventListener("blur",c),l()}}}function Fe(t,e,o){const n=h.camera,l=new r,i=new r,a=new le("playerCamera",Math.PI*1.4,1.1,n.distance,o.getPosition(),t);a.attachControl(e,!0),a.lowerBetaLimit=n.pitchMin+Math.PI/2,a.upperBetaLimit=n.pitchMax+Math.PI/2,a.lowerRadiusLimit=n.minDistance,a.upperRadiusLimit=n.maxDistance,a.wheelDeltaPercentage=.01,a.angularSensibilityX=1/n.mouseSensitivity,a.angularSensibilityY=1/n.mouseSensitivity,a.inertia=n.inertia,a.checkCollisions=!0,a.collisionRadius=new r(n.collisionRadius,n.collisionRadius,n.collisionRadius),t.activeCamera=a;function c(){var d;document.pointerLockElement!==e&&((d=e.requestPointerLock)==null||d.call(e))}function s(d){const u=o.getPosition(),y=o.getFacingDirection();i.set(y.x*n.lookAheadDistance,0,y.z*n.lookAheadDistance);const p=Math.min(1,n.lookAheadLerp*d);if(l.x+=(u.x+i.x-l.x)*p,l.z+=(u.z+i.z-l.z)*p,l.y=u.y+n.heightOffset,o.getHorizontalSpeed()>n.cameraRotationMoveThreshold){const A=u?o.mesh.rotation.y+Math.PI:a.alpha,f=Math.atan2(Math.sin(A-a.alpha),Math.cos(A-a.alpha)),m=Math.min(1,n.cameraRotationFollowLerp*d);a.alpha+=f*m}const w=Math.min(1,n.followLerp*d);a.target=r.Lerp(a.target,l,w)}return{camera:a,activatePointerLock:c,update:s}}function je(){const t=document.getElementById("startScreen"),e=document.getElementById("playButton"),o=document.getElementById("hud"),n=document.getElementById("objectiveText"),l=document.getElementById("storyBox"),i=document.getElementById("interactPrompt");let a=!1,c=!1;function s(f){a||(a=!0,setTimeout(()=>{t.classList.remove("visible"),o.classList.remove("hidden"),f==null||f()},120))}function d(f){e.addEventListener("click",()=>s(f))}function u(f){l.textContent=f,l.classList.remove("hidden")}function y(f){n.textContent=`Objective: ${f}`}function p(f){i.textContent=f,i.classList.remove("hidden")}function w(){i.classList.add("hidden")}function A(f){f.code==="KeyE"&&!f.repeat&&(c=!0)}return window.addEventListener("keydown",A),{bindStart:d,showStory:u,setObjective:y,showInteractPrompt:p,hideInteractPrompt:w,consumeInteractPressed(){const f=c;return c=!1,f},isPlaying:()=>a,dispose(){window.removeEventListener("keydown",A)}}}function De(t,e,o){let n=!1,l=!1,i=e.getPosition().clone(),a=0,c=!1,s=()=>{};function d(p){s=p}function u(p){a>0&&(a=Math.max(0,a-p));const w=e.getPosition();n||r.Distance(w,t.shrinePosition)<=h.world.shrineTriggerRadius&&(n=!0,i=t.shrinePosition.clone(),i.y=w.y,o.showStory("A distant bell rings. Something calls you beyond the monastery."),o.setObjective("Find the sealed gate"),s()),!l&&t.gatePosition&&r.Distance(w,t.gatePosition)<=h.world.gateTriggerRadius&&(l=!0,i=t.gatePosition.clone(),i.y=w.y,o.showStory("Beyond the gate, mountain winds carry distant chanting. The world is waiting."),o.setObjective("Offer incense (E) and continue your journey")),c&&a<=0&&(c=!1,a=h.world.checkpointResetCooldown,e.setPosition(i),o.showStory("You center your breath and return to your last point of calm."),o.showInteractPrompt("Checkpoint restored"),window.setTimeout(()=>{o.hideInteractPrompt()},900))}function y(p){p.code==="KeyR"&&!p.repeat&&(c=!0)}return window.addEventListener("keydown",y),{update:u,setOnShrineTriggered:d,isShrineTriggered:()=>n,isGateTriggered:()=>l,dispose(){window.removeEventListener("keydown",y)}}}function T(t,e){return t+Math.random()*(e-t)}function Ge(t){const e=h.effects.dustMotes,o=[],n=new x("dustMoteMaterial",t);n.diffuseColor=new z(.95,.89,.75),n.emissiveColor=new z(.12,.1,.06),n.alpha=.5,n.disableLighting=!0;for(let i=0;i<e.count;i+=1){const a=P.CreateSphere(`dustMote${i}`,{diameter:e.size,segments:6},t),c=new r(T(-20,e.radius),T(e.minHeight,e.maxHeight),T(-20,e.radius));a.position.copyFrom(c),a.material=n,a.isPickable=!1,a.checkCollisions=!1,o.push({mesh:a,basePos:c,phase:Math.random()*Math.PI*2,driftDir:new r(T(-1,1),0,T(-1,1)).normalize()})}function l(i){const a=performance.now()*.001;for(const c of o)c.mesh.position.x+=c.driftDir.x*e.driftSpeed*i,c.mesh.position.z+=c.driftDir.z*e.driftSpeed*i,c.mesh.position.y=c.basePos.y+Math.sin(a+c.phase)*e.bobAmplitude,Math.abs(c.mesh.position.x)>e.radius&&(c.mesh.position.x=-c.mesh.position.x*.9),Math.abs(c.mesh.position.z)>e.radius&&(c.mesh.position.z=-c.mesh.position.z*.9)}return{update:l}}function Ne(){let t,e,o,n=!1;function l(){t||(t=new window.AudioContext),t.state==="suspended"&&t.resume()}function i(){if(n)return;l(),e=t.createOscillator(),o=t.createGain();const c=t.createBiquadFilter();e.type="triangle",e.frequency.value=110,c.type="lowpass",c.frequency.value=320,c.Q.value=.4,o.gain.value=h.audio.ambientVolume,e.connect(c),c.connect(o),o.connect(t.destination),e.start(),n=!0}function a(){if(!n)return;const c=t.currentTime,s=t.createGain(),d=t.createOscillator(),u=t.createOscillator();d.type="sine",u.type="sine",d.frequency.setValueAtTime(784,c),u.frequency.setValueAtTime(1176,c),s.gain.setValueAtTime(h.audio.bellVolume,c),s.gain.exponentialRampToValueAtTime(.001,c+2.1),d.connect(s),u.connect(s),s.connect(t.destination),d.start(c),u.start(c+.01),d.stop(c+2.2),u.stop(c+2.2)}return{start:i,playShrineBell:a}}const We=new r(0,1,0);function Ye(t,e,o){let n=!1;function l(){if(!t.interactablePosition||n)return;const i=e.getPosition();if(r.Distance(i,t.interactablePosition)>h.world.interactRange){o.hideInteractPrompt();return}o.showInteractPrompt("Press E to light incense"),o.consumeInteractPressed()&&(n=!0,o.hideInteractPrompt(),o.showStory("You light the incense bowl. Smoke curls upward, and the silence deepens."),t.interactableFlame&&(t.interactableFlame.isVisible=!0,t.interactableFlame.position.copyFrom(t.interactablePosition).addInPlace(We)))}return{update:l,isCompleted:()=>n}}function Ve(){const t=document.createElement("div");return t.style.position="fixed",t.style.right="12px",t.style.top="10px",t.style.padding="4px 8px",t.style.fontSize="12px",t.style.background="rgba(0,0,0,0.4)",t.style.border="1px solid rgba(255,255,255,0.15)",t.style.borderRadius="4px",t.style.color="#d8dde9",t.style.pointerEvents="none",t.textContent="FPS: --",document.body.appendChild(t),{update(e){t.textContent=`FPS: ${Math.round(e)}`}}}async function He(){const{canvas:t,engine:e,scene:o}=ue();o.clearColor.set(.56,.62,.72,1);const n=new ce("hemiLight",new r(0,1,0),o);n.intensity=.68,n.groundColor=new z(.26,.22,.16);const l=new de("sunLight",new r(-.4,-1,.35),o);l.intensity=1.6,l.position=new r(15,30,-10);const i=await be(o),a=_e(t),c=Be(o,i,a),s=Fe(o,t,c),d=je(),u=De(i,c,d),y=Ge(o),p=Ne(),w=Ye(i,c,d),A=Ve();d.bindStart(()=>{t.focus(),s.activatePointerLock(),p.start()}),u.setOnShrineTriggered(()=>{p.playShrineBell()}),o.onBeforeRenderObservable.add(()=>{if(!d.isPlaying())return;const b=o.getEngine().getDeltaTime()/1e3;c.update(b),s.update(b),y.update(b),u.update(b),w.update(b),A.update(o.getEngine().getFps())}),e.runRenderLoop(()=>{o.render()}),window.addEventListener("resize",()=>{e.resize()});let f=!1;const m=()=>{var b,L,E;f||(f=!0,(b=a.dispose)==null||b.call(a),(L=u.dispose)==null||L.call(u),(E=d.dispose)==null||E.call(d))};o.onDisposeObservable.add(m),window.addEventListener("beforeunload",m,{once:!0})}export{He as createGame};
