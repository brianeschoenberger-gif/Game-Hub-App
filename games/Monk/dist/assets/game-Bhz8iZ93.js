import{E as U,S as re,a as T,C,V as l,M as L,b as x,B as ee,T as se,A as E,c as S,d as m,R as le,e as ce,H as de,D as ue}from"./babylon-core-CPh0TrEW.js";function me(){const t=document.getElementById("renderCanvas");if(!t)throw new Error("Render canvas not found.");const e={preserveDrawingBuffer:!0,stencil:!0};let o;try{o=new U(t,!0,{...e,disableWebGL2Support:!1})}catch{o=new U(t,!0,{...e,disableWebGL2Support:!0})}const n=new re(o);return{canvas:t,engine:o,scene:n}}const fe=new URL("../../Assets/Medieval Village MegaKit[Standard]/glTF/",import.meta.url).href,pe="https://cdn.jsdelivr.net/npm/babylonjs-loaders@7.54.3/babylonjs.loaders.min.js";let F=null;function he(){return x.IsPluginForExtensionAvailable(".gltf")?Promise.resolve():(F||(F=new Promise((t,e)=>{globalThis.BABYLON=globalThis.BABYLON??ee;const o=document.createElement("script");o.src=pe,o.async=!0,o.onload=()=>t(),o.onerror=()=>e(new Error("Failed to load Babylon glTF loader script.")),document.head.appendChild(o)})),F)}function G(t,e,o,n,s,i=!0){const r=L.CreateBox(e,o,t);return r.position=n,r.material=s,r.isVisible=i,r.checkCollisions=!0,r}function H(t){const e=t.getChildMeshes(!1);if(e.length===0)return null;let o=e[0].getBoundingInfo().boundingBox.minimumWorld.clone(),n=e[0].getBoundingInfo().boundingBox.maximumWorld.clone();for(let r=1;r<e.length;r+=1){const a=e[r].getBoundingInfo().boundingBox;o=l.Minimize(o,a.minimumWorld),n=l.Maximize(n,a.maximumWorld)}const s=n.subtract(o),i=o.add(n).scale(.5);return{min:o,max:n,size:s,center:i}}function ge(t,e,o,n=0){t.rotation.set(0,n,0),t.scaling.set(1,1,1),t.position.set(0,0,0),t.computeWorldMatrix(!0);let s=H(t);if(!s)return;const i=new l(Math.max(s.size.x,.001),Math.max(s.size.y,.001),Math.max(s.size.z,.001)),r=Math.min(e.x/i.x,e.y/i.y,e.z/i.z);if(t.scaling.setAll(r),t.computeWorldMatrix(!0),s=H(t),!s)return;const a=new l(s.center.x,s.min.y,s.center.z);t.position.copyFrom(o.subtract(a)),t.computeWorldMatrix(!0)}async function we(t,e){const o=new URL(e,fe).href,n=await x.LoadAssetContainerAsync("",o,t,void 0,".gltf");return n.removeAllFromScene(),n}function v(t,e,o,n,s=!1){const i=e.instantiateModelsToScene(a=>`${o}_${a}`,!1),r=new se(`${o}_root`,t);return i.rootNodes.forEach(a=>{a.parent||(a.parent=r)}),ge(r,n.size,n.position,n.rotationY??0),s&&r.getChildMeshes(!1).forEach(a=>{a.checkCollisions=!0}),r}async function ye(t){const e={wallWood:"Wall_Plaster_WoodGrid.gltf",wallBrick:"Wall_UnevenBrick_Straight.gltf",roofHouse:"Roof_RoundTiles_8x10.gltf",stairs:"Stairs_Exterior_Straight.gltf",fence:"Prop_WoodenFence_Single.gltf",crate:"Prop_Crate.gltf"},o=await Promise.all(Object.entries(e).map(async([r,a])=>[r,await we(t,a)])),n=Object.fromEntries(o),s=new l(0,0,-8),i=new l(18,12,14);v(t,n.wallWood,"mainBuildingFront",{size:new l(i.x,7,1.6),position:new l(s.x,0,s.z-6.6),rotationY:0}),v(t,n.wallBrick,"mainBuildingBack",{size:new l(i.x,7,1.6),position:new l(s.x,0,s.z+6.6),rotationY:Math.PI}),v(t,n.wallWood,"mainBuildingLeft",{size:new l(i.z,7,1.6),position:new l(s.x-8.6,0,s.z),rotationY:-Math.PI/2}),v(t,n.wallBrick,"mainBuildingRight",{size:new l(i.z,7,1.6),position:new l(s.x+8.6,0,s.z),rotationY:Math.PI/2}),v(t,n.roofHouse,"mainBuildingRoof",{size:new l(20,6.2,16),position:new l(s.x,6,s.z),rotationY:0}),v(t,n.stairs,"mainBuildingStairs",{size:new l(6,3,4),position:new l(s.x,0,s.z+8.8),rotationY:Math.PI});for(let r=-5;r<=5;r+=1)v(t,n.fence,`roadFenceLeft_${r}`,{size:new l(3.2,1.6,.7),position:new l(-7.5,0,r*4),rotationY:Math.PI/2}),v(t,n.fence,`roadFenceRight_${r}`,{size:new l(3.2,1.6,.7),position:new l(7.5,0,r*4),rotationY:-Math.PI/2});v(t,n.crate,"roadCrateA",{size:new l(1.2,1.2,1.2),position:new l(-5.4,0,9.4),rotationY:.2}),v(t,n.crate,"roadCrateB",{size:new l(1.2,1.2,1.2),position:new l(5.1,0,10.5),rotationY:-.35})}function be(t,e,o,n){const s=L.CreateGround("villageGround",{width:96,height:96},t);s.material=e,s.checkCollisions=!0;const i=L.CreateGround("mainRoad",{width:11.5,height:88},t);return i.position.y=.01,i.material=o,i.checkCollisions=!1,G(t,"mainBuildingCollider",{width:17.6,height:7.5,depth:13.4},new l(0,3.75,-8),n,!1),[{name:"boundWest",pos:new l(-48.5,3,0),size:new l(1,6,97)},{name:"boundEast",pos:new l(48.5,3,0),size:new l(1,6,97)},{name:"boundNorth",pos:new l(0,3,-48.5),size:new l(97,6,1)},{name:"boundSouth",pos:new l(0,3,48.5),size:new l(97,6,1)}].forEach(a=>{G(t,a.name,{width:a.size.x,height:a.size.y,depth:a.size.z},a.pos,n,!1)}),s}async function Ae(t){t.collisionsEnabled=!0,await he();const e=new T("terrainMaterial",t);e.diffuseColor=new C(.25,.5,.24);const o=new T("roadMaterial",t);o.diffuseColor=new C(.4,.28,.17);const n=new T("hiddenCollisionMaterial",t);n.diffuseColor=new C(.35,.35,.35),n.alpha=0;const s=new T("markerMaterial",t);s.diffuseColor=new C(.84,.67,.33);const i=new l(-4.2,0,-16.5),r=new l(0,0,42),a=new l(4.8,0,9.8),u=be(t,e,o,n);await ye(t);const c=G(t,"shrineMarker",{width:1.2,depth:1.2,height:2.8},new l(i.x,1.4,i.z),s,!1);c.checkCollisions=!1,c.isPickable=!1;const d=L.CreateSphere("incenseFlame",{diameter:.22,segments:12},t);return d.material=s,d.isVisible=!1,d.checkCollisions=!1,{ground:u,shrinePosition:i,gatePosition:r,interactablePosition:a,interactableFlame:d}}const g={movement:{walkSpeed:5.8,sprintSpeed:8.8,acceleration:24,deceleration:16,airAcceleration:7,jumpSpeed:7.6,gravity:-19,fallGravityMultiplier:1.22,lowJumpGravityMultiplier:1.1,coyoteTime:.08,jumpBufferTime:.12,rotationLerp:11,playerHeight:1.8,spawnPosition:{x:0,y:1.1,z:20}},camera:{distance:2.1,minDistance:1.2,maxDistance:3.4,heightOffset:1.9,mouseSensitivity:.0011,pitchMin:-.7,pitchMax:.95,followLerp:12,lookAheadDistance:.9,lookAheadLerp:6,cameraRotationFollowLerp:5,cameraRotationMoveThreshold:.25,collisionRadius:.34,inertia:.62},effects:{dustMotes:{count:24,radius:20,minHeight:.7,maxHeight:3.4,driftSpeed:.18,bobAmplitude:.14,size:.055}},audio:{ambientVolume:.06,bellVolume:.2},world:{shrineTriggerRadius:2.4,gateTriggerRadius:2.8,interactRange:2.2,checkpointResetCooldown:.35}},N={idle:["idle","breath","stand"],run:["run","walk","jog"],jump:["jump","fall"]};function _(t,e){const o=e.map(n=>n.toLowerCase());return t.find(n=>{var i;const s=((i=n.name)==null?void 0:i.toLowerCase())??"";return o.some(r=>s.includes(r))})??null}function Me(t){if(!t)return null;const e=t.clone("jumpProxyGroup");return e.speedRatio=.7,e.stop(),e}function $(t=[]){const e=_(t,N.idle),o=_(t,N.run),n=_(t,N.jump)??Me(o),s={idle:e,run:o,jump:n},i={idle:0,run:0,jump:0};let r="idle",a=!1;Object.values(s).forEach(d=>{!d||!(d instanceof E)||(d.play(!0),d.setWeightForAllAnimatables(0),d.enableBlending=!0,d.blendingSpeed=.08,a=!0)}),a&&s.idle&&(i.idle=1,s.idle.setWeightForAllAnimatables(1));function u(d){a&&(r=d)}function c(d,w){if(!a)return;const p={idle:r==="idle"?1:0,run:r==="run"?1:0,jump:r==="jump"?1:0},y=S.Clamp(d*10,0,1);s.idle&&(i.idle=S.Lerp(i.idle,p.idle,y),s.idle.setWeightForAllAnimatables(i.idle)),s.run&&(i.run=S.Lerp(i.run,p.run,y),s.run.speedRatio=S.Lerp(.9,1.35,S.Clamp(w.normalizedSpeed,0,1)),s.run.setWeightForAllAnimatables(i.run)),s.jump&&(i.jump=S.Lerp(i.jump,p.jump,y),s.jump.setWeightForAllAnimatables(i.jump))}return{isReady:()=>a,setState:u,update:c}}const Le="https://cdn.jsdelivr.net/npm/babylonjs-loaders@7.54.3/babylonjs.loaders.min.js",Pe=new URL(""+new URL("Meshy_AI_Monastic_Contemplatio_0223043241_texture-De5dN5g8.glb",import.meta.url).href,import.meta.url).href,ve=new URL(""+new URL("Meshy_AI_Animation_Walking_withSkin-BPaoHyrO.glb",import.meta.url).href,import.meta.url).href,Ce=new URL(""+new URL("Meshy_AI_Animation_Running_withSkin-BvKtgFaU.glb",import.meta.url).href,import.meta.url).href;let j=null,q=!1;function Te(t){if(q)return;q=!0;const e=t instanceof Error?t.message:String(t??"unknown reason");console.warn(`Falling back to procedural monk character: ${e}`)}function xe(){return x.IsPluginForExtensionAvailable(".glb")?Promise.resolve():(j||(j=new Promise((t,e)=>{globalThis.BABYLON=globalThis.BABYLON??ee;const o=document.createElement("script");o.src=Le,o.async=!0,o.onload=()=>t(),o.onerror=()=>e(new Error("Failed to load Babylon UMD loaders script.")),document.head.appendChild(o)})),j)}function Ee(t,e){const o=new T("monkSkinMaterial",e);o.diffuseColor=new C(.86,.73,.58);const n=new T("monkRobeMaterial",e);n.diffuseColor=new C(.71,.42,.2);const s=new T("monkSashMaterial",e);s.diffuseColor=new C(.6,.22,.18);const i=L.CreateBox("monkRoot",{size:.01},e);i.parent=t,i.position=new l(0,-.1,0),i.isVisible=!1;const r=L.CreateCylinder("monkRobe",{height:1.14,diameterTop:.42,diameterBottom:.76,tessellation:18},e);r.material=n,r.parent=i,r.position=new l(0,.32,0);const a=L.CreateSphere("monkHead",{diameter:.42,segments:20},e);a.material=o,a.parent=i,a.position=new l(0,1.05,0);const u=L.CreateTorus("monkSash",{diameter:.5,thickness:.08,tessellation:24},e);u.material=s,u.parent=i,u.position=new l(0,.45,0),u.rotation.x=Math.PI/2;const c=L.CreateCapsule("monkArmLeft",{radius:.08,height:.65,tessellation:12},e);c.material=n,c.parent=i,c.position=new l(-.28,.63,0),c.rotation.z=.22;const d=L.CreateCapsule("monkArmRight",{radius:.08,height:.65,tessellation:12},e);return d.material=n,d.parent=i,d.position=new l(.28,.63,0),d.rotation.z=-.22,{root:i,armLeft:c,armRight:d}}function Oe(t,e){const o=new m("idle-bob","position.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);o.setKeys([{frame:0,value:e.root.position.y},{frame:15,value:e.root.position.y+.03},{frame:30,value:e.root.position.y}]);const n=new m("run-bob","position.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);n.setKeys([{frame:0,value:e.root.position.y-.04},{frame:8,value:e.root.position.y+.06},{frame:15,value:e.root.position.y-.04},{frame:22,value:e.root.position.y+.06},{frame:30,value:e.root.position.y-.04}]);const s=new m("run-arm-left","rotation.x",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);s.setKeys([{frame:0,value:-.6},{frame:15,value:.6},{frame:30,value:-.6}]);const i=new m("run-arm-right","rotation.x",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);i.setKeys([{frame:0,value:.6},{frame:15,value:-.6},{frame:30,value:.6}]);const r=new m("jump-lift","position.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);r.setKeys([{frame:0,value:e.root.position.y},{frame:12,value:e.root.position.y+.24},{frame:22,value:e.root.position.y+.16},{frame:30,value:e.root.position.y}]);const a=new m("jump-arms","rotation.x",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);a.setKeys([{frame:0,value:0},{frame:12,value:-.8},{frame:30,value:0}]);const u=new E("idle");u.addTargetedAnimation(o,e.root);const c=new E("run");c.addTargetedAnimation(n,e.root),c.addTargetedAnimation(s,e.armLeft),c.addTargetedAnimation(i,e.armRight);const d=new E("jump");return d.addTargetedAnimation(r,e.root),d.addTargetedAnimation(a,e.armLeft),d.addTargetedAnimation(a.clone(),e.armRight),[u,c,d]}function J(t,e){const o=e.position.y,n=new m("idle-bob-proxy","position.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);n.setKeys([{frame:0,value:o},{frame:15,value:o+.025},{frame:30,value:o}]);const s=new m("run-bob-proxy","position.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);s.setKeys([{frame:0,value:o-.03},{frame:8,value:o+.045},{frame:15,value:o-.03},{frame:22,value:o+.045},{frame:30,value:o-.03}]);const i=new m("run-sway-proxy","rotation.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);i.setKeys([{frame:0,value:-.03},{frame:15,value:.03},{frame:30,value:-.03}]);const r=new m("jump-lift-proxy","position.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);r.setKeys([{frame:0,value:o},{frame:12,value:o+.16},{frame:22,value:o+.08},{frame:30,value:o}]);const a=new E("idle");a.addTargetedAnimation(n,e);const u=new E("run");u.addTargetedAnimation(s,e),u.addTargetedAnimation(i,e);const c=new E("jump");return c.addTargetedAnimation(r,e),[a,u,c]}function Se(t){return t.targetedAnimations.every(e=>!!e.target)}function D(t,e){return t.animationGroups.filter(o=>!e.has(o.name))}function Ie(t,e,o=.02){const n=e.getChildMeshes(!1);if(n.length===0)return;e.computeWorldMatrix(!0);let s=Number.POSITIVE_INFINITY;n.forEach(r=>{const a=r.getBoundingInfo().boundingBox.minimumWorld.y;a<s&&(s=a)});const i=t.position.y-.9+o;e.position.y+=i-s,e.computeWorldMatrix(!0)}async function ke(t,e){var i,r;if(await xe(),!x.IsPluginForExtensionAvailable(".glb"))throw new Error("GLTF loader script did not register a .glb plugin.");const o=new Set(e.animationGroups.map(a=>a.name));let n=null,s=null;try{n=await x.ImportMeshAsync("","",Pe,e,void 0,".glb");const a=n.meshes.find(u=>!u.parent)??n.meshes[0];if(!a)throw new Error("Unable to find GLB model root mesh for monk character.");a.parent=t,a.position=new l(0,0,0),a.scaling=new l(.9,.9,.9),a.rotationQuaternion=null,Ie(t,a),s=new Map,n.meshes.forEach(u=>s.set(u.name,u)),n.transformNodes.forEach(u=>s.set(u.name,u)),n.skeletons.forEach(u=>s.set(u.name,u))}catch(a){throw n&&(n.meshes.forEach(c=>{c&&!c.isDisposed()&&c.dispose(!1,!0)}),n.transformNodes.forEach(c=>{c&&!c.isDisposed()&&c.dispose(!1,!0)}),n.skeletons.forEach(c=>{c&&!c.isDisposed()&&c.dispose()})),D(e,o).forEach(c=>c.dispose()),a}try{const a=w=>w!=null&&w.name?s.get(w.name)??null:null;await x.ImportAnimationsAsync("",ve,e,!1,void 0,a,void 0,void 0,void 0,".glb"),await x.ImportAnimationsAsync("",Ce,e,!1,void 0,a,void 0,void 0,void 0,".glb");const c=D(e,o).filter(Se);if(c.length>0)return c;const d=n.meshes.find(w=>w.parent===t)??n.meshes[0];return d?J(e,d):[]}catch(a){D(e,o).forEach(d=>d.dispose()),console.warn(`Monk GLB loaded but animation import failed. Using static model. ${a instanceof Error?a.message:String(a)}`);const c=((i=n==null?void 0:n.meshes)==null?void 0:i.find(d=>d.parent===t))??((r=n==null?void 0:n.meshes)==null?void 0:r[0]);return c?J(e,c):[]}}async function ze(t,e){try{const o=await ke(t,e),n=$(o);return{setAnimationState:n.setState,update:(s,i)=>n.update(s,i),loadedFromGlb:!0}}catch(o){Te(o);const n=Ee(t,e),s=Oe(e,n),i=$(s);return{setAnimationState:i.setState,update:(r,a)=>i.update(r,a),loadedFromGlb:!1}}}function Be(t){const e=L.CreateCapsule("playerCapsule",{radius:.45,height:1.8,tessellation:12},t);e.isVisible=!1,e.ellipsoid=new l(.45,.9,.45),e.ellipsoidOffset=new l(0,.9,0),e.checkCollisions=!0;const o=g.movement.spawnPosition;return e.position=new l(o.x,o.y,o.z),e}async function Re(t,e){return ze(t,e)}const I=new l,B=new l,P=new l,Q=new l,X=new l,Fe=new l(0,-1,0),Z=new l(0,0,1);function Ne(t,e,o){const n=Be(t),s={setAnimationState:()=>{},update:()=>{},loadedFromGlb:!1};Re(n,t).then(f=>{s.setAnimationState=f.setAnimationState,s.update=f.update,s.loadedFromGlb=f.loadedFromGlb});const i=new l(0,0,0),r=g.movement.playerHeight/2,a=.03,u=.14,c=new le(X,Fe,r+.3);let d=!1,w=0,p=0,y=0;function A(){X.set(n.position.x,n.position.y+.05,n.position.z),c.length=r+.35;const f=t.pickWithRay(c,z=>z!==n&&z.checkCollisions===!0);if(!(f!=null&&f.hit)||!f.pickedPoint){d=!1;return}const b=n.position.y-r,M=f.pickedPoint.y;d=b-M<=u,d&&i.y<=0&&(i.y=0,n.position.y=M+r+a)}function h(f){w+=f;const b=t.activeCamera;if(!b)return;I.copyFrom(b.getForwardRay().direction),I.y=0,I.normalize(),l.CrossToRef(l.UpReadOnly,I,B),B.normalize(),P.setAll(0),o.keys.forward&&P.addInPlace(I),o.keys.back&&P.subtractInPlace(I),o.keys.left&&P.subtractInPlace(B),o.keys.right&&P.addInPlace(B);const M=P.lengthSquared()>0;M&&P.normalize();const O=o.keys.sprint?g.movement.sprintSpeed:g.movement.walkSpeed,z=M?P.x*O:0,te=M?P.z*O:0;let Y=M?g.movement.acceleration:g.movement.deceleration;!d&&M&&(Y=g.movement.airAcceleration);const W=Math.min(1,Y*f);i.x+=(z-i.x)*W,i.z+=(te-i.z)*W,A(),d?p=g.movement.coyoteTime:p=Math.max(0,p-f),o.consumeJumpPress()?y=g.movement.jumpBufferTime:y=Math.max(0,y-f),y>0&&(d||p>0)&&(i.y=g.movement.jumpSpeed,d=!1,p=0,y=0);let R=1;i.y<0?R=g.movement.fallGravityMultiplier:i.y>0&&!o.keys.jump&&(R=g.movement.lowJumpGravityMultiplier),i.y+=g.movement.gravity*R*f,Q.set(i.x*f,i.y*f,i.z*f),n.moveWithCollisions(Q),A();const V=Math.hypot(i.x,i.z),ne=V/g.movement.sprintSpeed,oe=d?V>.35?"run":"idle":"jump";if(s.setAnimationState(oe),s.update(f,{elapsedTime:w,normalizedSpeed:ne,isGrounded:d}),M){const K=Math.atan2(P.x,P.z),ie=Math.min(1,g.movement.rotationLerp*f),ae=Math.atan2(Math.sin(K-n.rotation.y),Math.cos(K-n.rotation.y));n.rotation.y+=ae*ie,Z.set(Math.sin(n.rotation.y),0,Math.cos(n.rotation.y))}}return{mesh:n,update:h,getPosition:()=>n.position,setPosition:f=>{n.position.copyFrom(f),i.set(0,0,0),d=!1},isGrounded:()=>d,getFacingDirection:()=>Z,getHorizontalSpeed:()=>Math.hypot(i.x,i.z),usesGlbCharacter:()=>s.loadedFromGlb}}function _e(t){const e={forward:!1,back:!1,left:!1,right:!1,sprint:!1,jump:!1};let o=!1;const n=new Map([["KeyW","forward"],["KeyS","back"],["KeyA","left"],["KeyD","right"],["ShiftLeft","sprint"],["ShiftRight","sprint"]]);function s(){e.forward=!1,e.back=!1,e.left=!1,e.right=!1,e.sprint=!1,e.jump=!1,o=!1}function i(u){n.has(u.code)&&(e[n.get(u.code)]=!0),u.code==="Space"&&(u.repeat||(o=!0),e.jump=!0,u.preventDefault())}function r(u){n.has(u.code)&&(e[n.get(u.code)]=!1),u.code==="Space"&&(e.jump=!1,u.preventDefault())}function a(){s()}return window.addEventListener("keydown",i),window.addEventListener("keyup",r),window.addEventListener("blur",a),t.setAttribute("tabindex","0"),{keys:e,consumeJumpPress(){const u=o;return o=!1,u},dispose(){window.removeEventListener("keydown",i),window.removeEventListener("keyup",r),window.removeEventListener("blur",a),s()}}}function je(t,e,o){const n=g.camera,s=new l,i=new l,r=new ce("playerCamera",Math.PI*1.4,1.1,n.distance,o.getPosition(),t);r.attachControl(e,!0),r.lowerBetaLimit=n.pitchMin+Math.PI/2,r.upperBetaLimit=n.pitchMax+Math.PI/2,r.lowerRadiusLimit=n.minDistance,r.upperRadiusLimit=n.maxDistance,r.wheelDeltaPercentage=.01,r.angularSensibilityX=1/n.mouseSensitivity,r.angularSensibilityY=1/n.mouseSensitivity,r.inertia=n.inertia,r.checkCollisions=!0,r.collisionRadius=new l(n.collisionRadius,n.collisionRadius,n.collisionRadius),t.activeCamera=r;function a(){var c;document.pointerLockElement!==e&&((c=e.requestPointerLock)==null||c.call(e))}function u(c){const d=o.getPosition(),w=o.getFacingDirection();i.set(w.x*n.lookAheadDistance,0,w.z*n.lookAheadDistance);const p=Math.min(1,n.lookAheadLerp*c);if(s.x+=(d.x+i.x-s.x)*p,s.z+=(d.z+i.z-s.z)*p,s.y=d.y+n.heightOffset,o.getHorizontalSpeed()>n.cameraRotationMoveThreshold){const A=d?o.mesh.rotation.y+Math.PI:r.alpha,h=Math.atan2(Math.sin(A-r.alpha),Math.cos(A-r.alpha)),f=Math.min(1,n.cameraRotationFollowLerp*c);r.alpha+=h*f}const y=Math.min(1,n.followLerp*c);r.target=l.Lerp(r.target,s,y)}return{camera:r,activatePointerLock:a,update:u}}function De(){const t=document.getElementById("startScreen"),e=document.getElementById("playButton"),o=document.getElementById("hud"),n=document.getElementById("objectiveText"),s=document.getElementById("storyBox"),i=document.getElementById("interactPrompt");let r=!1,a=!1;function u(h){r||(r=!0,setTimeout(()=>{t.classList.remove("visible"),o.classList.remove("hidden"),h==null||h()},120))}function c(h){e.addEventListener("click",()=>u(h))}function d(h){s.textContent=h,s.classList.remove("hidden")}function w(h){n.textContent=`Objective: ${h}`}function p(h){i.textContent=h,i.classList.remove("hidden")}function y(){i.classList.add("hidden")}function A(h){h.code==="KeyE"&&!h.repeat&&(a=!0)}return window.addEventListener("keydown",A),{bindStart:c,showStory:d,setObjective:w,showInteractPrompt:p,hideInteractPrompt:y,consumeInteractPressed(){const h=a;return a=!1,h},isPlaying:()=>r,dispose(){window.removeEventListener("keydown",A)}}}function Ge(t,e,o){let n=!1,s=!1,i=e.getPosition().clone(),r=0,a=!1,u=()=>{};function c(p){u=p}function d(p){r>0&&(r=Math.max(0,r-p));const y=e.getPosition();n||l.Distance(y,t.shrinePosition)<=g.world.shrineTriggerRadius&&(n=!0,i=t.shrinePosition.clone(),i.y=y.y,o.showStory("A distant bell rings. Something calls you beyond the monastery."),o.setObjective("Find the sealed gate"),u()),!s&&t.gatePosition&&l.Distance(y,t.gatePosition)<=g.world.gateTriggerRadius&&(s=!0,i=t.gatePosition.clone(),i.y=y.y,o.showStory("Beyond the gate, mountain winds carry distant chanting. The world is waiting."),o.setObjective("Offer incense (E) and continue your journey")),a&&r<=0&&(a=!1,r=g.world.checkpointResetCooldown,e.setPosition(i),o.showStory("You center your breath and return to your last point of calm."),o.showInteractPrompt("Checkpoint restored"),window.setTimeout(()=>{o.hideInteractPrompt()},900))}function w(p){p.code==="KeyR"&&!p.repeat&&(a=!0)}return window.addEventListener("keydown",w),{update:d,setOnShrineTriggered:c,isShrineTriggered:()=>n,isGateTriggered:()=>s,dispose(){window.removeEventListener("keydown",w)}}}function k(t,e){return t+Math.random()*(e-t)}function Ye(t){const e=g.effects.dustMotes,o=[],n=new T("dustMoteMaterial",t);n.diffuseColor=new C(.95,.89,.75),n.emissiveColor=new C(.12,.1,.06),n.alpha=.5,n.disableLighting=!0;for(let i=0;i<e.count;i+=1){const r=L.CreateSphere(`dustMote${i}`,{diameter:e.size,segments:6},t),a=new l(k(-20,e.radius),k(e.minHeight,e.maxHeight),k(-20,e.radius));r.position.copyFrom(a),r.material=n,r.isPickable=!1,r.checkCollisions=!1,o.push({mesh:r,basePos:a,phase:Math.random()*Math.PI*2,driftDir:new l(k(-1,1),0,k(-1,1)).normalize()})}function s(i){const r=performance.now()*.001;for(const a of o)a.mesh.position.x+=a.driftDir.x*e.driftSpeed*i,a.mesh.position.z+=a.driftDir.z*e.driftSpeed*i,a.mesh.position.y=a.basePos.y+Math.sin(r+a.phase)*e.bobAmplitude,Math.abs(a.mesh.position.x)>e.radius&&(a.mesh.position.x=-a.mesh.position.x*.9),Math.abs(a.mesh.position.z)>e.radius&&(a.mesh.position.z=-a.mesh.position.z*.9)}return{update:s}}function We(){let t,e,o,n=!1;function s(){t||(t=new window.AudioContext),t.state==="suspended"&&t.resume()}function i(){if(n)return;s(),e=t.createOscillator(),o=t.createGain();const a=t.createBiquadFilter();e.type="triangle",e.frequency.value=110,a.type="lowpass",a.frequency.value=320,a.Q.value=.4,o.gain.value=g.audio.ambientVolume,e.connect(a),a.connect(o),o.connect(t.destination),e.start(),n=!0}function r(){if(!n)return;const a=t.currentTime,u=t.createGain(),c=t.createOscillator(),d=t.createOscillator();c.type="sine",d.type="sine",c.frequency.setValueAtTime(784,a),d.frequency.setValueAtTime(1176,a),u.gain.setValueAtTime(g.audio.bellVolume,a),u.gain.exponentialRampToValueAtTime(.001,a+2.1),c.connect(u),d.connect(u),u.connect(t.destination),c.start(a),d.start(a+.01),c.stop(a+2.2),d.stop(a+2.2)}return{start:i,playShrineBell:r}}const Ve=new l(0,1,0);function Ke(t,e,o){let n=!1;function s(){if(!t.interactablePosition||n)return;const i=e.getPosition();if(l.Distance(i,t.interactablePosition)>g.world.interactRange){o.hideInteractPrompt();return}o.showInteractPrompt("Press E to light incense"),o.consumeInteractPressed()&&(n=!0,o.hideInteractPrompt(),o.showStory("You light the incense bowl. Smoke curls upward, and the silence deepens."),t.interactableFlame&&(t.interactableFlame.isVisible=!0,t.interactableFlame.position.copyFrom(t.interactablePosition).addInPlace(Ve)))}return{update:s,isCompleted:()=>n}}function Ue(){const t=document.createElement("div");return t.style.position="fixed",t.style.right="12px",t.style.top="10px",t.style.padding="4px 8px",t.style.fontSize="12px",t.style.background="rgba(0,0,0,0.4)",t.style.border="1px solid rgba(255,255,255,0.15)",t.style.borderRadius="4px",t.style.color="#d8dde9",t.style.pointerEvents="none",t.textContent="FPS: --",document.body.appendChild(t),{update(e){t.textContent=`FPS: ${Math.round(e)}`}}}async function $e(){const{canvas:t,engine:e,scene:o}=me();o.clearColor.set(.56,.62,.72,1);const n=new de("hemiLight",new l(0,1,0),o);n.intensity=.68,n.groundColor=new C(.26,.22,.16);const s=new ue("sunLight",new l(-.4,-1,.35),o);s.intensity=1.6,s.position=new l(15,30,-10);const i=await Ae(o),r=_e(t),a=Ne(o,i,r),u=je(o,t,a),c=De(),d=Ge(i,a,c),w=Ye(o),p=We(),y=Ke(i,a,c),A=Ue();c.bindStart(()=>{t.focus(),u.activatePointerLock(),p.start()}),d.setOnShrineTriggered(()=>{p.playShrineBell()}),o.onBeforeRenderObservable.add(()=>{if(!c.isPlaying())return;const b=o.getEngine().getDeltaTime()/1e3;a.update(b),u.update(b),w.update(b),d.update(b),y.update(b),A.update(o.getEngine().getFps())}),e.runRenderLoop(()=>{o.render()}),window.addEventListener("resize",()=>{e.resize()});let h=!1;const f=()=>{var b,M,O;h||(h=!0,(b=r.dispose)==null||b.call(r),(M=d.dispose)==null||M.call(d),(O=c.dispose)==null||O.call(c))};o.onDisposeObservable.add(f),window.addEventListener("beforeunload",f,{once:!0})}export{$e as createGame};
