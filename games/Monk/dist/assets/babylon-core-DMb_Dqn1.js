const LS="modulepreload",NS=function(a,e){return new URL(a,e).href},Eh={},X=function(e,t,i){let r=Promise.resolve();if(t&&t.length>0){const n=document.getElementsByTagName("link"),o=document.querySelector("meta[property=csp-nonce]"),l=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));r=Promise.allSettled(t.map(c=>{if(c=NS(c,i),c in Eh)return;Eh[c]=!0;const h=c.endsWith(".css"),f=h?'[rel="stylesheet"]':"";if(!!i)for(let _=n.length-1;_>=0;_--){const p=n[_];if(p.href===c&&(!h||p.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${c}"]${f}`))return;const d=document.createElement("link");if(d.rel=h?"stylesheet":LS,h||(d.as="script"),d.crossOrigin="",d.href=c,l&&d.setAttribute("nonce",l),document.head.appendChild(d),h)return new Promise((_,p)=>{d.addEventListener("load",_),d.addEventListener("error",()=>p(new Error(`Unable to preload CSS for ${c}`)))})}))}function s(n){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=n,window.dispatchEvent(o),!o.defaultPrevented)throw n}return r.then(n=>{for(const o of n||[])o.status==="rejected"&&s(o.reason);return e().catch(s)})};class B{static _CheckLimit(e,t){let i=B._LogLimitOutputs[e];return i?i.current++:(i={limit:t,current:1},B._LogLimitOutputs[e]=i),i.current<=i.limit}static _GenerateLimitMessage(e,t=1){const i=B._LogLimitOutputs[e];if(!i||!B.MessageLimitReached)return;const r=this._Levels[t];i.current===i.limit&&B[r.name](B.MessageLimitReached.replace(/%LIMIT%/g,""+i.limit).replace(/%TYPE%/g,r.name??""))}static _AddLogEntry(e){B._LogCache=e+B._LogCache,B.OnNewCacheEntry&&B.OnNewCacheEntry(e)}static _FormatMessage(e){const t=r=>r<10?"0"+r:""+r,i=new Date;return"["+t(i.getHours())+":"+t(i.getMinutes())+":"+t(i.getSeconds())+"]: "+e}static _LogDisabled(e,t){}static _LogEnabled(e=1,t,i){const r=Array.isArray(t)?t[0]:t;if(i!==void 0&&!B._CheckLimit(r,i))return;const s=B._FormatMessage(r),n=this._Levels[e],o=Array.isArray(t)?t.slice(1):[];n.logFunc&&n.logFunc("BJS - "+s,...o);const l=`<div style='color:${n.color}'>${s}</div><br>`;B._AddLogEntry(l),B._GenerateLimitMessage(r,e)}static get LogCache(){return B._LogCache}static ClearLogCache(){B._LogCache="",B._LogLimitOutputs={},B.errorsCount=0}static set LogLevels(e){B.Log=B._LogDisabled,B.Warn=B._LogDisabled,B.Error=B._LogDisabled,[B.MessageLogLevel,B.WarningLogLevel,B.ErrorLogLevel].forEach(t=>{if((e&t)===t){const i=this._Levels[t];B[i.name]=B._LogEnabled.bind(B,t)}})}}B.NoneLogLevel=0;B.MessageLogLevel=1;B.WarningLogLevel=2;B.ErrorLogLevel=4;B.AllLogLevel=7;B.MessageLimitReached="Too many %TYPE%s (%LIMIT%), no more %TYPE%s will be reported for this message.";B._LogCache="";B._LogLimitOutputs={};B._Levels=[{},{color:"white",logFunc:console.log,name:"Log"},{color:"orange",logFunc:console.warn,name:"Warn"},{},{color:"red",logFunc:console.error,name:"Error"}];B.errorsCount=0;B.Log=B._LogEnabled.bind(B,B.MessageLogLevel);B.Warn=B._LogEnabled.bind(B,B.WarningLogLevel);B.Error=B._LogEnabled.bind(B,B.ErrorLogLevel);const FS=typeof WeakRef<"u";class wS{constructor(e,t=!1,i,r){this.initialize(e,t,i,r)}initialize(e,t=!1,i,r){return this.mask=e,this.skipNextObservers=t,this.target=i,this.currentTarget=r,this}}class BS{constructor(e,t,i=null){this.callback=e,this.mask=t,this.scope=i,this._willBeUnregistered=!1,this.unregisterOnNextCall=!1,this._remove=null}remove(){this._remove&&this._remove()}}class U{static FromPromise(e,t){const i=new U;return e.then(r=>{i.notifyObservers(r)}).catch(r=>{if(t)t.notifyObservers(r);else throw r}),i}get observers(){return this._observers}constructor(e,t=!1){this.notifyIfTriggered=t,this._observers=new Array,this._numObserversMarkedAsDeleted=0,this._hasNotified=!1,this._eventState=new wS(0),e&&(this._onObserverAdded=e)}add(e,t=-1,i=!1,r=null,s=!1){if(!e)return null;const n=new BS(e,t,r);n.unregisterOnNextCall=s,i?this._observers.unshift(n):this._observers.push(n),this._onObserverAdded&&this._onObserverAdded(n),this._hasNotified&&this.notifyIfTriggered&&this._lastNotifiedValue!==void 0&&this.notifyObserver(n,this._lastNotifiedValue);const o=FS?new WeakRef(this):{deref:()=>this};return n._remove=()=>{const l=o.deref();l&&l._remove(n)},n}addOnce(e){return this.add(e,void 0,void 0,void 0,!0)}remove(e){return e?(e._remove=null,this._observers.indexOf(e)!==-1?(this._deferUnregister(e),!0):!1):!1}removeCallback(e,t){for(let i=0;i<this._observers.length;i++){const r=this._observers[i];if(!r._willBeUnregistered&&r.callback===e&&(!t||t===r.scope))return this._deferUnregister(r),!0}return!1}_deferUnregister(e){e._willBeUnregistered||(this._numObserversMarkedAsDeleted++,e.unregisterOnNextCall=!1,e._willBeUnregistered=!0,setTimeout(()=>{this._remove(e)},0))}_remove(e,t=!0){if(!e)return!1;const i=this._observers.indexOf(e);return i!==-1?(t&&this._numObserversMarkedAsDeleted--,this._observers.splice(i,1),!0):!1}makeObserverTopPriority(e){this._remove(e,!1),this._observers.unshift(e)}makeObserverBottomPriority(e){this._remove(e,!1),this._observers.push(e)}notifyObservers(e,t=-1,i,r,s){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=e),!this._observers.length)return!0;const n=this._eventState;n.mask=t,n.target=i,n.currentTarget=r,n.skipNextObservers=!1,n.lastReturnValue=e,n.userInfo=s;for(const o of this._observers)if(!o._willBeUnregistered&&(o.mask&t&&(o.unregisterOnNextCall&&this._deferUnregister(o),o.scope?n.lastReturnValue=o.callback.apply(o.scope,[e,n]):n.lastReturnValue=o.callback(e,n)),n.skipNextObservers))return!1;return!0}notifyObserver(e,t,i=-1){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=t),e._willBeUnregistered)return;const r=this._eventState;r.mask=i,r.skipNextObservers=!1,e.unregisterOnNextCall&&this._deferUnregister(e),e.callback(t,r)}hasObservers(){return this._observers.length-this._numObserversMarkedAsDeleted>0}clear(){for(;this._observers.length;){const e=this._observers.pop();e&&(e._remove=null)}this._onObserverAdded=null,this._numObserversMarkedAsDeleted=0,this.cleanLastNotifiedState()}cleanLastNotifiedState(){this._hasNotified=!1,this._lastNotifiedValue=void 0}clone(){const e=new U;return e._observers=this._observers.slice(0),e}hasSpecificMask(e=-1){for(const t of this._observers)if(t.mask&e||t.mask===e)return!0;return!1}}function Ht(){return typeof window<"u"}function ks(){return typeof navigator<"u"}function pn(){return typeof document<"u"}function sm(a){let e="",t=a.firstChild;for(;t;)t.nodeType===3&&(e+=t.textContent),t=t.nextSibling;return e}const vh=(a,e,t)=>!a||a.getClassName&&a.getClassName()==="Mesh"?null:a.getClassName&&(a.getClassName()==="SubMesh"||a.getClassName()==="PhysicsBody")?a.clone(e):a.clone?a.clone():Array.isArray(a)?a.slice():t&&typeof a=="object"?{...a}:null;function US(a){const e=[];do Object.getOwnPropertyNames(a).forEach(function(t){e.indexOf(t)===-1&&e.push(t)});while(a=Object.getPrototypeOf(a));return e}class Da{static DeepCopy(e,t,i,r,s=!1){const n=US(e);for(const o of n){if(o[0]==="_"&&(!r||r.indexOf(o)===-1)||o.endsWith("Observable")||i&&i.indexOf(o)!==-1)continue;const l=e[o],c=typeof l;if(c!=="function")try{if(c==="object")if(l instanceof Uint8Array)t[o]=Uint8Array.from(l);else if(l instanceof Array){if(t[o]=[],l.length>0)if(typeof l[0]=="object")for(let h=0;h<l.length;h++){const f=vh(l[h],t,s);t[o].indexOf(f)===-1&&t[o].push(f)}else t[o]=l.slice(0)}else t[o]=vh(l,t,s);else t[o]=l}catch(h){B.Warn(h.message)}}}}class Ti{static get Now(){return Ht()&&window.performance&&window.performance.now?window.performance.now():Date.now()}}const Th={};function Le(a,e=!1){if(!(e&&Th[a]))return Th[a]=!0,`${a} needs to be imported before as it contains a side-effect required by your code.`}function VS(){return typeof _native<"u"&&_native.XMLHttpRequest?new _native.XMLHttpRequest:new XMLHttpRequest}class Gt{constructor(){this._xhr=VS(),this._requestURL=""}static get IsCustomRequestAvailable(){return Object.keys(Gt.CustomRequestHeaders).length>0||Gt.CustomRequestModifiers.length>0}get requestURL(){return this._requestURL}_injectCustomRequestHeaders(){if(!this._shouldSkipRequestModifications(this._requestURL))for(const e in Gt.CustomRequestHeaders){const t=Gt.CustomRequestHeaders[e];t&&this._xhr.setRequestHeader(e,t)}}_shouldSkipRequestModifications(e){return Gt.SkipRequestModificationForBabylonCDN&&(e.includes("preview.babylonjs.com")||e.includes("cdn.babylonjs.com"))}get onprogress(){return this._xhr.onprogress}set onprogress(e){this._xhr.onprogress=e}get readyState(){return this._xhr.readyState}get status(){return this._xhr.status}get statusText(){return this._xhr.statusText}get response(){return this._xhr.response}get responseURL(){return this._xhr.responseURL}get responseText(){return this._xhr.responseText}get responseType(){return this._xhr.responseType}set responseType(e){this._xhr.responseType=e}get timeout(){return this._xhr.timeout}set timeout(e){this._xhr.timeout=e}addEventListener(e,t,i){this._xhr.addEventListener(e,t,i)}removeEventListener(e,t,i){this._xhr.removeEventListener(e,t,i)}abort(){this._xhr.abort()}send(e){Gt.CustomRequestHeaders&&this._injectCustomRequestHeaders(),this._xhr.send(e)}open(e,t){for(const i of Gt.CustomRequestModifiers){if(this._shouldSkipRequestModifications(t))return;t=i(this._xhr,t)||t}t=t.replace("file:http:","http:"),t=t.replace("file:https:","https:"),this._requestURL=t,this._xhr.open(e,t,!0)}setRequestHeader(e,t){this._xhr.setRequestHeader(e,t)}getResponseHeader(e){return this._xhr.getResponseHeader(e)}}Gt.CustomRequestHeaders={};Gt.CustomRequestModifiers=new Array;Gt.SkipRequestModificationForBabylonCDN=!0;class Re{static get LastCreatedEngine(){return this.Instances.length===0?null:this.Instances[this.Instances.length-1]}static get LastCreatedScene(){return this._LastCreatedScene}}Re.Instances=[];Re.OnEnginesDisposedObservable=new U;Re._LastCreatedScene=null;Re.UseFallbackTexture=!0;Re.FallbackTexture="";class mn{}mn.FilesToLoad={};class GS{static ExponentialBackoff(e=3,t=500){return(i,r,s)=>r.status!==0||s>=e||i.indexOf("file:")!==-1?-1:Math.pow(2,s)*t}}class Zs extends Error{}Zs._setPrototypeOf=Object.setPrototypeOf||((a,e)=>(a.__proto__=e,a));const bs={MeshInvalidPositionsError:0,GLTFLoaderUnexpectedMagicError:2e3,SceneLoaderError:3e3,LoadFileError:4e3,RequestFileError:4001,ReadFileError:4002};class Ur extends Zs{constructor(e,t,i){super(e),this.errorCode=t,this.innerError=i,this.name="RuntimeError",Zs._setPrototypeOf(this,Ur.prototype)}}const kS=a=>{if(typeof TextDecoder<"u")return new TextDecoder().decode(a);let e="";for(let t=0;t<a.byteLength;t++)e+=String.fromCharCode(a[t]);return e},nm=a=>{const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let t="",i,r,s,n,o,l,c,h=0;const f=ArrayBuffer.isView(a)?new Uint8Array(a.buffer,a.byteOffset,a.byteLength):new Uint8Array(a);for(;h<f.length;)i=f[h++],r=h<f.length?f[h++]:Number.NaN,s=h<f.length?f[h++]:Number.NaN,n=i>>2,o=(i&3)<<4|r>>4,l=(r&15)<<2|s>>6,c=s&63,isNaN(r)?l=c=64:isNaN(s)&&(c=64),t+=e.charAt(n)+e.charAt(o)+e.charAt(l)+e.charAt(c);return t},am=a=>atob(a),WS=a=>{const e=am(a),t=e.length,i=new Uint8Array(new ArrayBuffer(t));for(let r=0;r<t;r++)i[r]=e.charCodeAt(r);return i.buffer},XS="attribute",HS="varying";class Nn{constructor(){this.children=[]}isValid(e){return!0}process(e,t){var r,s,n,o,l,c;let i="";if(this.line){let h=this.line;const f=t.processor;if(f){f.lineProcessor&&(h=f.lineProcessor(h,t.isFragment,t.processingContext));const u=((r=t.processor)==null?void 0:r.attributeKeywordName)??XS,d=t.isFragment&&((s=t.processor)!=null&&s.varyingFragmentKeywordName)?(n=t.processor)==null?void 0:n.varyingFragmentKeywordName:!t.isFragment&&((o=t.processor)!=null&&o.varyingVertexKeywordName)?(l=t.processor)==null?void 0:l.varyingVertexKeywordName:HS;!t.isFragment&&f.attributeProcessor&&this.line.startsWith(u)?h=f.attributeProcessor(this.line,e,t.processingContext):f.varyingProcessor&&((c=f.varyingCheck)!=null&&c.call(f,this.line,t.isFragment)||!f.varyingCheck&&this.line.startsWith(d))?h=f.varyingProcessor(this.line,t.isFragment,e,t.processingContext):f.uniformProcessor&&f.uniformRegexp&&f.uniformRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(h=f.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):f.uniformBufferProcessor&&f.uniformBufferRegexp&&f.uniformBufferRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(h=f.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0):f.textureProcessor&&f.textureRegexp&&f.textureRegexp.test(this.line)?h=f.textureProcessor(this.line,t.isFragment,e,t.processingContext):(f.uniformProcessor||f.uniformBufferProcessor)&&this.line.startsWith("uniform")&&!t.lookForClosingBracketForUniformBuffer&&(/uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/.test(this.line)?f.uniformProcessor&&(h=f.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):f.uniformBufferProcessor&&(h=f.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0)),t.lookForClosingBracketForUniformBuffer&&this.line.indexOf("}")!==-1&&(t.lookForClosingBracketForUniformBuffer=!1,f.endOfUniformBufferProcessor&&(h=f.endOfUniformBufferProcessor(this.line,t.isFragment,t.processingContext)))}i+=h+`
`}return this.children.forEach(h=>{i+=h.process(e,t)}),this.additionalDefineKey&&(e[this.additionalDefineKey]=this.additionalDefineValue||"true"),i}}class zS{constructor(){this._lines=[]}get currentLine(){return this._lines[this.lineIndex]}get canRead(){return this.lineIndex<this._lines.length-1}set lines(e){this._lines.length=0;for(const t of e){if(!t||t==="\r")continue;if(t[0]==="#"){this._lines.push(t);continue}const i=t.trim();if(!i)continue;if(i.startsWith("//")){this._lines.push(t);continue}const r=i.indexOf(";");if(r===-1)this._lines.push(i);else if(r===i.length-1)i.length>1&&this._lines.push(i);else{const s=t.split(";");for(let n=0;n<s.length;n++){let o=s[n];o&&(o=o.trim(),o&&this._lines.push(o+(n!==s.length-1?";":"")))}}}}}class Po extends Nn{process(e,t){for(let i=0;i<this.children.length;i++){const r=this.children[i];if(r.isValid(e))return r.process(e,t)}return""}}class YS extends Nn{isValid(e){return this.testExpression.isTrue(e)}}class xt{isTrue(e){return!0}static postfixToInfix(e){const t=[];for(const i of e)if(xt._OperatorPriority[i]===void 0)t.push(i);else{const r=t[t.length-1],s=t[t.length-2];t.length-=2,t.push(`(${s}${i}${r})`)}return t[t.length-1]}static infixToPostfix(e){const t=xt._InfixToPostfixCache.get(e);if(t)return t.accessTime=Date.now(),t.result;if(!e.includes("&&")&&!e.includes("||")&&!e.includes(")")&&!e.includes("("))return[e];const i=[];let r=-1;const s=()=>{h=h.trim(),h!==""&&(i.push(h),h="")},n=f=>{r<xt._Stack.length-1&&(xt._Stack[++r]=f)},o=()=>xt._Stack[r],l=()=>r===-1?"!!INVALID EXPRESSION!!":xt._Stack[r--];let c=0,h="";for(;c<e.length;){const f=e.charAt(c),u=c<e.length-1?e.substring(c,2+c):"";if(f==="(")h="",n(f);else if(f===")"){for(s();r!==-1&&o()!=="(";)i.push(l());l()}else if(xt._OperatorPriority[u]>1){for(s();r!==-1&&xt._OperatorPriority[o()]>=xt._OperatorPriority[u];)i.push(l());n(u),c++}else h+=f;c++}for(s();r!==-1;)o()==="("?l():i.push(l());return xt._InfixToPostfixCache.size>=xt.InfixToPostfixCacheLimitSize&&xt.ClearCache(),xt._InfixToPostfixCache.set(e,{result:i,accessTime:Date.now()}),i}static ClearCache(){const e=Array.from(xt._InfixToPostfixCache.entries()).sort((t,i)=>t[1].accessTime-i[1].accessTime);for(let t=0;t<xt.InfixToPostfixCacheCleanupSize;t++)xt._InfixToPostfixCache.delete(e[t][0])}}xt.InfixToPostfixCacheLimitSize=5e4;xt.InfixToPostfixCacheCleanupSize=25e3;xt._InfixToPostfixCache=new Map;xt._OperatorPriority={")":0,"(":1,"||":2,"&&":3};xt._Stack=["","","","","","","","","","","","","","","","","","","",""];class ma extends xt{constructor(e,t=!1){super(),this.define=e,this.not=t}isTrue(e){let t=e[this.define]!==void 0;return this.not&&(t=!t),t}}class KS extends xt{isTrue(e){return this.leftOperand.isTrue(e)||this.rightOperand.isTrue(e)}}class qS extends xt{isTrue(e){return this.leftOperand.isTrue(e)&&this.rightOperand.isTrue(e)}}class jS extends xt{constructor(e,t,i){super(),this.define=e,this.operand=t,this.testValue=i}isTrue(e){let t=e[this.define];t===void 0&&(t=this.define);let i=!1;const r=parseInt(t),s=parseInt(this.testValue);switch(this.operand){case">":i=r>s;break;case"<":i=r<s;break;case"<=":i=r<=s;break;case">=":i=r>=s;break;case"==":i=r===s;break;case"!=":i=r!==s;break}return i}}const ga={};function om(a,e,t=""){return t+(e?e+`
`:"")+a}function lm(a,e,t,i,r,s,n){const o=n||ga.loadFile;if(o)return o(a,e,t,i,r,s);throw Le("FileTools")}function cm(a,e,t,i){if(a){e?a.IS_NDC_HALF_ZRANGE="":delete a.IS_NDC_HALF_ZRANGE,t?a.USE_REVERSE_DEPTHBUFFER="":delete a.USE_REVERSE_DEPTHBUFFER,i?a.USE_EXACT_SRGB_CONVERSIONS="":delete a.USE_EXACT_SRGB_CONVERSIONS;return}else{let r="";return e&&(r+="#define IS_NDC_HALF_ZRANGE"),t&&(r&&(r+=`
`),r+="#define USE_REVERSE_DEPTHBUFFER"),i&&(r&&(r+=`
`),r+="#define USE_EXACT_SRGB_CONVERSIONS"),r}}function ZS(a,e,t=!1,i){switch(a){case 3:return e instanceof ArrayBuffer?new Int8Array(e):new Int8Array(e);case 0:return e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e);case 4:return e instanceof ArrayBuffer?new Int16Array(e):new Int16Array(t?e/2:e);case 5:case 8:case 9:case 10:case 2:return e instanceof ArrayBuffer?new Uint16Array(e):new Uint16Array(t?e/2:e);case 6:return e instanceof ArrayBuffer?new Int32Array(e):new Int32Array(t?e/4:e);case 7:case 11:case 12:case 13:case 14:case 15:return e instanceof ArrayBuffer?new Uint32Array(e):new Uint32Array(t?e/4:e);case 1:return e instanceof ArrayBuffer?new Float32Array(e):new Float32Array(t?e/4:e)}return e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e)}const QS=/defined\s*?\((.+?)\)/g,Oo=/defined\s*?\[(.+?)\]/g,$S=/#include\s?<(.+)>(\((.*)\))*(\[(.*)\])*/g,JS=/__decl__/,Sh=/light\{X\}.(\w*)/g,Ah=/\{X\}/g,ia=[],eA=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/;function tA(a){a.processor&&a.processor.initializeShaders&&a.processor.initializeShaders(a.processingContext)}function Rh(a,e,t,i){var r;(r=e.processor)!=null&&r.preProcessShaderCode&&(a=e.processor.preProcessShaderCode(a,e.isFragment)),Ea(a,e,s=>{e.processCodeAfterIncludes&&(s=e.processCodeAfterIncludes(e.isFragment?"fragment":"vertex",s,e.defines));const n=oA(s,e,i);t(n,s)})}function iA(a,e,t){return!t.processor||!t.processor.finalizeShaders?{vertexCode:a,fragmentCode:e}:t.processor.finalizeShaders(a,e,t.processingContext)}function rA(a,e){var i;if((i=e.processor)!=null&&i.noPrecision)return a;const t=e.shouldUseHighPrecisionShader;return a.indexOf("precision highp float")===-1?t?a=`precision highp float;
`+a:a=`precision mediump float;
`+a:t||(a=a.replace("precision highp float","precision mediump float")),a}function Do(a){const t=/defined\((.+)\)/.exec(a);if(t&&t.length)return new ma(t[1].trim(),a[0]==="!");const i=["==","!=",">=","<=","<",">"];let r="",s=0;for(r of i)if(s=a.indexOf(r),s>-1)break;if(s===-1)return new ma(a);const n=a.substring(0,s).trim(),o=a.substring(s+r.length).trim();return new jS(n,r,o)}function sA(a){a=a.replace(QS,"defined[$1]");const e=xt.infixToPostfix(a),t=[];for(const r of e)if(r!=="||"&&r!=="&&")t.push(r);else if(t.length>=2){let s=t[t.length-1],n=t[t.length-2];t.length-=2;const o=r=="&&"?new qS:new KS;typeof s=="string"&&(s=s.replace(Oo,"defined($1)")),typeof n=="string"&&(n=n.replace(Oo,"defined($1)")),o.leftOperand=typeof n=="string"?Do(n):n,o.rightOperand=typeof s=="string"?Do(s):s,t.push(o)}let i=t[t.length-1];return typeof i=="string"&&(i=i.replace(Oo,"defined($1)")),typeof i=="string"?Do(i):i}function fa(a,e){const t=new YS,i=a.substring(0,e);let r=a.substring(e);return r=r.substring(0,(r.indexOf("//")+1||r.length+1)-1).trim(),i==="#ifdef"?t.testExpression=new ma(r):i==="#ifndef"?t.testExpression=new ma(r,!0):t.testExpression=sA(r),t}function Lo(a,e,t){let i=a.currentLine;for(;tl(a,t);){i=a.currentLine;const r=i.substring(0,5).toLowerCase();if(r==="#else"){const s=new Nn;e.children.push(s),tl(a,s);return}else if(r==="#elif"){const s=fa(i,5);e.children.push(s),t=s}}}function tl(a,e){for(;a.canRead;){a.lineIndex++;const t=a.currentLine;if(t.indexOf("#")>=0){const r=eA.exec(t);if(r&&r.length){switch(r[0]){case"#ifdef":{const n=new Po;e.children.push(n);const o=fa(t,6);n.children.push(o),Lo(a,n,o);break}case"#else":case"#elif":return!0;case"#endif":return!1;case"#ifndef":{const n=new Po;e.children.push(n);const o=fa(t,7);n.children.push(o),Lo(a,n,o);break}case"#if":{const n=new Po,o=fa(t,3);e.children.push(n),n.children.push(o),Lo(a,n,o);break}}continue}}const i=new Nn;if(i.line=t,e.children.push(i),t[0]==="#"&&t[1]==="d"){const r=t.replace(";","").split(" ");i.additionalDefineKey=r[1],r.length===3&&(i.additionalDefineValue=r[2])}}return!1}function nA(a,e,t){const i=new Nn,r=new zS;return r.lineIndex=-1,r.lines=a.split(`
`),tl(r,i),i.process(e,t)}function aA(a,e){var r;const t=a.defines,i={};for(const s of t){const o=s.replace("#define","").replace(";","").trim().split(" ");i[o[0]]=o.length>1?o[1]:""}return((r=a.processor)==null?void 0:r.shaderLanguage)===0&&(i.GL_ES="true"),i.__VERSION__=a.version,i[a.platformName]="true",cm(i,e==null?void 0:e.isNDCHalfZRange,e==null?void 0:e.useReverseDepthBuffer,e==null?void 0:e.useExactSrgbConversions),i}function oA(a,e,t){let i=rA(a,e);if(!e.processor||e.processor.shaderLanguage===0&&i.indexOf("#version 3")!==-1&&(i=i.replace("#version 300 es",""),!e.processor.parseGLES3))return i;const r=e.defines,s=aA(e,t);return e.processor.preProcessor&&(i=e.processor.preProcessor(i,r,s,e.isFragment,e.processingContext)),i=nA(i,s,e),e.processor.postProcessor&&(i=e.processor.postProcessor(i,r,e.isFragment,e.processingContext,t?{drawBuffersExtensionDisabled:!t.getCaps().drawBuffersExtension}:{})),t!=null&&t._features.needShaderCodeInlining&&(i=t.inlineShaderCode(i)),i}function Ea(a,e,t){ia.length=0;let i;for(;(i=$S.exec(a))!==null;)ia.push(i);let r=String(a),s=[a],n=!1;for(const o of ia){let l=o[1];if(l.indexOf("__decl__")!==-1&&(l=l.replace(JS,""),e.supportsUniformBuffers&&(l=l.replace("Vertex","Ubo").replace("Fragment","Ubo")),l=l+"Declaration"),e.includesShadersStore[l]){let c=e.includesShadersStore[l];if(o[2]){const f=o[3].split(",");for(let u=0;u<f.length;u+=2){const d=new RegExp(f[u],"g"),_=f[u+1];c=c.replace(d,_)}}if(o[4]){const f=o[5];if(f.indexOf("..")!==-1){const u=f.split(".."),d=parseInt(u[0]);let _=parseInt(u[1]),p=c.slice(0);c="",isNaN(_)&&(_=e.indexParameters[u[1]]);for(let g=d;g<_;g++)e.supportsUniformBuffers||(p=p.replace(Sh,(E,v)=>v+"{X}")),c+=p.replace(Ah,g.toString())+`
`}else e.supportsUniformBuffers||(c=c.replace(Sh,(u,d)=>d+"{X}")),c=c.replace(Ah,f)}const h=[];for(const f of s){const u=f.split(o[0]);for(let d=0;d<u.length-1;d++)h.push(u[d]),h.push(c);h.push(u[u.length-1])}s=h,n=n||c.indexOf("#include<")>=0||c.indexOf("#include <")>=0}else{const c=e.shadersRepository+"ShadersInclude/"+l+".fx";hm.loadFile(c,h=>{e.includesShadersStore[l]=h,Ea(s.join(""),e,t)});return}}ia.length=0,r=s.join(""),n?Ea(r.toString(),e,t):t(r)}const hm={loadFile:(a,e,t,i,r,s)=>{throw Le("FileTools")}};let ra=[];class vs{static SetImmediate(e){ra.length===0&&setTimeout(()=>{const t=ra;ra=[];for(const i of t)i()},1),ra.push(e)}}function Ch(a,e,t){try{if(a())return e(),!0}catch(i){return t==null||t(i),!0}return!1}const va=(a,e,t,i=16,r=3e4,s=!0,n)=>{if(s&&Ch(a,e,t))return null;const o=setInterval(()=>{Ch(a,e,t)?clearInterval(o):(r-=i,r<0&&(clearInterval(o),t==null||t(new Error("Operation timed out after maximum retries. "+(n||"")),!0)))},i);return()=>clearInterval(o)};class C{static GetShadersRepository(e=0){return e===0?C.ShadersRepository:C.ShadersRepositoryWGSL}static GetShadersStore(e=0){return e===0?C.ShadersStore:C.ShadersStoreWGSL}static GetIncludesShadersStore(e=0){return e===0?C.IncludesShadersStore:C.IncludesShadersStoreWGSL}}C.ShadersRepository="src/Shaders/";C.ShadersStore={};C.IncludesShadersStore={};C.ShadersRepositoryWGSL="src/ShadersWGSL/";C.ShadersStoreWGSL={};C.IncludesShadersStoreWGSL={};class lA{constructor(){this._valueCache={},this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null,this._isDisposed=!1}get isAsync(){return this.isParallelCompiled}get isReady(){return this.program?this.isParallelCompiled?this.engine._isRenderingStateCompiled(this):!0:!1}_handlesSpectorRebuildCallback(e){e&&this.program&&e(this.program)}setEngine(e){this.engine=e}_fillEffectInformation(e,t,i,r,s,n,o,l){const c=this.engine;if(c.supportsUniformBuffers)for(const u in t)e.bindUniformBlock(u,t[u]);this.engine.getUniforms(this,i).forEach((u,d)=>{r[i[d]]=u}),this._uniforms=r;let f;for(f=0;f<s.length;f++)e.getUniform(s[f])==null&&(s.splice(f,1),f--);s.forEach((u,d)=>{n[u]=d});for(const u of c.getAttributes(this,o))l.push(u)}dispose(){this._uniforms={},this._isDisposed=!0}_cacheMatrix(e,t){const i=this._valueCache[e],r=t.updateFlag;return i!==void 0&&i===r?!1:(this._valueCache[e]=r,!0)}_cacheFloat2(e,t,i){let r=this._valueCache[e];if(!r||r.length!==2)return r=[t,i],this._valueCache[e]=r,!0;let s=!1;return r[0]!==t&&(r[0]=t,s=!0),r[1]!==i&&(r[1]=i,s=!0),s}_cacheFloat3(e,t,i,r){let s=this._valueCache[e];if(!s||s.length!==3)return s=[t,i,r],this._valueCache[e]=s,!0;let n=!1;return s[0]!==t&&(s[0]=t,n=!0),s[1]!==i&&(s[1]=i,n=!0),s[2]!==r&&(s[2]=r,n=!0),n}_cacheFloat4(e,t,i,r,s){let n=this._valueCache[e];if(!n||n.length!==4)return n=[t,i,r,s],this._valueCache[e]=n,!0;let o=!1;return n[0]!==t&&(n[0]=t,o=!0),n[1]!==i&&(n[1]=i,o=!0),n[2]!==r&&(n[2]=r,o=!0),n[3]!==s&&(n[3]=s,o=!0),o}setInt(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this.engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setInt3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this.engine.setInt3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setInt4(e,t,i,r,s){this._cacheFloat4(e,t,i,r,s)&&(this.engine.setInt4(this._uniforms[e],t,i,r,s)||(this._valueCache[e]=null))}setIntArray(e,t){this._valueCache[e]=null,this.engine.setIntArray(this._uniforms[e],t)}setIntArray2(e,t){this._valueCache[e]=null,this.engine.setIntArray2(this._uniforms[e],t)}setIntArray3(e,t){this._valueCache[e]=null,this.engine.setIntArray3(this._uniforms[e],t)}setIntArray4(e,t){this._valueCache[e]=null,this.engine.setIntArray4(this._uniforms[e],t)}setUInt(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this.engine.setUInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setUInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setUInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setUInt3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this.engine.setUInt3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setUInt4(e,t,i,r,s){this._cacheFloat4(e,t,i,r,s)&&(this.engine.setUInt4(this._uniforms[e],t,i,r,s)||(this._valueCache[e]=null))}setUIntArray(e,t){this._valueCache[e]=null,this.engine.setUIntArray(this._uniforms[e],t)}setUIntArray2(e,t){this._valueCache[e]=null,this.engine.setUIntArray2(this._uniforms[e],t)}setUIntArray3(e,t){this._valueCache[e]=null,this.engine.setUIntArray3(this._uniforms[e],t)}setUIntArray4(e,t){this._valueCache[e]=null,this.engine.setUIntArray4(this._uniforms[e],t)}setArray(e,t){this._valueCache[e]=null,this.engine.setArray(this._uniforms[e],t)}setArray2(e,t){this._valueCache[e]=null,this.engine.setArray2(this._uniforms[e],t)}setArray3(e,t){this._valueCache[e]=null,this.engine.setArray3(this._uniforms[e],t)}setArray4(e,t){this._valueCache[e]=null,this.engine.setArray4(this._uniforms[e],t)}setMatrices(e,t){t&&(this._valueCache[e]=null,this.engine.setMatrices(this._uniforms[e],t))}setMatrix(e,t){this._cacheMatrix(e,t)&&(this.engine.setMatrices(this._uniforms[e],t.asArray())||(this._valueCache[e]=null))}setMatrix3x3(e,t){this._valueCache[e]=null,this.engine.setMatrix3x3(this._uniforms[e],t)}setMatrix2x2(e,t){this._valueCache[e]=null,this.engine.setMatrix2x2(this._uniforms[e],t)}setFloat(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this.engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)}setVector2(e,t){this._cacheFloat2(e,t.x,t.y)&&(this.engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))}setFloat2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setFloat2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setVector3(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this.engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))}setFloat3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this.engine.setFloat3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setVector4(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setQuaternion(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setFloat4(e,t,i,r,s){this._cacheFloat4(e,t,i,r,s)&&(this.engine.setFloat4(this._uniforms[e],t,i,r,s)||(this._valueCache[e]=null))}setColor3(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this.engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))}setColor4(e,t,i){this._cacheFloat4(e,t.r,t.g,t.b,i)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)||(this._valueCache[e]=null))}setDirectColor4(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))}_getVertexShaderCode(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null}_getFragmentShaderCode(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null}}const il=new WeakMap,cA={_webGLVersion:2,cachedPipelines:{}};function xi(a){let e=il.get(a);if(!e){if(!a)return cA;e={_webGLVersion:a.TEXTURE_BINDING_3D?2:1,_context:a,parallelShaderCompile:a.getExtension("KHR_parallel_shader_compile")||void 0,cachedPipelines:{}},il.set(a,e)}return e}function No(a){il.delete(a)}function fm(a,e,t,i,r,s){const n=xi(i);s||(s=n._createShaderProgramInjection??hc);const o=rl(e,"vertex",i,n._contextWasLost),l=rl(t,"fragment",i,n._contextWasLost);return s(a,o,l,i,r,n.validateShaderPrograms)}function um(a,e,t,i,r,s=null,n){const o=xi(r);n||(n=o._createShaderProgramInjection??hc);const l=o._webGLVersion>1?`#version 300 es
#define WEBGL2 
`:"",c=Ih(e,"vertex",i,l,r,o._contextWasLost),h=Ih(t,"fragment",i,l,r,o._contextWasLost);return n(a,c,h,r,s,o.validateShaderPrograms)}function hA(a,e){const t=new lA,i=xi(a);return i.parallelShaderCompile&&!i.disableParallelShaderCompile&&(t.isParallelCompiled=!0),t.context=i._context,t}function hc(a,e,t,i,r=null,s){const n=i.createProgram();if(a.program=n,!n)throw new Error("Unable to create program");return i.attachShader(n,e),i.attachShader(n,t),i.linkProgram(n),a.context=i,a.vertexShader=e,a.fragmentShader=t,a.isParallelCompiled||fc(a,i,s),n}function fA(a,e,t){const i=a;if(i._isDisposed)return!1;const r=xi(e);return r&&r.parallelShaderCompile&&r.parallelShaderCompile.COMPLETION_STATUS_KHR&&i.program&&e.getProgramParameter(i.program,r.parallelShaderCompile.COMPLETION_STATUS_KHR)?(fc(i,e,t),!0):!1}function fc(a,e,t){const i=a.context,r=a.vertexShader,s=a.fragmentShader,n=a.program;if(!i.getProgramParameter(n,i.LINK_STATUS)){if(!e.getShaderParameter(r,e.COMPILE_STATUS)){const c=e.getShaderInfoLog(r);if(c)throw a.vertexCompilationError=c,new Error("VERTEX SHADER "+c)}if(!e.getShaderParameter(s,e.COMPILE_STATUS)){const c=e.getShaderInfoLog(s);if(c)throw a.fragmentCompilationError=c,new Error("FRAGMENT SHADER "+c)}const l=i.getProgramInfoLog(n);if(l)throw a.programLinkError=l,new Error(l)}if(t&&(i.validateProgram(n),!i.getProgramParameter(n,i.VALIDATE_STATUS))){const c=i.getProgramInfoLog(n);if(c)throw a.programValidationError=c,new Error(c)}i.deleteShader(r),i.deleteShader(s),a.vertexShader=void 0,a.fragmentShader=void 0,a.onCompiled&&(a.onCompiled(),a.onCompiled=void 0)}function uA(a,e,t,i,r,s,n,o,l,c="",h,f,u){const d=xi(a.context);f||(f=d.createRawShaderProgramInjection??fm),u||(u=d.createShaderProgramInjection??um);const _=a;i?_.program=f(_,e,t,_.context,l):_.program=u(_,e,t,o,_.context,l),_.program.__SPECTOR_rebuildProgram=n,h()}function Ih(a,e,t,i,r,s){return rl(om(a,t,i),e,r,s)}function rl(a,e,t,i){const r=t.createShader(e==="vertex"?t.VERTEX_SHADER:t.FRAGMENT_SHADER);if(!r){let s=t.NO_ERROR,n=t.NO_ERROR;for(;(n=t.getError())!==t.NO_ERROR;)s=n;throw new Error(`Something went wrong while creating a gl ${e} shader object. gl error=${s}, gl isContextLost=${t.isContextLost()}, _contextWasLost=${i}`)}return t.shaderSource(r,a),t.compileShader(r),r}function dA(a,e){e.useProgram(a)}function _A(a,e){const t=a;if(!t.isParallelCompiled){e(a);return}const i=t.onCompiled;t.onCompiled=()=>{i==null||i(),e(a)}}function pA(a,e){return xi(e).cachedPipelines[a]}function dm(a){const e=a._name,t=a.context;if(e&&t){const i=xi(t),r=i.cachedPipelines[e];r==null||r.dispose(),delete i.cachedPipelines[e]}}function mA(a,e,t,i,r,s,n){let o,l;const c=Ht()?s==null?void 0:s.getHostDocument():null;typeof e=="string"?o=e:e.vertexSource?o="source:"+e.vertexSource:e.vertexElement?o=(c==null?void 0:c.getElementById(e.vertexElement))||e.vertexElement:o=e.vertex||e,typeof e=="string"?l=e:e.fragmentSource?l="source:"+e.fragmentSource:e.fragmentElement?l=(c==null?void 0:c.getElementById(e.fragmentElement))||e.fragmentElement:l=e.fragment||e;const h=[void 0,void 0],f=()=>{if(h[0]&&h[1]){a.isFragment=!0;const[u,d]=h;Rh(d,a,(_,p)=>{n&&(n._fragmentSourceCodeBeforeMigration=p),t&&(_=t("fragment",_));const g=iA(u,_,a);a=null;const E=gA(g.vertexCode,g.fragmentCode,e,r);i==null||i(E.vertexSourceCode,E.fragmentSourceCode)},s)}};bh(o,"Vertex","",u=>{tA(a),Rh(u,a,(d,_)=>{n&&(n._rawVertexSourceCode=u,n._vertexSourceCodeBeforeMigration=_),t&&(d=t("vertex",d)),h[0]=d,f()},s)},r),bh(l,"Fragment","Pixel",u=>{n&&(n._rawFragmentSourceCode=u),h[1]=u,f()},r)}function bh(a,e,t,i,r,s){if(typeof HTMLElement<"u"&&a instanceof HTMLElement){const l=sm(a);i(l);return}if(a.substring(0,7)==="source:"){i(a.substring(7));return}if(a.substring(0,7)==="base64:"){const l=window.atob(a.substring(7));i(l);return}const n=C.GetShadersStore(r);if(n[a+e+"Shader"]){i(n[a+e+"Shader"]);return}if(t&&n[a+t+"Shader"]){i(n[a+t+"Shader"]);return}let o;if(a[0]==="."||a[0]==="/"||a.indexOf("http")>-1?o=a:o=C.GetShadersRepository(r)+a,s=s||lm,!s)throw new Error("loadFileInjection is not defined");s(o+"."+e.toLowerCase()+".fx",i)}function gA(a,e,t,i){if(t){const r=t.vertexElement||t.vertex||t.spectorName||t,s=t.fragmentElement||t.fragment||t.spectorName||t;return{vertexSourceCode:(i===1?"//":"")+"#define SHADER_NAME vertex:"+r+`
`+a,fragmentSourceCode:(i===1?"//":"")+"#define SHADER_NAME fragment:"+s+`
`+e}}else return{vertexSourceCode:a,fragmentSourceCode:e}}const EA=(a,e,t,i)=>{try{const r=a.context?xi(a.context):null;r&&(r.disableParallelShaderCompile=a.disableParallelCompilation);const s=a.existingPipelineContext||e(a.shaderProcessingContext);return s._name=a.name,a.name&&r&&(r.cachedPipelines[a.name]=s),t(s,a.vertex,a.fragment,!!a.createAsRaw,"","",a.rebuildRebind,a.defines,a.transformFeedbackVaryings,"",()=>{i(s,()=>{var n;(n=a.onRenderingStateCompiled)==null||n.call(a,s)})}),s}catch(r){throw B.Error("Error compiling effect"),r}};class lt{static get ShadersRepository(){return C.ShadersRepository}static set ShadersRepository(e){C.ShadersRepository=e}get isDisposed(){return this._isDisposed}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new U),this._onBindObservable}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i,r=null,s,n=null,o=null,l=null,c=null,h,f="",u=0,d){this.defines="",this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new U,this.onErrorObservable=new U,this._onBindObservable=null,this._isDisposed=!1,this._refCount=1,this._bonesComputationForcedToCPU=!1,this._uniformBuffersNames={},this._multiTarget=!1,this._samplers={},this._isReady=!1,this._compilationError="",this._allFallbacksProcessed=!1,this._uniforms={},this._key="",this._fallbacks=null,this._vertexSourceCodeOverride="",this._fragmentSourceCodeOverride="",this._transformFeedbackVaryings=null,this._disableParallelShaderCompilation=!1,this._pipelineContext=null,this._vertexSourceCode="",this._fragmentSourceCode="",this._vertexSourceCodeBeforeMigration="",this._fragmentSourceCodeBeforeMigration="",this._rawVertexSourceCode="",this._rawFragmentSourceCode="",this._processCodeAfterIncludes=void 0,this._processFinalCode=null,this.name=e,this._key=f;const _=this._key.replace(/\r/g,"").replace(/\n/g,"|");let p;if(t.attributes){const g=t;if(this._engine=i,this._attributesNames=g.attributes,this._uniformsNames=g.uniformsNames.concat(g.samplers),this._samplerList=g.samplers.slice(),this.defines=g.defines,this.onError=g.onError,this.onCompiled=g.onCompiled,this._fallbacks=g.fallbacks,this._indexParameters=g.indexParameters,this._transformFeedbackVaryings=g.transformFeedbackVaryings||null,this._multiTarget=!!g.multiTarget,this._shaderLanguage=g.shaderLanguage??0,this._disableParallelShaderCompilation=!!g.disableParallelShaderCompilation,g.uniformBuffersNames){this._uniformBuffersNamesList=g.uniformBuffersNames.slice();for(let E=0;E<g.uniformBuffersNames.length;E++)this._uniformBuffersNames[g.uniformBuffersNames[E]]=E}this._processFinalCode=g.processFinalCode??null,this._processCodeAfterIncludes=g.processCodeAfterIncludes??void 0,d=g.extraInitializationsAsync,p=g.existingPipelineContext}else this._engine=s,this.defines=n??"",this._uniformsNames=i.concat(r),this._samplerList=r?r.slice():[],this._attributesNames=t,this._uniformBuffersNamesList=[],this._shaderLanguage=u,this.onError=c,this.onCompiled=l,this._indexParameters=h,this._fallbacks=o;this._engine.shaderPlatformName==="WEBGL2"&&(p=pA(_,this._engine._gl)??p),this._attributeLocationByName={},this.uniqueId=lt._UniqueIdSeed++,p?(this._pipelineContext=p,this._pipelineContext.setEngine(this._engine),this._onRenderingStateCompiled(this._pipelineContext),this._pipelineContext.program&&(this._pipelineContext.program.__SPECTOR_rebuildProgram=this._rebuildProgram.bind(this))):this._processShaderCodeAsync(null,!1,null,d),this._engine.onReleaseEffectsObservable.addOnce(()=>{this.isDisposed||this.dispose(!0)})}async _processShaderCodeAsync(e=null,t=!1,i=null,r){r&&await r(),this._processingContext=i||this._engine._getShaderProcessingContext(this._shaderLanguage,!1);const s={defines:this.defines.split(`
`),indexParameters:this._indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:e??this._engine._getShaderProcessor(this._shaderLanguage),supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:C.GetShadersRepository(this._shaderLanguage),includesShadersStore:C.GetIncludesShadersStore(this._shaderLanguage),version:(this._engine.version*100).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._processingContext,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:this._processCodeAfterIncludes};mA(s,this.name,this._processFinalCode,(n,o)=>{this._vertexSourceCode=n,this._fragmentSourceCode=o,this._prepareEffect(t)},this._shaderLanguage,this._engine,this)}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch{return!1}}_isReadyInternal(){return this._engine.isDisposed||this._isReady?!0:this._pipelineContext?this._pipelineContext.isReady:!1}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getAttributesNames(){return this._attributesNames}getAttributeLocation(e){return this._attributes[e]}getAttributeLocationByName(e){return this._attributeLocationByName[e]}getAttributesCount(){return this._attributes.length}getUniformIndex(e){return this._uniformsNames.indexOf(e)}getUniform(e){return this._uniforms[e]}getSamplers(){return this._samplerList}getUniformNames(){return this._uniformsNames}getUniformBuffersNames(){return this._uniformBuffersNamesList}getIndexParameters(){return this._indexParameters}getCompilationError(){return this._compilationError}allFallbacksProcessed(){return this._allFallbacksProcessed}whenCompiledAsync(){return new Promise(e=>{this.executeWhenCompiled(e)})}executeWhenCompiled(e){if(this.isReady()){e(this);return}this.onCompileObservable.add(t=>{e(t)}),(!this._pipelineContext||this._pipelineContext.isAsync)&&this._checkIsReady(null)}_checkIsReady(e){va(()=>this._isReadyInternal()||this._isDisposed,()=>{},t=>{this._processCompilationErrors(t,e)},16,12e4,!0,` - Effect: ${typeof this.name=="string"?this.name:this.key}`)}get vertexSourceCode(){var e;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._vertexSourceCodeOverride:((e=this._pipelineContext)==null?void 0:e._getVertexShaderCode())??this._vertexSourceCode}get fragmentSourceCode(){var e;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._fragmentSourceCodeOverride:((e=this._pipelineContext)==null?void 0:e._getFragmentShaderCode())??this._fragmentSourceCode}get vertexSourceCodeBeforeMigration(){return this._vertexSourceCodeBeforeMigration}get fragmentSourceCodeBeforeMigration(){return this._fragmentSourceCodeBeforeMigration}get rawVertexSourceCode(){return this._rawVertexSourceCode}get rawFragmentSourceCode(){return this._rawFragmentSourceCode}getPipelineGenerationOptions(){return{platformName:this._engine.shaderPlatformName,shaderLanguage:this._shaderLanguage,shaderNameOrContent:this.name,key:this._key,defines:this.defines.split(`
`),addGlobalDefines:!1,extendedProcessingOptions:{indexParameters:this._indexParameters,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,supportsUniformBuffers:this._engine.supportsUniformBuffers},extendedCreatePipelineOptions:{transformFeedbackVaryings:this._transformFeedbackVaryings,createAsRaw:!!(this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride)}}}_rebuildProgram(e,t,i,r){this._isReady=!1,this._vertexSourceCodeOverride=e,this._fragmentSourceCodeOverride=t,this.onError=(s,n)=>{r&&r(n)},this.onCompiled=()=>{var n,o;const s=this.getEngine().scenes;if(s)for(let l=0;l<s.length;l++)s[l].markAllMaterialsAsDirty(127);(o=(n=this._pipelineContext)._handlesSpectorRebuildCallback)==null||o.call(n,i)},this._fallbacks=null,this._prepareEffect()}_onRenderingStateCompiled(e){if(this._pipelineContext=e,this._pipelineContext.setEngine(this._engine),this._attributes=[],this._pipelineContext._fillEffectInformation(this,this._uniformBuffersNames,this._uniformsNames,this._uniforms,this._samplerList,this._samplers,this._attributesNames,this._attributes),this._attributesNames)for(let t=0;t<this._attributesNames.length;t++){const i=this._attributesNames[t];this._attributeLocationByName[i]=this._attributes[t]}this._engine.bindSamplers(this),this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh(),lt.AutomaticallyClearCodeCache&&this.clearCodeCache()}_prepareEffect(e=!1){const t=this._pipelineContext;this._isReady=!1;try{const i=!!(this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride),r=i?null:this.defines,s=i?this._vertexSourceCodeOverride:this._vertexSourceCode,n=i?this._fragmentSourceCodeOverride:this._fragmentSourceCode,o=this._engine;this._pipelineContext=EA({existingPipelineContext:e?t:null,vertex:s,fragment:n,context:o.shaderPlatformName==="WEBGL2"||o.shaderPlatformName==="WEBGL1"?o._gl:void 0,rebuildRebind:(l,c,h,f)=>this._rebuildProgram(l,c,h,f),defines:r,transformFeedbackVaryings:this._transformFeedbackVaryings,name:this._key.replace(/\r/g,"").replace(/\n/g,"|"),createAsRaw:i,disableParallelCompilation:this._disableParallelShaderCompilation,shaderProcessingContext:this._processingContext,onRenderingStateCompiled:l=>{t&&!e&&this._engine._deletePipelineContext(t),l&&this._onRenderingStateCompiled(l)}},this._engine.createPipelineContext.bind(this._engine),this._engine._preparePipelineContext.bind(this._engine),this._engine._executeWhenRenderingStateIsCompiled.bind(this._engine)),this._pipelineContext.isAsync&&this._checkIsReady(t)}catch(i){this._processCompilationErrors(i,t)}}_getShaderCodeAndErrorLine(e,t,i){const r=i?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/;let s=null;if(t&&e){const n=t.match(r);if(n&&n.length===2){const o=parseInt(n[1]),l=e.split(`
`,-1);l.length>=o&&(s=`Offending line [${o}] in ${i?"fragment":"vertex"} code: ${l[o-1]}`)}}return[e,s]}_processCompilationErrors(e,t=null){var n,o,l;this._compilationError=e.message;const i=this._attributesNames,r=this._fallbacks;if(B.Error("Unable to compile effect:"),B.Error("Uniforms: "+this._uniformsNames.map(function(c){return" "+c})),B.Error("Attributes: "+i.map(function(c){return" "+c})),B.Error(`Defines:
`+this.defines),lt.LogShaderCodeOnCompilationError){let c=null,h=null,f=null;(n=this._pipelineContext)!=null&&n._getVertexShaderCode()&&([f,c]=this._getShaderCodeAndErrorLine(this._pipelineContext._getVertexShaderCode(),this._compilationError,!1),f&&(B.Error("Vertex code:"),B.Error(f))),(o=this._pipelineContext)!=null&&o._getFragmentShaderCode()&&([f,h]=this._getShaderCodeAndErrorLine((l=this._pipelineContext)==null?void 0:l._getFragmentShaderCode(),this._compilationError,!0),f&&(B.Error("Fragment code:"),B.Error(f))),c&&B.Error(c),h&&B.Error(h)}B.Error("Error: "+this._compilationError);const s=()=>{this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this),this._engine.onEffectErrorObservable.notifyObservers({effect:this,errors:this._compilationError})};t&&(this._pipelineContext=t,this._isReady=!0,s()),r?(this._pipelineContext=null,r.hasMoreFallbacks?(this._allFallbacksProcessed=!1,B.Error("Trying next fallback."),this.defines=r.reduce(this.defines,this),this._prepareEffect()):(this._allFallbacksProcessed=!0,s(),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())):(this._allFallbacksProcessed=!0,t||s())}get isSupported(){return this._compilationError===""}_bindTexture(e,t){this._engine._bindTexture(this._samplers[e],t,e)}setTexture(e,t){this._engine.setTexture(this._samplers[e],this._uniforms[e],t,e)}setTextureArray(e,t){const i=e+"Ex";if(this._samplerList.indexOf(i+"0")===-1){const r=this._samplerList.indexOf(e);for(let n=1;n<t.length;n++){const o=i+(n-1).toString();this._samplerList.splice(r+n,0,o)}let s=0;for(const n of this._samplerList)this._samplers[n]=s,s+=1}this._engine.setTextureArray(this._samplers[e],this._uniforms[e],t,e)}bindUniformBuffer(e,t){const i=this._uniformBuffersNames[t];i===void 0||lt._BaseCache[i]===e&&this._engine._features.useUBOBindingCache||(lt._BaseCache[i]=e,this._engine.bindUniformBufferBase(e,i,t))}bindUniformBlock(e,t){this._engine.bindUniformBlock(this._pipelineContext,e,t)}setInt(e,t){return this._pipelineContext.setInt(e,t),this}setInt2(e,t,i){return this._pipelineContext.setInt2(e,t,i),this}setInt3(e,t,i,r){return this._pipelineContext.setInt3(e,t,i,r),this}setInt4(e,t,i,r,s){return this._pipelineContext.setInt4(e,t,i,r,s),this}setIntArray(e,t){return this._pipelineContext.setIntArray(e,t),this}setIntArray2(e,t){return this._pipelineContext.setIntArray2(e,t),this}setIntArray3(e,t){return this._pipelineContext.setIntArray3(e,t),this}setIntArray4(e,t){return this._pipelineContext.setIntArray4(e,t),this}setUInt(e,t){return this._pipelineContext.setUInt(e,t),this}setUInt2(e,t,i){return this._pipelineContext.setUInt2(e,t,i),this}setUInt3(e,t,i,r){return this._pipelineContext.setUInt3(e,t,i,r),this}setUInt4(e,t,i,r,s){return this._pipelineContext.setUInt4(e,t,i,r,s),this}setUIntArray(e,t){return this._pipelineContext.setUIntArray(e,t),this}setUIntArray2(e,t){return this._pipelineContext.setUIntArray2(e,t),this}setUIntArray3(e,t){return this._pipelineContext.setUIntArray3(e,t),this}setUIntArray4(e,t){return this._pipelineContext.setUIntArray4(e,t),this}setFloatArray(e,t){return this._pipelineContext.setArray(e,t),this}setFloatArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setFloatArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setFloatArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setArray(e,t){return this._pipelineContext.setArray(e,t),this}setArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setMatrices(e,t){return this._pipelineContext.setMatrices(e,t),this}setMatrix(e,t){return this._pipelineContext.setMatrix(e,t),this}setMatrix3x3(e,t){return this._pipelineContext.setMatrix3x3(e,t),this}setMatrix2x2(e,t){return this._pipelineContext.setMatrix2x2(e,t),this}setFloat(e,t){return this._pipelineContext.setFloat(e,t),this}setBool(e,t){return this._pipelineContext.setInt(e,t?1:0),this}setVector2(e,t){return this._pipelineContext.setVector2(e,t),this}setFloat2(e,t,i){return this._pipelineContext.setFloat2(e,t,i),this}setVector3(e,t){return this._pipelineContext.setVector3(e,t),this}setFloat3(e,t,i,r){return this._pipelineContext.setFloat3(e,t,i,r),this}setVector4(e,t){return this._pipelineContext.setVector4(e,t),this}setQuaternion(e,t){return this._pipelineContext.setQuaternion(e,t),this}setFloat4(e,t,i,r,s){return this._pipelineContext.setFloat4(e,t,i,r,s),this}setColor3(e,t){return this._pipelineContext.setColor3(e,t),this}setColor4(e,t,i){return this._pipelineContext.setColor4(e,t,i),this}setDirectColor4(e,t){return this._pipelineContext.setDirectColor4(e,t),this}clearCodeCache(){this._vertexSourceCode="",this._fragmentSourceCode="",this._fragmentSourceCodeBeforeMigration="",this._vertexSourceCodeBeforeMigration=""}dispose(e=!1){if(e)this._refCount=0;else{if(lt.PersistentMode)return;this._refCount--}this._refCount>0||this._isDisposed||(this._pipelineContext&&dm(this._pipelineContext),this._engine._releaseEffect(this),this.clearCodeCache(),this._isDisposed=!0)}static RegisterShader(e,t,i,r=0){t&&(C.GetShadersStore(r)[`${e}PixelShader`]=t),i&&(C.GetShadersStore(r)[`${e}VertexShader`]=i)}static ResetCache(){lt._BaseCache={}}}lt.LogShaderCodeOnCompilationError=!0;lt.PersistentMode=!1;lt.AutomaticallyClearCodeCache=!1;lt._UniqueIdSeed=0;lt._BaseCache={};lt.ShadersStore=C.ShadersStore;lt.IncludesShadersStore=C.IncludesShadersStore;class Xt{static SetMatrixPrecision(e){if(Xt.MatrixTrackPrecisionChange=!1,e&&!Xt.MatrixUse64Bits&&Xt.MatrixTrackedMatrices)for(let t=0;t<Xt.MatrixTrackedMatrices.length;++t){const i=Xt.MatrixTrackedMatrices[t],r=i._m;i._m=new Array(16);for(let s=0;s<16;++s)i._m[s]=r[s]}Xt.MatrixUse64Bits=e,Xt.MatrixCurrentType=Xt.MatrixUse64Bits?Array:Float32Array,Xt.MatrixTrackedMatrices=null}}Xt.MatrixUse64Bits=!1;Xt.MatrixTrackPrecisionChange=!0;Xt.MatrixCurrentType=Float32Array;Xt.MatrixTrackedMatrices=[];class vA{constructor(e=!0){this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1,e&&this.reset()}get isDirty(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0)}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0)}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0)}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0)}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0)}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0)}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0)}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0)}reset(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._zOffsetUnits=0,this._frontFace=null,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!0,this._isFrontFaceDirty=!1}apply(e){this.isDirty&&(this._isCullDirty&&(this.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(e.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(e.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(e.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset||this.zOffsetUnits?(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(this.zOffset,this.zOffsetUnits)):e.disable(e.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1),this._isFrontFaceDirty&&(e.frontFace(this.frontFace),this._isFrontFaceDirty=!1))}}class TA{get isDirty(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._isStencilFuncDirty=!0)}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef!==e&&(this._funcRef=e,this._isStencilFuncDirty=!0)}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._isStencilFuncDirty=!0)}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._isStencilOpDirty=!0)}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._isStencilOpDirty=!0)}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._isStencilOpDirty=!0)}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._isStencilMaskDirty=!0)}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._isStencilTestDirty=!0)}constructor(e=!0){this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.useStencilGlobalOnly=!1,e&&this.reset()}reset(){var e;this.stencilMaterial=void 0,(e=this.stencilGlobal)==null||e.reset(),this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0}apply(e){var i;if(!e)return;const t=!this.useStencilGlobalOnly&&!!((i=this.stencilMaterial)!=null&&i.enabled);this.enabled=t?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.func=t?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=t?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=t?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=t?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=t?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=t?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=t?this.stencilMaterial.mask:this.stencilGlobal.mask,this.isDirty&&(this._isStencilTestDirty&&(this.enabled?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(e.stencilMask(this.mask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(e.stencilFunc(this.func,this.funcRef,this.funcMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(e.stencilOp(this.opStencilFail,this.opDepthFail,this.opStencilDepthPass),this._isStencilOpDirty=!1))}}class Dr{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=Dr.ALWAYS,this.funcRef=1,this.funcMask=255,this.opStencilFail=Dr.KEEP,this.opDepthFail=Dr.KEEP,this.opStencilDepthPass=Dr.REPLACE}get stencilFunc(){return this.func}set stencilFunc(e){this.func=e}get stencilFuncRef(){return this.funcRef}set stencilFuncRef(e){this.funcRef=e}get stencilFuncMask(){return this.funcMask}set stencilFuncMask(e){this.funcMask=e}get stencilOpStencilFail(){return this.opStencilFail}set stencilOpStencilFail(e){this.opStencilFail=e}get stencilOpDepthFail(){return this.opDepthFail}set stencilOpDepthFail(e){this.opDepthFail=e}get stencilOpStencilDepthPass(){return this.opStencilDepthPass}set stencilOpStencilDepthPass(e){this.opStencilDepthPass=e}get stencilMask(){return this.mask}set stencilMask(e){this.mask=e}get stencilTest(){return this.enabled}set stencilTest(e){this.enabled=e}}Dr.ALWAYS=519;Dr.KEEP=7680;Dr.REPLACE=7681;class SA{constructor(){this._blendFunctionParameters=new Array(4),this._blendEquationParameters=new Array(2),this._blendConstants=new Array(4),this._isBlendConstantsDirty=!1,this._alphaBlend=!1,this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this.reset()}get isDirty(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty||this._isBlendEquationParametersDirty}get alphaBlend(){return this._alphaBlend}set alphaBlend(e){this._alphaBlend!==e&&(this._alphaBlend=e,this._isAlphaBlendDirty=!0)}setAlphaBlendConstants(e,t,i,r){this._blendConstants[0]===e&&this._blendConstants[1]===t&&this._blendConstants[2]===i&&this._blendConstants[3]===r||(this._blendConstants[0]=e,this._blendConstants[1]=t,this._blendConstants[2]=i,this._blendConstants[3]=r,this._isBlendConstantsDirty=!0)}setAlphaBlendFunctionParameters(e,t,i,r){this._blendFunctionParameters[0]===e&&this._blendFunctionParameters[1]===t&&this._blendFunctionParameters[2]===i&&this._blendFunctionParameters[3]===r||(this._blendFunctionParameters[0]=e,this._blendFunctionParameters[1]=t,this._blendFunctionParameters[2]=i,this._blendFunctionParameters[3]=r,this._isBlendFunctionParametersDirty=!0)}setAlphaEquationParameters(e,t){this._blendEquationParameters[0]===e&&this._blendEquationParameters[1]===t||(this._blendEquationParameters[0]=e,this._blendEquationParameters[1]=t,this._isBlendEquationParametersDirty=!0)}reset(){this._alphaBlend=!1,this._blendFunctionParameters[0]=null,this._blendFunctionParameters[1]=null,this._blendFunctionParameters[2]=null,this._blendFunctionParameters[3]=null,this._blendEquationParameters[0]=null,this._blendEquationParameters[1]=null,this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1}apply(e){this.isDirty&&(this._isAlphaBlendDirty&&(this._alphaBlend?e.enable(e.BLEND):e.disable(e.BLEND),this._isAlphaBlendDirty=!1),this._isBlendFunctionParametersDirty&&(e.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),this._isBlendFunctionParametersDirty=!1),this._isBlendEquationParametersDirty&&(e.blendEquationSeparate(this._blendEquationParameters[0],this._blendEquationParameters[1]),this._isBlendEquationParametersDirty=!1),this._isBlendConstantsDirty&&(e.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),this._isBlendConstantsDirty=!1))}}class AA{get wrapU(){return this._cachedWrapU}set wrapU(e){this._cachedWrapU=e}get wrapV(){return this._cachedWrapV}set wrapV(e){this._cachedWrapV=e}get wrapR(){return this._cachedWrapR}set wrapR(e){this._cachedWrapR=e}get anisotropicFilteringLevel(){return this._cachedAnisotropicFilteringLevel}set anisotropicFilteringLevel(e){this._cachedAnisotropicFilteringLevel=e}get comparisonFunction(){return this._comparisonFunction}set comparisonFunction(e){this._comparisonFunction=e}get useMipMaps(){return this._useMipMaps}set useMipMaps(e){this._useMipMaps=e}constructor(){this.samplingMode=-1,this._useMipMaps=!0,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this._comparisonFunction=0}setParameters(e=1,t=1,i=1,r=1,s=2,n=0){return this._cachedWrapU=e,this._cachedWrapV=t,this._cachedWrapR=i,this._cachedAnisotropicFilteringLevel=r,this.samplingMode=s,this._comparisonFunction=n,this}compareSampler(e){return this._cachedWrapU===e._cachedWrapU&&this._cachedWrapV===e._cachedWrapV&&this._cachedWrapR===e._cachedWrapR&&this._cachedAnisotropicFilteringLevel===e._cachedAnisotropicFilteringLevel&&this.samplingMode===e.samplingMode&&this._comparisonFunction===e._comparisonFunction&&this._useMipMaps===e._useMipMaps}}var xh;(function(a){a[a.Unknown=0]="Unknown",a[a.Url=1]="Url",a[a.Temp=2]="Temp",a[a.Raw=3]="Raw",a[a.Dynamic=4]="Dynamic",a[a.RenderTarget=5]="RenderTarget",a[a.MultiRenderTarget=6]="MultiRenderTarget",a[a.Cube=7]="Cube",a[a.CubeRaw=8]="CubeRaw",a[a.CubePrefiltered=9]="CubePrefiltered",a[a.Raw3D=10]="Raw3D",a[a.Raw2DArray=11]="Raw2DArray",a[a.DepthStencil=12]="DepthStencil",a[a.CubeRawRGBD=13]="CubeRawRGBD",a[a.Depth=14]="Depth"})(xh||(xh={}));class Yt extends AA{get useMipMaps(){return this.generateMipMaps}set useMipMaps(e){this.generateMipMaps=e}get uniqueId(){return this._uniqueId}_setUniqueId(e){this._uniqueId=e}getEngine(){return this._engine}get source(){return this._source}constructor(e,t,i=!1){super(),this.isReady=!1,this.isCube=!1,this.is3D=!1,this.is2DArray=!1,this.isMultiview=!1,this.url="",this.generateMipMaps=!1,this.samples=0,this.type=-1,this.format=-1,this.onLoadedObservable=new U,this.onErrorObservable=new U,this.onRebuildCallback=null,this.width=0,this.height=0,this.depth=0,this.baseWidth=0,this.baseHeight=0,this.baseDepth=0,this.invertY=!1,this._invertVScale=!1,this._associatedChannel=-1,this._source=0,this._buffer=null,this._bufferView=null,this._bufferViewArray=null,this._bufferViewArrayArray=null,this._size=0,this._extension="",this._files=null,this._workingCanvas=null,this._workingContext=null,this._cachedCoordinatesMode=null,this._isDisabled=!1,this._compression=null,this._sphericalPolynomial=null,this._sphericalPolynomialPromise=null,this._sphericalPolynomialComputed=!1,this._lodGenerationScale=0,this._lodGenerationOffset=0,this._useSRGBBuffer=!1,this._creationFlags=0,this._lodTextureHigh=null,this._lodTextureMid=null,this._lodTextureLow=null,this._isRGBD=!1,this._linearSpecularLOD=!1,this._irradianceTexture=null,this._hardwareTexture=null,this._maxLodLevel=null,this._references=1,this._gammaSpace=null,this._premulAlpha=!1,this._dynamicTextureSource=null,this._autoMSAAManagement=!1,this._engine=e,this._source=t,this._uniqueId=Yt._Counter++,i||(this._hardwareTexture=e._createHardwareTexture())}incrementReferences(){this._references++}updateSize(e,t,i=1){this._engine.updateTextureDimensions(this,e,t,i),this.width=e,this.height=t,this.depth=i,this.baseWidth=e,this.baseHeight=t,this.baseDepth=i,this._size=e*t*i}_rebuild(){if(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this.onRebuildCallback){const t=this.onRebuildCallback(this),i=r=>{r._swapAndDie(this,!1),this.isReady=t.isReady};t.isAsync?t.proxy.then(i):i(t.proxy);return}let e;switch(this.source){case 2:break;case 1:e=this._engine.createTexture(this._originalUrl??this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,t=>{t._swapAndDie(this,!1),this.isReady=!0},null,this._buffer,void 0,this.format,this._extension,void 0,void 0,void 0,this._useSRGBBuffer);return;case 3:e=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type,this._creationFlags,this._useSRGBBuffer),e._swapAndDie(this,!1),this.isReady=!0;break;case 10:e=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),e._swapAndDie(this,!1),this.isReady=!0;break;case 11:e=this._engine.createRawTexture2DArray(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),e._swapAndDie(this,!1),this.isReady=!0;break;case 4:e=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode),e._swapAndDie(this,!1),this._dynamicTextureSource&&this._engine.updateDynamicTexture(this,this._dynamicTextureSource,this.invertY,this._premulAlpha,this.format,!0);break;case 7:e=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,()=>{e._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension,!1,0,0,null,void 0,this._useSRGBBuffer,ArrayBuffer.isView(this._buffer)?this._buffer:null);return;case 8:e=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this._originalFormat??this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),e._swapAndDie(this,!1),this.isReady=!0;break;case 13:return;case 9:e=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,t=>{t&&t._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension),e._sphericalPolynomial=this._sphericalPolynomial;return}}_swapAndDie(e,t=!0){var s;(s=this._hardwareTexture)==null||s.setUsage(e._source,this.generateMipMaps,this.is2DArray,this.isCube,this.is3D,this.width,this.height,this.depth),e._hardwareTexture=this._hardwareTexture,t&&(e._isRGBD=this._isRGBD),this._lodTextureHigh&&(e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(e._lodTextureLow&&e._lodTextureLow.dispose(),e._lodTextureLow=this._lodTextureLow),this._irradianceTexture&&(e._irradianceTexture&&e._irradianceTexture.dispose(),e._irradianceTexture=this._irradianceTexture);const i=this._engine.getLoadedTexturesCache();let r=i.indexOf(this);r!==-1&&i.splice(r,1),r=i.indexOf(e),r===-1&&i.push(e)}dispose(){this._references--,this._references===0&&(this.onLoadedObservable.clear(),this.onErrorObservable.clear(),this._engine._releaseTexture(this),this._hardwareTexture=null,this._dynamicTextureSource=null)}}Yt._Counter=0;const Ta=new Map;function Rr(a,e){RA(a)&&B.Warn(`Extension with the name '${name}' already exists`),Ta.set(a,e)}function RA(a){return Ta.delete(a)}function _m(a,e){(e==="image/ktx"||e==="image/ktx2")&&(a=".ktx"),Ta.has(a)||(a.endsWith(".ies")&&Rr(".ies",()=>X(()=>Promise.resolve().then(()=>sx),void 0,import.meta.url).then(i=>new i._IESTextureLoader)),a.endsWith(".dds")&&Rr(".dds",()=>X(()=>Promise.resolve().then(()=>_I),void 0,import.meta.url).then(i=>new i._DDSTextureLoader)),a.endsWith(".basis")&&Rr(".basis",()=>X(()=>Promise.resolve().then(()=>ux),void 0,import.meta.url).then(i=>new i._BasisTextureLoader)),a.endsWith(".env")&&Rr(".env",()=>X(()=>Promise.resolve().then(()=>xI),void 0,import.meta.url).then(i=>new i._ENVTextureLoader)),a.endsWith(".hdr")&&Rr(".hdr",()=>X(()=>Promise.resolve().then(()=>vx),void 0,import.meta.url).then(i=>new i._HDRTextureLoader)),(a.endsWith(".ktx")||a.endsWith(".ktx2"))&&(Rr(".ktx",()=>X(()=>Promise.resolve().then(()=>Lf),void 0,import.meta.url).then(i=>new i._KTXTextureLoader)),Rr(".ktx2",()=>X(()=>Promise.resolve().then(()=>Lf),void 0,import.meta.url).then(i=>new i._KTXTextureLoader))),a.endsWith(".tga")&&Rr(".tga",()=>X(()=>Promise.resolve().then(()=>Gx),void 0,import.meta.url).then(i=>new i._TGATextureLoader)),a.endsWith(".exr")&&Rr(".exr",()=>X(()=>Promise.resolve().then(()=>b0),void 0,import.meta.url).then(i=>new i._ExrTextureLoader)));const t=Ta.get(a);return t?Promise.resolve(t(e)):null}function pm(a,e){if(Ht()){const{requestAnimationFrame:t}=e||window;if(typeof t=="function")return t(a)}else if(typeof requestAnimationFrame=="function")return requestAnimationFrame(a);return setTimeout(a,16)}class H{get frameId(){return this._frameId}get isWebGPU(){return this._isWebGPU}_getShaderProcessor(e){return this._shaderProcessor}get shaderPlatformName(){return this._shaderPlatformName}_clearEmptyResources(){this._emptyTexture=null,this._emptyCubeTexture=null,this._emptyTexture3D=null,this._emptyTexture2DArray=null}get useReverseDepthBuffer(){return this._useReverseDepthBuffer}set useReverseDepthBuffer(e){e!==this._useReverseDepthBuffer&&(this._useReverseDepthBuffer=e,e?this._depthCullingState.depthFunc=518:this._depthCullingState.depthFunc=515)}setColorWrite(e){e!==this._colorWrite&&(this._colorWriteChanged=!0,this._colorWrite=e)}getColorWrite(){return this._colorWrite}get depthCullingState(){return this._depthCullingState}get alphaState(){return this._alphaState}get stencilState(){return this._stencilState}get stencilStateComposer(){return this._stencilStateComposer}_getGlobalDefines(e){if(e){this.isNDCHalfZRange?e.IS_NDC_HALF_ZRANGE="":delete e.IS_NDC_HALF_ZRANGE,this.useReverseDepthBuffer?e.USE_REVERSE_DEPTHBUFFER="":delete e.USE_REVERSE_DEPTHBUFFER,this.useExactSrgbConversions?e.USE_EXACT_SRGB_CONVERSIONS="":delete e.USE_EXACT_SRGB_CONVERSIONS;return}else{let t="";return this.isNDCHalfZRange&&(t+="#define IS_NDC_HALF_ZRANGE"),this.useReverseDepthBuffer&&(t&&(t+=`
`),t+="#define USE_REVERSE_DEPTHBUFFER"),this.useExactSrgbConversions&&(t&&(t+=`
`),t+="#define USE_EXACT_SRGB_CONVERSIONS"),t}}_rebuildInternalTextures(){const e=this._internalTexturesCache.slice();for(const t of e)t._rebuild()}_rebuildRenderTargetWrappers(){const e=this._renderTargetWrapperCache.slice();for(const t of e)t._rebuild()}_rebuildEffects(){for(const e in this._compiledEffects){const t=this._compiledEffects[e];t._pipelineContext=null,t._prepareEffect()}lt.ResetCache()}_rebuildGraphicsResources(){var e;this.wipeCaches(!0),this._rebuildEffects(),(e=this._rebuildComputeEffects)==null||e.call(this),this._rebuildBuffers(),this._rebuildInternalTextures(),this._rebuildTextures(),this._rebuildRenderTargetWrappers(),this.wipeCaches(!0)}_flagContextRestored(){B.Warn(this.name+" context successfully restored."),this.onContextRestoredObservable.notifyObservers(this),this._contextWasLost=!1}_restoreEngineAfterContextLost(e){setTimeout(async()=>{this._clearEmptyResources();const t=this._depthCullingState.depthTest,i=this._depthCullingState.depthFunc,r=this._depthCullingState.depthMask,s=this._stencilState.stencilTest;await e(),this._rebuildGraphicsResources(),this._depthCullingState.depthTest=t,this._depthCullingState.depthFunc=i,this._depthCullingState.depthMask=r,this._stencilState.stencilTest=s,this._flagContextRestored()},0)}get isDisposed(){return this._isDisposed}get snapshotRendering(){return!1}set snapshotRendering(e){}get snapshotRenderingMode(){return 0}set snapshotRenderingMode(e){}getClassName(){return"AbstractEngine"}get emptyTexture(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1)),this._emptyTexture}get emptyTexture3D(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture3D}get emptyTexture2DArray(){return this._emptyTexture2DArray||(this._emptyTexture2DArray=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture2DArray}get emptyCubeTexture(){if(!this._emptyCubeTexture){const e=new Uint8Array(4),t=[e,e,e,e,e,e];this._emptyCubeTexture=this.createRawCubeTexture(t,1,5,0,!1,!1,1)}return this._emptyCubeTexture}get activeRenderLoops(){return this._activeRenderLoops}stopRenderLoop(e){if(!e){this._activeRenderLoops.length=0,this._cancelFrame();return}const t=this._activeRenderLoops.indexOf(e);t>=0&&(this._activeRenderLoops.splice(t,1),this._activeRenderLoops.length==0&&this._cancelFrame())}_cancelFrame(){if(this._frameHandler!==0){const e=this._frameHandler;if(this._frameHandler=0,Ht()){const{cancelAnimationFrame:t}=this.getHostWindow()||window;if(typeof t=="function")return t(e)}else if(typeof cancelAnimationFrame=="function")return cancelAnimationFrame(e);return clearTimeout(e)}}beginFrame(){this.onBeginFrameObservable.notifyObservers(this)}endFrame(){this._frameId++,this.onEndFrameObservable.notifyObservers(this)}get maxFPS(){return this._maxFPS}set maxFPS(e){if(this._maxFPS=e,e!==void 0){if(e<=0){this._minFrameTime=Number.MAX_VALUE;return}this._minFrameTime=1e3/(e+1)}}_isOverFrameTime(e){if(!e)return!1;const t=e-this._lastFrameTime;return this._maxFPS===void 0||t>=this._minFrameTime?(this._lastFrameTime=e,!1):!0}_processFrame(e){if(this._frameHandler=0,!this._contextWasLost&&!this._isOverFrameTime(e)){let t=!0;(this.isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(t=!1),t&&(this.beginFrame(),!this.skipFrameRender&&!this._renderViews()&&this._renderFrame(),this.endFrame())}}_renderLoop(e){this._processFrame(e),this._activeRenderLoops.length>0&&this._frameHandler===0&&(this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()))}_renderFrame(){for(let e=0;e<this._activeRenderLoops.length;e++){const t=this._activeRenderLoops[e];t()}}_renderViews(){return!1}_queueNewFrame(e,t){return pm(e,t)}runRenderLoop(e){this._activeRenderLoops.indexOf(e)===-1&&(this._activeRenderLoops.push(e),this._activeRenderLoops.length===1&&this._frameHandler===0&&(this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow())))}getDepthBuffer(){return this._depthCullingState.depthTest}setDepthBuffer(e){this._depthCullingState.depthTest=e}setZOffset(e){this._depthCullingState.zOffset=this.useReverseDepthBuffer?-e:e}getZOffset(){const e=this._depthCullingState.zOffset;return this.useReverseDepthBuffer?-e:e}setZOffsetUnits(e){this._depthCullingState.zOffsetUnits=this.useReverseDepthBuffer?-e:e}getZOffsetUnits(){const e=this._depthCullingState.zOffsetUnits;return this.useReverseDepthBuffer?-e:e}getHostWindow(){return Ht()?this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=!0}_rebuildTextures(){for(const e of this.scenes)e._rebuildTextures();for(const e of this._virtualScenes)e._rebuildTextures()}_releaseRenderTargetWrapper(e){const t=this._renderTargetWrapperCache.indexOf(e);t!==-1&&this._renderTargetWrapperCache.splice(t,1)}get currentViewport(){return this._cachedViewport}setViewport(e,t,i){const r=t||this.getRenderWidth(),s=i||this.getRenderHeight(),n=e.x||0,o=e.y||0;this._cachedViewport=e,this._viewport(n*r,o*s,r*e.width,s*e.height)}createCanvasImage(){return document.createElement("img")}createCanvasPath2D(e){return new Path2D(e)}get description(){let e=this.name+this.version;return this._caps.parallelShaderCompile&&(e+=" - Parallel shader compilation"),e}_createTextureBase(e,t,i,r,s=3,n=null,o=null,l,c,h=null,f=null,u=null,d=null,_,p,g){e=e||"";const E=e.substr(0,5)==="data:",v=e.substr(0,5)==="blob:",b=E&&e.indexOf(";base64,")!==-1,R=f||new Yt(this,1);R!==f&&(R.label=e.substring(0,60));const S=e;this._transformTextureUrl&&!b&&!f&&!h&&(e=this._transformTextureUrl(e)),S!==e&&(R._originalUrl=S);const T=e.lastIndexOf(".");let I=d||(T>-1?e.substring(T).toLowerCase():"");I.indexOf("?")>-1&&(I=I.split("?")[0]);const L=_m(I,_);r&&r.addPendingData(R),R.url=e,R.generateMipMaps=!t,R.samplingMode=s,R.invertY=i,R._useSRGBBuffer=this._getUseSRGBBuffer(!!g,t),this._doNotHandleContextLost||(R._buffer=h);let w=null;n&&!f&&(w=R.onLoadedObservable.add(n)),f||this._internalTexturesCache.push(R);const $=(J,ce)=>{r&&r.removePendingData(R),e===S?(w&&R.onLoadedObservable.remove(w),Re.UseFallbackTexture&&e!==Re.FallbackTexture&&this._createTextureBase(Re.FallbackTexture,t,R.invertY,r,s,null,o,l,c,h,R),J=(J||"Unknown error")+(Re.UseFallbackTexture?" - Fallback texture was used":""),R.onErrorObservable.notifyObservers({message:J,exception:ce}),o&&o(J,ce)):(B.Warn(`Failed to load ${e}, falling back to ${S}`),this._createTextureBase(S,t,R.invertY,r,s,n,o,l,c,h,R,u,d,_,p,g))};if(L){const J=async ce=>{(await L).loadData(ce,R,(oe,ue,Pe,Se,ie,K)=>{K?$("TextureLoader failed to load data"):l(R,I,r,{width:oe,height:ue},R.invertY,!Pe,Se,()=>(ie(),!1),s)},p)};h?h instanceof ArrayBuffer?J(new Uint8Array(h)):ArrayBuffer.isView(h)?J(h):o&&o("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this._loadFile(e,ce=>J(new Uint8Array(ce)),void 0,r?r.offlineProvider:void 0,!0,(ce,le)=>{$("Unable to load "+(ce&&ce.responseURL,le))})}else{const J=ce=>{v&&!this._doNotHandleContextLost&&(R._buffer=ce),l(R,I,r,ce,R.invertY,t,!1,c,s)};!E||b?h&&(typeof h.decoding=="string"||h.close)?J(h):H._FileToolsLoadImage(e||"",J,$,r?r.offlineProvider:null,_,R.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0,this):typeof h=="string"||h instanceof ArrayBuffer||ArrayBuffer.isView(h)||h instanceof Blob?H._FileToolsLoadImage(h,J,$,r?r.offlineProvider:null,_,R.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0,this):h&&J(h)}return R}_rebuildBuffers(){for(const e of this._uniformBuffers)e._rebuildAfterContextLost()}get _shouldUseHighPrecisionShader(){return!!(this._caps.highPrecisionShaderSupported&&this._highPrecisionShadersAllowed)}getHostDocument(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:pn()?document:null}getLoadedTexturesCache(){return this._internalTexturesCache}clearInternalTexturesCache(){this._internalTexturesCache.length=0}getCaps(){return this._caps}resetTextureCache(){for(const e in this._boundTexturesCache)Object.prototype.hasOwnProperty.call(this._boundTexturesCache,e)&&(this._boundTexturesCache[e]=null);this._currentTextureChannel=-1}get name(){return this._name}set name(e){this._name=e}static get NpmPackage(){return"babylonjs@7.54.3"}static get Version(){return"7.54.3"}getRenderingCanvas(){return this._renderingCanvas}getAudioContext(){return this._audioContext}getAudioDestination(){return this._audioDestination}setHardwareScalingLevel(e){this._hardwareScalingLevel=e,this.resize()}getHardwareScalingLevel(){return this._hardwareScalingLevel}get doNotHandleContextLost(){return this._doNotHandleContextLost}set doNotHandleContextLost(e){this._doNotHandleContextLost=e}get isStencilEnable(){return this._isStencilEnable}getCreationOptions(){return this._creationOptions}constructor(e,t,i){var n,o;this._colorWrite=!0,this._colorWriteChanged=!0,this._depthCullingState=new vA,this._stencilStateComposer=new TA,this._stencilState=new Dr,this._alphaState=new SA,this._alphaMode=1,this._alphaEquation=0,this._activeRequests=[],this._badOS=!1,this._badDesktopOS=!1,this._compatibilityMode=!0,this._internalTexturesCache=new Array,this._currentRenderTarget=null,this._boundTexturesCache={},this._activeChannel=0,this._currentTextureChannel=-1,this._viewportCached={x:0,y:0,z:0,w:0},this._isWebGPU=!1,this.onCanvasBlurObservable=new U,this.onCanvasFocusObservable=new U,this.onNewSceneAddedObservable=new U,this.onResizeObservable=new U,this.onCanvasPointerOutObservable=new U,this.onEffectErrorObservable=new U,this.disablePerformanceMonitorInBackground=!1,this.disableVertexArrayObjects=!1,this._frameId=0,this.hostInformation={isMobile:!1},this.isFullscreen=!1,this.enableOfflineSupport=!1,this.disableManifestCheck=!1,this.disableContextMenu=!0,this.currentRenderPassId=0,this.isPointerLock=!1,this.postProcesses=[],this.canvasTabIndex=1,this._contextWasLost=!1,this._useReverseDepthBuffer=!1,this.isNDCHalfZRange=!1,this.hasOriginBottomLeft=!0,this._renderTargetWrapperCache=new Array,this._compiledEffects={},this._isDisposed=!1,this.scenes=[],this._virtualScenes=new Array,this.onBeforeTextureInitObservable=new U,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this._frameHandler=0,this._activeRenderLoops=new Array,this._windowIsBackground=!1,this._boundRenderFunction=l=>this._renderLoop(l),this._lastFrameTime=0,this.skipFrameRender=!1,this.onBeforeShaderCompilationObservable=new U,this.onAfterShaderCompilationObservable=new U,this.onBeginFrameObservable=new U,this.onEndFrameObservable=new U,this._transformTextureUrl=null,this._uniformBuffers=new Array,this._storageBuffers=new Array,this._highPrecisionShadersAllowed=!0,this.onContextLostObservable=new U,this.onContextRestoredObservable=new U,this._name="",this.premultipliedAlpha=!0,this.adaptToDeviceRatio=!1,this._lastDevicePixelRatio=1,this._doNotHandleContextLost=!1,this.cullBackFaces=null,this._renderPassNames=["main"],this._fps=60,this._deltaTime=0,this._deterministicLockstep=!1,this._lockstepMaxSteps=4,this._timeStep=1/60,this.onDisposeObservable=new U,this.onReleaseEffectsObservable=new U,Re.Instances.push(this),this.startTime=Ti.Now,this._stencilStateComposer.stencilGlobal=this._stencilState,Xt.SetMatrixPrecision(!!t.useHighPrecisionMatrix),ks()&&navigator.userAgent&&(this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)),this.adaptToDeviceRatio=i??!1,t.antialias=e??t.antialias,t.deterministicLockstep=t.deterministicLockstep??!1,t.lockstepMaxSteps=t.lockstepMaxSteps??4,t.timeStep=t.timeStep??1/60,t.stencil=t.stencil??!0,this._audioContext=((n=t.audioEngineOptions)==null?void 0:n.audioContext)??null,this._audioDestination=((o=t.audioEngineOptions)==null?void 0:o.audioDestination)??null,this.premultipliedAlpha=t.premultipliedAlpha??!0,this._doNotHandleContextLost=!!t.doNotHandleContextLost,this._isStencilEnable=!!t.stencil,this.useExactSrgbConversions=t.useExactSrgbConversions??!1;const r=Ht()&&window.devicePixelRatio||1,s=t.limitDeviceRatio||r;i=i||t.adaptToDeviceRatio||!1,this._hardwareScalingLevel=i?1/Math.min(s,r):1,this._lastDevicePixelRatio=r,this._creationOptions=t}resize(e=!1){var r,s;let t,i;if(this.adaptToDeviceRatio){const n=Ht()&&window.devicePixelRatio||1,o=this._lastDevicePixelRatio/n;this._lastDevicePixelRatio=n,this._hardwareScalingLevel*=o}if(Ht()&&pn())if(this._renderingCanvas){const n=(s=(r=this._renderingCanvas).getBoundingClientRect)==null?void 0:s.call(r);t=this._renderingCanvas.clientWidth||(n==null?void 0:n.width)||this._renderingCanvas.width*this._hardwareScalingLevel||100,i=this._renderingCanvas.clientHeight||(n==null?void 0:n.height)||this._renderingCanvas.height*this._hardwareScalingLevel||100}else t=window.innerWidth,i=window.innerHeight;else t=this._renderingCanvas?this._renderingCanvas.width:100,i=this._renderingCanvas?this._renderingCanvas.height:100;this.setSize(t/this._hardwareScalingLevel,i/this._hardwareScalingLevel,e)}setSize(e,t,i=!1){if(!this._renderingCanvas||(e=e|0,t=t|0,!i&&this._renderingCanvas.width===e&&this._renderingCanvas.height===t))return!1;if(this._renderingCanvas.width=e,this._renderingCanvas.height=t,this.scenes){for(let r=0;r<this.scenes.length;r++){const s=this.scenes[r];for(let n=0;n<s.cameras.length;n++){const o=s.cameras[n];o._currentRenderId=0}}this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this)}return!0}createRawTexture(e,t,i,r,s,n,o,l,c,h,f){throw Le("engine.rawTexture")}createRawCubeTexture(e,t,i,r,s,n,o,l){throw Le("engine.rawTexture")}createRawTexture3D(e,t,i,r,s,n,o,l,c,h,f){throw Le("engine.rawTexture")}createRawTexture2DArray(e,t,i,r,s,n,o,l,c,h,f){throw Le("engine.rawTexture")}_sharedInit(e){this._renderingCanvas=e}_setupMobileChecks(){navigator&&navigator.userAgent&&(this._checkForMobile=()=>{const e=navigator.userAgent;this.hostInformation.isMobile=e.indexOf("Mobile")!==-1||e.indexOf("Mac")!==-1&&pn()&&"ontouchend"in document},this._checkForMobile(),Ht()&&window.addEventListener("resize",this._checkForMobile))}createVideoElement(e){return document.createElement("video")}_reportDrawCall(e=1){var t;(t=this._drawCalls)==null||t.addCount(e,!1)}getFps(){return this._fps}getDeltaTime(){return this._deltaTime}isDeterministicLockStep(){return this._deterministicLockstep}getLockstepMaxSteps(){return this._lockstepMaxSteps}getTimeStep(){return this._timeStep*1e3}_createImageBitmapFromSource(e,t){throw new Error("createImageBitmapFromSource is not implemented")}createImageBitmap(e,t){return createImageBitmap(e,t)}resizeImageBitmap(e,t,i){throw new Error("resizeImageBitmap is not implemented")}getFontOffset(e){throw new Error("getFontOffset is not implemented")}static _CreateCanvas(e,t){if(typeof document>"u")return new OffscreenCanvas(e,t);const i=document.createElement("canvas");return i.width=e,i.height=t,i}createCanvas(e,t){return H._CreateCanvas(e,t)}static _FileToolsLoadImage(e,t,i,r,s,n,o){throw Le("FileTools")}_loadFile(e,t,i,r,s,n){const o=lm(e,t,i,r,s,n);return this._activeRequests.push(o),o.onCompleteObservable.add(()=>{const l=this._activeRequests.indexOf(o);l!==-1&&this._activeRequests.splice(l,1)}),o}static _FileToolsLoadFile(e,t,i,r,s,n){if(ga.loadFile)return ga.loadFile(e,t,i,r,s,n);throw Le("FileTools")}dispose(){var t;for(this.releaseEffects(),this._isDisposed=!0,this.stopRenderLoop(),this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._renderingCanvas=null,this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(;this.scenes.length;)this.scenes[0].dispose();for(;this._virtualScenes.length;)this._virtualScenes[0].dispose();(t=this.releaseComputeEffects)==null||t.call(this),lt.ResetCache();for(const i of this._activeRequests)i.abort();this._boundRenderFunction=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onNewSceneAddedObservable.clear(),this.onEffectErrorObservable.clear(),Ht()&&window.removeEventListener("resize",this._checkForMobile);const e=Re.Instances.indexOf(this);e>=0&&Re.Instances.splice(e,1),Re.Instances.length||(Re.OnEnginesDisposedObservable.notifyObservers(this),Re.OnEnginesDisposedObservable.clear()),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear()}static DefaultLoadingScreenFactory(e){throw Le("LoadingScreen")}static MarkAllMaterialsAsDirty(e,t){for(let i=0;i<Re.Instances.length;i++){const r=Re.Instances[i];for(let s=0;s<r.scenes.length;s++)r.scenes[s].markAllMaterialsAsDirty(e,t)}}}H._RenderPassIdCounter=0;H._RescalePostProcessFactory=null;H.CollisionsEpsilon=.001;H.QueueNewFrame=pm;const mm=new RegExp(/^data:([^,]+\/[^,]+)?;base64,/i);class Sa extends Ur{constructor(e,t){super(e,bs.LoadFileError),this.name="LoadFileError",Zs._setPrototypeOf(this,Sa.prototype),t instanceof Gt?this.request=t:this.file=t}}class Aa extends Ur{constructor(e,t){super(e,bs.RequestFileError),this.request=t,this.name="RequestFileError",Zs._setPrototypeOf(this,Aa.prototype)}}class uc extends Ur{constructor(e,t){super(e,bs.ReadFileError),this.file=t,this.name="ReadFileError",Zs._setPrototypeOf(this,uc.prototype)}}const CA=a=>(a=a.replace(/#/gm,"%23"),a),yt={DefaultRetryStrategy:GS.ExponentialBackoff(),BaseUrl:"",CorsBehavior:"anonymous",PreprocessUrl:a=>a,ScriptBaseUrl:"",ScriptPreprocessUrl:a=>a,CleanUrl:CA},dc=(a,e)=>{if(!(a&&a.indexOf("data:")===0)&&yt.CorsBehavior)if(typeof yt.CorsBehavior=="string"||yt.CorsBehavior instanceof String)e.crossOrigin=yt.CorsBehavior;else{const t=yt.CorsBehavior(a);t&&(e.crossOrigin=t)}},La=(a,e,t,i,r="",s,n=Re.LastCreatedEngine)=>{if(typeof HTMLImageElement>"u"&&!(n!=null&&n._features.forceBitmapOverHTMLImageElement))return t("LoadImage is only supported in web or BabylonNative environments."),null;let o,l=!1;a instanceof ArrayBuffer||ArrayBuffer.isView(a)?typeof Blob<"u"&&typeof URL<"u"?(o=URL.createObjectURL(new Blob([a],{type:r})),l=!0):o=`data:${r};base64,`+nm(a):a instanceof Blob?(o=URL.createObjectURL(a),l=!0):(o=yt.CleanUrl(a),o=yt.PreprocessUrl(o));const c=S=>{if(t){const T=o||a.toString();t(`Error while trying to load image: ${T.indexOf("http")===0||T.length<=128?T:T.slice(0,128)+"..."}`,S)}};if(n!=null&&n._features.forceBitmapOverHTMLImageElement)return Jr(o,S=>{n.createImageBitmap(new Blob([S],{type:r}),{premultiplyAlpha:"none",...s}).then(T=>{e(T),l&&URL.revokeObjectURL(o)}).catch(T=>{t&&t("Error while trying to load image: "+a,T)})},void 0,i||void 0,!0,(S,T)=>{c(T)}),null;const h=new Image;dc(o,h);const f=[],u=()=>{f.forEach(S=>{S.target.addEventListener(S.name,S.handler)})},d=()=>{f.forEach(S=>{S.target.removeEventListener(S.name,S.handler)}),f.length=0},_=()=>{d(),e(h),l&&h.src&&URL.revokeObjectURL(h.src)},p=S=>{d(),c(S),l&&h.src&&URL.revokeObjectURL(h.src)},g=S=>{if(S.blockedURI!==h.src||S.disposition==="report")return;d();const T=new Error(`CSP violation of policy ${S.effectiveDirective} ${S.blockedURI}. Current policy is ${S.originalPolicy}`);Re.UseFallbackTexture=!1,c(T),l&&h.src&&URL.revokeObjectURL(h.src),h.src=""};f.push({target:h,name:"load",handler:_}),f.push({target:h,name:"error",handler:p}),f.push({target:document,name:"securitypolicyviolation",handler:g}),u();const E=o.substring(0,5)==="blob:",v=o.substring(0,5)==="data:",b=()=>{E||v||!Gt.IsCustomRequestAvailable?h.src=o:Jr(o,(S,T,I)=>{const O=!r&&I?I:r,L=new Blob([S],{type:O}),w=URL.createObjectURL(L);l=!0,h.src=w},void 0,i||void 0,!0,(S,T)=>{c(T)})},R=()=>{i&&i.loadImage(o,h)};if(!E&&!v&&i&&i.enableTexturesOffline)i.open(R,b);else{if(o.indexOf("file:")!==-1){const S=decodeURIComponent(o.substring(5).toLowerCase());if(mn.FilesToLoad[S]&&typeof URL<"u"){try{let T;try{T=URL.createObjectURL(mn.FilesToLoad[S])}catch{T=URL.createObjectURL(mn.FilesToLoad[S])}h.src=T,l=!0}catch{h.src=""}return h}}b()}return h},Sn=(a,e,t,i,r)=>{const s=new FileReader,n={onCompleteObservable:new U,abort:()=>s.abort()};return s.onloadend=()=>n.onCompleteObservable.notifyObservers(n),r&&(s.onerror=()=>{r(new uc(`Unable to read ${a.name}`,a))}),s.onload=o=>{e(o.target.result)},t&&(s.onprogress=t),i?s.readAsArrayBuffer(a):s.readAsText(a),n},Jr=(a,e,t,i,r,s,n)=>{if(a.name)return Sn(a,e,t,r,s?h=>{s(void 0,h)}:void 0);const o=a;if(o.indexOf("file:")!==-1){let h=decodeURIComponent(o.substring(5).toLowerCase());h.indexOf("./")===0&&(h=h.substring(2));const f=mn.FilesToLoad[h];if(f)return Sn(f,e,t,r,s?u=>s(void 0,new Sa(u.message,u.file)):void 0)}const{match:l,type:c}=IA(o);if(l){const h={onCompleteObservable:new U,abort:()=>()=>{}};try{const f=r?mc(o):Em(o);e(f,void 0,c)}catch(f){s?s(void 0,f):B.Error(f.message||"Failed to parse the Data URL")}return vs.SetImmediate(()=>{h.onCompleteObservable.notifyObservers(h)}),h}return _c(o,(h,f)=>{e(h,f==null?void 0:f.responseURL,f==null?void 0:f.getResponseHeader("content-type"))},t,i,r,s?h=>{s(h.request,new Sa(h.message,h.request))}:void 0,n)},_c=(a,e,t,i,r,s,n)=>{a=yt.CleanUrl(a),a=yt.PreprocessUrl(a);const o=yt.BaseUrl+a;let l=!1;const c={onCompleteObservable:new U,abort:()=>l=!0},h=()=>{let f=new Gt,u=null,d;const _=()=>{f&&(t&&f.removeEventListener("progress",t),d&&f.removeEventListener("readystatechange",d),f.removeEventListener("loadend",p))};let p=()=>{_(),c.onCompleteObservable.notifyObservers(c),c.onCompleteObservable.clear(),t=void 0,d=null,p=null,s=void 0,n=void 0,e=void 0};c.abort=()=>{l=!0,p&&p(),f&&f.readyState!==(XMLHttpRequest.DONE||4)&&f.abort(),u!==null&&(clearTimeout(u),u=null),f=null};const g=v=>{const b=v.message||"Unknown error";s&&f?s(new Aa(b,f)):B.Error(b)},E=v=>{if(f){if(f.open("GET",o),n)try{n(f)}catch(b){g(b);return}r&&(f.responseType="arraybuffer"),t&&f.addEventListener("progress",t),p&&f.addEventListener("loadend",p),d=()=>{if(!(l||!f)&&f.readyState===(XMLHttpRequest.DONE||4)){if(d&&f.removeEventListener("readystatechange",d),f.status>=200&&f.status<300||f.status===0&&(!Ht()||gm())){const S=r?f.response:f.responseText;if(S!==null){try{e&&e(S,f)}catch(T){g(T)}return}}const b=yt.DefaultRetryStrategy;if(b){const S=b(o,f,v);if(S!==-1){_(),f=new Gt,u=setTimeout(()=>E(v+1),S);return}}const R=new Aa("Error status: "+f.status+" "+f.statusText+" - Unable to load "+o,f);s&&s(R)}},f.addEventListener("readystatechange",d),f.send()}};E(0)};if(i&&i.enableSceneOffline){const f=d=>{d&&d.status>400?s&&s(d):h()},u=()=>{i&&i.loadFile(yt.BaseUrl+a,d=>{!l&&e&&e(d),c.onCompleteObservable.notifyObservers(c)},t?d=>{!l&&t&&t(d)}:void 0,f,r)};i.open(u,f)}else h();return c},gm=()=>typeof location<"u"&&location.protocol==="file:",pc=a=>mm.test(a),IA=a=>{const e=mm.exec(a);return e===null||e.length===0?{match:!1,type:""}:{match:!0,type:e[0].replace("data:","").replace("base64,","")}};function mc(a){return WS(a.split(",")[1])}const Em=a=>am(a.split(",")[1]),bA=()=>{H._FileToolsLoadImage=La,ga.loadFile=Jr,hm.loadFile=Jr};bA();let dn;const xA=(a,e,t,i,r,s,n,o,l,c)=>{dn={DecodeBase64UrlToBinary:a,DecodeBase64UrlToString:e,DefaultRetryStrategy:t.DefaultRetryStrategy,BaseUrl:t.BaseUrl,CorsBehavior:t.CorsBehavior,PreprocessUrl:t.PreprocessUrl,IsBase64DataUrl:i,IsFileURL:r,LoadFile:s,LoadImage:n,ReadFile:o,RequestFile:l,SetCorsBehavior:c},Object.defineProperty(dn,"DefaultRetryStrategy",{get:function(){return t.DefaultRetryStrategy},set:function(h){t.DefaultRetryStrategy=h}}),Object.defineProperty(dn,"BaseUrl",{get:function(){return t.BaseUrl},set:function(h){t.BaseUrl=h}}),Object.defineProperty(dn,"PreprocessUrl",{get:function(){return t.PreprocessUrl},set:function(h){t.PreprocessUrl=h}}),Object.defineProperty(dn,"CorsBehavior",{get:function(){return t.CorsBehavior},set:function(h){t.CorsBehavior=h}})};xA(mc,Em,yt,pc,gm,Jr,La,Sn,_c,dc);const vm={};function Y(a,e){vm[a]=e}function Ui(a){return vm[a]}class gn{static Instantiate(e){if(this.RegisteredExternalClasses&&this.RegisteredExternalClasses[e])return this.RegisteredExternalClasses[e];const t=Ui(e);if(t)return t;B.Warn(e+" not found, you may have missed an import.");const i=e.split(".");let r=window||this;for(let s=0,n=i.length;s<n;s++)r=r[i[s]];return typeof r!="function"?null:r}}gn.RegisteredExternalClasses={};function xs(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{const e=Math.random()*16|0;return(a==="x"?e:e&3|8).toString(16)})}function An(a){let e=1;do e*=2;while(e<a);return e===a}function sl(a,e,t){return a*(1-t)+e*t}function Tm(a){const e=Sm(a),t=gc(a);return e-a>a-t?t:e}function Sm(a){return a--,a|=a>>1,a|=a>>2,a|=a>>4,a|=a>>8,a|=a>>16,a++,a}function gc(a){return a=a|a>>1,a=a|a>>2,a=a|a>>4,a=a|a>>8,a=a|a>>16,a-(a>>1)}function Ts(a,e,t=2){let i;switch(t){case 1:i=gc(a);break;case 2:i=Tm(a);break;case 3:default:i=Sm(a);break}return Math.min(i,e)}class k{static get BaseUrl(){return yt.BaseUrl}static set BaseUrl(e){yt.BaseUrl=e}static get CleanUrl(){return yt.CleanUrl}static set CleanUrl(e){yt.CleanUrl=e}static IsAbsoluteUrl(e){return e.indexOf("//")===0?!0:e.indexOf("://")===-1||e.indexOf(".")===-1||e.indexOf("/")===-1||e.indexOf(":")>e.indexOf("/")?!1:e.indexOf("://")<e.indexOf(".")||e.indexOf("data:")===0||e.indexOf("blob:")===0}static set ScriptBaseUrl(e){yt.ScriptBaseUrl=e}static get ScriptBaseUrl(){return yt.ScriptBaseUrl}static set CDNBaseUrl(e){k.ScriptBaseUrl=e,k.AssetBaseUrl=e}static set ScriptPreprocessUrl(e){yt.ScriptPreprocessUrl=e}static get ScriptPreprocessUrl(){return yt.ScriptPreprocessUrl}static get DefaultRetryStrategy(){return yt.DefaultRetryStrategy}static set DefaultRetryStrategy(e){yt.DefaultRetryStrategy=e}static get CorsBehavior(){return yt.CorsBehavior}static set CorsBehavior(e){yt.CorsBehavior=e}static get UseFallbackTexture(){return Re.UseFallbackTexture}static set UseFallbackTexture(e){Re.UseFallbackTexture=e}static get RegisteredExternalClasses(){return gn.RegisteredExternalClasses}static set RegisteredExternalClasses(e){gn.RegisteredExternalClasses=e}static get fallbackTexture(){return Re.FallbackTexture}static set fallbackTexture(e){Re.FallbackTexture=e}static FetchToRef(e,t,i,r,s,n){const o=Math.abs(e)*i%i|0,l=Math.abs(t)*r%r|0,c=(o+l*i)*4;n.r=s[c]/255,n.g=s[c+1]/255,n.b=s[c+2]/255,n.a=s[c+3]/255}static Mix(e,t,i){return 0}static Instantiate(e){return gn.Instantiate(e)}static SetImmediate(e){vs.SetImmediate(e)}static IsExponentOfTwo(e){return!0}static FloatRound(e){return Math.fround(e)}static GetFilename(e){const t=e.lastIndexOf("/");return t<0?e:e.substring(t+1)}static GetFolderPath(e,t=!1){const i=e.lastIndexOf("/");return i<0?t?e:"":e.substring(0,i+1)}static ToDegrees(e){return e*180/Math.PI}static ToRadians(e){return e*Math.PI/180}static SmoothAngleChange(e,t,i=.9){const r=this.ToRadians(e),s=this.ToRadians(t);return this.ToDegrees(Math.atan2((1-i)*Math.sin(s)+i*Math.sin(r),(1-i)*Math.cos(s)+i*Math.cos(r)))}static MakeArray(e,t){return t!==!0&&(e===void 0||e==null)?null:Array.isArray(e)?e:[e]}static GetPointerPrefix(e){return Ht()&&!window.PointerEvent?"mouse":"pointer"}static SetCorsBehavior(e,t){dc(e,t)}static SetReferrerPolicyBehavior(e,t){t.referrerPolicy=e}static get PreprocessUrl(){return yt.PreprocessUrl}static set PreprocessUrl(e){yt.PreprocessUrl=e}static LoadImage(e,t,i,r,s,n){return La(e,t,i,r,s,n)}static LoadFile(e,t,i,r,s,n){return Jr(e,t,i,r,s,n)}static LoadFileAsync(e,t=!0){return new Promise((i,r)=>{Jr(e,s=>{i(s)},void 0,void 0,t,(s,n)=>{r(n)})})}static GetAssetUrl(e){if(!e)return"";if(k.AssetBaseUrl&&e.startsWith(k._DefaultAssetsUrl)){const t=k.AssetBaseUrl[k.AssetBaseUrl.length-1]==="/"?k.AssetBaseUrl.substring(0,k.AssetBaseUrl.length-1):k.AssetBaseUrl;return e.replace(k._DefaultAssetsUrl,t)}return e}static GetBabylonScriptURL(e,t){if(!e)return"";if(k.ScriptBaseUrl&&e.startsWith(k._DefaultCdnUrl)){const i=k.ScriptBaseUrl[k.ScriptBaseUrl.length-1]==="/"?k.ScriptBaseUrl.substring(0,k.ScriptBaseUrl.length-1):k.ScriptBaseUrl;e=e.replace(k._DefaultCdnUrl,i)}return e=k.ScriptPreprocessUrl(e),t&&(e=k.GetAbsoluteUrl(e)),e}static LoadBabylonScript(e,t,i,r){e=k.GetBabylonScriptURL(e),k.LoadScript(e,t,i)}static LoadBabylonScriptAsync(e){return e=k.GetBabylonScriptURL(e),k.LoadScriptAsync(e)}static LoadScript(e,t,i,r,s=!1){if(typeof importScripts=="function"){try{importScripts(e),t&&t()}catch(l){i==null||i(`Unable to load script '${e}' in worker`,l)}return}else if(!Ht()){i==null||i(`Cannot load script '${e}' outside of a window or a worker`);return}const n=document.getElementsByTagName("head")[0],o=document.createElement("script");s?(o.setAttribute("type","module"),o.innerText=e):(o.setAttribute("type","text/javascript"),o.setAttribute("src",e)),r&&(o.id=r),o.onload=()=>{t&&t()},o.onerror=l=>{i&&i(`Unable to load script '${e}'`,l)},n.appendChild(o)}static LoadScriptAsync(e,t){return new Promise((i,r)=>{this.LoadScript(e,()=>{i()},(s,n)=>{r(n||new Error(s))},t)})}static ReadFileAsDataURL(e,t,i){const r=new FileReader,s={onCompleteObservable:new U,abort:()=>r.abort()};return r.onloadend=()=>{s.onCompleteObservable.notifyObservers(s)},r.onload=n=>{t(n.target.result)},r.onprogress=i,r.readAsDataURL(e),s}static ReadFile(e,t,i,r,s){return Sn(e,t,i,r,s)}static FileAsURL(e){const t=new Blob([e]);return window.URL.createObjectURL(t)}static Format(e,t=2){return e.toFixed(t)}static DeepCopy(e,t,i,r){Da.DeepCopy(e,t,i,r)}static IsEmpty(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}static RegisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){const r=t[i];e.addEventListener(r.name,r.handler,!1);try{window.parent&&window.parent.addEventListener(r.name,r.handler,!1)}catch{}}}static UnregisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){const r=t[i];e.removeEventListener(r.name,r.handler);try{e.parent&&e.parent.removeEventListener(r.name,r.handler)}catch{}}}static async DumpFramebuffer(e,t,i,r,s="image/png",n,o){throw Le("DumpTools")}static DumpData(e,t,i,r,s="image/png",n,o=!1,l=!1,c){throw Le("DumpTools")}static DumpDataAsync(e,t,i,r="image/png",s,n=!1,o=!1,l){throw Le("DumpTools")}static _IsOffScreenCanvas(e){return e.convertToBlob!==void 0}static ToBlob(e,t,i="image/png",r){!k._IsOffScreenCanvas(e)&&!e.toBlob&&(e.toBlob=function(s,n,o){setTimeout(()=>{const l=atob(this.toDataURL(n,o).split(",")[1]),c=l.length,h=new Uint8Array(c);for(let f=0;f<c;f++)h[f]=l.charCodeAt(f);s(new Blob([h]))})}),k._IsOffScreenCanvas(e)?e.convertToBlob({type:i,quality:r}).then(s=>t(s)):e.toBlob(function(s){t(s)},i,r)}static DownloadBlob(e,t){if("download"in document.createElement("a")){if(!t){const i=new Date;t="screenshot_"+((i.getFullYear()+"-"+(i.getMonth()+1)).slice(2)+"-"+i.getDate()+"_"+i.getHours()+"-"+("0"+i.getMinutes()).slice(-2))+".png"}k.Download(e,t)}else if(e&&typeof URL<"u"){const i=URL.createObjectURL(e),r=window.open("");if(!r)return;const s=r.document.createElement("img");s.onload=function(){URL.revokeObjectURL(i)},s.src=i,r.document.body.appendChild(s)}}static EncodeScreenshotCanvasData(e,t,i="image/png",r,s){if(typeof r=="string"||!t)this.ToBlob(e,function(n){n&&k.DownloadBlob(n,r),t&&t("")},i,s);else if(t){if(k._IsOffScreenCanvas(e)){e.convertToBlob({type:i,quality:s}).then(o=>{const l=new FileReader;l.readAsDataURL(o),l.onloadend=()=>{const c=l.result;t(c)}});return}const n=e.toDataURL(i,s);t(n)}}static Download(e,t){if(typeof URL>"u")return;const i=window.URL.createObjectURL(e),r=document.createElement("a");document.body.appendChild(r),r.style.display="none",r.href=i,r.download=t,r.addEventListener("click",()=>{r.parentElement&&r.parentElement.removeChild(r)}),r.click(),window.URL.revokeObjectURL(i)}static BackCompatCameraNoPreventDefault(e){return typeof e[0]=="boolean"?e[0]:typeof e[1]=="boolean"?e[1]:!1}static CreateScreenshot(e,t,i,r,s="image/png",n=!1,o){throw Le("ScreenshotTools")}static CreateScreenshotAsync(e,t,i,r="image/png",s){throw Le("ScreenshotTools")}static CreateScreenshotUsingRenderTarget(e,t,i,r,s="image/png",n=1,o=!1,l,c=!1,h=!1,f=!0,u,d){throw Le("ScreenshotTools")}static CreateScreenshotUsingRenderTargetAsync(e,t,i,r="image/png",s=1,n=!1,o,l=!1,c=!1,h=!0,f,u){throw Le("ScreenshotTools")}static RandomId(){return xs()}static IsBase64(e){return pc(e)}static DecodeBase64(e){return mc(e)}static get errorsCount(){return B.errorsCount}static Log(e){B.Log(e)}static Warn(e){B.Warn(e)}static Error(e){B.Error(e)}static get LogCache(){return B.LogCache}static ClearLogCache(){B.ClearLogCache()}static set LogLevels(e){B.LogLevels=e}static set PerformanceLogLevel(e){if((e&k.PerformanceUserMarkLogLevel)===k.PerformanceUserMarkLogLevel){k.StartPerformanceCounter=k._StartUserMark,k.EndPerformanceCounter=k._EndUserMark;return}if((e&k.PerformanceConsoleLogLevel)===k.PerformanceConsoleLogLevel){k.StartPerformanceCounter=k._StartPerformanceConsole,k.EndPerformanceCounter=k._EndPerformanceConsole;return}k.StartPerformanceCounter=k._StartPerformanceCounterDisabled,k.EndPerformanceCounter=k._EndPerformanceCounterDisabled}static _StartPerformanceCounterDisabled(e,t){}static _EndPerformanceCounterDisabled(e,t){}static _StartUserMark(e,t=!0){if(!k._Performance){if(!Ht())return;k._Performance=window.performance}!t||!k._Performance.mark||k._Performance.mark(e+"-Begin")}static _EndUserMark(e,t=!0){!t||!k._Performance.mark||(k._Performance.mark(e+"-End"),k._Performance.measure(e,e+"-Begin",e+"-End"))}static _StartPerformanceConsole(e,t=!0){t&&(k._StartUserMark(e,t),console.time&&console.time(e))}static _EndPerformanceConsole(e,t=!0){t&&(k._EndUserMark(e,t),console.timeEnd(e))}static get Now(){return Ti.Now}static GetClassName(e,t=!1){let i=null;return!t&&e.getClassName?i=e.getClassName():(e instanceof Object&&(i=(t?e:Object.getPrototypeOf(e)).constructor.__bjsclassName__),i||(i=typeof e)),i}static First(e,t){for(const i of e)if(t(i))return i;return null}static getFullClassName(e,t=!1){let i=null,r=null;if(!t&&e.getClassName)i=e.getClassName();else{if(e instanceof Object){const s=t?e:Object.getPrototypeOf(e);i=s.constructor.__bjsclassName__,r=s.constructor.__bjsmoduleName__}i||(i=typeof e)}return i?(r!=null?r+".":"")+i:null}static DelayAsync(e){return new Promise(t=>{setTimeout(()=>{t()},e)})}static IsSafari(){return ks()?/^((?!chrome|android).)*safari/i.test(navigator.userAgent):!1}}k.AssetBaseUrl="";k.UseCustomRequestHeaders=!1;k.CustomRequestHeaders=Gt.CustomRequestHeaders;k.GetDOMTextContent=sm;k._DefaultCdnUrl="https://cdn.babylonjs.com";k._DefaultAssetsUrl="https://assets.babylonjs.com/core";k.GetAbsoluteUrl=typeof document=="object"?a=>{const e=document.createElement("a");return e.href=a,e.href}:typeof URL=="function"&&typeof location=="object"?a=>new URL(a,location.origin).href:()=>{throw new Error("Unable to get absolute URL. Override BABYLON.Tools.GetAbsoluteUrl to a custom implementation for the current context.")};k.NoneLogLevel=B.NoneLogLevel;k.MessageLogLevel=B.MessageLogLevel;k.WarningLogLevel=B.WarningLogLevel;k.ErrorLogLevel=B.ErrorLogLevel;k.AllLogLevel=B.AllLogLevel;k.IsWindowObjectExist=Ht;k.PerformanceNoneLogLevel=0;k.PerformanceUserMarkLogLevel=1;k.PerformanceConsoleLogLevel=2;k.StartPerformanceCounter=k._StartPerformanceCounterDisabled;k.EndPerformanceCounter=k._EndPerformanceCounterDisabled;class Ra{constructor(e,t,i,r=0){this.iterations=e,this.index=r-1,this._done=!1,this._fn=t,this._successCallback=i}executeNext(){this._done||(this.index+1<this.iterations?(++this.index,this._fn(this)):this.breakLoop())}breakLoop(){this._done=!0,this._successCallback()}static Run(e,t,i,r=0){const s=new Ra(e,t,i,r);return s.executeNext(),s}static SyncAsyncForLoop(e,t,i,r,s,n=0){return Ra.Run(Math.ceil(e/t),o=>{s&&s()?o.breakLoop():setTimeout(()=>{for(let l=0;l<t;++l){const c=o.index*t+l;if(c>=e)break;if(i(c),s&&s()){o.breakLoop();break}}o.executeNext()},n)},r)}}k.Mix=sl;k.IsExponentOfTwo=An;Re.FallbackTexture="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z";class jt{constructor(e){this.length=0,this.data=new Array(e),this._id=jt._GlobalId++}push(e){this.data[this.length++]=e,this.length>this.data.length&&(this.data.length*=2)}forEach(e){for(let t=0;t<this.length;t++)e(this.data[t])}sort(e){this.data.sort(e)}reset(){this.length=0}dispose(){this.reset(),this.data&&(this.data.length=0)}concat(e){if(e.length!==0){this.length+e.length>this.data.length&&(this.data.length=(this.length+e.length)*2);for(let t=0;t<e.length;t++)this.data[this.length++]=(e.data||e)[t]}}indexOf(e){const t=this.data.indexOf(e);return t>=this.length?-1:t}contains(e){return this.indexOf(e)!==-1}}jt._GlobalId=0;class hs extends jt{constructor(){super(...arguments),this._duplicateId=0}push(e){super.push(e),e.__smartArrayFlags||(e.__smartArrayFlags={}),e.__smartArrayFlags[this._id]=this._duplicateId}pushNoDuplicate(e){return e.__smartArrayFlags&&e.__smartArrayFlags[this._id]===this._duplicateId?!1:(this.push(e),!0)}reset(){super.reset(),this._duplicateId++}concatWithNoDuplicate(e){if(e.length!==0){this.length+e.length>this.data.length&&(this.data.length=(this.length+e.length)*2);for(let t=0;t<e.length;t++){const i=(e.data||e)[t];this.pushNoDuplicate(i)}}}}class yh{constructor(){this._count=0,this._data={}}copyFrom(e){this.clear(),e.forEach((t,i)=>this.add(t,i))}get(e){const t=this._data[e];if(t!==void 0)return t}getOrAddWithFactory(e,t){let i=this.get(e);return i!==void 0||(i=t(e),i&&this.add(e,i)),i}getOrAdd(e,t){const i=this.get(e);return i!==void 0?i:(this.add(e,t),t)}contains(e){return this._data[e]!==void 0}add(e,t){return this._data[e]!==void 0?!1:(this._data[e]=t,++this._count,!0)}set(e,t){return this._data[e]===void 0?!1:(this._data[e]=t,!0)}getAndRemove(e){const t=this.get(e);return t!==void 0?(delete this._data[e],--this._count,t):null}remove(e){return this.contains(e)?(delete this._data[e],--this._count,!0):!1}clear(){this._data={},this._count=0}get count(){return this._count}forEach(e){for(const t in this._data){const i=this._data[t];e(t,i)}}first(e){for(const t in this._data){const i=this._data[t],r=e(t,i);if(r)return r}return null}}class us{static Eval(e,t){return e.match(/\([^()]*\)/g)?e=e.replace(/\([^()]*\)/g,i=>(i=i.slice(1,i.length-1),us._HandleParenthesisContent(i,t))):e=us._HandleParenthesisContent(e,t),e==="true"?!0:e==="false"?!1:us.Eval(e,t)}static _HandleParenthesisContent(e,t){t=t||(s=>s==="true");let i;const r=e.split("||");for(const s in r)if(Object.prototype.hasOwnProperty.call(r,s)){let n=us._SimplifyNegation(r[s].trim());const o=n.split("&&");if(o.length>1)for(let l=0;l<o.length;++l){const c=us._SimplifyNegation(o[l].trim());if(c!=="true"&&c!=="false"?c[0]==="!"?i=!t(c.substring(1)):i=t(c):i=c==="true",!i){n="false";break}}if(i||n==="true"){i=!0;break}n!=="true"&&n!=="false"?n[0]==="!"?i=!t(n.substring(1)):i=t(n):i=n==="true"}return i?"true":"false"}static _SimplifyNegation(e){return e=e.replace(/^[\s!]+/,t=>(t=t.replace(/[\s]/g,()=>""),t.length%2?"!":"")),e=e.trim(),e==="!true"?e="false":e==="!false"&&(e="true"),e}}class qe{static EnableFor(e){e._tags=e._tags||{},e.hasTags=()=>qe.HasTags(e),e.addTags=t=>qe.AddTagsTo(e,t),e.removeTags=t=>qe.RemoveTagsFrom(e,t),e.matchesTagsQuery=t=>qe.MatchesQuery(e,t)}static DisableFor(e){delete e._tags,delete e.hasTags,delete e.addTags,delete e.removeTags,delete e.matchesTagsQuery}static HasTags(e){if(!e._tags)return!1;const t=e._tags;for(const i in t)if(Object.prototype.hasOwnProperty.call(t,i))return!0;return!1}static GetTags(e,t=!0){if(!e._tags)return null;if(t){const i=[];for(const r in e._tags)Object.prototype.hasOwnProperty.call(e._tags,r)&&e._tags[r]===!0&&i.push(r);return i.join(" ")}else return e._tags}static AddTagsTo(e,t){if(!t||typeof t!="string")return;t.split(" ").forEach(function(r){qe._AddTagTo(e,r)})}static _AddTagTo(e,t){t=t.trim(),!(t===""||t==="true"||t==="false")&&(t.match(/[\s]/)||t.match(/^([!]|([|]|[&]){2})/)||(qe.EnableFor(e),e._tags[t]=!0))}static RemoveTagsFrom(e,t){if(!qe.HasTags(e))return;const i=t.split(" ");for(const r in i)qe._RemoveTagFrom(e,i[r])}static _RemoveTagFrom(e,t){delete e._tags[t]}static MatchesQuery(e,t){return t===void 0?!0:t===""?qe.HasTags(e):us.Eval(t,i=>qe.HasTags(e)&&e._tags[i])}}const yA=1/2.2,ua=2.2,wt=(1+Math.sqrt(5))/2,Ke=.001;function Bi(a,e){const t=[];for(let i=0;i<a;++i)t.push(e());return t}function rs(a,e){return Bi(a,e)}function MA(a,e,t){const i=a[e];if(typeof i!="function")return null;const r=function(){const s=a.length,n=r.previous.apply(a,arguments);return t(e,s),n};return i.next=r,r.previous=i,a[e]=r,()=>{const s=r.previous;if(!s)return;const n=r.next;n?(s.next=n,n.previous=s):(s.next=void 0,a[e]=s),r.next=void 0,r.previous=void 0}}const PA=["push","splice","pop","shift","unshift"];function Am(a,e){const t=PA.map(i=>MA(a,i,e));return()=>{t.forEach(i=>{i==null||i()})}}function OA(a){return parseInt(a.toString().replace(/\W/g,""))}function nt(a,e,t=1401298e-51){return Math.abs(a-e)<=t}function DA(a,e,t,i=1401298e-51){return a<e-i||a>t+i}function Mt(a,e){return a===e?a:Math.random()*(e-a)+a}function Qr(a,e,t){return a+(e-a)*t}function LA(a,e,t){let i=Na(e-a,360);return i>180&&(i-=360),a+i*je(t)}function NA(a,e,t){let i=0;return a!=e?i=je((t-a)/(e-a)):i=0,i}function Rm(a,e,t,i,r){const s=r*r,n=r*s,o=2*n-3*s+1,l=-2*n+3*s,c=n-2*s+r,h=n-s;return a*o+t*l+e*c+i*h}function FA(a,e,t,i,r){const s=r*r;return(s-r)*6*a+(3*s-4*r+1)*e+(-s+r)*6*t+(3*s-2*r)*i}function je(a,e=0,t=1){return Math.min(t,Math.max(e,a))}function Cm(a){return a-=Math.PI*2*Math.floor((a+Math.PI)/(Math.PI*2)),a}function tr(a){const e=a.toString(16);return a<=15?("0"+e).toUpperCase():e.toUpperCase()}function Im(a){if(Math.log2)return Math.floor(Math.log2(a));if(a<0)return NaN;if(a===0)return-1/0;let e=0;if(a<1){for(;a<1;)e++,a=a*2;e=-e}else if(a>1)for(;a>1;)e++,a=Math.floor(a/2);return e}function Na(a,e){return a-Math.floor(a/e)*e}function wA(a,e,t){return(a-e)/(t-e)}function BA(a,e,t){return a*(t-e)+e}function bm(a,e){let t=Na(e-a,360);return t>180&&(t-=360),t}function UA(a,e){const t=Na(a,e*2);return e-Math.abs(t-e)}function VA(a,e,t){let i=je(t);return i=-2*i*i*i+3*i*i,e*i+a*(1-i)}function xm(a,e,t){let i=0;return Math.abs(e-a)<=t?i=e:i=a+Math.sign(e-a)*t,i}function GA(a,e,t){const i=bm(a,e);let r=0;return-t<i&&i<t?r=e:(e=a+i,r=xm(a,e,t)),r}function kA(a,e,t){return(a-e)/(t-e)}function WA(a,e,t){return(t-e)*a+e}function Rn(a,e){const t=a%e;return t===0?e:Rn(e,t)}const XA=Object.freeze(Object.defineProperty({__proto__:null,Clamp:je,DeltaAngle:bm,Denormalize:BA,ExtractAsInt:OA,Hermite:Rm,Hermite1stDerivative:FA,HighestCommonFactor:Rn,ILog2:Im,InverseLerp:NA,Lerp:Qr,LerpAngle:LA,MoveTowards:xm,MoveTowardsAngle:GA,Normalize:wA,NormalizeRadians:Cm,OutsideRange:DA,PercentToRange:WA,PingPong:UA,RandomRange:Mt,RangeToPercent:kA,Repeat:Na,SmoothStep:VA,ToHex:tr,WithinEpsilon:nt},Symbol.toStringTag,{value:"Module"})),gi=a=>parseInt(a.toString().replace(/\W/g,""));class ne{constructor(e=0,t=0){this.x=e,this.y=t}toString(){return`{X: ${this.x} Y: ${this.y}}`}getClassName(){return"Vector2"}getHashCode(){const e=gi(this.x),t=gi(this.y);let i=e;return i=i*397^t,i}toArray(e,t=0){return e[t]=this.x,e[t+1]=this.y,this}fromArray(e,t=0){return ne.FromArrayToRef(e,t,this),this}asArray(){return[this.x,this.y]}copyFrom(e){return this.x=e.x,this.y=e.y,this}copyFromFloats(e,t){return this.x=e,this.y=t,this}set(e,t){return this.copyFromFloats(e,t)}setAll(e){return this.copyFromFloats(e,e)}add(e){return new ne(this.x+e.x,this.y+e.y)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t}addInPlace(e){return this.x+=e.x,this.y+=e.y,this}addInPlaceFromFloats(e,t){return this.x+=e,this.y+=t,this}addVector3(e){return new ne(this.x+e.x,this.y+e.y)}subtract(e){return new ne(this.x-e.x,this.y-e.y)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this}multiply(e){return new ne(this.x*e.x,this.y*e.y)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t}multiplyByFloats(e,t){return new ne(this.x*e,this.y*t)}divide(e){return new ne(this.x/e.x,this.y/e.y)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t}divideInPlace(e){return this.x=this.x/e.x,this.y=this.y/e.y,this}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e.x,e.y)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e.x,e.y)}minimizeInPlaceFromFloats(e,t){return this.x=Math.min(e,this.x),this.y=Math.min(t,this.y),this}maximizeInPlaceFromFloats(e,t){return this.x=Math.max(e,this.x),this.y=Math.max(t,this.y),this}subtractFromFloats(e,t){return new ne(this.x-e,this.y-t)}subtractFromFloatsToRef(e,t,i){return i.x=this.x-e,i.y=this.y-t,i}negate(){return new ne(-this.x,-this.y)}negateInPlace(){return this.x*=-1,this.y*=-1,this}negateToRef(e){return e.x=-this.x,e.y=-this.y,e}scaleInPlace(e){return this.x*=e,this.y*=e,this}scale(e){return new ne(this.x*e,this.y*e)}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t}equals(e){return e&&this.x===e.x&&this.y===e.y}equalsWithEpsilon(e,t=Ke){return e&&nt(this.x,e.x,t)&&nt(this.y,e.y,t)}equalsToFloats(e,t){return this.x===e&&this.y===t}floor(){return new ne(Math.floor(this.x),Math.floor(this.y))}floorToRef(e){return e.x=Math.floor(this.x),e.y=Math.floor(this.y),e}fract(){return new ne(this.x-Math.floor(this.x),this.y-Math.floor(this.y))}fractToRef(e){return e.x=this.x-Math.floor(this.x),e.y=this.y-Math.floor(this.y),e}rotateToRef(e,t){const i=Math.cos(e),r=Math.sin(e),s=i*this.x-r*this.y,n=r*this.x+i*this.y;return t.x=s,t.y=n,t}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSquared(){return this.x*this.x+this.y*this.y}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return e===0||e===1?this:this.scaleInPlace(1/e)}normalizeToNew(){const e=new ne;return this.normalizeToRef(e),e}normalizeToRef(e){const t=this.length();return t===0&&(e.x=this.x,e.y=this.y),this.scaleToRef(1/t,e)}clone(){return new ne(this.x,this.y)}dot(e){return this.x*e.x+this.y*e.y}static Zero(){return new ne(0,0)}static One(){return new ne(1,1)}static Random(e=0,t=1){return new ne(Mt(e,t),Mt(e,t))}static RandomToRef(e=0,t=1,i){return i.copyFromFloats(Mt(e,t),Mt(e,t))}static get ZeroReadOnly(){return ne._ZeroReadOnly}static FromArray(e,t=0){return new ne(e[t],e[t+1])}static FromArrayToRef(e,t,i){return i.x=e[t],i.y=e[t+1],i}static FromFloatsToRef(e,t,i){return i.copyFromFloats(e,t),i}static CatmullRom(e,t,i,r,s){const n=s*s,o=s*n,l=.5*(2*t.x+(-e.x+i.x)*s+(2*e.x-5*t.x+4*i.x-r.x)*n+(-e.x+3*t.x-3*i.x+r.x)*o),c=.5*(2*t.y+(-e.y+i.y)*s+(2*e.y-5*t.y+4*i.y-r.y)*n+(-e.y+3*t.y-3*i.y+r.y)*o);return new ne(l,c)}static ClampToRef(e,t,i,r){return r.x=je(e.x,t.x,i.x),r.y=je(e.y,t.y,i.y),r}static Clamp(e,t,i){const r=je(e.x,t.x,i.x),s=je(e.y,t.y,i.y);return new ne(r,s)}static Hermite(e,t,i,r,s){const n=s*s,o=s*n,l=2*o-3*n+1,c=-2*o+3*n,h=o-2*n+s,f=o-n,u=e.x*l+i.x*c+t.x*h+r.x*f,d=e.y*l+i.y*c+t.y*h+r.y*f;return new ne(u,d)}static Hermite1stDerivative(e,t,i,r,s){return this.Hermite1stDerivativeToRef(e,t,i,r,s,new ne)}static Hermite1stDerivativeToRef(e,t,i,r,s,n){const o=s*s;return n.x=(o-s)*6*e.x+(3*o-4*s+1)*t.x+(-o+s)*6*i.x+(3*o-2*s)*r.x,n.y=(o-s)*6*e.y+(3*o-4*s+1)*t.y+(-o+s)*6*i.y+(3*o-2*s)*r.y,n}static Lerp(e,t,i){return ne.LerpToRef(e,t,i,new ne)}static LerpToRef(e,t,i,r){return r.x=e.x+(t.x-e.x)*i,r.y=e.y+(t.y-e.y)*i,r}static Dot(e,t){return e.x*t.x+e.y*t.y}static Normalize(e){return ne.NormalizeToRef(e,new ne)}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Minimize(e,t){const i=e.x<t.x?e.x:t.x,r=e.y<t.y?e.y:t.y;return new ne(i,r)}static Maximize(e,t){const i=e.x>t.x?e.x:t.x,r=e.y>t.y?e.y:t.y;return new ne(i,r)}static Transform(e,t){return ne.TransformToRef(e,t,new ne)}static TransformToRef(e,t,i){const r=t.m,s=e.x*r[0]+e.y*r[4]+r[12],n=e.x*r[1]+e.y*r[5]+r[13];return i.x=s,i.y=n,i}static PointInTriangle(e,t,i,r){const s=.5*(-i.y*r.x+t.y*(-i.x+r.x)+t.x*(i.y-r.y)+i.x*r.y),n=s<0?-1:1,o=(t.y*r.x-t.x*r.y+(r.y-t.y)*e.x+(t.x-r.x)*e.y)*n,l=(t.x*i.y-t.y*i.x+(t.y-i.y)*e.x+(i.x-t.x)*e.y)*n;return o>0&&l>0&&o+l<2*s*n}static Distance(e,t){return Math.sqrt(ne.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,r=e.y-t.y;return i*i+r*r}static Center(e,t){return ne.CenterToRef(e,t,new ne)}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2)}static DistanceOfPointFromSegment(e,t,i){const r=ne.DistanceSquared(t,i);if(r===0)return ne.Distance(e,t);const s=i.subtract(t),n=Math.max(0,Math.min(1,ne.Dot(e.subtract(t),s)/r)),o=t.add(s.multiplyByFloats(n,n));return ne.Distance(e,o)}}ne._V8PerformanceHack=new ne(.5,.5);ne._ZeroReadOnly=ne.Zero();Object.defineProperties(ne.prototype,{dimension:{value:[2]},rank:{value:1}});class m{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}constructor(e=0,t=0,i=0){this._isDirty=!0,this._x=e,this._y=t,this._z=i}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z}}`}getClassName(){return"Vector3"}getHashCode(){const e=gi(this._x),t=gi(this._y),i=gi(this._z);let r=e;return r=r*397^t,r=r*397^i,r}asArray(){return[this._x,this._y,this._z]}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,this}fromArray(e,t=0){return m.FromArrayToRef(e,t,this),this}toQuaternion(){return z.RotationYawPitchRoll(this._y,this._x,this._z)}addInPlace(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._isDirty=!0,this}addInPlaceFromFloats(e,t,i){return this._x+=e,this._y+=t,this._z+=i,this._isDirty=!0,this}add(e){return new m(this._x+e._x,this._y+e._y,this._z+e._z)}addToRef(e,t){return t._x=this._x+e._x,t._y=this._y+e._y,t._z=this._z+e._z,t._isDirty=!0,t}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._isDirty=!0,this}subtract(e){return new m(this._x-e._x,this._y-e._y,this._z-e._z)}subtractToRef(e,t){return this.subtractFromFloatsToRef(e._x,e._y,e._z,t)}subtractFromFloats(e,t,i){return new m(this._x-e,this._y-t,this._z-i)}subtractFromFloatsToRef(e,t,i,r){return r._x=this._x-e,r._y=this._y-t,r._z=this._z-i,r._isDirty=!0,r}negate(){return new m(-this._x,-this._y,-this._z)}negateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}negateToRef(e){return e._x=this._x*-1,e._y=this._y*-1,e._z=this._z*-1,e._isDirty=!0,e}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._isDirty=!0,this}scale(e){return new m(this._x*e,this._y*e,this._z*e)}scaleToRef(e,t){return t._x=this._x*e,t._y=this._y*e,t._z=this._z*e,t._isDirty=!0,t}getNormalToRef(e){const t=this.length();let i=Math.acos(this.y/t);const r=Math.atan2(this.z,this.x);i>Math.PI/2?i-=Math.PI/2:i+=Math.PI/2;const s=t*Math.sin(i)*Math.cos(r),n=t*Math.cos(i),o=t*Math.sin(i)*Math.sin(r);return e.set(s,n,o),e}applyRotationQuaternionToRef(e,t){const i=this._x,r=this._y,s=this._z,n=e._x,o=e._y,l=e._z,c=e._w,h=2*(o*s-l*r),f=2*(l*i-n*s),u=2*(n*r-o*i);return t._x=i+c*h+o*u-l*f,t._y=r+c*f+l*h-n*u,t._z=s+c*u+n*f-o*h,t._isDirty=!0,t}applyRotationQuaternionInPlace(e){return this.applyRotationQuaternionToRef(e,this)}applyRotationQuaternion(e){return this.applyRotationQuaternionToRef(e,new m)}scaleAndAddToRef(e,t){return t._x+=this._x*e,t._y+=this._y*e,t._z+=this._z*e,t._isDirty=!0,t}projectOnPlane(e,t){return this.projectOnPlaneToRef(e,t,new m)}projectOnPlaneToRef(e,t,i){const r=e.normal,s=e.d,n=de.Vector3[0];this.subtractToRef(t,n),n.normalize();const o=m.Dot(n,r);if(Math.abs(o)<1e-10)i.setAll(1/0);else{const l=-(m.Dot(t,r)+s)/o,c=n.scaleInPlace(l);t.addToRef(c,i)}return i}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z}equalsWithEpsilon(e,t=Ke){return e&&nt(this._x,e._x,t)&&nt(this._y,e._y,t)&&nt(this._z,e._z,t)}equalsToFloats(e,t,i){return this._x===e&&this._y===t&&this._z===i}multiplyInPlace(e){return this._x*=e._x,this._y*=e._y,this._z*=e._z,this._isDirty=!0,this}multiply(e){return this.multiplyByFloats(e._x,e._y,e._z)}multiplyToRef(e,t){return t._x=this._x*e._x,t._y=this._y*e._y,t._z=this._z*e._z,t._isDirty=!0,t}multiplyByFloats(e,t,i){return new m(this._x*e,this._y*t,this._z*i)}divide(e){return new m(this._x/e._x,this._y/e._y,this._z/e._z)}divideToRef(e,t){return t._x=this._x/e._x,t._y=this._y/e._y,t._z=this._z/e._z,t._isDirty=!0,t}divideInPlace(e){return this._x=this._x/e._x,this._y=this._y/e._y,this._z=this._z/e._z,this._isDirty=!0,this}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e._x,e._y,e._z)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e._x,e._y,e._z)}minimizeInPlaceFromFloats(e,t,i){return e<this._x&&(this.x=e),t<this._y&&(this.y=t),i<this._z&&(this.z=i),this}maximizeInPlaceFromFloats(e,t,i){return e>this._x&&(this.x=e),t>this._y&&(this.y=t),i>this._z&&(this.z=i),this}isNonUniformWithinEpsilon(e){const t=Math.abs(this._x),i=Math.abs(this._y);if(!nt(t,i,e))return!0;const r=Math.abs(this._z);return!nt(t,r,e)||!nt(i,r,e)}get isNonUniform(){const e=Math.abs(this._x),t=Math.abs(this._y);if(e!==t)return!0;const i=Math.abs(this._z);return e!==i}floorToRef(e){return e._x=Math.floor(this._x),e._y=Math.floor(this._y),e._z=Math.floor(this._z),e._isDirty=!0,e}floor(){return new m(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z))}fractToRef(e){return e._x=this.x-Math.floor(this._x),e._y=this.y-Math.floor(this._y),e._z=this.z-Math.floor(this._z),e._isDirty=!0,e}fract(){return new m(this.x-Math.floor(this._x),this.y-Math.floor(this._y),this.z-Math.floor(this._z))}length(){return Math.sqrt(this.lengthSquared())}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z}get hasAZeroComponent(){return this._x*this._y*this._z===0}normalize(){return this.normalizeFromLength(this.length())}reorderInPlace(e){if(e=e.toLowerCase(),e==="xyz")return this;const t=de.Vector3[0].copyFrom(this);return this.x=t[e[0]],this.y=t[e[1]],this.z=t[e[2]],this}rotateByQuaternionToRef(e,t){return e.toRotationMatrix(de.Matrix[0]),m.TransformCoordinatesToRef(this,de.Matrix[0],t),t}rotateByQuaternionAroundPointToRef(e,t,i){return this.subtractToRef(t,de.Vector3[0]),de.Vector3[0].rotateByQuaternionToRef(e,de.Vector3[0]),t.addToRef(de.Vector3[0],i),i}cross(e){return m.CrossToRef(this,e,new m)}normalizeFromLength(e){return e===0||e===1?this:this.scaleInPlace(1/e)}normalizeToNew(){return this.normalizeToRef(new m)}normalizeToRef(e){const t=this.length();return t===0||t===1?(e._x=this._x,e._y=this._y,e._z=this._z,e._isDirty=!0,e):this.scaleToRef(1/t,e)}clone(){return new m(this._x,this._y,this._z)}copyFrom(e){return this.copyFromFloats(e._x,e._y,e._z)}copyFromFloats(e,t,i){return this._x=e,this._y=t,this._z=i,this._isDirty=!0,this}set(e,t,i){return this.copyFromFloats(e,t,i)}setAll(e){return this._x=this._y=this._z=e,this._isDirty=!0,this}static GetClipFactor(e,t,i,r){const s=m.Dot(e,i),n=m.Dot(t,i);return(s-r)/(s-n)}static GetAngleBetweenVectors(e,t,i){const r=e.normalizeToRef(de.Vector3[1]),s=t.normalizeToRef(de.Vector3[2]);let n=m.Dot(r,s);n=je(n,-1,1);const o=Math.acos(n),l=de.Vector3[3];return m.CrossToRef(r,s,l),m.Dot(l,i)>0?isNaN(o)?0:o:isNaN(o)?-Math.PI:-Math.acos(n)}static GetAngleBetweenVectorsOnPlane(e,t,i){de.Vector3[0].copyFrom(e);const r=de.Vector3[0];de.Vector3[1].copyFrom(t);const s=de.Vector3[1];de.Vector3[2].copyFrom(i);const n=de.Vector3[2],o=de.Vector3[3],l=de.Vector3[4];r.normalize(),s.normalize(),n.normalize(),m.CrossToRef(n,r,o),m.CrossToRef(o,n,l);const c=Math.atan2(m.Dot(s,o),m.Dot(s,l));return Cm(c)}static PitchYawRollToMoveBetweenPointsToRef(e,t,i){const r=F.Vector3[0];return t.subtractToRef(e,r),i._y=Math.atan2(r.x,r.z)||0,i._x=Math.atan2(Math.sqrt(r.x**2+r.z**2),r.y)||0,i._z=0,i._isDirty=!0,i}static PitchYawRollToMoveBetweenPoints(e,t){const i=m.Zero();return m.PitchYawRollToMoveBetweenPointsToRef(e,t,i)}static SlerpToRef(e,t,i,r){i=je(i,0,1);const s=de.Vector3[0],n=de.Vector3[1];s.copyFrom(e);const o=s.length();s.normalizeFromLength(o),n.copyFrom(t);const l=n.length();n.normalizeFromLength(l);const c=m.Dot(s,n);let h,f;if(c<1-Ke){const u=Math.acos(c),d=1/Math.sin(u);h=Math.sin((1-i)*u)*d,f=Math.sin(i*u)*d}else h=1-i,f=i;return s.scaleInPlace(h),n.scaleInPlace(f),r.copyFrom(s).addInPlace(n),r.scaleInPlace(Qr(o,l,i)),r}static SmoothToRef(e,t,i,r,s){return m.SlerpToRef(e,t,r===0?1:i/r,s),s}static FromArray(e,t=0){return new m(e[t],e[t+1],e[t+2])}static FromFloatArray(e,t){return m.FromArray(e,t)}static FromArrayToRef(e,t,i){return i._x=e[t],i._y=e[t+1],i._z=e[t+2],i._isDirty=!0,i}static FromFloatArrayToRef(e,t,i){return m.FromArrayToRef(e,t,i)}static FromFloatsToRef(e,t,i,r){return r.copyFromFloats(e,t,i),r}static Zero(){return new m(0,0,0)}static One(){return new m(1,1,1)}static Up(){return new m(0,1,0)}static get UpReadOnly(){return m._UpReadOnly}static get DownReadOnly(){return m._DownReadOnly}static get RightReadOnly(){return m._RightReadOnly}static get LeftReadOnly(){return m._LeftReadOnly}static get LeftHandedForwardReadOnly(){return m._LeftHandedForwardReadOnly}static get RightHandedForwardReadOnly(){return m._RightHandedForwardReadOnly}static get LeftHandedBackwardReadOnly(){return m._LeftHandedBackwardReadOnly}static get RightHandedBackwardReadOnly(){return m._RightHandedBackwardReadOnly}static get ZeroReadOnly(){return m._ZeroReadOnly}static get OneReadOnly(){return m._OneReadOnly}static Down(){return new m(0,-1,0)}static Forward(e=!1){return new m(0,0,e?-1:1)}static Backward(e=!1){return new m(0,0,e?1:-1)}static Right(){return new m(1,0,0)}static Left(){return new m(-1,0,0)}static Random(e=0,t=1){return new m(Mt(e,t),Mt(e,t),Mt(e,t))}static RandomToRef(e=0,t=1,i){return i.copyFromFloats(Mt(e,t),Mt(e,t),Mt(e,t))}static TransformCoordinates(e,t){const i=m.Zero();return m.TransformCoordinatesToRef(e,t,i),i}static TransformCoordinatesToRef(e,t,i){return m.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformCoordinatesFromFloatsToRef(e,t,i,r,s){const n=r.m,o=e*n[0]+t*n[4]+i*n[8]+n[12],l=e*n[1]+t*n[5]+i*n[9]+n[13],c=e*n[2]+t*n[6]+i*n[10]+n[14],h=1/(e*n[3]+t*n[7]+i*n[11]+n[15]);return s._x=o*h,s._y=l*h,s._z=c*h,s._isDirty=!0,s}static TransformNormal(e,t){const i=m.Zero();return m.TransformNormalToRef(e,t,i),i}static TransformNormalToRef(e,t,i){return this.TransformNormalFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformNormalFromFloatsToRef(e,t,i,r,s){const n=r.m;return s._x=e*n[0]+t*n[4]+i*n[8],s._y=e*n[1]+t*n[5]+i*n[9],s._z=e*n[2]+t*n[6]+i*n[10],s._isDirty=!0,s}static CatmullRom(e,t,i,r,s){const n=s*s,o=s*n,l=.5*(2*t._x+(-e._x+i._x)*s+(2*e._x-5*t._x+4*i._x-r._x)*n+(-e._x+3*t._x-3*i._x+r._x)*o),c=.5*(2*t._y+(-e._y+i._y)*s+(2*e._y-5*t._y+4*i._y-r._y)*n+(-e._y+3*t._y-3*i._y+r._y)*o),h=.5*(2*t._z+(-e._z+i._z)*s+(2*e._z-5*t._z+4*i._z-r._z)*n+(-e._z+3*t._z-3*i._z+r._z)*o);return new m(l,c,h)}static Clamp(e,t,i){const r=new m;return m.ClampToRef(e,t,i,r),r}static ClampToRef(e,t,i,r){let s=e._x;s=s>i._x?i._x:s,s=s<t._x?t._x:s;let n=e._y;n=n>i._y?i._y:n,n=n<t._y?t._y:n;let o=e._z;return o=o>i._z?i._z:o,o=o<t._z?t._z:o,r.copyFromFloats(s,n,o),r}static CheckExtends(e,t,i){t.minimizeInPlace(e),i.maximizeInPlace(e)}static Hermite(e,t,i,r,s){const n=s*s,o=s*n,l=2*o-3*n+1,c=-2*o+3*n,h=o-2*n+s,f=o-n,u=e._x*l+i._x*c+t._x*h+r._x*f,d=e._y*l+i._y*c+t._y*h+r._y*f,_=e._z*l+i._z*c+t._z*h+r._z*f;return new m(u,d,_)}static Hermite1stDerivative(e,t,i,r,s){const n=new m;return this.Hermite1stDerivativeToRef(e,t,i,r,s,n),n}static Hermite1stDerivativeToRef(e,t,i,r,s,n){const o=s*s;return n._x=(o-s)*6*e._x+(3*o-4*s+1)*t._x+(-o+s)*6*i._x+(3*o-2*s)*r._x,n._y=(o-s)*6*e._y+(3*o-4*s+1)*t._y+(-o+s)*6*i._y+(3*o-2*s)*r._y,n._z=(o-s)*6*e._z+(3*o-4*s+1)*t._z+(-o+s)*6*i._z+(3*o-2*s)*r._z,n._isDirty=!0,n}static Lerp(e,t,i){const r=new m(0,0,0);return m.LerpToRef(e,t,i,r),r}static LerpToRef(e,t,i,r){return r._x=e._x+(t._x-e._x)*i,r._y=e._y+(t._y-e._y)*i,r._z=e._z+(t._z-e._z)*i,r._isDirty=!0,r}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z}static Cross(e,t){const i=new m;return m.CrossToRef(e,t,i),i}static CrossToRef(e,t,i){const r=e._y*t._z-e._z*t._y,s=e._z*t._x-e._x*t._z,n=e._x*t._y-e._y*t._x;return i.copyFromFloats(r,s,n),i}static Normalize(e){const t=m.Zero();return m.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Project(e,t,i,r){const s=new m;return m.ProjectToRef(e,t,i,r,s),s}static ProjectToRef(e,t,i,r,s){var p;const n=r.width,o=r.height,l=r.x,c=r.y,h=de.Matrix[1],f=(p=Re.LastCreatedEngine)==null?void 0:p.isNDCHalfZRange,u=f?1:.5,d=f?0:.5;P.FromValuesToRef(n/2,0,0,0,0,-o/2,0,0,0,0,u,0,l+n/2,o/2+c,d,1,h);const _=de.Matrix[0];return t.multiplyToRef(i,_),_.multiplyToRef(h,_),m.TransformCoordinatesToRef(e,_,s),s}static Reflect(e,t){return this.ReflectToRef(e,t,new m)}static ReflectToRef(e,t,i){const r=F.Vector3[0];return r.copyFrom(t).scaleInPlace(2*m.Dot(e,t)),i.copyFrom(e).subtractInPlace(r)}static _UnprojectFromInvertedMatrixToRef(e,t,i){m.TransformCoordinatesToRef(e,t,i);const r=t.m,s=e._x*r[3]+e._y*r[7]+e._z*r[11]+r[15];return nt(s,1)&&i.scaleInPlace(1/s),i}static UnprojectFromTransform(e,t,i,r,s){return this.Unproject(e,t,i,r,s,P.IdentityReadOnly)}static Unproject(e,t,i,r,s,n){const o=new m;return m.UnprojectToRef(e,t,i,r,s,n,o),o}static UnprojectToRef(e,t,i,r,s,n,o){return m.UnprojectFloatsToRef(e._x,e._y,e._z,t,i,r,s,n,o),o}static UnprojectFloatsToRef(e,t,i,r,s,n,o,l,c){var u;const h=de.Matrix[0];n.multiplyToRef(o,h),h.multiplyToRef(l,h),h.invert();const f=de.Vector3[0];return f.x=e/r*2-1,f.y=-(t/s*2-1),(u=Re.LastCreatedEngine)!=null&&u.isNDCHalfZRange?f.z=i:f.z=2*i-1,m._UnprojectFromInvertedMatrixToRef(f,h,c),c}static Minimize(e,t){const i=new m;return i.copyFrom(e),i.minimizeInPlace(t),i}static Maximize(e,t){const i=new m;return i.copyFrom(e),i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(m.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e._x-t._x,r=e._y-t._y,s=e._z-t._z;return i*i+r*r+s*s}static ProjectOnTriangleToRef(e,t,i,r,s){const n=de.Vector3[0],o=de.Vector3[1],l=de.Vector3[2],c=de.Vector3[3],h=de.Vector3[4];i.subtractToRef(t,n),r.subtractToRef(t,o),r.subtractToRef(i,l);const f=n.length(),u=o.length(),d=l.length();if(f<Ke||u<Ke||d<Ke)return s.copyFrom(t),m.Distance(e,t);e.subtractToRef(t,h),m.CrossToRef(n,o,c);const _=c.length();if(_<Ke)return s.copyFrom(t),m.Distance(e,t);c.normalizeFromLength(_);let p=h.length();if(p<Ke)return s.copyFrom(t),0;h.normalizeFromLength(p);const g=m.Dot(c,h),E=de.Vector3[5],v=de.Vector3[6];E.copyFrom(c).scaleInPlace(-p*g),v.copyFrom(e).addInPlace(E);const b=de.Vector3[4],R=de.Vector3[5],S=de.Vector3[7],T=de.Vector3[8];b.copyFrom(n).scaleInPlace(1/f),T.copyFrom(o).scaleInPlace(1/u),b.addInPlace(T).scaleInPlace(-1),R.copyFrom(n).scaleInPlace(-1/f),T.copyFrom(l).scaleInPlace(1/d),R.addInPlace(T).scaleInPlace(-1),S.copyFrom(l).scaleInPlace(-1/d),T.copyFrom(o).scaleInPlace(-1/u),S.addInPlace(T).scaleInPlace(-1);const I=de.Vector3[9];let O;I.copyFrom(v).subtractInPlace(t),m.CrossToRef(b,I,T),O=m.Dot(T,c);const L=O;I.copyFrom(v).subtractInPlace(i),m.CrossToRef(R,I,T),O=m.Dot(T,c);const w=O;I.copyFrom(v).subtractInPlace(r),m.CrossToRef(S,I,T),O=m.Dot(T,c);const $=O,J=de.Vector3[10];let ce,le;L>0&&w<0?(J.copyFrom(n),ce=t,le=i):w>0&&$<0?(J.copyFrom(l),ce=i,le=r):(J.copyFrom(o).scaleInPlace(-1),ce=r,le=t);const oe=de.Vector3[9],ue=de.Vector3[4];if(ce.subtractToRef(v,T),le.subtractToRef(v,oe),m.CrossToRef(T,oe,ue),!(m.Dot(ue,c)<0))return s.copyFrom(v),Math.abs(p*g);const Se=de.Vector3[5];m.CrossToRef(J,ue,Se),Se.normalize();const ie=de.Vector3[9];ie.copyFrom(ce).subtractInPlace(v);const K=ie.length();if(K<Ke)return s.copyFrom(ce),m.Distance(e,ce);ie.normalizeFromLength(K);const M=m.Dot(Se,ie),V=de.Vector3[7];V.copyFrom(v).addInPlace(Se.scaleInPlace(K*M)),T.copyFrom(V).subtractInPlace(ce),p=J.length(),J.normalizeFromLength(p);let re=m.Dot(T,J)/Math.max(p,Ke);return re=je(re,0,1),V.copyFrom(ce).addInPlace(J.scaleInPlace(re*p)),s.copyFrom(V),m.Distance(e,V)}static Center(e,t){return m.CenterToRef(e,t,m.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e._x+t._x)/2,(e._y+t._y)/2,(e._z+t._z)/2)}static RotationFromAxis(e,t,i){const r=new m;return m.RotationFromAxisToRef(e,t,i,r),r}static RotationFromAxisToRef(e,t,i,r){const s=de.Quaternion[0];return z.RotationQuaternionFromAxisToRef(e,t,i,s),s.toEulerAnglesToRef(r),r}}m._V8PerformanceHack=new m(.5,.5,.5);m._UpReadOnly=m.Up();m._DownReadOnly=m.Down();m._LeftHandedForwardReadOnly=m.Forward(!1);m._RightHandedForwardReadOnly=m.Forward(!0);m._LeftHandedBackwardReadOnly=m.Backward(!1);m._RightHandedBackwardReadOnly=m.Backward(!0);m._RightReadOnly=m.Right();m._LeftReadOnly=m.Left();m._ZeroReadOnly=m.Zero();m._OneReadOnly=m.One();Object.defineProperties(m.prototype,{dimension:{value:[3]},rank:{value:1}});class Fe{constructor(e=0,t=0,i=0,r=0){this.x=e,this.y=t,this.z=i,this.w=r}toString(){return`{X: ${this.x} Y: ${this.y} Z: ${this.z} W: ${this.w}}`}getClassName(){return"Vector4"}getHashCode(){const e=gi(this.x),t=gi(this.y),i=gi(this.z),r=gi(this.w);let s=e;return s=s*397^t,s=s*397^i,s=s*397^r,s}asArray(){return[this.x,this.y,this.z,this.w]}toArray(e,t){return t===void 0&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,this}fromArray(e,t=0){return Fe.FromArrayToRef(e,t,this),this}addInPlace(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}addInPlaceFromFloats(e,t,i,r){return this.x+=e,this.y+=t,this.z+=i,this.w+=r,this}add(e){return new Fe(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z,t.w=this.w+e.w,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subtract(e){return new Fe(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z,t.w=this.w-e.w,t}subtractFromFloats(e,t,i,r){return new Fe(this.x-e,this.y-t,this.z-i,this.w-r)}subtractFromFloatsToRef(e,t,i,r,s){return s.x=this.x-e,s.y=this.y-t,s.z=this.z-i,s.w=this.w-r,s}negate(){return new Fe(-this.x,-this.y,-this.z,-this.w)}negateInPlace(){return this.x*=-1,this.y*=-1,this.z*=-1,this.w*=-1,this}negateToRef(e){return e.x=-this.x,e.y=-this.y,e.z=-this.z,e.w=-this.w,e}scaleInPlace(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}scale(e){return new Fe(this.x*e,this.y*e,this.z*e,this.w*e)}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e,t}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t.z+=this.z*e,t.w+=this.w*e,t}equals(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsWithEpsilon(e,t=Ke){return e&&nt(this.x,e.x,t)&&nt(this.y,e.y,t)&&nt(this.z,e.z,t)&&nt(this.w,e.w,t)}equalsToFloats(e,t,i,r){return this.x===e&&this.y===t&&this.z===i&&this.w===r}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiply(e){return new Fe(this.x*e.x,this.y*e.y,this.z*e.z,this.w*e.w)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t.z=this.z*e.z,t.w=this.w*e.w,t}multiplyByFloats(e,t,i,r){return new Fe(this.x*e,this.y*t,this.z*i,this.w*r)}divide(e){return new Fe(this.x/e.x,this.y/e.y,this.z/e.z,this.w/e.w)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t.z=this.z/e.z,t.w=this.w/e.w,t}divideInPlace(e){return this.divideToRef(e,this)}minimizeInPlace(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this}maximizeInPlace(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this}minimizeInPlaceFromFloats(e,t,i,r){return this.x=Math.min(e,this.x),this.y=Math.min(t,this.y),this.z=Math.min(i,this.z),this.w=Math.min(r,this.w),this}maximizeInPlaceFromFloats(e,t,i,r){return this.x=Math.max(e,this.x),this.y=Math.max(t,this.y),this.z=Math.max(i,this.z),this.w=Math.max(r,this.w),this}floorToRef(e){return e.x=Math.floor(this.x),e.y=Math.floor(this.y),e.z=Math.floor(this.z),e.w=Math.floor(this.w),e}floor(){return new Fe(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z),Math.floor(this.w))}fractToRef(e){return e.x=this.x-Math.floor(this.x),e.y=this.y-Math.floor(this.y),e.z=this.z-Math.floor(this.z),e.w=this.w-Math.floor(this.w),e}fract(){return new Fe(this.x-Math.floor(this.x),this.y-Math.floor(this.y),this.z-Math.floor(this.z),this.w-Math.floor(this.w))}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return e===0||e===1?this:this.scaleInPlace(1/e)}normalizeToNew(){return this.normalizeToRef(new Fe)}normalizeToRef(e){const t=this.length();return t===0||t===1?(e.x=this.x,e.y=this.y,e.z=this.z,e.w=this.w,e):this.scaleToRef(1/t,e)}toVector3(){return new m(this.x,this.y,this.z)}clone(){return new Fe(this.x,this.y,this.z,this.w)}copyFrom(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}copyFromFloats(e,t,i,r){return this.x=e,this.y=t,this.z=i,this.w=r,this}set(e,t,i,r){return this.copyFromFloats(e,t,i,r)}setAll(e){return this.x=this.y=this.z=this.w=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}static FromArray(e,t){return t||(t=0),new Fe(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){return i.x=e[t],i.y=e[t+1],i.z=e[t+2],i.w=e[t+3],i}static FromFloatArrayToRef(e,t,i){return Fe.FromArrayToRef(e,t,i),i}static FromFloatsToRef(e,t,i,r,s){return s.x=e,s.y=t,s.z=i,s.w=r,s}static Zero(){return new Fe(0,0,0,0)}static One(){return new Fe(1,1,1,1)}static Random(e=0,t=1){return new Fe(Mt(e,t),Mt(e,t),Mt(e,t),Mt(e,t))}static RandomToRef(e=0,t=1,i){return i.x=Mt(e,t),i.y=Mt(e,t),i.z=Mt(e,t),i.w=Mt(e,t),i}static Clamp(e,t,i){return Fe.ClampToRef(e,t,i,new Fe)}static ClampToRef(e,t,i,r){return r.x=je(e.x,t.x,i.x),r.y=je(e.y,t.y,i.y),r.z=je(e.z,t.z,i.z),r.w=je(e.w,t.w,i.w),r}static CheckExtends(e,t,i){t.minimizeInPlace(e),i.maximizeInPlace(e)}static get ZeroReadOnly(){return Fe._ZeroReadOnly}static Normalize(e){return Fe.NormalizeToRef(e,new Fe)}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Minimize(e,t){const i=new Fe;return i.copyFrom(e),i.minimizeInPlace(t),i}static Maximize(e,t){const i=new Fe;return i.copyFrom(e),i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(Fe.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,r=e.y-t.y,s=e.z-t.z,n=e.w-t.w;return i*i+r*r+s*s+n*n}static Center(e,t){return Fe.CenterToRef(e,t,new Fe)}static CenterToRef(e,t,i){return i.x=(e.x+t.x)/2,i.y=(e.y+t.y)/2,i.z=(e.z+t.z)/2,i.w=(e.w+t.w)/2,i}static TransformCoordinates(e,t){return Fe.TransformCoordinatesToRef(e,t,new Fe)}static TransformCoordinatesToRef(e,t,i){return Fe.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformCoordinatesFromFloatsToRef(e,t,i,r,s){const n=r.m,o=e*n[0]+t*n[4]+i*n[8]+n[12],l=e*n[1]+t*n[5]+i*n[9]+n[13],c=e*n[2]+t*n[6]+i*n[10]+n[14],h=e*n[3]+t*n[7]+i*n[11]+n[15];return s.x=o,s.y=l,s.z=c,s.w=h,s}static TransformNormal(e,t){return Fe.TransformNormalToRef(e,t,new Fe)}static TransformNormalToRef(e,t,i){const r=t.m,s=e.x*r[0]+e.y*r[4]+e.z*r[8],n=e.x*r[1]+e.y*r[5]+e.z*r[9],o=e.x*r[2]+e.y*r[6]+e.z*r[10];return i.x=s,i.y=n,i.z=o,i.w=e.w,i}static TransformNormalFromFloatsToRef(e,t,i,r,s,n){const o=s.m;return n.x=e*o[0]+t*o[4]+i*o[8],n.y=e*o[1]+t*o[5]+i*o[9],n.z=e*o[2]+t*o[6]+i*o[10],n.w=r,n}static FromVector3(e,t=0){return new Fe(e._x,e._y,e._z,t)}static Dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}}Fe._V8PerformanceHack=new Fe(.5,.5,.5,.5);Fe._ZeroReadOnly=Fe.Zero();Object.defineProperties(Fe.prototype,{dimension:{value:[4]},rank:{value:1}});class z{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}get w(){return this._w}set w(e){this._w=e,this._isDirty=!0}constructor(e=0,t=0,i=0,r=1){this._isDirty=!0,this._x=e,this._y=t,this._z=i,this._w=r}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z} W: ${this._w}}`}getClassName(){return"Quaternion"}getHashCode(){const e=gi(this._x),t=gi(this._y),i=gi(this._z),r=gi(this._w);let s=e;return s=s*397^t,s=s*397^i,s=s*397^r,s}asArray(){return[this._x,this._y,this._z,this._w]}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,this}fromArray(e,t=0){return z.FromArrayToRef(e,t,this)}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z&&this._w===e._w}equalsWithEpsilon(e,t=Ke){return e&&nt(this._x,e._x,t)&&nt(this._y,e._y,t)&&nt(this._z,e._z,t)&&nt(this._w,e._w,t)}isApprox(e,t=Ke){return e&&(nt(this._x,e._x,t)&&nt(this._y,e._y,t)&&nt(this._z,e._z,t)&&nt(this._w,e._w,t)||nt(this._x,-e._x,t)&&nt(this._y,-e._y,t)&&nt(this._z,-e._z,t)&&nt(this._w,-e._w,t))}clone(){return new z(this._x,this._y,this._z,this._w)}copyFrom(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._w=e._w,this._isDirty=!0,this}copyFromFloats(e,t,i,r){return this._x=e,this._y=t,this._z=i,this._w=r,this._isDirty=!0,this}set(e,t,i,r){return this.copyFromFloats(e,t,i,r)}setAll(e){return this.copyFromFloats(e,e,e,e)}add(e){return new z(this._x+e._x,this._y+e._y,this._z+e._z,this._w+e._w)}addInPlace(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._w+=e._w,this._isDirty=!0,this}addToRef(e,t){return t._x=this._x+e._x,t._y=this._y+e._y,t._z=this._z+e._z,t._w=this._w+e._w,t._isDirty=!0,t}addInPlaceFromFloats(e,t,i,r){return this._x+=e,this._y+=t,this._z+=i,this._w+=r,this._isDirty=!0,this}subtractToRef(e,t){return t._x=this._x-e._x,t._y=this._y-e._y,t._z=this._z-e._z,t._w=this._w-e._w,t._isDirty=!0,t}subtractFromFloats(e,t,i,r){return this.subtractFromFloatsToRef(e,t,i,r,new z)}subtractFromFloatsToRef(e,t,i,r,s){return s._x=this._x-e,s._y=this._y-t,s._z=this._z-i,s._w=this._w-r,s._isDirty=!0,s}subtract(e){return new z(this._x-e._x,this._y-e._y,this._z-e._z,this._w-e._w)}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._w-=e._w,this._isDirty=!0,this}scale(e){return new z(this._x*e,this._y*e,this._z*e,this._w*e)}scaleToRef(e,t){return t._x=this._x*e,t._y=this._y*e,t._z=this._z*e,t._w=this._w*e,t._isDirty=!0,t}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._w*=e,this._isDirty=!0,this}scaleAndAddToRef(e,t){return t._x+=this._x*e,t._y+=this._y*e,t._z+=this._z*e,t._w+=this._w*e,t._isDirty=!0,t}multiply(e){const t=new z(0,0,0,1);return this.multiplyToRef(e,t),t}multiplyToRef(e,t){const i=this._x*e._w+this._y*e._z-this._z*e._y+this._w*e._x,r=-this._x*e._z+this._y*e._w+this._z*e._x+this._w*e._y,s=this._x*e._y-this._y*e._x+this._z*e._w+this._w*e._z,n=-this._x*e._x-this._y*e._y-this._z*e._z+this._w*e._w;return t.copyFromFloats(i,r,s,n),t}multiplyInPlace(e){return this.multiplyToRef(e,this)}multiplyByFloats(e,t,i,r){return this._x*=e,this._y*=t,this._z*=i,this._w*=r,this._isDirty=!0,this}divide(e){throw new ReferenceError("Can not divide a quaternion")}divideToRef(e,t){throw new ReferenceError("Can not divide a quaternion")}divideInPlace(e){throw new ReferenceError("Can not divide a quaternion")}minimizeInPlace(){throw new ReferenceError("Can not minimize a quaternion")}minimizeInPlaceFromFloats(){throw new ReferenceError("Can not minimize a quaternion")}maximizeInPlace(){throw new ReferenceError("Can not maximize a quaternion")}maximizeInPlaceFromFloats(){throw new ReferenceError("Can not maximize a quaternion")}negate(){return this.negateToRef(new z)}negateInPlace(){return this._x=-this._x,this._y=-this._y,this._z=-this._z,this._w=-this._w,this._isDirty=!0,this}negateToRef(e){return e._x=-this._x,e._y=-this._y,e._z=-this._z,e._w=-this._w,e._isDirty=!0,e}equalsToFloats(e,t,i,r){return this._x===e&&this._y===t&&this._z===i&&this._w===r}floorToRef(e){throw new ReferenceError("Can not floor a quaternion")}floor(){throw new ReferenceError("Can not floor a quaternion")}fractToRef(e){throw new ReferenceError("Can not fract a quaternion")}fract(){throw new ReferenceError("Can not fract a quaternion")}conjugateToRef(e){return e.copyFromFloats(-this._x,-this._y,-this._z,this._w),e}conjugateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}conjugate(){return new z(-this._x,-this._y,-this._z,this._w)}invert(){const e=this.conjugate(),t=this.lengthSquared();return t==0||t==1||e.scaleInPlace(1/t),e}invertInPlace(){this.conjugateInPlace();const e=this.lengthSquared();return e==0||e==1?this:(this.scaleInPlace(1/e),this)}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this.lengthSquared())}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return e===0||e===1?this:this.scaleInPlace(1/e)}normalizeToNew(){const e=new z(0,0,0,1);return this.normalizeToRef(e),e}normalizeToRef(e){const t=this.length();return t===0||t===1?e.copyFromFloats(this._x,this._y,this._z,this._w):this.scaleToRef(1/t,e)}toEulerAngles(){const e=m.Zero();return this.toEulerAnglesToRef(e),e}toEulerAnglesToRef(e){const t=this._z,i=this._x,r=this._y,s=this._w,n=r*t-i*s,o=.4999999;if(n<-o)e._y=2*Math.atan2(r,s),e._x=Math.PI/2,e._z=0,e._isDirty=!0;else if(n>o)e._y=2*Math.atan2(r,s),e._x=-Math.PI/2,e._z=0,e._isDirty=!0;else{const l=s*s,c=t*t,h=i*i,f=r*r;e._z=Math.atan2(2*(i*r+t*s),-c-h+f+l),e._x=Math.asin(-2*n),e._y=Math.atan2(2*(t*i+r*s),c-h-f+l),e._isDirty=!0}return e}toAlphaBetaGammaToRef(e){const t=this._z,i=this._x,r=this._y,s=this._w,n=Math.sqrt(i*i+r*r),o=Math.sqrt(t*t+s*s),l=2*Math.atan2(n,o),c=2*Math.atan2(t,s),h=2*Math.atan2(r,i),f=(c+h)/2,u=(c-h)/2;return e.set(u,l,f),e}toRotationMatrix(e){return P.FromQuaternionToRef(this,e),e}fromRotationMatrix(e){return z.FromRotationMatrixToRef(e,this),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}static FromRotationMatrix(e){const t=new z;return z.FromRotationMatrixToRef(e,t),t}static FromRotationMatrixToRef(e,t){const i=e.m,r=i[0],s=i[4],n=i[8],o=i[1],l=i[5],c=i[9],h=i[2],f=i[6],u=i[10],d=r+l+u;let _;return d>0?(_=.5/Math.sqrt(d+1),t._w=.25/_,t._x=(f-c)*_,t._y=(n-h)*_,t._z=(o-s)*_,t._isDirty=!0):r>l&&r>u?(_=2*Math.sqrt(1+r-l-u),t._w=(f-c)/_,t._x=.25*_,t._y=(s+o)/_,t._z=(n+h)/_,t._isDirty=!0):l>u?(_=2*Math.sqrt(1+l-r-u),t._w=(n-h)/_,t._x=(s+o)/_,t._y=.25*_,t._z=(c+f)/_,t._isDirty=!0):(_=2*Math.sqrt(1+u-r-l),t._w=(o-s)/_,t._x=(n+h)/_,t._y=(c+f)/_,t._z=.25*_,t._isDirty=!0),t}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w}static AreClose(e,t,i=.1){const r=z.Dot(e,t);return 1-r*r<=i}static SmoothToRef(e,t,i,r,s){let n=r===0?1:i/r;return n=je(n,0,1),z.SlerpToRef(e,t,n,s),s}static Zero(){return new z(0,0,0,0)}static Inverse(e){return new z(-e._x,-e._y,-e._z,e._w)}static InverseToRef(e,t){return t.set(-e._x,-e._y,-e._z,e._w),t}static Identity(){return new z(0,0,0,1)}static IsIdentity(e){return e&&e._x===0&&e._y===0&&e._z===0&&e._w===1}static RotationAxis(e,t){return z.RotationAxisToRef(e,t,new z)}static RotationAxisToRef(e,t,i){i._w=Math.cos(t/2);const r=Math.sin(t/2)/e.length();return i._x=e._x*r,i._y=e._y*r,i._z=e._z*r,i._isDirty=!0,i}static FromArray(e,t){return t||(t=0),new z(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){return i._x=e[t],i._y=e[t+1],i._z=e[t+2],i._w=e[t+3],i._isDirty=!0,i}static FromFloatsToRef(e,t,i,r,s){return s.copyFromFloats(e,t,i,r),s}static FromEulerAngles(e,t,i){const r=new z;return z.RotationYawPitchRollToRef(t,e,i,r),r}static FromEulerAnglesToRef(e,t,i,r){return z.RotationYawPitchRollToRef(t,e,i,r),r}static FromEulerVector(e){const t=new z;return z.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromEulerVectorToRef(e,t){return z.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromUnitVectorsToRef(e,t,i,r=Ke){const s=m.Dot(e,t)+1;return s<r?Math.abs(e.x)>Math.abs(e.z)?i.set(-e.y,e.x,0,0):i.set(0,-e.z,e.y,0):(m.CrossToRef(e,t,F.Vector3[0]),i.set(F.Vector3[0].x,F.Vector3[0].y,F.Vector3[0].z,s)),i.normalize()}static RotationYawPitchRoll(e,t,i){const r=new z;return z.RotationYawPitchRollToRef(e,t,i,r),r}static RotationYawPitchRollToRef(e,t,i,r){const s=i*.5,n=t*.5,o=e*.5,l=Math.sin(s),c=Math.cos(s),h=Math.sin(n),f=Math.cos(n),u=Math.sin(o),d=Math.cos(o);return r._x=d*h*c+u*f*l,r._y=u*f*c-d*h*l,r._z=d*f*l-u*h*c,r._w=d*f*c+u*h*l,r._isDirty=!0,r}static RotationAlphaBetaGamma(e,t,i){const r=new z;return z.RotationAlphaBetaGammaToRef(e,t,i,r),r}static RotationAlphaBetaGammaToRef(e,t,i,r){const s=(i+e)*.5,n=(i-e)*.5,o=t*.5;return r._x=Math.cos(n)*Math.sin(o),r._y=Math.sin(n)*Math.sin(o),r._z=Math.sin(s)*Math.cos(o),r._w=Math.cos(s)*Math.cos(o),r._isDirty=!0,r}static RotationQuaternionFromAxis(e,t,i){const r=new z(0,0,0,0);return z.RotationQuaternionFromAxisToRef(e,t,i,r),r}static RotationQuaternionFromAxisToRef(e,t,i,r){const s=de.Matrix[0];return e=e.normalizeToRef(de.Vector3[0]),t=t.normalizeToRef(de.Vector3[1]),i=i.normalizeToRef(de.Vector3[2]),P.FromXYZAxesToRef(e,t,i,s),z.FromRotationMatrixToRef(s,r),r}static FromLookDirectionLH(e,t){const i=new z;return z.FromLookDirectionLHToRef(e,t,i),i}static FromLookDirectionLHToRef(e,t,i){const r=de.Matrix[0];return P.LookDirectionLHToRef(e,t,r),z.FromRotationMatrixToRef(r,i),i}static FromLookDirectionRH(e,t){const i=new z;return z.FromLookDirectionRHToRef(e,t,i),i}static FromLookDirectionRHToRef(e,t,i){const r=de.Matrix[0];return P.LookDirectionRHToRef(e,t,r),z.FromRotationMatrixToRef(r,i)}static Slerp(e,t,i){const r=z.Identity();return z.SlerpToRef(e,t,i,r),r}static SlerpToRef(e,t,i,r){let s,n,o=e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w,l=!1;if(o<0&&(l=!0,o=-o),o>.999999)n=1-i,s=l?-i:i;else{const c=Math.acos(o),h=1/Math.sin(c);n=Math.sin((1-i)*c)*h,s=l?-Math.sin(i*c)*h:Math.sin(i*c)*h}return r._x=n*e._x+s*t._x,r._y=n*e._y+s*t._y,r._z=n*e._z+s*t._z,r._w=n*e._w+s*t._w,r._isDirty=!0,r}static Hermite(e,t,i,r,s){const n=s*s,o=s*n,l=2*o-3*n+1,c=-2*o+3*n,h=o-2*n+s,f=o-n,u=e._x*l+i._x*c+t._x*h+r._x*f,d=e._y*l+i._y*c+t._y*h+r._y*f,_=e._z*l+i._z*c+t._z*h+r._z*f,p=e._w*l+i._w*c+t._w*h+r._w*f;return new z(u,d,_,p)}static Hermite1stDerivative(e,t,i,r,s){const n=new z;return this.Hermite1stDerivativeToRef(e,t,i,r,s,n),n}static Hermite1stDerivativeToRef(e,t,i,r,s,n){const o=s*s;return n._x=(o-s)*6*e._x+(3*o-4*s+1)*t._x+(-o+s)*6*i._x+(3*o-2*s)*r._x,n._y=(o-s)*6*e._y+(3*o-4*s+1)*t._y+(-o+s)*6*i._y+(3*o-2*s)*r._y,n._z=(o-s)*6*e._z+(3*o-4*s+1)*t._z+(-o+s)*6*i._z+(3*o-2*s)*r._z,n._w=(o-s)*6*e._w+(3*o-4*s+1)*t._w+(-o+s)*6*i._w+(3*o-2*s)*r._w,n._isDirty=!0,n}static Normalize(e){const t=z.Zero();return z.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Clamp(e,t,i){const r=new z;return z.ClampToRef(e,t,i,r),r}static ClampToRef(e,t,i,r){return r.copyFromFloats(je(e.x,t.x,i.x),je(e.y,t.y,i.y),je(e.z,t.z,i.z),je(e.w,t.w,i.w))}static Random(e=0,t=1){return new z(Mt(e,t),Mt(e,t),Mt(e,t),Mt(e,t))}static RandomToRef(e=0,t=1,i){return i.copyFromFloats(Mt(e,t),Mt(e,t),Mt(e,t),Mt(e,t))}static Minimize(){throw new ReferenceError("Quaternion.Minimize does not make sense")}static Maximize(){throw new ReferenceError("Quaternion.Maximize does not make sense")}static Distance(e,t){return Math.sqrt(z.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,r=e.y-t.y,s=e.z-t.z,n=e.w-t.w;return i*i+r*r+s*s+n*n}static Center(e,t){return z.CenterToRef(e,t,z.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2,(e.z+t.z)/2,(e.w+t.w)/2)}}z._V8PerformanceHack=new z(.5,.5,.5,.5);Object.defineProperties(z.prototype,{dimension:{value:[4]},rank:{value:1}});class P{static get Use64Bits(){return Xt.MatrixUse64Bits}get m(){return this._m}markAsUpdated(){this.updateFlag=P._UpdateFlagSeed++,this._isIdentity=!1,this._isIdentity3x2=!1,this._isIdentityDirty=!0,this._isIdentity3x2Dirty=!0}_updateIdentityStatus(e,t=!1,i=!1,r=!0){this._isIdentity=e,this._isIdentity3x2=e||i,this._isIdentityDirty=this._isIdentity?!1:t,this._isIdentity3x2Dirty=this._isIdentity3x2?!1:r}constructor(){this._isIdentity=!1,this._isIdentityDirty=!0,this._isIdentity3x2=!0,this._isIdentity3x2Dirty=!0,this.updateFlag=-1,Xt.MatrixTrackPrecisionChange&&Xt.MatrixTrackedMatrices.push(this),this._m=new Xt.MatrixCurrentType(16),this.markAsUpdated()}isIdentity(){if(this._isIdentityDirty){this._isIdentityDirty=!1;const e=this._m;this._isIdentity=e[0]===1&&e[1]===0&&e[2]===0&&e[3]===0&&e[4]===0&&e[5]===1&&e[6]===0&&e[7]===0&&e[8]===0&&e[9]===0&&e[10]===1&&e[11]===0&&e[12]===0&&e[13]===0&&e[14]===0&&e[15]===1}return this._isIdentity}isIdentityAs3x2(){return this._isIdentity3x2Dirty&&(this._isIdentity3x2Dirty=!1,this._m[0]!==1||this._m[5]!==1||this._m[15]!==1?this._isIdentity3x2=!1:this._m[1]!==0||this._m[2]!==0||this._m[3]!==0||this._m[4]!==0||this._m[6]!==0||this._m[7]!==0||this._m[8]!==0||this._m[9]!==0||this._m[10]!==0||this._m[11]!==0||this._m[12]!==0||this._m[13]!==0||this._m[14]!==0?this._isIdentity3x2=!1:this._isIdentity3x2=!0),this._isIdentity3x2}determinant(){if(this._isIdentity===!0)return 1;const e=this._m,t=e[0],i=e[1],r=e[2],s=e[3],n=e[4],o=e[5],l=e[6],c=e[7],h=e[8],f=e[9],u=e[10],d=e[11],_=e[12],p=e[13],g=e[14],E=e[15],v=u*E-g*d,b=f*E-p*d,R=f*g-p*u,S=h*E-_*d,T=h*g-u*_,I=h*p-_*f,O=+(o*v-l*b+c*R),L=-(n*v-l*S+c*T),w=+(n*b-o*S+c*I),$=-(n*R-o*T+l*I);return t*O+i*L+r*w+s*$}toString(){return`{${this.m[0]}, ${this.m[1]}, ${this.m[2]}, ${this.m[3]}
${this.m[4]}, ${this.m[5]}, ${this.m[6]}, ${this.m[7]}
${this.m[8]}, ${this.m[9]}, ${this.m[10]}, ${this.m[11]}
${this.m[12]}, ${this.m[13]}, ${this.m[14]}, ${this.m[15]}}`}toArray(e=null,t=0){if(!e)return this._m;const i=this._m;for(let r=0;r<16;r++)e[t+r]=i[r];return this}asArray(){return this._m}fromArray(e,t=0){return P.FromArrayToRef(e,t,this)}copyFromFloats(...e){return P.FromArrayToRef(e,0,this)}set(...e){const t=this._m;for(let i=0;i<16;i++)t[i]=e[i];return this.markAsUpdated(),this}setAll(e){const t=this._m;for(let i=0;i<16;i++)t[i]=e;return this.markAsUpdated(),this}invert(){return this.invertToRef(this),this}reset(){return P.FromValuesToRef(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,this),this._updateIdentityStatus(!1),this}add(e){const t=new P;return this.addToRef(e,t),t}addToRef(e,t){const i=this._m,r=t._m,s=e.m;for(let n=0;n<16;n++)r[n]=i[n]+s[n];return t.markAsUpdated(),t}addToSelf(e){const t=this._m,i=e.m;return t[0]+=i[0],t[1]+=i[1],t[2]+=i[2],t[3]+=i[3],t[4]+=i[4],t[5]+=i[5],t[6]+=i[6],t[7]+=i[7],t[8]+=i[8],t[9]+=i[9],t[10]+=i[10],t[11]+=i[11],t[12]+=i[12],t[13]+=i[13],t[14]+=i[14],t[15]+=i[15],this.markAsUpdated(),this}addInPlace(e){const t=this._m,i=e.m;for(let r=0;r<16;r++)t[r]+=i[r];return this.markAsUpdated(),this}addInPlaceFromFloats(...e){const t=this._m;for(let i=0;i<16;i++)t[i]+=e[i];return this.markAsUpdated(),this}subtract(e){const t=this._m,i=e.m;for(let r=0;r<16;r++)t[r]-=i[r];return this.markAsUpdated(),this}subtractToRef(e,t){const i=this._m,r=e.m,s=t._m;for(let n=0;n<16;n++)s[n]=i[n]-r[n];return t.markAsUpdated(),t}subtractInPlace(e){const t=this._m,i=e.m;for(let r=0;r<16;r++)t[r]-=i[r];return this.markAsUpdated(),this}subtractFromFloats(...e){return this.subtractFromFloatsToRef(...e,new P)}subtractFromFloatsToRef(...e){const t=e.pop(),i=this._m,r=t._m,s=e;for(let n=0;n<16;n++)r[n]=i[n]-s[n];return t.markAsUpdated(),t}invertToRef(e){if(this._isIdentity===!0)return P.IdentityToRef(e),e;const t=this._m,i=t[0],r=t[1],s=t[2],n=t[3],o=t[4],l=t[5],c=t[6],h=t[7],f=t[8],u=t[9],d=t[10],_=t[11],p=t[12],g=t[13],E=t[14],v=t[15],b=d*v-E*_,R=u*v-g*_,S=u*E-g*d,T=f*v-p*_,I=f*E-d*p,O=f*g-p*u,L=+(l*b-c*R+h*S),w=-(o*b-c*T+h*I),$=+(o*R-l*T+h*O),J=-(o*S-l*I+c*O),ce=i*L+r*w+s*$+n*J;if(ce===0)return e.copyFrom(this),e;const le=1/ce,oe=c*v-E*h,ue=l*v-g*h,Pe=l*E-g*c,Se=o*v-p*h,ie=o*E-p*c,K=o*g-p*l,M=c*_-d*h,V=l*_-u*h,re=l*d-u*c,ve=o*_-f*h,Be=o*d-f*c,fe=o*u-f*l,me=-(r*b-s*R+n*S),Oe=+(i*b-s*T+n*I),Ee=-(i*R-r*T+n*O),Ue=+(i*S-r*I+s*O),vt=+(r*oe-s*ue+n*Pe),xe=-(i*oe-s*Se+n*ie),Ye=+(i*ue-r*Se+n*K),Me=-(i*Pe-r*ie+s*K),Tt=-(r*M-s*V+n*re),Lt=+(i*M-s*ve+n*Be),Kt=-(i*V-r*ve+n*fe),Ci=+(i*re-r*Be+s*fe);return P.FromValuesToRef(L*le,me*le,vt*le,Tt*le,w*le,Oe*le,xe*le,Lt*le,$*le,Ee*le,Ye*le,Kt*le,J*le,Ue*le,Me*le,Ci*le,e),e}addAtIndex(e,t){return this._m[e]+=t,this.markAsUpdated(),this}multiplyAtIndex(e,t){return this._m[e]*=t,this.markAsUpdated(),this}setTranslationFromFloats(e,t,i){return this._m[12]=e,this._m[13]=t,this._m[14]=i,this.markAsUpdated(),this}addTranslationFromFloats(e,t,i){return this._m[12]+=e,this._m[13]+=t,this._m[14]+=i,this.markAsUpdated(),this}setTranslation(e){return this.setTranslationFromFloats(e._x,e._y,e._z)}getTranslation(){return new m(this._m[12],this._m[13],this._m[14])}getTranslationToRef(e){return e.x=this._m[12],e.y=this._m[13],e.z=this._m[14],e}removeRotationAndScaling(){const e=this.m;return P.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e[12],e[13],e[14],e[15],this),this._updateIdentityStatus(e[12]===0&&e[13]===0&&e[14]===0&&e[15]===1),this}copyFrom(e){e.copyToArray(this._m);const t=e;return this.updateFlag=t.updateFlag,this._updateIdentityStatus(t._isIdentity,t._isIdentityDirty,t._isIdentity3x2,t._isIdentity3x2Dirty),this}copyToArray(e,t=0){const i=this._m;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],this}multiply(e){const t=new P;return this.multiplyToRef(e,t),t}multiplyInPlace(e){const t=this._m,i=e.m;for(let r=0;r<16;r++)t[r]*=i[r];return this.markAsUpdated(),this}multiplyByFloats(...e){const t=this._m;for(let i=0;i<16;i++)t[i]*=e[i];return this.markAsUpdated(),this}multiplyByFloatsToRef(...e){const t=e.pop(),i=this._m,r=t._m,s=e;for(let n=0;n<16;n++)r[n]=i[n]*s[n];return t.markAsUpdated(),t}multiplyToRef(e,t){return this._isIdentity?(t.copyFrom(e),t):e._isIdentity?(t.copyFrom(this),t):(this.multiplyToArray(e,t._m,0),t.markAsUpdated(),t)}multiplyToArray(e,t,i){const r=this._m,s=e.m,n=r[0],o=r[1],l=r[2],c=r[3],h=r[4],f=r[5],u=r[6],d=r[7],_=r[8],p=r[9],g=r[10],E=r[11],v=r[12],b=r[13],R=r[14],S=r[15],T=s[0],I=s[1],O=s[2],L=s[3],w=s[4],$=s[5],J=s[6],ce=s[7],le=s[8],oe=s[9],ue=s[10],Pe=s[11],Se=s[12],ie=s[13],K=s[14],M=s[15];return t[i]=n*T+o*w+l*le+c*Se,t[i+1]=n*I+o*$+l*oe+c*ie,t[i+2]=n*O+o*J+l*ue+c*K,t[i+3]=n*L+o*ce+l*Pe+c*M,t[i+4]=h*T+f*w+u*le+d*Se,t[i+5]=h*I+f*$+u*oe+d*ie,t[i+6]=h*O+f*J+u*ue+d*K,t[i+7]=h*L+f*ce+u*Pe+d*M,t[i+8]=_*T+p*w+g*le+E*Se,t[i+9]=_*I+p*$+g*oe+E*ie,t[i+10]=_*O+p*J+g*ue+E*K,t[i+11]=_*L+p*ce+g*Pe+E*M,t[i+12]=v*T+b*w+R*le+S*Se,t[i+13]=v*I+b*$+R*oe+S*ie,t[i+14]=v*O+b*J+R*ue+S*K,t[i+15]=v*L+b*ce+R*Pe+S*M,this}divide(e){return this.divideToRef(e,new P)}divideToRef(e,t){const i=this._m,r=e.m,s=t._m;for(let n=0;n<16;n++)s[n]=i[n]/r[n];return t.markAsUpdated(),t}divideInPlace(e){const t=this._m,i=e.m;for(let r=0;r<16;r++)t[r]/=i[r];return this.markAsUpdated(),this}minimizeInPlace(e){const t=this._m,i=e.m;for(let r=0;r<16;r++)t[r]=Math.min(t[r],i[r]);return this.markAsUpdated(),this}minimizeInPlaceFromFloats(...e){const t=this._m;for(let i=0;i<16;i++)t[i]=Math.min(t[i],e[i]);return this.markAsUpdated(),this}maximizeInPlace(e){const t=this._m,i=e.m;for(let r=0;r<16;r++)t[r]=Math.min(t[r],i[r]);return this.markAsUpdated(),this}maximizeInPlaceFromFloats(...e){const t=this._m;for(let i=0;i<16;i++)t[i]=Math.min(t[i],e[i]);return this.markAsUpdated(),this}negate(){return this.negateToRef(new P)}negateInPlace(){const e=this._m;for(let t=0;t<16;t++)e[t]=-e[t];return this.markAsUpdated(),this}negateToRef(e){const t=this._m,i=e._m;for(let r=0;r<16;r++)i[r]=-t[r];return e.markAsUpdated(),e}equals(e){const t=e;if(!t)return!1;if((this._isIdentity||t._isIdentity)&&!this._isIdentityDirty&&!t._isIdentityDirty)return this._isIdentity&&t._isIdentity;const i=this.m,r=t.m;return i[0]===r[0]&&i[1]===r[1]&&i[2]===r[2]&&i[3]===r[3]&&i[4]===r[4]&&i[5]===r[5]&&i[6]===r[6]&&i[7]===r[7]&&i[8]===r[8]&&i[9]===r[9]&&i[10]===r[10]&&i[11]===r[11]&&i[12]===r[12]&&i[13]===r[13]&&i[14]===r[14]&&i[15]===r[15]}equalsWithEpsilon(e,t=0){const i=this._m,r=e.m;for(let s=0;s<16;s++)if(!nt(i[s],r[s],t))return!1;return!0}equalsToFloats(...e){const t=this._m;for(let i=0;i<16;i++)if(t[i]!=e[i])return!1;return!0}floor(){return this.floorToRef(new P)}floorToRef(e){const t=this._m,i=e._m;for(let r=0;r<16;r++)i[r]=Math.floor(t[r]);return e.markAsUpdated(),e}fract(){return this.fractToRef(new P)}fractToRef(e){const t=this._m,i=e._m;for(let r=0;r<16;r++)i[r]=t[r]-Math.floor(t[r]);return e.markAsUpdated(),e}clone(){const e=new P;return e.copyFrom(this),e}getClassName(){return"Matrix"}getHashCode(){let e=gi(this._m[0]);for(let t=1;t<16;t++)e=e*397^gi(this._m[t]);return e}decomposeToTransformNode(e){return e.rotationQuaternion=e.rotationQuaternion||new z,this.decompose(e.scaling,e.rotationQuaternion,e.position)}decompose(e,t,i,r,s=!0){if(this._isIdentity)return i&&i.setAll(0),e&&e.setAll(1),t&&t.copyFromFloats(0,0,0,1),!0;const n=this._m;if(i&&i.copyFromFloats(n[12],n[13],n[14]),e=e||de.Vector3[0],e.x=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]),e.y=Math.sqrt(n[4]*n[4]+n[5]*n[5]+n[6]*n[6]),e.z=Math.sqrt(n[8]*n[8]+n[9]*n[9]+n[10]*n[10]),r){const o=(s?r.absoluteScaling.x:r.scaling.x)<0?-1:1,l=(s?r.absoluteScaling.y:r.scaling.y)<0?-1:1,c=(s?r.absoluteScaling.z:r.scaling.z)<0?-1:1;e.x*=o,e.y*=l,e.z*=c}else this.determinant()<=0&&(e.y*=-1);if(e._x===0||e._y===0||e._z===0)return t&&t.copyFromFloats(0,0,0,1),!1;if(t){const o=1/e._x,l=1/e._y,c=1/e._z;P.FromValuesToRef(n[0]*o,n[1]*o,n[2]*o,0,n[4]*l,n[5]*l,n[6]*l,0,n[8]*c,n[9]*c,n[10]*c,0,0,0,0,1,de.Matrix[0]),z.FromRotationMatrixToRef(de.Matrix[0],t)}return!0}getRow(e){if(e<0||e>3)return null;const t=e*4;return new Fe(this._m[t+0],this._m[t+1],this._m[t+2],this._m[t+3])}getRowToRef(e,t){if(e>=0&&e<=3){const i=e*4;t.x=this._m[i+0],t.y=this._m[i+1],t.z=this._m[i+2],t.w=this._m[i+3]}return t}setRow(e,t){return this.setRowFromFloats(e,t.x,t.y,t.z,t.w)}transpose(){const e=new P;return P.TransposeToRef(this,e),e}transposeToRef(e){return P.TransposeToRef(this,e),e}setRowFromFloats(e,t,i,r,s){if(e<0||e>3)return this;const n=e*4;return this._m[n+0]=t,this._m[n+1]=i,this._m[n+2]=r,this._m[n+3]=s,this.markAsUpdated(),this}scale(e){const t=new P;return this.scaleToRef(e,t),t}scaleToRef(e,t){for(let i=0;i<16;i++)t._m[i]=this._m[i]*e;return t.markAsUpdated(),t}scaleAndAddToRef(e,t){for(let i=0;i<16;i++)t._m[i]+=this._m[i]*e;return t.markAsUpdated(),t}scaleInPlace(e){const t=this._m;for(let i=0;i<16;i++)t[i]*=e;return this.markAsUpdated(),this}toNormalMatrix(e){const t=de.Matrix[0];this.invertToRef(t),t.transposeToRef(e);const i=e._m;return P.FromValuesToRef(i[0],i[1],i[2],0,i[4],i[5],i[6],0,i[8],i[9],i[10],0,0,0,0,1,e),e}getRotationMatrix(){const e=new P;return this.getRotationMatrixToRef(e),e}getRotationMatrixToRef(e){const t=de.Vector3[0];if(!this.decompose(t))return P.IdentityToRef(e),e;const i=this._m,r=1/t._x,s=1/t._y,n=1/t._z;return P.FromValuesToRef(i[0]*r,i[1]*r,i[2]*r,0,i[4]*s,i[5]*s,i[6]*s,0,i[8]*n,i[9]*n,i[10]*n,0,0,0,0,1,e),e}toggleModelMatrixHandInPlace(){const e=this._m;return e[2]*=-1,e[6]*=-1,e[8]*=-1,e[9]*=-1,e[14]*=-1,this.markAsUpdated(),this}toggleProjectionMatrixHandInPlace(){const e=this._m;return e[8]*=-1,e[9]*=-1,e[10]*=-1,e[11]*=-1,this.markAsUpdated(),this}static FromArray(e,t=0){const i=new P;return P.FromArrayToRef(e,t,i),i}static FromArrayToRef(e,t,i){for(let r=0;r<16;r++)i._m[r]=e[r+t];return i.markAsUpdated(),i}static FromFloat32ArrayToRefScaled(e,t,i,r){return r._m[0]=e[0+t]*i,r._m[1]=e[1+t]*i,r._m[2]=e[2+t]*i,r._m[3]=e[3+t]*i,r._m[4]=e[4+t]*i,r._m[5]=e[5+t]*i,r._m[6]=e[6+t]*i,r._m[7]=e[7+t]*i,r._m[8]=e[8+t]*i,r._m[9]=e[9+t]*i,r._m[10]=e[10+t]*i,r._m[11]=e[11+t]*i,r._m[12]=e[12+t]*i,r._m[13]=e[13+t]*i,r._m[14]=e[14+t]*i,r._m[15]=e[15+t]*i,r.markAsUpdated(),r}static get IdentityReadOnly(){return P._IdentityReadOnly}static FromValuesToRef(e,t,i,r,s,n,o,l,c,h,f,u,d,_,p,g,E){const v=E._m;v[0]=e,v[1]=t,v[2]=i,v[3]=r,v[4]=s,v[5]=n,v[6]=o,v[7]=l,v[8]=c,v[9]=h,v[10]=f,v[11]=u,v[12]=d,v[13]=_,v[14]=p,v[15]=g,E.markAsUpdated()}static FromValues(e,t,i,r,s,n,o,l,c,h,f,u,d,_,p,g){const E=new P,v=E._m;return v[0]=e,v[1]=t,v[2]=i,v[3]=r,v[4]=s,v[5]=n,v[6]=o,v[7]=l,v[8]=c,v[9]=h,v[10]=f,v[11]=u,v[12]=d,v[13]=_,v[14]=p,v[15]=g,E.markAsUpdated(),E}static Compose(e,t,i){const r=new P;return P.ComposeToRef(e,t,i,r),r}static ComposeToRef(e,t,i,r){const s=r._m,n=t._x,o=t._y,l=t._z,c=t._w,h=n+n,f=o+o,u=l+l,d=n*h,_=n*f,p=n*u,g=o*f,E=o*u,v=l*u,b=c*h,R=c*f,S=c*u,T=e._x,I=e._y,O=e._z;return s[0]=(1-(g+v))*T,s[1]=(_+S)*T,s[2]=(p-R)*T,s[3]=0,s[4]=(_-S)*I,s[5]=(1-(d+v))*I,s[6]=(E+b)*I,s[7]=0,s[8]=(p+R)*O,s[9]=(E-b)*O,s[10]=(1-(d+g))*O,s[11]=0,s[12]=i._x,s[13]=i._y,s[14]=i._z,s[15]=1,r.markAsUpdated(),r}static Identity(){const e=P.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return e._updateIdentityStatus(!0),e}static IdentityToRef(e){return P.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,e),e._updateIdentityStatus(!0),e}static Zero(){const e=P.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);return e._updateIdentityStatus(!1),e}static RotationX(e){const t=new P;return P.RotationXToRef(e,t),t}static Invert(e){const t=new P;return e.invertToRef(t),t}static RotationXToRef(e,t){const i=Math.sin(e),r=Math.cos(e);return P.FromValuesToRef(1,0,0,0,0,r,i,0,0,-i,r,0,0,0,0,1,t),t._updateIdentityStatus(r===1&&i===0),t}static RotationY(e){const t=new P;return P.RotationYToRef(e,t),t}static RotationYToRef(e,t){const i=Math.sin(e),r=Math.cos(e);return P.FromValuesToRef(r,0,-i,0,0,1,0,0,i,0,r,0,0,0,0,1,t),t._updateIdentityStatus(r===1&&i===0),t}static RotationZ(e){const t=new P;return P.RotationZToRef(e,t),t}static RotationZToRef(e,t){const i=Math.sin(e),r=Math.cos(e);return P.FromValuesToRef(r,i,0,0,-i,r,0,0,0,0,1,0,0,0,0,1,t),t._updateIdentityStatus(r===1&&i===0),t}static RotationAxis(e,t){const i=new P;return P.RotationAxisToRef(e,t,i),i}static RotationAxisToRef(e,t,i){const r=Math.sin(-t),s=Math.cos(-t),n=1-s;e=e.normalizeToRef(de.Vector3[0]);const o=i._m;return o[0]=e._x*e._x*n+s,o[1]=e._x*e._y*n-e._z*r,o[2]=e._x*e._z*n+e._y*r,o[3]=0,o[4]=e._y*e._x*n+e._z*r,o[5]=e._y*e._y*n+s,o[6]=e._y*e._z*n-e._x*r,o[7]=0,o[8]=e._z*e._x*n-e._y*r,o[9]=e._z*e._y*n+e._x*r,o[10]=e._z*e._z*n+s,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,i.markAsUpdated(),i}static RotationAlignToRef(e,t,i,r=!1){const s=m.Dot(t,e),n=i._m;if(s<-1+Ke)n[0]=-1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=r?1:-1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=r?-1:1,n[11]=0;else{const o=m.Cross(t,e),l=1/(1+s);n[0]=o._x*o._x*l+s,n[1]=o._y*o._x*l-o._z,n[2]=o._z*o._x*l+o._y,n[3]=0,n[4]=o._x*o._y*l+o._z,n[5]=o._y*o._y*l+s,n[6]=o._z*o._y*l-o._x,n[7]=0,n[8]=o._x*o._z*l-o._y,n[9]=o._y*o._z*l+o._x,n[10]=o._z*o._z*l+s,n[11]=0}return n[12]=0,n[13]=0,n[14]=0,n[15]=1,i.markAsUpdated(),i}static RotationYawPitchRoll(e,t,i){const r=new P;return P.RotationYawPitchRollToRef(e,t,i,r),r}static RotationYawPitchRollToRef(e,t,i,r){return z.RotationYawPitchRollToRef(e,t,i,de.Quaternion[0]),de.Quaternion[0].toRotationMatrix(r),r}static Scaling(e,t,i){const r=new P;return P.ScalingToRef(e,t,i,r),r}static ScalingToRef(e,t,i,r){return P.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1,r),r._updateIdentityStatus(e===1&&t===1&&i===1),r}static Translation(e,t,i){const r=new P;return P.TranslationToRef(e,t,i,r),r}static TranslationToRef(e,t,i,r){return P.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e,t,i,1,r),r._updateIdentityStatus(e===0&&t===0&&i===0),r}static Lerp(e,t,i){const r=new P;return P.LerpToRef(e,t,i,r),r}static LerpToRef(e,t,i,r){const s=r._m,n=e.m,o=t.m;for(let l=0;l<16;l++)s[l]=n[l]*(1-i)+o[l]*i;return r.markAsUpdated(),r}static DecomposeLerp(e,t,i){const r=new P;return P.DecomposeLerpToRef(e,t,i,r),r}static DecomposeLerpToRef(e,t,i,r){const s=de.Vector3[0],n=de.Quaternion[0],o=de.Vector3[1];e.decompose(s,n,o);const l=de.Vector3[2],c=de.Quaternion[1],h=de.Vector3[3];t.decompose(l,c,h);const f=de.Vector3[4];m.LerpToRef(s,l,i,f);const u=de.Quaternion[2];z.SlerpToRef(n,c,i,u);const d=de.Vector3[5];return m.LerpToRef(o,h,i,d),P.ComposeToRef(f,u,d,r),r}static LookAtLH(e,t,i){const r=new P;return P.LookAtLHToRef(e,t,i,r),r}static LookAtLHToRef(e,t,i,r){const s=de.Vector3[0],n=de.Vector3[1],o=de.Vector3[2];t.subtractToRef(e,o),o.normalize(),m.CrossToRef(i,o,s);const l=s.lengthSquared();l===0?s.x=1:s.normalizeFromLength(Math.sqrt(l)),m.CrossToRef(o,s,n),n.normalize();const c=-m.Dot(s,e),h=-m.Dot(n,e),f=-m.Dot(o,e);return P.FromValuesToRef(s._x,n._x,o._x,0,s._y,n._y,o._y,0,s._z,n._z,o._z,0,c,h,f,1,r),r}static LookAtRH(e,t,i){const r=new P;return P.LookAtRHToRef(e,t,i,r),r}static LookAtRHToRef(e,t,i,r){const s=de.Vector3[0],n=de.Vector3[1],o=de.Vector3[2];e.subtractToRef(t,o),o.normalize(),m.CrossToRef(i,o,s);const l=s.lengthSquared();l===0?s.x=1:s.normalizeFromLength(Math.sqrt(l)),m.CrossToRef(o,s,n),n.normalize();const c=-m.Dot(s,e),h=-m.Dot(n,e),f=-m.Dot(o,e);return P.FromValuesToRef(s._x,n._x,o._x,0,s._y,n._y,o._y,0,s._z,n._z,o._z,0,c,h,f,1,r),r}static LookDirectionLH(e,t){const i=new P;return P.LookDirectionLHToRef(e,t,i),i}static LookDirectionLHToRef(e,t,i){const r=de.Vector3[0];r.copyFrom(e),r.scaleInPlace(-1);const s=de.Vector3[1];return m.CrossToRef(t,r,s),P.FromValuesToRef(s._x,s._y,s._z,0,t._x,t._y,t._z,0,r._x,r._y,r._z,0,0,0,0,1,i),i}static LookDirectionRH(e,t){const i=new P;return P.LookDirectionRHToRef(e,t,i),i}static LookDirectionRHToRef(e,t,i){const r=de.Vector3[2];return m.CrossToRef(t,e,r),P.FromValuesToRef(r._x,r._y,r._z,0,t._x,t._y,t._z,0,e._x,e._y,e._z,0,0,0,0,1,i),i}static OrthoLH(e,t,i,r,s){const n=new P;return P.OrthoLHToRef(e,t,i,r,n,s),n}static OrthoLHToRef(e,t,i,r,s,n){const o=i,l=r,c=2/e,h=2/t,f=2/(l-o),u=-(l+o)/(l-o);return P.FromValuesToRef(c,0,0,0,0,h,0,0,0,0,f,0,0,0,u,1,s),n&&s.multiplyToRef(ls,s),s._updateIdentityStatus(c===1&&h===1&&f===1&&u===0),s}static OrthoOffCenterLH(e,t,i,r,s,n,o){const l=new P;return P.OrthoOffCenterLHToRef(e,t,i,r,s,n,l,o),l}static OrthoOffCenterLHToRef(e,t,i,r,s,n,o,l){const c=s,h=n,f=2/(t-e),u=2/(r-i),d=2/(h-c),_=-(h+c)/(h-c),p=(e+t)/(e-t),g=(r+i)/(i-r);return P.FromValuesToRef(f,0,0,0,0,u,0,0,0,0,d,0,p,g,_,1,o),l&&o.multiplyToRef(ls,o),o.markAsUpdated(),o}static ObliqueOffCenterLHToRef(e,t,i,r,s,n,o,l,c,h,f){const u=-o*Math.cos(l),d=-o*Math.sin(l);return P.TranslationToRef(0,0,-c,de.Matrix[1]),P.FromValuesToRef(1,0,0,0,0,1,0,0,u,d,1,0,0,0,0,1,de.Matrix[0]),de.Matrix[1].multiplyToRef(de.Matrix[0],de.Matrix[0]),P.TranslationToRef(0,0,c,de.Matrix[1]),de.Matrix[0].multiplyToRef(de.Matrix[1],de.Matrix[0]),P.OrthoOffCenterLHToRef(e,t,i,r,s,n,h,f),de.Matrix[0].multiplyToRef(h,h),h}static OrthoOffCenterRH(e,t,i,r,s,n,o){const l=new P;return P.OrthoOffCenterRHToRef(e,t,i,r,s,n,l,o),l}static OrthoOffCenterRHToRef(e,t,i,r,s,n,o,l){return P.OrthoOffCenterLHToRef(e,t,i,r,s,n,o,l),o._m[10]*=-1,o}static ObliqueOffCenterRHToRef(e,t,i,r,s,n,o,l,c,h,f){const u=o*Math.cos(l),d=o*Math.sin(l);return P.TranslationToRef(0,0,c,de.Matrix[1]),P.FromValuesToRef(1,0,0,0,0,1,0,0,u,d,1,0,0,0,0,1,de.Matrix[0]),de.Matrix[1].multiplyToRef(de.Matrix[0],de.Matrix[0]),P.TranslationToRef(0,0,-c,de.Matrix[1]),de.Matrix[0].multiplyToRef(de.Matrix[1],de.Matrix[0]),P.OrthoOffCenterRHToRef(e,t,i,r,s,n,h,f),de.Matrix[0].multiplyToRef(h,h),h}static PerspectiveLH(e,t,i,r,s,n=0){const o=new P,l=i,c=r,h=2*l/e,f=2*l/t,u=(c+l)/(c-l),d=-2*c*l/(c-l),_=Math.tan(n);return P.FromValuesToRef(h,0,0,0,0,f,0,_,0,0,u,1,0,0,d,0,o),s&&o.multiplyToRef(ls,o),o._updateIdentityStatus(!1),o}static PerspectiveFovLH(e,t,i,r,s,n=0,o=!1){const l=new P;return P.PerspectiveFovLHToRef(e,t,i,r,l,!0,s,n,o),l}static PerspectiveFovLHToRef(e,t,i,r,s,n=!0,o,l=0,c=!1){const h=i,f=r,u=1/Math.tan(e*.5),d=n?u/t:u,_=n?u:u*t,p=c&&h===0?-1:f!==0?(f+h)/(f-h):1,g=c&&h===0?2*f:f!==0?-2*f*h/(f-h):-2*h,E=Math.tan(l);return P.FromValuesToRef(d,0,0,0,0,_,0,E,0,0,p,1,0,0,g,0,s),o&&s.multiplyToRef(ls,s),s._updateIdentityStatus(!1),s}static PerspectiveFovReverseLHToRef(e,t,i,r,s,n=!0,o,l=0){const c=1/Math.tan(e*.5),h=n?c/t:c,f=n?c:c*t,u=Math.tan(l);return P.FromValuesToRef(h,0,0,0,0,f,0,u,0,0,-i,1,0,0,1,0,s),o&&s.multiplyToRef(ls,s),s._updateIdentityStatus(!1),s}static PerspectiveFovRH(e,t,i,r,s,n=0,o=!1){const l=new P;return P.PerspectiveFovRHToRef(e,t,i,r,l,!0,s,n,o),l}static PerspectiveFovRHToRef(e,t,i,r,s,n=!0,o,l=0,c=!1){const h=i,f=r,u=1/Math.tan(e*.5),d=n?u/t:u,_=n?u:u*t,p=c&&h===0?1:f!==0?-(f+h)/(f-h):-1,g=c&&h===0?2*f:f!==0?-2*f*h/(f-h):-2*h,E=Math.tan(l);return P.FromValuesToRef(d,0,0,0,0,_,0,E,0,0,p,-1,0,0,g,0,s),o&&s.multiplyToRef(ls,s),s._updateIdentityStatus(!1),s}static PerspectiveFovReverseRHToRef(e,t,i,r,s,n=!0,o,l=0){const c=1/Math.tan(e*.5),h=n?c/t:c,f=n?c:c*t,u=Math.tan(l);return P.FromValuesToRef(h,0,0,0,0,f,0,u,0,0,-i,-1,0,0,-1,0,s),o&&s.multiplyToRef(ls,s),s._updateIdentityStatus(!1),s}static GetFinalMatrix(e,t,i,r,s,n){const o=e.width,l=e.height,c=e.x,h=e.y,f=P.FromValues(o/2,0,0,0,0,-l/2,0,0,0,0,n-s,0,c+o/2,l/2+h,s,1),u=new P;return t.multiplyToRef(i,u),u.multiplyToRef(r,u),u.multiplyToRef(f,u)}static GetAsMatrix2x2(e){const t=e.m,i=[t[0],t[1],t[4],t[5]];return Xt.MatrixUse64Bits?i:new Float32Array(i)}static GetAsMatrix3x3(e){const t=e.m,i=[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]];return Xt.MatrixUse64Bits?i:new Float32Array(i)}static Transpose(e){const t=new P;return P.TransposeToRef(e,t),t}static TransposeToRef(e,t){const i=e.m,r=i[0],s=i[4],n=i[8],o=i[12],l=i[1],c=i[5],h=i[9],f=i[13],u=i[2],d=i[6],_=i[10],p=i[14],g=i[3],E=i[7],v=i[11],b=i[15],R=t._m;return R[0]=r,R[1]=s,R[2]=n,R[3]=o,R[4]=l,R[5]=c,R[6]=h,R[7]=f,R[8]=u,R[9]=d,R[10]=_,R[11]=p,R[12]=g,R[13]=E,R[14]=v,R[15]=b,t.markAsUpdated(),t._updateIdentityStatus(e._isIdentity,e._isIdentityDirty),t}static Reflection(e){const t=new P;return P.ReflectionToRef(e,t),t}static ReflectionToRef(e,t){e.normalize();const i=e.normal.x,r=e.normal.y,s=e.normal.z,n=-2*i,o=-2*r,l=-2*s;return P.FromValuesToRef(n*i+1,o*i,l*i,0,n*r,o*r+1,l*r,0,n*s,o*s,l*s+1,0,n*e.d,o*e.d,l*e.d,1,t),t}static FromXYZAxesToRef(e,t,i,r){return P.FromValuesToRef(e._x,e._y,e._z,0,t._x,t._y,t._z,0,i._x,i._y,i._z,0,0,0,0,1,r),r}static FromQuaternionToRef(e,t){const i=e._x*e._x,r=e._y*e._y,s=e._z*e._z,n=e._x*e._y,o=e._z*e._w,l=e._z*e._x,c=e._y*e._w,h=e._y*e._z,f=e._x*e._w;return t._m[0]=1-2*(r+s),t._m[1]=2*(n+o),t._m[2]=2*(l-c),t._m[3]=0,t._m[4]=2*(n-o),t._m[5]=1-2*(s+i),t._m[6]=2*(h+f),t._m[7]=0,t._m[8]=2*(l+c),t._m[9]=2*(h-f),t._m[10]=1-2*(r+i),t._m[11]=0,t._m[12]=0,t._m[13]=0,t._m[14]=0,t._m[15]=1,t.markAsUpdated(),t}}P._UpdateFlagSeed=0;P._IdentityReadOnly=P.Identity();Object.defineProperties(P.prototype,{dimension:{value:[4,4]},rank:{value:2}});class de{}de.Vector3=rs(11,m.Zero);de.Matrix=rs(2,P.Identity);de.Quaternion=rs(3,z.Zero);class F{}F.Vector2=rs(3,ne.Zero);F.Vector3=rs(13,m.Zero);F.Vector4=rs(3,Fe.Zero);F.Quaternion=rs(3,z.Zero);F.Matrix=rs(8,P.Identity);Y("BABYLON.Vector2",ne);Y("BABYLON.Vector3",m);Y("BABYLON.Vector4",Fe);Y("BABYLON.Matrix",P);const ls=P.FromValues(1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1);function A(a,e,t,i){var r=arguments.length,s=r<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,n;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(a,e,t,i);else for(var o=a.length-1;o>=0;o--)(n=a[o])&&(s=(r<3?n(s):r>3?n(e,t,s):n(e,t))||s);return r>3&&s&&Object.defineProperty(e,t,s),s}const sa={},da={};function HA(a){const e=a.getClassName();return da[e]||(da[e]={}),da[e]}function nl(a){const e=a.getClassName();if(sa[e])return sa[e];sa[e]={};const t=sa[e];let i=a,r=e;for(;r;){const s=da[r];for(const l in s)t[l]=s[l];let n,o=!1;do{if(n=Object.getPrototypeOf(i),!n.getClassName){o=!0;break}if(n.getClassName()!==r)break;i=n}while(n);if(o)break;r=n.getClassName(),i=n}return t}function qi(a,e){return(t,i)=>{const r=HA(t);r[i]||(r[i]={type:a,sourceName:e})}}function zA(a,e=null){return(t,i)=>{const r=e||"_"+i;Object.defineProperty(t,i,{get:function(){return this[r]},set:function(s){var n;typeof((n=this[r])==null?void 0:n.equals)=="function"&&this[r].equals(s)||this[r]!==s&&(this[r]=s,t[a].apply(this))},enumerable:!0,configurable:!0})}}function j(a,e=null){return zA(a,e)}function y(a){return qi(0,a)}function Je(a){return qi(1,a)}function Qt(a){return qi(2,a)}function Fn(a){return qi(3,a)}function Ec(a){return qi(4,a)}function di(a){return qi(5,a)}function ym(a){return qi(6,a)}function YA(a){return qi(7,a)}function Mm(a){return qi(8,a)}function Pm(a){return qi(9,a)}function KA(a){return qi(10,a)}function Om(a){return qi(12,a)}function Fr(a,e,t,i){const r=t.value;t.value=(...s)=>{let n=r;if(typeof _native<"u"&&_native[e]){const o=_native[e];i?n=(...l)=>i(...l)?o(...l):r(...l):n=o}return a[e]=n,n(...s)}}Fr.filter=function(a){return(e,t,i)=>Fr(e,t,i,a)};function Ws(a){return Math.pow(a,ua)}function Xs(a){return a<=.04045?.0773993808*a:Math.pow(.947867299*(a+.055),2.4)}function Hs(a){return Math.pow(a,yA)}function zs(a){return a<=.0031308?12.92*a:1.055*Math.pow(a,.41666)-.055}class ae{constructor(e=0,t=0,i=0){this.r=e,this.g=t,this.b=i}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"}getClassName(){return"Color3"}getHashCode(){let e=this.r*255|0;return e=e*397^(this.g*255|0),e=e*397^(this.b*255|0),e}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,this}fromArray(e,t=0){return ae.FromArrayToRef(e,t,this),this}toColor4(e=1){return new Ne(this.r,this.g,this.b,e)}asArray(){return[this.r,this.g,this.b]}toLuminance(){return this.r*.3+this.g*.59+this.b*.11}multiply(e){return new ae(this.r*e.r,this.g*e.g,this.b*e.b)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t}multiplyInPlace(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyByFloats(e,t,i){return new ae(this.r*e,this.g*t,this.b*i)}divide(e){throw new ReferenceError("Can not divide a color")}divideToRef(e,t){throw new ReferenceError("Can not divide a color")}divideInPlace(e){throw new ReferenceError("Can not divide a color")}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e.r,e.g,e.b)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e.r,e.g,e.b)}minimizeInPlaceFromFloats(e,t,i){return this.r=Math.min(e,this.r),this.g=Math.min(t,this.g),this.b=Math.min(i,this.b),this}maximizeInPlaceFromFloats(e,t,i){return this.r=Math.max(e,this.r),this.g=Math.max(t,this.g),this.b=Math.max(i,this.b),this}floorToRef(e){throw new ReferenceError("Can not floor a color")}floor(){throw new ReferenceError("Can not floor a color")}fractToRef(e){throw new ReferenceError("Can not fract a color")}fract(){throw new ReferenceError("Can not fract a color")}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b}equalsFloats(e,t,i){return this.equalsToFloats(e,t,i)}equalsToFloats(e,t,i){return this.r===e&&this.g===t&&this.b===i}equalsWithEpsilon(e,t=Ke){return nt(this.r,e.r,t)&&nt(this.g,e.g,t)&&nt(this.b,e.b,t)}negate(){throw new ReferenceError("Can not negate a color")}negateInPlace(){throw new ReferenceError("Can not negate a color")}negateToRef(e){throw new ReferenceError("Can not negate a color")}scale(e){return new ae(this.r*e,this.g*e,this.b*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t}clampToRef(e=0,t=1,i){return i.r=je(this.r,e,t),i.g=je(this.g,e,t),i.b=je(this.b,e,t),i}add(e){return new ae(this.r+e.r,this.g+e.g,this.b+e.b)}addInPlace(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addInPlaceFromFloats(e,t,i){return this.r+=e,this.g+=t,this.b+=i,this}addToRef(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,t}subtract(e){return new ae(this.r-e.r,this.g-e.g,this.b-e.b)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t}subtractInPlace(e){return this.r-=e.r,this.g-=e.g,this.b-=e.b,this}subtractFromFloats(e,t,i){return new ae(this.r-e,this.g-t,this.b-i)}subtractFromFloatsToRef(e,t,i,r){return r.r=this.r-e,r.g=this.g-t,r.b=this.b-i,r}clone(){return new ae(this.r,this.g,this.b)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copyFromFloats(e,t,i){return this.r=e,this.g=t,this.b=i,this}set(e,t,i){return this.copyFromFloats(e,t,i)}setAll(e){return this.r=this.g=this.b=e,this}toHexString(){const e=Math.round(this.r*255),t=Math.round(this.g*255),i=Math.round(this.b*255);return"#"+tr(e)+tr(t)+tr(i)}fromHexString(e){return e.substring(0,1)!=="#"||e.length!==7?this:(this.r=parseInt(e.substring(1,3),16)/255,this.g=parseInt(e.substring(3,5),16)/255,this.b=parseInt(e.substring(5,7),16)/255,this)}toHSV(){return this.toHSVToRef(new ae)}toHSVToRef(e){const t=this.r,i=this.g,r=this.b,s=Math.max(t,i,r),n=Math.min(t,i,r);let o=0,l=0;const c=s,h=s-n;return s!==0&&(l=h/s),s!=n&&(s==t?(o=(i-r)/h,i<r&&(o+=6)):s==i?o=(r-t)/h+2:s==r&&(o=(t-i)/h+4),o*=60),e.r=o,e.g=l,e.b=c,e}toLinearSpace(e=!1){const t=new ae;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=Xs(this.r),e.g=Xs(this.g),e.b=Xs(this.b)):(e.r=Ws(this.r),e.g=Ws(this.g),e.b=Ws(this.b)),this}toGammaSpace(e=!1){const t=new ae;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=zs(this.r),e.g=zs(this.g),e.b=zs(this.b)):(e.r=Hs(this.r),e.g=Hs(this.g),e.b=Hs(this.b)),this}static HSVtoRGBToRef(e,t,i,r){const s=i*t,n=e/60,o=s*(1-Math.abs(n%2-1));let l=0,c=0,h=0;n>=0&&n<=1?(l=s,c=o):n>=1&&n<=2?(l=o,c=s):n>=2&&n<=3?(c=s,h=o):n>=3&&n<=4?(c=o,h=s):n>=4&&n<=5?(l=o,h=s):n>=5&&n<=6&&(l=s,h=o);const f=i-s;return r.r=l+f,r.g=c+f,r.b=h+f,r}static FromHSV(e,t,i){const r=new ae(0,0,0);return ae.HSVtoRGBToRef(e,t,i,r),r}static FromHexString(e){return new ae(0,0,0).fromHexString(e)}static FromArray(e,t=0){return new ae(e[t],e[t+1],e[t+2])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2]}static FromInts(e,t,i){return new ae(e/255,t/255,i/255)}static Lerp(e,t,i){const r=new ae(0,0,0);return ae.LerpToRef(e,t,i,r),r}static LerpToRef(e,t,i,r){r.r=e.r+(t.r-e.r)*i,r.g=e.g+(t.g-e.g)*i,r.b=e.b+(t.b-e.b)*i}static Hermite(e,t,i,r,s){const n=s*s,o=s*n,l=2*o-3*n+1,c=-2*o+3*n,h=o-2*n+s,f=o-n,u=e.r*l+i.r*c+t.r*h+r.r*f,d=e.g*l+i.g*c+t.g*h+r.g*f,_=e.b*l+i.b*c+t.b*h+r.b*f;return new ae(u,d,_)}static Hermite1stDerivative(e,t,i,r,s){const n=ae.Black();return this.Hermite1stDerivativeToRef(e,t,i,r,s,n),n}static Hermite1stDerivativeToRef(e,t,i,r,s,n){const o=s*s;n.r=(o-s)*6*e.r+(3*o-4*s+1)*t.r+(-o+s)*6*i.r+(3*o-2*s)*r.r,n.g=(o-s)*6*e.g+(3*o-4*s+1)*t.g+(-o+s)*6*i.g+(3*o-2*s)*r.g,n.b=(o-s)*6*e.b+(3*o-4*s+1)*t.b+(-o+s)*6*i.b+(3*o-2*s)*r.b}static Red(){return new ae(1,0,0)}static Green(){return new ae(0,1,0)}static Blue(){return new ae(0,0,1)}static Black(){return new ae(0,0,0)}static get BlackReadOnly(){return ae._BlackReadOnly}static White(){return new ae(1,1,1)}static Purple(){return new ae(.5,0,.5)}static Magenta(){return new ae(1,0,1)}static Yellow(){return new ae(1,1,0)}static Gray(){return new ae(.5,.5,.5)}static Teal(){return new ae(0,1,1)}static Random(){return new ae(Math.random(),Math.random(),Math.random())}}ae._V8PerformanceHack=new ae(.5,.5,.5);ae._BlackReadOnly=ae.Black();Object.defineProperties(ae.prototype,{dimension:{value:[3]},rank:{value:1}});class Ne{constructor(e=0,t=0,i=0,r=1){this.r=e,this.g=t,this.b=i,this.a=r}asArray(){return[this.r,this.g,this.b,this.a]}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e[t+3]=this.a,this}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this.a=e[t+3],this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}add(e){return new Ne(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)}addToRef(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,t.a=this.a+e.a,t}addInPlace(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this}addInPlaceFromFloats(e,t,i,r){return this.r+=e,this.g+=t,this.b+=i,this.a+=r,this}subtract(e){return new Ne(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t.a=this.a-e.a,t}subtractInPlace(e){return this.r-=e.r,this.g-=e.g,this.b-=e.b,this.a-=e.a,this}subtractFromFloats(e,t,i,r){return new Ne(this.r-e,this.g-t,this.b-i,this.a-r)}subtractFromFloatsToRef(e,t,i,r,s){return s.r=this.r-e,s.g=this.g-t,s.b=this.b-i,s.a=this.a-r,s}scale(e){return new Ne(this.r*e,this.g*e,this.b*e,this.a*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this.a*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t.a=this.a*e,t}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t.a+=this.a*e,t}clampToRef(e=0,t=1,i){return i.r=je(this.r,e,t),i.g=je(this.g,e,t),i.b=je(this.b,e,t),i.a=je(this.a,e,t),i}multiply(e){return new Ne(this.r*e.r,this.g*e.g,this.b*e.b,this.a*e.a)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t.a=this.a*e.a,t}multiplyInPlace(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this.a*=e.a,this}multiplyByFloats(e,t,i,r){return new Ne(this.r*e,this.g*t,this.b*i,this.a*r)}divide(e){throw new ReferenceError("Can not divide a color")}divideToRef(e,t){throw new ReferenceError("Can not divide a color")}divideInPlace(e){throw new ReferenceError("Can not divide a color")}minimizeInPlace(e){return this.r=Math.min(this.r,e.r),this.g=Math.min(this.g,e.g),this.b=Math.min(this.b,e.b),this.a=Math.min(this.a,e.a),this}maximizeInPlace(e){return this.r=Math.max(this.r,e.r),this.g=Math.max(this.g,e.g),this.b=Math.max(this.b,e.b),this.a=Math.max(this.a,e.a),this}minimizeInPlaceFromFloats(e,t,i,r){return this.r=Math.min(e,this.r),this.g=Math.min(t,this.g),this.b=Math.min(i,this.b),this.a=Math.min(r,this.a),this}maximizeInPlaceFromFloats(e,t,i,r){return this.r=Math.max(e,this.r),this.g=Math.max(t,this.g),this.b=Math.max(i,this.b),this.a=Math.max(r,this.a),this}floorToRef(e){throw new ReferenceError("Can not floor a color")}floor(){throw new ReferenceError("Can not floor a color")}fractToRef(e){throw new ReferenceError("Can not fract a color")}fract(){throw new ReferenceError("Can not fract a color")}negate(){throw new ReferenceError("Can not negate a color")}negateInPlace(){throw new ReferenceError("Can not negate a color")}negateToRef(e){throw new ReferenceError("Can not negate a color")}equalsWithEpsilon(e,t=Ke){return nt(this.r,e.r,t)&&nt(this.g,e.g,t)&&nt(this.b,e.b,t)&&nt(this.a,e.a,t)}equalsToFloats(e,t,i,r){return this.r===e&&this.g===t&&this.b===i&&this.a===r}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"}getClassName(){return"Color4"}getHashCode(){let e=this.r*255|0;return e=e*397^(this.g*255|0),e=e*397^(this.b*255|0),e=e*397^(this.a*255|0),e}clone(){return new Ne().copyFrom(this)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}copyFromFloats(e,t,i,r){return this.r=e,this.g=t,this.b=i,this.a=r,this}set(e,t,i,r){return this.copyFromFloats(e,t,i,r)}setAll(e){return this.r=this.g=this.b=this.a=e,this}toHexString(e=!1){const t=Math.round(this.r*255),i=Math.round(this.g*255),r=Math.round(this.b*255);if(e)return"#"+tr(t)+tr(i)+tr(r);const s=Math.round(this.a*255);return"#"+tr(t)+tr(i)+tr(r)+tr(s)}fromHexString(e){return e.substring(0,1)!=="#"||e.length!==9&&e.length!==7?this:(this.r=parseInt(e.substring(1,3),16)/255,this.g=parseInt(e.substring(3,5),16)/255,this.b=parseInt(e.substring(5,7),16)/255,e.length===9&&(this.a=parseInt(e.substring(7,9),16)/255),this)}toLinearSpace(e=!1){const t=new Ne;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=Xs(this.r),e.g=Xs(this.g),e.b=Xs(this.b)):(e.r=Ws(this.r),e.g=Ws(this.g),e.b=Ws(this.b)),e.a=this.a,this}toGammaSpace(e=!1){const t=new Ne;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=zs(this.r),e.g=zs(this.g),e.b=zs(this.b)):(e.r=Hs(this.r),e.g=Hs(this.g),e.b=Hs(this.b)),e.a=this.a,this}static FromHexString(e){return e.substring(0,1)!=="#"||e.length!==9&&e.length!==7?new Ne(0,0,0,0):new Ne(0,0,0,1).fromHexString(e)}static Lerp(e,t,i){return Ne.LerpToRef(e,t,i,new Ne)}static LerpToRef(e,t,i,r){return r.r=e.r+(t.r-e.r)*i,r.g=e.g+(t.g-e.g)*i,r.b=e.b+(t.b-e.b)*i,r.a=e.a+(t.a-e.a)*i,r}static Hermite(e,t,i,r,s){const n=s*s,o=s*n,l=2*o-3*n+1,c=-2*o+3*n,h=o-2*n+s,f=o-n,u=e.r*l+i.r*c+t.r*h+r.r*f,d=e.g*l+i.g*c+t.g*h+r.g*f,_=e.b*l+i.b*c+t.b*h+r.b*f,p=e.a*l+i.a*c+t.a*h+r.a*f;return new Ne(u,d,_,p)}static Hermite1stDerivative(e,t,i,r,s){const n=new Ne;return this.Hermite1stDerivativeToRef(e,t,i,r,s,n),n}static Hermite1stDerivativeToRef(e,t,i,r,s,n){const o=s*s;n.r=(o-s)*6*e.r+(3*o-4*s+1)*t.r+(-o+s)*6*i.r+(3*o-2*s)*r.r,n.g=(o-s)*6*e.g+(3*o-4*s+1)*t.g+(-o+s)*6*i.g+(3*o-2*s)*r.g,n.b=(o-s)*6*e.b+(3*o-4*s+1)*t.b+(-o+s)*6*i.b+(3*o-2*s)*r.b,n.a=(o-s)*6*e.a+(3*o-4*s+1)*t.a+(-o+s)*6*i.a+(3*o-2*s)*r.a}static FromColor3(e,t=1){return new Ne(e.r,e.g,e.b,t)}static FromArray(e,t=0){return new Ne(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2],i.a=e[t+3]}static FromInts(e,t,i,r){return new Ne(e/255,t/255,i/255,r/255)}static CheckColors4(e,t){if(e.length===t*3){const i=[];for(let r=0;r<e.length;r+=3){const s=r/3*4;i[s]=e[r],i[s+1]=e[r+1],i[s+2]=e[r+2],i[s+3]=1}return i}return e}}Ne._V8PerformanceHack=new Ne(.5,.5,.5,.5);Object.defineProperties(Ne.prototype,{dimension:{value:[4]},rank:{value:1}});class tt{}tt.Color3=Bi(3,ae.Black);tt.Color4=Bi(3,()=>new Ne(0,0,0,0));Y("BABYLON.Color3",ae);Y("BABYLON.Color4",Ne);const Mh=function(a,e,t,i={}){const r=a();qe&&qe.HasTags(e)&&qe.AddTagsTo(r,qe.GetTags(e,!0));const s=nl(r),n={};for(const o in s){const l=s[o],c=e[o],h=l.type;if(c!=null&&(o!=="uniqueId"||ye.AllowLoadingUniqueId))switch(h){case 0:case 6:case 9:case 11:r[o]=c;break;case 1:i.cloneTexturesOnlyOnce&&n[c.uniqueId]?r[o]=n[c.uniqueId]:(r[o]=t||c.isRenderTarget?c:c.clone(),n[c.uniqueId]=r[o]);break;case 2:case 3:case 4:case 5:case 7:case 8:case 10:case 12:r[o]=t?c:c.clone();break}}return r};class ye{static AppendSerializedAnimations(e,t){if(e.animations){t.animations=[];for(let i=0;i<e.animations.length;i++){const r=e.animations[i];t.animations.push(r.serialize())}}}static Serialize(e,t){t||(t={}),qe&&(t.tags=qe.GetTags(e));const i=nl(e);for(const r in i){const s=i[r],n=s.sourceName||r,o=s.type,l=e[r];if(l!=null&&(r!=="uniqueId"||ye.AllowLoadingUniqueId))switch(o){case 0:t[n]=l;break;case 1:t[n]=l.serialize();break;case 2:t[n]=l.asArray();break;case 3:t[n]=l.serialize();break;case 4:t[n]=l.asArray();break;case 5:t[n]=l.asArray();break;case 6:t[n]=l.id;break;case 7:t[n]=l.serialize();break;case 8:t[n]=l.asArray();break;case 9:t[n]=l.serialize();break;case 10:t[n]=l.asArray();break;case 11:t[n]=l.id;break;case 12:t[n]=l.asArray();break}}return t}static ParseProperties(e,t,i,r){r||(r="");const s=nl(t);for(const n in s){const o=s[n],l=e[o.sourceName||n],c=o.type;if(l!=null&&(n!=="uniqueId"||ye.AllowLoadingUniqueId)){const h=t;switch(c){case 0:h[n]=l;break;case 1:i&&(h[n]=ye._TextureParser(l,i,r));break;case 2:h[n]=ae.FromArray(l);break;case 3:h[n]=ye._FresnelParametersParser(l);break;case 4:h[n]=ne.FromArray(l);break;case 5:h[n]=m.FromArray(l);break;case 6:i&&(h[n]=i.getLastMeshById(l));break;case 7:h[n]=ye._ColorCurvesParser(l);break;case 8:h[n]=Ne.FromArray(l);break;case 9:h[n]=ye._ImageProcessingConfigurationParser(l);break;case 10:h[n]=z.FromArray(l);break;case 11:i&&(h[n]=i.getCameraById(l));break;case 12:h[n]=P.FromArray(l);break}}}}static Parse(e,t,i,r=null){const s=e();return qe&&qe.AddTagsTo(s,t.tags),ye.ParseProperties(t,s,i,r),s}static Clone(e,t,i={}){return Mh(e,t,!1,i)}static Instanciate(e,t){return Mh(e,t,!0)}}ye.AllowLoadingUniqueId=!1;ye._ImageProcessingConfigurationParser=a=>{throw Le("ImageProcessingConfiguration")};ye._FresnelParametersParser=a=>{throw Le("FresnelParameters")};ye._ColorCurvesParser=a=>{throw Le("ColorCurves")};ye._TextureParser=(a,e,t)=>{throw Le("Texture")};function Dm(a){a.push("vCameraColorCurveNeutral","vCameraColorCurvePositive","vCameraColorCurveNegative")}class It{constructor(){this._dirty=!0,this._tempColor=new Ne(0,0,0,0),this._globalCurve=new Ne(0,0,0,0),this._highlightsCurve=new Ne(0,0,0,0),this._midtonesCurve=new Ne(0,0,0,0),this._shadowsCurve=new Ne(0,0,0,0),this._positiveCurve=new Ne(0,0,0,0),this._negativeCurve=new Ne(0,0,0,0),this._globalHue=30,this._globalDensity=0,this._globalSaturation=0,this._globalExposure=0,this._highlightsHue=30,this._highlightsDensity=0,this._highlightsSaturation=0,this._highlightsExposure=0,this._midtonesHue=30,this._midtonesDensity=0,this._midtonesSaturation=0,this._midtonesExposure=0,this._shadowsHue=30,this._shadowsDensity=0,this._shadowsSaturation=0,this._shadowsExposure=0}get globalHue(){return this._globalHue}set globalHue(e){this._globalHue=e,this._dirty=!0}get globalDensity(){return this._globalDensity}set globalDensity(e){this._globalDensity=e,this._dirty=!0}get globalSaturation(){return this._globalSaturation}set globalSaturation(e){this._globalSaturation=e,this._dirty=!0}get globalExposure(){return this._globalExposure}set globalExposure(e){this._globalExposure=e,this._dirty=!0}get highlightsHue(){return this._highlightsHue}set highlightsHue(e){this._highlightsHue=e,this._dirty=!0}get highlightsDensity(){return this._highlightsDensity}set highlightsDensity(e){this._highlightsDensity=e,this._dirty=!0}get highlightsSaturation(){return this._highlightsSaturation}set highlightsSaturation(e){this._highlightsSaturation=e,this._dirty=!0}get highlightsExposure(){return this._highlightsExposure}set highlightsExposure(e){this._highlightsExposure=e,this._dirty=!0}get midtonesHue(){return this._midtonesHue}set midtonesHue(e){this._midtonesHue=e,this._dirty=!0}get midtonesDensity(){return this._midtonesDensity}set midtonesDensity(e){this._midtonesDensity=e,this._dirty=!0}get midtonesSaturation(){return this._midtonesSaturation}set midtonesSaturation(e){this._midtonesSaturation=e,this._dirty=!0}get midtonesExposure(){return this._midtonesExposure}set midtonesExposure(e){this._midtonesExposure=e,this._dirty=!0}get shadowsHue(){return this._shadowsHue}set shadowsHue(e){this._shadowsHue=e,this._dirty=!0}get shadowsDensity(){return this._shadowsDensity}set shadowsDensity(e){this._shadowsDensity=e,this._dirty=!0}get shadowsSaturation(){return this._shadowsSaturation}set shadowsSaturation(e){this._shadowsSaturation=e,this._dirty=!0}get shadowsExposure(){return this._shadowsExposure}set shadowsExposure(e){this._shadowsExposure=e,this._dirty=!0}getClassName(){return"ColorCurves"}static Bind(e,t,i="vCameraColorCurvePositive",r="vCameraColorCurveNeutral",s="vCameraColorCurveNegative"){e._dirty&&(e._dirty=!1,e._getColorGradingDataToRef(e._globalHue,e._globalDensity,e._globalSaturation,e._globalExposure,e._globalCurve),e._getColorGradingDataToRef(e._highlightsHue,e._highlightsDensity,e._highlightsSaturation,e._highlightsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._highlightsCurve),e._getColorGradingDataToRef(e._midtonesHue,e._midtonesDensity,e._midtonesSaturation,e._midtonesExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._midtonesCurve),e._getColorGradingDataToRef(e._shadowsHue,e._shadowsDensity,e._shadowsSaturation,e._shadowsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._shadowsCurve),e._highlightsCurve.subtractToRef(e._midtonesCurve,e._positiveCurve),e._midtonesCurve.subtractToRef(e._shadowsCurve,e._negativeCurve)),t&&(t.setFloat4(i,e._positiveCurve.r,e._positiveCurve.g,e._positiveCurve.b,e._positiveCurve.a),t.setFloat4(r,e._midtonesCurve.r,e._midtonesCurve.g,e._midtonesCurve.b,e._midtonesCurve.a),t.setFloat4(s,e._negativeCurve.r,e._negativeCurve.g,e._negativeCurve.b,e._negativeCurve.a))}_getColorGradingDataToRef(e,t,i,r,s){e!=null&&(e=It._Clamp(e,0,360),t=It._Clamp(t,-100,100),i=It._Clamp(i,-100,100),r=It._Clamp(r,-100,100),t=It._ApplyColorGradingSliderNonlinear(t),t*=.5,r=It._ApplyColorGradingSliderNonlinear(r),t<0&&(t*=-1,e=(e+180)%360),It._FromHSBToRef(e,t,50+.25*r,s),s.scaleToRef(2,s),s.a=1+.01*i)}static _ApplyColorGradingSliderNonlinear(e){e/=100;let t=Math.abs(e);return t=Math.pow(t,2),e<0&&(t*=-1),t*=100,t}static _FromHSBToRef(e,t,i,r){let s=It._Clamp(e,0,360);const n=It._Clamp(t/100,0,1),o=It._Clamp(i/100,0,1);if(n===0)r.r=o,r.g=o,r.b=o;else{s/=60;const l=Math.floor(s),c=s-l,h=o*(1-n),f=o*(1-n*c),u=o*(1-n*(1-c));switch(l){case 0:r.r=o,r.g=u,r.b=h;break;case 1:r.r=f,r.g=o,r.b=h;break;case 2:r.r=h,r.g=o,r.b=u;break;case 3:r.r=h,r.g=f,r.b=o;break;case 4:r.r=u,r.g=h,r.b=o;break;default:r.r=o,r.g=h,r.b=f;break}}r.a=1}static _Clamp(e,t,i){return Math.min(Math.max(e,t),i)}clone(){return ye.Clone(()=>new It,this)}serialize(){return ye.Serialize(this)}static Parse(e){return ye.Parse(()=>new It,e,null,null)}}It.PrepareUniforms=Dm;A([y()],It.prototype,"_globalHue",void 0);A([y()],It.prototype,"_globalDensity",void 0);A([y()],It.prototype,"_globalSaturation",void 0);A([y()],It.prototype,"_globalExposure",void 0);A([y()],It.prototype,"_highlightsHue",void 0);A([y()],It.prototype,"_highlightsDensity",void 0);A([y()],It.prototype,"_highlightsSaturation",void 0);A([y()],It.prototype,"_highlightsExposure",void 0);A([y()],It.prototype,"_midtonesHue",void 0);A([y()],It.prototype,"_midtonesDensity",void 0);A([y()],It.prototype,"_midtonesSaturation",void 0);A([y()],It.prototype,"_midtonesExposure",void 0);ye._ColorCurvesParser=It.Parse;function qA(a,e){e.EXPOSURE&&a.push("exposureLinear"),e.CONTRAST&&a.push("contrast"),e.COLORGRADING&&a.push("colorTransformSettings"),(e.VIGNETTE||e.DITHER)&&a.push("vInverseScreenSize"),e.VIGNETTE&&(a.push("vignetteSettings1"),a.push("vignetteSettings2")),e.COLORCURVES&&Dm(a),e.DITHER&&a.push("ditherIntensity")}function jA(a,e){e.COLORGRADING&&a.push("txColorTransform")}class ze{constructor(){this.colorCurves=new It,this._colorCurvesEnabled=!1,this._colorGradingEnabled=!1,this._colorGradingWithGreenDepth=!0,this._colorGradingBGR=!0,this._exposure=1,this._toneMappingEnabled=!1,this._toneMappingType=ze.TONEMAPPING_STANDARD,this._contrast=1,this.vignetteStretch=0,this.vignetteCenterX=0,this.vignetteCenterY=0,this.vignetteWeight=1.5,this.vignetteColor=new Ne(0,0,0,0),this.vignetteCameraFov=.5,this._vignetteBlendMode=ze.VIGNETTEMODE_MULTIPLY,this._vignetteEnabled=!1,this._ditheringEnabled=!1,this._ditheringIntensity=1/255,this._skipFinalColorClamp=!1,this._applyByPostProcess=!1,this._isEnabled=!0,this.onUpdateParameters=new U}get colorCurvesEnabled(){return this._colorCurvesEnabled}set colorCurvesEnabled(e){this._colorCurvesEnabled!==e&&(this._colorCurvesEnabled=e,this._updateParameters())}get colorGradingTexture(){return this._colorGradingTexture}set colorGradingTexture(e){this._colorGradingTexture!==e&&(this._colorGradingTexture=e,this._updateParameters())}get colorGradingEnabled(){return this._colorGradingEnabled}set colorGradingEnabled(e){this._colorGradingEnabled!==e&&(this._colorGradingEnabled=e,this._updateParameters())}get colorGradingWithGreenDepth(){return this._colorGradingWithGreenDepth}set colorGradingWithGreenDepth(e){this._colorGradingWithGreenDepth!==e&&(this._colorGradingWithGreenDepth=e,this._updateParameters())}get colorGradingBGR(){return this._colorGradingBGR}set colorGradingBGR(e){this._colorGradingBGR!==e&&(this._colorGradingBGR=e,this._updateParameters())}get exposure(){return this._exposure}set exposure(e){this._exposure!==e&&(this._exposure=e,this._updateParameters())}get toneMappingEnabled(){return this._toneMappingEnabled}set toneMappingEnabled(e){this._toneMappingEnabled!==e&&(this._toneMappingEnabled=e,this._updateParameters())}get toneMappingType(){return this._toneMappingType}set toneMappingType(e){this._toneMappingType!==e&&(this._toneMappingType=e,this._updateParameters())}get contrast(){return this._contrast}set contrast(e){this._contrast!==e&&(this._contrast=e,this._updateParameters())}get vignetteCentreY(){return this.vignetteCenterY}set vignetteCentreY(e){this.vignetteCenterY=e}get vignetteCentreX(){return this.vignetteCenterX}set vignetteCentreX(e){this.vignetteCenterX=e}get vignetteBlendMode(){return this._vignetteBlendMode}set vignetteBlendMode(e){this._vignetteBlendMode!==e&&(this._vignetteBlendMode=e,this._updateParameters())}get vignetteEnabled(){return this._vignetteEnabled}set vignetteEnabled(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._updateParameters())}get ditheringEnabled(){return this._ditheringEnabled}set ditheringEnabled(e){this._ditheringEnabled!==e&&(this._ditheringEnabled=e,this._updateParameters())}get ditheringIntensity(){return this._ditheringIntensity}set ditheringIntensity(e){this._ditheringIntensity!==e&&(this._ditheringIntensity=e,this._updateParameters())}get skipFinalColorClamp(){return this._skipFinalColorClamp}set skipFinalColorClamp(e){this._skipFinalColorClamp!==e&&(this._skipFinalColorClamp=e,this._updateParameters())}get applyByPostProcess(){return this._applyByPostProcess}set applyByPostProcess(e){this._applyByPostProcess!==e&&(this._applyByPostProcess=e,this._updateParameters())}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this._updateParameters())}_updateParameters(){this.onUpdateParameters.notifyObservers(this)}getClassName(){return"ImageProcessingConfiguration"}prepareDefines(e,t=!1){if(t!==this.applyByPostProcess||!this._isEnabled){e.VIGNETTE=!1,e.TONEMAPPING=0,e.CONTRAST=!1,e.EXPOSURE=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.DITHER=!1,e.IMAGEPROCESSING=!1,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this._isEnabled;return}if(e.VIGNETTE=this.vignetteEnabled,e.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===ze._VIGNETTEMODE_MULTIPLY,e.VIGNETTEBLENDMODEOPAQUE=!e.VIGNETTEBLENDMODEMULTIPLY,!this._toneMappingEnabled)e.TONEMAPPING=0;else switch(this._toneMappingType){case ze.TONEMAPPING_KHR_PBR_NEUTRAL:e.TONEMAPPING=3;break;case ze.TONEMAPPING_ACES:e.TONEMAPPING=2;break;default:e.TONEMAPPING=1;break}e.CONTRAST=this.contrast!==1,e.EXPOSURE=this.exposure!==1,e.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves,e.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture,e.COLORGRADING?e.COLORGRADING3D=this.colorGradingTexture.is3D:e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth,e.SAMPLER3DBGRMAP=this.colorGradingBGR,e.DITHER=this._ditheringEnabled,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSING=e.VIGNETTE||!!e.TONEMAPPING||e.CONTRAST||e.EXPOSURE||e.COLORCURVES||e.COLORGRADING||e.DITHER}isReady(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()}bind(e,t){if(this._colorCurvesEnabled&&this.colorCurves&&It.Bind(this.colorCurves,e),this._vignetteEnabled||this._ditheringEnabled){const i=1/e.getEngine().getRenderWidth(),r=1/e.getEngine().getRenderHeight();if(e.setFloat2("vInverseScreenSize",i,r),this._ditheringEnabled&&e.setFloat("ditherIntensity",.5*this._ditheringIntensity),this._vignetteEnabled){const s=t??r/i;let n=Math.tan(this.vignetteCameraFov*.5),o=n*s;const l=Math.sqrt(o*n);o=sl(o,l,this.vignetteStretch),n=sl(n,l,this.vignetteStretch),e.setFloat4("vignetteSettings1",o,n,-o*this.vignetteCenterX,-n*this.vignetteCenterY);const c=-2*this.vignetteWeight;e.setFloat4("vignetteSettings2",this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,c)}}if(e.setFloat("exposureLinear",this.exposure),e.setFloat("contrast",this.contrast),this.colorGradingTexture){e.setTexture("txColorTransform",this.colorGradingTexture);const i=this.colorGradingTexture.getSize().height;e.setFloat4("colorTransformSettings",(i-1)/i,.5/i,i,this.colorGradingTexture.level)}}clone(){return ye.Clone(()=>new ze,this)}serialize(){return ye.Serialize(this)}static Parse(e){const t=ye.Parse(()=>new ze,e,null,null);return e.vignetteCentreX!==void 0&&(t.vignetteCenterX=e.vignetteCentreX),e.vignetteCentreY!==void 0&&(t.vignetteCenterY=e.vignetteCentreY),t}static get VIGNETTEMODE_MULTIPLY(){return this._VIGNETTEMODE_MULTIPLY}static get VIGNETTEMODE_OPAQUE(){return this._VIGNETTEMODE_OPAQUE}}ze.TONEMAPPING_STANDARD=0;ze.TONEMAPPING_ACES=1;ze.TONEMAPPING_KHR_PBR_NEUTRAL=2;ze.PrepareUniforms=qA;ze.PrepareSamplers=jA;ze._VIGNETTEMODE_MULTIPLY=0;ze._VIGNETTEMODE_OPAQUE=1;A([YA()],ze.prototype,"colorCurves",void 0);A([y()],ze.prototype,"_colorCurvesEnabled",void 0);A([Je("colorGradingTexture")],ze.prototype,"_colorGradingTexture",void 0);A([y()],ze.prototype,"_colorGradingEnabled",void 0);A([y()],ze.prototype,"_colorGradingWithGreenDepth",void 0);A([y()],ze.prototype,"_colorGradingBGR",void 0);A([y()],ze.prototype,"_exposure",void 0);A([y()],ze.prototype,"_toneMappingEnabled",void 0);A([y()],ze.prototype,"_toneMappingType",void 0);A([y()],ze.prototype,"_contrast",void 0);A([y()],ze.prototype,"vignetteStretch",void 0);A([y()],ze.prototype,"vignetteCenterX",void 0);A([y()],ze.prototype,"vignetteCenterY",void 0);A([y()],ze.prototype,"vignetteWeight",void 0);A([Mm()],ze.prototype,"vignetteColor",void 0);A([y()],ze.prototype,"vignetteCameraFov",void 0);A([y()],ze.prototype,"_vignetteBlendMode",void 0);A([y()],ze.prototype,"_vignetteEnabled",void 0);A([y()],ze.prototype,"_ditheringEnabled",void 0);A([y()],ze.prototype,"_ditheringIntensity",void 0);A([y()],ze.prototype,"_skipFinalColorClamp",void 0);A([y()],ze.prototype,"_applyByPostProcess",void 0);A([y()],ze.prototype,"_isEnabled",void 0);ye._ImageProcessingConfigurationParser=ze.Parse;Y("BABYLON.ImageProcessingConfiguration",ze);class _e{constructor(e,t,i,r,s=!1){this._valueCache={},this._engine=e,this._noUBO=!e.supportsUniformBuffers||s,this._dynamic=i,this._name=r??"no-name",this._data=t||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=!1,this._engine._features.trackUbosInFrame&&(this._buffers=[],this._bufferIndex=-1,this._createBufferOnWrite=!1,this._currentFrameId=0),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateUIntArray=this._updateUIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect,this.updateUInt=this._updateUIntForEffect,this.updateUInt2=this._updateUInt2ForEffect,this.updateUInt3=this._updateUInt3ForEffect,this.updateUInt4=this._updateUInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateUIntArray=this._updateUIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform,this.updateUInt=this._updateUIntForUniform,this.updateUInt2=this._updateUInt2ForUniform,this.updateUInt3=this._updateUInt3ForUniform,this.updateUInt4=this._updateUInt4ForUniform)}get useUbo(){return!this._noUBO}get isSync(){return!this._needSync}isDynamic(){return this._dynamic!==void 0}getData(){return this._bufferData}getBuffer(){return this._buffer}_fillAlignment(e){let t;if(e<=2?t=e:t=4,this._uniformLocationPointer%t!==0){const i=this._uniformLocationPointer;this._uniformLocationPointer+=t-this._uniformLocationPointer%t;const r=this._uniformLocationPointer-i;for(let s=0;s<r;s++)this._data.push(0)}}addUniform(e,t,i=0){if(this._noUBO||this._uniformLocations[e]!==void 0)return;let r;if(i>0){if(t instanceof Array)throw"addUniform should not be use with Array in UBO: "+e;if(this._fillAlignment(4),this._uniformArraySizes[e]={strideSize:t,arraySize:i},t==16)t=t*i;else{const n=(4-t)*i;t=t*i+n}r=[];for(let s=0;s<t;s++)r.push(0)}else{if(t instanceof Array)r=t,t=r.length;else{t=t,r=[];for(let s=0;s<t;s++)r.push(0)}this._fillAlignment(t)}this._uniformSizes[e]=t,this._uniformLocations[e]=this._uniformLocationPointer,this._uniformLocationPointer+=t;for(let s=0;s<t;s++)this._data.push(r[s]);this._needSync=!0}addMatrix(e,t){this.addUniform(e,Array.prototype.slice.call(t.asArray()))}addFloat2(e,t,i){const r=[t,i];this.addUniform(e,r)}addFloat3(e,t,i,r){const s=[t,i,r];this.addUniform(e,s)}addColor3(e,t){const i=[t.r,t.g,t.b];this.addUniform(e,i)}addColor4(e,t,i){const r=[t.r,t.g,t.b,i];this.addUniform(e,r)}addVector3(e,t){const i=[t.x,t.y,t.z];this.addUniform(e,i)}addMatrix3x3(e){this.addUniform(e,12)}addMatrix2x2(e){this.addUniform(e,8)}create(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)}_getNames(){const e=[];let t=0;for(const i in this._uniformLocations)if(e.push(i),++t===10)break;return e.join(",")}_rebuild(){this._noUBO||!this._bufferData||(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNames()):this._buffer=this._engine.createUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNames()),this._engine._features.trackUbosInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=!1))}_rebuildAfterContextLost(){this._engine._features.trackUbosInFrame&&(this._buffers=[],this._currentFrameId=0),this._rebuild()}get _numBuffers(){return this._buffers.length}get _indexBuffer(){return this._bufferIndex}get name(){return this._name}get currentEffect(){return this._currentEffect}_buffersEqual(e,t){for(let i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0}_copyBuffer(e,t){for(let i=0;i<e.length;++i)t[i]=e[i]}update(){if(!this._noUBO){if(this.bindUniformBuffer(),!this._buffer){this.create();return}if(!this._dynamic&&!this._needSync){this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}if(this._buffers&&this._buffers.length>1&&this._buffers[this._bufferIndex][1])if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1])){this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}else this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1]);this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&(_e._UpdatedUbosInFrame[this._name]||(_e._UpdatedUbosInFrame[this._name]=0),_e._UpdatedUbosInFrame[this._name]++),this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame}}_createNewBuffer(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=!1,this._needSync=!0):this._rebuild()}_checkNewFrame(){this._engine._features.trackUbosInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=!1,this._buffers&&this._buffers.length>0?(this._needSync=this._bufferIndex!==0,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1)}updateUniform(e,t,i){this._checkNewFrame();let r=this._uniformLocations[e];if(r===void 0){if(this._buffer){B.Error("Cannot add an uniform after UBO has been created. uniformName="+e);return}this.addUniform(e,i),r=this._uniformLocations[e]}if(this._buffer||this.create(),this._dynamic)for(let s=0;s<i;s++)this._bufferData[r+s]=t[s];else{let s=!1;for(let n=0;n<i;n++)(i===16&&!this._engine._features.uniformBufferHardCheckMatrix||this._bufferData[r+n]!==Math.fround(t[n]))&&(s=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[r+n]=t[n]);this._needSync=this._needSync||s}}updateUniformArray(e,t,i){this._checkNewFrame();const r=this._uniformLocations[e];if(r===void 0){B.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform and make sure that uniform buffers are supported by the current engine.");return}this._buffer||this.create();const s=this._uniformArraySizes[e];if(this._dynamic)for(let n=0;n<i;n++)this._bufferData[r+n]=t[n];else{let n=!1,o=0,l=0;for(let c=0;c<i;c++)if(this._bufferData[r+l*4+o]!==k.FloatRound(t[c])&&(n=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[r+l*4+o]=t[c]),o++,o===s.strideSize){for(;o<4;o++)this._bufferData[r+l*4+o]=0;o=0,l++}this._needSync=this._needSync||n}}_cacheMatrix(e,t){this._checkNewFrame();const i=this._valueCache[e],r=t.updateFlag;return i!==void 0&&i===r?!1:(this._valueCache[e]=r,!0)}_updateMatrix3x3ForUniform(e,t){for(let i=0;i<3;i++)_e._TempBuffer[i*4]=t[i*3],_e._TempBuffer[i*4+1]=t[i*3+1],_e._TempBuffer[i*4+2]=t[i*3+2],_e._TempBuffer[i*4+3]=0;this.updateUniform(e,_e._TempBuffer,12)}_updateMatrix3x3ForEffect(e,t){this._currentEffect.setMatrix3x3(e,t)}_updateMatrix2x2ForEffect(e,t){this._currentEffect.setMatrix2x2(e,t)}_updateMatrix2x2ForUniform(e,t){for(let i=0;i<2;i++)_e._TempBuffer[i*4]=t[i*2],_e._TempBuffer[i*4+1]=t[i*2+1],_e._TempBuffer[i*4+2]=0,_e._TempBuffer[i*4+3]=0;this.updateUniform(e,_e._TempBuffer,8)}_updateFloatForEffect(e,t){this._currentEffect.setFloat(e,t)}_updateFloatForUniform(e,t){_e._TempBuffer[0]=t,this.updateUniform(e,_e._TempBuffer,1)}_updateFloat2ForEffect(e,t,i,r=""){this._currentEffect.setFloat2(e+r,t,i)}_updateFloat2ForUniform(e,t,i){_e._TempBuffer[0]=t,_e._TempBuffer[1]=i,this.updateUniform(e,_e._TempBuffer,2)}_updateFloat3ForEffect(e,t,i,r,s=""){this._currentEffect.setFloat3(e+s,t,i,r)}_updateFloat3ForUniform(e,t,i,r){_e._TempBuffer[0]=t,_e._TempBuffer[1]=i,_e._TempBuffer[2]=r,this.updateUniform(e,_e._TempBuffer,3)}_updateFloat4ForEffect(e,t,i,r,s,n=""){this._currentEffect.setFloat4(e+n,t,i,r,s)}_updateFloat4ForUniform(e,t,i,r,s){_e._TempBuffer[0]=t,_e._TempBuffer[1]=i,_e._TempBuffer[2]=r,_e._TempBuffer[3]=s,this.updateUniform(e,_e._TempBuffer,4)}_updateFloatArrayForEffect(e,t){this._currentEffect.setFloatArray(e,t)}_updateFloatArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateArrayForEffect(e,t){this._currentEffect.setArray(e,t)}_updateArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateIntArrayForEffect(e,t){this._currentEffect.setIntArray(e,t)}_updateIntArrayForUniform(e,t){_e._TempBufferInt32View.set(t),this.updateUniformArray(e,_e._TempBuffer,t.length)}_updateUIntArrayForEffect(e,t){this._currentEffect.setUIntArray(e,t)}_updateUIntArrayForUniform(e,t){_e._TempBufferUInt32View.set(t),this.updateUniformArray(e,_e._TempBuffer,t.length)}_updateMatrixForEffect(e,t){this._currentEffect.setMatrix(e,t)}_updateMatrixForUniform(e,t){this._cacheMatrix(e,t)&&this.updateUniform(e,t.asArray(),16)}_updateMatricesForEffect(e,t){this._currentEffect.setMatrices(e,t)}_updateMatricesForUniform(e,t){this.updateUniform(e,t,t.length)}_updateVector3ForEffect(e,t){this._currentEffect.setVector3(e,t)}_updateVector3ForUniform(e,t){_e._TempBuffer[0]=t.x,_e._TempBuffer[1]=t.y,_e._TempBuffer[2]=t.z,this.updateUniform(e,_e._TempBuffer,3)}_updateVector4ForEffect(e,t){this._currentEffect.setVector4(e,t)}_updateVector4ForUniform(e,t){_e._TempBuffer[0]=t.x,_e._TempBuffer[1]=t.y,_e._TempBuffer[2]=t.z,_e._TempBuffer[3]=t.w,this.updateUniform(e,_e._TempBuffer,4)}_updateColor3ForEffect(e,t,i=""){this._currentEffect.setColor3(e+i,t)}_updateColor3ForUniform(e,t){_e._TempBuffer[0]=t.r,_e._TempBuffer[1]=t.g,_e._TempBuffer[2]=t.b,this.updateUniform(e,_e._TempBuffer,3)}_updateColor4ForEffect(e,t,i,r=""){this._currentEffect.setColor4(e+r,t,i)}_updateDirectColor4ForEffect(e,t,i=""){this._currentEffect.setDirectColor4(e+i,t)}_updateColor4ForUniform(e,t,i){_e._TempBuffer[0]=t.r,_e._TempBuffer[1]=t.g,_e._TempBuffer[2]=t.b,_e._TempBuffer[3]=i,this.updateUniform(e,_e._TempBuffer,4)}_updateDirectColor4ForUniform(e,t){_e._TempBuffer[0]=t.r,_e._TempBuffer[1]=t.g,_e._TempBuffer[2]=t.b,_e._TempBuffer[3]=t.a,this.updateUniform(e,_e._TempBuffer,4)}_updateIntForEffect(e,t,i=""){this._currentEffect.setInt(e+i,t)}_updateIntForUniform(e,t){_e._TempBufferInt32View[0]=t,this.updateUniform(e,_e._TempBuffer,1)}_updateInt2ForEffect(e,t,i,r=""){this._currentEffect.setInt2(e+r,t,i)}_updateInt2ForUniform(e,t,i){_e._TempBufferInt32View[0]=t,_e._TempBufferInt32View[1]=i,this.updateUniform(e,_e._TempBuffer,2)}_updateInt3ForEffect(e,t,i,r,s=""){this._currentEffect.setInt3(e+s,t,i,r)}_updateInt3ForUniform(e,t,i,r){_e._TempBufferInt32View[0]=t,_e._TempBufferInt32View[1]=i,_e._TempBufferInt32View[2]=r,this.updateUniform(e,_e._TempBuffer,3)}_updateInt4ForEffect(e,t,i,r,s,n=""){this._currentEffect.setInt4(e+n,t,i,r,s)}_updateInt4ForUniform(e,t,i,r,s){_e._TempBufferInt32View[0]=t,_e._TempBufferInt32View[1]=i,_e._TempBufferInt32View[2]=r,_e._TempBufferInt32View[3]=s,this.updateUniform(e,_e._TempBuffer,4)}_updateUIntForEffect(e,t,i=""){this._currentEffect.setUInt(e+i,t)}_updateUIntForUniform(e,t){_e._TempBufferUInt32View[0]=t,this.updateUniform(e,_e._TempBuffer,1)}_updateUInt2ForEffect(e,t,i,r=""){this._currentEffect.setUInt2(e+r,t,i)}_updateUInt2ForUniform(e,t,i){_e._TempBufferUInt32View[0]=t,_e._TempBufferUInt32View[1]=i,this.updateUniform(e,_e._TempBuffer,2)}_updateUInt3ForEffect(e,t,i,r,s=""){this._currentEffect.setUInt3(e+s,t,i,r)}_updateUInt3ForUniform(e,t,i,r){_e._TempBufferUInt32View[0]=t,_e._TempBufferUInt32View[1]=i,_e._TempBufferUInt32View[2]=r,this.updateUniform(e,_e._TempBuffer,3)}_updateUInt4ForEffect(e,t,i,r,s,n=""){this._currentEffect.setUInt4(e+n,t,i,r,s)}_updateUInt4ForUniform(e,t,i,r,s){_e._TempBufferUInt32View[0]=t,_e._TempBufferUInt32View[1]=i,_e._TempBufferUInt32View[2]=r,_e._TempBufferUInt32View[3]=s,this.updateUniform(e,_e._TempBuffer,4)}setTexture(e,t){this._currentEffect.setTexture(e,t)}setTextureArray(e,t){this._currentEffect.setTextureArray(e,t)}bindTexture(e,t){this._currentEffect._bindTexture(e,t)}updateUniformDirectly(e,t){this.updateUniform(e,t,t.length),this.update()}bindToEffect(e,t){this._currentEffect=e,this._currentEffectName=t}bindUniformBuffer(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName)}unbindEffect(){this._currentEffect=void 0,this._currentEffectName=void 0}setDataBuffer(e){if(!this._buffers)return this._buffer===e;for(let t=0;t<this._buffers.length;++t)if(this._buffers[t][0]===e)return this._bufferIndex=t,this._buffer=e,this._createBufferOnWrite=!1,this._currentEffect=void 0,!0;return!1}dispose(){if(this._noUBO)return;const e=this._engine._uniformBuffers,t=e.indexOf(this);if(t!==-1&&(e[t]=e[e.length-1],e.pop()),this._engine._features.trackUbosInFrame&&this._buffers)for(let i=0;i<this._buffers.length;++i){const r=this._buffers[i][0];this._engine._releaseBuffer(r)}else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}}_e._UpdatedUbosInFrame={};_e._MAX_UNIFORM_SIZE=256;_e._TempBuffer=new Float32Array(_e._MAX_UNIFORM_SIZE);_e._TempBufferInt32View=new Int32Array(_e._TempBuffer.buffer);_e._TempBufferUInt32View=new Uint32Array(_e._TempBuffer.buffer);class wn{get underlyingResource(){return null}constructor(){this.references=0,this.capacity=0,this.is32Bits=!1,this.uniqueId=wn._Counter++}}wn._Counter=0;function ZA(a,e,t,i){switch(e){case 5120:{let r=a.getInt8(t);return i&&(r=Math.max(r/127,-1)),r}case 5121:{let r=a.getUint8(t);return i&&(r=r/255),r}case 5122:{let r=a.getInt16(t,!0);return i&&(r=Math.max(r/32767,-1)),r}case 5123:{let r=a.getUint16(t,!0);return i&&(r=r/65535),r}case 5124:return a.getInt32(t,!0);case 5125:return a.getUint32(t,!0);case 5126:return a.getFloat32(t,!0);default:throw new Error(`Invalid component type ${e}`)}}function QA(a,e,t,i,r){switch(e){case 5120:{i&&(r=Math.round(r*127)),a.setInt8(t,r);break}case 5121:{i&&(r=Math.round(r*255)),a.setUint8(t,r);break}case 5122:{i&&(r=Math.round(r*32767)),a.setInt16(t,r,!0);break}case 5123:{i&&(r=Math.round(r*65535)),a.setUint16(t,r,!0);break}case 5124:{a.setInt32(t,r,!0);break}case 5125:{a.setUint32(t,r,!0);break}case 5126:{a.setFloat32(t,r,!0);break}default:throw new Error(`Invalid component type ${e}`)}}function Yr(a){switch(a){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:throw new Error(`Invalid type '${a}'`)}}function PL(a){switch(a){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:throw new Error(`Invalid component type '${a}'`)}}function Ca(a,e,t,i,r,s,n,o){const l=new Array(i),c=new Array(i);if(a instanceof Array){let h=e/4;const f=t/4;for(let u=0;u<s;u+=i){for(let d=0;d<i;d++)l[d]=c[d]=a[h+d];o(c,u);for(let d=0;d<i;d++)l[d]!==c[d]&&(a[h+d]=c[d]);h+=f}}else{const h=ArrayBuffer.isView(a)?new DataView(a.buffer,a.byteOffset,a.byteLength):new DataView(a),f=Yr(r);for(let u=0;u<s;u+=i){for(let d=0,_=e;d<i;d++,_+=f)l[d]=c[d]=ZA(h,r,_,n);o(c,u);for(let d=0,_=e;d<i;d++,_+=f)l[d]!==c[d]&&QA(h,r,_,n,c[d]);e+=t}}}function Ph(a,e,t,i,r,s,n,o){const l=e*Yr(t),c=n*e;if(t!==5126||r!==l){const h=new Float32Array(c);return Ca(a,i,r,e,t,c,s,(f,u)=>{for(let d=0;d<e;d++)h[u+d]=f[d]}),h}if(!(a instanceof Array||a instanceof Float32Array)||i!==0||a.length!==c)if(a instanceof Array){const h=i/4;return a.slice(h,h+c)}else{if(a instanceof ArrayBuffer)return new Float32Array(a,i,c);{const h=a.byteOffset+i;return h&3&&(B.Warn("Float array must be aligned to 4-bytes border"),o=!0),o?new Float32Array(a.buffer.slice(h,h+c*Float32Array.BYTES_PER_ELEMENT)):new Float32Array(a.buffer,h,c)}}return o?a.slice():a}function $A(a,e,t,i,r,s,n,o){const l=e*Yr(t),c=n*e;if(o.length!==c)throw new Error("Output length is not valid");if(t!==5126||r!==l){Ca(a,i,r,e,t,c,s,(h,f)=>{for(let u=0;u<e;u++)o[f+u]=h[u]});return}if(a instanceof Array){const h=i/4;o.set(a,h)}else if(a instanceof ArrayBuffer){const h=new Float32Array(a,i,c);o.set(h)}else{const h=a.byteOffset+i;if(h&3){B.Warn("Float array must be aligned to 4-bytes border"),o.set(new Float32Array(a.buffer.slice(h,h+c*Float32Array.BYTES_PER_ELEMENT)));return}const f=new Float32Array(a.buffer,h,c);o.set(f)}}class Cn{get isDisposed(){return this._isDisposed}constructor(e,t,i,r=0,s=!1,n=!1,o=!1,l,c){this._isAlreadyOwned=!1,this._isDisposed=!1,e&&e.getScene?this._engine=e.getScene().getEngine():this._engine=e,this._updatable=i,this._instanced=n,this._divisor=l||1,this._label=c,t instanceof wn?(this._data=null,this._buffer=t):(this._data=t,this._buffer=null),this.byteStride=o?r:r*Float32Array.BYTES_PER_ELEMENT,s||this.create()}createVertexBuffer(e,t,i,r,s,n=!1,o){const l=n?t:t*Float32Array.BYTES_PER_ELEMENT,c=r?n?r:r*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new x(this._engine,this,e,this._updatable,!0,c,s===void 0?this._instanced:s,l,i,void 0,void 0,!0,this._divisor||o)}isUpdatable(){return this._updatable}getData(){return this._data}getBuffer(){return this._buffer}getStrideSize(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT}create(e=null){!e&&this._buffer||(e=e||this._data,e&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e),this._data=e):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(e,this._label),this._data=e):this._buffer=this._engine.createVertexBuffer(e,void 0,this._label)))}_rebuild(){if(this._data)this._buffer=null,this.create(this._data);else{if(!this._buffer)return;if(this._buffer.capacity>0){this._updatable?this._buffer=this._engine.createDynamicVertexBuffer(this._buffer.capacity,this._label):this._buffer=this._engine.createVertexBuffer(this._buffer.capacity,void 0,this._label);return}B.Warn(`Missing data for buffer "${this._label}" ${this._buffer?"(uniqueId: "+this._buffer.uniqueId+")":""}. Buffer reconstruction failed.`),this._buffer=null}}update(e){this.create(e)}updateDirectly(e,t,i,r=!1){this._buffer&&this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e,r?t:t*Float32Array.BYTES_PER_ELEMENT,i?i*this.byteStride:void 0),t===0&&i===void 0?this._data=e:this._data=null)}_increaseReferences(){if(this._buffer){if(!this._isAlreadyOwned){this._isAlreadyOwned=!0;return}this._buffer.references++}}dispose(){this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._isDisposed=!0,this._data=null,this._buffer=null)}}class x{get isDisposed(){return this._isDisposed}get instanceDivisor(){return this._instanceDivisor}set instanceDivisor(e){const t=e!=0;this._instanceDivisor=e,t!==this._instanced&&(this._instanced=t,this._computeHashCode())}get _maxVerticesCount(){const e=this.getData();return e?Array.isArray(e)?e.length/(this.byteStride/4)-this.byteOffset/4:(e.byteLength-this.byteOffset)/this.byteStride:0}constructor(e,t,i,r,s,n,o,l,c,h,f=!1,u=!1,d=1,_=!1){this._isDisposed=!1;let p=!1;if(this.engine=e,typeof r=="object"&&r!==null?(p=r.updatable??!1,s=r.postponeInternalCreation,n=r.stride,o=r.instanced,l=r.offset,c=r.size,h=r.type,f=r.normalized??!1,u=r.useBytes??!1,d=r.divisor??1,_=r.takeBufferOwnership??!1,this._label=r.label):p=!!r,t instanceof Cn?(this._buffer=t,this._ownsBuffer=_):(this._buffer=new Cn(e,t,p,n,s,o,u,d,this._label),this._ownsBuffer=!0),this.uniqueId=x._Counter++,this._kind=i,h===void 0){const E=this.getData();this.type=E?x.GetDataType(E):x.FLOAT}else this.type=h;const g=Yr(this.type);u?(this._size=c||(n?n/g:x.DeduceStride(i)),this.byteStride=n||this._buffer.byteStride||this._size*g,this.byteOffset=l||0):(this._size=c||n||x.DeduceStride(i),this.byteStride=n?n*g:this._buffer.byteStride||this._size*g,this.byteOffset=(l||0)*g),this.normalized=f,this._instanced=o!==void 0?o:!1,this._instanceDivisor=o?d:0,this._alignBuffer(),this._computeHashCode()}_computeHashCode(){this.hashCode=(this.type-5120<<0)+((this.normalized?1:0)<<3)+(this._size<<4)+((this._instanced?1:0)<<6)+(this.byteStride<<12)}_rebuild(){var e;(e=this._buffer)==null||e._rebuild()}getKind(){return this._kind}isUpdatable(){return this._buffer.isUpdatable()}getData(){return this._buffer.getData()}getFloatData(e,t){const i=this.getData();return i?Ph(i,this._size,this.type,this.byteOffset,this.byteStride,this.normalized,e,t):null}getBuffer(){return this._buffer.getBuffer()}getWrapperBuffer(){return this._buffer}getStrideSize(){return this.byteStride/Yr(this.type)}getOffset(){return this.byteOffset/Yr(this.type)}getSize(e=!1){return e?this._size*Yr(this.type):this._size}getIsInstanced(){return this._instanced}getInstanceDivisor(){return this._instanceDivisor}create(e){this._buffer.create(e),this._alignBuffer()}update(e){this._buffer.update(e),this._alignBuffer()}updateDirectly(e,t,i=!1){this._buffer.updateDirectly(e,t,void 0,i),this._alignBuffer()}dispose(){this._ownsBuffer&&this._buffer.dispose(),this._isDisposed=!0}forEach(e,t){Ca(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,e,this.normalized,(i,r)=>{for(let s=0;s<this._size;s++)t(i[s],r+s)})}_alignBuffer(){}static DeduceStride(e){switch(e){case x.UVKind:case x.UV2Kind:case x.UV3Kind:case x.UV4Kind:case x.UV5Kind:case x.UV6Kind:return 2;case x.NormalKind:case x.PositionKind:return 3;case x.ColorKind:case x.ColorInstanceKind:case x.MatricesIndicesKind:case x.MatricesIndicesExtraKind:case x.MatricesWeightsKind:case x.MatricesWeightsExtraKind:case x.TangentKind:return 4;default:throw new Error("Invalid kind '"+e+"'")}}static GetDataType(e){return e instanceof Int8Array?x.BYTE:e instanceof Uint8Array?x.UNSIGNED_BYTE:e instanceof Int16Array?x.SHORT:e instanceof Uint16Array?x.UNSIGNED_SHORT:e instanceof Int32Array?x.INT:e instanceof Uint32Array?x.UNSIGNED_INT:x.FLOAT}static GetTypeByteLength(e){return Yr(e)}static ForEach(e,t,i,r,s,n,o,l){Ca(e,t,i,r,s,n,o,(c,h)=>{for(let f=0;f<r;f++)l(c[f],h+f)})}static GetFloatData(e,t,i,r,s,n,o,l){return Ph(e,t,i,r,s,n,o,l)}}x._Counter=0;x.BYTE=5120;x.UNSIGNED_BYTE=5121;x.SHORT=5122;x.UNSIGNED_SHORT=5123;x.INT=5124;x.UNSIGNED_INT=5125;x.FLOAT=5126;x.PositionKind="position";x.NormalKind="normal";x.TangentKind="tangent";x.UVKind="uv";x.UV2Kind="uv2";x.UV3Kind="uv3";x.UV4Kind="uv4";x.UV5Kind="uv5";x.UV6Kind="uv6";x.ColorKind="color";x.ColorInstanceKind="instanceColor";x.MatricesIndicesKind="matricesIndices";x.MatricesWeightsKind="matricesWeights";x.MatricesIndicesExtraKind="matricesIndicesExtra";x.MatricesWeightsExtraKind="matricesWeightsExtra";class oi{constructor(){this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshFaceId=-1,this.subMeshId=0,this.pickedSprite=null,this.thinInstanceIndex=-1,this.ray=null,this.originMesh=null,this.aimTransform=null,this.gripTransform=null}getNormal(e=!1,t=!0){if(!this.pickedMesh||t&&!this.pickedMesh.isVerticesDataPresent(x.NormalKind))return null;let i=this.pickedMesh.getIndices();(i==null?void 0:i.length)===0&&(i=null);let r;const s=F.Vector3[0],n=F.Vector3[1],o=F.Vector3[2];if(t){const c=this.pickedMesh.getVerticesData(x.NormalKind);let h=i?m.FromArrayToRef(c,i[this.faceId*3]*3,s):s.copyFromFloats(c[this.faceId*3*3],c[this.faceId*3*3+1],c[this.faceId*3*3+2]),f=i?m.FromArrayToRef(c,i[this.faceId*3+1]*3,n):n.copyFromFloats(c[(this.faceId*3+1)*3],c[(this.faceId*3+1)*3+1],c[(this.faceId*3+1)*3+2]),u=i?m.FromArrayToRef(c,i[this.faceId*3+2]*3,o):o.copyFromFloats(c[(this.faceId*3+2)*3],c[(this.faceId*3+2)*3+1],c[(this.faceId*3+2)*3+2]);h=h.scale(this.bu),f=f.scale(this.bv),u=u.scale(1-this.bu-this.bv),r=new m(h.x+f.x+u.x,h.y+f.y+u.y,h.z+f.z+u.z)}else{const c=this.pickedMesh.getVerticesData(x.PositionKind),h=i?m.FromArrayToRef(c,i[this.faceId*3]*3,s):s.copyFromFloats(c[this.faceId*3*3],c[this.faceId*3*3+1],c[this.faceId*3*3+2]),f=i?m.FromArrayToRef(c,i[this.faceId*3+1]*3,n):n.copyFromFloats(c[(this.faceId*3+1)*3],c[(this.faceId*3+1)*3+1],c[(this.faceId*3+1)*3+2]),u=i?m.FromArrayToRef(c,i[this.faceId*3+2]*3,o):o.copyFromFloats(c[(this.faceId*3+2)*3],c[(this.faceId*3+2)*3+1],c[(this.faceId*3+2)*3+2]),d=h.subtract(f),_=u.subtract(f);r=m.Cross(d,_)}const l=(c,h)=>{if(this.thinInstanceIndex!==-1){const u=c.thinInstanceGetWorldMatrices()[this.thinInstanceIndex];u&&m.TransformNormalToRef(h,u,h)}let f=c.getWorldMatrix();c.nonUniformScaling&&(F.Matrix[0].copyFrom(f),f=F.Matrix[0],f.setTranslationFromFloats(0,0,0),f.invert(),f.transposeToRef(F.Matrix[1]),f=F.Matrix[1]),m.TransformNormalToRef(h,f,h)};if(e&&l(this.pickedMesh,r),this.ray){const c=F.Vector3[0].copyFrom(r);e||l(this.pickedMesh,c),m.Dot(c,this.ray.direction)>0&&r.negateInPlace()}return r.normalize(),r}getTextureCoordinates(e=x.UVKind){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(e))return null;const t=this.pickedMesh.getIndices();if(!t)return null;const i=this.pickedMesh.getVerticesData(e);if(!i)return null;let r=ne.FromArray(i,t[this.faceId*3]*2),s=ne.FromArray(i,t[this.faceId*3+1]*2),n=ne.FromArray(i,t[this.faceId*3+2]*2);return r=r.scale(this.bu),s=s.scale(this.bv),n=n.scale(1-this.bu-this.bv),new ne(r.x+s.x+n.x,r.y+s.y+n.y)}}class qt{constructor(e,t,i,r,s,n){this.source=e,this.pointerX=t,this.pointerY=i,this.meshUnderPointer=r,this.sourceEvent=s,this.additionalData=n}static CreateNew(e,t,i){const r=e.getScene();return new qt(e,r.pointerX,r.pointerY,r.meshUnderPointer||e,t,i)}static CreateNewFromSprite(e,t,i,r){return new qt(e,t.pointerX,t.pointerY,t.meshUnderPointer,i,r)}static CreateNewFromScene(e,t){return new qt(null,e.pointerX,e.pointerY,e.meshUnderPointer,t)}static CreateNewFromPrimitive(e,t,i,r){return new qt(e,t.x,t.y,null,i,r)}}class al{constructor(e){this._vertexBuffers={},this.onBeforeRenderObservable=new U,this._scene=e}_prepareBuffers(){if(this._vertexBuffers[x.PositionKind])return;const e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[x.PositionKind]=new x(this._scene.getEngine(),e,x.PositionKind,!1,!1,2),this._buildIndexBuffer()}_buildIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}_rebuild(){const e=this._vertexBuffers[x.PositionKind];e&&(e._rebuild(),this._buildIndexBuffer())}_prepareFrame(e=null,t=null){const i=this._scene.activeCamera;return!i||(t=t||i._postProcesses.filter(r=>r!=null),!t||t.length===0||!this._scene.postProcessesEnabled)?!1:(t[0].activate(i,e,t!=null),!0)}directRender(e,t=null,i=!1,r=0,s=0,n=!1){var l;const o=this._scene.getEngine();for(let c=0;c<e.length;c++){c<e.length-1?e[c+1].activate(this._scene.activeCamera||this._scene,t==null?void 0:t.texture):(t?o.bindFramebuffer(t,r,void 0,void 0,i,s):n||o.restoreDefaultFramebuffer(),(l=o._debugInsertMarker)==null||l.call(o,`post process ${e[c].name} output`));const h=e[c],f=h.apply();f&&(h.onBeforeRenderObservable.notifyObservers(f),this._prepareBuffers(),o.bindBuffers(this._vertexBuffers,this._indexBuffer,f),o.drawElementsType(0,0,6),h.onAfterRenderObservable.notifyObservers(f))}o.setDepthBuffer(!0),o.setDepthWrite(!0)}_finalizeFrame(e,t,i,r,s=!1){var l;const n=this._scene.activeCamera;if(!n||(this.onBeforeRenderObservable.notifyObservers(this),r=r||n._postProcesses.filter(c=>c!=null),r.length===0||!this._scene.postProcessesEnabled))return;const o=this._scene.getEngine();for(let c=0,h=r.length;c<h;c++){const f=r[c];if(c<h-1?f._outputTexture=r[c+1].activate(n,t==null?void 0:t.texture):(t?(o.bindFramebuffer(t,i,void 0,void 0,s),f._outputTexture=t):(o.restoreDefaultFramebuffer(),f._outputTexture=null),(l=o._debugInsertMarker)==null||l.call(o,`post process ${r[c].name} output`)),e)break;const u=f.apply();u&&(f.onBeforeRenderObservable.notifyObservers(u),this._prepareBuffers(),o.bindBuffers(this._vertexBuffers,this._indexBuffer,u),o.drawElementsType(0,0,6),f.onAfterRenderObservable.notifyObservers(u))}o.setDepthBuffer(!0),o.setDepthWrite(!0),o.setAlphaMode(0)}dispose(){const e=this._vertexBuffers[x.PositionKind];e&&(e.dispose(),this._vertexBuffers[x.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)}}class er{set opaqueSortCompareFn(e){e?this._opaqueSortCompareFn=e:this._opaqueSortCompareFn=er.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted}set alphaTestSortCompareFn(e){e?this._alphaTestSortCompareFn=e:this._alphaTestSortCompareFn=er.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted}set transparentSortCompareFn(e){e?this._transparentSortCompareFn=e:this._transparentSortCompareFn=er.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted}constructor(e,t,i=null,r=null,s=null){this.index=e,this._opaqueSubMeshes=new jt(256),this._transparentSubMeshes=new jt(256),this._alphaTestSubMeshes=new jt(256),this._depthOnlySubMeshes=new jt(256),this._particleSystems=new jt(256),this._spriteManagers=new jt(256),this._empty=!0,this._edgesRenderers=new hs(16),this._scene=t,this.opaqueSortCompareFn=i,this.alphaTestSortCompareFn=r,this.transparentSortCompareFn=s}render(e,t,i,r){if(e){e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);return}const s=this._scene.getEngine();this._depthOnlySubMeshes.length!==0&&(s.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),s.setColorWrite(!0)),this._opaqueSubMeshes.length!==0&&this._renderOpaque(this._opaqueSubMeshes),this._alphaTestSubMeshes.length!==0&&this._renderAlphaTest(this._alphaTestSubMeshes);const n=s.getStencilBuffer();if(s.setStencilBuffer(!1),t&&this._renderSprites(),i&&this._renderParticles(r),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),this._transparentSubMeshes.length!==0||this._scene.useOrderIndependentTransparency){if(s.setStencilBuffer(n),this._scene.useOrderIndependentTransparency){const o=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);o.length&&this._renderTransparent(o)}else this._renderTransparent(this._transparentSubMeshes);s.setAlphaMode(0)}if(s.setStencilBuffer(!1),this._edgesRenderers.length){for(let o=0;o<this._edgesRenderers.length;o++)this._edgesRenderers.data[o].render();s.setAlphaMode(0)}s.setStencilBuffer(n)}_renderOpaqueSorted(e){er._RenderSorted(e,this._opaqueSortCompareFn,this._scene.activeCamera,!1)}_renderAlphaTestSorted(e){er._RenderSorted(e,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)}_renderTransparentSorted(e){er._RenderSorted(e,this._transparentSortCompareFn,this._scene.activeCamera,!0)}static _RenderSorted(e,t,i,r){let s=0,n;const o=i?i.globalPosition:er._ZeroVector;if(r)for(;s<e.length;s++)n=e.data[s],n._alphaIndex=n.getMesh().alphaIndex,n._distanceToCamera=m.Distance(n.getBoundingInfo().boundingSphere.centerWorld,o);const l=e.length===e.data.length?e.data:e.data.slice(0,e.length);t&&l.sort(t);const c=l[0].getMesh().getScene();for(s=0;s<l.length;s++)if(n=l[s],!(c._activeMeshesFrozenButKeepClipping&&!n.isInFrustum(c._frustumPlanes))){if(r){const h=n.getMaterial();if(h&&h.needDepthPrePass){const f=h.getScene().getEngine();f.setColorWrite(!1),f.setAlphaMode(0),n.render(!1),f.setColorWrite(!0)}}n.render(r)}}static defaultTransparentSortCompare(e,t){return e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:er.backToFrontSortCompare(e,t)}static backToFrontSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0}static frontToBackSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?-1:e._distanceToCamera>t._distanceToCamera?1:0}static PainterSortCompare(e,t){const i=e.getMesh(),r=t.getMesh();return i.material&&r.material?i.material.uniqueId-r.material.uniqueId:i.uniqueId-r.uniqueId}prepare(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this.prepareSprites(),this._edgesRenderers.reset(),this._empty=!0}prepareSprites(){this._spriteManagers.reset()}dispose(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()}dispatch(e,t,i){t===void 0&&(t=e.getMesh()),i===void 0&&(i=e.getMaterial()),i!=null&&(i.needAlphaBlendingForMesh(t)?this._transparentSubMeshes.push(e):i.needAlphaTestingForMesh(t)?(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._alphaTestSubMeshes.push(e)):(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._opaqueSubMeshes.push(e)),t._renderingGroup=this,t._edgesRenderer&&t.isEnabled()&&t.isVisible&&t._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(t._edgesRenderer),this._empty=!1)}dispatchSprites(e){this._spriteManagers.push(e),this._empty=!1}dispatchParticles(e){this._particleSystems.push(e),this._empty=!1}_renderParticles(e){if(this._particleSystems.length===0)return;const t=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(let i=0;i<this._particleSystems.length;i++){const r=this._particleSystems.data[i];if((t&&t.layerMask&r.layerMask)===0)continue;const s=r.emitter;(!s.position||!e||e.indexOf(s)!==-1)&&this._scene._activeParticles.addCount(r.render(),!1)}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}_renderSprites(){if(!this._scene.spritesEnabled||this._spriteManagers.length===0)return;const e=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(let t=0;t<this._spriteManagers.length;t++){const i=this._spriteManagers.data[t];(e&&e.layerMask&i.layerMask)!==0&&i.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}}er._ZeroVector=m.Zero();class JA{}class ii{get maintainStateBetweenFrames(){return this._maintainStateBetweenFrames}set maintainStateBetweenFrames(e){e!==this._maintainStateBetweenFrames&&(this._maintainStateBetweenFrames=e,this._maintainStateBetweenFrames||this.restoreDispachedFlags())}restoreDispachedFlags(){for(const e of this._scene.meshes)if(e.subMeshes)for(const t of e.subMeshes)t._wasDispatched=!1;if(this._scene.spriteManagers)for(const e of this._scene.spriteManagers)e._wasDispatched=!1;for(const e of this._scene.particleSystems)e._wasDispatched=!1}constructor(e){this._useSceneAutoClearSetup=!1,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new JA,this._maintainStateBetweenFrames=!1,this._scene=e;for(let t=ii.MIN_RENDERINGGROUPS;t<ii.MAX_RENDERINGGROUPS;t++)this._autoClearDepthStencil[t]={autoClear:!0,depth:!0,stencil:!0}}getRenderingGroup(e){const t=e||0;return this._prepareRenderingGroup(t),this._renderingGroups[t]}_clearDepthStencilBuffer(e=!0,t=!0){this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(null,!1,e,t),this._depthStencilBufferAlreadyCleaned=!0)}render(e,t,i,r){const s=this._renderingGroupInfo;if(s.scene=this._scene,s.camera=this._scene.activeCamera,s.renderingManager=this,this._scene.spriteManagers&&r)for(let n=0;n<this._scene.spriteManagers.length;n++){const o=this._scene.spriteManagers[n];this.dispatchSprites(o)}for(let n=ii.MIN_RENDERINGGROUPS;n<ii.MAX_RENDERINGGROUPS;n++){this._depthStencilBufferAlreadyCleaned=n===ii.MIN_RENDERINGGROUPS;const o=this._renderingGroups[n];if(!o||o._empty)continue;const l=1<<n;if(s.renderingGroupId=n,this._scene.onBeforeRenderingGroupObservable.notifyObservers(s,l),ii.AUTOCLEAR){const c=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(n):this._autoClearDepthStencil[n];c&&c.autoClear&&this._clearDepthStencilBuffer(c.depth,c.stencil)}for(const c of this._scene._beforeRenderingGroupDrawStage)c.action(n);o.render(e,r,i,t);for(const c of this._scene._afterRenderingGroupDrawStage)c.action(n);this._scene.onAfterRenderingGroupObservable.notifyObservers(s,l)}}reset(){if(!this.maintainStateBetweenFrames)for(let e=ii.MIN_RENDERINGGROUPS;e<ii.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.prepare()}}resetSprites(){if(!this.maintainStateBetweenFrames)for(let e=ii.MIN_RENDERINGGROUPS;e<ii.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.prepareSprites()}}dispose(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null}freeRenderingGroups(){for(let e=ii.MIN_RENDERINGGROUPS;e<ii.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.dispose()}}_prepareRenderingGroup(e){this._renderingGroups[e]===void 0&&(this._renderingGroups[e]=new er(e,this._scene,this._customOpaqueSortCompareFn[e],this._customAlphaTestSortCompareFn[e],this._customTransparentSortCompareFn[e]))}dispatchSprites(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchSprites(e))}dispatchParticles(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchParticles(e))}dispatch(e,t,i){t===void 0&&(t=e.getMesh()),!(this.maintainStateBetweenFrames&&e._wasDispatched)&&(e._wasDispatched=!0,this.getRenderingGroup(t.renderingGroupId).dispatch(e,t,i))}setRenderingOrder(e,t=null,i=null,r=null){if(this._customOpaqueSortCompareFn[e]=t,this._customAlphaTestSortCompareFn[e]=i,this._customTransparentSortCompareFn[e]=r,this._renderingGroups[e]){const s=this._renderingGroups[e];s.opaqueSortCompareFn=this._customOpaqueSortCompareFn[e],s.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[e],s.transparentSortCompareFn=this._customTransparentSortCompareFn[e]}}setRenderingAutoClearDepthStencil(e,t,i=!0,r=!0){this._autoClearDepthStencil[e]={autoClear:t,depth:i,stencil:r}}getAutoClearDepthStencilSetup(e){return this._autoClearDepthStencil[e]}}ii.MAX_RENDERINGGROUPS=4;ii.MIN_RENDERINGGROUPS=0;ii.AUTOCLEAR=!0;class Ae{}Ae.NAME_EFFECTLAYER="EffectLayer";Ae.NAME_LAYER="Layer";Ae.NAME_LENSFLARESYSTEM="LensFlareSystem";Ae.NAME_BOUNDINGBOXRENDERER="BoundingBoxRenderer";Ae.NAME_PARTICLESYSTEM="ParticleSystem";Ae.NAME_GAMEPAD="Gamepad";Ae.NAME_SIMPLIFICATIONQUEUE="SimplificationQueue";Ae.NAME_GEOMETRYBUFFERRENDERER="GeometryBufferRenderer";Ae.NAME_PREPASSRENDERER="PrePassRenderer";Ae.NAME_DEPTHRENDERER="DepthRenderer";Ae.NAME_DEPTHPEELINGRENDERER="DepthPeelingRenderer";Ae.NAME_POSTPROCESSRENDERPIPELINEMANAGER="PostProcessRenderPipelineManager";Ae.NAME_SPRITE="Sprite";Ae.NAME_SUBSURFACE="SubSurface";Ae.NAME_OUTLINERENDERER="Outline";Ae.NAME_PROCEDURALTEXTURE="ProceduralTexture";Ae.NAME_SHADOWGENERATOR="ShadowGenerator";Ae.NAME_OCTREE="Octree";Ae.NAME_PHYSICSENGINE="PhysicsEngine";Ae.NAME_AUDIO="Audio";Ae.NAME_FLUIDRENDERER="FluidRenderer";Ae.NAME_IBLCDFGENERATOR="iblCDFGenerator";Ae.STEP_ISREADYFORMESH_EFFECTLAYER=0;Ae.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER=0;Ae.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER=0;Ae.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER=0;Ae.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER=1;Ae.STEP_BEFORECAMERADRAW_PREPASS=0;Ae.STEP_BEFORECAMERADRAW_EFFECTLAYER=1;Ae.STEP_BEFORECAMERADRAW_LAYER=2;Ae.STEP_BEFORERENDERTARGETDRAW_PREPASS=0;Ae.STEP_BEFORERENDERTARGETDRAW_LAYER=1;Ae.STEP_BEFORERENDERINGMESH_PREPASS=0;Ae.STEP_BEFORERENDERINGMESH_OUTLINE=1;Ae.STEP_AFTERRENDERINGMESH_PREPASS=0;Ae.STEP_AFTERRENDERINGMESH_OUTLINE=1;Ae.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW=0;Ae.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER=1;Ae.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE=0;Ae.STEP_BEFORECLEAR_PROCEDURALTEXTURE=0;Ae.STEP_BEFORECLEAR_PREPASS=1;Ae.STEP_BEFORERENDERTARGETCLEAR_PREPASS=0;Ae.STEP_AFTERRENDERTARGETDRAW_PREPASS=0;Ae.STEP_AFTERRENDERTARGETDRAW_LAYER=1;Ae.STEP_AFTERCAMERADRAW_PREPASS=0;Ae.STEP_AFTERCAMERADRAW_EFFECTLAYER=1;Ae.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM=2;Ae.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW=3;Ae.STEP_AFTERCAMERADRAW_LAYER=4;Ae.STEP_AFTERCAMERADRAW_FLUIDRENDERER=5;Ae.STEP_AFTERCAMERAPOSTPROCESS_LAYER=0;Ae.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER=0;Ae.STEP_AFTERRENDER_AUDIO=0;Ae.STEP_GATHERRENDERTARGETS_DEPTHRENDERER=0;Ae.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER=1;Ae.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR=2;Ae.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER=3;Ae.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER=0;Ae.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER=1;Ae.STEP_POINTERMOVE_SPRITE=0;Ae.STEP_POINTERDOWN_SPRITE=0;Ae.STEP_POINTERUP_SPRITE=0;class Pt extends Array{constructor(e){super(...e)}static Create(){return Object.create(Pt.prototype)}registerStep(e,t,i){let r=0,s=Number.MAX_VALUE;for(;r<this.length&&(s=this[r].index,!(e<s));r++);this.splice(r,0,{index:e,component:t,action:i.bind(t)})}clear(){this.length=0}}class ge{}ge.POINTERDOWN=1;ge.POINTERUP=2;ge.POINTERMOVE=4;ge.POINTERWHEEL=8;ge.POINTERPICK=16;ge.POINTERTAP=32;ge.POINTERDOUBLETAP=64;class Lm{constructor(e,t){this.type=e,this.event=t}}class eR extends Lm{constructor(e,t,i,r){super(e,t),this.ray=null,this.originalPickingInfo=null,this.skipOnPointerObservable=!1,this.localPosition=new ne(i,r)}}class Xi extends Lm{get pickInfo(){return this._pickInfo||this._generatePickInfo(),this._pickInfo}constructor(e,t,i,r=null){super(e,t),this._pickInfo=i,this._inputManager=r}_generatePickInfo(){this._inputManager&&(this._pickInfo=this._inputManager._pickMove(this.event),this._inputManager._setRayOnPointerInfo(this._pickInfo,this.event),this._inputManager=null)}}class Fi{constructor(){this.hoverCursor="",this.actions=[],this.isRecursive=!1,this.disposeWhenUnowned=!0}static get HasTriggers(){for(const e in Fi.Triggers)if(Object.prototype.hasOwnProperty.call(Fi.Triggers,e))return!0;return!1}static get HasPickTriggers(){for(const e in Fi.Triggers)if(Object.prototype.hasOwnProperty.call(Fi.Triggers,e)){const t=parseInt(e);if(t>=1&&t<=7)return!0}return!1}static HasSpecificTrigger(e){for(const t in Fi.Triggers)if(Object.prototype.hasOwnProperty.call(Fi.Triggers,t)&&parseInt(t)===e)return!0;return!1}}Fi.Triggers={};class Qs{}Qs.KEYDOWN=1;Qs.KEYUP=2;class ol{constructor(e,t){this.type=e,this.event=t}}class Oh extends ol{get skipOnPointerObservable(){return this.skipOnKeyboardObservable}set skipOnPointerObservable(e){this.skipOnKeyboardObservable=e}constructor(e,t){super(e,t),this.type=e,this.event=t,this.skipOnKeyboardObservable=!1}}var Te;(function(a){a[a.Generic=0]="Generic",a[a.Keyboard=1]="Keyboard",a[a.Mouse=2]="Mouse",a[a.Touch=3]="Touch",a[a.DualShock=4]="DualShock",a[a.Xbox=5]="Xbox",a[a.Switch=6]="Switch",a[a.DualSense=7]="DualSense"})(Te||(Te={}));var De;(function(a){a[a.Horizontal=0]="Horizontal",a[a.Vertical=1]="Vertical",a[a.LeftClick=2]="LeftClick",a[a.MiddleClick=3]="MiddleClick",a[a.RightClick=4]="RightClick",a[a.BrowserBack=5]="BrowserBack",a[a.BrowserForward=6]="BrowserForward",a[a.MouseWheelX=7]="MouseWheelX",a[a.MouseWheelY=8]="MouseWheelY",a[a.MouseWheelZ=9]="MouseWheelZ",a[a.Move=12]="Move"})(De||(De={}));var Dh;(function(a){a[a.Horizontal=0]="Horizontal",a[a.Vertical=1]="Vertical",a[a.LeftClick=2]="LeftClick",a[a.MiddleClick=3]="MiddleClick",a[a.RightClick=4]="RightClick",a[a.BrowserBack=5]="BrowserBack",a[a.BrowserForward=6]="BrowserForward",a[a.MouseWheelX=7]="MouseWheelX",a[a.MouseWheelY=8]="MouseWheelY",a[a.MouseWheelZ=9]="MouseWheelZ",a[a.DeltaHorizontal=10]="DeltaHorizontal",a[a.DeltaVertical=11]="DeltaVertical"})(Dh||(Dh={}));var Lh;(function(a){a[a.Cross=0]="Cross",a[a.Circle=1]="Circle",a[a.Square=2]="Square",a[a.Triangle=3]="Triangle",a[a.L1=4]="L1",a[a.R1=5]="R1",a[a.L2=6]="L2",a[a.R2=7]="R2",a[a.Share=8]="Share",a[a.Options=9]="Options",a[a.L3=10]="L3",a[a.R3=11]="R3",a[a.DPadUp=12]="DPadUp",a[a.DPadDown=13]="DPadDown",a[a.DPadLeft=14]="DPadLeft",a[a.DPadRight=15]="DPadRight",a[a.Home=16]="Home",a[a.TouchPad=17]="TouchPad",a[a.LStickXAxis=18]="LStickXAxis",a[a.LStickYAxis=19]="LStickYAxis",a[a.RStickXAxis=20]="RStickXAxis",a[a.RStickYAxis=21]="RStickYAxis"})(Lh||(Lh={}));var Nh;(function(a){a[a.Cross=0]="Cross",a[a.Circle=1]="Circle",a[a.Square=2]="Square",a[a.Triangle=3]="Triangle",a[a.L1=4]="L1",a[a.R1=5]="R1",a[a.L2=6]="L2",a[a.R2=7]="R2",a[a.Create=8]="Create",a[a.Options=9]="Options",a[a.L3=10]="L3",a[a.R3=11]="R3",a[a.DPadUp=12]="DPadUp",a[a.DPadDown=13]="DPadDown",a[a.DPadLeft=14]="DPadLeft",a[a.DPadRight=15]="DPadRight",a[a.Home=16]="Home",a[a.TouchPad=17]="TouchPad",a[a.LStickXAxis=18]="LStickXAxis",a[a.LStickYAxis=19]="LStickYAxis",a[a.RStickXAxis=20]="RStickXAxis",a[a.RStickYAxis=21]="RStickYAxis"})(Nh||(Nh={}));var Fh;(function(a){a[a.A=0]="A",a[a.B=1]="B",a[a.X=2]="X",a[a.Y=3]="Y",a[a.LB=4]="LB",a[a.RB=5]="RB",a[a.LT=6]="LT",a[a.RT=7]="RT",a[a.Back=8]="Back",a[a.Start=9]="Start",a[a.LS=10]="LS",a[a.RS=11]="RS",a[a.DPadUp=12]="DPadUp",a[a.DPadDown=13]="DPadDown",a[a.DPadLeft=14]="DPadLeft",a[a.DPadRight=15]="DPadRight",a[a.Home=16]="Home",a[a.LStickXAxis=17]="LStickXAxis",a[a.LStickYAxis=18]="LStickYAxis",a[a.RStickXAxis=19]="RStickXAxis",a[a.RStickYAxis=20]="RStickYAxis"})(Fh||(Fh={}));var wh;(function(a){a[a.B=0]="B",a[a.A=1]="A",a[a.Y=2]="Y",a[a.X=3]="X",a[a.L=4]="L",a[a.R=5]="R",a[a.ZL=6]="ZL",a[a.ZR=7]="ZR",a[a.Minus=8]="Minus",a[a.Plus=9]="Plus",a[a.LS=10]="LS",a[a.RS=11]="RS",a[a.DPadUp=12]="DPadUp",a[a.DPadDown=13]="DPadDown",a[a.DPadLeft=14]="DPadLeft",a[a.DPadRight=15]="DPadRight",a[a.Home=16]="Home",a[a.Capture=17]="Capture",a[a.LStickXAxis=18]="LStickXAxis",a[a.LStickYAxis=19]="LStickYAxis",a[a.RStickXAxis=20]="RStickXAxis",a[a.RStickYAxis=21]="RStickYAxis"})(wh||(wh={}));var Bh;(function(a){a[a.PointerMove=0]="PointerMove",a[a.PointerDown=1]="PointerDown",a[a.PointerUp=2]="PointerUp"})(Bh||(Bh={}));class sn{}sn.DOM_DELTA_PIXEL=0;sn.DOM_DELTA_LINE=1;sn.DOM_DELTA_PAGE=2;class fs{static CreateDeviceEvent(e,t,i,r,s,n,o){switch(e){case Te.Keyboard:return this._CreateKeyboardEvent(i,r,s,n);case Te.Mouse:if(i===De.MouseWheelX||i===De.MouseWheelY||i===De.MouseWheelZ)return this._CreateWheelEvent(e,t,i,r,s,n);case Te.Touch:return this._CreatePointerEvent(e,t,i,r,s,n,o);default:throw`Unable to generate event for device ${Te[e]}`}}static _CreatePointerEvent(e,t,i,r,s,n,o){const l=this._CreateMouseEvent(e,t,i,r,s,n);e===Te.Mouse?(l.deviceType=Te.Mouse,l.pointerId=1,l.pointerType="mouse"):(l.deviceType=Te.Touch,l.pointerId=o??t,l.pointerType="touch");let c=0;return c+=s.pollInput(e,t,De.LeftClick),c+=s.pollInput(e,t,De.RightClick)*2,c+=s.pollInput(e,t,De.MiddleClick)*4,l.buttons=c,i===De.Move?l.type="pointermove":i>=De.LeftClick&&i<=De.RightClick&&(l.type=r===1?"pointerdown":"pointerup",l.button=i-2),l}static _CreateWheelEvent(e,t,i,r,s,n){const o=this._CreateMouseEvent(e,t,i,r,s,n);switch(o.pointerId=1,o.type="wheel",o.deltaMode=sn.DOM_DELTA_PIXEL,o.deltaX=0,o.deltaY=0,o.deltaZ=0,i){case De.MouseWheelX:o.deltaX=r;break;case De.MouseWheelY:o.deltaY=r;break;case De.MouseWheelZ:o.deltaZ=r;break}return o}static _CreateMouseEvent(e,t,i,r,s,n){const o=this._CreateEvent(n),l=s.pollInput(e,t,De.Horizontal),c=s.pollInput(e,t,De.Vertical);return n?(o.movementX=0,o.movementY=0,o.offsetX=o.movementX-n.getBoundingClientRect().x,o.offsetY=o.movementY-n.getBoundingClientRect().y):(o.movementX=s.pollInput(e,t,10),o.movementY=s.pollInput(e,t,11),o.offsetX=0,o.offsetY=0),this._CheckNonCharacterKeys(o,s),o.clientX=l,o.clientY=c,o.x=l,o.y=c,o.deviceType=e,o.deviceSlot=t,o.inputIndex=i,o}static _CreateKeyboardEvent(e,t,i,r){const s=this._CreateEvent(r);return this._CheckNonCharacterKeys(s,i),s.deviceType=Te.Keyboard,s.deviceSlot=0,s.inputIndex=e,s.type=t===1?"keydown":"keyup",s.key=String.fromCharCode(e),s.keyCode=e,s}static _CheckNonCharacterKeys(e,t){const i=t.isDeviceAvailable(Te.Keyboard),r=i&&t.pollInput(Te.Keyboard,0,18)===1,s=i&&t.pollInput(Te.Keyboard,0,17)===1,n=i&&(t.pollInput(Te.Keyboard,0,91)===1||t.pollInput(Te.Keyboard,0,92)===1||t.pollInput(Te.Keyboard,0,93)===1),o=i&&t.pollInput(Te.Keyboard,0,16)===1;e.altKey=r,e.ctrlKey=s,e.metaKey=n,e.shiftKey=o}static _CreateEvent(e){const t={};return t.preventDefault=()=>{},t.target=e,t}}class tR{constructor(e,t,i){this._nativeInput=_native.DeviceInputSystem?new _native.DeviceInputSystem(e,t,(r,s,n,o)=>{const l=fs.CreateDeviceEvent(r,s,n,o,this);i(r,s,l)}):this._createDummyNativeInput()}pollInput(e,t,i){return this._nativeInput.pollInput(e,t,i)}isDeviceAvailable(e){return e===Te.Mouse||e===Te.Touch}dispose(){this._nativeInput.dispose()}_createDummyNativeInput(){return{pollInput:()=>0,isDeviceAvailable:()=>!1,dispose:()=>{}}}}const Uh=255,Vh=Object.keys(De).length/2;class iR{constructor(e,t,i,r){this._inputs=[],this._keyboardActive=!1,this._pointerActive=!1,this._usingSafari=k.IsSafari(),this._usingMacOS=ks()&&/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform),this._keyboardDownEvent=s=>{},this._keyboardUpEvent=s=>{},this._keyboardBlurEvent=s=>{},this._pointerMoveEvent=s=>{},this._pointerDownEvent=s=>{},this._pointerUpEvent=s=>{},this._pointerCancelEvent=s=>{},this._pointerCancelTouch=s=>{},this._pointerLeaveEvent=s=>{},this._pointerWheelEvent=s=>{},this._pointerBlurEvent=s=>{},this._pointerMacOSChromeOutEvent=s=>{},this._eventsAttached=!1,this._mouseId=-1,this._isUsingFirefox=ks()&&navigator.userAgent&&navigator.userAgent.indexOf("Firefox")!==-1,this._isUsingChromium=ks()&&navigator.userAgent&&navigator.userAgent.indexOf("Chrome")!==-1,this._maxTouchPoints=0,this._pointerInputClearObserver=null,this._gamepadConnectedEvent=s=>{},this._gamepadDisconnectedEvent=s=>{},this._eventPrefix=k.GetPointerPrefix(e),this._engine=e,this._onDeviceConnected=t,this._onDeviceDisconnected=i,this._onInputChanged=r,this._mouseId=this._isUsingFirefox?0:1,this._enableEvents(),this._usingMacOS&&(this._metaKeys=[]),this._engine._onEngineViewChanged||(this._engine._onEngineViewChanged=()=>{this._enableEvents()})}pollInput(e,t,i){const r=this._inputs[e][t];if(!r)throw`Unable to find device ${Te[e]}`;e>=Te.DualShock&&e<=Te.DualSense&&this._updateDevice(e,t,i);const s=r[i];if(s===void 0)throw`Unable to find input ${i} for device ${Te[e]} in slot ${t}`;return i===De.Move&&k.Warn("Unable to provide information for PointerInput.Move.  Try using PointerInput.Horizontal or PointerInput.Vertical for move data."),s}isDeviceAvailable(e){return this._inputs[e]!==void 0}dispose(){this._onDeviceConnected=()=>{},this._onDeviceDisconnected=()=>{},this._onInputChanged=()=>{},delete this._engine._onEngineViewChanged,this._elementToAttachTo&&this._disableEvents()}_enableEvents(){const e=this==null?void 0:this._engine.getInputElement();if(e&&(!this._eventsAttached||this._elementToAttachTo!==e)){if(this._disableEvents(),this._inputs){for(const t of this._inputs)if(t)for(const i in t){const r=+i,s=t[r];if(s)for(let n=0;n<s.length;n++)s[n]=0}}this._elementToAttachTo=e,this._elementToAttachTo.tabIndex=this._elementToAttachTo.tabIndex!==-1?this._elementToAttachTo.tabIndex:this._engine.canvasTabIndex,this._handleKeyActions(),this._handlePointerActions(),this._handleGamepadActions(),this._eventsAttached=!0,this._checkForConnectedDevices()}}_disableEvents(){this._elementToAttachTo&&(this._elementToAttachTo.removeEventListener("blur",this._keyboardBlurEvent),this._elementToAttachTo.removeEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.removeEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.removeEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"leave",this._pointerLeaveEvent),this._elementToAttachTo.removeEventListener(this._wheelEventName,this._pointerWheelEvent),this._usingMacOS&&this._isUsingChromium&&this._elementToAttachTo.removeEventListener("lostpointercapture",this._pointerMacOSChromeOutEvent),window.removeEventListener("gamepadconnected",this._gamepadConnectedEvent),window.removeEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)),this._pointerInputClearObserver&&this._engine.onEndFrameObservable.remove(this._pointerInputClearObserver),this._eventsAttached=!1}_checkForConnectedDevices(){if(navigator.getGamepads){const e=navigator.getGamepads();for(const t of e)t&&this._addGamePad(t)}typeof matchMedia=="function"&&matchMedia("(pointer:fine)").matches&&this._addPointerDevice(Te.Mouse,0,0,0)}_addGamePad(e){const t=this._getGamepadDeviceType(e.id),i=e.index;this._gamepads=this._gamepads||new Array(e.index+1),this._registerDevice(t,i,e.buttons.length+e.axes.length),this._gamepads[i]=t}_addPointerDevice(e,t,i,r){this._pointerActive||(this._pointerActive=!0),this._registerDevice(e,t,Vh);const s=this._inputs[e][t];s[0]=i,s[1]=r}_registerDevice(e,t,i){if(t===void 0)throw`Unable to register device ${Te[e]} to undefined slot.`;if(this._inputs[e]||(this._inputs[e]={}),!this._inputs[e][t]){const r=new Array(i);r.fill(0),this._inputs[e][t]=r,this._onDeviceConnected(e,t)}}_unregisterDevice(e,t){this._inputs[e][t]&&(delete this._inputs[e][t],this._onDeviceDisconnected(e,t))}_handleKeyActions(){this._keyboardDownEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(Te.Keyboard,0,Uh));const t=this._inputs[Te.Keyboard][0];if(t){t[e.keyCode]=1;const i=e;i.inputIndex=e.keyCode,this._usingMacOS&&e.metaKey&&e.key!=="Meta"&&(this._metaKeys.includes(e.keyCode)||this._metaKeys.push(e.keyCode)),this._onInputChanged(Te.Keyboard,0,i)}},this._keyboardUpEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(Te.Keyboard,0,Uh));const t=this._inputs[Te.Keyboard][0];if(t){t[e.keyCode]=0;const i=e;if(i.inputIndex=e.keyCode,this._usingMacOS&&e.key==="Meta"&&this._metaKeys.length>0){for(const r of this._metaKeys){const s=fs.CreateDeviceEvent(Te.Keyboard,0,r,0,this,this._elementToAttachTo);t[r]=0,this._onInputChanged(Te.Keyboard,0,s)}this._metaKeys.splice(0,this._metaKeys.length)}this._onInputChanged(Te.Keyboard,0,i)}},this._keyboardBlurEvent=()=>{if(this._keyboardActive){const e=this._inputs[Te.Keyboard][0];for(let t=0;t<e.length;t++)if(e[t]!==0){e[t]=0;const i=fs.CreateDeviceEvent(Te.Keyboard,0,t,0,this,this._elementToAttachTo);this._onInputChanged(Te.Keyboard,0,i)}this._usingMacOS&&this._metaKeys.splice(0,this._metaKeys.length)}},this._elementToAttachTo.addEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.addEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.addEventListener("blur",this._keyboardBlurEvent)}_handlePointerActions(){this._maxTouchPoints=ks()&&navigator.maxTouchPoints||2,this._activeTouchIds||(this._activeTouchIds=new Array(this._maxTouchPoints));for(let i=0;i<this._maxTouchPoints;i++)this._activeTouchIds[i]=-1;this._pointerMoveEvent=i=>{const r=this._getPointerType(i);let s=r===Te.Mouse?0:this._activeTouchIds.indexOf(i.pointerId);if(r===Te.Touch&&s===-1){const o=this._activeTouchIds.indexOf(-1);if(o>=0)s=o,this._activeTouchIds[o]=i.pointerId,this._onDeviceConnected(r,s);else{k.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);return}}this._inputs[r]||(this._inputs[r]={}),this._inputs[r][s]||this._addPointerDevice(r,s,i.clientX,i.clientY);const n=this._inputs[r][s];if(n){const o=i;o.inputIndex=De.Move,n[De.Horizontal]=i.clientX,n[De.Vertical]=i.clientY,r===Te.Touch&&n[De.LeftClick]===0&&(n[De.LeftClick]=1),i.pointerId===void 0&&(i.pointerId=this._mouseId),this._onInputChanged(r,s,o),!this._usingSafari&&i.button!==-1&&(o.inputIndex=i.button+2,n[i.button+2]=n[i.button+2]?0:1,this._onInputChanged(r,s,o))}},this._pointerDownEvent=i=>{const r=this._getPointerType(i);let s=r===Te.Mouse?0:i.pointerId;if(r===Te.Touch){let o=this._activeTouchIds.indexOf(i.pointerId);if(o===-1&&(o=this._activeTouchIds.indexOf(-1)),o>=0)s=o,this._activeTouchIds[o]=i.pointerId;else{k.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);return}}this._inputs[r]||(this._inputs[r]={}),this._inputs[r][s]?r===Te.Touch&&this._onDeviceConnected(r,s):this._addPointerDevice(r,s,i.clientX,i.clientY);const n=this._inputs[r][s];if(n){const o=n[De.Horizontal],l=n[De.Vertical];if(r===Te.Mouse){if(i.pointerId===void 0&&(i.pointerId=this._mouseId),!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(this._mouseId)}catch{}}else if(i.pointerId&&!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(i.pointerId)}catch{}n[De.Horizontal]=i.clientX,n[De.Vertical]=i.clientY,n[i.button+2]=1;const c=i;c.inputIndex=i.button+2,this._onInputChanged(r,s,c),(o!==i.clientX||l!==i.clientY)&&(c.inputIndex=De.Move,this._onInputChanged(r,s,c))}},this._pointerUpEvent=i=>{var c,h,f,u,d;const r=this._getPointerType(i),s=r===Te.Mouse?0:this._activeTouchIds.indexOf(i.pointerId);if(r===Te.Touch){if(s===-1)return;this._activeTouchIds[s]=-1}const n=(c=this._inputs[r])==null?void 0:c[s];let o=i.button,l=n&&n[o+2]!==0;if(!l&&this._isUsingFirefox&&this._usingMacOS&&n&&(o=o===2?0:2,l=n[o+2]!==0),l){const _=n[De.Horizontal],p=n[De.Vertical];n[De.Horizontal]=i.clientX,n[De.Vertical]=i.clientY,n[o+2]=0;const g=i;i.pointerId===void 0&&(i.pointerId=this._mouseId),(_!==i.clientX||p!==i.clientY)&&(g.inputIndex=De.Move,this._onInputChanged(r,s,g)),g.inputIndex=o+2,r===Te.Mouse&&this._mouseId>=0&&((f=(h=this._elementToAttachTo).hasPointerCapture)!=null&&f.call(h,this._mouseId))?this._elementToAttachTo.releasePointerCapture(this._mouseId):i.pointerId&&((d=(u=this._elementToAttachTo).hasPointerCapture)!=null&&d.call(u,i.pointerId))&&this._elementToAttachTo.releasePointerCapture(i.pointerId),this._onInputChanged(r,s,g),r===Te.Touch&&this._onDeviceDisconnected(r,s)}},this._pointerCancelTouch=i=>{var n,o;const r=this._activeTouchIds.indexOf(i);if(r===-1)return;(o=(n=this._elementToAttachTo).hasPointerCapture)!=null&&o.call(n,i)&&this._elementToAttachTo.releasePointerCapture(i),this._inputs[Te.Touch][r][De.LeftClick]=0;const s=fs.CreateDeviceEvent(Te.Touch,r,De.LeftClick,0,this,this._elementToAttachTo,i);this._onInputChanged(Te.Touch,r,s),this._activeTouchIds[r]=-1,this._onDeviceDisconnected(Te.Touch,r)},this._pointerCancelEvent=i=>{var r,s;if(i.pointerType==="mouse"){const n=this._inputs[Te.Mouse][0];this._mouseId>=0&&((s=(r=this._elementToAttachTo).hasPointerCapture)!=null&&s.call(r,this._mouseId))&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let o=De.LeftClick;o<=De.BrowserForward;o++)if(n[o]===1){n[o]=0;const l=fs.CreateDeviceEvent(Te.Mouse,0,o,0,this,this._elementToAttachTo);this._onInputChanged(Te.Mouse,0,l)}}else this._pointerCancelTouch(i.pointerId)},this._pointerLeaveEvent=i=>{i.pointerType==="pen"&&this._pointerCancelTouch(i.pointerId)},this._wheelEventName="onwheel"in document.createElement("div")?"wheel":document.onmousewheel!==void 0?"mousewheel":"DOMMouseScroll";let e=!1;const t=function(){};try{const i=Object.defineProperty({},"passive",{get:function(){e=!0}});this._elementToAttachTo.addEventListener("test",t,i),this._elementToAttachTo.removeEventListener("test",t,i)}catch{}this._pointerBlurEvent=()=>{var i,r,s,n,o;if(this.isDeviceAvailable(Te.Mouse)){const l=this._inputs[Te.Mouse][0];this._mouseId>=0&&((r=(i=this._elementToAttachTo).hasPointerCapture)!=null&&r.call(i,this._mouseId))&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let c=De.LeftClick;c<=De.BrowserForward;c++)if(l[c]===1){l[c]=0;const h=fs.CreateDeviceEvent(Te.Mouse,0,c,0,this,this._elementToAttachTo);this._onInputChanged(Te.Mouse,0,h)}}if(this.isDeviceAvailable(Te.Touch)){const l=this._inputs[Te.Touch];for(let c=0;c<this._activeTouchIds.length;c++){const h=this._activeTouchIds[c];if((n=(s=this._elementToAttachTo).hasPointerCapture)!=null&&n.call(s,h)&&this._elementToAttachTo.releasePointerCapture(h),h!==-1&&((o=l[c])==null?void 0:o[De.LeftClick])===1){l[c][De.LeftClick]=0;const f=fs.CreateDeviceEvent(Te.Touch,c,De.LeftClick,0,this,this._elementToAttachTo,h);this._onInputChanged(Te.Touch,c,f),this._activeTouchIds[c]=-1,this._onDeviceDisconnected(Te.Touch,c)}}}},this._pointerWheelEvent=i=>{const r=Te.Mouse,s=0;this._inputs[r]||(this._inputs[r]=[]),this._inputs[r][s]||(this._pointerActive=!0,this._registerDevice(r,s,Vh));const n=this._inputs[r][s];if(n){n[De.MouseWheelX]=i.deltaX||0,n[De.MouseWheelY]=i.deltaY||i.wheelDelta||0,n[De.MouseWheelZ]=i.deltaZ||0;const o=i;i.pointerId===void 0&&(i.pointerId=this._mouseId),n[De.MouseWheelX]!==0&&(o.inputIndex=De.MouseWheelX,this._onInputChanged(r,s,o)),n[De.MouseWheelY]!==0&&(o.inputIndex=De.MouseWheelY,this._onInputChanged(r,s,o)),n[De.MouseWheelZ]!==0&&(o.inputIndex=De.MouseWheelZ,this._onInputChanged(r,s,o))}},this._usingMacOS&&this._isUsingChromium&&(this._pointerMacOSChromeOutEvent=i=>{i.buttons>1&&this._pointerCancelEvent(i)},this._elementToAttachTo.addEventListener("lostpointercapture",this._pointerMacOSChromeOutEvent)),this._elementToAttachTo.addEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"leave",this._pointerLeaveEvent),this._elementToAttachTo.addEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.addEventListener(this._wheelEventName,this._pointerWheelEvent,e?{passive:!1}:!1),this._pointerInputClearObserver=this._engine.onEndFrameObservable.add(()=>{if(this.isDeviceAvailable(Te.Mouse)){const i=this._inputs[Te.Mouse][0];i[De.MouseWheelX]=0,i[De.MouseWheelY]=0,i[De.MouseWheelZ]=0}})}_handleGamepadActions(){this._gamepadConnectedEvent=e=>{this._addGamePad(e.gamepad)},this._gamepadDisconnectedEvent=e=>{if(this._gamepads){const t=this._getGamepadDeviceType(e.gamepad.id),i=e.gamepad.index;this._unregisterDevice(t,i),delete this._gamepads[i]}},window.addEventListener("gamepadconnected",this._gamepadConnectedEvent),window.addEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)}_updateDevice(e,t,i){const r=navigator.getGamepads()[t];if(r&&e===this._gamepads[t]){const s=this._inputs[e][t];i>=r.buttons.length?s[i]=r.axes[i-r.buttons.length].valueOf():s[i]=r.buttons[i].value}}_getGamepadDeviceType(e){return e.indexOf("054c")!==-1?e.indexOf("0ce6")!==-1?Te.DualSense:Te.DualShock:e.indexOf("Xbox One")!==-1||e.search("Xbox 360")!==-1||e.search("xinput")!==-1?Te.Xbox:e.indexOf("057e")!==-1?Te.Switch:Te.Generic}_getPointerType(e){let t=Te.Mouse;return(e.pointerType==="touch"||e.pointerType==="pen"||e.touches)&&(t=Te.Touch),t}}class Gh{constructor(e,t,i=0){this.deviceType=t,this.deviceSlot=i,this.onInputChangedObservable=new U,this._deviceInputSystem=e}getInput(e){return this._deviceInputSystem.pollInput(this.deviceType,this.deviceSlot,e)}}class rR{constructor(e){this._registeredManagers=new Array,this._refCount=0,this.registerManager=n=>{for(let o=0;o<this._devices.length;o++){const l=this._devices[o];for(const c in l){const h=+c;n._addDevice(new Gh(this._deviceInputSystem,o,h))}}this._registeredManagers.push(n)},this.unregisterManager=n=>{const o=this._registeredManagers.indexOf(n);o>-1&&this._registeredManagers.splice(o,1)};const t=Object.keys(Te).length/2;this._devices=new Array(t);const i=(n,o)=>{this._devices[n]||(this._devices[n]=new Array),this._devices[n][o]||(this._devices[n][o]=o);for(const l of this._registeredManagers){const c=new Gh(this._deviceInputSystem,n,o);l._addDevice(c)}},r=(n,o)=>{var l;(l=this._devices[n])!=null&&l[o]&&delete this._devices[n][o];for(const c of this._registeredManagers)c._removeDevice(n,o)},s=(n,o,l)=>{if(l)for(const c of this._registeredManagers)c._onInputChanged(n,o,l)};typeof _native<"u"?this._deviceInputSystem=new tR(i,r,s):this._deviceInputSystem=new iR(e,i,r,s)}dispose(){this._deviceInputSystem.dispose()}}class sR{getDeviceSource(e,t){if(t===void 0){if(this._firstDevice[e]===void 0)return null;t=this._firstDevice[e]}return!this._devices[e]||this._devices[e][t]===void 0?null:this._devices[e][t]}getDeviceSources(e){return this._devices[e]?this._devices[e].filter(t=>!!t):[]}constructor(e){const t=Object.keys(Te).length/2;this._devices=new Array(t),this._firstDevice=new Array(t),this._engine=e,this._engine._deviceSourceManager||(this._engine._deviceSourceManager=new rR(e)),this._engine._deviceSourceManager._refCount++,this.onDeviceConnectedObservable=new U(i=>{for(const r of this._devices)if(r)for(const s of r)s&&this.onDeviceConnectedObservable.notifyObserver(i,s)}),this.onDeviceDisconnectedObservable=new U,this._engine._deviceSourceManager.registerManager(this),this._onDisposeObserver=e.onDisposeObservable.add(()=>{this.dispose()})}dispose(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this._engine._deviceSourceManager&&(this._engine._deviceSourceManager.unregisterManager(this),--this._engine._deviceSourceManager._refCount<1&&(this._engine._deviceSourceManager.dispose(),delete this._engine._deviceSourceManager)),this._engine.onDisposeObservable.remove(this._onDisposeObserver)}_addDevice(e){this._devices[e.deviceType]||(this._devices[e.deviceType]=new Array),this._devices[e.deviceType][e.deviceSlot]||(this._devices[e.deviceType][e.deviceSlot]=e,this._updateFirstDevices(e.deviceType)),this.onDeviceConnectedObservable.notifyObservers(e)}_removeDevice(e,t){var r,s;const i=(r=this._devices[e])==null?void 0:r[t];this.onDeviceDisconnectedObservable.notifyObservers(i),(s=this._devices[e])!=null&&s[t]&&delete this._devices[e][t],this._updateFirstDevices(e)}_onInputChanged(e,t,i){var r,s;(s=(r=this._devices[e])==null?void 0:r[t])==null||s.onInputChangedObservable.notifyObservers(i)}_updateFirstDevices(e){switch(e){case Te.Keyboard:case Te.Mouse:this._firstDevice[e]=0;break;case Te.Touch:case Te.DualSense:case Te.DualShock:case Te.Xbox:case Te.Switch:case Te.Generic:{delete this._firstDevice[e];const t=this._devices[e];if(t){for(let i=0;i<t.length;i++)if(t[i]){this._firstDevice[e]=i;break}}break}}}}class vc{}vc._IsPickingAvailable=!1;class kh{constructor(){this._singleClick=!1,this._doubleClick=!1,this._hasSwiped=!1,this._ignore=!1}get singleClick(){return this._singleClick}get doubleClick(){return this._doubleClick}get hasSwiped(){return this._hasSwiped}get ignore(){return this._ignore}set singleClick(e){this._singleClick=e}set doubleClick(e){this._doubleClick=e}set hasSwiped(e){this._hasSwiped=e}set ignore(e){this._ignore=e}}class Ot{constructor(e){this._alreadyAttached=!1,this._meshPickProceed=!1,this._currentPickResult=null,this._previousPickResult=null,this._activePointerIds=new Array,this._activePointerIdsCount=0,this._doubleClickOccured=!1,this._isSwiping=!1,this._swipeButtonPressed=-1,this._skipPointerTap=!1,this._isMultiTouchGesture=!1,this._pointerX=0,this._pointerY=0,this._startingPointerPosition=new ne(0,0),this._previousStartingPointerPosition=new ne(0,0),this._startingPointerTime=0,this._previousStartingPointerTime=0,this._pointerCaptures={},this._meshUnderPointerId={},this._movePointerInfo=null,this._cameraObserverCount=0,this._delayedClicks=[null,null,null,null,null],this._deviceSourceManager=null,this._scene=e||Re.LastCreatedScene,this._scene}get meshUnderPointer(){return this._movePointerInfo&&(this._movePointerInfo._generatePickInfo(),this._movePointerInfo=null),this._pointerOverMesh}getMeshUnderPointerByPointerId(e){return this._meshUnderPointerId[e]||null}get unTranslatedPointer(){return new ne(this._unTranslatedPointerX,this._unTranslatedPointerY)}get pointerX(){return this._pointerX}set pointerX(e){this._pointerX=e}get pointerY(){return this._pointerY}set pointerY(e){this._pointerY=e}_updatePointerPosition(e){const t=this._scene.getEngine().getInputElementClientRect();t&&(this._pointerX=e.clientX-t.left,this._pointerY=e.clientY-t.top,this._unTranslatedPointerX=this._pointerX,this._unTranslatedPointerY=this._pointerY)}_processPointerMove(e,t){const i=this._scene,r=i.getEngine(),s=r.getInputElement();s&&(s.tabIndex=r.canvasTabIndex,i.doNotHandleCursors||(s.style.cursor=i.defaultCursor)),this._setCursorAndPointerOverMesh(e,t,i);for(const l of i._pointerMoveStage){e=e||this._pickMove(t);const c=!!(e!=null&&e.pickedMesh);e=l.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,c,s)}const n=t.inputIndex>=De.MouseWheelX&&t.inputIndex<=De.MouseWheelZ?ge.POINTERWHEEL:ge.POINTERMOVE;i.onPointerMove&&(e=e||this._pickMove(t),i.onPointerMove(t,e,n));let o;e?(o=new Xi(n,t,e),this._setRayOnPointerInfo(e,t)):(o=new Xi(n,t,null,this),this._movePointerInfo=o),i.onPointerObservable.hasObservers()&&i.onPointerObservable.notifyObservers(o,n)}_setRayOnPointerInfo(e,t){const i=this._scene;e&&vc._IsPickingAvailable&&(e.ray||(e.ray=i.createPickingRay(t.offsetX,t.offsetY,P.Identity(),i.activeCamera)))}_addCameraPointerObserver(e,t){return this._cameraObserverCount++,this._scene.onPointerObservable.add(e,t)}_removeCameraPointerObserver(e){return this._cameraObserverCount--,this._scene.onPointerObservable.remove(e)}_checkForPicking(){return!!(this._scene.onPointerObservable.observers.length>this._cameraObserverCount||this._scene.onPointerPick)}_checkPrePointerObservable(e,t,i){const r=this._scene,s=new eR(i,t,this._unTranslatedPointerX,this._unTranslatedPointerY);return e&&(s.originalPickingInfo=e,s.ray=e.ray,t.pointerType==="xr-near"&&e.originMesh&&(s.nearInteractionPickingInfo=e)),r.onPrePointerObservable.notifyObservers(s,i),!!s.skipOnPointerObservable}_pickMove(e){const t=this._scene,i=t.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,t.pointerMovePredicate,t.pointerMoveFastCheck,t.cameraToUseForPointers,t.pointerMoveTrianglePredicate);return this._setCursorAndPointerOverMesh(i,e,t),i}_setCursorAndPointerOverMesh(e,t,i){const s=i.getEngine().getInputElement();if(e!=null&&e.pickedMesh){if(this.setPointerOverMesh(e.pickedMesh,t.pointerId,e,t),!i.doNotHandleCursors&&s&&this._pointerOverMesh){const n=this._pointerOverMesh._getActionManagerForTrigger();n&&n.hasPointerTriggers&&(s.style.cursor=n.hoverCursor||i.hoverCursor)}}else this.setPointerOverMesh(null,t.pointerId,e,t)}simulatePointerMove(e,t){const i=new PointerEvent("pointermove",t);i.inputIndex=De.Move,!this._checkPrePointerObservable(e,i,ge.POINTERMOVE)&&this._processPointerMove(e,i)}simulatePointerDown(e,t){const i=new PointerEvent("pointerdown",t);i.inputIndex=i.button+2,!this._checkPrePointerObservable(e,i,ge.POINTERDOWN)&&this._processPointerDown(e,i)}_processPointerDown(e,t){const i=this._scene;if(e!=null&&e.pickedMesh){this._pickedDownMesh=e.pickedMesh;const n=e.pickedMesh._getActionManagerForTrigger();if(n){if(n.hasPickTriggers)switch(n.processTrigger(5,new qt(e.pickedMesh,i.pointerX,i.pointerY,e.pickedMesh,t,e)),t.button){case 0:n.processTrigger(2,new qt(e.pickedMesh,i.pointerX,i.pointerY,e.pickedMesh,t,e));break;case 1:n.processTrigger(4,new qt(e.pickedMesh,i.pointerX,i.pointerY,e.pickedMesh,t,e));break;case 2:n.processTrigger(3,new qt(e.pickedMesh,i.pointerX,i.pointerY,e.pickedMesh,t,e));break}n.hasSpecificTrigger(8)&&window.setTimeout(()=>{const o=i.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,l=>l.isPickable&&l.isVisible&&l.isReady()&&l.actionManager&&l.actionManager.hasSpecificTrigger(8)&&l===this._pickedDownMesh,!1,i.cameraToUseForPointers);o!=null&&o.pickedMesh&&n&&this._activePointerIdsCount!==0&&Date.now()-this._startingPointerTime>Ot.LongPressDelay&&!this._isPointerSwiping()&&(this._startingPointerTime=0,n.processTrigger(8,qt.CreateNew(o.pickedMesh,t)))},Ot.LongPressDelay)}}else for(const n of i._pointerDownStage)e=n.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,!1);let r;const s=ge.POINTERDOWN;e?(i.onPointerDown&&i.onPointerDown(t,e,s),r=new Xi(s,t,e),this._setRayOnPointerInfo(e,t)):r=new Xi(s,t,null,this),i.onPointerObservable.hasObservers()&&i.onPointerObservable.notifyObservers(r,s)}_isPointerSwiping(){return this._isSwiping}simulatePointerUp(e,t,i){const r=new PointerEvent("pointerup",t);r.inputIndex=De.Move;const s=new kh;i?s.doubleClick=!0:s.singleClick=!0,!this._checkPrePointerObservable(e,r,ge.POINTERUP)&&this._processPointerUp(e,r,s)}_processPointerUp(e,t,i){const r=this._scene;if(e!=null&&e.pickedMesh){if(this._pickedUpMesh=e.pickedMesh,this._pickedDownMesh===this._pickedUpMesh&&(r.onPointerPick&&r.onPointerPick(t,e),i.singleClick&&!i.ignore&&r.onPointerObservable.observers.length>this._cameraObserverCount)){const n=ge.POINTERPICK,o=new Xi(n,t,e);this._setRayOnPointerInfo(e,t),r.onPointerObservable.notifyObservers(o,n)}const s=e.pickedMesh._getActionManagerForTrigger();if(s&&!i.ignore){s.processTrigger(7,qt.CreateNew(e.pickedMesh,t,e)),!i.hasSwiped&&i.singleClick&&s.processTrigger(1,qt.CreateNew(e.pickedMesh,t,e));const n=e.pickedMesh._getActionManagerForTrigger(6);i.doubleClick&&n&&n.processTrigger(6,qt.CreateNew(e.pickedMesh,t,e))}}else if(!i.ignore)for(const s of r._pointerUpStage)e=s.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,i.doubleClick);if(this._pickedDownMesh&&this._pickedDownMesh!==this._pickedUpMesh){const s=this._pickedDownMesh._getActionManagerForTrigger(16);s&&s.processTrigger(16,qt.CreateNew(this._pickedDownMesh,t))}if(!i.ignore){const s=new Xi(ge.POINTERUP,t,e);if(this._setRayOnPointerInfo(e,t),r.onPointerObservable.notifyObservers(s,ge.POINTERUP),r.onPointerUp&&r.onPointerUp(t,e,ge.POINTERUP),!i.hasSwiped&&!this._skipPointerTap&&!this._isMultiTouchGesture){let n=0;if(i.singleClick?n=ge.POINTERTAP:i.doubleClick&&(n=ge.POINTERDOUBLETAP),n){const o=new Xi(n,t,e);r.onPointerObservable.hasObservers()&&r.onPointerObservable.hasSpecificMask(n)&&r.onPointerObservable.notifyObservers(o,n)}}}}isPointerCaptured(e=0){return this._pointerCaptures[e]}attachControl(e=!0,t=!0,i=!0,r=null){const s=this._scene,n=s.getEngine();r||(r=n.getInputElement()),this._alreadyAttached&&this.detachControl(),r&&(this._alreadyAttachedTo=r),this._deviceSourceManager=new sR(n),this._initActionManager=o=>{if(!this._meshPickProceed){const l=s.skipPointerUpPicking||s._registeredActions===0&&!this._checkForPicking()&&!s.onPointerUp?null:s.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,s.pointerUpPredicate,s.pointerUpFastCheck,s.cameraToUseForPointers,s.pointerUpTrianglePredicate);this._currentPickResult=l,l&&(o=l.hit&&l.pickedMesh?l.pickedMesh._getActionManagerForTrigger():null),this._meshPickProceed=!0}return o},this._delayedSimpleClick=(o,l,c)=>{if((Date.now()-this._previousStartingPointerTime>Ot.DoubleClickDelay&&!this._doubleClickOccured||o!==this._previousButtonPressed)&&(this._doubleClickOccured=!1,l.singleClick=!0,l.ignore=!1,this._delayedClicks[o])){const h=this._delayedClicks[o].evt,f=ge.POINTERTAP,u=new Xi(f,h,this._currentPickResult);s.onPointerObservable.hasObservers()&&s.onPointerObservable.hasSpecificMask(f)&&s.onPointerObservable.notifyObservers(u,f),this._delayedClicks[o]=null}},this._initClickEvent=(o,l,c,h)=>{var p,g;const f=new kh;this._currentPickResult=null;let u=null,d=o.hasSpecificMask(ge.POINTERPICK)||l.hasSpecificMask(ge.POINTERPICK)||o.hasSpecificMask(ge.POINTERTAP)||l.hasSpecificMask(ge.POINTERTAP)||o.hasSpecificMask(ge.POINTERDOUBLETAP)||l.hasSpecificMask(ge.POINTERDOUBLETAP);!d&&Fi&&(u=this._initActionManager(u,f),u&&(d=u.hasPickTriggers));let _=!1;if(d=d&&!this._isMultiTouchGesture,d){const E=c.button;if(f.hasSwiped=this._isPointerSwiping(),!f.hasSwiped){let v=!Ot.ExclusiveDoubleClickMode;if(v||(v=!o.hasSpecificMask(ge.POINTERDOUBLETAP)&&!l.hasSpecificMask(ge.POINTERDOUBLETAP),v&&!Fi.HasSpecificTrigger(6)&&(u=this._initActionManager(u,f),u&&(v=!u.hasSpecificTrigger(6)))),v)(Date.now()-this._previousStartingPointerTime>Ot.DoubleClickDelay||E!==this._previousButtonPressed)&&(f.singleClick=!0,h(f,this._currentPickResult),_=!0);else{const R={evt:c,clickInfo:f,timeoutId:window.setTimeout(this._delayedSimpleClick.bind(this,E,f,h),Ot.DoubleClickDelay)};this._delayedClicks[E]=R}let b=o.hasSpecificMask(ge.POINTERDOUBLETAP)||l.hasSpecificMask(ge.POINTERDOUBLETAP);!b&&Fi.HasSpecificTrigger(6)&&(u=this._initActionManager(u,f),u&&(b=u.hasSpecificTrigger(6))),b&&(E===this._previousButtonPressed&&Date.now()-this._previousStartingPointerTime<Ot.DoubleClickDelay&&!this._doubleClickOccured?(!f.hasSwiped&&!this._isPointerSwiping()?(this._previousStartingPointerTime=0,this._doubleClickOccured=!0,f.doubleClick=!0,f.ignore=!1,Ot.ExclusiveDoubleClickMode&&this._delayedClicks[E]&&(clearTimeout((p=this._delayedClicks[E])==null?void 0:p.timeoutId),this._delayedClicks[E]=null),h(f,this._currentPickResult)):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=E,Ot.ExclusiveDoubleClickMode?(this._delayedClicks[E]&&(clearTimeout((g=this._delayedClicks[E])==null?void 0:g.timeoutId),this._delayedClicks[E]=null),h(f,this._previousPickResult)):h(f,this._currentPickResult)),_=!0):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=E))}}_||h(f,this._currentPickResult)},this._onPointerMove=o=>{if(this._updatePointerPosition(o),!this._isSwiping&&this._swipeButtonPressed!==-1&&(this._isSwiping=Math.abs(this._startingPointerPosition.x-this._pointerX)>Ot.DragMovementThreshold||Math.abs(this._startingPointerPosition.y-this._pointerY)>Ot.DragMovementThreshold),n.isPointerLock&&n._verifyPointerLock(),this._checkPrePointerObservable(null,o,o.inputIndex>=De.MouseWheelX&&o.inputIndex<=De.MouseWheelZ?ge.POINTERWHEEL:ge.POINTERMOVE)||!s.cameraToUseForPointers&&!s.activeCamera)return;if(s.skipPointerMovePicking){this._processPointerMove(new oi,o);return}s.pointerMovePredicate||(s.pointerMovePredicate=c=>c.isPickable&&c.isVisible&&c.isReady()&&c.isEnabled()&&(c.enablePointerMoveEvents||s.constantlyUpdateMeshUnderPointer||c._getActionManagerForTrigger()!==null)&&(!s.cameraToUseForPointers||(s.cameraToUseForPointers.layerMask&c.layerMask)!==0));const l=s._registeredActions>0||s.constantlyUpdateMeshUnderPointer?this._pickMove(o):null;this._processPointerMove(l,o)},this._onPointerDown=o=>{var h;const l=this._activePointerIds.indexOf(-1);if(l===-1?this._activePointerIds.push(o.pointerId):this._activePointerIds[l]=o.pointerId,this._activePointerIdsCount++,this._pickedDownMesh=null,this._meshPickProceed=!1,Ot.ExclusiveDoubleClickMode){for(let f=0;f<this._delayedClicks.length;f++)if(this._delayedClicks[f])if(o.button===f)clearTimeout((h=this._delayedClicks[f])==null?void 0:h.timeoutId);else{const u=this._delayedClicks[f].clickInfo;this._doubleClickOccured=!1,u.singleClick=!0,u.ignore=!1;const d=this._delayedClicks[f].evt,_=ge.POINTERTAP,p=new Xi(_,d,this._currentPickResult);s.onPointerObservable.hasObservers()&&s.onPointerObservable.hasSpecificMask(_)&&s.onPointerObservable.notifyObservers(p,_),this._delayedClicks[f]=null}}if(this._updatePointerPosition(o),this._swipeButtonPressed===-1&&(this._swipeButtonPressed=o.button),s.preventDefaultOnPointerDown&&r&&(o.preventDefault(),r.focus()),this._startingPointerPosition.x=this._pointerX,this._startingPointerPosition.y=this._pointerY,this._startingPointerTime=Date.now(),this._checkPrePointerObservable(null,o,ge.POINTERDOWN)||!s.cameraToUseForPointers&&!s.activeCamera)return;this._pointerCaptures[o.pointerId]=!0,s.pointerDownPredicate||(s.pointerDownPredicate=f=>f.isPickable&&f.isVisible&&f.isReady()&&f.isEnabled()&&(!s.cameraToUseForPointers||(s.cameraToUseForPointers.layerMask&f.layerMask)!==0)),this._pickedDownMesh=null;let c;s.skipPointerDownPicking||s._registeredActions===0&&!this._checkForPicking()&&!s.onPointerDown?c=new oi:c=s.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,s.pointerDownPredicate,s.pointerDownFastCheck,s.cameraToUseForPointers,s.pointerDownTrianglePredicate),this._processPointerDown(c,o)},this._onPointerUp=o=>{const l=this._activePointerIds.indexOf(o.pointerId);l!==-1&&(this._activePointerIds[l]=-1,this._activePointerIdsCount--,this._pickedUpMesh=null,this._meshPickProceed=!1,this._updatePointerPosition(o),s.preventDefaultOnPointerUp&&r&&(o.preventDefault(),r.focus()),this._initClickEvent(s.onPrePointerObservable,s.onPointerObservable,o,(c,h)=>{if(s.onPrePointerObservable.hasObservers()&&(this._skipPointerTap=!1,!c.ignore)){if(this._checkPrePointerObservable(null,o,ge.POINTERUP)){this._swipeButtonPressed===o.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1),o.buttons===0&&(this._pointerCaptures[o.pointerId]=!1);return}c.hasSwiped||(c.singleClick&&s.onPrePointerObservable.hasSpecificMask(ge.POINTERTAP)&&this._checkPrePointerObservable(null,o,ge.POINTERTAP)&&(this._skipPointerTap=!0),c.doubleClick&&s.onPrePointerObservable.hasSpecificMask(ge.POINTERDOUBLETAP)&&this._checkPrePointerObservable(null,o,ge.POINTERDOUBLETAP)&&(this._skipPointerTap=!0))}if(!this._pointerCaptures[o.pointerId]){this._swipeButtonPressed===o.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1);return}o.buttons===0&&(this._pointerCaptures[o.pointerId]=!1),!(!s.cameraToUseForPointers&&!s.activeCamera)&&(s.pointerUpPredicate||(s.pointerUpPredicate=f=>f.isPickable&&f.isVisible&&f.isReady()&&f.isEnabled()&&(!s.cameraToUseForPointers||(s.cameraToUseForPointers.layerMask&f.layerMask)!==0)),!this._meshPickProceed&&(Fi&&Fi.HasTriggers||this._checkForPicking()||s.onPointerUp)&&this._initActionManager(null,c),h||(h=this._currentPickResult),this._processPointerUp(h,o,c),this._previousPickResult=this._currentPickResult,this._swipeButtonPressed===o.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1))}))},this._onKeyDown=o=>{const l=Qs.KEYDOWN;if(s.onPreKeyboardObservable.hasObservers()){const c=new Oh(l,o);if(s.onPreKeyboardObservable.notifyObservers(c,l),c.skipOnKeyboardObservable)return}if(s.onKeyboardObservable.hasObservers()){const c=new ol(l,o);s.onKeyboardObservable.notifyObservers(c,l)}s.actionManager&&s.actionManager.processTrigger(14,qt.CreateNewFromScene(s,o))},this._onKeyUp=o=>{const l=Qs.KEYUP;if(s.onPreKeyboardObservable.hasObservers()){const c=new Oh(l,o);if(s.onPreKeyboardObservable.notifyObservers(c,l),c.skipOnKeyboardObservable)return}if(s.onKeyboardObservable.hasObservers()){const c=new ol(l,o);s.onKeyboardObservable.notifyObservers(c,l)}s.actionManager&&s.actionManager.processTrigger(15,qt.CreateNewFromScene(s,o))},this._deviceSourceManager.onDeviceConnectedObservable.add(o=>{o.deviceType===Te.Mouse?o.onInputChangedObservable.add(l=>{this._originMouseEvent=l,l.inputIndex===De.LeftClick||l.inputIndex===De.MiddleClick||l.inputIndex===De.RightClick||l.inputIndex===De.BrowserBack||l.inputIndex===De.BrowserForward?t&&o.getInput(l.inputIndex)===1?this._onPointerDown(l):e&&o.getInput(l.inputIndex)===0&&this._onPointerUp(l):i&&(l.inputIndex===De.Move?this._onPointerMove(l):(l.inputIndex===De.MouseWheelX||l.inputIndex===De.MouseWheelY||l.inputIndex===De.MouseWheelZ)&&this._onPointerMove(l))}):o.deviceType===Te.Touch?o.onInputChangedObservable.add(l=>{l.inputIndex===De.LeftClick&&(t&&o.getInput(l.inputIndex)===1?(this._onPointerDown(l),this._activePointerIdsCount>1&&(this._isMultiTouchGesture=!0)):e&&o.getInput(l.inputIndex)===0&&(this._onPointerUp(l),this._activePointerIdsCount===0&&(this._isMultiTouchGesture=!1))),i&&l.inputIndex===De.Move&&this._onPointerMove(l)}):o.deviceType===Te.Keyboard&&o.onInputChangedObservable.add(l=>{l.type==="keydown"?this._onKeyDown(l):l.type==="keyup"&&this._onKeyUp(l)})}),this._alreadyAttached=!0}detachControl(){this._alreadyAttached&&(this._deviceSourceManager.dispose(),this._deviceSourceManager=null,this._alreadyAttachedTo&&!this._scene.doNotHandleCursors&&(this._alreadyAttachedTo.style.cursor=this._scene.defaultCursor),this._alreadyAttached=!1,this._alreadyAttachedTo=null)}setPointerOverMesh(e,t=0,i,r){if(this._meshUnderPointerId[t]===e&&(!e||!e._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting))return;const s=this._meshUnderPointerId[t];let n;s&&(n=s._getActionManagerForTrigger(10),n&&n.processTrigger(10,new qt(s,this._pointerX,this._pointerY,e,r,{pointerId:t}))),e?(this._meshUnderPointerId[t]=e,this._pointerOverMesh=e,n=e._getActionManagerForTrigger(9),n&&n.processTrigger(9,new qt(e,this._pointerX,this._pointerY,e,r,{pointerId:t,pickResult:i}))):(delete this._meshUnderPointerId[t],this._pointerOverMesh=null),this._scene.onMeshUnderPointerUpdatedObservable.hasObservers()&&this._scene.onMeshUnderPointerUpdatedObservable.notifyObservers({mesh:e,pointerId:t})}getPointerOverMesh(){return this.meshUnderPointer}_invalidateMesh(e){this._pointerOverMesh===e&&(this._pointerOverMesh=null),this._pickedDownMesh===e&&(this._pickedDownMesh=null),this._pickedUpMesh===e&&(this._pickedUpMesh=null);for(const t in this._meshUnderPointerId)this._meshUnderPointerId[t]===e&&delete this._meshUnderPointerId[t]}}Ot.DragMovementThreshold=10;Ot.LongPressDelay=500;Ot.DoubleClickDelay=300;Ot.ExclusiveDoubleClickMode=!1;class ur{get min(){return this._min}get max(){return this._max}get average(){return this._average}get lastSecAverage(){return this._lastSecAverage}get current(){return this._current}get total(){return this._totalAccumulated}get count(){return this._totalValueCount}constructor(){this._startMonitoringTime=0,this._min=0,this._max=0,this._average=0,this._lastSecAverage=0,this._current=0,this._totalValueCount=0,this._totalAccumulated=0,this._lastSecAccumulated=0,this._lastSecTime=0,this._lastSecValueCount=0}fetchNewFrame(){this._totalValueCount++,this._current=0,this._lastSecValueCount++}addCount(e,t){ur.Enabled&&(this._current+=e,t&&this._fetchResult())}beginMonitoring(){ur.Enabled&&(this._startMonitoringTime=Ti.Now)}endMonitoring(e=!0){if(!ur.Enabled)return;e&&this.fetchNewFrame();const t=Ti.Now;this._current=t-this._startMonitoringTime,e&&this._fetchResult()}endFrame(){this._fetchResult()}_fetchResult(){this._totalAccumulated+=this._current,this._lastSecAccumulated+=this._current,this._min=Math.min(this._min,this._current),this._max=Math.max(this._max,this._current),this._average=this._totalAccumulated/this._totalValueCount;const e=Ti.Now;e-this._lastSecTime>1e3&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=e,this._lastSecAccumulated=0,this._lastSecValueCount=0)}}ur.Enabled=!0;class hi{constructor(e,t,i,r){this.normal=new m(e,t,i),this.d=r}asArray(){return[this.normal.x,this.normal.y,this.normal.z,this.d]}clone(){return new hi(this.normal.x,this.normal.y,this.normal.z,this.d)}getClassName(){return"Plane"}getHashCode(){let e=this.normal.getHashCode();return e=e*397^(this.d|0),e}normalize(){const e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z);let t=0;return e!==0&&(t=1/e),this.normal.x*=t,this.normal.y*=t,this.normal.z*=t,this.d*=t,this}transform(e){const t=hi._TmpMatrix;e.invertToRef(t);const i=t.m,r=this.normal.x,s=this.normal.y,n=this.normal.z,o=this.d,l=r*i[0]+s*i[1]+n*i[2]+o*i[3],c=r*i[4]+s*i[5]+n*i[6]+o*i[7],h=r*i[8]+s*i[9]+n*i[10]+o*i[11],f=r*i[12]+s*i[13]+n*i[14]+o*i[15];return new hi(l,c,h,f)}dotCoordinate(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d}copyFromPoints(e,t,i){const r=t.x-e.x,s=t.y-e.y,n=t.z-e.z,o=i.x-e.x,l=i.y-e.y,c=i.z-e.z,h=s*c-n*l,f=n*o-r*c,u=r*l-s*o,d=Math.sqrt(h*h+f*f+u*u);let _;return d!==0?_=1/d:_=0,this.normal.x=h*_,this.normal.y=f*_,this.normal.z=u*_,this.d=-(this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z),this}isFrontFacingTo(e,t){return m.Dot(this.normal,e)<=t}signedDistanceTo(e){return m.Dot(e,this.normal)+this.d}static FromArray(e){return new hi(e[0],e[1],e[2],e[3])}static FromPoints(e,t,i){const r=new hi(0,0,0,0);return r.copyFromPoints(e,t,i),r}static FromPositionAndNormal(e,t){const i=new hi(0,0,0,0);return this.FromPositionAndNormalToRef(e,t,i)}static FromPositionAndNormalToRef(e,t,i){return i.normal.copyFrom(t),i.normal.normalize(),i.d=-e.dot(i.normal),i}static SignedDistanceToPlaneFromPositionAndNormal(e,t,i){const r=-(t.x*e.x+t.y*e.y+t.z*e.z);return m.Dot(i,t)+r}}hi._TmpMatrix=P.Identity();class Li{static GetPlanes(e){const t=[];for(let i=0;i<6;i++)t.push(new hi(0,0,0,0));return Li.GetPlanesToRef(e,t),t}static GetNearPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[2],t.normal.y=i[7]+i[6],t.normal.z=i[11]+i[10],t.d=i[15]+i[14],t.normalize()}static GetFarPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[2],t.normal.y=i[7]-i[6],t.normal.z=i[11]-i[10],t.d=i[15]-i[14],t.normalize()}static GetLeftPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[0],t.normal.y=i[7]+i[4],t.normal.z=i[11]+i[8],t.d=i[15]+i[12],t.normalize()}static GetRightPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[0],t.normal.y=i[7]-i[4],t.normal.z=i[11]-i[8],t.d=i[15]-i[12],t.normalize()}static GetTopPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[1],t.normal.y=i[7]-i[5],t.normal.z=i[11]-i[9],t.d=i[15]-i[13],t.normalize()}static GetBottomPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[1],t.normal.y=i[7]+i[5],t.normal.z=i[11]+i[9],t.d=i[15]+i[13],t.normalize()}static GetPlanesToRef(e,t){Li.GetNearPlaneToRef(e,t[0]),Li.GetFarPlaneToRef(e,t[1]),Li.GetLeftPlaneToRef(e,t[2]),Li.GetRightPlaneToRef(e,t[3]),Li.GetTopPlaneToRef(e,t[4]),Li.GetBottomPlaneToRef(e,t[5])}static IsPointInFrustum(e,t){for(let i=0;i<6;i++)if(t[i].dotCoordinate(e)<0)return!1;return!0}}class Tc{static get UniqueId(){const e=this._UniqueIdCounter;return this._UniqueIdCounter++,e}}Tc._UniqueIdCounter=1;class it{static CompareLightsPriority(e,t){return e.shadowEnabled!==t.shadowEnabled?(t.shadowEnabled?1:0)-(e.shadowEnabled?1:0):t.renderPriority-e.renderPriority}}it.FALLOFF_DEFAULT=0;it.FALLOFF_PHYSICAL=1;it.FALLOFF_GLTF=2;it.FALLOFF_STANDARD=3;it.LIGHTMAP_DEFAULT=0;it.LIGHTMAP_SPECULAR=1;it.LIGHTMAP_SHADOWSONLY=2;it.INTENSITYMODE_AUTOMATIC=0;it.INTENSITYMODE_LUMINOUSPOWER=1;it.INTENSITYMODE_LUMINOUSINTENSITY=2;it.INTENSITYMODE_ILLUMINANCE=3;it.INTENSITYMODE_LUMINANCE=4;it.LIGHTTYPEID_POINTLIGHT=0;it.LIGHTTYPEID_DIRECTIONALLIGHT=1;it.LIGHTTYPEID_SPOTLIGHT=2;it.LIGHTTYPEID_HEMISPHERICLIGHT=3;it.LIGHTTYPEID_RECT_AREALIGHT=4;class nR{constructor(){this.pointerDownFastCheck=!1,this.pointerUpFastCheck=!1,this.pointerMoveFastCheck=!1,this.skipPointerMovePicking=!1,this.skipPointerDownPicking=!1,this.skipPointerUpPicking=!1}}var Wh;(function(a){a[a.BackwardCompatible=0]="BackwardCompatible",a[a.Intermediate=1]="Intermediate",a[a.Aggressive=2]="Aggressive"})(Wh||(Wh={}));class Ge{static DefaultMaterialFactory(e){throw Le("StandardMaterial")}static CollisionCoordinatorFactory(){throw Le("DefaultCollisionCoordinator")}get clearColor(){return this._clearColor}set clearColor(e){e!==this._clearColor&&(this._clearColor=e,this.onClearColorChangedObservable.notifyObservers(this._clearColor))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}get performancePriority(){return this._performancePriority}set performancePriority(e){if(e!==this._performancePriority){switch(this._performancePriority=e,e){case 0:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!1,this.autoClear=!0;break;case 1:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!0,this.autoClear=!1;break;case 2:this.skipFrustumClipping=!0,this._renderingManager.maintainStateBetweenFrames=!0,this.skipPointerMovePicking=!0,this.autoClear=!1;break}this.onScenePerformancePriorityChangedObservable.notifyObservers(e)}}set forceWireframe(e){this._forceWireframe!==e&&(this._forceWireframe=e,this.markAllMaterialsAsDirty(16))}get forceWireframe(){return this._forceWireframe}set skipFrustumClipping(e){this._skipFrustumClipping!==e&&(this._skipFrustumClipping=e)}get skipFrustumClipping(){return this._skipFrustumClipping}set forcePointsCloud(e){this._forcePointsCloud!==e&&(this._forcePointsCloud=e,this.markAllMaterialsAsDirty(16))}get forcePointsCloud(){return this._forcePointsCloud}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture!==e&&(this._environmentTexture=e,this.onEnvironmentTextureChangedObservable.notifyObservers(e),this.markAllMaterialsAsDirty(1))}getNodes(){let e=[];return e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes),this.skeletons.forEach(t=>e=e.concat(t.bones)),e}get animationPropertiesOverride(){return this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set beforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),e&&(this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e))}set afterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),e&&(this._onAfterRenderObserver=this.onAfterRenderObservable.add(e))}set beforeCameraRender(e){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(e)}set afterCameraRender(e){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(e)}get pointerDownPredicate(){return this._pointerPickingConfiguration.pointerDownPredicate}set pointerDownPredicate(e){this._pointerPickingConfiguration.pointerDownPredicate=e}get pointerUpPredicate(){return this._pointerPickingConfiguration.pointerUpPredicate}set pointerUpPredicate(e){this._pointerPickingConfiguration.pointerUpPredicate=e}get pointerMovePredicate(){return this._pointerPickingConfiguration.pointerMovePredicate}set pointerMovePredicate(e){this._pointerPickingConfiguration.pointerMovePredicate=e}get pointerDownFastCheck(){return this._pointerPickingConfiguration.pointerDownFastCheck}set pointerDownFastCheck(e){this._pointerPickingConfiguration.pointerDownFastCheck=e}get pointerUpFastCheck(){return this._pointerPickingConfiguration.pointerUpFastCheck}set pointerUpFastCheck(e){this._pointerPickingConfiguration.pointerUpFastCheck=e}get pointerMoveFastCheck(){return this._pointerPickingConfiguration.pointerMoveFastCheck}set pointerMoveFastCheck(e){this._pointerPickingConfiguration.pointerMoveFastCheck=e}get skipPointerMovePicking(){return this._pointerPickingConfiguration.skipPointerMovePicking}set skipPointerMovePicking(e){this._pointerPickingConfiguration.skipPointerMovePicking=e}get skipPointerDownPicking(){return this._pointerPickingConfiguration.skipPointerDownPicking}set skipPointerDownPicking(e){this._pointerPickingConfiguration.skipPointerDownPicking=e}get skipPointerUpPicking(){return this._pointerPickingConfiguration.skipPointerUpPicking}set skipPointerUpPicking(e){this._pointerPickingConfiguration.skipPointerUpPicking=e}get unTranslatedPointer(){return this._inputManager.unTranslatedPointer}static get DragMovementThreshold(){return Ot.DragMovementThreshold}static set DragMovementThreshold(e){Ot.DragMovementThreshold=e}static get LongPressDelay(){return Ot.LongPressDelay}static set LongPressDelay(e){Ot.LongPressDelay=e}static get DoubleClickDelay(){return Ot.DoubleClickDelay}static set DoubleClickDelay(e){Ot.DoubleClickDelay=e}static get ExclusiveDoubleClickMode(){return Ot.ExclusiveDoubleClickMode}static set ExclusiveDoubleClickMode(e){Ot.ExclusiveDoubleClickMode=e}bindEyePosition(e,t="vEyePosition",i=!1){var n;const r=this._forcedViewPosition?this._forcedViewPosition:this._mirroredCameraPosition?this._mirroredCameraPosition:((n=this.activeCamera)==null?void 0:n.globalPosition)??m.ZeroReadOnly,s=this.useRightHandedSystem===(this._mirroredCameraPosition!=null);return F.Vector4[0].set(r.x,r.y,r.z,s?-1:1),e&&(i?e.setFloat3(t,F.Vector4[0].x,F.Vector4[0].y,F.Vector4[0].z):e.setVector4(t,F.Vector4[0])),F.Vector4[0]}finalizeSceneUbo(){const e=this.getSceneUniformBuffer(),t=this.bindEyePosition(null);return e.updateFloat4("vEyePosition",t.x,t.y,t.z,t.w),e.update(),e}set useRightHandedSystem(e){this._useRightHandedSystem!==e&&(this._useRightHandedSystem=e,this.markAllMaterialsAsDirty(16))}get useRightHandedSystem(){return this._useRightHandedSystem}setStepId(e){this._currentStepId=e}getStepId(){return this._currentStepId}getInternalStep(){return this._currentInternalStep}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAllMaterialsAsDirty(16))}get fogEnabled(){return this._fogEnabled}set fogMode(e){this._fogMode!==e&&(this._fogMode=e,this.markAllMaterialsAsDirty(16))}get fogMode(){return this._fogMode}get prePass(){return!!this.prePassRenderer&&this.prePassRenderer.defaultRT.enabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this.markAllMaterialsAsDirty(2))}get shadowsEnabled(){return this._shadowsEnabled}set lightsEnabled(e){this._lightsEnabled!==e&&(this._lightsEnabled=e,this.markAllMaterialsAsDirty(2))}get lightsEnabled(){return this._lightsEnabled}get activeCameras(){return this._activeCameras}set activeCameras(e){this._unObserveActiveCameras&&(this._unObserveActiveCameras(),this._unObserveActiveCameras=null),e&&(this._unObserveActiveCameras=Am(e,()=>{this.onActiveCamerasChanged.notifyObservers(this)})),this._activeCameras=e}get activeCamera(){return this._activeCamera}set activeCamera(e){e!==this._activeCamera&&(this._activeCamera=e,this.onActiveCameraChanged.notifyObservers(this))}get _hasDefaultMaterial(){return Ge.DefaultMaterialFactory!==Ge._OriginalDefaultMaterialFactory}get defaultMaterial(){return this._defaultMaterial||(this._defaultMaterial=Ge.DefaultMaterialFactory(this)),this._defaultMaterial}set defaultMaterial(e){this._defaultMaterial=e}set texturesEnabled(e){this._texturesEnabled!==e&&(this._texturesEnabled=e,this.markAllMaterialsAsDirty(1))}get texturesEnabled(){return this._texturesEnabled}get frameGraph(){return this._frameGraph}set frameGraph(e){if(this._frameGraph){this._frameGraph=e,e||(this.customRenderFunction=this._currentCustomRenderFunction);return}this._frameGraph=e,e&&(this._currentCustomRenderFunction=this.customRenderFunction,this.customRenderFunction=this._renderWithFrameGraph)}set skeletonsEnabled(e){this._skeletonsEnabled!==e&&(this._skeletonsEnabled=e,this.markAllMaterialsAsDirty(8))}get skeletonsEnabled(){return this._skeletonsEnabled}get collisionCoordinator(){return this._collisionCoordinator||(this._collisionCoordinator=Ge.CollisionCoordinatorFactory(),this._collisionCoordinator.init(this)),this._collisionCoordinator}get renderingManager(){return this._renderingManager}get frustumPlanes(){return this._frustumPlanes}_registerTransientComponents(){if(this._transientComponents.length>0){for(const e of this._transientComponents)e.register();this._transientComponents.length=0}}_addComponent(e){this._components.push(e),this._transientComponents.push(e);const t=e;t.addFromContainer&&t.serialize&&this._serializableComponents.push(t)}_getComponent(e){for(const t of this._components)if(t.name===e)return t;return null}constructor(e,t){this._inputManager=new Ot(this),this.cameraToUseForPointers=null,this._isScene=!0,this._blockEntityCollection=!1,this.autoClear=!0,this.autoClearDepthAndStencil=!0,this._clearColor=new Ne(.2,.2,.3,1),this.onClearColorChangedObservable=new U,this.ambientColor=new ae(0,0,0),this.environmentIntensity=1,this.iblIntensity=1,this._performancePriority=0,this.onScenePerformancePriorityChangedObservable=new U,this._forceWireframe=!1,this._skipFrustumClipping=!1,this._forcePointsCloud=!1,this.rootNodes=[],this.cameras=[],this.lights=[],this.meshes=[],this.skeletons=[],this.particleSystems=[],this.animations=[],this.animationGroups=[],this.multiMaterials=[],this.materials=[],this.morphTargetManagers=[],this.geometries=[],this.transformNodes=[],this.actionManagers=[],this.textures=[],this._environmentTexture=null,this.postProcesses=[],this.effectLayers=[],this.sounds=null,this.layers=[],this.lensFlareSystems=[],this.proceduralTextures=[],this.animationsEnabled=!0,this._animationPropertiesOverride=null,this.useConstantAnimationDeltaTime=!1,this.constantlyUpdateMeshUnderPointer=!1,this.hoverCursor="pointer",this.defaultCursor="",this.doNotHandleCursors=!1,this.preventDefaultOnPointerDown=!0,this.preventDefaultOnPointerUp=!0,this.metadata=null,this.reservedDataStore=null,this.disableOfflineSupportExceptionRules=[],this.onDisposeObservable=new U,this._onDisposeObserver=null,this.onBeforeRenderObservable=new U,this._onBeforeRenderObserver=null,this.onAfterRenderObservable=new U,this.onAfterRenderCameraObservable=new U,this._onAfterRenderObserver=null,this.onBeforeAnimationsObservable=new U,this.onAfterAnimationsObservable=new U,this.onBeforeDrawPhaseObservable=new U,this.onAfterDrawPhaseObservable=new U,this.onReadyObservable=new U,this.onBeforeCameraRenderObservable=new U,this._onBeforeCameraRenderObserver=null,this.onAfterCameraRenderObservable=new U,this._onAfterCameraRenderObserver=null,this.onBeforeActiveMeshesEvaluationObservable=new U,this.onAfterActiveMeshesEvaluationObservable=new U,this.onBeforeParticlesRenderingObservable=new U,this.onAfterParticlesRenderingObservable=new U,this.onDataLoadedObservable=new U,this.onNewCameraAddedObservable=new U,this.onCameraRemovedObservable=new U,this.onNewLightAddedObservable=new U,this.onLightRemovedObservable=new U,this.onNewGeometryAddedObservable=new U,this.onGeometryRemovedObservable=new U,this.onNewTransformNodeAddedObservable=new U,this.onTransformNodeRemovedObservable=new U,this.onNewMeshAddedObservable=new U,this.onMeshRemovedObservable=new U,this.onNewSkeletonAddedObservable=new U,this.onSkeletonRemovedObservable=new U,this.onNewMaterialAddedObservable=new U,this.onNewMultiMaterialAddedObservable=new U,this.onMaterialRemovedObservable=new U,this.onMultiMaterialRemovedObservable=new U,this.onNewTextureAddedObservable=new U,this.onTextureRemovedObservable=new U,this.onBeforeRenderTargetsRenderObservable=new U,this.onAfterRenderTargetsRenderObservable=new U,this.onBeforeStepObservable=new U,this.onAfterStepObservable=new U,this.onActiveCameraChanged=new U,this.onActiveCamerasChanged=new U,this.onBeforeRenderingGroupObservable=new U,this.onAfterRenderingGroupObservable=new U,this.onMeshImportedObservable=new U,this.onAnimationFileImportedObservable=new U,this.onEnvironmentTextureChangedObservable=new U,this.onMeshUnderPointerUpdatedObservable=new U,this._registeredForLateAnimationBindings=new hs(256),this._pointerPickingConfiguration=new nR,this.onPrePointerObservable=new U,this.onPointerObservable=new U,this.onPreKeyboardObservable=new U,this.onKeyboardObservable=new U,this._useRightHandedSystem=!1,this._timeAccumulator=0,this._currentStepId=0,this._currentInternalStep=0,this._fogEnabled=!0,this._fogMode=Ge.FOGMODE_NONE,this.fogColor=new ae(.2,.2,.3),this.fogDensity=.1,this.fogStart=0,this.fogEnd=1e3,this.needsPreviousWorldMatrices=!1,this._shadowsEnabled=!0,this._lightsEnabled=!0,this._unObserveActiveCameras=null,this._texturesEnabled=!0,this._frameGraph=null,this.frameGraphs=[],this.physicsEnabled=!0,this.particlesEnabled=!0,this.spritesEnabled=!0,this._skeletonsEnabled=!0,this.lensFlaresEnabled=!0,this.collisionsEnabled=!0,this.gravity=new m(0,-9.807,0),this.postProcessesEnabled=!0,this.renderTargetsEnabled=!0,this.dumpNextRenderTargets=!1,this.customRenderTargets=[],this.importedMeshesFiles=[],this.probesEnabled=!0,this._meshesForIntersections=new hs(256),this.proceduralTexturesEnabled=!0,this._totalVertices=new ur,this._activeIndices=new ur,this._activeParticles=new ur,this._activeBones=new ur,this._animationTime=0,this.animationTimeScale=1,this._renderId=0,this._frameId=0,this._executeWhenReadyTimeoutId=null,this._intermediateRendering=!1,this._defaultFrameBufferCleared=!1,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1,this._toBeDisposed=new Array(256),this._activeRequests=new Array,this._pendingData=new Array,this._isDisposed=!1,this.dispatchAllSubMeshesOfActiveMeshes=!1,this._activeMeshes=new jt(256),this._processedMaterials=new jt(256),this._renderTargets=new hs(256),this._materialsRenderTargets=new hs(256),this._activeParticleSystems=new jt(256),this._activeSkeletons=new hs(32),this._softwareSkinnedMeshes=new hs(32),this._activeAnimatables=new Array,this._transformMatrix=P.Zero(),this.requireLightSorting=!1,this._components=[],this._serializableComponents=[],this._transientComponents=[],this._beforeCameraUpdateStage=Pt.Create(),this._beforeClearStage=Pt.Create(),this._beforeRenderTargetClearStage=Pt.Create(),this._gatherRenderTargetsStage=Pt.Create(),this._gatherActiveCameraRenderTargetsStage=Pt.Create(),this._isReadyForMeshStage=Pt.Create(),this._beforeEvaluateActiveMeshStage=Pt.Create(),this._evaluateSubMeshStage=Pt.Create(),this._preActiveMeshStage=Pt.Create(),this._cameraDrawRenderTargetStage=Pt.Create(),this._beforeCameraDrawStage=Pt.Create(),this._beforeRenderTargetDrawStage=Pt.Create(),this._beforeRenderingGroupDrawStage=Pt.Create(),this._beforeRenderingMeshStage=Pt.Create(),this._afterRenderingMeshStage=Pt.Create(),this._afterRenderingGroupDrawStage=Pt.Create(),this._afterCameraDrawStage=Pt.Create(),this._afterCameraPostProcessStage=Pt.Create(),this._afterRenderTargetDrawStage=Pt.Create(),this._afterRenderTargetPostProcessStage=Pt.Create(),this._afterRenderStage=Pt.Create(),this._pointerMoveStage=Pt.Create(),this._pointerDownStage=Pt.Create(),this._pointerUpStage=Pt.Create(),this._geometriesByUniqueId=null,this._defaultMeshCandidates={data:[],length:0},this._defaultSubMeshCandidates={data:[],length:0},this._preventFreeActiveMeshesAndRenderingGroups=!1,this._activeMeshesFrozen=!1,this._activeMeshesFrozenButKeepClipping=!1,this._skipEvaluateActiveMeshesCompletely=!1,this._useCurrentFrameBuffer=!1,this._allowPostProcessClearColor=!0,this.getDeterministicFrameTime=()=>this._engine.getTimeStep(),this._registeredActions=0,this._blockMaterialDirtyMechanism=!1,this._perfCollector=null,this.activeCameras=[];const i={useGeometryUniqueIdsMap:!0,useMaterialMeshMap:!0,useClonedMeshMap:!0,virtual:!1,...t};e=this._engine=e||Re.LastCreatedEngine,i.virtual?e._virtualScenes.push(this):(Re._LastCreatedScene=this,e.scenes.push(this)),this._uid=null,this._renderingManager=new ii(this),al&&(this.postProcessManager=new al(this)),Ht()&&this.attachControl(),this._createUbo(),ze&&(this._imageProcessingConfiguration=new ze),this.setDefaultCandidateProviders(),i.useGeometryUniqueIdsMap&&(this._geometriesByUniqueId={}),this.useMaterialMeshMap=i.useMaterialMeshMap,this.useClonedMeshMap=i.useClonedMeshMap,(!t||!t.virtual)&&e.onNewSceneAddedObservable.notifyObservers(this)}getClassName(){return"Scene"}_getDefaultMeshCandidates(){return this._defaultMeshCandidates.data=this.meshes,this._defaultMeshCandidates.length=this.meshes.length,this._defaultMeshCandidates}_getDefaultSubMeshCandidates(e){return this._defaultSubMeshCandidates.data=e.subMeshes,this._defaultSubMeshCandidates.length=e.subMeshes.length,this._defaultSubMeshCandidates}setDefaultCandidateProviders(){this.getActiveMeshCandidates=()=>this._getDefaultMeshCandidates(),this.getActiveSubMeshCandidates=e=>this._getDefaultSubMeshCandidates(e),this.getIntersectingSubMeshCandidates=(e,t)=>this._getDefaultSubMeshCandidates(e),this.getCollidingSubMeshCandidates=(e,t)=>this._getDefaultSubMeshCandidates(e)}get meshUnderPointer(){return this._inputManager.meshUnderPointer}get pointerX(){return this._inputManager.pointerX}set pointerX(e){this._inputManager.pointerX=e}get pointerY(){return this._inputManager.pointerY}set pointerY(e){this._inputManager.pointerY=e}getCachedMaterial(){return this._cachedMaterial}getCachedEffect(){return this._cachedEffect}getCachedVisibility(){return this._cachedVisibility}isCachedMaterialInvalid(e,t,i=1){return this._cachedEffect!==t||this._cachedMaterial!==e||this._cachedVisibility!==i}getEngine(){return this._engine}getTotalVertices(){return this._totalVertices.current}get totalVerticesPerfCounter(){return this._totalVertices}getActiveIndices(){return this._activeIndices.current}get totalActiveIndicesPerfCounter(){return this._activeIndices}getActiveParticles(){return this._activeParticles.current}get activeParticlesPerfCounter(){return this._activeParticles}getActiveBones(){return this._activeBones.current}get activeBonesPerfCounter(){return this._activeBones}getActiveMeshes(){return this._activeMeshes}getAnimationRatio(){return this._animationRatio!==void 0?this._animationRatio:1}getRenderId(){return this._renderId}getFrameId(){return this._frameId}incrementRenderId(){this._renderId++}_createUbo(){this.setSceneUniformBuffer(this.createSceneUniformBuffer())}simulatePointerMove(e,t){return this._inputManager.simulatePointerMove(e,t),this}simulatePointerDown(e,t){return this._inputManager.simulatePointerDown(e,t),this}simulatePointerUp(e,t,i){return this._inputManager.simulatePointerUp(e,t,i),this}isPointerCaptured(e=0){return this._inputManager.isPointerCaptured(e)}attachControl(e=!0,t=!0,i=!0){this._inputManager.attachControl(e,t,i)}detachControl(){this._inputManager.detachControl()}isReady(e=!0){var n,o;if(this._isDisposed)return!1;let t;const i=this.getEngine(),r=i.currentRenderPassId;i.currentRenderPassId=((n=this.activeCamera)==null?void 0:n.renderPassId)??r;let s=!0;for(this._pendingData.length>0&&(s=!1),(o=this.prePassRenderer)==null||o.update(),this.useOrderIndependentTransparency&&this.depthPeelingRenderer&&s&&(s=this.depthPeelingRenderer.isReady()),e&&(this._processedMaterials.reset(),this._materialsRenderTargets.reset()),t=0;t<this.meshes.length;t++){const l=this.meshes[t];if(!l.subMeshes||l.subMeshes.length===0)continue;if(!l.isReady(!0)){s=!1;continue}const c=l.hasThinInstances||l.getClassName()==="InstancedMesh"||l.getClassName()==="InstancedLinesMesh"||i.getCaps().instancedArrays&&l.instances.length>0;for(const f of this._isReadyForMeshStage)f.action(l,c)||(s=!1);if(!e)continue;const h=l.material||this.defaultMaterial;if(h)if(h._storeEffectOnSubMeshes)for(const f of l.subMeshes){const u=f.getMaterial();u&&u.hasRenderTargetTextures&&u.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(u)===-1&&(this._processedMaterials.push(u),this._materialsRenderTargets.concatWithNoDuplicate(u.getRenderTargetTextures()))}else h.hasRenderTargetTextures&&h.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(h)===-1&&(this._processedMaterials.push(h),this._materialsRenderTargets.concatWithNoDuplicate(h.getRenderTargetTextures()))}if(e)for(t=0;t<this._materialsRenderTargets.length;++t)this._materialsRenderTargets.data[t].isReadyForRendering()||(s=!1);for(t=0;t<this.geometries.length;t++)this.geometries[t].delayLoadState===2&&(s=!1);if(this.activeCameras&&this.activeCameras.length>0)for(const l of this.activeCameras)l.isReady(!0)||(s=!1);else this.activeCamera&&(this.activeCamera.isReady(!0)||(s=!1));for(const l of this.particleSystems)l.isReady()||(s=!1);if(this.layers)for(const l of this.layers)l.isReady()||(s=!1);if(this.effectLayers)for(const l of this.effectLayers)l.isLayerReady()||(s=!1);return i.areAllEffectsReady()||(s=!1),i.currentRenderPassId=r,s}resetCachedMaterial(){this._cachedMaterial=null,this._cachedEffect=null,this._cachedVisibility=null}registerBeforeRender(e){this.onBeforeRenderObservable.add(e)}unregisterBeforeRender(e){this.onBeforeRenderObservable.removeCallback(e)}registerAfterRender(e){this.onAfterRenderObservable.add(e)}unregisterAfterRender(e){this.onAfterRenderObservable.removeCallback(e)}_executeOnceBeforeRender(e){const t=()=>{e(),setTimeout(()=>{this.unregisterBeforeRender(t)})};this.registerBeforeRender(t)}executeOnceBeforeRender(e,t){t!==void 0?setTimeout(()=>{this._executeOnceBeforeRender(e)},t):this._executeOnceBeforeRender(e)}addPendingData(e){this._pendingData.push(e)}removePendingData(e){const t=this.isLoading,i=this._pendingData.indexOf(e);i!==-1&&this._pendingData.splice(i,1),t&&!this.isLoading&&this.onDataLoadedObservable.notifyObservers(this)}getWaitingItemsCount(){return this._pendingData.length}get isLoading(){return this._pendingData.length>0}executeWhenReady(e,t=!1){this.onReadyObservable.addOnce(e),this._executeWhenReadyTimeoutId===null&&this._checkIsReady(t)}whenReadyAsync(e=!1){return new Promise(t=>{this.executeWhenReady(()=>{t()},e)})}_checkIsReady(e=!1){if(this._registerTransientComponents(),this.isReady(e)){this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}if(this._isDisposed){this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}this._executeWhenReadyTimeoutId=setTimeout(()=>{this.incrementRenderId(),this._checkIsReady(e)},100)}get animatables(){return this._activeAnimatables}resetLastAnimationTimeFrame(){this._animationTimeLast=Ti.Now}getViewMatrix(){return this._viewMatrix}getProjectionMatrix(){return this._projectionMatrix}getTransformMatrix(){return this._transformMatrix}setTransformMatrix(e,t,i,r){!i&&!r&&this._multiviewSceneUbo&&(this._multiviewSceneUbo.dispose(),this._multiviewSceneUbo=null),!(this._viewUpdateFlag===e.updateFlag&&this._projectionUpdateFlag===t.updateFlag)&&(this._viewUpdateFlag=e.updateFlag,this._projectionUpdateFlag=t.updateFlag,this._viewMatrix=e,this._projectionMatrix=t,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._frustumPlanes?Li.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=Li.GetPlanes(this._transformMatrix),this._multiviewSceneUbo&&this._multiviewSceneUbo.useUbo?this._updateMultiviewUbo(i,r):this._sceneUbo.useUbo&&(this._sceneUbo.updateMatrix("viewProjection",this._transformMatrix),this._sceneUbo.updateMatrix("view",this._viewMatrix),this._sceneUbo.updateMatrix("projection",this._projectionMatrix)))}getSceneUniformBuffer(){return this._multiviewSceneUbo?this._multiviewSceneUbo:this._sceneUbo}createSceneUniformBuffer(e){const t=new _e(this._engine,void 0,!1,e??"scene");return t.addUniform("viewProjection",16),t.addUniform("view",16),t.addUniform("projection",16),t.addUniform("vEyePosition",4),t}setSceneUniformBuffer(e){this._sceneUbo=e,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1}getUniqueId(){return Tc.UniqueId}addMesh(e,t=!1){this._blockEntityCollection||(this.meshes.push(e),e._resyncLightSources(),e.parent||e._addToSceneRootNodes(),k.SetImmediate(()=>{this.onNewMeshAddedObservable.notifyObservers(e)}),t&&e.getChildMeshes().forEach(i=>{this.addMesh(i)}))}removeMesh(e,t=!1){const i=this.meshes.indexOf(e);return i!==-1&&(this.meshes.splice(i,1),e.parent||e._removeFromSceneRootNodes()),this._inputManager._invalidateMesh(e),this.onMeshRemovedObservable.notifyObservers(e),t&&e.getChildMeshes().forEach(r=>{this.removeMesh(r)}),i}addTransformNode(e){this._blockEntityCollection||e.getScene()===this&&e._indexInSceneTransformNodesArray!==-1||(e._indexInSceneTransformNodesArray=this.transformNodes.length,this.transformNodes.push(e),e.parent||e._addToSceneRootNodes(),this.onNewTransformNodeAddedObservable.notifyObservers(e))}removeTransformNode(e){const t=e._indexInSceneTransformNodesArray;if(t!==-1){if(t!==this.transformNodes.length-1){const i=this.transformNodes[this.transformNodes.length-1];this.transformNodes[t]=i,i._indexInSceneTransformNodesArray=t}e._indexInSceneTransformNodesArray=-1,this.transformNodes.pop(),e.parent||e._removeFromSceneRootNodes()}return this.onTransformNodeRemovedObservable.notifyObservers(e),t}removeSkeleton(e){const t=this.skeletons.indexOf(e);return t!==-1&&(this.skeletons.splice(t,1),this.onSkeletonRemovedObservable.notifyObservers(e),this._executeActiveContainerCleanup(this._activeSkeletons)),t}removeMorphTargetManager(e){const t=this.morphTargetManagers.indexOf(e);return t!==-1&&this.morphTargetManagers.splice(t,1),t}removeLight(e){const t=this.lights.indexOf(e);if(t!==-1){for(const i of this.meshes)i._removeLightSource(e,!1);this.lights.splice(t,1),this.sortLightsByPriority(),e.parent||e._removeFromSceneRootNodes()}return this.onLightRemovedObservable.notifyObservers(e),t}removeCamera(e){const t=this.cameras.indexOf(e);if(t!==-1&&(this.cameras.splice(t,1),e.parent||e._removeFromSceneRootNodes()),this.activeCameras){const i=this.activeCameras.indexOf(e);i!==-1&&this.activeCameras.splice(i,1)}return this.activeCamera===e&&(this.cameras.length>0?this.activeCamera=this.cameras[0]:this.activeCamera=null),this.onCameraRemovedObservable.notifyObservers(e),t}removeParticleSystem(e){const t=this.particleSystems.indexOf(e);return t!==-1&&(this.particleSystems.splice(t,1),this._executeActiveContainerCleanup(this._activeParticleSystems)),t}removeAnimation(e){const t=this.animations.indexOf(e);return t!==-1&&this.animations.splice(t,1),t}stopAnimation(e,t,i){}removeAnimationGroup(e){const t=this.animationGroups.indexOf(e);return t!==-1&&this.animationGroups.splice(t,1),t}removeMultiMaterial(e){const t=this.multiMaterials.indexOf(e);return t!==-1&&this.multiMaterials.splice(t,1),this.onMultiMaterialRemovedObservable.notifyObservers(e),t}removeMaterial(e){const t=e._indexInSceneMaterialArray;if(t!==-1&&t<this.materials.length){if(t!==this.materials.length-1){const i=this.materials[this.materials.length-1];this.materials[t]=i,i._indexInSceneMaterialArray=t}e._indexInSceneMaterialArray=-1,this.materials.pop()}return this.onMaterialRemovedObservable.notifyObservers(e),t}removeActionManager(e){const t=this.actionManagers.indexOf(e);return t!==-1&&this.actionManagers.splice(t,1),t}removeTexture(e){const t=this.textures.indexOf(e);return t!==-1&&this.textures.splice(t,1),this.onTextureRemovedObservable.notifyObservers(e),t}addLight(e){if(!this._blockEntityCollection){this.lights.push(e),this.sortLightsByPriority(),e.parent||e._addToSceneRootNodes();for(const t of this.meshes)t.lightSources.indexOf(e)===-1&&(t.lightSources.push(e),t._resyncLightSources());k.SetImmediate(()=>{this.onNewLightAddedObservable.notifyObservers(e)})}}sortLightsByPriority(){this.requireLightSorting&&this.lights.sort(it.CompareLightsPriority)}addCamera(e){this._blockEntityCollection||(this.cameras.push(e),k.SetImmediate(()=>{this.onNewCameraAddedObservable.notifyObservers(e)}),e.parent||e._addToSceneRootNodes())}addSkeleton(e){this._blockEntityCollection||(this.skeletons.push(e),k.SetImmediate(()=>{this.onNewSkeletonAddedObservable.notifyObservers(e)}))}addParticleSystem(e){this._blockEntityCollection||this.particleSystems.push(e)}addAnimation(e){this._blockEntityCollection||this.animations.push(e)}addAnimationGroup(e){this._blockEntityCollection||this.animationGroups.push(e)}addMultiMaterial(e){this._blockEntityCollection||(this.multiMaterials.push(e),k.SetImmediate(()=>{this.onNewMultiMaterialAddedObservable.notifyObservers(e)}))}addMaterial(e){this._blockEntityCollection||e.getScene()===this&&e._indexInSceneMaterialArray!==-1||(e._indexInSceneMaterialArray=this.materials.length,this.materials.push(e),k.SetImmediate(()=>{this.onNewMaterialAddedObservable.notifyObservers(e)}))}addMorphTargetManager(e){this._blockEntityCollection||this.morphTargetManagers.push(e)}addGeometry(e){this._blockEntityCollection||(this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=this.geometries.length),this.geometries.push(e))}addActionManager(e){this.actionManagers.push(e)}addTexture(e){this._blockEntityCollection||(this.textures.push(e),this.onNewTextureAddedObservable.notifyObservers(e))}switchActiveCamera(e,t=!0){this._engine.getInputElement()&&(this.activeCamera&&this.activeCamera.detachControl(),this.activeCamera=e,t&&e.attachControl())}setActiveCameraById(e){const t=this.getCameraById(e);return t?(this.activeCamera=t,t):null}setActiveCameraByName(e){const t=this.getCameraByName(e);return t?(this.activeCamera=t,t):null}getAnimationGroupByName(e){for(let t=0;t<this.animationGroups.length;t++)if(this.animationGroups[t].name===e)return this.animationGroups[t];return null}_getMaterial(e,t){for(let i=0;i<this.materials.length;i++){const r=this.materials[i];if(t(r))return r}if(e)for(let i=0;i<this.multiMaterials.length;i++){const r=this.multiMaterials[i];if(t(r))return r}return null}getMaterialByUniqueID(e,t=!1){return this._getMaterial(t,i=>i.uniqueId===e)}getMaterialById(e,t=!1){return this._getMaterial(t,i=>i.id===e)}getMaterialByName(e,t=!1){return this._getMaterial(t,i=>i.name===e)}getLastMaterialById(e,t=!1){for(let i=this.materials.length-1;i>=0;i--)if(this.materials[i].id===e)return this.materials[i];if(t){for(let i=this.multiMaterials.length-1;i>=0;i--)if(this.multiMaterials[i].id===e)return this.multiMaterials[i]}return null}getTextureByUniqueId(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].uniqueId===e)return this.textures[t];return null}getTextureByName(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].name===e)return this.textures[t];return null}getCameraById(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].id===e)return this.cameras[t];return null}getCameraByUniqueId(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].uniqueId===e)return this.cameras[t];return null}getCameraByName(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].name===e)return this.cameras[t];return null}getBoneById(e){for(let t=0;t<this.skeletons.length;t++){const i=this.skeletons[t];for(let r=0;r<i.bones.length;r++)if(i.bones[r].id===e)return i.bones[r]}return null}getBoneByName(e){for(let t=0;t<this.skeletons.length;t++){const i=this.skeletons[t];for(let r=0;r<i.bones.length;r++)if(i.bones[r].name===e)return i.bones[r]}return null}getLightByName(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].name===e)return this.lights[t];return null}getLightById(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].id===e)return this.lights[t];return null}getLightByUniqueId(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].uniqueId===e)return this.lights[t];return null}getParticleSystemById(e){for(let t=0;t<this.particleSystems.length;t++)if(this.particleSystems[t].id===e)return this.particleSystems[t];return null}getGeometryById(e){for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].id===e)return this.geometries[t];return null}_getGeometryByUniqueId(e){if(this._geometriesByUniqueId){const t=this._geometriesByUniqueId[e];if(t!==void 0)return this.geometries[t]}else for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].uniqueId===e)return this.geometries[t];return null}getFrameGraphByName(e){for(let t=0;t<this.frameGraphs.length;t++)if(this.frameGraphs[t].name===e)return this.frameGraphs[t];return null}pushGeometry(e,t){return!t&&this._getGeometryByUniqueId(e.uniqueId)?!1:(this.addGeometry(e),k.SetImmediate(()=>{this.onNewGeometryAddedObservable.notifyObservers(e)}),!0)}removeGeometry(e){let t;if(this._geometriesByUniqueId){if(t=this._geometriesByUniqueId[e.uniqueId],t===void 0)return!1}else if(t=this.geometries.indexOf(e),t<0)return!1;if(t!==this.geometries.length-1){const i=this.geometries[this.geometries.length-1];i&&(this.geometries[t]=i,this._geometriesByUniqueId&&(this._geometriesByUniqueId[i.uniqueId]=t))}return this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=void 0),this.geometries.pop(),this.onGeometryRemovedObservable.notifyObservers(e),!0}getGeometries(){return this.geometries}getMeshById(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].id===e)return this.meshes[t];return null}getMeshesById(e){return this.meshes.filter(function(t){return t.id===e})}getTransformNodeById(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getTransformNodeByUniqueId(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].uniqueId===e)return this.transformNodes[t];return null}getTransformNodesById(e){return this.transformNodes.filter(function(t){return t.id===e})}getMeshByUniqueId(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].uniqueId===e)return this.meshes[t];return null}getLastMeshById(e){for(let t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];return null}getLastTransformNodeById(e){for(let t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getLastEntryById(e){let t;for(t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];for(t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];for(t=this.cameras.length-1;t>=0;t--)if(this.cameras[t].id===e)return this.cameras[t];for(t=this.lights.length-1;t>=0;t--)if(this.lights[t].id===e)return this.lights[t];return null}getNodeById(e){const t=this.getMeshById(e);if(t)return t;const i=this.getTransformNodeById(e);if(i)return i;const r=this.getLightById(e);if(r)return r;const s=this.getCameraById(e);if(s)return s;const n=this.getBoneById(e);return n||null}getNodeByName(e){const t=this.getMeshByName(e);if(t)return t;const i=this.getTransformNodeByName(e);if(i)return i;const r=this.getLightByName(e);if(r)return r;const s=this.getCameraByName(e);if(s)return s;const n=this.getBoneByName(e);return n||null}getMeshByName(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].name===e)return this.meshes[t];return null}getTransformNodeByName(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].name===e)return this.transformNodes[t];return null}getLastSkeletonById(e){for(let t=this.skeletons.length-1;t>=0;t--)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByUniqueId(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].uniqueId===e)return this.skeletons[t];return null}getSkeletonById(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByName(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].name===e)return this.skeletons[t];return null}getMorphTargetManagerById(e){for(let t=0;t<this.morphTargetManagers.length;t++)if(this.morphTargetManagers[t].uniqueId===e)return this.morphTargetManagers[t];return null}getMorphTargetById(e){for(let t=0;t<this.morphTargetManagers.length;++t){const i=this.morphTargetManagers[t];for(let r=0;r<i.numTargets;++r){const s=i.getTarget(r);if(s.id===e)return s}}return null}getMorphTargetByName(e){for(let t=0;t<this.morphTargetManagers.length;++t){const i=this.morphTargetManagers[t];for(let r=0;r<i.numTargets;++r){const s=i.getTarget(r);if(s.name===e)return s}}return null}getPostProcessByName(e){for(let t=0;t<this.postProcesses.length;++t){const i=this.postProcesses[t];if(i.name===e)return i}return null}isActiveMesh(e){return this._activeMeshes.indexOf(e)!==-1}get uid(){return this._uid||(this._uid=k.RandomId()),this._uid}addExternalData(e,t){return this._externalData||(this._externalData=new yh),this._externalData.add(e,t)}getExternalData(e){return this._externalData?this._externalData.get(e):null}getOrAddExternalDataWithFactory(e,t){return this._externalData||(this._externalData=new yh),this._externalData.getOrAddWithFactory(e,t)}removeExternalData(e){return this._externalData.remove(e)}_evaluateSubMesh(e,t,i,r){if(r||e.isInFrustum(this._frustumPlanes)){for(const n of this._evaluateSubMeshStage)n.action(t,e);const s=e.getMaterial();s!=null&&(s.hasRenderTargetTextures&&s.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(s)===-1&&(this._processedMaterials.push(s),this._materialsRenderTargets.concatWithNoDuplicate(s.getRenderTargetTextures())),this._renderingManager.dispatch(e,t,s))}}freeProcessedMaterials(){this._processedMaterials.dispose()}get blockfreeActiveMeshesAndRenderingGroups(){return this._preventFreeActiveMeshesAndRenderingGroups}set blockfreeActiveMeshesAndRenderingGroups(e){this._preventFreeActiveMeshesAndRenderingGroups!==e&&(e&&(this.freeActiveMeshes(),this.freeRenderingGroups()),this._preventFreeActiveMeshesAndRenderingGroups=e)}freeActiveMeshes(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._activeMeshes.dispose(),this.activeCamera&&this.activeCamera._activeMeshes&&this.activeCamera._activeMeshes.dispose(),this.activeCameras))for(let e=0;e<this.activeCameras.length;e++){const t=this.activeCameras[e];t&&t._activeMeshes&&t._activeMeshes.dispose()}}freeRenderingGroups(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._renderingManager&&this._renderingManager.freeRenderingGroups(),this.textures))for(let e=0;e<this.textures.length;e++){const t=this.textures[e];t&&t.renderList&&t.freeRenderingGroups()}}_isInIntermediateRendering(){return this._intermediateRendering}freezeActiveMeshes(e=!1,t,i,r=!0,s=!1){return this.executeWhenReady(()=>{if(!this.activeCamera){i&&i("No active camera found");return}if(this._frustumPlanes||this.updateTransformMatrix(),this._evaluateActiveMeshes(),this._activeMeshesFrozen=!0,this._activeMeshesFrozenButKeepClipping=s,this._skipEvaluateActiveMeshesCompletely=e,r)for(let n=0;n<this._activeMeshes.length;n++)this._activeMeshes.data[n]._freeze();t&&t()}),this}unfreezeActiveMeshes(){for(let e=0;e<this.meshes.length;e++){const t=this.meshes[e];t._internalAbstractMeshDataInfo&&(t._internalAbstractMeshDataInfo._isActive=!1)}for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._unFreeze();return this._activeMeshesFrozen=!1,this}_executeActiveContainerCleanup(e){!(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1)&&this._activeMeshesFrozen&&this._activeMeshes.length||this.onBeforeRenderObservable.addOnce(()=>e.dispose())}_evaluateActiveMeshes(){var i;if(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1){this._activeMeshes.length>0&&((i=this.activeCamera)==null||i._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset());return}if(this._activeMeshesFrozen&&this._activeMeshes.length){if(!this._skipEvaluateActiveMeshesCompletely){const r=this._activeMeshes.length;for(let s=0;s<r;s++)this._activeMeshes.data[s].computeWorldMatrix()}if(this._activeParticleSystems){const r=this._activeParticleSystems.length;for(let s=0;s<r;s++)this._activeParticleSystems.data[s].animate()}this._renderingManager.resetSprites();return}if(!this.activeCamera)return;this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this),this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._materialsRenderTargets.reset();for(const r of this._beforeEvaluateActiveMeshStage)r.action();const e=this.getActiveMeshCandidates(),t=e.length;for(let r=0;r<t;r++){const s=e.data[r];let n=s._internalAbstractMeshDataInfo._currentLOD.get(this.activeCamera);if(n?n[1]=-1:(n=[s,-1],s._internalAbstractMeshDataInfo._currentLOD.set(this.activeCamera,n)),s.isBlocked||(this._totalVertices.addCount(s.getTotalVertices(),!1),!s.isReady()||!s.isEnabled()||s.scaling.hasAZeroComponent))continue;s.computeWorldMatrix(),s.actionManager&&s.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(s);let o=this.customLODSelector?this.customLODSelector(s,this.activeCamera):s.getLOD(this.activeCamera);if(n[0]=o,n[1]=this._frameId,o!=null&&(o!==s&&o.billboardMode!==0&&o.computeWorldMatrix(),s._preActivate(),s.isVisible&&s.visibility>0&&s.layerMask&this.activeCamera.layerMask&&(this._skipFrustumClipping||s.alwaysSelectAsActiveMesh||s.isInFrustum(this._frustumPlanes)))){this._activeMeshes.push(s),this.activeCamera._activeMeshes.push(s),o!==s&&o._activate(this._renderId,!1);for(const l of this._preActiveMeshStage)l.action(s);s._activate(this._renderId,!1)&&(s.isAnInstance?s._internalAbstractMeshDataInfo._actAsRegularMesh&&(o=s):o._internalAbstractMeshDataInfo._onlyForInstances=!1,o._internalAbstractMeshDataInfo._isActive=!0,this._activeMesh(s,o)),s._postActivate()}}if(this.onAfterActiveMeshesEvaluationObservable.notifyObservers(this),this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(let r=0;r<this.particleSystems.length;r++){const s=this.particleSystems[r];if(!s.isStarted()||!s.emitter)continue;const n=s.emitter;(!n.position||n.isEnabled())&&(this._activeParticleSystems.push(s),s.animate(),this._renderingManager.dispatchParticles(s))}this.onAfterParticlesRenderingObservable.notifyObservers(this)}}_prepareSkeleton(e){!this._skeletonsEnabled||!e.skeleton||(this._activeSkeletons.pushNoDuplicate(e.skeleton)&&(e.skeleton.prepare(),this._activeBones.addCount(e.skeleton.bones.length,!1)),e.computeBonesUsingShaders||this._softwareSkinnedMeshes.pushNoDuplicate(e)&&this.frameGraph&&e.applySkeleton(e.skeleton))}_activeMesh(e,t){this._prepareSkeleton(t);let i=e.hasInstances||e.isAnInstance||this.dispatchAllSubMeshesOfActiveMeshes||this._skipFrustumClipping||t.alwaysSelectAsActiveMesh;if(t&&t.subMeshes&&t.subMeshes.length>0){const r=this.getActiveSubMeshCandidates(t),s=r.length;i=i||s===1;for(let n=0;n<s;n++){const o=r.data[n];this._evaluateSubMesh(o,t,e,i)}}}updateTransformMatrix(e){const t=this.activeCamera;if(t)if(t._renderingMultiview){const i=t._rigCameras[0],r=t._rigCameras[1];this.setTransformMatrix(i.getViewMatrix(),i.getProjectionMatrix(e),r.getViewMatrix(),r.getProjectionMatrix(e))}else this.setTransformMatrix(t.getViewMatrix(),t.getProjectionMatrix(e))}_bindFrameBuffer(e,t=!0){this._useCurrentFrameBuffer||(e&&e._multiviewTexture?e._multiviewTexture._bindFrameBuffer():e&&e.outputRenderTarget?e.outputRenderTarget._bindFrameBuffer():this._engine._currentFrameBufferIsDefaultFrameBuffer()||this._engine.restoreDefaultFramebuffer()),t&&this._clearFrameBuffer(e)}_clearFrameBuffer(e){if(!(e&&e._multiviewTexture))if(e&&e.outputRenderTarget&&!e._renderingMultiview){const t=e.outputRenderTarget;t.onClearObservable.hasObservers()?t.onClearObservable.notifyObservers(this._engine):!t.skipInitialClear&&!e.isRightCamera&&(this.autoClear&&this._engine.clear(t.clearColor||this._clearColor,!t._cleared,!0,!0),t._cleared=!0)}else this._defaultFrameBufferCleared?this._engine.clear(null,!1,!0,!0):(this._defaultFrameBufferCleared=!0,this._clear())}_renderForCamera(e,t,i=!0){var n;if(e&&e._skipRendering)return;const r=this._engine;if(this._activeCamera=e,!this.activeCamera)throw new Error("Active camera not set");if(r.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,!this.prePass&&i){let o=!0;e._renderingMultiview&&e.outputRenderTarget&&(o=e.outputRenderTarget.skipInitialClear,this.autoClear&&(this._defaultFrameBufferCleared=!1,e.outputRenderTarget.skipInitialClear=!1)),this._bindFrameBuffer(this._activeCamera),e._renderingMultiview&&e.outputRenderTarget&&(e.outputRenderTarget.skipInitialClear=o)}this.updateTransformMatrix(),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshes();for(let o=0;o<this._softwareSkinnedMeshes.length;o++){const l=this._softwareSkinnedMeshes.data[o];l.applySkeleton(l.skeleton)}this.onBeforeRenderTargetsRenderObservable.notifyObservers(this),this._renderTargets.concatWithNoDuplicate(this._materialsRenderTargets),e.customRenderTargets&&e.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(e.customRenderTargets),t&&t.customRenderTargets&&t.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(t.customRenderTargets),this.environmentTexture&&this.environmentTexture.isRenderTarget&&this._renderTargets.pushNoDuplicate(this.environmentTexture);for(const o of this._gatherActiveCameraRenderTargetsStage)o.action(this._renderTargets);let s=!1;if(this.renderTargetsEnabled){if(this._intermediateRendering=!0,this._renderTargets.length>0){k.StartPerformanceCounter("Render targets",this._renderTargets.length>0);for(let o=0;o<this._renderTargets.length;o++){const l=this._renderTargets.data[o];if(l._shouldRender()){this._renderId++;const c=l.activeCamera&&l.activeCamera!==this.activeCamera;l.render(c,this.dumpNextRenderTargets),s=!0}}k.EndPerformanceCounter("Render targets",this._renderTargets.length>0),this._renderId++}for(const o of this._cameraDrawRenderTargetStage)s=o.action(this.activeCamera)||s;this._intermediateRendering=!1}this._engine.currentRenderPassId=((n=e.outputRenderTarget)==null?void 0:n.renderPassId)??e.renderPassId??0,s&&!this.prePass&&(this._bindFrameBuffer(this._activeCamera,!1),this.updateTransformMatrix()),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),this.postProcessManager&&!e._multiviewTexture&&!this.prePass&&this.postProcessManager._prepareFrame();for(const o of this._beforeCameraDrawStage)o.action(this.activeCamera);this.onBeforeDrawPhaseObservable.notifyObservers(this),r.snapshotRendering&&r.snapshotRenderingMode===1&&this.finalizeSceneUbo(),this._renderingManager.render(null,null,!0,!0),this.onAfterDrawPhaseObservable.notifyObservers(this);for(const o of this._afterCameraDrawStage)o.action(this.activeCamera);if(this.postProcessManager&&!e._multiviewTexture){const o=e.outputRenderTarget?e.outputRenderTarget.renderTarget:void 0;this.postProcessManager._finalizeFrame(e.isIntermediate,o)}for(const o of this._afterCameraPostProcessStage)o.action(this.activeCamera);this._renderTargets.reset(),this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera)}_processSubCameras(e,t=!0){if(e.cameraRigMode===0||e._renderingMultiview){e._renderingMultiview&&!this._multiviewSceneUbo&&this._createMultiviewUbo(),this._renderForCamera(e,void 0,t),this.onAfterRenderCameraObservable.notifyObservers(e);return}if(e._useMultiviewToSingleView)this._renderMultiviewToSingleView(e);else{this.onBeforeCameraRenderObservable.notifyObservers(e);for(let i=0;i<e._rigCameras.length;i++)this._renderForCamera(e._rigCameras[i],e)}this._activeCamera=e,this.updateTransformMatrix(),this.onAfterRenderCameraObservable.notifyObservers(e)}_checkIntersections(){for(let e=0;e<this._meshesForIntersections.length;e++){const t=this._meshesForIntersections.data[e];if(t.actionManager)for(let i=0;t.actionManager&&i<t.actionManager.actions.length;i++){const r=t.actionManager.actions[i];if(r.trigger===12||r.trigger===13){const s=r.getTriggerParameter(),n=s.mesh?s.mesh:s,o=n.intersectsMesh(t,s.usePreciseIntersection),l=t._intersectionsInProgress.indexOf(n);o&&l===-1?r.trigger===12?(r._executeCurrent(qt.CreateNew(t,void 0,n)),t._intersectionsInProgress.push(n)):r.trigger===13&&t._intersectionsInProgress.push(n):!o&&l>-1&&(r.trigger===13&&r._executeCurrent(qt.CreateNew(t,void 0,n)),(!t.actionManager.hasSpecificTrigger(13,c=>{const h=c.mesh?c.mesh:c;return n===h})||r.trigger===13)&&t._intersectionsInProgress.splice(l,1))}}}}_advancePhysicsEngineStep(e){}_animate(e){}animate(){if(this._engine.isDeterministicLockStep()){let e=Math.max(Ge.MinDeltaTime,Math.min(this._engine.getDeltaTime(),Ge.MaxDeltaTime))+this._timeAccumulator;const t=this._engine.getTimeStep(),i=1e3/t/1e3;let r=0;const s=this._engine.getLockstepMaxSteps();let n=Math.floor(e/t);for(n=Math.min(n,s);e>0&&r<n;)this.onBeforeStepObservable.notifyObservers(this),this._animationRatio=t*i,this._animate(t),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(t),this.onAfterStepObservable.notifyObservers(this),this._currentStepId++,r++,e-=t;this._timeAccumulator=e<0?0:e}else{const e=this.useConstantAnimationDeltaTime?16:Math.max(Ge.MinDeltaTime,Math.min(this._engine.getDeltaTime(),Ge.MaxDeltaTime));this._animationRatio=e*(60/1e3),this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(e)}}_clear(){(this.autoClearDepthAndStencil||this.autoClear)&&this._engine.clear(this._clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil)}_checkCameraRenderTarget(e){var t;if(e!=null&&e.outputRenderTarget&&!(e!=null&&e.isRigCamera)&&(e.outputRenderTarget._cleared=!1),(t=e==null?void 0:e.rigCameras)!=null&&t.length)for(let i=0;i<e.rigCameras.length;++i){const r=e.rigCameras[i].outputRenderTarget;r&&(r._cleared=!1)}}resetDrawCache(e){if(this.meshes)for(const t of this.meshes)t.resetDrawCache(e)}_renderWithFrameGraph(e=!0,t=!1){var s;if(this.activeCamera=null,this._activeParticleSystems.reset(),this._activeSkeletons.reset(),e){for(const n of this.cameras)if(n.update(),n.cameraRigMode!==0)for(let o=0;o<n._rigCameras.length;o++)n._rigCameras[o].update()}for(const n of this._beforeClearStage)n.action();const i=this.getActiveMeshCandidates(),r=i.length;for(let n=0;n<r;n++){const o=i.data[n];o.isBlocked||(this._totalVertices.addCount(o.getTotalVertices(),!1),!(!o.isReady()||!o.isEnabled()||o.scaling.hasAZeroComponent)&&(o.computeWorldMatrix(),o.actionManager&&o.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(o)))}if(this.particlesEnabled)for(let n=0;n<this.particleSystems.length;n++){const o=this.particleSystems[n];if(!o.isStarted()||!o.emitter)continue;const l=o.emitter;(!l.position||l.isEnabled())&&(this._activeParticleSystems.push(o),o.animate())}(s=this.frameGraph)==null||s.execute()}render(e=!0,t=!1){var i,r;if(!this.isDisposed){this.onReadyObservable.hasObservers()&&this._executeWhenReadyTimeoutId===null&&this._checkIsReady(),this._frameId++,this._defaultFrameBufferCleared=!1,this._checkCameraRenderTarget(this.activeCamera),(i=this.activeCameras)!=null&&i.length&&this.activeCameras.forEach(this._checkCameraRenderTarget),this._registerTransientComponents(),this._activeParticles.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),this.onBeforeAnimationsObservable.notifyObservers(this),this.actionManager&&this.actionManager.processTrigger(11),t||this.animate();for(const s of this._beforeCameraUpdateStage)s.action();if(e){if(this.activeCameras&&this.activeCameras.length>0)for(let s=0;s<this.activeCameras.length;s++){const n=this.activeCameras[s];if(n.update(),n.cameraRigMode!==0)for(let o=0;o<n._rigCameras.length;o++)n._rigCameras[o].update()}else if(this.activeCamera&&(this.activeCamera.update(),this.activeCamera.cameraRigMode!==0))for(let s=0;s<this.activeCamera._rigCameras.length;s++)this.activeCamera._rigCameras[s].update()}if(this.onBeforeRenderObservable.notifyObservers(this),this.customRenderFunction)this._renderId++,this._engine.currentRenderPassId=0,this.customRenderFunction(e,t);else{const s=this.getEngine();this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);const n=(r=this.activeCameras)!=null&&r.length?this.activeCameras[0]:this.activeCamera;if(this.renderTargetsEnabled){k.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!0;for(let o=0;o<this.customRenderTargets.length;o++){const l=this.customRenderTargets[o];if(l._shouldRender()){if(this._renderId++,this.activeCamera=l.activeCamera||this.activeCamera,!this.activeCamera)throw new Error("Active camera not set");s.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),l.render(n!==this.activeCamera,this.dumpNextRenderTargets)}}k.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!1,this._renderId++}this._engine.currentRenderPassId=(n==null?void 0:n.renderPassId)??0,this.activeCamera=n,this._activeCamera&&this._activeCamera.cameraRigMode!==22&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this);for(const o of this._beforeClearStage)o.action();this._clearFrameBuffer(this.activeCamera);for(const o of this._gatherRenderTargetsStage)o.action(this._renderTargets);if(this.activeCameras&&this.activeCameras.length>0)for(let o=0;o<this.activeCameras.length;o++)this._processSubCameras(this.activeCameras[o],o>0);else{if(!this.activeCamera)throw new Error("No camera defined");this._processSubCameras(this.activeCamera,!!this.activeCamera.outputRenderTarget)}}this._checkIntersections();for(const s of this._afterRenderStage)s.action();if(this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this),this._toBeDisposed.length){for(let s=0;s<this._toBeDisposed.length;s++){const n=this._toBeDisposed[s];n&&n.dispose()}this._toBeDisposed.length=0}this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=!1),this._activeBones.addCount(0,!0),this._activeIndices.addCount(0,!0),this._activeParticles.addCount(0,!0),this._engine.restoreDefaultFramebuffer()}}freezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].freeze()}unfreezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].unfreeze()}dispose(){if(this.isDisposed)return;this.beforeRender=null,this.afterRender=null,this.metadata=null,this.skeletons.length=0,this.morphTargetManagers.length=0,this._transientComponents.length=0,this._isReadyForMeshStage.clear(),this._beforeEvaluateActiveMeshStage.clear(),this._evaluateSubMeshStage.clear(),this._preActiveMeshStage.clear(),this._cameraDrawRenderTargetStage.clear(),this._beforeCameraDrawStage.clear(),this._beforeRenderTargetDrawStage.clear(),this._beforeRenderingGroupDrawStage.clear(),this._beforeRenderingMeshStage.clear(),this._afterRenderingMeshStage.clear(),this._afterRenderingGroupDrawStage.clear(),this._afterCameraDrawStage.clear(),this._afterRenderTargetDrawStage.clear(),this._afterRenderStage.clear(),this._beforeCameraUpdateStage.clear(),this._beforeClearStage.clear(),this._gatherRenderTargetsStage.clear(),this._gatherActiveCameraRenderTargetsStage.clear(),this._pointerMoveStage.clear(),this._pointerDownStage.clear(),this._pointerUpStage.clear(),this.importedMeshesFiles=[],this._activeAnimatables&&this.stopAllAnimations&&(this._activeAnimatables.forEach(s=>{s.onAnimationEndObservable.clear(),s.onAnimationEnd=null}),this.stopAllAnimations()),this.resetCachedMaterial(),this.activeCamera&&(this.activeCamera._activeMeshes.dispose(),this.activeCamera=null),this.activeCameras=null,this._activeMeshes.dispose(),this._renderingManager.dispose(),this._processedMaterials.dispose(),this._activeParticleSystems.dispose(),this._activeSkeletons.dispose(),this._softwareSkinnedMeshes.dispose(),this._renderTargets.dispose(),this._materialsRenderTargets.dispose(),this._registeredForLateAnimationBindings.dispose(),this._meshesForIntersections.dispose(),this._toBeDisposed.length=0;const e=this._activeRequests.slice();for(const s of e)s.abort();this._activeRequests.length=0;try{this.onDisposeObservable.notifyObservers(this)}catch(s){B.Error("An error occurred while calling onDisposeObservable!",s)}if(this.detachControl(),this._engine.getInputElement())for(let s=0;s<this.cameras.length;s++)this.cameras[s].detachControl();this._disposeList(this.animationGroups),this._disposeList(this.lights),this._defaultMaterial&&this._defaultMaterial.dispose(),this._disposeList(this.multiMaterials),this._disposeList(this.materials),this._disposeList(this.meshes,s=>s.dispose(!0)),this._disposeList(this.transformNodes,s=>s.dispose(!0));const i=this.cameras;this._disposeList(i),this._disposeList(this.particleSystems),this._disposeList(this.postProcesses),this._disposeList(this.textures),this._disposeList(this.morphTargetManagers),this._sceneUbo.dispose(),this._multiviewSceneUbo&&this._multiviewSceneUbo.dispose(),this.postProcessManager.dispose(),this._disposeList(this._components);let r=this._engine.scenes.indexOf(this);if(r>-1&&this._engine.scenes.splice(r,1),Re._LastCreatedScene===this){Re._LastCreatedScene=null;let s=Re.Instances.length-1;for(;s>=0;){const n=Re.Instances[s];if(n.scenes.length>0){Re._LastCreatedScene=n.scenes[this._engine.scenes.length-1];break}s--}}r=this._engine._virtualScenes.indexOf(this),r>-1&&this._engine._virtualScenes.splice(r,1),this._engine.wipeCaches(!0),this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderTargetsRenderObservable.clear(),this.onAfterRenderTargetsRenderObservable.clear(),this.onAfterStepObservable.clear(),this.onBeforeStepObservable.clear(),this.onBeforeActiveMeshesEvaluationObservable.clear(),this.onAfterActiveMeshesEvaluationObservable.clear(),this.onBeforeParticlesRenderingObservable.clear(),this.onAfterParticlesRenderingObservable.clear(),this.onBeforeDrawPhaseObservable.clear(),this.onAfterDrawPhaseObservable.clear(),this.onBeforeAnimationsObservable.clear(),this.onAfterAnimationsObservable.clear(),this.onDataLoadedObservable.clear(),this.onBeforeRenderingGroupObservable.clear(),this.onAfterRenderingGroupObservable.clear(),this.onMeshImportedObservable.clear(),this.onBeforeCameraRenderObservable.clear(),this.onAfterCameraRenderObservable.clear(),this.onAfterRenderCameraObservable.clear(),this.onReadyObservable.clear(),this.onNewCameraAddedObservable.clear(),this.onCameraRemovedObservable.clear(),this.onNewLightAddedObservable.clear(),this.onLightRemovedObservable.clear(),this.onNewGeometryAddedObservable.clear(),this.onGeometryRemovedObservable.clear(),this.onNewTransformNodeAddedObservable.clear(),this.onTransformNodeRemovedObservable.clear(),this.onNewMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onNewSkeletonAddedObservable.clear(),this.onSkeletonRemovedObservable.clear(),this.onNewMaterialAddedObservable.clear(),this.onNewMultiMaterialAddedObservable.clear(),this.onMaterialRemovedObservable.clear(),this.onMultiMaterialRemovedObservable.clear(),this.onNewTextureAddedObservable.clear(),this.onTextureRemovedObservable.clear(),this.onPrePointerObservable.clear(),this.onPointerObservable.clear(),this.onPreKeyboardObservable.clear(),this.onKeyboardObservable.clear(),this.onActiveCameraChanged.clear(),this.onScenePerformancePriorityChangedObservable.clear(),this.onClearColorChangedObservable.clear(),this.onEnvironmentTextureChangedObservable.clear(),this.onMeshUnderPointerUpdatedObservable.clear(),this._isDisposed=!0}_disposeList(e,t){const i=e.slice(0);t=t??(r=>r.dispose());for(const r of i)t(r);e.length=0}get isDisposed(){return this._isDisposed}clearCachedVertexData(){for(let e=0;e<this.meshes.length;e++){const i=this.meshes[e].geometry;i&&i.clearCachedData()}}cleanCachedTextureBuffer(){for(const e of this.textures)e._buffer&&(e._buffer=null)}getWorldExtends(e){const t=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),i=new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return e=e||(()=>!0),this.meshes.filter(e).forEach(r=>{if(r.computeWorldMatrix(!0),!r.subMeshes||r.subMeshes.length===0||r.infiniteDistance)return;const s=r.getBoundingInfo(),n=s.boundingBox.minimumWorld,o=s.boundingBox.maximumWorld;m.CheckExtends(n,t,i),m.CheckExtends(o,t,i)}),{min:t,max:i}}createPickingRay(e,t,i,r,s=!1){throw Le("Ray")}createPickingRayToRef(e,t,i,r,s,n=!1,o=!1){throw Le("Ray")}createPickingRayInCameraSpace(e,t,i){throw Le("Ray")}createPickingRayInCameraSpaceToRef(e,t,i,r){throw Le("Ray")}pick(e,t,i,r,s,n){const o=Le("Ray",!0);return o&&B.Warn(o),new oi}pickWithBoundingInfo(e,t,i,r,s){const n=Le("Ray",!0);return n&&B.Warn(n),new oi}pickWithRay(e,t,i,r){throw Le("Ray")}multiPick(e,t,i,r,s){throw Le("Ray")}multiPickWithRay(e,t,i){throw Le("Ray")}setPointerOverMesh(e,t,i){this._inputManager.setPointerOverMesh(e,t,i)}getPointerOverMesh(){return this._inputManager.getPointerOverMesh()}_rebuildGeometries(){for(const e of this.geometries)e._rebuild();for(const e of this.meshes)e._rebuild();this.postProcessManager&&this.postProcessManager._rebuild();for(const e of this._components)e.rebuild();for(const e of this.particleSystems)e.rebuild();if(this.spriteManagers)for(const e of this.spriteManagers)e.rebuild()}_rebuildTextures(){for(const e of this.textures)e._rebuild(!0);this.markAllMaterialsAsDirty(1)}_getByTags(e,t,i){if(t===void 0)return e;const r=[];for(const s in e){const n=e[s];qe&&qe.MatchesQuery(n,t)&&(!i||i(n))&&r.push(n)}return r}getMeshesByTags(e,t){return this._getByTags(this.meshes,e,t)}getCamerasByTags(e,t){return this._getByTags(this.cameras,e,t)}getLightsByTags(e,t){return this._getByTags(this.lights,e,t)}getMaterialByTags(e,t){return this._getByTags(this.materials,e,t).concat(this._getByTags(this.multiMaterials,e,t))}getTransformNodesByTags(e,t){return this._getByTags(this.transformNodes,e,t)}setRenderingOrder(e,t=null,i=null,r=null){this._renderingManager.setRenderingOrder(e,t,i,r)}setRenderingAutoClearDepthStencil(e,t,i=!0,r=!0){this._renderingManager.setRenderingAutoClearDepthStencil(e,t,i,r)}getAutoClearDepthStencilSetup(e){return this._renderingManager.getAutoClearDepthStencilSetup(e)}_forceBlockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism=e}get blockMaterialDirtyMechanism(){return this._blockMaterialDirtyMechanism}set blockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism!==e&&(this._blockMaterialDirtyMechanism=e,e||this.markAllMaterialsAsDirty(127))}markAllMaterialsAsDirty(e,t){if(!this._blockMaterialDirtyMechanism)for(const i of this.materials)t&&!t(i)||i.markAsDirty(e)}_loadFile(e,t,i,r,s,n,o){const l=Jr(e,t,i,r?this.offlineProvider:void 0,s,n,o);return this._activeRequests.push(l),l.onCompleteObservable.add(c=>{this._activeRequests.splice(this._activeRequests.indexOf(c),1)}),l}_loadFileAsync(e,t,i,r,s){return new Promise((n,o)=>{this._loadFile(e,l=>{n(l)},t,i,r,(l,c)=>{o(c)},s)})}_requestFile(e,t,i,r,s,n,o){const l=_c(e,t,i,r?this.offlineProvider:void 0,s,n,o);return this._activeRequests.push(l),l.onCompleteObservable.add(c=>{this._activeRequests.splice(this._activeRequests.indexOf(c),1)}),l}_requestFileAsync(e,t,i,r,s){return new Promise((n,o)=>{this._requestFile(e,l=>{n(l)},t,i,r,l=>{o(l)},s)})}_readFile(e,t,i,r,s){const n=Sn(e,t,i,r,s);return this._activeRequests.push(n),n.onCompleteObservable.add(o=>{this._activeRequests.splice(this._activeRequests.indexOf(o),1)}),n}_readFileAsync(e,t,i){return new Promise((r,s)=>{this._readFile(e,n=>{r(n)},t,i,n=>{s(n)})})}getPerfCollector(){throw Le("performanceViewerSceneExtension")}setActiveCameraByID(e){return this.setActiveCameraById(e)}getMaterialByID(e){return this.getMaterialById(e)}getLastMaterialByID(e){return this.getLastMaterialById(e)}getTextureByUniqueID(e){return this.getTextureByUniqueId(e)}getCameraByID(e){return this.getCameraById(e)}getCameraByUniqueID(e){return this.getCameraByUniqueId(e)}getBoneByID(e){return this.getBoneById(e)}getLightByID(e){return this.getLightById(e)}getLightByUniqueID(e){return this.getLightByUniqueId(e)}getParticleSystemByID(e){return this.getParticleSystemById(e)}getGeometryByID(e){return this.getGeometryById(e)}getMeshByID(e){return this.getMeshById(e)}getMeshByUniqueID(e){return this.getMeshByUniqueId(e)}getLastMeshByID(e){return this.getLastMeshById(e)}getMeshesByID(e){return this.getMeshesById(e)}getTransformNodeByID(e){return this.getTransformNodeById(e)}getTransformNodeByUniqueID(e){return this.getTransformNodeByUniqueId(e)}getTransformNodesByID(e){return this.getTransformNodesById(e)}getNodeByID(e){return this.getNodeById(e)}getLastEntryByID(e){return this.getLastEntryById(e)}getLastSkeletonByID(e){return this.getLastSkeletonById(e)}}Ge.FOGMODE_NONE=0;Ge.FOGMODE_EXP=1;Ge.FOGMODE_EXP2=2;Ge.FOGMODE_LINEAR=3;Ge.MinDeltaTime=1;Ge.MaxDeltaTime=1e3;Ge._OriginalDefaultMaterialFactory=Ge.DefaultMaterialFactory;Y("BABYLON.Scene",Ge);class Ni{constructor(e,t){this.width=e,this.height=t}toString(){return`{W: ${this.width}, H: ${this.height}}`}getClassName(){return"Size"}getHashCode(){let e=this.width|0;return e=e*397^(this.height|0),e}copyFrom(e){this.width=e.width,this.height=e.height}copyFromFloats(e,t){return this.width=e,this.height=t,this}set(e,t){return this.copyFromFloats(e,t)}multiplyByFloats(e,t){return new Ni(this.width*e,this.height*t)}clone(){return new Ni(this.width,this.height)}equals(e){return e?this.width===e.width&&this.height===e.height:!1}get surface(){return this.width*this.height}static Zero(){return new Ni(0,0)}add(e){return new Ni(this.width+e.width,this.height+e.height)}subtract(e){return new Ni(this.width-e.width,this.height-e.height)}scale(e){return new Ni(this.width*e,this.height*e)}static Lerp(e,t,i){const r=e.width+(t.width-e.width)*i,s=e.height+(t.height-e.height)*i;return new Ni(r,s)}}class Sc{get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get coordinatesMode(){return 0}get isCube(){return this._texture?this._texture.isCube:!1}set isCube(e){this._texture&&(this._texture.isCube=e)}get is3D(){return this._texture?this._texture.is3D:!1}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return this._texture?this._texture.is2DArray:!1}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}getClassName(){return"ThinTexture"}static _IsRenderTargetWrapper(e){return(e==null?void 0:e.shareDepth)!==void 0}constructor(e){this._wrapU=1,this._wrapV=1,this.wrapR=1,this.anisotropicFilteringLevel=4,this.delayLoadState=0,this._texture=null,this._engine=null,this._cachedSize=Ni.Zero(),this._cachedBaseSize=Ni.Zero(),this._initialSamplingMode=2,this._texture=Sc._IsRenderTargetWrapper(e)?e.texture:e,this._texture&&(this._engine=this._texture.getEngine())}isReady(){return this.delayLoadState===4?(this.delayLoad(),!1):this._texture?this._texture.isReady:!1}delayLoad(){}getInternalTexture(){return this._texture}getSize(){if(this._texture){if(this._texture.width)return this._cachedSize.width=this._texture.width,this._cachedSize.height=this._texture.height,this._cachedSize;if(this._texture._size)return this._cachedSize.width=this._texture._size,this._cachedSize.height=this._texture._size,this._cachedSize}return this._cachedSize}getBaseSize(){return!this.isReady()||!this._texture?(this._cachedBaseSize.width=0,this._cachedBaseSize.height=0,this._cachedBaseSize):this._texture._size?(this._cachedBaseSize.width=this._texture._size,this._cachedBaseSize.height=this._texture._size,this._cachedBaseSize):(this._cachedBaseSize.width=this._texture.baseWidth,this._cachedBaseSize.height=this._texture.baseHeight,this._cachedBaseSize)}get samplingMode(){return this._texture?this._texture.samplingMode:this._initialSamplingMode}updateSamplingMode(e){this._texture&&this._engine&&this._engine.updateTextureSamplingMode(e,this._texture)}releaseInternalTexture(){this._texture&&(this._texture.dispose(),this._texture=null)}dispose(){this._texture&&(this.releaseInternalTexture(),this._engine=null)}}class rt extends Sc{set hasAlpha(e){this._hasAlpha!==e&&(this._hasAlpha=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get hasAlpha(){return this._hasAlpha}set getAlphaFromRGB(e){this._getAlphaFromRGB!==e&&(this._getAlphaFromRGB=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get getAlphaFromRGB(){return this._getAlphaFromRGB}set coordinatesIndex(e){this._coordinatesIndex!==e&&(this._coordinatesIndex=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get coordinatesIndex(){return this._coordinatesIndex}set coordinatesMode(e){this._coordinatesMode!==e&&(this._coordinatesMode=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get coordinatesMode(){return this._coordinatesMode}get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get isCube(){return this._texture?this._texture.isCube:this._isCube}set isCube(e){this._texture?this._texture.isCube=e:this._isCube=e}get is3D(){return this._texture?this._texture.is3D:!1}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return this._texture?this._texture.is2DArray:!1}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}get gammaSpace(){if(this._texture)this._texture._gammaSpace===null&&(this._texture._gammaSpace=this._gammaSpace);else return this._gammaSpace;return this._texture._gammaSpace&&!this._texture._useSRGBBuffer}set gammaSpace(e){var t;if(this._texture){if(this._texture._gammaSpace===e)return;this._texture._gammaSpace=e}else{if(this._gammaSpace===e)return;this._gammaSpace=e}(t=this.getScene())==null||t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this))}get isRGBD(){return this._texture!=null&&this._texture._isRGBD}set isRGBD(e){var t;e!==this.isRGBD&&(this._texture&&(this._texture._isRGBD=e),(t=this.getScene())==null||t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this)))}get noMipmap(){return!1}get lodGenerationOffset(){return this._texture?this._texture._lodGenerationOffset:0}set lodGenerationOffset(e){this._texture&&(this._texture._lodGenerationOffset=e)}get lodGenerationScale(){return this._texture?this._texture._lodGenerationScale:0}set lodGenerationScale(e){this._texture&&(this._texture._lodGenerationScale=e)}get linearSpecularLOD(){return this._texture?this._texture._linearSpecularLOD:!1}set linearSpecularLOD(e){this._texture&&(this._texture._linearSpecularLOD=e)}get irradianceTexture(){return this._texture?this._texture._irradianceTexture:null}set irradianceTexture(e){this._texture&&(this._texture._irradianceTexture=e)}get uid(){return this._uid||(this._uid=xs()),this._uid}toString(){return this.name}getClassName(){return"BaseTexture"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get isBlocking(){return!0}get loadingError(){return this._loadingError}get errorObject(){return this._errorObject}constructor(e,t=null){super(null),this.metadata=null,this.reservedDataStore=null,this._hasAlpha=!1,this._getAlphaFromRGB=!1,this.level=1,this._coordinatesIndex=0,this.optimizeUVAllocation=!0,this._coordinatesMode=0,this.wrapR=1,this.anisotropicFilteringLevel=rt.DEFAULT_ANISOTROPIC_FILTERING_LEVEL,this._isCube=!1,this._gammaSpace=!0,this.invertZ=!1,this.lodLevelInAlpha=!1,this.isRenderTarget=!1,this._prefiltered=!1,this._forceSerialize=!1,this.animations=[],this.onDisposeObservable=new U,this._onDisposeObserver=null,this._scene=null,this._uid=null,this._parentContainer=null,this._loadingError=!1,e?rt._IsScene(e)?this._scene=e:this._engine=e:this._scene=Re.LastCreatedScene,this._scene&&(this.uniqueId=this._scene.getUniqueId(),this._scene.addTexture(this),this._engine=this._scene.getEngine()),this._texture=t,this._uid=null}getScene(){return this._scene}_getEngine(){return this._engine}getTextureMatrix(){return P.IdentityReadOnly}getReflectionTextureMatrix(){return P.IdentityReadOnly}getRefractionTextureMatrix(){return this.getReflectionTextureMatrix()}isReadyOrNotBlocking(){return!this.isBlocking||this.isReady()||this.loadingError}scale(e){}get canRescale(){return!1}_getFromCache(e,t,i,r,s,n){const o=this._getEngine();if(!o)return null;const l=o._getUseSRGBBuffer(!!s,t),c=o.getLoadedTexturesCache();for(let h=0;h<c.length;h++){const f=c[h];if((s===void 0||l===f._useSRGBBuffer)&&(r===void 0||r===f.invertY)&&f.url===e&&f.generateMipMaps===!t&&(!i||i===f.samplingMode)&&(n===void 0||n===f.isCube))return f.incrementReferences(),f}return null}_rebuild(e=!1){}clone(){return null}get textureType(){return this._texture&&this._texture.type!==void 0?this._texture.type:0}get textureFormat(){return this._texture&&this._texture.format!==void 0?this._texture.format:5}_markAllSubMeshesAsTexturesDirty(){const e=this.getScene();e&&e.markAllMaterialsAsDirty(1)}readPixels(e=0,t=0,i=null,r=!0,s=!1,n=0,o=0,l=Number.MAX_VALUE,c=Number.MAX_VALUE){if(!this._texture)return null;const h=this._getEngine();if(!h)return null;const f=this.getSize();let u=f.width,d=f.height;t!==0&&(u=u/Math.pow(2,t),d=d/Math.pow(2,t),u=Math.round(u),d=Math.round(d)),l=Math.min(u,l),c=Math.min(d,c);try{return this._texture.isCube?h._readTexturePixels(this._texture,l,c,e,t,i,r,s,n,o):h._readTexturePixels(this._texture,l,c,-1,t,i,r,s,n,o)}catch{return null}}_readPixelsSync(e=0,t=0,i=null,r=!0,s=!1){if(!this._texture)return null;const n=this.getSize();let o=n.width,l=n.height;const c=this._getEngine();if(!c)return null;t!=0&&(o=o/Math.pow(2,t),l=l/Math.pow(2,t),o=Math.round(o),l=Math.round(l));try{return this._texture.isCube?c._readTexturePixelsSync(this._texture,o,l,e,t,i,r,s):c._readTexturePixelsSync(this._texture,o,l,-1,t,i,r,s)}catch{return null}}get _lodTextureHigh(){return this._texture?this._texture._lodTextureHigh:null}get _lodTextureMid(){return this._texture?this._texture._lodTextureMid:null}get _lodTextureLow(){return this._texture?this._texture._lodTextureLow:null}dispose(){if(this._scene){this._scene.stopAnimation&&this._scene.stopAnimation(this),this._scene.removePendingData(this);const e=this._scene.textures.indexOf(this);if(e>=0&&this._scene.textures.splice(e,1),this._scene.onTextureRemovedObservable.notifyObservers(this),this._scene=null,this._parentContainer){const t=this._parentContainer.textures.indexOf(this);t>-1&&this._parentContainer.textures.splice(t,1),this._parentContainer=null}}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null,super.dispose()}serialize(e=!1){if(!this.name&&!e)return null;const t=ye.Serialize(this);return ye.AppendSerializedAnimations(this,t),t}static WhenAllReady(e,t){let i=e.length;if(i===0){t();return}for(let r=0;r<e.length;r++){const s=e[r];if(s.isReady())--i===0&&t();else{const n=s.onLoadObservable;n?n.addOnce(()=>{--i===0&&t()}):--i===0&&t()}}}static _IsScene(e){return e.getClassName()==="Scene"}}rt.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=4;A([y()],rt.prototype,"uniqueId",void 0);A([y()],rt.prototype,"name",void 0);A([y()],rt.prototype,"displayName",void 0);A([y()],rt.prototype,"metadata",void 0);A([y("hasAlpha")],rt.prototype,"_hasAlpha",void 0);A([y("getAlphaFromRGB")],rt.prototype,"_getAlphaFromRGB",void 0);A([y()],rt.prototype,"level",void 0);A([y("coordinatesIndex")],rt.prototype,"_coordinatesIndex",void 0);A([y()],rt.prototype,"optimizeUVAllocation",void 0);A([y("coordinatesMode")],rt.prototype,"_coordinatesMode",void 0);A([y()],rt.prototype,"wrapU",null);A([y()],rt.prototype,"wrapV",null);A([y()],rt.prototype,"wrapR",void 0);A([y()],rt.prototype,"anisotropicFilteringLevel",void 0);A([y()],rt.prototype,"isCube",null);A([y()],rt.prototype,"is3D",null);A([y()],rt.prototype,"is2DArray",null);A([y()],rt.prototype,"gammaSpace",null);A([y()],rt.prototype,"invertZ",void 0);A([y()],rt.prototype,"lodLevelInAlpha",void 0);A([y()],rt.prototype,"lodGenerationOffset",null);A([y()],rt.prototype,"lodGenerationScale",null);A([y()],rt.prototype,"linearSpecularLOD",null);A([Je()],rt.prototype,"irradianceTexture",null);A([y()],rt.prototype,"isRenderTarget",void 0);function Nm(a,e,t=!1){const i=e.width,r=e.height;if(a instanceof Float32Array){let c=a.byteLength/a.BYTES_PER_ELEMENT;const h=new Uint8Array(c);for(;--c>=0;){let f=a[c];f<0?f=0:f>1&&(f=1),h[c]=f*255}a=h}const s=document.createElement("canvas");s.width=i,s.height=r;const n=s.getContext("2d");if(!n)return null;const o=n.createImageData(i,r);if(o.data.set(a),n.putImageData(o,0,0),t){const c=document.createElement("canvas");c.width=i,c.height=r;const h=c.getContext("2d");return h?(h.translate(0,r),h.scale(1,-1),h.drawImage(s,0,0),c.toDataURL("image/png")):null}return s.toDataURL("image/png")}function aR(a,e=0,t=0){const i=a.getInternalTexture();if(!i)return null;const r=a._readPixelsSync(e,t);return r?Nm(r,a.getSize(),i.invertY):null}async function oR(a,e=0,t=0){const i=a.getInternalTexture();if(!i)return null;const r=await a.readPixels(e,t);return r?Nm(r,a.getSize(),i.invertY):null}class Z extends rt{static _CreateVideoTexture(e,t,i,r=!1,s=!1,n=Z.TRILINEAR_SAMPLINGMODE,o={},l,c=5){throw Le("VideoTexture")}get noMipmap(){return this._noMipmap}get mimeType(){return this._mimeType}set isBlocking(e){this._isBlocking=e}get isBlocking(){return this._isBlocking}get invertY(){return this._invertY}constructor(e,t,i,r,s=Z.TRILINEAR_SAMPLINGMODE,n=null,o=null,l=null,c=!1,h,f,u,d,_){super(t),this.url=null,this.uOffset=0,this.vOffset=0,this.uScale=1,this.vScale=1,this.uAng=0,this.vAng=0,this.wAng=0,this.uRotationCenter=.5,this.vRotationCenter=.5,this.wRotationCenter=.5,this.homogeneousRotationInUVTransform=!1,this.inspectableCustomProperties=null,this._noMipmap=!1,this._invertY=!1,this._rowGenerationMatrix=null,this._cachedTextureMatrix=null,this._projectionModeMatrix=null,this._t0=null,this._t1=null,this._t2=null,this._cachedUOffset=-1,this._cachedVOffset=-1,this._cachedUScale=0,this._cachedVScale=0,this._cachedUAng=-1,this._cachedVAng=-1,this._cachedWAng=-1,this._cachedReflectionProjectionMatrixId=-1,this._cachedURotationCenter=-1,this._cachedVRotationCenter=-1,this._cachedWRotationCenter=-1,this._cachedHomogeneousRotationInUVTransform=!1,this._cachedIdentity3x2=!0,this._cachedReflectionTextureMatrix=null,this._cachedReflectionUOffset=-1,this._cachedReflectionVOffset=-1,this._cachedReflectionUScale=0,this._cachedReflectionVScale=0,this._cachedReflectionCoordinatesMode=-1,this._buffer=null,this._deleteBuffer=!1,this._format=null,this._delayedOnLoad=null,this._delayedOnError=null,this.onLoadObservable=new U,this._isBlocking=!0,this.name=e||"",this.url=e;let p,g=!1,E=null,v=!0;typeof i=="object"&&i!==null?(p=i.noMipmap??!1,r=i.invertY??!0,s=i.samplingMode??Z.TRILINEAR_SAMPLINGMODE,n=i.onLoad??null,o=i.onError??null,l=i.buffer??null,c=i.deleteBuffer??!1,h=i.format,f=i.mimeType,u=i.loaderOptions,d=i.creationFlags,g=i.useSRGBBuffer??!1,E=i.internalTexture??null,v=i.gammaSpace??v,_=i.forcedExtension??_):p=!!i,this._gammaSpace=v,this._noMipmap=p,this._invertY=r===void 0?!0:r,this._initialSamplingMode=s,this._buffer=l,this._deleteBuffer=c,this._mimeType=f,this._loaderOptions=u,this._creationFlags=d,this._useSRGBBuffer=g,this._forcedExtension=_,h&&(this._format=h);const b=this.getScene(),R=this._getEngine();if(!R)return;R.onBeforeTextureInitObservable.notifyObservers(this);const S=()=>{this._texture&&(this._texture._invertVScale&&(this.vScale*=-1,this.vOffset+=1),this._texture._cachedWrapU!==null&&(this.wrapU=this._texture._cachedWrapU,this._texture._cachedWrapU=null),this._texture._cachedWrapV!==null&&(this.wrapV=this._texture._cachedWrapV,this._texture._cachedWrapV=null),this._texture._cachedWrapR!==null&&(this.wrapR=this._texture._cachedWrapR,this._texture._cachedWrapR=null)),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this),n&&n(),!this.isBlocking&&b&&b.resetCachedMaterial()},T=(I,O)=>{this._loadingError=!0,this._errorObject={message:I,exception:O},o&&o(I,O),Z.OnTextureLoadErrorObservable.notifyObservers(this)};if(!this.url&&!E){this._delayedOnLoad=S,this._delayedOnError=T;return}if(this._texture=E??this._getFromCache(this.url,p,s,this._invertY,g,this.isCube),this._texture)if(this._texture.isReady)vs.SetImmediate(()=>S());else{const I=this._texture.onLoadedObservable.add(S);this._texture.onErrorObservable.add(O=>{var L;T(O.message,O.exception),(L=this._texture)==null||L.onLoadedObservable.remove(I)})}else if(!b||!b.useDelayedTextureLoading){try{this._texture=R.createTexture(this.url,p,this._invertY,b,s,S,T,this._buffer,void 0,this._format,this._forcedExtension,f,u,d,g)}catch(I){throw T("error loading",I),I}c&&(this._buffer=null)}else this.delayLoadState=4,this._delayedOnLoad=S,this._delayedOnError=T}updateURL(e,t=null,i,r){this.url&&(this.releaseInternalTexture(),this.getScene().markAllMaterialsAsDirty(1,s=>s.hasTexture(this))),(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,this._buffer=t,this._forcedExtension=r,this.delayLoadState=4,i&&(this._delayedOnLoad=i),this.delayLoad()}delayLoad(){if(this.delayLoadState!==4)return;const e=this.getScene();e&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap,this.samplingMode,this._invertY,this._useSRGBBuffer,this.isCube),this._texture?this._delayedOnLoad&&(this._texture.isReady?vs.SetImmediate(this._delayedOnLoad):this._texture.onLoadedObservable.add(this._delayedOnLoad)):(this._texture=e.getEngine().createTexture(this.url,this._noMipmap,this._invertY,e,this.samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer,null,this._format,this._forcedExtension,this._mimeType,this._loaderOptions,this._creationFlags,this._useSRGBBuffer),this._deleteBuffer&&(this._buffer=null)),this._delayedOnLoad=null,this._delayedOnError=null)}_prepareRowForTextureGeneration(e,t,i,r){e*=this._cachedUScale,t*=this._cachedVScale,e-=this.uRotationCenter*this._cachedUScale,t-=this.vRotationCenter*this._cachedVScale,i-=this.wRotationCenter,m.TransformCoordinatesFromFloatsToRef(e,t,i,this._rowGenerationMatrix,r),r.x+=this.uRotationCenter*this._cachedUScale+this._cachedUOffset,r.y+=this.vRotationCenter*this._cachedVScale+this._cachedVOffset,r.z+=this.wRotationCenter}getTextureMatrix(e=1){if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale*e===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng&&this.uRotationCenter===this._cachedURotationCenter&&this.vRotationCenter===this._cachedVRotationCenter&&this.wRotationCenter===this._cachedWRotationCenter&&this.homogeneousRotationInUVTransform===this._cachedHomogeneousRotationInUVTransform)return this._cachedTextureMatrix;this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale*e,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedURotationCenter=this.uRotationCenter,this._cachedVRotationCenter=this.vRotationCenter,this._cachedWRotationCenter=this.wRotationCenter,this._cachedHomogeneousRotationInUVTransform=this.homogeneousRotationInUVTransform,(!this._cachedTextureMatrix||!this._rowGenerationMatrix)&&(this._cachedTextureMatrix=P.Zero(),this._rowGenerationMatrix=new P,this._t0=m.Zero(),this._t1=m.Zero(),this._t2=m.Zero()),P.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this.homogeneousRotationInUVTransform?(P.TranslationToRef(-this._cachedURotationCenter,-this._cachedVRotationCenter,-this._cachedWRotationCenter,F.Matrix[0]),P.TranslationToRef(this._cachedURotationCenter,this._cachedVRotationCenter,this._cachedWRotationCenter,F.Matrix[1]),P.ScalingToRef(this._cachedUScale,this._cachedVScale,0,F.Matrix[2]),P.TranslationToRef(this._cachedUOffset,this._cachedVOffset,0,F.Matrix[3]),F.Matrix[0].multiplyToRef(this._rowGenerationMatrix,this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(F.Matrix[1],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(F.Matrix[2],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(F.Matrix[3],this._cachedTextureMatrix),this._cachedTextureMatrix.setRowFromFloats(2,this._cachedTextureMatrix.m[12],this._cachedTextureMatrix.m[13],this._cachedTextureMatrix.m[14],1)):(this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),P.FromValuesToRef(this._t1.x,this._t1.y,this._t1.z,0,this._t2.x,this._t2.y,this._t2.z,0,this._t0.x,this._t0.y,this._t0.z,0,0,0,0,1,this._cachedTextureMatrix));const t=this.getScene();if(!t)return this._cachedTextureMatrix;const i=this._cachedIdentity3x2;return this._cachedIdentity3x2=this._cachedTextureMatrix.isIdentityAs3x2(),this.optimizeUVAllocation&&i!==this._cachedIdentity3x2&&t.markAllMaterialsAsDirty(1,r=>r.hasTexture(this)),this._cachedTextureMatrix}getReflectionTextureMatrix(){const e=this.getScene();if(!e)return this._cachedReflectionTextureMatrix;if(this.uOffset===this._cachedReflectionUOffset&&this.vOffset===this._cachedReflectionVOffset&&this.uScale===this._cachedReflectionUScale&&this.vScale===this._cachedReflectionVScale&&this.coordinatesMode===this._cachedReflectionCoordinatesMode)if(this.coordinatesMode===Z.PROJECTION_MODE){if(this._cachedReflectionProjectionMatrixId===e.getProjectionMatrix().updateFlag)return this._cachedReflectionTextureMatrix}else return this._cachedReflectionTextureMatrix;this._cachedReflectionTextureMatrix||(this._cachedReflectionTextureMatrix=P.Zero()),this._projectionModeMatrix||(this._projectionModeMatrix=P.Zero());const t=this._cachedReflectionCoordinatesMode!==this.coordinatesMode;switch(this._cachedReflectionUOffset=this.uOffset,this._cachedReflectionVOffset=this.vOffset,this._cachedReflectionUScale=this.uScale,this._cachedReflectionVScale=this.vScale,this._cachedReflectionCoordinatesMode=this.coordinatesMode,this.coordinatesMode){case Z.PLANAR_MODE:{P.IdentityToRef(this._cachedReflectionTextureMatrix),this._cachedReflectionTextureMatrix[0]=this.uScale,this._cachedReflectionTextureMatrix[5]=this.vScale,this._cachedReflectionTextureMatrix[12]=this.uOffset,this._cachedReflectionTextureMatrix[13]=this.vOffset;break}case Z.PROJECTION_MODE:{P.FromValuesToRef(.5,0,0,0,0,-.5,0,0,0,0,0,0,.5,.5,1,1,this._projectionModeMatrix);const i=e.getProjectionMatrix();this._cachedReflectionProjectionMatrixId=i.updateFlag,i.multiplyToRef(this._projectionModeMatrix,this._cachedReflectionTextureMatrix);break}default:P.IdentityToRef(this._cachedReflectionTextureMatrix);break}return t&&e.markAllMaterialsAsDirty(1,i=>i.hasTexture(this)),this._cachedReflectionTextureMatrix}clone(){const e={noMipmap:this._noMipmap,invertY:this._invertY,samplingMode:this.samplingMode,onLoad:void 0,onError:void 0,buffer:this._texture?this._texture._buffer:void 0,deleteBuffer:this._deleteBuffer,format:this.textureFormat,mimeType:this.mimeType,loaderOptions:this._loaderOptions,creationFlags:this._creationFlags,useSRGBBuffer:this._useSRGBBuffer};return ye.Clone(()=>new Z(this._texture?this._texture.url:null,this.getScene(),e),this)}serialize(){var i,r;const e=this.name;Z.SerializeBuffers||this.name.startsWith("data:")&&(this.name=""),this.name.startsWith("data:")&&this.url===this.name&&(this.url="");const t=super.serialize(Z._SerializeInternalTextureUniqueId);return t?((Z.SerializeBuffers||Z.ForceSerializeBuffers)&&(typeof this._buffer=="string"&&this._buffer.substring(0,5)==="data:"?(t.base64String=this._buffer,t.name=t.name.replace("data:","")):this.url&&this.url.startsWith("data:")&&this._buffer instanceof Uint8Array?t.base64String="data:image/png;base64,"+nm(this._buffer):(Z.ForceSerializeBuffers||this.url&&this.url.startsWith("blob:")||this._forceSerialize)&&(t.base64String=!this._engine||this._engine._features.supportSyncTextureRead?aR(this):oR(this))),t.invertY=this._invertY,t.samplingMode=this.samplingMode,t._creationFlags=this._creationFlags,t._useSRGBBuffer=this._useSRGBBuffer,Z._SerializeInternalTextureUniqueId&&(t.internalTextureUniqueId=(i=this._texture)==null?void 0:i.uniqueId),t.internalTextureLabel=(r=this._texture)==null?void 0:r.label,t.noMipmap=this._noMipmap,this.name=e,t):null}getClassName(){return"Texture"}dispose(){super.dispose(),this.onLoadObservable.clear(),this._delayedOnLoad=null,this._delayedOnError=null,this._buffer=null}static Parse(e,t,i){if(e.customType){const c=gn.Instantiate(e.customType).Parse(e,t,i);return e.samplingMode&&c.updateSamplingMode&&c._samplingMode&&c._samplingMode!==e.samplingMode&&c.updateSamplingMode(e.samplingMode),c}if(e.isCube&&!e.isRenderTarget)return Z._CubeTextureParser(e,t,i);const r=e.internalTextureUniqueId!==void 0;if(!e.name&&!e.isRenderTarget&&!r)return null;let s;if(r){const l=t.getEngine().getLoadedTexturesCache();for(const c of l)if(c.uniqueId===e.internalTextureUniqueId){s=c;break}}const n=l=>{if(l&&l._texture&&(l._texture._cachedWrapU=null,l._texture._cachedWrapV=null,l._texture._cachedWrapR=null),e.samplingMode){const c=e.samplingMode;l&&l.samplingMode!==c&&l.updateSamplingMode(c)}if(l&&e.animations)for(let c=0;c<e.animations.length;c++){const h=e.animations[c],f=Ui("BABYLON.Animation");f&&l.animations.push(f.Parse(h))}l&&l._texture&&(r&&!s&&l._texture._setUniqueId(e.internalTextureUniqueId),l._texture.label=e.internalTextureLabel)};return ye.Parse(()=>{let l=!0;if(e.noMipmap&&(l=!1),e.mirrorPlane){const c=Z._CreateMirror(e.name,e.renderTargetSize,t,l);return c._waitingRenderList=e.renderList,c.mirrorPlane=hi.FromArray(e.mirrorPlane),n(c),c}else if(e.isRenderTarget){let c=null;if(e.isCube){if(t.reflectionProbes)for(let h=0;h<t.reflectionProbes.length;h++){const f=t.reflectionProbes[h];if(f.name===e.name)return f.cubeTexture}}else c=Z._CreateRenderTargetTexture(e.name,e.renderTargetSize,t,l,e._creationFlags??0),c._waitingRenderList=e.renderList;return n(c),c}else if(e.isVideo){const c=Z._CreateVideoTexture(i+(e.url||e.name),i+(e.src||e.url),t,l,e.invertY,e.samplingMode,e.settings||{});return n(c),c}else{let c;if(e.base64String&&!s)c=Z.CreateFromBase64String(e.base64String,e.base64String,t,!l,e.invertY,e.samplingMode,()=>{n(c)},e._creationFlags??0,e._useSRGBBuffer??!1),c.name=e.name;else{let h;e.name&&(e.name.indexOf("://")>0||e.name.startsWith("data:"))?h=e.name:h=i+e.name,e.url&&(e.url.startsWith("data:")||Z.UseSerializedUrlIfAny)&&(h=e.url);const f={noMipmap:!l,invertY:e.invertY,samplingMode:e.samplingMode,onLoad:()=>{n(c)},internalTexture:s};c=new Z(h,t,f)}return c}},e,t)}static CreateFromBase64String(e,t,i,r,s,n=Z.TRILINEAR_SAMPLINGMODE,o=null,l=null,c=5,h,f){return new Z("data:"+t,i,r,s,n,o,l,e,!1,c,void 0,void 0,h,f)}static LoadFromDataString(e,t,i,r=!1,s,n=!0,o=Z.TRILINEAR_SAMPLINGMODE,l=null,c=null,h=5,f,u){return e.substring(0,5)!=="data:"&&(e="data:"+e),new Z(e,i,s,n,o,l,c,t,r,h,void 0,void 0,f,u)}}Z.SerializeBuffers=!0;Z.ForceSerializeBuffers=!1;Z.OnTextureLoadErrorObservable=new U;Z._SerializeInternalTextureUniqueId=!1;Z._CubeTextureParser=(a,e,t)=>{throw Le("CubeTexture")};Z._CreateMirror=(a,e,t,i)=>{throw Le("MirrorTexture")};Z._CreateRenderTargetTexture=(a,e,t,i,r)=>{throw Le("RenderTargetTexture")};Z.NEAREST_SAMPLINGMODE=1;Z.NEAREST_NEAREST_MIPLINEAR=8;Z.BILINEAR_SAMPLINGMODE=2;Z.LINEAR_LINEAR_MIPNEAREST=11;Z.TRILINEAR_SAMPLINGMODE=3;Z.LINEAR_LINEAR_MIPLINEAR=3;Z.NEAREST_NEAREST_MIPNEAREST=4;Z.NEAREST_LINEAR_MIPNEAREST=5;Z.NEAREST_LINEAR_MIPLINEAR=6;Z.NEAREST_LINEAR=7;Z.NEAREST_NEAREST=1;Z.LINEAR_NEAREST_MIPNEAREST=9;Z.LINEAR_NEAREST_MIPLINEAR=10;Z.LINEAR_LINEAR=2;Z.LINEAR_NEAREST=12;Z.EXPLICIT_MODE=0;Z.SPHERICAL_MODE=1;Z.PLANAR_MODE=2;Z.CUBIC_MODE=3;Z.PROJECTION_MODE=4;Z.SKYBOX_MODE=5;Z.INVCUBIC_MODE=6;Z.EQUIRECTANGULAR_MODE=7;Z.FIXED_EQUIRECTANGULAR_MODE=8;Z.FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;Z.CLAMP_ADDRESSMODE=0;Z.WRAP_ADDRESSMODE=1;Z.MIRROR_ADDRESSMODE=2;Z.UseSerializedUrlIfAny=!1;A([y()],Z.prototype,"url",void 0);A([y()],Z.prototype,"uOffset",void 0);A([y()],Z.prototype,"vOffset",void 0);A([y()],Z.prototype,"uScale",void 0);A([y()],Z.prototype,"vScale",void 0);A([y()],Z.prototype,"uAng",void 0);A([y()],Z.prototype,"vAng",void 0);A([y()],Z.prototype,"wAng",void 0);A([y()],Z.prototype,"uRotationCenter",void 0);A([y()],Z.prototype,"vRotationCenter",void 0);A([y()],Z.prototype,"wRotationCenter",void 0);A([y()],Z.prototype,"homogeneousRotationInUVTransform",void 0);A([y()],Z.prototype,"isBlocking",null);Y("BABYLON.Texture",Z);ye._TextureParser=Z.Parse;class Ia{constructor(){this.previousWorldMatrices={},this.previousBones={}}static AddUniforms(e){e.push("previousWorld","previousViewProjection","mPreviousBones")}static AddSamplers(e){}bindForSubMesh(e,t,i,r,s){if(t.prePassRenderer&&t.prePassRenderer.enabled&&t.prePassRenderer.currentRTisSceneRT&&(t.prePassRenderer.getIndex(2)!==-1||t.prePassRenderer.getIndex(11)!==-1)){this.previousWorldMatrices[i.uniqueId]||(this.previousWorldMatrices[i.uniqueId]=r.clone()),this.previousViewProjection||(this.previousViewProjection=t.getTransformMatrix().clone(),this.currentViewProjection=t.getTransformMatrix().clone());const n=t.getEngine();this.currentViewProjection.updateFlag!==t.getTransformMatrix().updateFlag?(this._lastUpdateFrameId=n.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection),this.currentViewProjection.copyFrom(t.getTransformMatrix())):this._lastUpdateFrameId!==n.frameId&&(this._lastUpdateFrameId=n.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection)),e.setMatrix("previousWorld",this.previousWorldMatrices[i.uniqueId]),e.setMatrix("previousViewProjection",this.previousViewProjection),this.previousWorldMatrices[i.uniqueId]=r.clone()}}}class ll{constructor(e,t,i){this.bu=e,this.bv=t,this.distance=i,this.faceId=0,this.subMeshId=0}}class Or{constructor(e,t,i){this.vectors=Bi(8,m.Zero),this.center=m.Zero(),this.centerWorld=m.Zero(),this.extendSize=m.Zero(),this.extendSizeWorld=m.Zero(),this.directions=Bi(3,m.Zero),this.vectorsWorld=Bi(8,m.Zero),this.minimumWorld=m.Zero(),this.maximumWorld=m.Zero(),this.minimum=m.Zero(),this.maximum=m.Zero(),this._drawWrapperFront=null,this._drawWrapperBack=null,this.reConstruct(e,t,i)}reConstruct(e,t,i){const r=e.x,s=e.y,n=e.z,o=t.x,l=t.y,c=t.z,h=this.vectors;this.minimum.copyFromFloats(r,s,n),this.maximum.copyFromFloats(o,l,c),h[0].copyFromFloats(r,s,n),h[1].copyFromFloats(o,l,c),h[2].copyFromFloats(o,s,n),h[3].copyFromFloats(r,l,n),h[4].copyFromFloats(r,s,c),h[5].copyFromFloats(o,l,n),h[6].copyFromFloats(r,l,c),h[7].copyFromFloats(o,s,c),t.addToRef(e,this.center).scaleInPlace(.5),t.subtractToRef(e,this.extendSize).scaleInPlace(.5),this._worldMatrix=i||P.IdentityReadOnly,this._update(this._worldMatrix)}scale(e){const t=Or._TmpVector3,i=this.maximum.subtractToRef(this.minimum,t[0]),r=i.length();i.normalizeFromLength(r);const s=r*e,n=i.scaleInPlace(s*.5),o=this.center.subtractToRef(n,t[1]),l=this.center.addToRef(n,t[2]);return this.reConstruct(o,l,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){const t=this.minimumWorld,i=this.maximumWorld,r=this.directions,s=this.vectorsWorld,n=this.vectors;if(e.isIdentity()){t.copyFrom(this.minimum),i.copyFrom(this.maximum);for(let o=0;o<8;++o)s[o].copyFrom(n[o]);this.extendSizeWorld.copyFrom(this.extendSize),this.centerWorld.copyFrom(this.center)}else{t.setAll(Number.MAX_VALUE),i.setAll(-Number.MAX_VALUE);for(let o=0;o<8;++o){const l=s[o];m.TransformCoordinatesToRef(n[o],e,l),t.minimizeInPlace(l),i.maximizeInPlace(l)}i.subtractToRef(t,this.extendSizeWorld).scaleInPlace(.5),i.addToRef(t,this.centerWorld).scaleInPlace(.5)}m.FromArrayToRef(e.m,0,r[0]),m.FromArrayToRef(e.m,4,r[1]),m.FromArrayToRef(e.m,8,r[2]),this._worldMatrix=e}isInFrustum(e){return Or.IsInFrustum(this.vectorsWorld,e)}isCompletelyInFrustum(e){return Or.IsCompletelyInFrustum(this.vectorsWorld,e)}intersectsPoint(e){const t=this.minimumWorld,i=this.maximumWorld,r=t.x,s=t.y,n=t.z,o=i.x,l=i.y,c=i.z,h=e.x,f=e.y,u=e.z,d=-Ke;return!(o-h<d||d>h-r||l-f<d||d>f-s||c-u<d||d>u-n)}intersectsSphere(e){return Or.IntersectsSphere(this.minimumWorld,this.maximumWorld,e.centerWorld,e.radiusWorld)}intersectsMinMax(e,t){const i=this.minimumWorld,r=this.maximumWorld,s=i.x,n=i.y,o=i.z,l=r.x,c=r.y,h=r.z,f=e.x,u=e.y,d=e.z,_=t.x,p=t.y,g=t.z;return!(l<f||s>_||c<u||n>p||h<d||o>g)}dispose(){var e,t;(e=this._drawWrapperFront)==null||e.dispose(),(t=this._drawWrapperBack)==null||t.dispose()}static Intersects(e,t){return e.intersectsMinMax(t.minimumWorld,t.maximumWorld)}static IntersectsSphere(e,t,i,r){const s=Or._TmpVector3[0];return m.ClampToRef(i,e,t,s),m.DistanceSquared(i,s)<=r*r}static IsCompletelyInFrustum(e,t){for(let i=0;i<6;++i){const r=t[i];for(let s=0;s<8;++s)if(r.dotCoordinate(e[s])<0)return!1}return!0}static IsInFrustum(e,t){for(let i=0;i<6;++i){let r=!0;const s=t[i];for(let n=0;n<8;++n)if(s.dotCoordinate(e[n])>=0){r=!1;break}if(r)return!1}return!0}}Or._TmpVector3=Bi(3,m.Zero);class Lr{constructor(e,t,i){this.center=m.Zero(),this.centerWorld=m.Zero(),this.minimum=m.Zero(),this.maximum=m.Zero(),this.reConstruct(e,t,i)}reConstruct(e,t,i){this.minimum.copyFrom(e),this.maximum.copyFrom(t);const r=m.Distance(e,t);t.addToRef(e,this.center).scaleInPlace(.5),this.radius=r*.5,this._update(i||P.IdentityReadOnly)}scale(e){const t=this.radius*e,i=Lr._TmpVector3,r=i[0].setAll(t),s=this.center.subtractToRef(r,i[1]),n=this.center.addToRef(r,i[2]);return this.reConstruct(s,n,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){if(e.isIdentity())this.centerWorld.copyFrom(this.center),this.radiusWorld=this.radius;else{m.TransformCoordinatesToRef(this.center,e,this.centerWorld);const t=Lr._TmpVector3[0];m.TransformNormalFromFloatsToRef(1,1,1,e,t),this.radiusWorld=Math.max(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z))*this.radius}}isInFrustum(e){const t=this.centerWorld,i=this.radiusWorld;for(let r=0;r<6;r++)if(e[r].dotCoordinate(t)<=-i)return!1;return!0}isCenterInFrustum(e){const t=this.centerWorld;for(let i=0;i<6;i++)if(e[i].dotCoordinate(t)<0)return!1;return!0}intersectsPoint(e){const t=m.DistanceSquared(this.centerWorld,e);return!(this.radiusWorld*this.radiusWorld<t)}static Intersects(e,t){const i=m.DistanceSquared(e.centerWorld,t.centerWorld),r=e.radiusWorld+t.radiusWorld;return!(r*r<i)}static CreateFromCenterAndRadius(e,t,i){this._TmpVector3[0].copyFrom(e),this._TmpVector3[1].copyFromFloats(0,0,t),this._TmpVector3[2].copyFrom(e),this._TmpVector3[0].addInPlace(this._TmpVector3[1]),this._TmpVector3[2].subtractInPlace(this._TmpVector3[1]);const r=new Lr(this._TmpVector3[0],this._TmpVector3[2]);return i?r._worldMatrix=i:r._worldMatrix=P.Identity(),r}}Lr._TmpVector3=Bi(3,m.Zero);const Fo={min:0,max:0},wo={min:0,max:0},Xh=(a,e,t)=>{const i=m.Dot(e.centerWorld,a),r=Math.abs(m.Dot(e.directions[0],a))*e.extendSize.x,s=Math.abs(m.Dot(e.directions[1],a))*e.extendSize.y,n=Math.abs(m.Dot(e.directions[2],a))*e.extendSize.z,o=r+s+n;t.min=i-o,t.max=i+o},_i=(a,e,t)=>(Xh(a,e,Fo),Xh(a,t,wo),!(Fo.min>wo.max||wo.min>Fo.max));class Mi{constructor(e,t,i){this._isLocked=!1,this.boundingBox=new Or(e,t,i),this.boundingSphere=new Lr(e,t,i)}reConstruct(e,t,i){this.boundingBox.reConstruct(e,t,i),this.boundingSphere.reConstruct(e,t,i)}get minimum(){return this.boundingBox.minimum}get maximum(){return this.boundingBox.maximum}get isLocked(){return this._isLocked}set isLocked(e){this._isLocked=e}update(e){this._isLocked||(this.boundingBox._update(e),this.boundingSphere._update(e))}centerOn(e,t){const i=Mi._TmpVector3[0].copyFrom(e).subtractInPlace(t),r=Mi._TmpVector3[1].copyFrom(e).addInPlace(t);return this.boundingBox.reConstruct(i,r,this.boundingBox.getWorldMatrix()),this.boundingSphere.reConstruct(i,r,this.boundingBox.getWorldMatrix()),this}encapsulate(e){const t=m.Minimize(this.minimum,e),i=m.Maximize(this.maximum,e);return this.reConstruct(t,i,this.boundingBox.getWorldMatrix()),this}encapsulateBoundingInfo(e){const t=F.Matrix[0];this.boundingBox.getWorldMatrix().invertToRef(t);const i=F.Vector3[0];return m.TransformCoordinatesToRef(e.boundingBox.minimumWorld,t,i),this.encapsulate(i),m.TransformCoordinatesToRef(e.boundingBox.maximumWorld,t,i),this.encapsulate(i),this}scale(e){return this.boundingBox.scale(e),this.boundingSphere.scale(e),this}isInFrustum(e,t=0){return(t===2||t===3)&&this.boundingSphere.isCenterInFrustum(e)?!0:this.boundingSphere.isInFrustum(e)?t===1||t===3?!0:this.boundingBox.isInFrustum(e):!1}get diagonalLength(){const e=this.boundingBox;return e.maximumWorld.subtractToRef(e.minimumWorld,Mi._TmpVector3[0]).length()}isCompletelyInFrustum(e){return this.boundingBox.isCompletelyInFrustum(e)}_checkCollision(e){return e._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)}intersectsPoint(e){return!(!this.boundingSphere.centerWorld||!this.boundingSphere.intersectsPoint(e)||!this.boundingBox.intersectsPoint(e))}intersects(e,t){if(!Lr.Intersects(this.boundingSphere,e.boundingSphere)||!Or.Intersects(this.boundingBox,e.boundingBox))return!1;if(!t)return!0;const i=this.boundingBox,r=e.boundingBox;return!(!_i(i.directions[0],i,r)||!_i(i.directions[1],i,r)||!_i(i.directions[2],i,r)||!_i(r.directions[0],i,r)||!_i(r.directions[1],i,r)||!_i(r.directions[2],i,r)||!_i(m.Cross(i.directions[0],r.directions[0]),i,r)||!_i(m.Cross(i.directions[0],r.directions[1]),i,r)||!_i(m.Cross(i.directions[0],r.directions[2]),i,r)||!_i(m.Cross(i.directions[1],r.directions[0]),i,r)||!_i(m.Cross(i.directions[1],r.directions[1]),i,r)||!_i(m.Cross(i.directions[1],r.directions[2]),i,r)||!_i(m.Cross(i.directions[2],r.directions[0]),i,r)||!_i(m.Cross(i.directions[2],r.directions[1]),i,r)||!_i(m.Cross(i.directions[2],r.directions[2]),i,r))}}Mi._TmpVector3=Bi(2,m.Zero);class Fa{static extractMinAndMaxIndexed(e,t,i,r,s,n){for(let o=i;o<i+r;o++){const l=t[o]*3,c=e[l],h=e[l+1],f=e[l+2];s.minimizeInPlaceFromFloats(c,h,f),n.maximizeInPlaceFromFloats(c,h,f)}}static extractMinAndMax(e,t,i,r,s,n){for(let o=t,l=t*r;o<t+i;o++,l+=r){const c=e[l],h=e[l+1],f=e[l+2];s.minimizeInPlaceFromFloats(c,h,f),n.maximizeInPlaceFromFloats(c,h,f)}}}A([Fr.filter((...[a,e])=>!Array.isArray(a)&&!Array.isArray(e))],Fa,"extractMinAndMaxIndexed",null);A([Fr.filter((...[a])=>!Array.isArray(a))],Fa,"extractMinAndMax",null);function lR(a,e,t,i,r=null){const s=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return Fa.extractMinAndMaxIndexed(a,e,t,i,s,n),r&&(s.x-=s.x*r.x+r.y,s.y-=s.y*r.x+r.y,s.z-=s.z*r.x+r.y,n.x+=n.x*r.x+r.y,n.y+=n.y*r.x+r.y,n.z+=n.z*r.x+r.y),{minimum:s,maximum:n}}function Fm(a,e,t,i=null,r){const s=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return r||(r=3),Fa.extractMinAndMax(a,e,t,r,s,n),i&&(s.x-=s.x*i.x+i.y,s.y-=s.y*i.x+i.y,s.z-=s.z*i.x+i.y,n.x+=n.x*i.x+i.y,n.y+=n.y*i.x+i.y,n.z+=n.z*i.x+i.y),{minimum:s,maximum:n}}class wa{static GetEffect(e){return e.getPipelineContext===void 0?e.effect:e}constructor(e,t=!0){this._wasPreviouslyReady=!1,this._forceRebindOnNextCall=!0,this._wasPreviouslyUsingInstances=null,this.effect=null,this.defines=null,this.drawContext=e.createDrawContext(),t&&(this.materialContext=e.createMaterialContext())}setEffect(e,t,i=!0){var r;this.effect=e,t!==void 0&&(this.defines=t),i&&((r=this.drawContext)==null||r.reset())}dispose(e=!1){var t;if(this.effect){const i=this.effect;e?i.dispose():vs.SetImmediate(()=>{i.getEngine().onEndFrameObservable.addOnce(()=>{i.dispose()})}),this.effect=null}(t=this.drawContext)==null||t.dispose()}}class Ei{get materialDefines(){var e;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.defines:(e=this._getDrawWrapper())==null?void 0:e.defines}set materialDefines(e){const t=this._mainDrawWrapperOverride??this._getDrawWrapper(void 0,!0);t.defines=e}_getDrawWrapper(e,t=!1){e=e??this._engine.currentRenderPassId;let i=this._drawWrappers[e];return!i&&t&&(this._drawWrappers[e]=i=new wa(this._mesh.getScene().getEngine())),i}_removeDrawWrapper(e,t=!0,i=!1){var r;t&&((r=this._drawWrappers[e])==null||r.dispose(i)),this._drawWrappers[e]=void 0}get effect(){var e;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.effect:((e=this._getDrawWrapper())==null?void 0:e.effect)??null}get _drawWrapper(){return this._mainDrawWrapperOverride??this._getDrawWrapper(void 0,!0)}get _drawWrapperOverride(){return this._mainDrawWrapperOverride}_setMainDrawWrapperOverride(e){this._mainDrawWrapperOverride=e}setEffect(e,t=null,i,r=!0){const s=this._drawWrapper;s.setEffect(e,t,r),i!==void 0&&(s.materialContext=i),e||(s.defines=null,s.materialContext=void 0)}resetDrawCache(e,t=!1){if(this._drawWrappers)if(e!==void 0){this._removeDrawWrapper(e,!0,t);return}else for(const i of this._drawWrappers)i==null||i.dispose(t);this._drawWrappers=[]}static AddToMesh(e,t,i,r,s,n,o,l=!0){return new Ei(e,t,i,r,s,n,o,l)}constructor(e,t,i,r,s,n,o,l=!0,c=!0){this.materialIndex=e,this.verticesStart=t,this.verticesCount=i,this.indexStart=r,this.indexCount=s,this._mainDrawWrapperOverride=null,this._linesIndexCount=0,this._linesIndexBuffer=null,this._lastColliderWorldVertices=null,this._lastColliderTransformMatrix=null,this._wasDispatched=!1,this._renderId=0,this._alphaIndex=0,this._distanceToCamera=0,this._currentMaterial=null,this._mesh=n,this._renderingMesh=o||n,c&&n.subMeshes.push(this),this._engine=this._mesh.getScene().getEngine(),this.resetDrawCache(),this._trianglePlanes=[],this._id=n.subMeshes.length-1,l&&(this.refreshBoundingInfo(),n.computeWorldMatrix(!0))}get IsGlobal(){return this.verticesStart===0&&this.verticesCount===this._mesh.getTotalVertices()&&this.indexStart===0&&this.indexCount===this._mesh.getTotalIndices()}getBoundingInfo(){return this.IsGlobal||this._mesh.hasThinInstances?this._mesh.getBoundingInfo():this._boundingInfo}setBoundingInfo(e){return this._boundingInfo=e,this}getMesh(){return this._mesh}getRenderingMesh(){return this._renderingMesh}getReplacementMesh(){return this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null}getEffectiveMesh(){const e=this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null;return e||this._renderingMesh}getMaterial(e=!0){const t=this._renderingMesh.getMaterialForRenderPass(this._engine.currentRenderPassId)??this._renderingMesh.material;if(t){if(this._isMultiMaterial(t)){const i=t.getSubMaterial(this.materialIndex);return this._currentMaterial!==i&&(this._currentMaterial=i,this.resetDrawCache()),i}}else return e&&this._mesh.getScene()._hasDefaultMaterial?this._mesh.getScene().defaultMaterial:null;return t}_isMultiMaterial(e){return e.getSubMaterial!==void 0}refreshBoundingInfo(e=null){if(this._lastColliderWorldVertices=null,this.IsGlobal||!this._renderingMesh||!this._renderingMesh.geometry)return this;if(e||(e=this._renderingMesh.getVerticesData(x.PositionKind)),!e)return this._boundingInfo=this._mesh.getBoundingInfo(),this;const t=this._renderingMesh.getIndices();let i;if(this.indexStart===0&&this.indexCount===t.length){const r=this._renderingMesh.getBoundingInfo();i={minimum:r.minimum.clone(),maximum:r.maximum.clone()}}else i=lR(e,t,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias);return this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new Mi(i.minimum,i.maximum),this}_checkCollision(e){return this.getBoundingInfo()._checkCollision(e)}updateBoundingInfo(e){let t=this.getBoundingInfo();return t||(this.refreshBoundingInfo(),t=this.getBoundingInfo()),t&&t.update(e),this}isInFrustum(e){const t=this.getBoundingInfo();return t?t.isInFrustum(e,this._mesh.cullingStrategy):!1}isCompletelyInFrustum(e){const t=this.getBoundingInfo();return t?t.isCompletelyInFrustum(e):!1}render(e){return this._renderingMesh.render(this,e,this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:void 0),this}_getLinesIndexBuffer(e,t){if(!this._linesIndexBuffer){const i=Math.floor(this.indexCount/3)*6,s=this.verticesStart+this.verticesCount>65535?new Uint32Array(i):new Uint16Array(i);let n=0;if(e.length===0)for(let o=this.indexStart;o<this.indexStart+this.indexCount;o+=3)s[n++]=o,s[n++]=o+1,s[n++]=o+1,s[n++]=o+2,s[n++]=o+2,s[n++]=o;else for(let o=this.indexStart;o<this.indexStart+this.indexCount;o+=3)s[n++]=e[o],s[n++]=e[o+1],s[n++]=e[o+1],s[n++]=e[o+2],s[n++]=e[o+2],s[n++]=e[o];this._linesIndexBuffer=t.createIndexBuffer(s),this._linesIndexCount=s.length}return this._linesIndexBuffer}canIntersects(e){const t=this.getBoundingInfo();return t?e.intersectsBox(t.boundingBox):!1}intersects(e,t,i,r,s){const n=this.getMaterial();if(!n)return null;let o=3,l=!1;switch(n.fillMode){case 3:case 5:case 6:case 8:return null;case 7:o=1,l=!0;break}return n.fillMode===4?i.length?this._intersectLines(e,t,i,this._mesh.intersectionThreshold,r):this._intersectUnIndexedLines(e,t,i,this._mesh.intersectionThreshold,r):!i.length&&this._mesh._unIndexed?this._intersectUnIndexedTriangles(e,t,i,r,s):this._intersectTriangles(e,t,i,o,l,r,s)}_intersectLines(e,t,i,r,s){let n=null;for(let o=this.indexStart;o<this.indexStart+this.indexCount;o+=2){const l=t[i[o]],c=t[i[o+1]],h=e.intersectionSegment(l,c,r);if(!(h<0)&&(s||!n||h<n.distance)&&(n=new ll(null,null,h),n.faceId=o/2,s))break}return n}_intersectUnIndexedLines(e,t,i,r,s){let n=null;for(let o=this.verticesStart;o<this.verticesStart+this.verticesCount;o+=2){const l=t[o],c=t[o+1],h=e.intersectionSegment(l,c,r);if(!(h<0)&&(s||!n||h<n.distance)&&(n=new ll(null,null,h),n.faceId=o/2,s))break}return n}_intersectTriangles(e,t,i,r,s,n,o){let l=null,c=-1;for(let h=this.indexStart;h<this.indexStart+this.indexCount-(3-r);h+=r){c++;const f=i[h],u=i[h+1],d=i[h+2];if(s&&d===4294967295){h+=2;continue}const _=t[f],p=t[u],g=t[d];if(!_||!p||!g||o&&!o(_,p,g,e,f,u,d))continue;const E=e.intersectsTriangle(_,p,g);if(E){if(E.distance<0)continue;if((n||!l||E.distance<l.distance)&&(l=E,l.faceId=c,n))break}}return l}_intersectUnIndexedTriangles(e,t,i,r,s){let n=null;for(let o=this.verticesStart;o<this.verticesStart+this.verticesCount;o+=3){const l=t[o],c=t[o+1],h=t[o+2];if(s&&!s(l,c,h,e,-1,-1,-1))continue;const f=e.intersectsTriangle(l,c,h);if(f){if(f.distance<0)continue;if((r||!n||f.distance<n.distance)&&(n=f,n.faceId=o/3,r))break}}return n}_rebuild(){this._linesIndexBuffer&&(this._linesIndexBuffer=null)}clone(e,t){const i=new Ei(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,e,t,!1);if(!this.IsGlobal){const r=this.getBoundingInfo();if(!r)return i;i._boundingInfo=new Mi(r.minimum,r.maximum)}return i}dispose(e=!1){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);const t=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(t,1),this.resetDrawCache(void 0,e)}getClassName(){return"SubMesh"}static CreateFromIndices(e,t,i,r,s,n=!0){let o=Number.MAX_VALUE,l=-Number.MAX_VALUE;const h=(s||r).getIndices();for(let f=t;f<t+i;f++){const u=h[f];u<o&&(o=u),u>l&&(l=u)}return new Ei(e,o,l-o+1,t,i,r,s,n)}}class Vr{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=519,this.funcRef=1,this.funcMask=255,this.opStencilFail=7680,this.opDepthFail=7680,this.opStencilDepthPass=7681}get func(){return this._func}set func(e){this._func=e}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef=e}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask=e}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail=e}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail=e}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass=e}get mask(){return this._mask}set mask(e){this._mask=e}get enabled(){return this._enabled}set enabled(e){this._enabled=e}getClassName(){return"MaterialStencilState"}copyTo(e){ye.Clone(()=>e,this)}serialize(){return ye.Serialize(this)}parse(e,t,i){ye.Parse(()=>this,e,t,i)}}A([y()],Vr.prototype,"func",null);A([y()],Vr.prototype,"funcRef",null);A([y()],Vr.prototype,"funcMask",null);A([y()],Vr.prototype,"opStencilFail",null);A([y()],Vr.prototype,"opDepthFail",null);A([y()],Vr.prototype,"opStencilDepthPass",null);A([y()],Vr.prototype,"mask",null);A([y()],Vr.prototype,"enabled",null);function Ba(a){a.indexOf("vClipPlane")===-1&&a.push("vClipPlane"),a.indexOf("vClipPlane2")===-1&&a.push("vClipPlane2"),a.indexOf("vClipPlane3")===-1&&a.push("vClipPlane3"),a.indexOf("vClipPlane4")===-1&&a.push("vClipPlane4"),a.indexOf("vClipPlane5")===-1&&a.push("vClipPlane5"),a.indexOf("vClipPlane6")===-1&&a.push("vClipPlane6")}function cR(a,e,t){const i=!!(a.clipPlane??e.clipPlane),r=!!(a.clipPlane2??e.clipPlane2),s=!!(a.clipPlane3??e.clipPlane3),n=!!(a.clipPlane4??e.clipPlane4),o=!!(a.clipPlane5??e.clipPlane5),l=!!(a.clipPlane6??e.clipPlane6);i&&t.push("#define CLIPPLANE"),r&&t.push("#define CLIPPLANE2"),s&&t.push("#define CLIPPLANE3"),n&&t.push("#define CLIPPLANE4"),o&&t.push("#define CLIPPLANE5"),l&&t.push("#define CLIPPLANE6")}function hR(a,e,t){let i=!1;const r=!!(a.clipPlane??e.clipPlane),s=!!(a.clipPlane2??e.clipPlane2),n=!!(a.clipPlane3??e.clipPlane3),o=!!(a.clipPlane4??e.clipPlane4),l=!!(a.clipPlane5??e.clipPlane5),c=!!(a.clipPlane6??e.clipPlane6);return t.CLIPPLANE!==r&&(t.CLIPPLANE=r,i=!0),t.CLIPPLANE2!==s&&(t.CLIPPLANE2=s,i=!0),t.CLIPPLANE3!==n&&(t.CLIPPLANE3=n,i=!0),t.CLIPPLANE4!==o&&(t.CLIPPLANE4=o,i=!0),t.CLIPPLANE5!==l&&(t.CLIPPLANE5=l,i=!0),t.CLIPPLANE6!==c&&(t.CLIPPLANE6=c,i=!0),i}function Ua(a,e,t){let i=e.clipPlane??t.clipPlane;Os(a,"vClipPlane",i),i=e.clipPlane2??t.clipPlane2,Os(a,"vClipPlane2",i),i=e.clipPlane3??t.clipPlane3,Os(a,"vClipPlane3",i),i=e.clipPlane4??t.clipPlane4,Os(a,"vClipPlane4",i),i=e.clipPlane5??t.clipPlane5,Os(a,"vClipPlane5",i),i=e.clipPlane6??t.clipPlane6,Os(a,"vClipPlane6",i)}function Os(a,e,t){t&&a.setFloat4(e,t.normal.x,t.normal.y,t.normal.z,t.d)}const Hh=ae.Black(),cs={NUM_MORPH_INFLUENCERS:0,NORMAL:!1,TANGENT:!1,UV:!1,UV2:!1,COLOR:!1};function Bn(a,e,t){if(!a||a.LOGARITHMICDEPTH||a.indexOf&&a.indexOf("LOGARITHMICDEPTH")>=0){const i=t.activeCamera;i.mode===1&&B.Error("Logarithmic depth is not compatible with orthographic cameras!",20),e.setFloat("logarithmicDepthConstant",2/(Math.log(i.maxZ+1)/Math.LN2))}}function Va(a,e,t,i=!1){t&&a.fogEnabled&&(!e||e.applyFog)&&a.fogMode!==0&&(t.setFloat4("vFogInfos",a.fogMode,a.fogStart,a.fogEnd,a.fogDensity),i?(a.fogColor.toLinearSpaceToRef(Hh,a.getEngine().useExactSrgbConversions),t.setColor3("vFogColor",Hh)):t.setColor3("vFogColor",a.fogColor))}function fR(a,e,t,i,r,s,n,o,l,c){const h=a.numMaxInfluencers||a.numInfluencers;return h<=0?0:(e.push("#define MORPHTARGETS"),a.hasPositions&&e.push("#define MORPHTARGETTEXTURE_HASPOSITIONS"),a.hasNormals&&e.push("#define MORPHTARGETTEXTURE_HASNORMALS"),a.hasTangents&&e.push("#define MORPHTARGETTEXTURE_HASTANGENTS"),a.hasUVs&&e.push("#define MORPHTARGETTEXTURE_HASUVS"),a.hasUV2s&&e.push("#define MORPHTARGETTEXTURE_HASUV2S"),a.hasColors&&e.push("#define MORPHTARGETTEXTURE_HASCOLORS"),a.supportsPositions&&r&&e.push("#define MORPHTARGETS_POSITION"),a.supportsNormals&&s&&e.push("#define MORPHTARGETS_NORMAL"),a.supportsTangents&&n&&e.push("#define MORPHTARGETS_TANGENT"),a.supportsUVs&&o&&e.push("#define MORPHTARGETS_UV"),a.supportsUV2s&&l&&e.push("#define MORPHTARGETS_UV2"),a.supportsColors&&c&&e.push("#define MORPHTARGETS_COLOR"),e.push("#define NUM_MORPH_INFLUENCERS "+h),a.isUsingTextureForTargets&&e.push("#define MORPHTARGETS_TEXTURE"),cs.NUM_MORPH_INFLUENCERS=h,cs.NORMAL=s,cs.TANGENT=n,cs.UV=o,cs.UV2=l,cs.COLOR=c,Ac(t,i,cs,r),h)}function Ac(a,e,t,i=!0){const r=t.NUM_MORPH_INFLUENCERS;if(r>0&&Re.LastCreatedEngine){const s=Re.LastCreatedEngine.getCaps().maxVertexAttribs,n=e.morphTargetManager;if(n!=null&&n.isUsingTextureForTargets)return;const o=n&&n.supportsPositions&&i,l=n&&n.supportsNormals&&t.NORMAL,c=n&&n.supportsTangents&&t.TANGENT,h=n&&n.supportsUVs&&t.UV1,f=n&&n.supportsUV2s&&t.UV2,u=n&&n.supportsColors&&t.COLOR;for(let d=0;d<r;d++)o&&a.push("position"+d),l&&a.push("normal"+d),c&&a.push("tangent"+d),h&&a.push("uv_"+d),f&&a.push("uv2_"+d),u&&a.push("color"+d),a.length>s&&B.Error("Cannot add more vertex attributes for mesh "+e.name)}}function wm(a,e=!1){a.push("world0"),a.push("world1"),a.push("world2"),a.push("world3"),e&&(a.push("previousWorld0"),a.push("previousWorld1"),a.push("previousWorld2"),a.push("previousWorld3"))}function Rc(a,e){const t=a.morphTargetManager;!a||!t||e.setFloatArray("morphTargetInfluences",t.influences)}function Bm(a,e){e.bindToEffect(a,"Scene")}function ht(a,e,t){e._needUVs=!0,e[t]=!0,a.optimizeUVAllocation&&a.getTextureMatrix().isIdentityAs3x2()?(e[t+"DIRECTUV"]=a.coordinatesIndex+1,e["MAINUV"+(a.coordinatesIndex+1)]=!0):e[t+"DIRECTUV"]=0}function ft(a,e,t){const i=a.getTextureMatrix();e.updateMatrix(t+"Matrix",i)}function Cc(a,e,t){t.BAKED_VERTEX_ANIMATION_TEXTURE&&t.INSTANCES&&a.push("bakedVertexAnimationSettingsInstanced")}function uR(a,e){return e.set(a),e}function Ga(a,e,t){if(!(!e||!a)&&(a.computeBonesUsingShaders&&e._bonesComputationForcedToCPU&&(a.computeBonesUsingShaders=!1),a.useBones&&a.computeBonesUsingShaders&&a.skeleton)){const i=a.skeleton;if(i.isUsingTextureForMatrices&&e.getUniformIndex("boneTextureWidth")>-1){const r=i.getTransformMatrixTexture(a);e.setTexture("boneSampler",r),e.setFloat("boneTextureWidth",4*(i.bones.length+1))}else{const r=i.getTransformMatrices(a);r&&(e.setMatrices("mBones",r),t&&a.getScene().prePassRenderer&&a.getScene().prePassRenderer.getIndex(2)&&(t.previousBones[a.uniqueId]||(t.previousBones[a.uniqueId]=r.slice()),e.setMatrices("mPreviousBones",t.previousBones[a.uniqueId]),uR(r,t.previousBones[a.uniqueId])))}}}function dR(a,e,t,i,r,s=!0){a._bindLight(e,t,i,r,s)}function Ic(a,e,t,i,r=4){const s=Math.min(e.lightSources.length,r);for(let n=0;n<s;n++){const o=e.lightSources[n];dR(o,n,a,t,typeof i=="boolean"?i:i.SPECULARTERM,e.receiveShadows)}}function bc(a,e,t,i){t.NUM_BONE_INFLUENCERS>0&&(i.addCPUSkinningFallback(0,e),a.push("matricesIndices"),a.push("matricesWeights"),t.NUM_BONE_INFLUENCERS>4&&(a.push("matricesIndicesExtra"),a.push("matricesWeightsExtra")))}function xc(a,e){(e.INSTANCES||e.THIN_INSTANCES)&&wm(a,!!e.PREPASS_VELOCITY),e.INSTANCESCOLOR&&a.push("instanceColor")}function yc(a,e,t=4,i=0){let r=0;for(let s=0;s<t&&a["LIGHT"+s];s++)s>0&&(r=i+s,e.addFallback(r,"LIGHT"+s)),a.SHADOWS||(a["SHADOW"+s]&&e.addFallback(i,"SHADOW"+s),a["SHADOWPCF"+s]&&e.addFallback(i,"SHADOWPCF"+s),a["SHADOWPCSS"+s]&&e.addFallback(i,"SHADOWPCSS"+s),a["SHADOWPOISSON"+s]&&e.addFallback(i,"SHADOWPOISSON"+s),a["SHADOWESM"+s]&&e.addFallback(i,"SHADOWESM"+s),a["SHADOWCLOSEESM"+s]&&e.addFallback(i,"SHADOWCLOSEESM"+s));return r++}function _R(a,e){return e.fogEnabled&&a.applyFog&&e.fogMode!==0}function Mc(a,e,t,i,r,s,n,o=!1){n._areMiscDirty&&(n.LOGARITHMICDEPTH=t,n.POINTSIZE=i,n.FOG=r&&_R(a,e),n.NONUNIFORMSCALING=a.nonUniformScaling,n.ALPHATEST=s,n.DECAL_AFTER_DETAIL=o)}function Pc(a,e,t,i,r=4,s=!1){if(!t._areLightsDirty)return t._needNormals;let n=0;const o={needNormals:t._needNormals,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};if(a.lightsEnabled&&!s){for(const c of e.lightSources)if(pR(a,e,c,n,t,i,o),n++,n===r)break}t.SPECULARTERM=o.specularEnabled,t.SHADOWS=o.shadowEnabled;for(let c=n;c<r;c++)t["LIGHT"+c]!==void 0&&(t["LIGHT"+c]=!1,t["HEMILIGHT"+c]=!1,t["POINTLIGHT"+c]=!1,t["DIRLIGHT"+c]=!1,t["SPOTLIGHT"+c]=!1,t["AREALIGHT"+c]=!1,t["SHADOW"+c]=!1,t["SHADOWCSM"+c]=!1,t["SHADOWCSMDEBUG"+c]=!1,t["SHADOWCSMNUM_CASCADES"+c]=!1,t["SHADOWCSMUSESHADOWMAXZ"+c]=!1,t["SHADOWCSMNOBLEND"+c]=!1,t["SHADOWCSM_RIGHTHANDED"+c]=!1,t["SHADOWPCF"+c]=!1,t["SHADOWPCSS"+c]=!1,t["SHADOWPOISSON"+c]=!1,t["SHADOWESM"+c]=!1,t["SHADOWCLOSEESM"+c]=!1,t["SHADOWCUBE"+c]=!1,t["SHADOWLOWQUALITY"+c]=!1,t["SHADOWMEDIUMQUALITY"+c]=!1);const l=a.getEngine().getCaps();return t.SHADOWFLOAT===void 0&&(o.needRebuild=!0),t.SHADOWFLOAT=o.shadowEnabled&&(l.textureFloatRender&&l.textureFloatLinearFiltering||l.textureHalfFloatRender&&l.textureHalfFloatLinearFiltering),t.LIGHTMAPEXCLUDED=o.lightmapMode,o.needRebuild&&t.rebuild(),o.needNormals}function pR(a,e,t,i,r,s,n){switch(n.needNormals=!0,r["LIGHT"+i]===void 0&&(n.needRebuild=!0),r["LIGHT"+i]=!0,r["SPOTLIGHT"+i]=!1,r["HEMILIGHT"+i]=!1,r["POINTLIGHT"+i]=!1,r["DIRLIGHT"+i]=!1,r["AREALIGHT"+i]=!1,t.prepareLightSpecificDefines(r,i),r["LIGHT_FALLOFF_PHYSICAL"+i]=!1,r["LIGHT_FALLOFF_GLTF"+i]=!1,r["LIGHT_FALLOFF_STANDARD"+i]=!1,t.falloffType){case it.FALLOFF_GLTF:r["LIGHT_FALLOFF_GLTF"+i]=!0;break;case it.FALLOFF_PHYSICAL:r["LIGHT_FALLOFF_PHYSICAL"+i]=!0;break;case it.FALLOFF_STANDARD:r["LIGHT_FALLOFF_STANDARD"+i]=!0;break}if(s&&!t.specular.equalsFloats(0,0,0)&&(n.specularEnabled=!0),r["SHADOW"+i]=!1,r["SHADOWCSM"+i]=!1,r["SHADOWCSMDEBUG"+i]=!1,r["SHADOWCSMNUM_CASCADES"+i]=!1,r["SHADOWCSMUSESHADOWMAXZ"+i]=!1,r["SHADOWCSMNOBLEND"+i]=!1,r["SHADOWCSM_RIGHTHANDED"+i]=!1,r["SHADOWPCF"+i]=!1,r["SHADOWPCSS"+i]=!1,r["SHADOWPOISSON"+i]=!1,r["SHADOWESM"+i]=!1,r["SHADOWCLOSEESM"+i]=!1,r["SHADOWCUBE"+i]=!1,r["SHADOWLOWQUALITY"+i]=!1,r["SHADOWMEDIUMQUALITY"+i]=!1,e&&e.receiveShadows&&a.shadowsEnabled&&t.shadowEnabled){const o=t.getShadowGenerator(a.activeCamera)??t.getShadowGenerator();if(o){const l=o.getShadowMap();l&&l.renderList&&l.renderList.length>0&&(n.shadowEnabled=!0,o.prepareDefines(r,i))}}t.lightmapMode!=it.LIGHTMAP_DEFAULT?(n.lightmapMode=!0,r["LIGHTMAPEXCLUDED"+i]=!0,r["LIGHTMAPNOSPECULAR"+i]=t.lightmapMode==it.LIGHTMAP_SHADOWSONLY):(r["LIGHTMAPEXCLUDED"+i]=!1,r["LIGHTMAPNOSPECULAR"+i]=!1)}function Oc(a,e,t,i,r,s=null,n=!1){let o=Vm(a,i);s!==!1&&(o=hR(t,a,i)),i.DEPTHPREPASS!==!e.getColorWrite()&&(i.DEPTHPREPASS=!i.DEPTHPREPASS,o=!0),i.INSTANCES!==r&&(i.INSTANCES=r,o=!0),i.THIN_INSTANCES!==n&&(i.THIN_INSTANCES=n,o=!0),o&&i.markAsUnprocessed()}function mR(a,e){if(a.useBones&&a.computeBonesUsingShaders&&a.skeleton){e.NUM_BONE_INFLUENCERS=a.numBoneInfluencers;const t=e.BONETEXTURE!==void 0;if(a.skeleton.isUsingTextureForMatrices&&t)e.BONETEXTURE=!0;else{e.BonesPerMesh=a.skeleton.bones.length+1,e.BONETEXTURE=t?!1:void 0;const i=a.getScene().prePassRenderer;if(i&&i.enabled){const r=i.excludedSkinnedMesh.indexOf(a)===-1;e.BONES_VELOCITY_ENABLED=r}}}else e.NUM_BONE_INFLUENCERS=0,e.BonesPerMesh=0,e.BONETEXTURE!==void 0&&(e.BONETEXTURE=!1)}function gR(a,e){const t=a.morphTargetManager;t?(e.MORPHTARGETS_UV=t.supportsUVs&&e.UV1,e.MORPHTARGETS_UV2=t.supportsUV2s&&e.UV2,e.MORPHTARGETS_TANGENT=t.supportsTangents&&e.TANGENT,e.MORPHTARGETS_NORMAL=t.supportsNormals&&e.NORMAL,e.MORPHTARGETS_POSITION=t.supportsPositions,e.MORPHTARGETS_COLOR=t.supportsColors,e.MORPHTARGETTEXTURE_HASUVS=t.hasUVs,e.MORPHTARGETTEXTURE_HASUV2S=t.hasUV2s,e.MORPHTARGETTEXTURE_HASTANGENTS=t.hasTangents,e.MORPHTARGETTEXTURE_HASNORMALS=t.hasNormals,e.MORPHTARGETTEXTURE_HASPOSITIONS=t.hasPositions,e.MORPHTARGETTEXTURE_HASCOLORS=t.hasColors,e.NUM_MORPH_INFLUENCERS=t.numMaxInfluencers||t.numInfluencers,e.MORPHTARGETS=e.NUM_MORPH_INFLUENCERS>0,e.MORPHTARGETS_TEXTURE=t.isUsingTextureForTargets):(e.MORPHTARGETS_UV=!1,e.MORPHTARGETS_UV2=!1,e.MORPHTARGETS_TANGENT=!1,e.MORPHTARGETS_NORMAL=!1,e.MORPHTARGETS_POSITION=!1,e.MORPHTARGETS_COLOR=!1,e.MORPHTARGETTEXTURE_HASUVS=!1,e.MORPHTARGETTEXTURE_HASUV2S=!1,e.MORPHTARGETTEXTURE_HASTANGENTS=!1,e.MORPHTARGETTEXTURE_HASNORMALS=!1,e.MORPHTARGETTEXTURE_HASPOSITIONS=!1,e.MORPHTARGETTEXTURE_HAS_COLORS=!1,e.MORPHTARGETS=!1,e.NUM_MORPH_INFLUENCERS=0)}function ER(a,e){const t=a.bakedVertexAnimationManager;e.BAKED_VERTEX_ANIMATION_TEXTURE=!!(t&&t.isEnabled)}function Dc(a,e,t,i,r=!1,s=!0,n=!0){if(!e._areAttributesDirty&&e._needNormals===e._normals&&e._needUVs===e._uvs)return!1;e._normals=e._needNormals,e._uvs=e._needUVs,e.NORMAL=e._needNormals&&a.isVerticesDataPresent("normal"),e._needNormals&&a.isVerticesDataPresent("tangent")&&(e.TANGENT=!0);for(let o=1;o<=6;++o)e["UV"+o]=e._needUVs?a.isVerticesDataPresent(`uv${o===1?"":o}`):!1;if(t){const o=a.useVertexColors&&a.isVerticesDataPresent("color");e.VERTEXCOLOR=o,e.VERTEXALPHA=a.hasVertexAlpha&&o&&s}return a.isVerticesDataPresent("instanceColor")&&(a.hasInstances||a.hasThinInstances)&&(e.INSTANCESCOLOR=!0),mR(a,e),r&&gR(a,e),n&&ER(a,e),!0}function Lc(a,e){if(a.activeCamera){const t=e.MULTIVIEW;e.MULTIVIEW=a.activeCamera.outputRenderTarget!==null&&a.activeCamera.outputRenderTarget.getViewCount()>1,e.MULTIVIEW!=t&&e.markAsUnprocessed()}}function Um(a,e,t){const i=e.ORDER_INDEPENDENT_TRANSPARENCY,r=e.ORDER_INDEPENDENT_TRANSPARENCY_16BITS;e.ORDER_INDEPENDENT_TRANSPARENCY=a.useOrderIndependentTransparency&&t,e.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!a.getEngine().getCaps().textureFloatLinearFiltering,(i!==e.ORDER_INDEPENDENT_TRANSPARENCY||r!==e.ORDER_INDEPENDENT_TRANSPARENCY_16BITS)&&e.markAsUnprocessed()}function Nc(a,e,t){const i=e.PREPASS;if(!e._arePrePassDirty)return;const r=[{type:1,define:"PREPASS_POSITION",index:"PREPASS_POSITION_INDEX"},{type:9,define:"PREPASS_LOCAL_POSITION",index:"PREPASS_LOCAL_POSITION_INDEX"},{type:2,define:"PREPASS_VELOCITY",index:"PREPASS_VELOCITY_INDEX"},{type:11,define:"PREPASS_VELOCITY_LINEAR",index:"PREPASS_VELOCITY_LINEAR_INDEX"},{type:3,define:"PREPASS_REFLECTIVITY",index:"PREPASS_REFLECTIVITY_INDEX"},{type:0,define:"PREPASS_IRRADIANCE",index:"PREPASS_IRRADIANCE_INDEX"},{type:7,define:"PREPASS_ALBEDO_SQRT",index:"PREPASS_ALBEDO_SQRT_INDEX"},{type:5,define:"PREPASS_DEPTH",index:"PREPASS_DEPTH_INDEX"},{type:10,define:"PREPASS_SCREENSPACE_DEPTH",index:"PREPASS_SCREENSPACE_DEPTH_INDEX"},{type:6,define:"PREPASS_NORMAL",index:"PREPASS_NORMAL_INDEX"},{type:8,define:"PREPASS_WORLD_NORMAL",index:"PREPASS_WORLD_NORMAL_INDEX"}];if(a.prePassRenderer&&a.prePassRenderer.enabled&&t){e.PREPASS=!0,e.SCENE_MRT_COUNT=a.prePassRenderer.mrtCount,e.PREPASS_NORMAL_WORLDSPACE=a.prePassRenderer.generateNormalsInWorldSpace,e.PREPASS_COLOR=!0,e.PREPASS_COLOR_INDEX=0;for(let s=0;s<r.length;s++){const n=a.prePassRenderer.getIndex(r[s].type);n!==-1?(e[r[s].define]=!0,e[r[s].index]=n):e[r[s].define]=!1}}else{e.PREPASS=!1;for(let s=0;s<r.length;s++)e[r[s].define]=!1}e.PREPASS!=i&&(e.markAsUnprocessed(),e.markAsImageProcessingDirty())}function Vm(a,e){let t=!1;if(a.activeCamera){const i=e.CAMERA_ORTHOGRAPHIC?1:0,r=e.CAMERA_PERSPECTIVE?1:0,s=a.activeCamera.mode===1?1:0,n=a.activeCamera.mode===0?1:0;(i^s||r^n)&&(e.CAMERA_ORTHOGRAPHIC=s===1,e.CAMERA_PERSPECTIVE=n===1,t=!0)}return t}function vR(a,e,t,i,r=null,s=!1,n=!1){r&&r.push("Light"+a),!s&&(e.push("vLightData"+a,"vLightDiffuse"+a,"vLightSpecular"+a,"vLightDirection"+a,"vLightWidth"+a,"vLightHeight"+a,"vLightFalloff"+a,"vLightGround"+a,"lightMatrix"+a,"shadowsInfo"+a,"depthValues"+a),t.push("shadowTexture"+a),t.push("depthTexture"+a),e.push("viewFrustumZ"+a,"cascadeBlendFactor"+a,"lightSizeUVCorrection"+a,"depthCorrection"+a,"penumbraDarkness"+a,"frustumLengths"+a),i&&(t.push("projectionLightTexture"+a),e.push("textureProjectionMatrix"+a)),n&&t.push("iesLightTexture"+a))}function Fc(a,e,t,i=4){let r,s;if(a.uniformsNames){const n=a;r=n.uniformsNames,s=n.uniformBuffersNames,e=n.samplers,t=n.defines,i=n.maxSimultaneousLights||0}else r=a,e||(e=[]);for(let n=0;n<i&&t["LIGHT"+n];n++)vR(n,r,e,t["PROJECTEDLIGHTTEXTURE"+n],s,!1,t["IESLIGHTTEXTURE"+n]);t.NUM_MORPH_INFLUENCERS&&(r.push("morphTargetInfluences"),r.push("morphTargetCount")),t.BAKED_VERTEX_ANIMATION_TEXTURE&&(r.push("bakedVertexAnimationSettings"),r.push("bakedVertexAnimationTextureSizeInverted"),r.push("bakedVertexAnimationTime"),e.push("bakedVertexAnimationTexture"))}class q{get _supportGlowLayer(){return!1}set _glowModeEnabled(e){}get shaderLanguage(){return this._shaderLanguage}get canRenderToMRT(){return!1}set alpha(e){if(this._alpha===e)return;const t=this._alpha;this._alpha=e,(t===1||e===1)&&this.markAsDirty(q.MiscDirtyFlag+q.PrePassDirtyFlag)}get alpha(){return this._alpha}set backFaceCulling(e){this._backFaceCulling!==e&&(this._backFaceCulling=e,this.markAsDirty(q.TextureDirtyFlag))}get backFaceCulling(){return this._backFaceCulling}set cullBackFaces(e){this._cullBackFaces!==e&&(this._cullBackFaces=e,this.markAsDirty(q.TextureDirtyFlag))}get cullBackFaces(){return this._cullBackFaces}get blockDirtyMechanism(){return this._blockDirtyMechanism}set blockDirtyMechanism(e){this._blockDirtyMechanism!==e&&(this._blockDirtyMechanism=e,e||this.markDirty())}atomicMaterialsUpdate(e){this.blockDirtyMechanism=!0;try{e(this)}finally{this.blockDirtyMechanism=!1}}get hasRenderTargetTextures(){return this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._eventInfo.hasRenderTargetTextures}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new U),this._onBindObservable}set onBind(e){this._onBindObserver&&this.onBindObservable.remove(this._onBindObserver),this._onBindObserver=this.onBindObservable.add(e)}get onUnBindObservable(){return this._onUnBindObservable||(this._onUnBindObservable=new U),this._onUnBindObservable}get onEffectCreatedObservable(){return this._onEffectCreatedObservable||(this._onEffectCreatedObservable=new U),this._onEffectCreatedObservable}set alphaMode(e){this._alphaMode!==e&&(this._alphaMode=e,this.markAsDirty(q.TextureDirtyFlag))}get alphaMode(){return this._alphaMode}set needDepthPrePass(e){this._needDepthPrePass!==e&&(this._needDepthPrePass=e,this._needDepthPrePass&&(this.checkReadyOnEveryCall=!0))}get needDepthPrePass(){return this._needDepthPrePass}get isPrePassCapable(){return!1}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAsDirty(q.MiscDirtyFlag))}get fogEnabled(){return this._fogEnabled}get wireframe(){switch(this._fillMode){case q.WireFrameFillMode:case q.LineListDrawMode:case q.LineLoopDrawMode:case q.LineStripDrawMode:return!0}return this._scene.forceWireframe}set wireframe(e){this.fillMode=e?q.WireFrameFillMode:q.TriangleFillMode}get pointsCloud(){switch(this._fillMode){case q.PointFillMode:case q.PointListDrawMode:return!0}return this._scene.forcePointsCloud}set pointsCloud(e){this.fillMode=e?q.PointFillMode:q.TriangleFillMode}get fillMode(){return this._fillMode}set fillMode(e){this._fillMode!==e&&(this._fillMode=e,this.markAsDirty(q.MiscDirtyFlag))}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){const t=this.getScene().getEngine().getCaps().fragmentDepthSupported;e&&!t&&B.Warn("Logarithmic depth has been requested for a material on a device that doesn't support it."),this._useLogarithmicDepth=e&&t,this._markAllSubMeshesAsMiscDirty()}_getDrawWrapper(){return this._drawWrapper}_setDrawWrapper(e){this._drawWrapper=e}constructor(e,t,i,r=!1){this.shadowDepthWrapper=null,this.allowShaderHotSwapping=!0,this._shaderLanguage=0,this._forceGLSL=!1,this.metadata=null,this.reservedDataStore=null,this.checkReadyOnEveryCall=!1,this.checkReadyOnlyOnce=!1,this.state="",this._alpha=1,this._backFaceCulling=!0,this._cullBackFaces=!0,this._blockDirtyMechanism=!1,this.sideOrientation=null,this.onCompiled=null,this.onError=null,this.getRenderTargetTextures=null,this.doNotSerialize=!1,this._storeEffectOnSubMeshes=!1,this.animations=null,this.onDisposeObservable=new U,this._onDisposeObserver=null,this._onUnBindObservable=null,this._onBindObserver=null,this._alphaMode=2,this._needDepthPrePass=!1,this.disableDepthWrite=!1,this.disableColorWrite=!1,this.forceDepthWrite=!1,this.depthFunction=0,this.separateCullingPass=!1,this._fogEnabled=!0,this.pointSize=1,this.zOffset=0,this.zOffsetUnits=0,this.stencil=new Vr,this._useUBO=!1,this._fillMode=q.TriangleFillMode,this._cachedDepthWriteState=!1,this._cachedColorWriteState=!1,this._cachedDepthFunctionState=0,this._indexInSceneMaterialArray=-1,this.meshMap=null,this._parentContainer=null,this._uniformBufferLayoutBuilt=!1,this._eventInfo={},this._callbackPluginEventGeneric=()=>{},this._callbackPluginEventIsReadyForSubMesh=()=>{},this._callbackPluginEventPrepareDefines=()=>{},this._callbackPluginEventPrepareDefinesBeforeAttributes=()=>{},this._callbackPluginEventHardBindForSubMesh=()=>{},this._callbackPluginEventBindForSubMesh=()=>{},this._callbackPluginEventHasRenderTargetTextures=()=>{},this._callbackPluginEventFillRenderTargetTextures=()=>{},this._transparencyMode=null,this.name=e;const s=t||Re.LastCreatedScene;s&&(this._scene=s,this._dirtyCallbacks={},this._forceGLSL=r,this._dirtyCallbacks[1]=this._markAllSubMeshesAsTexturesDirty.bind(this),this._dirtyCallbacks[2]=this._markAllSubMeshesAsLightsDirty.bind(this),this._dirtyCallbacks[4]=this._markAllSubMeshesAsFresnelDirty.bind(this),this._dirtyCallbacks[8]=this._markAllSubMeshesAsAttributesDirty.bind(this),this._dirtyCallbacks[16]=this._markAllSubMeshesAsMiscDirty.bind(this),this._dirtyCallbacks[32]=this._markAllSubMeshesAsPrePassDirty.bind(this),this._dirtyCallbacks[127]=this._markAllSubMeshesAsAllDirty.bind(this),this.id=e||k.RandomId(),this.uniqueId=this._scene.getUniqueId(),this._materialContext=this._scene.getEngine().createMaterialContext(),this._drawWrapper=new wa(this._scene.getEngine(),!1),this._drawWrapper.materialContext=this._materialContext,this._uniformBuffer=new _e(this._scene.getEngine(),void 0,void 0,e),this._useUBO=this.getScene().getEngine().supportsUniformBuffers,this._createUniformBuffer(),i||this._scene.addMaterial(this),this._scene.useMaterialMeshMap&&(this.meshMap={}),q.OnEventObservable.notifyObservers(this,1))}_createUniformBuffer(){var t;const e=this.getScene().getEngine();(t=this._uniformBuffer)==null||t.dispose(),e.isWebGPU&&!this._forceGLSL?(this._uniformBuffer=new _e(e,void 0,void 0,this.name,!0),this._shaderLanguage=1):this._uniformBuffer=new _e(this._scene.getEngine(),void 0,void 0,this.name),this._uniformBufferLayoutBuilt=!1}toString(e){return"Name: "+this.name}getClassName(){return"Material"}get _isMaterial(){return!0}get isFrozen(){return this.checkReadyOnlyOnce}freeze(){this.markDirty(),this.checkReadyOnlyOnce=!0}unfreeze(){this.markDirty(),this.checkReadyOnlyOnce=!1}isReady(e,t){return!0}isReadyForSubMesh(e,t,i){const r=t.materialDefines;return r?(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=r,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),this._eventInfo.isReadyForSubMesh):!1}getEffect(){return this._drawWrapper.effect}getScene(){return this._scene}_getEffectiveOrientation(e){return this.sideOrientation!==null?this.sideOrientation:e.sideOrientation}get transparencyMode(){return this._transparencyMode}set transparencyMode(e){this._transparencyMode!==e&&(this._transparencyMode=e,this._markAllSubMeshesAsTexturesAndMiscDirty())}get _hasTransparencyMode(){return this._transparencyMode!=null}get _transparencyModeIsBlend(){return this._transparencyMode===q.MATERIAL_ALPHABLEND||this._transparencyMode===q.MATERIAL_ALPHATESTANDBLEND}get _transparencyModeIsTest(){return this._transparencyMode===q.MATERIAL_ALPHATEST||this._transparencyMode===q.MATERIAL_ALPHATESTANDBLEND}get _disableAlphaBlending(){return this._transparencyMode===q.MATERIAL_OPAQUE||this._transparencyMode===q.MATERIAL_ALPHATEST}needAlphaBlending(){return this._hasTransparencyMode?this._transparencyModeIsBlend:this._disableAlphaBlending?!1:this.alpha<1}needAlphaBlendingForMesh(e){return this._hasTransparencyMode?this._transparencyModeIsBlend:e.visibility<1?!0:this._disableAlphaBlending?!1:e.hasVertexAlpha||this.needAlphaBlending()}needAlphaTesting(){return this._hasTransparencyMode?this._transparencyModeIsTest:!1}needAlphaTestingForMesh(e){return this._hasTransparencyMode?this._transparencyModeIsTest:!this.needAlphaBlendingForMesh(e)&&this.needAlphaTesting()}getAlphaTestTexture(){return null}markDirty(e=!1){const t=this.getScene().meshes;for(const i of t)if(i.subMeshes){for(const r of i.subMeshes)if(r.getMaterial()===this)for(const s of r._drawWrappers)s&&this._materialContext===s.materialContext&&(s._wasPreviouslyReady=!1,s._wasPreviouslyUsingInstances=null,s._forceRebindOnNextCall=e)}e&&this.markAsDirty(q.AllDirtyFlag)}_preBind(e,t=null){const i=this._scene.getEngine(),s=(t??this.sideOrientation)===q.ClockWiseSideOrientation;return i.enableEffect(e||this._getDrawWrapper()),i.setState(this.backFaceCulling,this.zOffset,!1,s,this._scene._mirroredCameraPosition?!this.cullBackFaces:this.cullBackFaces,this.stencil,this.zOffsetUnits),s}bind(e,t){}buildUniformLayout(){const e=this._uniformBuffer;this._eventInfo.ubo=e,this._callbackPluginEventGeneric(8,this._eventInfo),e.create(),this._uniformBufferLayoutBuilt=!0}bindForSubMesh(e,t,i){const r=i._drawWrapper;this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),r._forceRebindOnNextCall=!1}bindOnlyWorldMatrix(e){}bindView(e){this._useUBO?this._needToBindSceneUbo=!0:e.setMatrix("view",this.getScene().getViewMatrix())}bindViewProjection(e){this._useUBO?this._needToBindSceneUbo=!0:(e.setMatrix("viewProjection",this.getScene().getTransformMatrix()),e.setMatrix("projection",this.getScene().getProjectionMatrix()))}bindEyePosition(e,t){this._useUBO?this._needToBindSceneUbo=!0:this._scene.bindEyePosition(e,t)}_afterBind(e,t=null,i){if(this._scene._cachedMaterial=this,this._needToBindSceneUbo&&t&&(this._needToBindSceneUbo=!1,Bm(t,this.getScene().getSceneUniformBuffer()),this._scene.finalizeSceneUbo()),e?this._scene._cachedVisibility=e.visibility:this._scene._cachedVisibility=1,this._onBindObservable&&e&&this._onBindObservable.notifyObservers(e),this.disableDepthWrite){const r=this._scene.getEngine();this._cachedDepthWriteState=r.getDepthWrite(),r.setDepthWrite(!1)}if(this.disableColorWrite){const r=this._scene.getEngine();this._cachedColorWriteState=r.getColorWrite(),r.setColorWrite(!1)}if(this.depthFunction!==0){const r=this._scene.getEngine();this._cachedDepthFunctionState=r.getDepthFunction()||0,r.setDepthFunction(this.depthFunction)}}unbind(){this._scene.getSceneUniformBuffer().unbindEffect(),this._onUnBindObservable&&this._onUnBindObservable.notifyObservers(this),this.depthFunction!==0&&this._scene.getEngine().setDepthFunction(this._cachedDepthFunctionState),this.disableDepthWrite&&this._scene.getEngine().setDepthWrite(this._cachedDepthWriteState),this.disableColorWrite&&this._scene.getEngine().setColorWrite(this._cachedColorWriteState)}getAnimatables(){return this._eventInfo.animatables=[],this._callbackPluginEventGeneric(256,this._eventInfo),this._eventInfo.animatables}getActiveTextures(){return this._eventInfo.activeTextures=[],this._callbackPluginEventGeneric(512,this._eventInfo),this._eventInfo.activeTextures}hasTexture(e){return this._eventInfo.hasTexture=!1,this._eventInfo.texture=e,this._callbackPluginEventGeneric(1024,this._eventInfo),this._eventInfo.hasTexture}clone(e){return null}_clonePlugins(e,t){const i={};if(this._serializePlugins(i),q._ParsePlugins(i,e,this._scene,t),this.pluginManager)for(const r of this.pluginManager._plugins){const s=e.pluginManager.getPlugin(r.name);s&&r.copyTo(s)}}getBindedMeshes(){if(this.meshMap){const e=[];for(const t in this.meshMap){const i=this.meshMap[t];i&&e.push(i)}return e}else return this._scene.meshes.filter(t=>t.material===this)}forceCompilation(e,t,i,r){const s={clipPlane:!1,useInstances:!1,...i},n=this.getScene(),o=this.allowShaderHotSwapping;this.allowShaderHotSwapping=!1;const l=()=>{if(!this._scene||!this._scene.getEngine())return;const c=n.clipPlane;if(s.clipPlane&&(n.clipPlane=new hi(0,0,0,1)),this._storeEffectOnSubMeshes){let h=!0,f=null;if(e.subMeshes){const u=new Ei(0,0,0,0,0,e,void 0,!1,!1);u.materialDefines&&(u.materialDefines._renderId=-1),this.isReadyForSubMesh(e,u,s.useInstances)||(u.effect&&u.effect.getCompilationError()&&u.effect.allFallbacksProcessed()?f=u.effect.getCompilationError():(h=!1,setTimeout(l,16)))}h&&(this.allowShaderHotSwapping=o,f&&r&&r(f),t&&t(this))}else this.isReady()?(this.allowShaderHotSwapping=o,t&&t(this)):setTimeout(l,16);s.clipPlane&&(n.clipPlane=c)};l()}forceCompilationAsync(e,t){return new Promise((i,r)=>{this.forceCompilation(e,()=>{i()},t,s=>{r(s)})})}markAsDirty(e){this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism||(q._DirtyCallbackArray.length=0,e&q.ImageProcessingDirtyFlag&&q._DirtyCallbackArray.push(q._ImageProcessingDirtyCallBack),e&q.TextureDirtyFlag&&q._DirtyCallbackArray.push(q._TextureDirtyCallBack),e&q.LightDirtyFlag&&q._DirtyCallbackArray.push(q._LightsDirtyCallBack),e&q.FresnelDirtyFlag&&q._DirtyCallbackArray.push(q._FresnelDirtyCallBack),e&q.AttributesDirtyFlag&&q._DirtyCallbackArray.push(q._AttributeDirtyCallBack),e&q.MiscDirtyFlag&&q._DirtyCallbackArray.push(q._MiscDirtyCallBack),e&q.PrePassDirtyFlag&&q._DirtyCallbackArray.push(q._PrePassDirtyCallBack),q._DirtyCallbackArray.length&&this._markAllSubMeshesAsDirty(q._RunDirtyCallBacks),this.getScene().resetCachedMaterial())}resetDrawCache(){const e=this.getScene().meshes;for(const t of e)if(t.subMeshes)for(const i of t.subMeshes)i.getMaterial()===this&&i.resetDrawCache()}_markAllSubMeshesAsDirty(e){const t=this.getScene();if(t.blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const i=t.meshes;for(const r of i)if(r.subMeshes){for(const s of r.subMeshes)if((s.getMaterial()||(t._hasDefaultMaterial?t.defaultMaterial:null))===this)for(const o of s._drawWrappers)!o||!o.defines||!o.defines.markAllAsDirty||this._materialContext===o.materialContext&&e(o.defines)}}_markScenePrePassDirty(){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const e=this.getScene().enablePrePassRenderer();e&&e.markAsDirty()}_markAllSubMeshesAsAllDirty(){this._markAllSubMeshesAsDirty(q._AllDirtyCallBack)}_markAllSubMeshesAsImageProcessingDirty(){this._markAllSubMeshesAsDirty(q._ImageProcessingDirtyCallBack)}_markAllSubMeshesAsTexturesDirty(){this._markAllSubMeshesAsDirty(q._TextureDirtyCallBack)}_markAllSubMeshesAsFresnelDirty(){this._markAllSubMeshesAsDirty(q._FresnelDirtyCallBack)}_markAllSubMeshesAsFresnelAndMiscDirty(){this._markAllSubMeshesAsDirty(q._FresnelAndMiscDirtyCallBack)}_markAllSubMeshesAsLightsDirty(){this._markAllSubMeshesAsDirty(q._LightsDirtyCallBack)}_markAllSubMeshesAsAttributesDirty(){this._markAllSubMeshesAsDirty(q._AttributeDirtyCallBack)}_markAllSubMeshesAsMiscDirty(){this._markAllSubMeshesAsDirty(q._MiscDirtyCallBack)}_markAllSubMeshesAsPrePassDirty(){this._markAllSubMeshesAsDirty(q._PrePassDirtyCallBack)}_markAllSubMeshesAsTexturesAndMiscDirty(){this._markAllSubMeshesAsDirty(q._TextureAndMiscDirtyCallBack)}_checkScenePerformancePriority(){if(this._scene.performancePriority!==0){this.checkReadyOnlyOnce=!0;const e=this._scene.onScenePerformancePriorityChangedObservable.addOnce(()=>{this.checkReadyOnlyOnce=!1});this.onDisposeObservable.add(()=>{this._scene.onScenePerformancePriorityChangedObservable.remove(e)})}}setPrePassRenderer(e){return!1}dispose(e,t,i){const r=this.getScene();if(r.stopAnimation(this),r.freeProcessedMaterials(),r.removeMaterial(this),this._eventInfo.forceDisposeTextures=t,this._callbackPluginEventGeneric(2,this._eventInfo),this._parentContainer){const s=this._parentContainer.materials.indexOf(this);s>-1&&this._parentContainer.materials.splice(s,1),this._parentContainer=null}if(i!==!0)if(this.meshMap)for(const s in this.meshMap){const n=this.meshMap[s];this._disposeMeshResources(n)}else{const s=r.meshes;for(const n of s)this._disposeMeshResources(n)}this._uniformBuffer.dispose(),this._drawWrapper.effect&&(this._storeEffectOnSubMeshes||this._drawWrapper.effect.dispose(),this._drawWrapper.effect=null),this.metadata=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._onBindObservable&&this._onBindObservable.clear(),this._onUnBindObservable&&this._onUnBindObservable.clear(),this._onEffectCreatedObservable&&this._onEffectCreatedObservable.clear(),this._eventInfo&&(this._eventInfo={})}_disposeMeshResources(e){var r;if(!e)return;const t=e.geometry,i=e._internalAbstractMeshDataInfo._materialForRenderPass;if(this._storeEffectOnSubMeshes){if(e.subMeshes&&i)for(const s of e.subMeshes){const n=s._drawWrappers;for(let o=0;o<n.length;o++){const l=(r=n[o])==null?void 0:r.effect;if(!l)continue;i[o]===this&&(t==null||t._releaseVertexArrayObject(l),s._removeDrawWrapper(o,!0,!0))}}}else t==null||t._releaseVertexArrayObject(this._drawWrapper.effect);e.material===this&&!e.sourceMesh&&(e.material=null)}serialize(){const e=ye.Serialize(this);return e.stencil=this.stencil.serialize(),e.uniqueId=this.uniqueId,this._serializePlugins(e),e}_serializePlugins(e){if(e.plugins={},this.pluginManager)for(const t of this.pluginManager._plugins)t.doNotSerialize||(e.plugins[t.getClassName()]=t.serialize())}static Parse(e,t,i){if(!e.customType)e.customType="BABYLON.StandardMaterial";else if(e.customType==="BABYLON.PBRMaterial"&&e.overloadedAlbedo&&(e.customType="BABYLON.LegacyPBRMaterial",!BABYLON.LegacyPBRMaterial))return B.Error("Your scene is trying to load a legacy version of the PBRMaterial, please, include it from the materials library."),null;const s=k.Instantiate(e.customType).Parse(e,t,i);return s._loadedUniqueId=e.uniqueId,s}static _ParsePlugins(e,t,i,r){var s;if(e.plugins)for(const n in e.plugins){const o=e.plugins[n];let l=(s=t.pluginManager)==null?void 0:s.getPlugin(o.name);if(!l){const c=k.Instantiate("BABYLON."+n);c&&(l=new c(t))}l==null||l.parse(o,i,r)}}}q.TriangleFillMode=0;q.WireFrameFillMode=1;q.PointFillMode=2;q.PointListDrawMode=3;q.LineListDrawMode=4;q.LineLoopDrawMode=5;q.LineStripDrawMode=6;q.TriangleStripDrawMode=7;q.TriangleFanDrawMode=8;q.ClockWiseSideOrientation=0;q.CounterClockWiseSideOrientation=1;q.ImageProcessingDirtyFlag=64;q.TextureDirtyFlag=1;q.LightDirtyFlag=2;q.FresnelDirtyFlag=4;q.AttributesDirtyFlag=8;q.MiscDirtyFlag=16;q.PrePassDirtyFlag=32;q.AllDirtyFlag=127;q.MATERIAL_OPAQUE=0;q.MATERIAL_ALPHATEST=1;q.MATERIAL_ALPHABLEND=2;q.MATERIAL_ALPHATESTANDBLEND=3;q.MATERIAL_NORMALBLENDMETHOD_WHITEOUT=0;q.MATERIAL_NORMALBLENDMETHOD_RNM=1;q.OnEventObservable=new U;q._AllDirtyCallBack=a=>a.markAllAsDirty();q._ImageProcessingDirtyCallBack=a=>a.markAsImageProcessingDirty();q._TextureDirtyCallBack=a=>a.markAsTexturesDirty();q._FresnelDirtyCallBack=a=>a.markAsFresnelDirty();q._MiscDirtyCallBack=a=>a.markAsMiscDirty();q._PrePassDirtyCallBack=a=>a.markAsPrePassDirty();q._LightsDirtyCallBack=a=>a.markAsLightDirty();q._AttributeDirtyCallBack=a=>a.markAsAttributesDirty();q._FresnelAndMiscDirtyCallBack=a=>{q._FresnelDirtyCallBack(a),q._MiscDirtyCallBack(a)};q._TextureAndMiscDirtyCallBack=a=>{q._TextureDirtyCallBack(a),q._MiscDirtyCallBack(a)};q._DirtyCallbackArray=[];q._RunDirtyCallBacks=a=>{for(const e of q._DirtyCallbackArray)e(a)};A([y()],q.prototype,"id",void 0);A([y()],q.prototype,"uniqueId",void 0);A([y()],q.prototype,"name",void 0);A([y()],q.prototype,"metadata",void 0);A([y()],q.prototype,"checkReadyOnEveryCall",void 0);A([y()],q.prototype,"checkReadyOnlyOnce",void 0);A([y()],q.prototype,"state",void 0);A([y("alpha")],q.prototype,"_alpha",void 0);A([y("backFaceCulling")],q.prototype,"_backFaceCulling",void 0);A([y("cullBackFaces")],q.prototype,"_cullBackFaces",void 0);A([y()],q.prototype,"sideOrientation",void 0);A([y("alphaMode")],q.prototype,"_alphaMode",void 0);A([y()],q.prototype,"_needDepthPrePass",void 0);A([y()],q.prototype,"disableDepthWrite",void 0);A([y()],q.prototype,"disableColorWrite",void 0);A([y()],q.prototype,"forceDepthWrite",void 0);A([y()],q.prototype,"depthFunction",void 0);A([y()],q.prototype,"separateCullingPass",void 0);A([y("fogEnabled")],q.prototype,"_fogEnabled",void 0);A([y()],q.prototype,"pointSize",void 0);A([y()],q.prototype,"zOffset",void 0);A([y()],q.prototype,"zOffsetUnits",void 0);A([y()],q.prototype,"pointsCloud",null);A([y()],q.prototype,"fillMode",null);A([y()],q.prototype,"useLogarithmicDepth",null);A([y()],q.prototype,"transparencyMode",null);class ji{constructor(e){if(this._keys=[],this._isDirty=!0,this._areLightsDirty=!0,this._areLightsDisposed=!1,this._areAttributesDirty=!0,this._areTexturesDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!0,this._areImageProcessingDirty=!0,this._normals=!1,this._uvs=!1,this._needNormals=!1,this._needUVs=!1,this._externalProperties=e,e)for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&this._setDefaultValue(t)}get isDirty(){return this._isDirty}markAsProcessed(){this._isDirty=!1,this._areAttributesDirty=!1,this._areTexturesDirty=!1,this._areFresnelDirty=!1,this._areLightsDirty=!1,this._areLightsDisposed=!1,this._areMiscDirty=!1,this._arePrePassDirty=!1,this._areImageProcessingDirty=!1}markAsUnprocessed(){this._isDirty=!0}markAllAsDirty(){this._areTexturesDirty=!0,this._areAttributesDirty=!0,this._areLightsDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!0,this._areImageProcessingDirty=!0,this._isDirty=!0}markAsImageProcessingDirty(){this._areImageProcessingDirty=!0,this._isDirty=!0}markAsLightDirty(e=!1){this._areLightsDirty=!0,this._areLightsDisposed=this._areLightsDisposed||e,this._isDirty=!0}markAsAttributesDirty(){this._areAttributesDirty=!0,this._isDirty=!0}markAsTexturesDirty(){this._areTexturesDirty=!0,this._isDirty=!0}markAsFresnelDirty(){this._areFresnelDirty=!0,this._isDirty=!0}markAsMiscDirty(){this._areMiscDirty=!0,this._isDirty=!0}markAsPrePassDirty(){this._arePrePassDirty=!0,this._isDirty=!0}rebuild(){this._keys.length=0;for(const e of Object.keys(this))e[0]!=="_"&&this._keys.push(e);if(this._externalProperties)for(const e in this._externalProperties)this._keys.indexOf(e)===-1&&this._keys.push(e)}isEqual(e){if(this._keys.length!==e._keys.length)return!1;for(let t=0;t<this._keys.length;t++){const i=this._keys[t];if(this[i]!==e[i])return!1}return!0}cloneTo(e){this._keys.length!==e._keys.length&&(e._keys=this._keys.slice(0));for(let t=0;t<this._keys.length;t++){const i=this._keys[t];e[i]=this[i]}}reset(){this._keys.forEach(e=>this._setDefaultValue(e))}_setDefaultValue(e){var r,s,n,o;const t=((s=(r=this._externalProperties)==null?void 0:r[e])==null?void 0:s.type)??typeof this[e],i=(o=(n=this._externalProperties)==null?void 0:n[e])==null?void 0:o.default;switch(t){case"number":this[e]=i??0;break;case"string":this[e]=i??"";break;default:this[e]=i??!1;break}}toString(){let e="";for(let t=0;t<this._keys.length;t++){const i=this._keys[t],r=this[i];switch(typeof r){case"number":case"string":e+="#define "+i+" "+r+`
`;break;default:r&&(e+="#define "+i+`
`);break}}return e}}class Un extends q{constructor(e,t,i=!0,r=!1){super(e,t,void 0,r),this._normalMatrix=new P,this._storeEffectOnSubMeshes=i}getEffect(){return this._storeEffectOnSubMeshes?this._activeEffect:super.getEffect()}isReady(e,t){return e?!this._storeEffectOnSubMeshes||!e.subMeshes||e.subMeshes.length===0?!0:this.isReadyForSubMesh(e,e.subMeshes[0],t):!1}_isReadyForSubMesh(e){const t=e.materialDefines;return!!(!this.checkReadyOnEveryCall&&e.effect&&t&&t._renderId===this.getScene().getRenderId())}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindOnlyNormalMatrix(e){this._activeEffect.setMatrix("normalMatrix",e)}bind(e,t){t&&this.bindForSubMesh(e,t,t.subMeshes[0])}_afterBind(e,t=null,i){super._afterBind(e,t,i),this.getScene()._cachedEffect=t,i?i._drawWrapper._forceRebindOnNextCall=!1:this._drawWrapper._forceRebindOnNextCall=!1}_mustRebind(e,t,i,r=1){return i._drawWrapper._forceRebindOnNextCall||e.isCachedMaterialInvalid(this,t,r)}dispose(e,t,i){this._activeEffect=void 0,super.dispose(e,t,i)}}class Q{static get DiffuseTextureEnabled(){return this._DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){this._DiffuseTextureEnabled!==e&&(this._DiffuseTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get BaseWeightTextureEnabled(){return this._BaseWeightTextureEnabled}static set BaseWeightTextureEnabled(e){this._BaseWeightTextureEnabled!==e&&(this._BaseWeightTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get DetailTextureEnabled(){return this._DetailTextureEnabled}static set DetailTextureEnabled(e){this._DetailTextureEnabled!==e&&(this._DetailTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get DecalMapEnabled(){return this._DecalMapEnabled}static set DecalMapEnabled(e){this._DecalMapEnabled!==e&&(this._DecalMapEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get AmbientTextureEnabled(){return this._AmbientTextureEnabled}static set AmbientTextureEnabled(e){this._AmbientTextureEnabled!==e&&(this._AmbientTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get OpacityTextureEnabled(){return this._OpacityTextureEnabled}static set OpacityTextureEnabled(e){this._OpacityTextureEnabled!==e&&(this._OpacityTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get ReflectionTextureEnabled(){return this._ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){this._ReflectionTextureEnabled!==e&&(this._ReflectionTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get EmissiveTextureEnabled(){return this._EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){this._EmissiveTextureEnabled!==e&&(this._EmissiveTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get SpecularTextureEnabled(){return this._SpecularTextureEnabled}static set SpecularTextureEnabled(e){this._SpecularTextureEnabled!==e&&(this._SpecularTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get BumpTextureEnabled(){return this._BumpTextureEnabled}static set BumpTextureEnabled(e){this._BumpTextureEnabled!==e&&(this._BumpTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get LightmapTextureEnabled(){return this._LightmapTextureEnabled}static set LightmapTextureEnabled(e){this._LightmapTextureEnabled!==e&&(this._LightmapTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get RefractionTextureEnabled(){return this._RefractionTextureEnabled}static set RefractionTextureEnabled(e){this._RefractionTextureEnabled!==e&&(this._RefractionTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get ColorGradingTextureEnabled(){return this._ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){this._ColorGradingTextureEnabled!==e&&(this._ColorGradingTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get FresnelEnabled(){return this._FresnelEnabled}static set FresnelEnabled(e){this._FresnelEnabled!==e&&(this._FresnelEnabled=e,H.MarkAllMaterialsAsDirty(4))}static get ClearCoatTextureEnabled(){return this._ClearCoatTextureEnabled}static set ClearCoatTextureEnabled(e){this._ClearCoatTextureEnabled!==e&&(this._ClearCoatTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get ClearCoatBumpTextureEnabled(){return this._ClearCoatBumpTextureEnabled}static set ClearCoatBumpTextureEnabled(e){this._ClearCoatBumpTextureEnabled!==e&&(this._ClearCoatBumpTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get ClearCoatTintTextureEnabled(){return this._ClearCoatTintTextureEnabled}static set ClearCoatTintTextureEnabled(e){this._ClearCoatTintTextureEnabled!==e&&(this._ClearCoatTintTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get SheenTextureEnabled(){return this._SheenTextureEnabled}static set SheenTextureEnabled(e){this._SheenTextureEnabled!==e&&(this._SheenTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get AnisotropicTextureEnabled(){return this._AnisotropicTextureEnabled}static set AnisotropicTextureEnabled(e){this._AnisotropicTextureEnabled!==e&&(this._AnisotropicTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get ThicknessTextureEnabled(){return this._ThicknessTextureEnabled}static set ThicknessTextureEnabled(e){this._ThicknessTextureEnabled!==e&&(this._ThicknessTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get RefractionIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set RefractionIntensityTextureEnabled(e){this._RefractionIntensityTextureEnabled!==e&&(this._RefractionIntensityTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get TranslucencyIntensityTextureEnabled(){return this._TranslucencyIntensityTextureEnabled}static set TranslucencyIntensityTextureEnabled(e){this._TranslucencyIntensityTextureEnabled!==e&&(this._TranslucencyIntensityTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get TranslucencyColorTextureEnabled(){return this._TranslucencyColorTextureEnabled}static set TranslucencyColorTextureEnabled(e){this._TranslucencyColorTextureEnabled!==e&&(this._TranslucencyColorTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get IridescenceTextureEnabled(){return this._IridescenceTextureEnabled}static set IridescenceTextureEnabled(e){this._IridescenceTextureEnabled!==e&&(this._IridescenceTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}}Q._DiffuseTextureEnabled=!0;Q._BaseWeightTextureEnabled=!0;Q._DetailTextureEnabled=!0;Q._DecalMapEnabled=!0;Q._AmbientTextureEnabled=!0;Q._OpacityTextureEnabled=!0;Q._ReflectionTextureEnabled=!0;Q._EmissiveTextureEnabled=!0;Q._SpecularTextureEnabled=!0;Q._BumpTextureEnabled=!0;Q._LightmapTextureEnabled=!0;Q._RefractionTextureEnabled=!0;Q._ColorGradingTextureEnabled=!0;Q._FresnelEnabled=!0;Q._ClearCoatTextureEnabled=!0;Q._ClearCoatBumpTextureEnabled=!0;Q._ClearCoatTintTextureEnabled=!0;Q._SheenTextureEnabled=!0;Q._AnisotropicTextureEnabled=!0;Q._ThicknessTextureEnabled=!0;Q._RefractionIntensityTextureEnabled=!0;Q._TranslucencyIntensityTextureEnabled=!0;Q._TranslucencyColorTextureEnabled=!0;Q._IridescenceTextureEnabled=!0;class Vn{constructor(){this._defines={},this._currentRank=32,this._maxRank=-1,this._mesh=null}unBindMesh(){this._mesh=null}addFallback(e,t){this._defines[e]||(e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e),this._defines[e]=new Array),this._defines[e].push(t)}addCPUSkinningFallback(e,t){this._mesh=t,e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e)}get hasMoreFallbacks(){return this._currentRank<=this._maxRank}reduce(e,t){if(this._mesh&&this._mesh.computeBonesUsingShaders&&this._mesh.numBoneInfluencers>0){this._mesh.computeBonesUsingShaders=!1,e=e.replace("#define NUM_BONE_INFLUENCERS "+this._mesh.numBoneInfluencers,"#define NUM_BONE_INFLUENCERS 0"),t._bonesComputationForcedToCPU=!0;const i=this._mesh.getScene();for(let r=0;r<i.meshes.length;r++){const s=i.meshes[r];if(!s.material){!this._mesh.material&&s.computeBonesUsingShaders&&s.numBoneInfluencers>0&&(s.computeBonesUsingShaders=!1);continue}if(!(!s.computeBonesUsingShaders||s.numBoneInfluencers===0)){if(s.material.getEffect()===t)s.computeBonesUsingShaders=!1;else if(s.subMeshes){for(const n of s.subMeshes)if(n.effect===t){s.computeBonesUsingShaders=!1;break}}}}}else{const i=this._defines[this._currentRank];if(i)for(let r=0;r<i.length;r++)e=e.replace("#define "+i[r],"");this._currentRank++}return e}}const TR=new RegExp("^([gimus]+)!");class qr{constructor(e){this._plugins=[],this._activePlugins=[],this._activePluginsForExtraEvents=[],this._material=e,this._scene=e.getScene(),this._engine=this._scene.getEngine()}_addPlugin(e){for(let r=0;r<this._plugins.length;++r)if(this._plugins[r].name===e.name)return!1;if(this._material._uniformBufferLayoutBuilt&&(this._material.resetDrawCache(),this._material._createUniformBuffer()),!e.isCompatible(this._material.shaderLanguage))throw`The plugin "${e.name}" can't be added to the material "${this._material.name}" because the plugin is not compatible with the shader language of the material.`;const t=e.getClassName();qr._MaterialPluginClassToMainDefine[t]||(qr._MaterialPluginClassToMainDefine[t]="MATERIALPLUGIN_"+ ++qr._MaterialPluginCounter),this._material._callbackPluginEventGeneric=(r,s)=>this._handlePluginEvent(r,s),this._plugins.push(e),this._plugins.sort((r,s)=>r.priority-s.priority),this._codeInjectionPoints={};const i={};i[qr._MaterialPluginClassToMainDefine[t]]={type:"boolean",default:!0};for(const r of this._plugins)r.collectDefines(i),this._collectPointNames("vertex",r.getCustomCode("vertex",this._material.shaderLanguage)),this._collectPointNames("fragment",r.getCustomCode("fragment",this._material.shaderLanguage));return this._defineNamesFromPlugins=i,!0}_activatePlugin(e){this._activePlugins.indexOf(e)===-1&&(this._activePlugins.push(e),this._activePlugins.sort((t,i)=>t.priority-i.priority),this._material._callbackPluginEventIsReadyForSubMesh=this._handlePluginEventIsReadyForSubMesh.bind(this),this._material._callbackPluginEventPrepareDefinesBeforeAttributes=this._handlePluginEventPrepareDefinesBeforeAttributes.bind(this),this._material._callbackPluginEventPrepareDefines=this._handlePluginEventPrepareDefines.bind(this),this._material._callbackPluginEventBindForSubMesh=this._handlePluginEventBindForSubMesh.bind(this),e.registerForExtraEvents&&(this._activePluginsForExtraEvents.push(e),this._activePluginsForExtraEvents.sort((t,i)=>t.priority-i.priority),this._material._callbackPluginEventHasRenderTargetTextures=this._handlePluginEventHasRenderTargetTextures.bind(this),this._material._callbackPluginEventFillRenderTargetTextures=this._handlePluginEventFillRenderTargetTextures.bind(this),this._material._callbackPluginEventHardBindForSubMesh=this._handlePluginEventHardBindForSubMesh.bind(this)))}getPlugin(e){for(let t=0;t<this._plugins.length;++t)if(this._plugins[t].name===e)return this._plugins[t];return null}_handlePluginEventIsReadyForSubMesh(e){let t=!0;for(const i of this._activePlugins)t=t&&i.isReadyForSubMesh(e.defines,this._scene,this._engine,e.subMesh);e.isReadyForSubMesh=t}_handlePluginEventPrepareDefinesBeforeAttributes(e){for(const t of this._activePlugins)t.prepareDefinesBeforeAttributes(e.defines,this._scene,e.mesh)}_handlePluginEventPrepareDefines(e){for(const t of this._activePlugins)t.prepareDefines(e.defines,this._scene,e.mesh)}_handlePluginEventHardBindForSubMesh(e){for(const t of this._activePluginsForExtraEvents)t.hardBindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventBindForSubMesh(e){for(const t of this._activePlugins)t.bindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventHasRenderTargetTextures(e){let t=!1;for(const i of this._activePluginsForExtraEvents)if(t=i.hasRenderTargetTextures(),t)break;e.hasRenderTargetTextures=t}_handlePluginEventFillRenderTargetTextures(e){for(const t of this._activePluginsForExtraEvents)t.fillRenderTargetTextures(e.renderTargets)}_handlePluginEvent(e,t){switch(e){case 512:{const i=t;for(const r of this._activePlugins)r.getActiveTextures(i.activeTextures);break}case 256:{const i=t;for(const r of this._activePlugins)r.getAnimatables(i.animatables);break}case 1024:{const i=t;let r=!1;for(const s of this._activePlugins)if(r=s.hasTexture(i.texture),r)break;i.hasTexture=r;break}case 2:{const i=t;for(const r of this._plugins)r.dispose(i.forceDisposeTextures);break}case 4:{const i=t;i.defineNames=this._defineNamesFromPlugins;break}case 128:{const i=t;for(const r of this._activePlugins)i.fallbackRank=r.addFallbacks(i.defines,i.fallbacks,i.fallbackRank),r.getAttributes(i.attributes,this._scene,i.mesh);this._uniformList.length>0&&i.uniforms.push(...this._uniformList),this._samplerList.length>0&&i.samplers.push(...this._samplerList),this._uboList.length>0&&i.uniformBuffersNames.push(...this._uboList),i.customCode=this._injectCustomCode(i,i.customCode);break}case 8:{const i=t;this._uboDeclaration="",this._vertexDeclaration="",this._fragmentDeclaration="",this._uniformList=[],this._samplerList=[],this._uboList=[];const r=this._material.shaderLanguage===1;for(const s of this._plugins){const n=s.getUniforms(this._material.shaderLanguage);if(n){if(n.ubo)for(const o of n.ubo){if(o.size&&o.type){const l=o.arraySize??0;if(i.ubo.addUniform(o.name,o.size,l),r){let c;switch(o.type){case"mat4":c="mat4x4f";break;case"float":c="f32";break;default:c=`${o.type}f`;break}this._uboDeclaration+=`uniform ${o.name}: ${c}${l>0?`[${l}]`:""};
`}else this._uboDeclaration+=`${o.type} ${o.name}${l>0?`[${l}]`:""};
`}this._uniformList.push(o.name)}n.vertex&&(this._vertexDeclaration+=n.vertex+`
`),n.fragment&&(this._fragmentDeclaration+=n.fragment+`
`)}s.getSamplers(this._samplerList),s.getUniformBuffersNames(this._uboList)}break}}}_collectPointNames(e,t){if(t)for(const i in t)this._codeInjectionPoints[e]||(this._codeInjectionPoints[e]={}),this._codeInjectionPoints[e][i]=!0}_injectCustomCode(e,t){return(i,r)=>{var o,l;t&&(r=t(i,r)),this._uboDeclaration&&(r=r.replace("#define ADDITIONAL_UBO_DECLARATION",this._uboDeclaration)),this._vertexDeclaration&&(r=r.replace("#define ADDITIONAL_VERTEX_DECLARATION",this._vertexDeclaration)),this._fragmentDeclaration&&(r=r.replace("#define ADDITIONAL_FRAGMENT_DECLARATION",this._fragmentDeclaration));const s=(o=this._codeInjectionPoints)==null?void 0:o[i];if(!s)return r;let n=null;for(let c in s){let h="";for(const f of this._activePlugins){let u=(l=f.getCustomCode(i,this._material.shaderLanguage))==null?void 0:l[c];u&&(f.resolveIncludes&&(n===null&&(n={defines:[],indexParameters:e.indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:void 0,supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:C.GetShadersRepository(0),includesShadersStore:C.GetIncludesShadersStore(0),version:void 0,platformName:this._engine.shaderPlatformName,processingContext:void 0,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:void 0}),n.isFragment=i==="fragment",Ea(u,n,d=>u=d)),h+=u+`
`)}if(h.length>0)if(c.charAt(0)==="!"){c=c.substring(1);let f="g";if(c.charAt(0)==="!")f="",c=c.substring(1);else{const p=TR.exec(c);p&&p.length>=2&&(f=p[1],c=c.substring(f.length+1))}f.indexOf("g")<0&&(f+="g");const u=r,d=new RegExp(c,f);let _=d.exec(u);for(;_!==null;){let p=h;for(let g=0;g<_.length;++g)p=p.replace("$"+g,_[g]);r=r.replace(_[0],p),_=d.exec(u)}}else{const f="#define "+c;r=r.replace(f,`
`+h+`
`+f)}}return r}}}qr._MaterialPluginClassToMainDefine={};qr._MaterialPluginCounter=0;Re.OnEnginesDisposedObservable.add(()=>{AR()});const SR=[];let zh=null;function AR(){SR.length=0,q.OnEventObservable.remove(zh),zh=null}class Zi{isCompatible(e){switch(e){case 0:return!0;default:return!1}}_enable(e){e&&this._pluginManager._activatePlugin(this)}constructor(e,t,i,r,s=!0,n=!1,o=!1){this.priority=500,this.resolveIncludes=!1,this.registerForExtraEvents=!1,this.doNotSerialize=!1,this._material=e,this.name=t,this.priority=i,this.resolveIncludes=o,e.pluginManager||(e.pluginManager=new qr(e),e.onDisposeObservable.add(()=>{e.pluginManager=void 0})),this._pluginDefineNames=r,this._pluginManager=e.pluginManager,s&&this._pluginManager._addPlugin(this),n&&this._enable(!0),this.markAllDefinesAsDirty=e._dirtyCallbacks[127]}getClassName(){return"MaterialPluginBase"}isReadyForSubMesh(e,t,i,r){return!0}hardBindForSubMesh(e,t,i,r){}bindForSubMesh(e,t,i,r){}dispose(e){}getCustomCode(e,t=0){return null}collectDefines(e){if(this._pluginDefineNames)for(const t of Object.keys(this._pluginDefineNames)){if(t[0]==="_")continue;const i=typeof this._pluginDefineNames[t];e[t]={type:i==="number"?"number":i==="string"?"string":i==="boolean"?"boolean":"object",default:this._pluginDefineNames[t]}}}prepareDefinesBeforeAttributes(e,t,i){}prepareDefines(e,t,i){}hasTexture(e){return!1}hasRenderTargetTextures(){return!1}fillRenderTargetTextures(e){}getActiveTextures(e){}getAnimatables(e){}addFallbacks(e,t,i){return i}getSamplers(e){}getAttributes(e,t,i){}getUniformBuffersNames(e){}getUniforms(e=0){return{}}copyTo(e){ye.Clone(()=>e,this)}serialize(){return ye.Serialize(this)}parse(e,t,i){ye.Parse(()=>this,e,t,i)}}A([y()],Zi.prototype,"name",void 0);A([y()],Zi.prototype,"priority",void 0);A([y()],Zi.prototype,"resolveIncludes",void 0);A([y()],Zi.prototype,"registerForExtraEvents",void 0);Y("BABYLON.MaterialPluginBase",Zi);class RR extends ji{constructor(){super(...arguments),this.DETAIL=!1,this.DETAILDIRECTUV=0,this.DETAIL_NORMALBLENDMETHOD=0}}class ss extends Zi{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"DetailMap",140,new RR,t),this._texture=null,this.diffuseBlendLevel=1,this.roughnessBlendLevel=1,this.bumpLevel=1,this._normalBlendMethod=q.MATERIAL_NORMALBLENDMETHOD_WHITEOUT,this._isEnabled=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&i.getCaps().standardDerivatives&&this._texture&&Q.DetailTextureEnabled&&!this._texture.isReady()):!0}prepareDefines(e,t){if(this._isEnabled){e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod;const i=t.getEngine();e._areTexturesDirty&&(i.getCaps().standardDerivatives&&this._texture&&Q.DetailTextureEnabled&&this._isEnabled?(ht(this._texture,e,"DETAIL"),e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod):e.DETAIL=!1)}else e.DETAIL=!1}bindForSubMesh(e,t){if(!this._isEnabled)return;const i=this._material.isFrozen;(!e.useUbo||!i||!e.isSync)&&this._texture&&Q.DetailTextureEnabled&&(e.updateFloat4("vDetailInfos",this._texture.coordinatesIndex,this.diffuseBlendLevel,this.bumpLevel,this.roughnessBlendLevel),ft(this._texture,e,"detail")),t.texturesEnabled&&this._texture&&Q.DetailTextureEnabled&&e.setTexture("detailSampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){var t;e&&((t=this._texture)==null||t.dispose())}getClassName(){return"DetailMapConfiguration"}getSamplers(e){e.push("detailSampler")}getUniforms(){return{ubo:[{name:"vDetailInfos",size:4,type:"vec4"},{name:"detailMatrix",size:16,type:"mat4"}]}}}A([Je("detailTexture"),j("_markAllSubMeshesAsTexturesDirty")],ss.prototype,"texture",void 0);A([y()],ss.prototype,"diffuseBlendLevel",void 0);A([y()],ss.prototype,"roughnessBlendLevel",void 0);A([y()],ss.prototype,"bumpLevel",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],ss.prototype,"normalBlendMethod",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],ss.prototype,"isEnabled",void 0);var Yh;(function(a){a[a.Zero=0]="Zero",a[a.One=1]="One",a[a.MaxViewZ=2]="MaxViewZ"})(Yh||(Yh={}));class si{static CreateConfiguration(e){return si._Configurations[e]={defines:{},previousWorldMatrices:{},previousViewProjection:P.Zero(),currentViewProjection:P.Zero(),previousBones:{},lastUpdateFrameId:-1,excludedSkinnedMesh:[],reverseCulling:!1},si._Configurations[e]}static DeleteConfiguration(e){delete si._Configurations[e]}static GetConfiguration(e){return si._Configurations[e]}static AddUniformsAndSamplers(e,t){e.push("previousWorld","previousViewProjection","mPreviousBones")}static MarkAsDirty(e,t){for(const i of t)if(i.subMeshes)for(const r of i.subMeshes)r._removeDrawWrapper(e)}static PrepareDefines(e,t,i){if(!i._arePrePassDirty)return;const r=si._Configurations[e];if(!r)return;i.PREPASS=!0,i.PREPASS_COLOR=!1,i.PREPASS_COLOR_INDEX=-1;let s=0;for(let n=0;n<si.GeometryTextureDescriptions.length;n++){const o=si.GeometryTextureDescriptions[n],l=o.define,c=o.defineIndex,h=r.defines[c];h!==void 0?(i[l]=!0,i[c]=h,s++):(i[l]=!1,delete i[c])}i.SCENE_MRT_COUNT=s,i.BONES_VELOCITY_ENABLED=t.useBones&&t.computeBonesUsingShaders&&t.skeleton&&!t.skeleton.isUsingTextureForMatrices&&r.excludedSkinnedMesh.indexOf(t)===-1}static Bind(e,t,i,r,s){const n=si._Configurations[e];if(!n)return;const o=i.getScene(),l=o.getEngine();if(n.reverseCulling&&l.setStateCullFaceType(o._mirroredCameraPosition?s.cullBackFaces:!s.cullBackFaces),(n.defines.PREPASS_VELOCITY_INDEX!==void 0||n.defines.PREPASS_VELOCITY_LINEAR_INDEX!==void 0)&&(n.previousWorldMatrices[i.uniqueId]||(n.previousWorldMatrices[i.uniqueId]=r.clone()),n.previousViewProjection||(n.previousViewProjection=o.getTransformMatrix().clone(),n.currentViewProjection=o.getTransformMatrix().clone()),n.currentViewProjection.updateFlag!==o.getTransformMatrix().updateFlag?(n.lastUpdateFrameId=l.frameId,n.previousViewProjection.copyFrom(n.currentViewProjection),n.currentViewProjection.copyFrom(o.getTransformMatrix())):n.lastUpdateFrameId!==l.frameId&&(n.lastUpdateFrameId=l.frameId,n.previousViewProjection.copyFrom(n.currentViewProjection)),t.setMatrix("previousWorld",n.previousWorldMatrices[i.uniqueId]),t.setMatrix("previousViewProjection",n.previousViewProjection),n.previousWorldMatrices[i.uniqueId]=r.clone(),i.useBones&&i.computeBonesUsingShaders&&i.skeleton)){const c=i.skeleton;if(!c.isUsingTextureForMatrices||t.getUniformIndex("boneTextureWidth")===-1){const h=c.getTransformMatrices(i);h&&(n.previousBones[i.uniqueId]||(n.previousBones[i.uniqueId]=h.slice()),t.setMatrices("mPreviousBones",n.previousBones[i.uniqueId]),n.previousBones[i.uniqueId].set(h))}}}}si.GeometryTextureDescriptions=[{type:0,name:"Irradiance",clearType:0,define:"PREPASS_IRRADIANCE",defineIndex:"PREPASS_IRRADIANCE_INDEX"},{type:1,name:"WorldPosition",clearType:0,define:"PREPASS_POSITION",defineIndex:"PREPASS_POSITION_INDEX"},{type:2,name:"Velocity",clearType:0,define:"PREPASS_VELOCITY",defineIndex:"PREPASS_VELOCITY_INDEX"},{type:3,name:"Reflectivity",clearType:0,define:"PREPASS_REFLECTIVITY",defineIndex:"PREPASS_REFLECTIVITY_INDEX"},{type:5,name:"ViewDepth",clearType:2,define:"PREPASS_DEPTH",defineIndex:"PREPASS_DEPTH_INDEX"},{type:6,name:"ViewNormal",clearType:0,define:"PREPASS_NORMAL",defineIndex:"PREPASS_NORMAL_INDEX"},{type:7,name:"AlbedoSqrt",clearType:0,define:"PREPASS_ALBEDO_SQRT",defineIndex:"PREPASS_ALBEDO_SQRT_INDEX"},{type:8,name:"WorldNormal",clearType:0,define:"PREPASS_WORLD_NORMAL",defineIndex:"PREPASS_WORLD_NORMAL_INDEX"},{type:9,name:"LocalPosition",clearType:0,define:"PREPASS_LOCAL_POSITION",defineIndex:"PREPASS_LOCAL_POSITION_INDEX"},{type:10,name:"ScreenDepth",clearType:1,define:"PREPASS_SCREENSPACE_DEPTH",defineIndex:"PREPASS_SCREENSPACE_DEPTH_INDEX"},{type:11,name:"LinearVelocity",clearType:0,define:"PREPASS_VELOCITY_LINEAR",defineIndex:"PREPASS_VELOCITY_LINEAR_INDEX"},{type:12,name:"Albedo",clearType:0,define:"PREPASS_ALBEDO",defineIndex:"PREPASS_ALBEDO_INDEX"}];si._Configurations={};const Bo={effect:null,subMesh:null};class CR extends ji{constructor(e){super(e),this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.OPACITY=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.REFLECTION=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.SPECULAR=!1,this.SPECULARDIRECTUV=0,this.BUMP=!1,this.BUMPDIRECTUV=0,this.PARALLAX=!1,this.PARALLAX_RHS=!1,this.PARALLAXOCCLUSION=!1,this.SPECULAROVERALPHA=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHAFROMDIFFUSE=!1,this.POINTSIZE=!1,this.FOG=!1,this.SPECULARTERM=!1,this.DIFFUSEFRESNEL=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONFRESNEL=!1,this.REFRACTIONFRESNEL=!1,this.EMISSIVEFRESNEL=!1,this.FRESNEL=!1,this.NORMAL=!1,this.TANGENT=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.VERTEXCOLOR=!1,this.VERTEXALPHA=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.GLOSSINESS=!1,this.ROUGHNESS=!1,this.EMISSIVEASILLUMINATION=!1,this.LINKEMISSIVEWITHDIFFUSE=!1,this.REFLECTIONFRESNELFROMSPECULAR=!1,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.USELIGHTMAPASSHADOWMAP=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.INVERTCUBICMAP=!1,this.LOGARITHMICDEPTH=!1,this.REFRACTION=!1,this.REFRACTIONMAP_3D=!1,this.REFLECTIONOVERALPHA=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_POSITION=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.MORPHTARGETS_UV2=!1,this.MORPHTARGETS_COLOR=!1,this.MORPHTARGETTEXTURE_HASPOSITIONS=!1,this.MORPHTARGETTEXTURE_HASNORMALS=!1,this.MORPHTARGETTEXTURE_HASTANGENTS=!1,this.MORPHTARGETTEXTURE_HASUVS=!1,this.MORPHTARGETTEXTURE_HASUV2S=!1,this.MORPHTARGETTEXTURE_HASCOLORS=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.NONUNIFORMSCALING=!1,this.PREMULTIPLYALPHA=!1,this.ALPHATEST_AFTERALLALPHACOMPUTATIONS=!1,this.ALPHABLEND=!0,this.PREPASS=!1,this.PREPASS_COLOR=!1,this.PREPASS_COLOR_INDEX=-1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO=!1,this.PREPASS_ALBEDO_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_SCREENSPACE_DEPTH=!1,this.PREPASS_SCREENSPACE_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_NORMAL_WORLDSPACE=!1,this.PREPASS_WORLD_NORMAL=!1,this.PREPASS_WORLD_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_LOCAL_POSITION=!1,this.PREPASS_LOCAL_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_VELOCITY_LINEAR=!1,this.PREPASS_VELOCITY_LINEAR_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.RGBDLIGHTMAP=!1,this.RGBDREFLECTION=!1,this.RGBDREFRACTION=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.AREALIGHTSUPPORTED=!0,this.IS_REFLECTION_LINEAR=!1,this.IS_REFRACTION_LINEAR=!1,this.EXPOSURE=!1,this.DECAL_AFTER_DETAIL=!1,this.rebuild()}setReflectionMode(e){const t=["REFLECTIONMAP_CUBIC","REFLECTIONMAP_EXPLICIT","REFLECTIONMAP_PLANAR","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_SKYBOX","REFLECTIONMAP_SPHERICAL","REFLECTIONMAP_EQUIRECTANGULAR","REFLECTIONMAP_EQUIRECTANGULAR_FIXED","REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"];for(const i of t)this[i]=i===e}}class se extends Un{get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}get isPrePassCapable(){return!this.disableDepthWrite}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}get canRenderToMRT(){return!0}constructor(e,t,i=!1){super(e,t,void 0,i||se.ForceGLSL),this._diffuseTexture=null,this._ambientTexture=null,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._specularTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._refractionTexture=null,this.ambientColor=new ae(0,0,0),this.diffuseColor=new ae(1,1,1),this.specularColor=new ae(1,1,1),this.emissiveColor=new ae(0,0,0),this.specularPower=64,this._useAlphaFromDiffuseTexture=!1,this._useEmissiveAsIllumination=!1,this._linkEmissiveWithDiffuse=!1,this._useSpecularOverAlpha=!1,this._useReflectionOverAlpha=!1,this._disableLighting=!1,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this._roughness=0,this.indexOfRefraction=.98,this.invertRefractionY=!0,this.alphaCutOff=.4,this._useLightmapAsShadowmap=!1,this._useReflectionFresnelFromSpecular=!1,this._useGlossinessFromSpecularMapAlpha=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._applyDecalMapAfterDetailMap=!1,this._shadersLoaded=!1,this._renderTargets=new jt(16),this._globalAmbientColor=new ae(0,0,0),this._cacheHasRenderTargetTextures=!1,this.detailMap=new ss(this),this._attachImageProcessingConfiguration(null),this.prePassConfiguration=new Ia,this.getRenderTargetTextures=()=>(this._renderTargets.reset(),se.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),se.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&this._renderTargets.push(this._refractionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets)}get hasRenderTargetTextures(){return se.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget||se.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget?!0:this._cacheHasRenderTargetTextures}getClassName(){return"StandardMaterial"}needAlphaBlending(){return this._hasTransparencyMode?this._transparencyModeIsBlend:this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled}needAlphaTesting(){return this._hasTransparencyMode?this._transparencyModeIsTest:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===q.MATERIAL_ALPHATEST)}_shouldUseAlphaFromDiffuseTexture(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture&&this._transparencyMode!==q.MATERIAL_OPAQUE}_hasAlphaChannel(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._opacityTexture!=null}getAlphaTestTexture(){return this._diffuseTexture}isReadyForSubMesh(e,t,i=!1){this._uniformBufferLayoutBuilt||this.buildUniformLayout();const r=t._drawWrapper;if(r.effect&&this.isFrozen&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(4,this._eventInfo),t.materialDefines=new CR(this._eventInfo.defineNames));const s=this.getScene(),n=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const o=s.getEngine();n._needNormals=Pc(s,e,n,!0,this._maxSimultaneousLights,this._disableLighting),Lc(s,n);const l=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(Nc(s,n,this.canRenderToMRT&&!l),Um(s,n,l),si.PrepareDefines(o.currentRenderPassId,e,n),n._areTexturesDirty){this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,n._needUVs=!1;for(let h=1;h<=6;++h)n["MAINUV"+h]=!1;if(s.texturesEnabled){if(n.DIFFUSEDIRECTUV=0,n.BUMPDIRECTUV=0,n.AMBIENTDIRECTUV=0,n.OPACITYDIRECTUV=0,n.EMISSIVEDIRECTUV=0,n.SPECULARDIRECTUV=0,n.LIGHTMAPDIRECTUV=0,this._diffuseTexture&&se.DiffuseTextureEnabled)if(this._diffuseTexture.isReadyOrNotBlocking())ht(this._diffuseTexture,n,"DIFFUSE");else return!1;else n.DIFFUSE=!1;if(this._ambientTexture&&se.AmbientTextureEnabled)if(this._ambientTexture.isReadyOrNotBlocking())ht(this._ambientTexture,n,"AMBIENT");else return!1;else n.AMBIENT=!1;if(this._opacityTexture&&se.OpacityTextureEnabled)if(this._opacityTexture.isReadyOrNotBlocking())ht(this._opacityTexture,n,"OPACITY"),n.OPACITYRGB=this._opacityTexture.getAlphaFromRGB;else return!1;else n.OPACITY=!1;if(this._reflectionTexture&&se.ReflectionTextureEnabled)if(this._reflectionTexture.isReadyOrNotBlocking()){switch(n._needNormals=!0,n.REFLECTION=!0,n.ROUGHNESS=this._roughness>0,n.REFLECTIONOVERALPHA=this._useReflectionOverAlpha,n.INVERTCUBICMAP=this._reflectionTexture.coordinatesMode===Z.INVCUBIC_MODE,n.REFLECTIONMAP_3D=this._reflectionTexture.isCube,n.REFLECTIONMAP_OPPOSITEZ=n.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!this._reflectionTexture.invertZ:this._reflectionTexture.invertZ,n.RGBDREFLECTION=this._reflectionTexture.isRGBD,this._reflectionTexture.coordinatesMode){case Z.EXPLICIT_MODE:n.setReflectionMode("REFLECTIONMAP_EXPLICIT");break;case Z.PLANAR_MODE:n.setReflectionMode("REFLECTIONMAP_PLANAR");break;case Z.PROJECTION_MODE:n.setReflectionMode("REFLECTIONMAP_PROJECTION");break;case Z.SKYBOX_MODE:n.setReflectionMode("REFLECTIONMAP_SKYBOX");break;case Z.SPHERICAL_MODE:n.setReflectionMode("REFLECTIONMAP_SPHERICAL");break;case Z.EQUIRECTANGULAR_MODE:n.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR");break;case Z.FIXED_EQUIRECTANGULAR_MODE:n.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR_FIXED");break;case Z.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:n.setReflectionMode("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED");break;case Z.CUBIC_MODE:case Z.INVCUBIC_MODE:default:n.setReflectionMode("REFLECTIONMAP_CUBIC");break}n.USE_LOCAL_REFLECTIONMAP_CUBIC=!!this._reflectionTexture.boundingBoxSize}else return!1;else n.REFLECTION=!1,n.REFLECTIONMAP_OPPOSITEZ=!1;if(this._emissiveTexture&&se.EmissiveTextureEnabled)if(this._emissiveTexture.isReadyOrNotBlocking())ht(this._emissiveTexture,n,"EMISSIVE");else return!1;else n.EMISSIVE=!1;if(this._lightmapTexture&&se.LightmapTextureEnabled)if(this._lightmapTexture.isReadyOrNotBlocking())ht(this._lightmapTexture,n,"LIGHTMAP"),n.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,n.RGBDLIGHTMAP=this._lightmapTexture.isRGBD;else return!1;else n.LIGHTMAP=!1;if(this._specularTexture&&se.SpecularTextureEnabled)if(this._specularTexture.isReadyOrNotBlocking())ht(this._specularTexture,n,"SPECULAR"),n.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha;else return!1;else n.SPECULAR=!1;if(s.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&se.BumpTextureEnabled){if(this._bumpTexture.isReady())ht(this._bumpTexture,n,"BUMP"),n.PARALLAX=this._useParallax,n.PARALLAX_RHS=s.useRightHandedSystem,n.PARALLAXOCCLUSION=this._useParallaxOcclusion;else return!1;n.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap}else n.BUMP=!1,n.PARALLAX=!1,n.PARALLAX_RHS=!1,n.PARALLAXOCCLUSION=!1;if(this._refractionTexture&&se.RefractionTextureEnabled)if(this._refractionTexture.isReadyOrNotBlocking())n._needUVs=!0,n.REFRACTION=!0,n.REFRACTIONMAP_3D=this._refractionTexture.isCube,n.RGBDREFRACTION=this._refractionTexture.isRGBD,n.USE_LOCAL_REFRACTIONMAP_CUBIC=!!this._refractionTexture.boundingBoxSize;else return!1;else n.REFRACTION=!1;n.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting}else n.DIFFUSE=!1,n.AMBIENT=!1,n.OPACITY=!1,n.REFLECTION=!1,n.EMISSIVE=!1,n.LIGHTMAP=!1,n.BUMP=!1,n.REFRACTION=!1;n.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture(),n.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination,n.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse,n.SPECULAROVERALPHA=this._useSpecularOverAlpha,n.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,n.ALPHATEST_AFTERALLALPHACOMPUTATIONS=this.transparencyMode!==null,n.ALPHABLEND=this.transparencyMode===null||this.needAlphaBlendingForMesh(e)}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=n,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(n._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(n),n.IS_REFLECTION_LINEAR=this.reflectionTexture!=null&&!this.reflectionTexture.gammaSpace,n.IS_REFRACTION_LINEAR=this.refractionTexture!=null&&!this.refractionTexture.gammaSpace}if(n._areFresnelDirty&&(se.FresnelEnabled?(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters)&&(n.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled,n.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled,n.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled,n.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular,n.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled,n.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled,n._needNormals=!0,n.FRESNEL=!0):n.FRESNEL=!1),n.AREALIGHTUSED){for(let h=0;h<e.lightSources.length;h++)if(!e.lightSources[h]._isReady())return!1}Mc(e,s,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this.needAlphaTestingForMesh(e),n,this._applyDecalMapAfterDetailMap),Oc(s,o,this,n,i,null,t.getRenderingMesh().hasThinInstances),this._eventInfo.defines=n,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),Dc(e,n,!0,!0,!0),this._callbackPluginEventPrepareDefines(this._eventInfo);let c=!1;if(n.isDirty){const h=n._areLightsDisposed;n.markAsProcessed();const f=new Vn;n.REFLECTION&&f.addFallback(0,"REFLECTION"),n.SPECULAR&&f.addFallback(0,"SPECULAR"),n.BUMP&&f.addFallback(0,"BUMP"),n.PARALLAX&&f.addFallback(1,"PARALLAX"),n.PARALLAX_RHS&&f.addFallback(1,"PARALLAX_RHS"),n.PARALLAXOCCLUSION&&f.addFallback(0,"PARALLAXOCCLUSION"),n.SPECULAROVERALPHA&&f.addFallback(0,"SPECULAROVERALPHA"),n.FOG&&f.addFallback(1,"FOG"),n.POINTSIZE&&f.addFallback(0,"POINTSIZE"),n.LOGARITHMICDEPTH&&f.addFallback(0,"LOGARITHMICDEPTH"),yc(n,f,this._maxSimultaneousLights),n.SPECULARTERM&&f.addFallback(0,"SPECULARTERM"),n.DIFFUSEFRESNEL&&f.addFallback(1,"DIFFUSEFRESNEL"),n.OPACITYFRESNEL&&f.addFallback(2,"OPACITYFRESNEL"),n.REFLECTIONFRESNEL&&f.addFallback(3,"REFLECTIONFRESNEL"),n.EMISSIVEFRESNEL&&f.addFallback(4,"EMISSIVEFRESNEL"),n.FRESNEL&&f.addFallback(4,"FRESNEL"),n.MULTIVIEW&&f.addFallback(0,"MULTIVIEW");const u=[x.PositionKind];n.NORMAL&&u.push(x.NormalKind),n.TANGENT&&u.push(x.TangentKind);for(let T=1;T<=6;++T)n["UV"+T]&&u.push(`uv${T===1?"":T}`);n.VERTEXCOLOR&&u.push(x.ColorKind),bc(u,e,n,f),xc(u,n),Ac(u,e,n),Cc(u,e,n);let d="default";const _=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","visibility","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","normalMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","vReflectionPosition","vReflectionSize","vRefractionPosition","vRefractionSize","logarithmicDepthConstant","vTangentSpaceParams","alphaCutOff","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices"],p=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler","boneSampler","morphTargets","oitDepthSampler","oitFrontColorSampler","areaLightsLTC1Sampler","areaLightsLTC2Sampler"],g=["Material","Scene","Mesh"],E={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:n.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=f,this._eventInfo.fallbackRank=0,this._eventInfo.defines=n,this._eventInfo.uniforms=_,this._eventInfo.attributes=u,this._eventInfo.samplers=p,this._eventInfo.uniformBuffersNames=g,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=E,this._callbackPluginEventGeneric(128,this._eventInfo),si.AddUniformsAndSamplers(_,p),Ia.AddUniforms(_),ze&&(ze.PrepareUniforms(_,n),ze.PrepareSamplers(p,n)),Fc({uniformsNames:_,uniformBuffersNames:g,samplers:p,defines:n,maxSimultaneousLights:this._maxSimultaneousLights}),Ba(_);const v={};this.customShaderNameResolve&&(d=this.customShaderNameResolve(d,_,g,p,n,u,v));const b=n.toString(),R=t.effect;let S=s.getEngine().createEffect(d,{attributes:u,uniformsNames:_,uniformBuffersNames:g,samplers:p,defines:b,fallbacks:f,onCompiled:this.onCompiled,onError:this.onError,indexParameters:E,processFinalCode:v.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:n.PREPASS,shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:async()=>{this._shaderLanguage===1?await Promise.all([X(()=>Promise.resolve().then(()=>oy),void 0,import.meta.url),X(()=>Promise.resolve().then(()=>Dy),void 0,import.meta.url)]):await Promise.all([X(()=>Promise.resolve().then(()=>mM),void 0,import.meta.url),X(()=>Promise.resolve().then(()=>HM),void 0,import.meta.url)]),this._shadersLoaded=!0}},o);if(this._eventInfo.customCode=void 0,S)if(this._onEffectCreatedObservable&&(Bo.effect=S,Bo.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Bo)),this.allowShaderHotSwapping&&R&&!S.isReady()){if(S=R,n.markAsUnprocessed(),c=this.isFrozen,h)return n._areLightsDisposed=!0,!1}else s.resetCachedMaterial(),t.setEffect(S,n,this._materialContext)}return!t.effect||!t.effect.isReady()?!1:(n._renderId=s.getRenderId(),r._wasPreviouslyReady=!c,r._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),!0)}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("diffuseLeftColor",4),e.addUniform("diffuseRightColor",4),e.addUniform("opacityParts",4),e.addUniform("reflectionLeftColor",4),e.addUniform("reflectionRightColor",4),e.addUniform("refractionLeftColor",4),e.addUniform("refractionRightColor",4),e.addUniform("emissiveLeftColor",4),e.addUniform("emissiveRightColor",4),e.addUniform("vDiffuseInfos",2),e.addUniform("vAmbientInfos",2),e.addUniform("vOpacityInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vSpecularInfos",2),e.addUniform("vBumpInfos",3),e.addUniform("diffuseMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("reflectionMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("specularMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("pointSize",1),e.addUniform("alphaCutOff",1),e.addUniform("refractionMatrix",16),e.addUniform("vRefractionInfos",4),e.addUniform("vRefractionPosition",3),e.addUniform("vRefractionSize",3),e.addUniform("vSpecularColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vDiffuseColor",4),e.addUniform("vAmbientColor",3),super.buildUniformLayout()}bindForSubMesh(e,t,i){var c;const r=this.getScene(),s=i.materialDefines;if(!s)return;const n=i.effect;if(!n)return;this._activeEffect=n,t.getMeshUniformBuffer().bindToEffect(n,"Mesh"),t.transferToEffect(e),this._uniformBuffer.bindToEffect(n,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,r,t,e,this.isFrozen),si.Bind(r.getEngine().currentRenderPassId,this._activeEffect,t,e,this),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),s.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const o=this._mustRebind(r,n,i,t.visibility);Ga(t,n);const l=this._uniformBuffer;if(o){if(this.bindViewProjection(n),!l.useUbo||!this.isFrozen||!l.isSync||i._drawWrapper._forceRebindOnNextCall){if(se.FresnelEnabled&&s.FRESNEL&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(l.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),l.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&l.updateColor4("opacityParts",new ae(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(l.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),l.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(l.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),l.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(l.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),l.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),r.texturesEnabled){if(this._diffuseTexture&&se.DiffuseTextureEnabled&&(l.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),ft(this._diffuseTexture,l,"diffuse")),this._ambientTexture&&se.AmbientTextureEnabled&&(l.updateFloat2("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level),ft(this._ambientTexture,l,"ambient")),this._opacityTexture&&se.OpacityTextureEnabled&&(l.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),ft(this._opacityTexture,l,"opacity")),this._hasAlphaChannel()&&l.updateFloat("alphaCutOff",this.alphaCutOff),this._reflectionTexture&&se.ReflectionTextureEnabled){if(l.updateFloat2("vReflectionInfos",this._reflectionTexture.level,this.roughness),l.updateMatrix("reflectionMatrix",this._reflectionTexture.getReflectionTextureMatrix()),this._reflectionTexture.boundingBoxSize){const h=this._reflectionTexture;l.updateVector3("vReflectionPosition",h.boundingBoxPosition),l.updateVector3("vReflectionSize",h.boundingBoxSize)}}else l.updateFloat2("vReflectionInfos",0,this.roughness);if(this._emissiveTexture&&se.EmissiveTextureEnabled&&(l.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),ft(this._emissiveTexture,l,"emissive")),this._lightmapTexture&&se.LightmapTextureEnabled&&(l.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),ft(this._lightmapTexture,l,"lightmap")),this._specularTexture&&se.SpecularTextureEnabled&&(l.updateFloat2("vSpecularInfos",this._specularTexture.coordinatesIndex,this._specularTexture.level),ft(this._specularTexture,l,"specular")),this._bumpTexture&&r.getEngine().getCaps().standardDerivatives&&se.BumpTextureEnabled&&(l.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias),ft(this._bumpTexture,l,"bump"),r._mirroredCameraPosition?l.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):l.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),this._refractionTexture&&se.RefractionTextureEnabled){let h=1;if(this._refractionTexture.isCube||(l.updateMatrix("refractionMatrix",this._refractionTexture.getReflectionTextureMatrix()),this._refractionTexture.depth&&(h=this._refractionTexture.depth)),l.updateFloat4("vRefractionInfos",this._refractionTexture.level,this.indexOfRefraction,h,this.invertRefractionY?-1:1),this._refractionTexture.boundingBoxSize){const f=this._refractionTexture;l.updateVector3("vRefractionPosition",f.boundingBoxPosition),l.updateVector3("vRefractionSize",f.boundingBoxSize)}}}this.pointsCloud&&l.updateFloat("pointSize",this.pointSize),l.updateColor4("vSpecularColor",this.specularColor,this.specularPower),l.updateColor3("vEmissiveColor",se.EmissiveTextureEnabled?this.emissiveColor:ae.BlackReadOnly),l.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha),r.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),l.updateColor3("vAmbientColor",this._globalAmbientColor)}r.texturesEnabled&&(this._diffuseTexture&&se.DiffuseTextureEnabled&&n.setTexture("diffuseSampler",this._diffuseTexture),this._ambientTexture&&se.AmbientTextureEnabled&&n.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&se.OpacityTextureEnabled&&n.setTexture("opacitySampler",this._opacityTexture),this._reflectionTexture&&se.ReflectionTextureEnabled&&(this._reflectionTexture.isCube?n.setTexture("reflectionCubeSampler",this._reflectionTexture):n.setTexture("reflection2DSampler",this._reflectionTexture)),this._emissiveTexture&&se.EmissiveTextureEnabled&&n.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&se.LightmapTextureEnabled&&n.setTexture("lightmapSampler",this._lightmapTexture),this._specularTexture&&se.SpecularTextureEnabled&&n.setTexture("specularSampler",this._specularTexture),this._bumpTexture&&r.getEngine().getCaps().standardDerivatives&&se.BumpTextureEnabled&&n.setTexture("bumpSampler",this._bumpTexture),this._refractionTexture&&se.RefractionTextureEnabled&&(this._refractionTexture.isCube?n.setTexture("refractionCubeSampler",this._refractionTexture):n.setTexture("refraction2DSampler",this._refractionTexture))),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(n),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),Ua(n,this,r),this.bindEyePosition(n)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(o||!this.isFrozen)&&(r.lightsEnabled&&!this._disableLighting&&Ic(r,t,n,s,this._maxSimultaneousLights),(r.fogEnabled&&t.applyFog&&r.fogMode!==Ge.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture||t.receiveShadows||s.PREPASS)&&this.bindView(n),Va(r,t,n),s.NUM_MORPH_INFLUENCERS&&Rc(t,n),s.BAKED_VERTEX_ANIMATION_TEXTURE&&((c=t.bakedVertexAnimationManager)==null||c.bind(n,s.INSTANCES)),this.useLogarithmicDepth&&Bn(s,n,r),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect,i),l.update()}getAnimatables(){const e=super.getAnimatables();return this._diffuseTexture&&this._diffuseTexture.animations&&this._diffuseTexture.animations.length>0&&e.push(this._diffuseTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._specularTexture&&this._specularTexture.animations&&this._specularTexture.animations.length>0&&e.push(this._specularTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),e}getActiveTextures(){const e=super.getActiveTextures();return this._diffuseTexture&&e.push(this._diffuseTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._specularTexture&&e.push(this._specularTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),this._refractionTexture&&e.push(this._refractionTexture),e}hasTexture(e){return!!(super.hasTexture(e)||this._diffuseTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._specularTexture===e||this._bumpTexture===e||this._lightmapTexture===e||this._refractionTexture===e)}dispose(e,t){var i,r,s,n,o,l,c,h,f;t&&((i=this._diffuseTexture)==null||i.dispose(),(r=this._ambientTexture)==null||r.dispose(),(s=this._opacityTexture)==null||s.dispose(),(n=this._reflectionTexture)==null||n.dispose(),(o=this._emissiveTexture)==null||o.dispose(),(l=this._specularTexture)==null||l.dispose(),(c=this._bumpTexture)==null||c.dispose(),(h=this._lightmapTexture)==null||h.dispose(),(f=this._refractionTexture)==null||f.dispose()),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}clone(e,t=!0,i=""){const r=ye.Clone(()=>new se(e,this.getScene()),this,{cloneTexturesOnlyOnce:t});return r.name=e,r.id=e,this.stencil.copyTo(r.stencil),this._clonePlugins(r,i),r}static Parse(e,t,i){const r=ye.Parse(()=>new se(e.name,t),e,t,i);return e.stencil&&r.stencil.parse(e.stencil,t,i),q._ParsePlugins(e,r,t,i),r}static get DiffuseTextureEnabled(){return Q.DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){Q.DiffuseTextureEnabled=e}static get DetailTextureEnabled(){return Q.DetailTextureEnabled}static set DetailTextureEnabled(e){Q.DetailTextureEnabled=e}static get AmbientTextureEnabled(){return Q.AmbientTextureEnabled}static set AmbientTextureEnabled(e){Q.AmbientTextureEnabled=e}static get OpacityTextureEnabled(){return Q.OpacityTextureEnabled}static set OpacityTextureEnabled(e){Q.OpacityTextureEnabled=e}static get ReflectionTextureEnabled(){return Q.ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){Q.ReflectionTextureEnabled=e}static get EmissiveTextureEnabled(){return Q.EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){Q.EmissiveTextureEnabled=e}static get SpecularTextureEnabled(){return Q.SpecularTextureEnabled}static set SpecularTextureEnabled(e){Q.SpecularTextureEnabled=e}static get BumpTextureEnabled(){return Q.BumpTextureEnabled}static set BumpTextureEnabled(e){Q.BumpTextureEnabled=e}static get LightmapTextureEnabled(){return Q.LightmapTextureEnabled}static set LightmapTextureEnabled(e){Q.LightmapTextureEnabled=e}static get RefractionTextureEnabled(){return Q.RefractionTextureEnabled}static set RefractionTextureEnabled(e){Q.RefractionTextureEnabled=e}static get ColorGradingTextureEnabled(){return Q.ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){Q.ColorGradingTextureEnabled=e}static get FresnelEnabled(){return Q.FresnelEnabled}static set FresnelEnabled(e){Q.FresnelEnabled=e}}se.ForceGLSL=!1;A([Je("diffuseTexture")],se.prototype,"_diffuseTexture",void 0);A([j("_markAllSubMeshesAsTexturesAndMiscDirty")],se.prototype,"diffuseTexture",void 0);A([Je("ambientTexture")],se.prototype,"_ambientTexture",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],se.prototype,"ambientTexture",void 0);A([Je("opacityTexture")],se.prototype,"_opacityTexture",void 0);A([j("_markAllSubMeshesAsTexturesAndMiscDirty")],se.prototype,"opacityTexture",void 0);A([Je("reflectionTexture")],se.prototype,"_reflectionTexture",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],se.prototype,"reflectionTexture",void 0);A([Je("emissiveTexture")],se.prototype,"_emissiveTexture",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],se.prototype,"emissiveTexture",void 0);A([Je("specularTexture")],se.prototype,"_specularTexture",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],se.prototype,"specularTexture",void 0);A([Je("bumpTexture")],se.prototype,"_bumpTexture",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],se.prototype,"bumpTexture",void 0);A([Je("lightmapTexture")],se.prototype,"_lightmapTexture",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],se.prototype,"lightmapTexture",void 0);A([Je("refractionTexture")],se.prototype,"_refractionTexture",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],se.prototype,"refractionTexture",void 0);A([Qt("ambient")],se.prototype,"ambientColor",void 0);A([Qt("diffuse")],se.prototype,"diffuseColor",void 0);A([Qt("specular")],se.prototype,"specularColor",void 0);A([Qt("emissive")],se.prototype,"emissiveColor",void 0);A([y()],se.prototype,"specularPower",void 0);A([y("useAlphaFromDiffuseTexture")],se.prototype,"_useAlphaFromDiffuseTexture",void 0);A([j("_markAllSubMeshesAsTexturesAndMiscDirty")],se.prototype,"useAlphaFromDiffuseTexture",void 0);A([y("useEmissiveAsIllumination")],se.prototype,"_useEmissiveAsIllumination",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],se.prototype,"useEmissiveAsIllumination",void 0);A([y("linkEmissiveWithDiffuse")],se.prototype,"_linkEmissiveWithDiffuse",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],se.prototype,"linkEmissiveWithDiffuse",void 0);A([y("useSpecularOverAlpha")],se.prototype,"_useSpecularOverAlpha",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],se.prototype,"useSpecularOverAlpha",void 0);A([y("useReflectionOverAlpha")],se.prototype,"_useReflectionOverAlpha",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],se.prototype,"useReflectionOverAlpha",void 0);A([y("disableLighting")],se.prototype,"_disableLighting",void 0);A([j("_markAllSubMeshesAsLightsDirty")],se.prototype,"disableLighting",void 0);A([y("useObjectSpaceNormalMap")],se.prototype,"_useObjectSpaceNormalMap",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],se.prototype,"useObjectSpaceNormalMap",void 0);A([y("useParallax")],se.prototype,"_useParallax",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],se.prototype,"useParallax",void 0);A([y("useParallaxOcclusion")],se.prototype,"_useParallaxOcclusion",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],se.prototype,"useParallaxOcclusion",void 0);A([y()],se.prototype,"parallaxScaleBias",void 0);A([y("roughness")],se.prototype,"_roughness",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],se.prototype,"roughness",void 0);A([y()],se.prototype,"indexOfRefraction",void 0);A([y()],se.prototype,"invertRefractionY",void 0);A([y()],se.prototype,"alphaCutOff",void 0);A([y("useLightmapAsShadowmap")],se.prototype,"_useLightmapAsShadowmap",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],se.prototype,"useLightmapAsShadowmap",void 0);A([Fn("diffuseFresnelParameters")],se.prototype,"_diffuseFresnelParameters",void 0);A([j("_markAllSubMeshesAsFresnelDirty")],se.prototype,"diffuseFresnelParameters",void 0);A([Fn("opacityFresnelParameters")],se.prototype,"_opacityFresnelParameters",void 0);A([j("_markAllSubMeshesAsFresnelAndMiscDirty")],se.prototype,"opacityFresnelParameters",void 0);A([Fn("reflectionFresnelParameters")],se.prototype,"_reflectionFresnelParameters",void 0);A([j("_markAllSubMeshesAsFresnelDirty")],se.prototype,"reflectionFresnelParameters",void 0);A([Fn("refractionFresnelParameters")],se.prototype,"_refractionFresnelParameters",void 0);A([j("_markAllSubMeshesAsFresnelDirty")],se.prototype,"refractionFresnelParameters",void 0);A([Fn("emissiveFresnelParameters")],se.prototype,"_emissiveFresnelParameters",void 0);A([j("_markAllSubMeshesAsFresnelDirty")],se.prototype,"emissiveFresnelParameters",void 0);A([y("useReflectionFresnelFromSpecular")],se.prototype,"_useReflectionFresnelFromSpecular",void 0);A([j("_markAllSubMeshesAsFresnelDirty")],se.prototype,"useReflectionFresnelFromSpecular",void 0);A([y("useGlossinessFromSpecularMapAlpha")],se.prototype,"_useGlossinessFromSpecularMapAlpha",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],se.prototype,"useGlossinessFromSpecularMapAlpha",void 0);A([y("maxSimultaneousLights")],se.prototype,"_maxSimultaneousLights",void 0);A([j("_markAllSubMeshesAsLightsDirty")],se.prototype,"maxSimultaneousLights",void 0);A([y("invertNormalMapX")],se.prototype,"_invertNormalMapX",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],se.prototype,"invertNormalMapX",void 0);A([y("invertNormalMapY")],se.prototype,"_invertNormalMapY",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],se.prototype,"invertNormalMapY",void 0);A([y("twoSidedLighting")],se.prototype,"_twoSidedLighting",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],se.prototype,"twoSidedLighting",void 0);A([y("applyDecalMapAfterDetailMap")],se.prototype,"_applyDecalMapAfterDetailMap",void 0);A([j("_markAllSubMeshesAsMiscDirty")],se.prototype,"applyDecalMapAfterDetailMap",void 0);Y("BABYLON.StandardMaterial",se);Ge.DefaultMaterialFactory=a=>new se("default material",a);class Er{constructor(e,t,i,r){this.x=e,this.y=t,this.width=i,this.height=r}toGlobal(e,t){return new Er(this.x*e,this.y*t,this.width*e,this.height*t)}toGlobalToRef(e,t,i){return i.x=this.x*e,i.y=this.y*t,i.width=this.width*e,i.height=this.height*t,this}clone(){return new Er(this.x,this.y,this.width,this.height)}}const cl="postprocessVertexShader",Gm=`attribute vec2 position;uniform vec2 scale;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=(position*madd+madd)*scale;gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;C.ShadersStore[cl]||(C.ShadersStore[cl]=Gm);const IR={name:cl,shader:Gm},km=Object.freeze(Object.defineProperty({__proto__:null,postprocessVertexShader:IR},Symbol.toStringTag,{value:"Module"})),Uo={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};class bR{constructor(e,t=Uo){this._fullscreenViewport=new Er(0,0,1,1);const i=t.positions??Uo.positions,r=t.indices??Uo.indices;this.engine=e,this._vertexBuffers={[x.PositionKind]:new x(e,i,x.PositionKind,!1,!1,2)},this._indexBuffer=e.createIndexBuffer(r),this._onContextRestoredObserver=e.onContextRestoredObservable.add(()=>{this._indexBuffer=e.createIndexBuffer(r);for(const s in this._vertexBuffers)this._vertexBuffers[s]._rebuild()})}setViewport(e=this._fullscreenViewport){this.engine.setViewport(e)}bindBuffers(e){this.engine.bindBuffers(this._vertexBuffers,this._indexBuffer,e)}applyEffectWrapper(e){this.engine.setState(!0),this.engine.depthCullingState.depthTest=!1,this.engine.stencilState.stencilTest=!1,this.engine.enableEffect(e.drawWrapper),this.bindBuffers(e.effect),e.onApplyObservable.notifyObservers({})}saveStates(){this._savedStateDepthTest=this.engine.depthCullingState.depthTest,this._savedStateStencilTest=this.engine.stencilState.stencilTest}restoreStates(){this.engine.depthCullingState.depthTest=this._savedStateDepthTest,this.engine.stencilState.stencilTest=this._savedStateStencilTest}draw(){this.engine.drawElementsType(0,0,6)}_isRenderTargetTexture(e){return e.renderTarget!==void 0}render(e,t=null){if(!e.effect.isReady())return;this.saveStates(),this.setViewport();const i=t===null?null:this._isRenderTargetTexture(t)?t.renderTarget:t;i&&this.engine.bindFramebuffer(i),this.applyEffectWrapper(e),this.draw(),i&&this.engine.unBindFramebuffer(i),this.restoreStates()}dispose(){const e=this._vertexBuffers[x.PositionKind];e&&(e.dispose(),delete this._vertexBuffers[x.PositionKind]),this._indexBuffer&&this.engine._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.engine.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}}class ni{static RegisterShaderCodeProcessing(e,t){if(!t){delete ni._CustomShaderCodeProcessing[e??""];return}ni._CustomShaderCodeProcessing[e??""]=t}static _GetShaderCodeProcessing(e){return ni._CustomShaderCodeProcessing[e]??ni._CustomShaderCodeProcessing[""]}get name(){return this.options.name}set name(e){this.options.name=e}isReady(){var e;return((e=this._drawWrapper.effect)==null?void 0:e.isReady())??!1}get drawWrapper(){return this._drawWrapper}get effect(){return this._drawWrapper.effect}set effect(e){this._drawWrapper.effect=e}constructor(e){this.alphaMode=0,this.onEffectCreatedObservable=new U(void 0,!0),this.onApplyObservable=new U,this._shadersLoaded=!1,this._webGPUReady=!1,this._importPromises=[],this.options={...e,name:e.name||"effectWrapper",engine:e.engine,uniforms:e.uniforms||e.uniformNames||[],uniformNames:void 0,samplers:e.samplers||e.samplerNames||[],samplerNames:void 0,attributeNames:e.attributeNames||["position"],uniformBuffers:e.uniformBuffers||[],defines:e.defines||"",useShaderStore:e.useShaderStore||!1,vertexUrl:e.vertexUrl||e.vertexShader||"postprocess",vertexShader:void 0,fragmentShader:e.fragmentShader||"pass",indexParameters:e.indexParameters,blockCompilation:e.blockCompilation||!1,shaderLanguage:e.shaderLanguage||0,onCompiled:e.onCompiled||void 0,extraInitializations:e.extraInitializations||void 0,extraInitializationsAsync:e.extraInitializationsAsync||void 0,useAsPostProcess:e.useAsPostProcess??!1},this.options.uniformNames=this.options.uniforms,this.options.samplerNames=this.options.samplers,this.options.vertexShader=this.options.vertexUrl,this.options.useAsPostProcess&&(this.options.samplers.indexOf("textureSampler")===-1&&this.options.samplers.push("textureSampler"),this.options.uniforms.indexOf("scale")===-1&&this.options.uniforms.push("scale")),e.vertexUrl||e.vertexShader?this._shaderPath={vertexSource:this.options.vertexShader}:(this.options.useAsPostProcess||(this.options.uniforms.push("scale"),this.onApplyObservable.add(()=>{this.effect.setFloat2("scale",1,1)})),this._shaderPath={vertex:this.options.vertexShader}),this._shaderPath.fragmentSource=this.options.fragmentShader,this._shaderPath.spectorName=this.options.name,this.options.useShaderStore&&(this._shaderPath.fragment=this._shaderPath.fragmentSource,this._shaderPath.vertex||(this._shaderPath.vertex=this._shaderPath.vertexSource),delete this._shaderPath.fragmentSource,delete this._shaderPath.vertexSource),this.onApplyObservable.add(()=>{this.bind()}),this.options.useShaderStore||(this._onContextRestoredObserver=this.options.engine.onContextRestoredObservable.add(()=>{this.effect._pipelineContext=null,this.effect._prepareEffect()})),this._drawWrapper=new wa(this.options.engine),this._webGPUReady=this.options.shaderLanguage===1;const t=Array.isArray(this.options.defines)?this.options.defines.join(`
`):this.options.defines;this._postConstructor(this.options.blockCompilation,t,this.options.extraInitializations)}_gatherImports(e=!1,t){this.options.useAsPostProcess&&(e&&this._webGPUReady?t.push(Promise.all([X(()=>Promise.resolve().then(()=>LE),void 0,import.meta.url)])):t.push(Promise.all([X(()=>Promise.resolve().then(()=>km),void 0,import.meta.url)])))}_postConstructor(e,t=null,i,r){this._importPromises.length=0,r&&this._importPromises.push(...r);const s=this.options.engine.isWebGPU&&!ni.ForceGLSL;this._gatherImports(s,this._importPromises),i!==void 0&&i(s,this._importPromises),s&&this._webGPUReady&&(this.options.shaderLanguage=1),e||this.updateEffect(t)}updateEffect(e=null,t=null,i=null,r,s,n,o,l){const c=ni._GetShaderCodeProcessing(this.name);if(c!=null&&c.defineCustomBindings){const u=(t==null?void 0:t.slice())??[];u.push(...this.options.uniforms);const d=(i==null?void 0:i.slice())??[];d.push(...this.options.samplers),e=c.defineCustomBindings(this.name,e,u,d),t=u,i=d}this.options.defines=e||"";const h=this._shadersLoaded||this._importPromises.length===0?void 0:async()=>{await Promise.all(this._importPromises),this._shadersLoaded=!0};let f;this.options.extraInitializationsAsync?f=async()=>{h==null||h(),await this.options.extraInitializationsAsync()}:f=h,this.options.useShaderStore?this._drawWrapper.effect=this.options.engine.createEffect({vertex:o??this._shaderPath.vertex,fragment:l??this._shaderPath.fragment},{attributes:this.options.attributeNames,uniformsNames:t||this.options.uniforms,uniformBuffersNames:this.options.uniformBuffers,samplers:i||this.options.samplers,defines:e!==null?e:"",fallbacks:null,onCompiled:s??this.options.onCompiled,onError:n??null,indexParameters:r||this.options.indexParameters,processCodeAfterIncludes:c!=null&&c.processCodeAfterIncludes?(u,d)=>c.processCodeAfterIncludes(this.name,u,d):null,processFinalCode:c!=null&&c.processFinalCode?(u,d)=>c.processFinalCode(this.name,u,d):null,shaderLanguage:this.options.shaderLanguage,extraInitializationsAsync:f},this.options.engine):this._drawWrapper.effect=new lt(this._shaderPath,this.options.attributeNames,t||this.options.uniforms,i||this.options.samplerNames,this.options.engine,e,void 0,s||this.options.onCompiled,void 0,void 0,void 0,this.options.shaderLanguage,f),this.onEffectCreatedObservable.notifyObservers(this._drawWrapper.effect)}bind(){var e,t;this.options.useAsPostProcess&&(this.options.engine.setAlphaMode(this.alphaMode),this.drawWrapper.effect.setFloat2("scale",1,1)),(t=(e=ni._GetShaderCodeProcessing(this.name))==null?void 0:e.bindCustomBindings)==null||t.call(e,this.name,this._drawWrapper.effect)}dispose(e=!1){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.onEffectCreatedObservable.clear(),this._drawWrapper.dispose(!0)}}ni.ForceGLSL=!1;ni._CustomShaderCodeProcessing={};H.prototype.setTextureFromPostProcess=function(a,e,t){let i=null;e&&(e._forcedOutputTexture?i=e._forcedOutputTexture:e._textures.data[e._currentRenderTextureInd]&&(i=e._textures.data[e._currentRenderTextureInd])),this._bindTexture(a,(i==null?void 0:i.texture)??null,t)};H.prototype.setTextureFromPostProcessOutput=function(a,e,t){var i;this._bindTexture(a,((i=e==null?void 0:e._outputTexture)==null?void 0:i.texture)??null,t)};lt.prototype.setTextureFromPostProcess=function(a,e){this._engine.setTextureFromPostProcess(this._samplers[a],e,a)};lt.prototype.setTextureFromPostProcessOutput=function(a,e){this._engine.setTextureFromPostProcessOutput(this._samplers[a],e,a)};class At{static get ForceGLSL(){return ni.ForceGLSL}static set ForceGLSL(e){ni.ForceGLSL=e}static RegisterShaderCodeProcessing(e,t){ni.RegisterShaderCodeProcessing(e,t)}get name(){return this._effectWrapper.name}set name(e){this._effectWrapper.name=e}get alphaMode(){return this._effectWrapper.alphaMode}set alphaMode(e){this._effectWrapper.alphaMode=e}get samples(){return this._samples}set samples(e){this._samples=Math.min(e,this._engine.getCaps().maxMSAASamples),this._textures.forEach(t=>{t.setSamples(this._samples)})}get shaderLanguage(){return this._shaderLanguage}getEffectName(){return this._fragmentUrl}set onActivate(e){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),e&&(this._onActivateObserver=this.onActivateObservable.add(e))}set onSizeChanged(e){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(e)}set onApply(e){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(e){this._forcedOutputTexture=e}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}constructor(e,t,i,r,s,n,o=1,l,c,h=null,f=0,u="postprocess",d,_=!1,p=5,g,E){this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=!0,this.forceAutoClearInAlphaMode=!1,this.animations=[],this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._webGPUReady=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new jt(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new ne(1,1),this._texelSize=ne.Zero(),this.onActivateObservable=new U,this.onSizeChangedObservable=new U,this.onApplyObservable=new U,this.onBeforeRenderObservable=new U,this.onAfterRenderObservable=new U,this.onDisposeObservable=new U;let v=1,b=null,R;if(i&&!Array.isArray(i)){const S=i;i=S.uniforms??null,r=S.samplers??null,v=S.size??1,n=S.camera??null,o=S.samplingMode??1,l=S.engine,c=S.reusable,h=Array.isArray(S.defines)?S.defines.join(`
`):S.defines??null,f=S.textureType??0,u=S.vertexUrl??"postprocess",d=S.indexParameters,_=S.blockCompilation??!1,p=S.textureFormat??5,g=S.shaderLanguage??0,b=S.uniformBuffers??null,E=S.extraInitializations,R=S.effectWrapper}else s&&(typeof s=="number"?v=s:v={width:s.width,height:s.height});if(this._useExistingThinPostProcess=!!R,this._effectWrapper=R??new ni({name:e,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:t,engine:l||(n==null?void 0:n.getScene().getEngine()),uniforms:i,samplers:r,uniformBuffers:b,defines:h,vertexUrl:u,indexParameters:d,blockCompilation:!0,shaderLanguage:g,extraInitializations:void 0}),this.name=e,this.onEffectCreatedObservable=this._effectWrapper.onEffectCreatedObservable,n!=null?(this._camera=n,this._scene=n.getScene(),n.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):l&&(this._engine=l,this._engine.postProcesses.push(this)),this._options=v,this.renderTargetSamplingMode=o||1,this._reusable=c||!1,this._textureType=f,this._textureFormat=p,this._shaderLanguage=g||0,this._samplers=r||[],this._samplers.indexOf("textureSampler")===-1&&this._samplers.push("textureSampler"),this._fragmentUrl=t,this._vertexUrl=u,this._parameters=i||[],this._parameters.indexOf("scale")===-1&&this._parameters.push("scale"),this._uniformBuffers=b||[],this._indexParameters=d,!this._useExistingThinPostProcess){this._webGPUReady=this._shaderLanguage===1;const S=[];this._gatherImports(this._engine.isWebGPU&&!At.ForceGLSL,S),this._effectWrapper._webGPUReady=this._webGPUReady,this._effectWrapper._postConstructor(_,h,E,S)}}_gatherImports(e=!1,t){e&&this._webGPUReady?t.push(Promise.all([X(()=>Promise.resolve().then(()=>LE),void 0,import.meta.url)])):t.push(Promise.all([X(()=>Promise.resolve().then(()=>km),void 0,import.meta.url)]))}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._effectWrapper.drawWrapper.effect}shareOutputWith(e){return this._disposeTextures(),this._shareOutputWithPostProcess=e,this}useOwnOutput(){this._textures.length==0&&(this._textures=new jt(2)),this._shareOutputWithPostProcess=null}updateEffect(e=null,t=null,i=null,r,s,n,o,l){this._effectWrapper.updateEffect(e,t,i,r,s,n,o,l),this._postProcessDefines=Array.isArray(this._effectWrapper.options.defines)?this._effectWrapper.options.defines.join(`
`):this._effectWrapper.options.defines}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(e,t,i=0){for(let s=0;s<this._textureCache.length;s++)if(this._textureCache[s].texture.width===e.width&&this._textureCache[s].texture.height===e.height&&this._textureCache[s].postProcessChannel===i&&this._textureCache[s].texture._generateDepthBuffer===t.generateDepthBuffer&&this._textureCache[s].texture.samples===t.samples)return this._textureCache[s].texture;const r=this._engine.createRenderTargetTexture(e,t);return this._textureCache.push({texture:r,postProcessChannel:i,lastUsedRenderId:-1}),r}_flushTextureCache(){const e=this._renderId;for(let t=this._textureCache.length-1;t>=0;t--)if(e-this._textureCache[t].lastUsedRenderId>100){let i=!1;for(let r=0;r<this._textures.length;r++)if(this._textures.data[r]===this._textureCache[t].texture){i=!0;break}i||(this._textureCache[t].texture.dispose(),this._textureCache.splice(t,1))}}resize(e,t,i=null,r=!1,s=!1){this._textures.length>0&&this._textures.reset(),this.width=e,this.height=t;let n=null;if(i){for(let c=0;c<i._postProcesses.length;c++)if(i._postProcesses[c]!==null){n=i._postProcesses[c];break}}const o={width:this.width,height:this.height},l={generateMipMaps:r,generateDepthBuffer:s||n===this,generateStencilBuffer:(s||n===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples,label:"PostProcessRTT-"+this.name};this._textures.push(this._createRenderTargetTexture(o,l,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(o,l,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}_getTarget(){let e;if(this._shareOutputWithPostProcess)e=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)e=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{e=this.inputTexture;let t;for(let i=0;i<this._textureCache.length;i++)if(this._textureCache[i].texture===e){t=this._textureCache[i];break}t&&(t.lastUsedRenderId=this._renderId)}return e}activate(e,t=null,i){var _,p;const r=e===null||e.cameraRigMode!==void 0?e||this._camera:null,s=(r==null?void 0:r.getScene())??e,n=s.getEngine(),o=n.getCaps().maxTextureSize,l=(t?t.width:this._engine.getRenderWidth(!0))*this._options|0,c=(t?t.height:this._engine.getRenderHeight(!0))*this._options|0;let h=this._options.width||l,f=this._options.height||c;const u=this.renderTargetSamplingMode!==7&&this.renderTargetSamplingMode!==1&&this.renderTargetSamplingMode!==2;let d=null;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){const g=n.currentViewport;g&&(h*=g.width,f*=g.height)}(u||this.alwaysForcePOT)&&(this._options.width||(h=n.needPOTTextures?Ts(h,o,this.scaleMode):h),this._options.height||(f=n.needPOTTextures?Ts(f,o,this.scaleMode):f)),(this.width!==h||this.height!==f||!(d=this._getTarget()))&&this.resize(h,f,r,u,i),this._textures.forEach(g=>{g.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(g,this.samples)}),this._flushTextureCache(),this._renderId++}return d||(d=this._getTarget()),this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(l/h,c/f),this._engine.bindFramebuffer(d,0,l,c,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(d,0,void 0,void 0,this.forceFullscreenViewport)),(p=(_=this._engine)._debugInsertMarker)==null||p.call(_,`post process ${this.name} input`),this.onActivateObservable.notifyObservers(r),this.autoClear&&(this.alphaMode===0||this.forceAutoClearInAlphaMode)&&this._engine.clear(this.clearColor?this.clearColor:s.clearColor,s._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),d}get isSupported(){return this._effectWrapper.drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){return this._effectWrapper.isReady()}apply(){if(!this._effectWrapper.isReady())return null;this._engine.enableEffect(this._effectWrapper.drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a);let e;return this._shareOutputWithPostProcess?e=this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?e=this._forcedOutputTexture:e=this.inputTexture,this.externalTextureSamplerBinding||this._effectWrapper.drawWrapper.effect._bindTexture("textureSampler",e==null?void 0:e.texture),this._effectWrapper.drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._effectWrapper.drawWrapper.effect),this._effectWrapper.bind(),this._effectWrapper.drawWrapper.effect}_disposeTextures(){if(this._shareOutputWithPostProcess||this._forcedOutputTexture){this._disposeTextureCache();return}this._disposeTextureCache(),this._textures.dispose()}_disposeTextureCache(){for(let e=this._textureCache.length-1;e>=0;e--)this._textureCache[e].texture.dispose();this._textureCache.length=0}setPrePassRenderer(e){return this._prePassEffectConfiguration?(this._prePassEffectConfiguration=e.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0):!1}dispose(e){e=e||this._camera,this._useExistingThinPostProcess||this._effectWrapper.dispose(),this._disposeTextures();let t;if(this._scene&&(t=this._scene.postProcesses.indexOf(this),t!==-1&&this._scene.postProcesses.splice(t,1)),this._parentContainer){const i=this._parentContainer.postProcesses.indexOf(this);i>-1&&this._parentContainer.postProcesses.splice(i,1),this._parentContainer=null}if(t=this._engine.postProcesses.indexOf(this),t!==-1&&this._engine.postProcesses.splice(t,1),this.onDisposeObservable.notifyObservers(),!!e){if(e.detachPostProcess(this),t=e._postProcesses.indexOf(this),t===0&&e._postProcesses.length>0){const i=this._camera._getFirstPostProcess();i&&i.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear(),this.onEffectCreatedObservable.clear()}}serialize(){const e=ye.Serialize(this),t=this.getCamera()||this._scene&&this._scene.activeCamera;return e.customType="BABYLON."+this.getClassName(),e.cameraId=t?t.id:null,e.reusable=this._reusable,e.textureType=this._textureType,e.fragmentUrl=this._fragmentUrl,e.parameters=this._parameters,e.samplers=this._samplers,e.uniformBuffers=this._uniformBuffers,e.options=this._options,e.defines=this._postProcessDefines,e.textureFormat=this._textureFormat,e.vertexUrl=this._vertexUrl,e.indexParameters=this._indexParameters,e}clone(){const e=this.serialize();e._engine=this._engine,e.cameraId=null;const t=At.Parse(e,this._scene,"");return t?(t.onActivateObservable=this.onActivateObservable.clone(),t.onSizeChangedObservable=this.onSizeChangedObservable.clone(),t.onApplyObservable=this.onApplyObservable.clone(),t.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),t.onAfterRenderObservable=this.onAfterRenderObservable.clone(),t._prePassEffectConfiguration=this._prePassEffectConfiguration,t):null}static Parse(e,t,i){const r=Ui(e.customType);if(!r||!r._Parse)return null;const s=t?t.getCameraById(e.cameraId):null;return r._Parse(e,s,t,i)}static _Parse(e,t,i,r){return ye.Parse(()=>new At(e.name,e.fragmentUrl,e.parameters,e.samplers,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable,e.defines,e.textureType,e.vertexUrl,e.indexParameters,!1,e.textureFormat),e,i,r)}}A([y()],At.prototype,"uniqueId",void 0);A([y()],At.prototype,"name",null);A([y()],At.prototype,"width",void 0);A([y()],At.prototype,"height",void 0);A([y()],At.prototype,"renderTargetSamplingMode",void 0);A([Mm()],At.prototype,"clearColor",void 0);A([y()],At.prototype,"autoClear",void 0);A([y()],At.prototype,"forceAutoClearInAlphaMode",void 0);A([y()],At.prototype,"alphaMode",null);A([y()],At.prototype,"alphaConstants",void 0);A([y()],At.prototype,"enablePixelPerfectMode",void 0);A([y()],At.prototype,"forceFullscreenViewport",void 0);A([y()],At.prototype,"scaleMode",void 0);A([y()],At.prototype,"alwaysForcePOT",void 0);A([y("samples")],At.prototype,"_samples",void 0);A([y()],At.prototype,"adaptScaleToCurrentViewport",void 0);Y("BABYLON.PostProcess",At);class ir{get renderList(){return this._renderList}set renderList(e){this._renderList!==e&&(this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),e&&(this._unObserveRenderList=Am(e,this._renderListHasChanged)),this._renderList=e)}get renderInLinearSpace(){return this._renderInLinearSpace}set renderInLinearSpace(e){e!==this._renderInLinearSpace&&(this._renderInLinearSpace=e,this._scene.markAllMaterialsAsDirty(64))}get name(){return this._name}set name(e){if(this._name===e||(this._name=e,!this._scene))return;const t=this._scene.getEngine();for(let i=0;i<this._renderPassIds.length;++i){const r=this._renderPassIds[i];t._renderPassNames[r]=`${this._name}#${i}`}}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}setMaterialForRendering(e,t){let i;Array.isArray(e)?i=e:i=[e];for(let r=0;r<i.length;++r)for(let s=0;s<this.options.numPasses;++s)i[r].setMaterialForRenderPass(this._renderPassIds[s],t!==void 0?Array.isArray(t)?t[s]:t:void 0)}constructor(e,t,i){this._unObserveRenderList=null,this._renderListHasChanged=(r,s)=>{const n=this._renderList?this._renderList.length:0;(s===0&&n>0||n===0)&&this._scene.meshes.forEach(o=>{o._markSubMeshesAsLightDirty()})},this.particleSystemList=null,this.getCustomRenderList=null,this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this._renderInLinearSpace=!1,this.onBeforeRenderObservable=new U,this.onAfterRenderObservable=new U,this.onBeforeRenderingManagerRenderObservable=new U,this.onAfterRenderingManagerRenderObservable=new U,this.onFastPathRenderObservable=new U,this._currentRefreshId=-1,this._refreshRate=1,this._currentApplyByPostProcessSetting=!1,this._currentSceneCamera=null,this.name=e,this._scene=t,this.renderList=[],this._renderPassIds=[],this.options={numPasses:1,doNotChangeAspectRatio:!0,...i},this._createRenderPassId(),this.renderPassId=this._renderPassIds[0],this._renderingManager=new ii(t),this._renderingManager._useSceneAutoClearSetup=!0}_releaseRenderPassId(){const e=this._scene.getEngine();for(let t=0;t<this.options.numPasses;++t)e.releaseRenderPassId(this._renderPassIds[t]);this._renderPassIds.length=0}_createRenderPassId(){this._releaseRenderPassId();const e=this._scene.getEngine();for(let t=0;t<this.options.numPasses;++t)this._renderPassIds[t]=e.createRenderPassId(`${this.name}#${t}`)}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}shouldRender(){return this._currentRefreshId===-1?(this._currentRefreshId=1,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}isReadyForRendering(e,t){this.prepareRenderList(),this.initRender(e,t);const i=this._checkReadiness();return this.finishRender(),i}prepareRenderList(){const e=this._scene;if(this._waitingRenderList){if(!this.renderListPredicate){this.renderList=[];for(let t=0;t<this._waitingRenderList.length;t++){const i=this._waitingRenderList[t],r=e.getMeshById(i);r&&this.renderList.push(r)}}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];const t=this._scene.meshes;for(let i=0;i<t.length;i++){const r=t[i];this.renderListPredicate(r)&&this.renderList.push(r)}}this._currentApplyByPostProcessSetting=this._scene.imageProcessingConfiguration.applyByPostProcess,this._scene.imageProcessingConfiguration._applyByPostProcess=!!this._renderInLinearSpace}initRender(e,t){const i=this._scene.getEngine(),r=this.activeCamera??this._scene.activeCamera;this._currentSceneCamera=this._scene.activeCamera,r&&(r!==this._scene.activeCamera&&(this._scene.setTransformMatrix(r.getViewMatrix(),r.getProjectionMatrix(!0)),this._scene.activeCamera=r),i.setViewport(r.rigParent?r.rigParent.viewport:r.viewport,e,t)),this._defaultRenderListPrepared=!1}finishRender(){const e=this._scene;e.imageProcessingConfiguration._applyByPostProcess=this._currentApplyByPostProcessSetting,e.activeCamera=this._currentSceneCamera,this._currentSceneCamera&&(this.activeCamera&&this.activeCamera!==e.activeCamera&&e.setTransformMatrix(this._currentSceneCamera.getViewMatrix(),this._currentSceneCamera.getProjectionMatrix(!0)),e.getEngine().setViewport(this._currentSceneCamera.viewport)),e.resetCachedMaterial()}render(e=0,t=!1){const i=this._scene,r=i.getEngine(),s=r.currentRenderPassId;if(r.currentRenderPassId=this._renderPassIds[e],this.onBeforeRenderObservable.notifyObservers(e),r.snapshotRendering&&r.snapshotRenderingMode===1)this.onFastPathRenderObservable.notifyObservers(e);else{let o=null;const l=this.renderList?this.renderList:i.getActiveMeshes().data,c=this.renderList?this.renderList.length:i.getActiveMeshes().length;this.getCustomRenderList&&(o=this.getCustomRenderList(e,l,c)),o?this._prepareRenderingManager(o,o.length,this.forceLayerMaskCheck):(this._defaultRenderListPrepared||(this._prepareRenderingManager(l,c,!this.renderList||this.forceLayerMaskCheck),this._defaultRenderListPrepared=!0),o=l),this.onBeforeRenderingManagerRenderObservable.notifyObservers(e),this._renderingManager.render(this.customRenderFunction,o,this.renderParticles,this.renderSprites),this.onAfterRenderingManagerRenderObservable.notifyObservers(e)}t||this.onAfterRenderObservable.notifyObservers(e),r.currentRenderPassId=s}_checkReadiness(){const e=this._scene,t=e.getEngine(),i=t.currentRenderPassId;let r=!0;e.getViewMatrix()||e.updateTransformMatrix();const s=this.options.numPasses;for(let o=0;o<s&&r;o++){let l=null;const c=this.renderList?this.renderList:e.getActiveMeshes().data,h=this.renderList?this.renderList.length:e.getActiveMeshes().length;t.currentRenderPassId=this._renderPassIds[o],this.onBeforeRenderObservable.notifyObservers(o),this.getCustomRenderList&&(l=this.getCustomRenderList(o,c,h)),l||(l=c),this.options.doNotChangeAspectRatio||e.updateTransformMatrix(!0);for(let f=0;f<l.length&&r;++f){const u=l[f];if(!(!u.isEnabled()||u.isBlocked||!u.isVisible||!u.subMeshes)){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(u,this.refreshRate,!0)){r=!1;continue}}else if(!u.isReady(!0)){r=!1;continue}}}this.onAfterRenderObservable.notifyObservers(o),s>1&&(e.incrementRenderId(),e.resetCachedMaterial())}const n=this.particleSystemList||e.particleSystems;for(const o of n)o.isReady()||(r=!1);return t.currentRenderPassId=i,r}_prepareRenderingManager(e,t,i){const r=this._scene,s=r.activeCamera,n=this.cameraForLOD??s;this._renderingManager.reset();const o=r.getRenderId(),l=r.getFrameId();for(let h=0;h<t;h++){const f=e[h];if(f&&!f.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(f,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!f.isReady(this.refreshRate===0)){this.resetRefreshCounter();continue}let u=null;if(n){const _=f._internalAbstractMeshDataInfo._currentLOD.get(n);!_||_[1]!==l?(u=r.customLODSelector?r.customLODSelector(f,n):f.getLOD(n),_?(_[0]=u,_[1]=l):f._internalAbstractMeshDataInfo._currentLOD.set(n,[u,l])):u=_[0]}else u=f;if(!u)continue;u!==f&&u.billboardMode!==0&&u.computeWorldMatrix(),u._preActivateForIntermediateRendering(o);let d;if(i&&s?d=(f.layerMask&s.layerMask)===0:d=!1,f.isEnabled()&&f.isVisible&&f.subMeshes&&!d){if(u!==f&&u._activate(o,!0),f._activate(o,!0)&&f.subMeshes.length){f.isAnInstance?f._internalAbstractMeshDataInfo._actAsRegularMesh&&(u=f):u._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,u._internalAbstractMeshDataInfo._isActiveIntermediate=!0,r._prepareSkeleton(u);for(let _=0;_<u.subMeshes.length;_++){const p=u.subMeshes[_];this._renderingManager.dispatch(p,u)}}f._postActivate()}}}const c=this.particleSystemList||r.particleSystems;for(let h=0;h<c.length;h++){const f=c[h],u=f.emitter;!f.isStarted()||!u||u.position&&!u.isEnabled()||this._renderingManager.dispatchParticles(f)}}setRenderingOrder(e,t=null,i=null,r=null){this._renderingManager.setRenderingOrder(e,t,i,r)}setRenderingAutoClearDepthStencil(e,t,i=!0,r=!0){this._renderingManager.setRenderingAutoClearDepthStencil(e,t,i,r),this._renderingManager._useSceneAutoClearSetup=!1}clone(){const e=new ir(this.name,this._scene,this.options);return this.renderList&&(e.renderList=this.renderList.slice(0)),e}dispose(){const e=this.renderList?this.renderList:this._scene.getActiveMeshes().data,t=this.renderList?this.renderList.length:this._scene.getActiveMeshes().length;for(let i=0;i<t;i++){const r=e[i];r.getMaterialForRenderPass(this.renderPassId)!==void 0&&r.setMaterialForRenderPass(this.renderPassId,void 0)}this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderingManagerRenderObservable.clear(),this.onAfterRenderingManagerRenderObservable.clear(),this.onFastPathRenderObservable.clear(),this._releaseRenderPassId(),this.renderList=null}_rebuild(){this.refreshRate===ir.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=ir.REFRESHRATE_RENDER_ONCE)}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}}ir.REFRESHRATE_RENDER_ONCE=0;ir.REFRESHRATE_RENDER_ONEVERYFRAME=1;ir.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2;lt.prototype.setDepthStencilTexture=function(a,e){this._engine.setDepthStencilTexture(this._samplers[a],this._uniforms[a],e,a)};class rr extends Z{get renderListPredicate(){return this._objectRenderer.renderListPredicate}set renderListPredicate(e){this._objectRenderer.renderListPredicate=e}get renderList(){return this._objectRenderer.renderList}set renderList(e){this._objectRenderer.renderList=e}get particleSystemList(){return this._objectRenderer.particleSystemList}set particleSystemList(e){this._objectRenderer.particleSystemList=e}get getCustomRenderList(){return this._objectRenderer.getCustomRenderList}set getCustomRenderList(e){this._objectRenderer.getCustomRenderList=e}get renderParticles(){return this._objectRenderer.renderParticles}set renderParticles(e){this._objectRenderer.renderParticles=e}get renderSprites(){return this._objectRenderer.renderSprites}set renderSprites(e){this._objectRenderer.renderSprites=e}get forceLayerMaskCheck(){return this._objectRenderer.forceLayerMaskCheck}set forceLayerMaskCheck(e){this._objectRenderer.forceLayerMaskCheck=e}get activeCamera(){return this._objectRenderer.activeCamera}set activeCamera(e){this._objectRenderer.activeCamera=e}get cameraForLOD(){return this._objectRenderer.cameraForLOD}set cameraForLOD(e){this._objectRenderer.cameraForLOD=e}get renderInLinearSpace(){return this._objectRenderer.renderInLinearSpace}set renderInLinearSpace(e){this._objectRenderer.renderInLinearSpace=e}get customIsReadyFunction(){return this._objectRenderer.customIsReadyFunction}set customIsReadyFunction(e){this._objectRenderer.customIsReadyFunction=e}get customRenderFunction(){return this._objectRenderer.customRenderFunction}set customRenderFunction(e){this._objectRenderer.customRenderFunction=e}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(e){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(e)}get onBeforeRenderObservable(){return this._objectRenderer.onBeforeRenderObservable}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}get onAfterRenderObservable(){return this._objectRenderer.onAfterRenderObservable}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}set onClear(e){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(e)}get _waitingRenderList(){return this._objectRenderer._waitingRenderList}set _waitingRenderList(e){this._objectRenderer._waitingRenderList=e}get renderPassId(){return this._objectRenderer.renderPassId}get renderPassIds(){return this._objectRenderer.renderPassIds}get currentRefreshId(){return this._objectRenderer.currentRefreshId}setMaterialForRendering(e,t){this._objectRenderer.setMaterialForRendering(e,t)}get isMulti(){var e;return((e=this._renderTarget)==null?void 0:e.isMulti)??!1}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){var e;return((e=this._renderTarget)==null?void 0:e._depthStencilTexture)??null}constructor(e,t,i,r=!1,s=!0,n=0,o=!1,l=Z.TRILINEAR_SAMPLINGMODE,c=!0,h=!1,f=!1,u=5,d=!1,_,p,g=!1,E=!1){let v,b=!0,R;if(typeof r=="object"){const T=r;r=!!T.generateMipMaps,s=T.doNotChangeAspectRatio??!0,n=T.type??0,o=!!T.isCube,l=T.samplingMode??Z.TRILINEAR_SAMPLINGMODE,c=T.generateDepthBuffer??!0,h=!!T.generateStencilBuffer,f=!!T.isMulti,u=T.format??5,d=!!T.delayAllocation,_=T.samples,p=T.creationFlags,g=!!T.noColorAttachment,E=!!T.useSRGBBuffer,v=T.colorAttachment,b=T.gammaSpace??b,R=T.existingObjectRenderer}if(super(null,i,!r,void 0,l,void 0,void 0,void 0,void 0,u),this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new U,this.onAfterUnbindObservable=new U,this.onClearObservable=new U,this.onResizeObservable=new U,this._cleared=!1,this.skipInitialClear=!1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this._dontDisposeObjectRenderer=!1,this.boundingBoxPosition=m.Zero(),this._disableEngineStages=!1,this._dumpToolsLoading=!1,i=this.getScene(),!i)return;const S=this.getScene().getEngine();this._gammaSpace=b,this._coordinatesMode=Z.PROJECTION_MODE,this.name=e,this.isRenderTarget=!0,this._initialSizeParameter=t,this._dontDisposeObjectRenderer=!!R,this._processSizeParameter(t),this._objectRenderer=R??new ir(e,i,{numPasses:o?6:this.getRenderLayers()||1,doNotChangeAspectRatio:s}),this._onBeforeRenderingManagerRenderObserver=this._objectRenderer.onBeforeRenderingManagerRenderObservable.add(()=>{if(!this._disableEngineStages)for(const T of this._scene._beforeRenderTargetClearStage)T.action(this,this._currentFaceIndex,this._currentLayer);if(this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(S):this.skipInitialClear||S.clear(this.clearColor||this._scene.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),!this._disableEngineStages)for(const T of this._scene._beforeRenderTargetDrawStage)T.action(this,this._currentFaceIndex,this._currentLayer)}),this._onAfterRenderingManagerRenderObserver=this._objectRenderer.onAfterRenderingManagerRenderObservable.add(()=>{var I;if(!this._disableEngineStages)for(const O of this._scene._afterRenderTargetDrawStage)O.action(this,this._currentFaceIndex,this._currentLayer);const T=((I=this._texture)==null?void 0:I.generateMipMaps)??!1;if(this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex,this._postProcesses,this.ignoreCameraViewport):this._currentUseCameraPostProcess&&this._scene.postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex),!this._disableEngineStages)for(const O of this._scene._afterRenderTargetPostProcessStage)O.action(this,this._currentFaceIndex,this._currentLayer);this._texture&&(this._texture.generateMipMaps=T),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),this._currentDumpForDebug&&(this._dumpTools?this._dumpTools.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),S):B.Error("dumpTools module is still being loaded. To speed up the process import dump tools directly in your project"))}),this._onFastPathRenderObserver=this._objectRenderer.onFastPathRenderObservable.add(()=>{this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(S):this.skipInitialClear||S.clear(this.clearColor||this._scene.clearColor,!0,!0,!0)}),this._resizeObserver=S.onResizeObservable.add(()=>{}),this._generateMipMaps=!!r,this._doNotChangeAspectRatio=s,!f&&(this._renderTargetOptions={generateMipMaps:r,type:n,format:this._format??void 0,samplingMode:this.samplingMode,generateDepthBuffer:c,generateStencilBuffer:h,samples:_,creationFlags:p,noColorAttachment:g,useSRGBBuffer:E,colorAttachment:v,label:this.name},this.samplingMode===Z.NEAREST_SAMPLINGMODE&&(this.wrapU=Z.CLAMP_ADDRESSMODE,this.wrapV=Z.CLAMP_ADDRESSMODE),d||(o?(this._renderTarget=i.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=Z.INVCUBIC_MODE,this._textureMatrix=P.Identity()):this._renderTarget=i.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,_!==void 0&&(this.samples=_)))}createDepthStencilTexture(e=0,t=!0,i=!1,r=1,s=14,n){var o;(o=this._renderTarget)==null||o.createDepthStencilTexture(e,t,i,r,s,n)}_processSizeParameter(e){if(e.ratio){this._sizeRatio=e.ratio;const t=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(t.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(t.getRenderHeight(),this._sizeRatio)}}else this._size=e}get samples(){var e;return((e=this._renderTarget)==null?void 0:e.samples)??this._samples}set samples(e){this._renderTarget&&(this._samples=this._renderTarget.setSamples(e))}addPostProcess(e){if(!this._postProcessManager){const t=this.getScene();if(!t)return;this._postProcessManager=new al(t),this._postProcesses=new Array}this._postProcesses.push(e),this._postProcesses[0].autoClear=!1}clearPostProcesses(e=!1){if(this._postProcesses){if(e)for(const t of this._postProcesses)t.dispose();this._postProcesses=[]}}removePostProcess(e){if(!this._postProcesses)return;const t=this._postProcesses.indexOf(e);t!==-1&&(this._postProcesses.splice(t,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=!1))}resetRefreshCounter(){this._objectRenderer.resetRefreshCounter()}get refreshRate(){return this._objectRenderer.refreshRate}set refreshRate(e){this._objectRenderer.refreshRate=e}_shouldRender(){return this._objectRenderer.shouldRender()}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){const e=this._size.layers;if(e)return e;const t=this._size.depth;return t||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(e){const t=Math.max(1,this.getRenderSize()*e);this.resize(t)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(e){var r;const t=this.isCube;(r=this._renderTarget)==null||r.dispose(),this._renderTarget=null;const i=this.getScene();i&&(this._processSizeParameter(e),t?this._renderTarget=i.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):this._renderTarget=i.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,this._renderTargetOptions.samples!==void 0&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(e=!1,t=!1){this._render(e,t)}isReadyForRendering(){this._dumpToolsLoading||(this._dumpToolsLoading=!0,X(()=>Promise.resolve().then(()=>EI),void 0,import.meta.url).then(t=>this._dumpTools=t)),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight());const e=this._objectRenderer._checkReadiness();return this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender(),e}_render(e=!1,t=!1){const i=this.getScene();if(i){if(this.useCameraPostProcesses!==void 0&&(e=this.useCameraPostProcesses),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight()),(this.is2DArray||this.is3D)&&!this.isMulti)for(let r=0;r<this.getRenderLayers();r++)this._renderToTarget(0,e,t,r),i.incrementRenderId(),i.resetCachedMaterial();else if(this.isCube&&!this.isMulti)for(let r=0;r<6;r++)this._renderToTarget(r,e,t),i.incrementRenderId(),i.resetCachedMaterial();else this._renderToTarget(0,e,t);this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender()}}_bestReflectionRenderTargetDimension(e,t){const r=e*t,s=Tm(r+128*128/(128+r));return Math.min(gc(e),s)}_bindFrameBuffer(e=0,t=0){const i=this.getScene();if(!i)return;const r=i.getEngine();this._renderTarget&&r.bindFramebuffer(this._renderTarget,this.isCube?e:void 0,void 0,void 0,this.ignoreCameraViewport,0,t)}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindFramebuffer(this._renderTarget,this.isCube,()=>{this.onAfterRenderObservable.notifyObservers(t)})}_prepareFrame(e,t,i,r){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses):(!r||!e.postProcessManager._prepareFrame(this._texture))&&this._bindFrameBuffer(t,i)}_renderToTarget(e,t,i,r=0){var o,l;const s=this.getScene();if(!s)return;const n=s.getEngine();this._currentFaceIndex=e,this._currentLayer=r,this._currentUseCameraPostProcess=t,this._currentDumpForDebug=i,this._prepareFrame(s,e,r,t),(o=n._debugPushGroup)==null||o.call(n,`render to face #${e} layer #${r}`,2),this._objectRenderer.render(e+r,!0),(l=n._debugPopGroup)==null||l.call(n,2),this._unbindFrameBuffer(n,e),this._texture&&this.isCube&&e===5&&n.generateMipMapsForCubemap(this._texture,!0)}setRenderingOrder(e,t=null,i=null,r=null){this._objectRenderer.setRenderingOrder(e,t,i,r)}setRenderingAutoClearDepthStencil(e,t){this._objectRenderer.setRenderingAutoClearDepthStencil(e,t)}clone(){const e=this.getSize(),t=new rr(this.name,e,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,this.renderList&&(t.renderList=this.renderList.slice(0)),t}serialize(){if(!this.name)return null;const e=super.serialize();if(e.renderTargetSize=this.getRenderSize(),e.renderList=[],this.renderList)for(let t=0;t<this.renderList.length;t++)e.renderList.push(this.renderList[t].id);return e}disposeFramebufferObjects(){var e;(e=this._renderTarget)==null||e.dispose(!0)}releaseInternalTexture(){var e;(e=this._renderTarget)==null||e.releaseTextures(),this._texture=null}dispose(){var i;this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._objectRenderer.onBeforeRenderingManagerRenderObservable.remove(this._onBeforeRenderingManagerRenderObserver),this._objectRenderer.onAfterRenderingManagerRenderObservable.remove(this._onAfterRenderingManagerRenderObserver),this._objectRenderer.onFastPathRenderObservable.remove(this._onFastPathRenderObserver),this._dontDisposeObjectRenderer||this._objectRenderer.dispose(),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null);const e=this.getScene();if(!e)return;let t=e.customRenderTargets.indexOf(this);t>=0&&e.customRenderTargets.splice(t,1);for(const r of e.cameras)t=r.customRenderTargets.indexOf(this),t>=0&&r.customRenderTargets.splice(t,1);(i=this._renderTarget)==null||i.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this._objectRenderer._rebuild(),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._objectRenderer.freeRenderingGroups()}getViewCount(){return 1}}rr.REFRESHRATE_RENDER_ONCE=ir.REFRESHRATE_RENDER_ONCE;rr.REFRESHRATE_RENDER_ONEVERYFRAME=ir.REFRESHRATE_RENDER_ONEVERYFRAME;rr.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=ir.REFRESHRATE_RENDER_ONEVERYTWOFRAMES;Z._CreateRenderTargetTexture=(a,e,t,i,r)=>new rr(a,e,t,i);function xR(a){return a.getPipelineContext===void 0}class yR{constructor(){this.shaderLanguage=0}postProcessor(e,t,i,r,s){if(s.drawBuffersExtensionDisabled){const n=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;e=e.replace(n,"")}return e}}const MR=/(flat\s)?\s*varying\s*.*/;class PR{constructor(){this.shaderLanguage=0}attributeProcessor(e){return e.replace("attribute","in")}varyingCheck(e,t){return MR.test(e)}varyingProcessor(e,t){return e.replace("varying",t?"in":"out")}postProcessor(e,t,i){const r=e.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,s=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(e=e.replace(s,""),e=e.replace(/texture2D\s*\(/g,"texture("),i){const n=e.search(/layout *\(location *= *0\) *out/g)!==-1;e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCube\s*\(/g,"texture("),e=e.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),e=e.replace(/gl_FragColor/g,"glFragColor"),e=e.replace(/gl_FragData/g,"glFragData"),e=e.replace(/void\s+?main\s*\(/g,(r||n?"":`layout(location = 0) out vec4 glFragColor;
`)+"void main(")}else if(t.indexOf("#define MULTIVIEW")!==-1)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+e;return e}}class In extends wn{constructor(e){super(),this._buffer=e}get underlyingResource(){return this._buffer}}class wc{get underlyingResource(){return this._webGLTexture}constructor(e=null,t){if(this._MSAARenderBuffers=null,this._context=t,!e&&(e=t.createTexture(),!e))throw new Error("Unable to create webGL texture");this.set(e)}setUsage(){}set(e){this._webGLTexture=e}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null}addMSAARenderBuffer(e){this._MSAARenderBuffers||(this._MSAARenderBuffers=[]),this._MSAARenderBuffers.push(e)}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(const e of this._MSAARenderBuffers)this._context.deleteRenderbuffer(e);this._MSAARenderBuffers=null}}getMSAARenderBuffer(e=0){var t;return((t=this._MSAARenderBuffers)==null?void 0:t[e])??null}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}function Kh(a){return a===13||a===14||a===15||a===16||a===17||a===18||a===19}function bn(a){return a===13||a===17||a===18||a===19}class OR{}class We extends H{get name(){return this._name}set name(e){this._name=e}get version(){return this._webGLVersion}static get ShadersRepository(){return lt.ShadersRepository}static set ShadersRepository(e){lt.ShadersRepository=e}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e}snapshotRenderingReset(){this.snapshotRendering=!1}constructor(e,t,i,r){if(i=i||{},super(t??i.antialias,i,r),this._name="WebGL",this.forcePOTTextures=!1,this.validateShaderPrograms=!1,this.disableUniformBuffers=!1,this._webGLVersion=1,this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},!e)return;let s=null;if(e.getContext){if(s=e,i.preserveDrawingBuffer===void 0&&(i.preserveDrawingBuffer=!1),i.xrCompatible===void 0&&(i.xrCompatible=!1),navigator&&navigator.userAgent){this._setupMobileChecks();const l=navigator.userAgent;for(const c of We.ExceptionList){const h=c.key,f=c.targets;if(new RegExp(h).test(l)){if(c.capture&&c.captureConstraint){const d=c.capture,_=c.captureConstraint,g=new RegExp(d).exec(l);if(g&&g.length>0&&parseInt(g[g.length-1])>=_)continue}for(const d of f)switch(d){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":i.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1;break}}}}if(this._doNotHandleContextLost?this._onContextLost=()=>{No(this._gl)}:(this._onContextLost=l=>{l.preventDefault(),this._contextWasLost=!0,No(this._gl),B.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost(()=>this._initGLContext())},s.addEventListener("webglcontextrestored",this._onContextRestored,!1),i.powerPreference=i.powerPreference||"high-performance"),s.addEventListener("webglcontextlost",this._onContextLost,!1),this._badDesktopOS&&(i.xrCompatible=!1),!i.disableWebGL2Support)try{this._gl=s.getContext("webgl2",i)||s.getContext("experimental-webgl2",i),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch{}if(!this._gl){if(!s)throw new Error("The provided canvas is null or undefined.");try{this._gl=s.getContext("webgl",i)||s.getContext("experimental-webgl",i)}catch{throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=e,s=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";const l=this._gl.getContextAttributes();l&&(i.stencil=l.stencil)}this._sharedInit(s),this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),i.useHighPrecisionFloats!==void 0&&(this._highPrecisionShadersAllowed=i.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let l=0;l<this._caps.maxVertexAttribs;l++)this._currentBufferPointers[l]=new OR;this._shaderProcessor=this.webGLVersion>1?new PR:new yR;const n=`Babylon.js v${We.Version}`;B.Log(n+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",n);const o=xi(this._gl);o.validateShaderPrograms=this.validateShaderPrograms,o.parallelShaderCompile=this._caps.parallelShaderCompile}_clearEmptyResources(){this._dummyFramebuffer=null,super._clearEmptyResources()}_getShaderProcessingContext(e){return null}areAllEffectsReady(){for(const e in this._compiledEffects)if(!this._compiledEffects[e].isReady())return!1;return!0}_initGLContext(){this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||this._gl.getExtension("OES_standard_derivatives")!==null,maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||this._gl.getExtension("OES_element_index_uint")!==null,fragmentDepthSupported:this._webGLVersion>1||this._gl.getExtension("EXT_frag_depth")!==null,highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,colorBufferHalfFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_half_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),texelFetch:this._webGLVersion!==1,blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1,textureNorm16:!!this._gl.getExtension("EXT_texture_norm16")},this._caps.supportFloatTexturesResolve=this._caps.colorBufferFloat,this._caps.rg11b10ufColorRenderable=this._caps.colorBufferFloat,this._glVersion=this._gl.getParameter(this._gl.VERSION);const e=this._gl.getExtension("WEBGL_debug_renderer_info");if(e!=null&&(this._glRenderer=this._gl.getParameter(e.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(e.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),this._gl.HALF_FLOAT_OES!==36193&&(this._gl.HALF_FLOAT_OES=36193),this._gl.RGBA16F!==34842&&(this._gl.RGBA16F=34842),this._gl.RGBA32F!==34836&&(this._gl.RGBA32F=34836),this._gl.DEPTH24_STENCIL8!==35056&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(this._webGLVersion===1&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=(this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)??0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!!(this._caps.textureFloat&&this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!!(this._caps.textureFloat&&this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.textureNorm16&&(this._gl.R16_EXT=33322,this._gl.RG16_EXT=33324,this._gl.RGB16_EXT=32852,this._gl.RGBA16_EXT=32859,this._gl.R16_SNORM_EXT=36760,this._gl.RG16_SNORM_EXT=36761,this._gl.RGB16_SNORM_EXT=36762,this._gl.RGBA16_SNORM_EXT=36763),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&this._gl.HALF_FLOAT_OES!==5131&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=this._maxMSAASamplesOverride!==null?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES),this._caps.maxDrawBuffers=this._gl.getParameter(this._gl.MAX_DRAW_BUFFERS);else{const t=this._gl.getExtension("WEBGL_draw_buffers");if(t!==null){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=t.drawBuffersWEBGL.bind(t),this._caps.maxDrawBuffers=this._gl.getParameter(t.MAX_DRAW_BUFFERS_WEBGL),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let i=0;i<16;i++)this._gl["COLOR_ATTACHMENT"+i+"_WEBGL"]=t["COLOR_ATTACHMENT"+i+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{const t=this._gl.getExtension("WEBGL_depth_texture");t!=null&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=t.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{const t=this._gl.getExtension("OES_vertex_array_object");t!=null&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=t.createVertexArrayOES.bind(t),this._gl.bindVertexArray=t.bindVertexArrayOES.bind(t),this._gl.deleteVertexArray=t.deleteVertexArrayOES.bind(t))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{const t=this._gl.getExtension("ANGLE_instanced_arrays");t!=null?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=t.drawArraysInstancedANGLE.bind(t),this._gl.drawElementsInstanced=t.drawElementsInstancedANGLE.bind(t),this._gl.vertexAttribDivisor=t.vertexAttribDivisorANGLE.bind(t)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){const t=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),i=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);t&&i&&(this._caps.highPrecisionShaderSupported=t.precision!==0&&i.precision!==0)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{const t=this._gl.getExtension("EXT_blend_minmax");t!=null&&(this._caps.blendMinMax=!0,this._gl.MAX=t.MAX_EXT,this._gl.MIN=t.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:WebGL2RenderingContext.SRGB,SRGB8:WebGL2RenderingContext.SRGB8,SRGB8_ALPHA8:WebGL2RenderingContext.SRGB8_ALPHA8};else{const t=this._gl.getExtension("EXT_sRGB");t!=null&&(this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:t.SRGB_EXT,SRGB8:t.SRGB_ALPHA_EXT,SRGB8_ALPHA8:t.SRGB_ALPHA_EXT})}if(this._creationOptions){const t=this._creationOptions.forceSRGBBufferSupportState;t!==void 0&&(this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&t)}}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let t=0;t<this._maxSimultaneousTextures;t++)this._nextFreeTextureSlots.push(t);this._glRenderer==="Mali-G72"&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:typeof HTMLImageElement>"u",supportRenderAndCopyToLodForFloatTextures:this._webGLVersion!==1,supportDepthStencilTexture:this._webGLVersion!==1,supportShadowSamplers:this._webGLVersion!==1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:this._webGLVersion!==1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:this._webGLVersion!==1,basisNeedsPOT:this._webGLVersion===1,support3DTextures:this._webGLVersion!==1,needTypeSuffixInShaderConstants:this._webGLVersion!==1,supportMSAA:this._webGLVersion!==1,supportSSAO2:this._webGLVersion!==1,supportIBLShadows:this._webGLVersion!==1,supportExtendedTextureFormats:this._webGLVersion!==1,supportSwitchCaseInShader:this._webGLVersion!==1,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,forceVertexBufferStrideAndOffsetMultiple4Bytes:!1,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!1,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);const e=this._workingCanvas.getContext("2d");e&&(this._workingContext=e)}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}extractDriverInfo(){const e=this.getGlInfo();return e&&e.renderer?e.renderer:""}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}clear(e,t,i,r=!1){var o,l;const s=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=s;let n=0;if(t&&e){let c=!0;if(this._currentRenderTarget){const h=(o=this._currentRenderTarget.texture)==null?void 0:o.format;if(h===8||h===9||h===10||h===11){const f=(l=this._currentRenderTarget.texture)==null?void 0:l.type;f===7||f===5?(We._TempClearColorUint32[0]=e.r*255,We._TempClearColorUint32[1]=e.g*255,We._TempClearColorUint32[2]=e.b*255,We._TempClearColorUint32[3]=e.a*255,this._gl.clearBufferuiv(this._gl.COLOR,0,We._TempClearColorUint32),c=!1):(We._TempClearColorInt32[0]=e.r*255,We._TempClearColorInt32[1]=e.g*255,We._TempClearColorInt32[2]=e.b*255,We._TempClearColorInt32[3]=e.a*255,this._gl.clearBufferiv(this._gl.COLOR,0,We._TempClearColorInt32),c=!1)}}c&&(this._gl.clearColor(e.r,e.g,e.b,e.a!==void 0?e.a:1),n|=this._gl.COLOR_BUFFER_BIT)}i&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),n|=this._gl.DEPTH_BUFFER_BIT),r&&(this._gl.clearStencil(0),n|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(n)}_viewport(e,t,i,r){(e!==this._viewportCached.x||t!==this._viewportCached.y||i!==this._viewportCached.z||r!==this._viewportCached.w)&&(this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=i,this._viewportCached.w=r,this._gl.viewport(e,t,i,r))}endFrame(){super.endFrame(),this._badOS&&this.flushFramebuffer()}get performanceMonitor(){throw new Error("Not Supported by ThinEngine")}bindFramebuffer(e,t=0,i,r,s,n=0,o=0){var f,u,d,_,p,g;const l=e;this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._bindUnboundFramebuffer(l._framebuffer);const c=this._gl;e.isMulti||(e.is2DArray||e.is3D?(c.framebufferTextureLayer(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,(f=e.texture._hardwareTexture)==null?void 0:f.underlyingResource,n,o),l._currentLOD=n):e.isCube?c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_CUBE_MAP_POSITIVE_X+t,(u=e.texture._hardwareTexture)==null?void 0:u.underlyingResource,n):l._currentLOD!==n&&(c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,(d=e.texture._hardwareTexture)==null?void 0:d.underlyingResource,n),l._currentLOD=n));const h=e._depthStencilTexture;if(h){e.is3D&&(e.texture.width!==h.width||e.texture.height!==h.height||e.texture.depth!==h.depth)&&B.Warn("Depth/Stencil attachment for 3D target must have same dimensions as color attachment");const E=e._depthStencilTextureWithStencil?c.DEPTH_STENCIL_ATTACHMENT:c.DEPTH_ATTACHMENT;e.is2DArray||e.is3D?c.framebufferTextureLayer(c.FRAMEBUFFER,E,(_=h._hardwareTexture)==null?void 0:_.underlyingResource,n,o):e.isCube?c.framebufferTexture2D(c.FRAMEBUFFER,E,c.TEXTURE_CUBE_MAP_POSITIVE_X+t,(p=h._hardwareTexture)==null?void 0:p.underlyingResource,n):c.framebufferTexture2D(c.FRAMEBUFFER,E,c.TEXTURE_2D,(g=h._hardwareTexture)==null?void 0:g.underlyingResource,n)}l._MSAAFramebuffer&&this._bindUnboundFramebuffer(l._MSAAFramebuffer),this._cachedViewport&&!s?this.setViewport(this._cachedViewport,i,r):(i||(i=e.width,n&&(i=i/Math.pow(2,n))),r||(r=e.height,n&&(r=r/Math.pow(2,n))),this._viewport(0,0,i,r)),this.wipeCaches()}setStateCullFaceType(e,t){const i=this.cullBackFaces??e??!0?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==i||t)&&(this._depthCullingState.cullFace=i)}setState(e,t=0,i,r=!1,s,n,o=0){(this._depthCullingState.cull!==e||i)&&(this._depthCullingState.cull=e),this.setStateCullFaceType(s,i),this.setZOffset(t),this.setZOffsetUnits(o);const l=r?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==l||i)&&(this._depthCullingState.frontFace=l),this._stencilStateComposer.stencilMaterial=n}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e),this._currentFramebuffer=e)}_currentFrameBufferIsDefaultFrameBuffer(){return this._currentFramebuffer===null}generateMipmaps(e){const t=this._getTextureTarget(e);this._bindTextureDirectly(t,e,!0),this._gl.generateMipmap(t),this._bindTextureDirectly(t,null)}unBindFramebuffer(e,t=!1,i){const r=e;this._currentRenderTarget=null,r.disableAutomaticMSAAResolve||(e.isMulti?this.resolveMultiFramebuffer(e):this.resolveFramebuffer(e)),t||(e.isMulti?this.generateMipMapsMultiFramebuffer(e):this.generateMipMapsFramebuffer(e)),i&&(r._MSAAFramebuffer&&this._bindUnboundFramebuffer(r._framebuffer),i()),this._bindUnboundFramebuffer(null)}generateMipMapsFramebuffer(e){var t;!e.isMulti&&((t=e.texture)!=null&&t.generateMipMaps)&&!e.isCube&&this.generateMipmaps(e.texture)}resolveFramebuffer(e){const t=e,i=this._gl;if(!t._MSAAFramebuffer||t.isMulti)return;let r=t.resolveMSAAColors?i.COLOR_BUFFER_BIT:0;r|=t._generateDepthBuffer&&t.resolveMSAADepth?i.DEPTH_BUFFER_BIT:0,r|=t._generateStencilBuffer&&t.resolveMSAAStencil?i.STENCIL_BUFFER_BIT:0,i.bindFramebuffer(i.READ_FRAMEBUFFER,t._MSAAFramebuffer),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,t._framebuffer),i.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,r,i.NEAREST)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(e,t,i){return this._createVertexBuffer(e,this._gl.STATIC_DRAW)}_createVertexBuffer(e,t){const i=this._gl.createBuffer();if(!i)throw new Error("Unable to create vertex buffer");const r=new In(i);return this.bindArrayBuffer(r),typeof e!="number"?e instanceof Array?(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),t),r.capacity=e.length*4):(this._gl.bufferData(this._gl.ARRAY_BUFFER,e,t),r.capacity=e.byteLength):(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Uint8Array(e),t),r.capacity=e),this._resetVertexBufferBinding(),r.references=1,r}createDynamicVertexBuffer(e,t){return this._createVertexBuffer(e,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(e,t,i){const r=this._gl.createBuffer(),s=new In(r);if(!r)throw new Error("Unable to create index buffer");this.bindIndexBuffer(s);const n=this._normalizeIndexData(e);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,n,t?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),s.references=1,s.is32Bits=n.BYTES_PER_ELEMENT===4,s}_normalizeIndexData(e){if(e.BYTES_PER_ELEMENT===2)return e;if(this._caps.uintIndices){if(e instanceof Uint32Array)return e;for(let i=0;i<e.length;i++)if(e[i]>=65535)return new Uint32Array(e);return new Uint16Array(e)}return new Uint16Array(e)}bindArrayBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ARRAY_BUFFER)}bindUniformBlock(e,t,i){const r=e.program,s=this._gl.getUniformBlockIndex(r,t);this._gl.uniformBlockBinding(r,s,i)}bindIndexBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(e,t){(this._vaoRecordInProgress||this._currentBoundBuffer[t]!==e)&&(this._gl.bindBuffer(t,e?e.underlyingResource:null),this._currentBoundBuffer[t]=e)}updateArrayBuffer(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)}_vertexAttribPointer(e,t,i,r,s,n,o){const l=this._currentBufferPointers[t];if(!l)return;let c=!1;l.active?(l.buffer!==e&&(l.buffer=e,c=!0),l.size!==i&&(l.size=i,c=!0),l.type!==r&&(l.type=r,c=!0),l.normalized!==s&&(l.normalized=s,c=!0),l.stride!==n&&(l.stride=n,c=!0),l.offset!==o&&(l.offset=o,c=!0)):(c=!0,l.active=!0,l.index=t,l.size=i,l.type=r,l.normalized=s,l.stride=n,l.offset=o,l.buffer=e),(c||this._vaoRecordInProgress)&&(this.bindArrayBuffer(e),r===this._gl.UNSIGNED_INT||r===this._gl.INT?this._gl.vertexAttribIPointer(t,i,r,n,o):this._gl.vertexAttribPointer(t,i,r,s,n,o))}_bindIndexBufferWithCache(e){e!=null&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)}_bindVertexBuffersAttributes(e,t,i){const r=t.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let s=0;s<r.length;s++){const n=t.getAttributeLocation(s);if(n>=0){const o=r[s];let l=null;if(i&&(l=i[o]),l||(l=e[o]),!l)continue;this._gl.enableVertexAttribArray(n),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[n]=!0);const c=l.getBuffer();c&&(this._vertexAttribPointer(c,n,l.getSize(),l.type,l.normalized,l.byteStride,l.byteOffset),l.getIsInstanced()&&(this._gl.vertexAttribDivisor(n,l.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(n),this._currentInstanceBuffers.push(c))))}}}recordVertexArrayObject(e,t,i,r){const s=this._gl.createVertexArray();if(!s)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(s),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(e,i,r),this.bindIndexBuffer(t),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),s}bindVertexArrayObject(e,t){this._cachedVertexArrayObject!==e&&(this._cachedVertexArrayObject=e,this._gl.bindVertexArray(e),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=t!=null&&t.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(e,t,i,r,s){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==s){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=s;const n=s.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let o=0;for(let l=0;l<n;l++)if(l<i.length){const c=s.getAttributeLocation(l);c>=0&&(this._gl.enableVertexAttribArray(c),this._vertexAttribArraysEnabled[c]=!0,this._vertexAttribPointer(e,c,i[l],this._gl.FLOAT,!1,r,o)),o+=i[l]*4}}this._bindIndexBufferWithCache(t)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(e,t,i,r){(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==i)&&(this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=i,this._bindVertexBuffersAttributes(e,i,r)),this._bindIndexBufferWithCache(t)}unbindInstanceAttributes(){let e;for(let t=0,i=this._currentInstanceLocations.length;t<i;t++){const r=this._currentInstanceBuffers[t];e!=r&&r.references&&(e=r,this.bindArrayBuffer(r));const s=this._currentInstanceLocations[t];this._gl.vertexAttribDivisor(s,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(e){this._gl.deleteVertexArray(e)}_releaseBuffer(e){return e.references--,e.references===0?(this._deleteBuffer(e),!0):!1}_deleteBuffer(e){this._gl.deleteBuffer(e.underlyingResource)}updateAndBindInstancesBuffer(e,t,i){if(this.bindArrayBuffer(e),t&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t),i[0].index!==void 0)this.bindInstancesBuffer(e,i,!0);else for(let r=0;r<4;r++){const s=i[r];this._vertexAttribArraysEnabled[s]||(this._gl.enableVertexAttribArray(s),this._vertexAttribArraysEnabled[s]=!0),this._vertexAttribPointer(e,s,4,this._gl.FLOAT,!1,64,r*16),this._gl.vertexAttribDivisor(s,1),this._currentInstanceLocations.push(s),this._currentInstanceBuffers.push(e)}}bindInstancesBuffer(e,t,i=!0){this.bindArrayBuffer(e);let r=0;if(i)for(let s=0;s<t.length;s++){const n=t[s];r+=n.attributeSize*4}for(let s=0;s<t.length;s++){const n=t[s];n.index===void 0&&(n.index=this._currentEffect.getAttributeLocationByName(n.attributeName)),!(n.index<0)&&(this._vertexAttribArraysEnabled[n.index]||(this._gl.enableVertexAttribArray(n.index),this._vertexAttribArraysEnabled[n.index]=!0),this._vertexAttribPointer(e,n.index,n.attributeSize,n.attributeType||this._gl.FLOAT,n.normalized||!1,r,n.offset),this._gl.vertexAttribDivisor(n.index,n.divisor===void 0?1:n.divisor),this._currentInstanceLocations.push(n.index),this._currentInstanceBuffers.push(e))}}disableInstanceAttributeByName(e){if(!this._currentEffect)return;const t=this._currentEffect.getAttributeLocationByName(e);this.disableInstanceAttribute(t)}disableInstanceAttribute(e){let t=!1,i;for(;(i=this._currentInstanceLocations.indexOf(e))!==-1;)this._currentInstanceLocations.splice(i,1),this._currentInstanceBuffers.splice(i,1),t=!0,i=this._currentInstanceLocations.indexOf(e);t&&(this._gl.vertexAttribDivisor(e,0),this.disableAttributeByIndex(e))}disableAttributeByIndex(e){this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=!1,this._currentBufferPointers[e].active=!1}draw(e,t,i,r){this.drawElementsType(e?0:1,t,i,r)}drawPointClouds(e,t,i){this.drawArraysType(2,e,t,i)}drawUnIndexed(e,t,i,r){this.drawArraysType(e?0:1,t,i,r)}drawElementsType(e,t,i,r){this.applyStates(),this._reportDrawCall();const s=this._drawMode(e),n=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,o=this._uintIndicesCurrentlySet?4:2;r?this._gl.drawElementsInstanced(s,i,n,t*o,r):this._gl.drawElements(s,i,n,t*o)}drawArraysType(e,t,i,r){this.applyStates(),this._reportDrawCall();const s=this._drawMode(e);r?this._gl.drawArraysInstanced(s,t,i,r):this._gl.drawArrays(s,t,i)}_drawMode(e){switch(e){case 0:return this._gl.TRIANGLES;case 2:return this._gl.POINTS;case 1:return this._gl.LINES;case 3:return this._gl.POINTS;case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN;default:return this._gl.TRIANGLES}}_releaseEffect(e){this._compiledEffects[e._key]&&delete this._compiledEffects[e._key];const t=e.getPipelineContext();t&&this._deletePipelineContext(t)}_deletePipelineContext(e){const t=e;t&&t.program&&(t.program.__SPECTOR_rebuildProgram=null,dm(t),this._gl&&this._gl.deleteProgram(t.program))}_getGlobalDefines(e){return cm(e,this.isNDCHalfZRange,this.useReverseDepthBuffer,this.useExactSrgbConversions)}createEffect(e,t,i,r,s,n,o,l,c,h=0,f){const u=typeof e=="string"?e:e.vertexToken||e.vertexSource||e.vertexElement||e.vertex,d=typeof e=="string"?e:e.fragmentToken||e.fragmentSource||e.fragmentElement||e.fragment,_=this._getGlobalDefines(),p=t.attributes!==void 0;let g=s??t.defines??"";_&&(g+=_);const E=u+"+"+d+"@"+g;if(this._compiledEffects[E]){const b=this._compiledEffects[E];return o&&b.isReady()&&o(b),b._refCount++,b}this._gl&&xi(this._gl);const v=new lt(e,t,p?this:i,r,this,s,n,o,l,c,E,t.shaderLanguage??h,t.extraInitializationsAsync??f);return this._compiledEffects[E]=v,v}_getShaderSource(e){return this._gl.getShaderSource(e)}createRawShaderProgram(e,t,i,r,s=null){const n=xi(this._gl);return n._contextWasLost=this._contextWasLost,n.validateShaderPrograms=this.validateShaderPrograms,fm(e,t,i,r||this._gl,s)}createShaderProgram(e,t,i,r,s,n=null){const o=xi(this._gl);return o._contextWasLost=this._contextWasLost,o.validateShaderPrograms=this.validateShaderPrograms,um(e,t,i,r,s||this._gl,n)}inlineShaderCode(e){return e}createPipelineContext(e){if(this._gl){const i=xi(this._gl);i.parallelShaderCompile=this._caps.parallelShaderCompile}const t=hA(this._gl);return t.engine=this,t}createMaterialContext(){}createDrawContext(){}_finalizePipelineContext(e){return fc(e,this._gl,this.validateShaderPrograms)}_preparePipelineContext(e,t,i,r,s,n,o,l,c,h,f){const u=xi(this._gl);return u._contextWasLost=this._contextWasLost,u.validateShaderPrograms=this.validateShaderPrograms,u._createShaderProgramInjection=this._createShaderProgram.bind(this),u.createRawShaderProgramInjection=this.createRawShaderProgram.bind(this),u.createShaderProgramInjection=this.createShaderProgram.bind(this),u.loadFileInjection=this._loadFile.bind(this),uA(e,t,i,r,s,n,o,l,c,h,f)}_createShaderProgram(e,t,i,r,s=null){return hc(e,t,i,r,s)}_isRenderingStateCompiled(e){return this._isDisposed?!1:fA(e,this._gl,this.validateShaderPrograms)}_executeWhenRenderingStateIsCompiled(e,t){_A(e,t)}getUniforms(e,t){const i=new Array,r=e;for(let s=0;s<t.length;s++)i.push(this._gl.getUniformLocation(r.program,t[s]));return i}getAttributes(e,t){const i=[],r=e;for(let s=0;s<t.length;s++)try{i.push(this._gl.getAttribLocation(r.program,t[s]))}catch{i.push(-1)}return i}enableEffect(e){e=e!==null&&xR(e)?e.effect:e,!(!e||e===this._currentEffect)&&(this._stencilStateComposer.stencilMaterial=void 0,e=e,this.bindSamplers(e),this._currentEffect=e,e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))}setInt(e,t){return e?(this._gl.uniform1i(e,t),!0):!1}setInt2(e,t,i){return e?(this._gl.uniform2i(e,t,i),!0):!1}setInt3(e,t,i,r){return e?(this._gl.uniform3i(e,t,i,r),!0):!1}setInt4(e,t,i,r,s){return e?(this._gl.uniform4i(e,t,i,r,s),!0):!1}setIntArray(e,t){return e?(this._gl.uniform1iv(e,t),!0):!1}setIntArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2iv(e,t),!0)}setIntArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3iv(e,t),!0)}setIntArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4iv(e,t),!0)}setUInt(e,t){return e?(this._gl.uniform1ui(e,t),!0):!1}setUInt2(e,t,i){return e?(this._gl.uniform2ui(e,t,i),!0):!1}setUInt3(e,t,i,r){return e?(this._gl.uniform3ui(e,t,i,r),!0):!1}setUInt4(e,t,i,r,s){return e?(this._gl.uniform4ui(e,t,i,r,s),!0):!1}setUIntArray(e,t){return e?(this._gl.uniform1uiv(e,t),!0):!1}setUIntArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2uiv(e,t),!0)}setUIntArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3uiv(e,t),!0)}setUIntArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4uiv(e,t),!0)}setArray(e,t){return!e||t.length<1?!1:(this._gl.uniform1fv(e,t),!0)}setArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2fv(e,t),!0)}setArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3fv(e,t),!0)}setArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4fv(e,t),!0)}setMatrices(e,t){return e?(this._gl.uniformMatrix4fv(e,!1,t),!0):!1}setMatrix3x3(e,t){return e?(this._gl.uniformMatrix3fv(e,!1,t),!0):!1}setMatrix2x2(e,t){return e?(this._gl.uniformMatrix2fv(e,!1,t),!0):!1}setFloat(e,t){return e?(this._gl.uniform1f(e,t),!0):!1}setFloat2(e,t,i){return e?(this._gl.uniform2f(e,t,i),!0):!1}setFloat3(e,t,i,r){return e?(this._gl.uniform3f(e,t,i,r),!0):!1}setFloat4(e,t,i,r,s){return e?(this._gl.uniform4f(e,t,i,r,s),!0):!1}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;const e=this._colorWrite;this._gl.colorMask(e,e,e,e)}}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),e&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(e,t){const i=this._gl;let r=i.NEAREST,s=i.NEAREST;switch(e){case 11:r=i.LINEAR,t?s=i.LINEAR_MIPMAP_NEAREST:s=i.LINEAR;break;case 3:r=i.LINEAR,t?s=i.LINEAR_MIPMAP_LINEAR:s=i.LINEAR;break;case 8:r=i.NEAREST,t?s=i.NEAREST_MIPMAP_LINEAR:s=i.NEAREST;break;case 4:r=i.NEAREST,t?s=i.NEAREST_MIPMAP_NEAREST:s=i.NEAREST;break;case 5:r=i.NEAREST,t?s=i.LINEAR_MIPMAP_NEAREST:s=i.LINEAR;break;case 6:r=i.NEAREST,t?s=i.LINEAR_MIPMAP_LINEAR:s=i.LINEAR;break;case 7:r=i.NEAREST,s=i.LINEAR;break;case 1:r=i.NEAREST,s=i.NEAREST;break;case 9:r=i.LINEAR,t?s=i.NEAREST_MIPMAP_NEAREST:s=i.NEAREST;break;case 10:r=i.LINEAR,t?s=i.NEAREST_MIPMAP_LINEAR:s=i.NEAREST;break;case 2:r=i.LINEAR,s=i.LINEAR;break;case 12:r=i.LINEAR,s=i.NEAREST;break}return{min:s,mag:r}}_createTexture(){const e=this._gl.createTexture();if(!e)throw new Error("Unable to create texture");return e}_createHardwareTexture(){return new wc(this._createTexture(),this._gl)}_createInternalTexture(e,t,i=!0,r=0){let s=!1,n=!1,o=0,l=3,c=5,h=!1,f=1,u,d=!1,_=0;t!==void 0&&typeof t=="object"?(s=!!t.generateMipMaps,n=!!t.createMipMaps,o=t.type===void 0?0:t.type,l=t.samplingMode===void 0?3:t.samplingMode,c=t.format===void 0?5:t.format,h=t.useSRGBBuffer===void 0?!1:t.useSRGBBuffer,f=t.samples??1,u=t.label,d=!!t.createMSAATexture,_=t.comparisonFunction||0):s=!!t,h&&(h=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(o===1&&!this._caps.textureFloatLinearFiltering||o===2&&!this._caps.textureHalfFloatLinearFiltering)&&(l=1),o===1&&!this._caps.textureFloat&&(o=0,B.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const p=Kh(c),g=bn(c),E=this._gl,v=new Yt(this,r),b=e.width||e,R=e.height||e,S=e.depth||0,T=e.layers||0,I=this._getSamplingParameters(l,(s||n)&&!p),O=T!==0?E.TEXTURE_2D_ARRAY:S!==0?E.TEXTURE_3D:E.TEXTURE_2D,L=p?this._getInternalFormatFromDepthTextureFormat(c,!0,g):this._getRGBABufferInternalSizedFormat(o,c,h),w=p?g?E.DEPTH_STENCIL:E.DEPTH_COMPONENT:this._getInternalFormat(c),$=p?this._getWebGLTextureTypeFromDepthTextureFormat(c):this._getWebGLTextureType(o);if(this._bindTextureDirectly(O,v),T!==0?(v.is2DArray=!0,E.texImage3D(O,0,L,b,R,T,0,w,$,null)):S!==0?(v.is3D=!0,E.texImage3D(O,0,L,b,R,S,0,w,$,null)):E.texImage2D(O,0,L,b,R,0,w,$,null),E.texParameteri(O,E.TEXTURE_MAG_FILTER,I.mag),E.texParameteri(O,E.TEXTURE_MIN_FILTER,I.min),E.texParameteri(O,E.TEXTURE_WRAP_S,E.CLAMP_TO_EDGE),E.texParameteri(O,E.TEXTURE_WRAP_T,E.CLAMP_TO_EDGE),p&&this.webGLVersion>1&&(_===0?(E.texParameteri(O,E.TEXTURE_COMPARE_FUNC,515),E.texParameteri(O,E.TEXTURE_COMPARE_MODE,E.NONE)):(E.texParameteri(O,E.TEXTURE_COMPARE_FUNC,_),E.texParameteri(O,E.TEXTURE_COMPARE_MODE,E.COMPARE_REF_TO_TEXTURE))),(s||n)&&this._gl.generateMipmap(O),this._bindTextureDirectly(O,null),v._useSRGBBuffer=h,v.baseWidth=b,v.baseHeight=R,v.width=b,v.height=R,v.depth=T||S,v.isReady=!0,v.samples=f,v.generateMipMaps=s,v.samplingMode=l,v.type=o,v.format=c,v.label=u,v.comparisonFunction=_,this._internalTexturesCache.push(v),d){let J=null;if(Kh(v.format)?J=this._setupFramebufferDepthAttachments(bn(v.format),v.format!==19,v.width,v.height,f,v.format,!0):J=this._createRenderBuffer(v.width,v.height,f,-1,this._getRGBABufferInternalSizedFormat(v.type,v.format,v._useSRGBBuffer),-1),!J)throw new Error("Unable to create render buffer");v._autoMSAAManagement=!0;let ce=v._hardwareTexture;ce||(ce=v._hardwareTexture=this._createHardwareTexture()),ce.addMSAARenderBuffer(J)}return v}_getUseSRGBBuffer(e,t){return e&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||t)}createTexture(e,t,i,r,s=3,n=null,o=null,l=null,c=null,h=null,f=null,u,d,_,p){return this._createTextureBase(e,t,i,r,s,n,o,(...g)=>this._prepareWebGLTexture(...g,h),(g,E,v,b,R,S)=>{const T=this._gl,I=v.width===g&&v.height===E;R._creationFlags=_??0;const O=this._getTexImageParametersForCreateTexture(R.format,R._useSRGBBuffer);if(I)return T.texImage2D(T.TEXTURE_2D,0,O.internalFormat,O.format,O.type,v),!1;const L=this._caps.maxTextureSize;if(v.width>L||v.height>L||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext||(this._workingCanvas.width=g,this._workingCanvas.height=E,this._workingContext.drawImage(v,0,0,v.width,v.height,0,0,g,E),T.texImage2D(T.TEXTURE_2D,0,O.internalFormat,O.format,O.type,this._workingCanvas),R.width=g,R.height=E),!1;{const w=new Yt(this,2);this._bindTextureDirectly(T.TEXTURE_2D,w,!0),T.texImage2D(T.TEXTURE_2D,0,O.internalFormat,O.format,O.type,v),this._rescaleTexture(w,R,r,O.format,()=>{this._releaseTexture(w),this._bindTextureDirectly(T.TEXTURE_2D,R,!0),S()})}return!0},l,c,h,f,u,d,p)}_getTexImageParametersForCreateTexture(e,t){let i,r;return this.webGLVersion===1?(i=this._getInternalFormat(e,t),r=i):(i=this._getInternalFormat(e,!1),r=this._getRGBABufferInternalSizedFormat(0,e,t)),{internalFormat:r,format:i,type:this._gl.UNSIGNED_BYTE}}_rescaleTexture(e,t,i,r,s){}_unpackFlipY(e){this._unpackFlipYCached!==e&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,e?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=e))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(e){return e.isCube?this._gl.TEXTURE_CUBE_MAP:e.is3D?this._gl.TEXTURE_3D:e.is2DArray||e.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(e,t,i=!1){const r=this._getTextureTarget(t),s=this._getSamplingParameters(e,t.useMipMaps||i);this._setTextureParameterInteger(r,this._gl.TEXTURE_MAG_FILTER,s.mag,t),this._setTextureParameterInteger(r,this._gl.TEXTURE_MIN_FILTER,s.min),i&&(t.generateMipMaps=!0,this._gl.generateMipmap(r)),this._bindTextureDirectly(r,null),t.samplingMode=e}updateTextureDimensions(e,t,i,r=1){}updateTextureWrappingMode(e,t,i=null,r=null){const s=this._getTextureTarget(e);t!==null&&(this._setTextureParameterInteger(s,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t),e),e._cachedWrapU=t),i!==null&&(this._setTextureParameterInteger(s,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(i),e),e._cachedWrapV=i),(e.is2DArray||e.is3D)&&r!==null&&(this._setTextureParameterInteger(s,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(r),e),e._cachedWrapR=r),this._bindTextureDirectly(s,null)}_uploadCompressedDataToTextureDirectly(e,t,i,r,s,n=0,o=0){const l=this._gl;let c=l.TEXTURE_2D;if(e.isCube&&(c=l.TEXTURE_CUBE_MAP_POSITIVE_X+n),e._useSRGBBuffer)switch(t){case 37492:case 36196:this._caps.etc2?t=l.COMPRESSED_SRGB8_ETC2:e._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?t=l.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:e._useSRGBBuffer=!1;break;case 36492:t=l.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:t=l.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:e._useSRGBBuffer=!1;break;default:e._useSRGBBuffer=!1;break}this._gl.compressedTexImage2D(c,o,t,i,r,0,s)}_uploadDataToTextureDirectly(e,t,i=0,r=0,s,n=!1){const o=this._gl,l=this._getWebGLTextureType(e.type),c=this._getInternalFormat(e.format),h=s===void 0?this._getRGBABufferInternalSizedFormat(e.type,e.format,e._useSRGBBuffer):this._getInternalFormat(s,e._useSRGBBuffer);this._unpackFlipY(e.invertY);let f=o.TEXTURE_2D;e.isCube&&(f=o.TEXTURE_CUBE_MAP_POSITIVE_X+i);const u=Math.round(Math.log(e.width)*Math.LOG2E),d=Math.round(Math.log(e.height)*Math.LOG2E),_=n?e.width:Math.pow(2,Math.max(u-r,0)),p=n?e.height:Math.pow(2,Math.max(d-r,0));o.texImage2D(f,r,h,_,p,0,c,l,t)}updateTextureData(e,t,i,r,s,n,o=0,l=0,c=!1){const h=this._gl,f=this._getWebGLTextureType(e.type),u=this._getInternalFormat(e.format);this._unpackFlipY(e.invertY);let d=h.TEXTURE_2D,_=h.TEXTURE_2D;e.isCube&&(_=h.TEXTURE_CUBE_MAP_POSITIVE_X+o,d=h.TEXTURE_CUBE_MAP),this._bindTextureDirectly(d,e,!0),h.texSubImage2D(_,l,i,r,s,n,u,f,t),c&&this._gl.generateMipmap(_),this._bindTextureDirectly(d,null)}_uploadArrayBufferViewToTexture(e,t,i=0,r=0){const s=this._gl,n=e.isCube?s.TEXTURE_CUBE_MAP:s.TEXTURE_2D;this._bindTextureDirectly(n,e,!0),this._uploadDataToTextureDirectly(e,t,i,r),this._bindTextureDirectly(n,null,!0)}_prepareWebGLTextureContinuation(e,t,i,r,s){const n=this._gl;if(!n)return;const o=this._getSamplingParameters(s,!i);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,o.mag),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,o.min),!i&&!r&&n.generateMipmap(n.TEXTURE_2D),this._bindTextureDirectly(n.TEXTURE_2D,null),t&&t.removePendingData(e),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()}_prepareWebGLTexture(e,t,i,r,s,n,o,l,c,h){const f=this.getCaps().maxTextureSize,u=Math.min(f,this.needPOTTextures?Ts(r.width,f):r.width),d=Math.min(f,this.needPOTTextures?Ts(r.height,f):r.height),_=this._gl;if(_){if(!e._hardwareTexture){i&&i.removePendingData(e);return}this._bindTextureDirectly(_.TEXTURE_2D,e,!0),this._unpackFlipY(s===void 0?!0:!!s),e.baseWidth=r.width,e.baseHeight=r.height,e.width=u,e.height=d,e.isReady=!0,e.type=e.type!==-1?e.type:0,e.format=e.format!==-1?e.format:h??(t===".jpg"&&!e._useSRGBBuffer?4:5),!l(u,d,r,t,e,()=>{this._prepareWebGLTextureContinuation(e,i,n,o,c)})&&this._prepareWebGLTextureContinuation(e,i,n,o,c)}}_getInternalFormatFromDepthTextureFormat(e,t,i){const r=this._gl;if(!t)return r.STENCIL_INDEX8;let n=i?r.DEPTH_STENCIL:r.DEPTH_COMPONENT;return this.webGLVersion>1?e===15?n=r.DEPTH_COMPONENT16:e===16?n=r.DEPTH_COMPONENT24:e===17||e===13?n=i?r.DEPTH24_STENCIL8:r.DEPTH_COMPONENT24:e===14?n=r.DEPTH_COMPONENT32F:e===18&&(n=i?r.DEPTH32F_STENCIL8:r.DEPTH_COMPONENT32F):n=r.DEPTH_COMPONENT16,n}_getWebGLTextureTypeFromDepthTextureFormat(e){const t=this._gl;let i=t.UNSIGNED_INT;return e===15?i=t.UNSIGNED_SHORT:e===17||e===13?i=t.UNSIGNED_INT_24_8:e===14?i=t.FLOAT:e===18?i=t.FLOAT_32_UNSIGNED_INT_24_8_REV:e===19&&(i=t.UNSIGNED_BYTE),i}_setupFramebufferDepthAttachments(e,t,i,r,s=1,n,o=!1){const l=this._gl;n=n??(e?13:14);const c=this._getInternalFormatFromDepthTextureFormat(n,t,e);return e&&t?this._createRenderBuffer(i,r,s,l.DEPTH_STENCIL,c,o?-1:l.DEPTH_STENCIL_ATTACHMENT):t?this._createRenderBuffer(i,r,s,c,c,o?-1:l.DEPTH_ATTACHMENT):e?this._createRenderBuffer(i,r,s,c,c,o?-1:l.STENCIL_ATTACHMENT):null}_createRenderBuffer(e,t,i,r,s,n,o=!0){const c=this._gl.createRenderbuffer();return this._updateRenderBuffer(c,e,t,i,r,s,n,o)}_updateRenderBuffer(e,t,i,r,s,n,o,l=!0){const c=this._gl;return c.bindRenderbuffer(c.RENDERBUFFER,e),r>1&&c.renderbufferStorageMultisample?c.renderbufferStorageMultisample(c.RENDERBUFFER,r,n,t,i):c.renderbufferStorage(c.RENDERBUFFER,s,t,i),o!==-1&&c.framebufferRenderbuffer(c.FRAMEBUFFER,o,c.RENDERBUFFER,e),l&&c.bindRenderbuffer(c.RENDERBUFFER,null),e}_releaseTexture(e){this._deleteTexture(e._hardwareTexture),this.unbindAllTextures();const t=this._internalTexturesCache.indexOf(e);t!==-1&&this._internalTexturesCache.splice(t,1),e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureLow&&e._lodTextureLow.dispose(),e._irradianceTexture&&e._irradianceTexture.dispose()}_deleteTexture(e){e==null||e.release()}_setProgram(e){this._currentProgram!==e&&(dA(e,this._gl),this._currentProgram=e)}bindSamplers(e){const t=e.getPipelineContext();this._setProgram(t.program);const i=e.getSamplers();for(let r=0;r<i.length;r++){const s=e.getUniform(i[r]);s&&(this._boundUniforms[r]=s)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(e,t,i=!1,r=!1){var l;let s=!1;const n=t&&t._associatedChannel>-1;if(i&&n&&(this._activeChannel=t._associatedChannel),this._boundTexturesCache[this._activeChannel]!==t||r){if(this._activateCurrentTexture(),t&&t.isMultiview)throw B.Error(["_bindTextureDirectly called with a multiview texture!",e,t]),"_bindTextureDirectly called with a multiview texture!";this._gl.bindTexture(e,((l=t==null?void 0:t._hardwareTexture)==null?void 0:l.underlyingResource)??null),this._boundTexturesCache[this._activeChannel]=t,t&&(t._associatedChannel=this._activeChannel)}else i&&(s=!0,this._activateCurrentTexture());return n&&!i&&this._bindSamplerUniformToChannel(t._associatedChannel,this._activeChannel),s}_bindTexture(e,t,i){if(e===void 0)return;t&&(t._associatedChannel=e),this._activeChannel=e;const r=t?this._getTextureTarget(t):this._gl.TEXTURE_2D;this._bindTextureDirectly(r,t)}unbindAllTextures(){for(let e=0;e<this._maxSimultaneousTextures;e++)this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(e,t,i,r){e!==void 0&&(t&&(this._boundUniforms[e]=t),this._setTexture(e,i))}_bindSamplerUniformToChannel(e,t){const i=this._boundUniforms[e];!i||i._currentState===t||(this._gl.uniform1i(i,t),i._currentState=t)}_getTextureWrapMode(e){switch(e){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(e,t,i=!1,r=!1,s=""){if(!t)return this._boundTexturesCache[e]!=null&&(this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(t.video){this._activeChannel=e;const c=t.getInternalTexture();c&&(c._associatedChannel=e),t.update()}else if(t.delayLoadState===4)return t.delayLoad(),!1;let n;r?n=t.depthStencilTexture:t.isReady()?n=t.getInternalTexture():t.isCube?n=this.emptyCubeTexture:t.is3D?n=this.emptyTexture3D:t.is2DArray?n=this.emptyTexture2DArray:n=this.emptyTexture,!i&&n&&(n._associatedChannel=e);let o=!0;this._boundTexturesCache[e]===n&&(i||this._bindSamplerUniformToChannel(n._associatedChannel,e),o=!1),this._activeChannel=e;const l=this._getTextureTarget(n);if(o&&this._bindTextureDirectly(l,n,i),n&&!n.isMultiview){if(n.isCube&&n._cachedCoordinatesMode!==t.coordinatesMode){n._cachedCoordinatesMode=t.coordinatesMode;const c=t.coordinatesMode!==3&&t.coordinatesMode!==5?1:0;t.wrapU=c,t.wrapV=c}n._cachedWrapU!==t.wrapU&&(n._cachedWrapU=t.wrapU,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t.wrapU),n)),n._cachedWrapV!==t.wrapV&&(n._cachedWrapV=t.wrapV,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(t.wrapV),n)),n.is3D&&n._cachedWrapR!==t.wrapR&&(n._cachedWrapR=t.wrapR,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(t.wrapR),n)),this._setAnisotropicLevel(l,n,t.anisotropicFilteringLevel)}return!0}setTextureArray(e,t,i,r){if(!(e===void 0||!t)){(!this._textureUnits||this._textureUnits.length!==i.length)&&(this._textureUnits=new Int32Array(i.length));for(let s=0;s<i.length;s++){const n=i[s].getInternalTexture();n?(this._textureUnits[s]=e+s,n._associatedChannel=e+s):this._textureUnits[s]=-1}this._gl.uniform1iv(t,this._textureUnits);for(let s=0;s<i.length;s++)this._setTexture(this._textureUnits[s],i[s],!0)}}_setAnisotropicLevel(e,t,i){const r=this._caps.textureAnisotropicFilterExtension;t.samplingMode!==11&&t.samplingMode!==3&&t.samplingMode!==2&&(i=1),r&&t._cachedAnisotropicFilteringLevel!==i&&(this._setTextureParameterFloat(e,r.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(i,this._caps.maxAnisotropy),t),t._cachedAnisotropicFilteringLevel=i)}_setTextureParameterFloat(e,t,i,r){this._bindTextureDirectly(e,r,!0,!0),this._gl.texParameterf(e,t,i)}_setTextureParameterInteger(e,t,i,r){r&&this._bindTextureDirectly(e,r,!0,!0),this._gl.texParameteri(e,t,i)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let e=0;e<this._caps.maxVertexAttribs;e++)this.disableAttributeByIndex(e);return}for(let e=0,t=this._vertexAttribArraysEnabled.length;e<t;e++)e>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[e]||this.disableAttributeByIndex(e)}releaseEffects(){this._compiledEffects={},this.onReleaseEffectsObservable.notifyObservers(this)}dispose(){var e;Ht()&&this._renderingCanvas&&(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._onContextRestored&&this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),super.dispose(),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.unbindAllAttributes(),this._boundUniforms={},this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._currentProgram=null,this._creationOptions.loseContextOnDispose&&((e=this._gl.getExtension("WEBGL_lose_context"))==null||e.loseContext()),No(this._gl)}attachContextLostEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",e,!1)}attachContextRestoredEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",e,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(e){const t=this._gl;for(;t.getError()!==t.NO_ERROR;);let i=!0;const r=t.createTexture();t.bindTexture(t.TEXTURE_2D,r),t.texImage2D(t.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,t.RGBA,this._getWebGLTextureType(e),null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);const s=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,s),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,r,0);const n=t.checkFramebufferStatus(t.FRAMEBUFFER);if(i=i&&n===t.FRAMEBUFFER_COMPLETE,i=i&&t.getError()===t.NO_ERROR,i&&(t.clear(t.COLOR_BUFFER_BIT),i=i&&t.getError()===t.NO_ERROR),i){t.bindFramebuffer(t.FRAMEBUFFER,null);const o=t.RGBA,l=t.UNSIGNED_BYTE,c=new Uint8Array(4);t.readPixels(0,0,1,1,o,l,c),i=i&&t.getError()===t.NO_ERROR}for(t.deleteTexture(r),t.deleteFramebuffer(s),t.bindFramebuffer(t.FRAMEBUFFER,null);!i&&t.getError()!==t.NO_ERROR;);return i}_getWebGLTextureType(e){if(this._webGLVersion===1){switch(e){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(e){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(e,t=!1){let i=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;switch(e){case 0:i=this._gl.ALPHA;break;case 1:i=this._gl.LUMINANCE;break;case 2:i=this._gl.LUMINANCE_ALPHA;break;case 6:case 33322:case 36760:i=this._gl.RED;break;case 7:case 33324:case 36761:i=this._gl.RG;break;case 4:case 32852:case 36762:i=t?this._glSRGBExtensionValues.SRGB:this._gl.RGB;break;case 5:case 32859:case 36763:i=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;break}if(this._webGLVersion>1)switch(e){case 8:i=this._gl.RED_INTEGER;break;case 9:i=this._gl.RG_INTEGER;break;case 10:i=this._gl.RGB_INTEGER;break;case 11:i=this._gl.RGBA_INTEGER;break}return i}_getRGBABufferInternalSizedFormat(e,t,i=!1){if(this._webGLVersion===1){if(t!==void 0)switch(t){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return i?this._glSRGBExtensionValues.SRGB:this._gl.RGB}return this._gl.RGBA}switch(e){case 3:switch(t){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(t){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return i?this._glSRGBExtensionValues.SRGB8:this._gl.RGB8;case 5:return i?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(t){case 8:return this._gl.R16I;case 36760:return this._gl.R16_SNORM_EXT;case 36761:return this._gl.RG16_SNORM_EXT;case 36762:return this._gl.RGB16_SNORM_EXT;case 36763:return this._gl.RGBA16_SNORM_EXT;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;case 11:return this._gl.RGBA16I;default:return this._gl.RGBA16I}case 5:switch(t){case 8:return this._gl.R16UI;case 33322:return this._gl.R16_EXT;case 33324:return this._gl.RG16_EXT;case 32852:return this._gl.RGB16_EXT;case 32859:return this._gl.RGBA16_EXT;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;case 11:return this._gl.RGBA16UI;default:return this._gl.RGBA16UI}case 6:switch(t){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;case 11:return this._gl.RGBA32I;default:return this._gl.RGBA32I}case 7:switch(t){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;case 11:return this._gl.RGBA32UI;default:return this._gl.RGBA32UI}case 1:switch(t){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;case 5:return this._gl.RGBA32F;default:return this._gl.RGBA32F}case 2:switch(t){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;case 5:return this._gl.RGBA16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(t){case 5:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI;default:return this._gl.RGB10_A2}}return i?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8}readPixels(e,t,i,r,s=!0,n=!0,o=null){const l=s?4:3,c=s?this._gl.RGBA:this._gl.RGB,h=i*r*l;if(!o)o=new Uint8Array(h);else if(o.length<h)return B.Error(`Data buffer is too small to store the read pixels (${o.length} should be more than ${h})`),Promise.resolve(o);return n&&this.flushFramebuffer(),this._gl.readPixels(e,t,i,r,c,this._gl.UNSIGNED_BYTE,o),Promise.resolve(o)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(this._HasMajorPerformanceCaveat!==null)return!this._HasMajorPerformanceCaveat;if(this._IsSupported===null)try{const e=H._CreateCanvas(1,1),t=e.getContext("webgl")||e.getContext("experimental-webgl");this._IsSupported=t!=null&&!!window.WebGLRenderingContext}catch{this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(this._HasMajorPerformanceCaveat===null)try{const e=H._CreateCanvas(1,1),t=e.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||e.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!t}catch{this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}}We._TempClearColorUint32=new Uint32Array(4);We._TempClearColorInt32=new Int32Array(4);We.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/12\\d\\..+?Mobile",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}];We._ConcatenateShader=om;We._IsSupported=null;We._HasMajorPerformanceCaveat=null;const DR=Object.freeze(Object.defineProperty({__proto__:null,ThinEngine:We},Symbol.toStringTag,{value:"Module"}));class LR{constructor(e=30){this._enabled=!0,this._rollingFrameTime=new NR(e)}sampleFrame(e=Ti.Now){if(this._enabled){if(this._lastFrameTimeMs!=null){const t=e-this._lastFrameTimeMs;this._rollingFrameTime.add(t)}this._lastFrameTimeMs=e}}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){const e=this._rollingFrameTime.history(0);return e===0?0:1e3/e}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=!0}disable(){this._enabled=!1,this._lastFrameTimeMs=null}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}}class NR{constructor(e){this._samples=new Array(e),this.reset()}add(e){let t;if(this.isSaturated()){const i=this._samples[this._pos];t=i-this.average,this.average-=t/(this._sampleCount-1),this._m2-=t*(i-this.average)}else this._sampleCount++;t=e-this.average,this.average+=t/this._sampleCount,this._m2+=t*(e-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=e,this._pos++,this._pos%=this._samples.length}history(e){if(e>=this._sampleCount||e>=this._samples.length)return 0;const t=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(t-e)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}_wrapPosition(e){const t=this._samples.length;return(e%t+t)%t}}We.prototype.setAlphaMode=function(a,e=!1){if(this._alphaMode===a){if(!e){const t=a===0;this.depthCullingState.depthMask!==t&&(this.depthCullingState.depthMask=t)}return}switch(a){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break}e||(this.depthCullingState.depthMask=a===0),this._alphaMode=a};We.prototype.updateRawTexture=function(a,e,t,i,r=null,s=0,n=!1){if(!a)return;const o=this._getRGBABufferInternalSizedFormat(s,t,n),l=this._getInternalFormat(t),c=this._getWebGLTextureType(s);this._bindTextureDirectly(this._gl.TEXTURE_2D,a,!0),this._unpackFlipY(i===void 0?!0:!!i),this._doNotHandleContextLost||(a._bufferView=e,a.format=t,a.type=s,a.invertY=i,a._compression=r),a.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),r&&e?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[r],a.width,a.height,0,e):this._gl.texImage2D(this._gl.TEXTURE_2D,0,o,a.width,a.height,0,l,c,e),a.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),a.isReady=!0};We.prototype.createRawTexture=function(a,e,t,i,r,s,n,o=null,l=0,c=0,h=!1){const f=new Yt(this,3);f.baseWidth=e,f.baseHeight=t,f.width=e,f.height=t,f.format=i,f.generateMipMaps=r,f.samplingMode=n,f.invertY=s,f._compression=o,f.type=l,f._useSRGBBuffer=this._getUseSRGBBuffer(h,!r),this._doNotHandleContextLost||(f._bufferView=a),this.updateRawTexture(f,a,i,s,o,l,f._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,f,!0);const u=this._getSamplingParameters(n,r);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,u.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,u.min),r&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(f),f};We.prototype.createRawCubeTexture=function(a,e,t,i,r,s,n,o=null){const l=this._gl,c=new Yt(this,8);c.isCube=!0,c.format=t,c.type=i,this._doNotHandleContextLost||(c._bufferViewArray=a);const h=this._getWebGLTextureType(i);let f=this._getInternalFormat(t);f===l.RGB&&(f=l.RGBA),h===l.FLOAT&&!this._caps.textureFloatLinearFiltering?(r=!1,n=1,B.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):h===this._gl.HALF_FLOAT_OES&&!this._caps.textureHalfFloatLinearFiltering?(r=!1,n=1,B.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):h===l.FLOAT&&!this._caps.textureFloatRender?(r=!1,B.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):h===l.HALF_FLOAT&&!this._caps.colorBufferFloat&&(r=!1,B.Warn("Render to half float textures is not supported. Mipmap generation forced to false."));const u=e,d=u;if(c.width=u,c.height=d,c.invertY=s,c._compression=o,!this.needPOTTextures||An(c.width)&&An(c.height)||(r=!1),a)this.updateRawCubeTexture(c,a,t,i,s,o);else{const g=this._getRGBABufferInternalSizedFormat(i),E=0;this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,c,!0);for(let v=0;v<6;v++)o?l.compressedTexImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+v,E,this.getCaps().s3tc[o],c.width,c.height,0,void 0):l.texImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+v,E,g,c.width,c.height,0,f,h,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,c,!0),a&&r&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);const p=this._getSamplingParameters(n,r);return l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MAG_FILTER,p.mag),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MIN_FILTER,p.min),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,null),c.generateMipMaps=r,c.samplingMode=n,c.isReady=!0,c};We.prototype.updateRawCubeTexture=function(a,e,t,i,r,s=null,n=0){a._bufferViewArray=e,a.format=t,a.type=i,a.invertY=r,a._compression=s;const o=this._gl,l=this._getWebGLTextureType(i);let c=this._getInternalFormat(t);const h=this._getRGBABufferInternalSizedFormat(i);let f=!1;c===o.RGB&&(c=o.RGBA,f=!0),this._bindTextureDirectly(o.TEXTURE_CUBE_MAP,a,!0),this._unpackFlipY(r===void 0?!0:!!r),a.width%4!==0&&o.pixelStorei(o.UNPACK_ALIGNMENT,1);for(let d=0;d<6;d++){let _=e[d];s?o.compressedTexImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+d,n,this.getCaps().s3tc[s],a.width,a.height,0,_):(f&&(_=Wm(_,a.width,a.height,i)),o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+d,n,h,a.width,a.height,0,c,l,_))}(!this.needPOTTextures||An(a.width)&&An(a.height))&&a.generateMipMaps&&n===0&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),a.isReady=!0};We.prototype.createRawCubeTextureFromUrl=function(a,e,t,i,r,s,n,o,l=null,c=null,h=3,f=!1){const u=this._gl,d=this.createRawCubeTexture(null,t,i,r,!s,f,h,null);e==null||e.addPendingData(d),d.url=a,d.isReady=!1,this._internalTexturesCache.push(d);const _=(g,E)=>{e==null||e.removePendingData(d),c&&g&&c(g.status+" "+g.statusText,E)},p=g=>{if(!d._hardwareTexture)return;const E=d.width,v=n(g);if(v){if(o){const b=this._getWebGLTextureType(r);let R=this._getInternalFormat(i);const S=this._getRGBABufferInternalSizedFormat(r);let T=!1;R===u.RGB&&(R=u.RGBA,T=!0),this._bindTextureDirectly(u.TEXTURE_CUBE_MAP,d,!0),this._unpackFlipY(!1);const I=o(v);for(let O=0;O<I.length;O++){const L=E>>O;for(let w=0;w<6;w++){let $=I[O][w];T&&($=Wm($,L,L,r)),u.texImage2D(w,O,S,L,L,0,R,b,$)}}this._bindTextureDirectly(u.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(d,v,i,r,f);d.isReady=!0,e==null||e.removePendingData(d),d.onLoadedObservable.notifyObservers(d),d.onLoadedObservable.clear(),l&&l()}};return this._loadFile(a,g=>{p(g)},void 0,e==null?void 0:e.offlineProvider,!0,_),d};function Wm(a,e,t,i){let r,s=1;i===1?r=new Float32Array(e*t*4):i===2?(r=new Uint16Array(e*t*4),s=15360):i===7?r=new Uint32Array(e*t*4):r=new Uint8Array(e*t*4);for(let n=0;n<e;n++)for(let o=0;o<t;o++){const l=(o*e+n)*3,c=(o*e+n)*4;r[c+0]=a[l+0],r[c+1]=a[l+1],r[c+2]=a[l+2],r[c+3]=s}return r}function Xm(a){return function(e,t,i,r,s,n,o,l,c=null,h=0){const f=a?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,u=a?10:11,d=new Yt(this,u);d.baseWidth=t,d.baseHeight=i,d.baseDepth=r,d.width=t,d.height=i,d.depth=r,d.format=s,d.type=h,d.generateMipMaps=n,d.samplingMode=l,a?d.is3D=!0:d.is2DArray=!0,this._doNotHandleContextLost||(d._bufferView=e),a?this.updateRawTexture3D(d,e,s,o,c,h):this.updateRawTexture2DArray(d,e,s,o,c,h),this._bindTextureDirectly(f,d,!0);const _=this._getSamplingParameters(l,n);return this._gl.texParameteri(f,this._gl.TEXTURE_MAG_FILTER,_.mag),this._gl.texParameteri(f,this._gl.TEXTURE_MIN_FILTER,_.min),n&&this._gl.generateMipmap(f),this._bindTextureDirectly(f,null),this._internalTexturesCache.push(d),d}}We.prototype.createRawTexture2DArray=Xm(!1);We.prototype.createRawTexture3D=Xm(!0);function Hm(a){return function(e,t,i,r,s=null,n=0){const o=a?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,l=this._getWebGLTextureType(n),c=this._getInternalFormat(i),h=this._getRGBABufferInternalSizedFormat(n,i);this._bindTextureDirectly(o,e,!0),this._unpackFlipY(r===void 0?!0:!!r),this._doNotHandleContextLost||(e._bufferView=t,e.format=i,e.invertY=r,e._compression=s),e.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),s&&t?this._gl.compressedTexImage3D(o,0,this.getCaps().s3tc[s],e.width,e.height,e.depth,0,t):this._gl.texImage3D(o,0,h,e.width,e.height,e.depth,0,c,l,t),e.generateMipMaps&&this._gl.generateMipmap(o),this._bindTextureDirectly(o,null),e.isReady=!0}}We.prototype.updateRawTexture2DArray=Hm(!1);We.prototype.updateRawTexture3D=Hm(!0);We.prototype._readTexturePixelsSync=function(a,e,t,i=-1,r=0,s=null,n=!0,o=!1,l=0,c=0){var u,d;const h=this._gl;if(!h)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){const _=h.createFramebuffer();if(!_)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=_}h.bindFramebuffer(h.FRAMEBUFFER,this._dummyFramebuffer),i>-1?h.framebufferTexture2D(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.TEXTURE_CUBE_MAP_POSITIVE_X+i,(u=a._hardwareTexture)==null?void 0:u.underlyingResource,r):h.framebufferTexture2D(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.TEXTURE_2D,(d=a._hardwareTexture)==null?void 0:d.underlyingResource,r);let f=a.type!==void 0?this._getWebGLTextureType(a.type):h.UNSIGNED_BYTE;if(o)s||(s=ZS(a.type,4*e*t));else switch(f){case h.UNSIGNED_BYTE:s||(s=new Uint8Array(4*e*t)),f=h.UNSIGNED_BYTE;break;default:s||(s=new Float32Array(4*e*t)),f=h.FLOAT;break}return n&&this.flushFramebuffer(),h.readPixels(l,c,e,t,h.RGBA,f,s),h.bindFramebuffer(h.FRAMEBUFFER,this._currentFramebuffer),s};We.prototype._readTexturePixels=function(a,e,t,i=-1,r=0,s=null,n=!0,o=!1,l=0,c=0){return Promise.resolve(this._readTexturePixelsSync(a,e,t,i,r,s,n,o,l,c))};We.prototype.updateDynamicIndexBuffer=function(a,e,t=0){this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(a);let i;a.is32Bits?i=e instanceof Uint32Array?e:new Uint32Array(e):i=e instanceof Uint16Array?e:new Uint16Array(e),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,i,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()};We.prototype.updateDynamicVertexBuffer=function(a,e,t,i){this.bindArrayBuffer(a),t===void 0&&(t=0);const r=e.byteLength||e.length;i===void 0||i>=r&&t===0?e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,new Float32Array(e)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,e):e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,new Float32Array(e).subarray(0,i/4)):(e instanceof ArrayBuffer?e=new Uint8Array(e,0,i):e=new Uint8Array(e.buffer,e.byteOffset,i),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,e)),this._resetVertexBufferBinding()};We.prototype._createDepthStencilCubeTexture=function(a,e){const t=new Yt(this,12);if(t.isCube=!0,this.webGLVersion===1)return B.Error("Depth cube texture is not supported by WebGL 1."),t;const i={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...e},r=this._gl;this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,t,!0),this._setupDepthStencilTexture(t,a,i.bilinearFiltering,i.comparisonFunction);for(let s=0;s<6;s++)i.generateStencil?r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,0,r.DEPTH24_STENCIL8,a,a,0,r.DEPTH_STENCIL,r.UNSIGNED_INT_24_8,null):r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,0,r.DEPTH_COMPONENT24,a,a,0,r.DEPTH_COMPONENT,r.UNSIGNED_INT,null);return this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(t),t};We.prototype._setCubeMapTextureParams=function(a,e,t){const i=this._gl;i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MIN_FILTER,e?i.LINEAR_MIPMAP_LINEAR:i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),a.samplingMode=e?3:2,e&&this.getCaps().textureMaxLevel&&t!==void 0&&t>0&&(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAX_LEVEL,t),a._maxLodLevel=t),this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,null)};We.prototype.createCubeTexture=function(a,e,t,i,r=null,s=null,n,o=null,l=!1,c=0,h=0,f=null,u,d=!1,_=null){const p=this._gl;return this.createCubeTextureBase(a,e,t,!!i,r,s,n,o,l,c,h,f,g=>this._bindTextureDirectly(p.TEXTURE_CUBE_MAP,g,!0),(g,E)=>{const v=this.needPOTTextures?Ts(E[0].width,this._caps.maxCubemapTextureSize):E[0].width,b=v,R=[p.TEXTURE_CUBE_MAP_POSITIVE_X,p.TEXTURE_CUBE_MAP_POSITIVE_Y,p.TEXTURE_CUBE_MAP_POSITIVE_Z,p.TEXTURE_CUBE_MAP_NEGATIVE_X,p.TEXTURE_CUBE_MAP_NEGATIVE_Y,p.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(p.TEXTURE_CUBE_MAP,g,!0),this._unpackFlipY(!1);const S=n?this._getInternalFormat(n,g._useSRGBBuffer):g._useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:p.RGBA;let T=n?this._getInternalFormat(n):p.RGBA;g._useSRGBBuffer&&this.webGLVersion===1&&(T=S);for(let I=0;I<R.length;I++)if(E[I].width!==v||E[I].height!==b){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext){B.Warn("Cannot create canvas to resize texture.");return}this._workingCanvas.width=v,this._workingCanvas.height=b,this._workingContext.drawImage(E[I],0,0,E[I].width,E[I].height,0,0,v,b),p.texImage2D(R[I],0,S,T,p.UNSIGNED_BYTE,this._workingCanvas)}else p.texImage2D(R[I],0,S,T,p.UNSIGNED_BYTE,E[I]);i||p.generateMipmap(p.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(g,!i),g.width=v,g.height=b,g.isReady=!0,n&&(g.format=n),g.onLoadedObservable.notifyObservers(g),g.onLoadedObservable.clear(),r&&r()},!!d,_)};We.prototype.generateMipMapsForCubemap=function(a,e=!0){if(a.generateMipMaps){const t=this._gl;this._bindTextureDirectly(t.TEXTURE_CUBE_MAP,a,!0),t.generateMipmap(t.TEXTURE_CUBE_MAP),e&&this._bindTextureDirectly(t.TEXTURE_CUBE_MAP,null)}};class FR{get depthStencilTexture(){return this._depthStencilTexture}setDepthStencilTexture(e,t=!0){t&&this._depthStencilTexture&&this._depthStencilTexture.dispose(),this._depthStencilTexture=e,this._generateDepthBuffer=this._generateStencilBuffer=this._depthStencilTextureWithStencil=!1,e&&(this._generateDepthBuffer=!0,this._generateStencilBuffer=this._depthStencilTextureWithStencil=bn(e.format))}get depthStencilTextureWithStencil(){return this._depthStencilTextureWithStencil}get isCube(){return this._isCube}get isMulti(){return this._isMulti}get is2DArray(){return this.layers>0}get is3D(){return this.depth>0}get size(){return this.width}get width(){return this._size.width??this._size}get height(){return this._size.height??this._size}get layers(){return this._size.layers||0}get depth(){return this._size.depth||0}get texture(){var e;return((e=this._textures)==null?void 0:e[0])??null}get textures(){return this._textures}get faceIndices(){return this._faceIndices}get layerIndices(){return this._layerIndices}getBaseArrayLayer(e){var s,n;if(!this._textures)return-1;const t=this._textures[e],i=((s=this._layerIndices)==null?void 0:s[e])??0,r=((n=this._faceIndices)==null?void 0:n[e])??0;return t.isCube?i*6+r:t.is3D?0:i}get samples(){return this._samples}setSamples(e,t=!0,i=!1){if(this.samples===e&&!i)return e;const r=this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,e,t):this._engine.updateRenderTargetTextureSampleCount(this,e);return this._samples=e,r}resolveMSAATextures(){this.isMulti?this._engine.resolveMultiFramebuffer(this):this._engine.resolveFramebuffer(this)}generateMipMaps(){this._engine._currentRenderTarget===this&&this._engine.unBindFramebuffer(this,!0),this.isMulti?this._engine.generateMipMapsMultiFramebuffer(this):this._engine.generateMipMapsFramebuffer(this)}constructor(e,t,i,r,s){this._textures=null,this._faceIndices=null,this._layerIndices=null,this._samples=1,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this.disableAutomaticMSAAResolve=!1,this.resolveMSAAColors=!0,this.resolveMSAADepth=!1,this.resolveMSAAStencil=!1,this._isMulti=e,this._isCube=t,this._size=i,this._engine=r,this._depthStencilTexture=null,this.label=s}setTextures(e){Array.isArray(e)?this._textures=e:e?this._textures=[e]:this._textures=null}setTexture(e,t=0,i=!0){this._textures||(this._textures=[]),this._textures[t]!==e&&(this._textures[t]&&i&&this._textures[t].dispose(),this._textures[t]=e)}setLayerAndFaceIndices(e,t){this._layerIndices=e,this._faceIndices=t}setLayerAndFaceIndex(e=0,t,i){this._layerIndices||(this._layerIndices=[]),this._faceIndices||(this._faceIndices=[]),t!==void 0&&t>=0&&(this._layerIndices[e]=t),i!==void 0&&i>=0&&(this._faceIndices[e]=i)}createDepthStencilTexture(e=0,t=!0,i=!1,r=1,s=14,n){var o;return(o=this._depthStencilTexture)==null||o.dispose(),this._depthStencilTextureWithStencil=i,this._depthStencilTextureLabel=n,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:t,comparisonFunction:e,generateStencil:i,isCube:this._isCube,samples:r,depthTextureFormat:s,label:n},this),this._depthStencilTexture}_shareDepth(e){this.shareDepth(e)}shareDepth(e){this._depthStencilTexture&&(e._depthStencilTexture&&e._depthStencilTexture.dispose(),e._depthStencilTexture=this._depthStencilTexture,e._depthStencilTextureWithStencil=this._depthStencilTextureWithStencil,this._depthStencilTexture.incrementReferences())}_swapAndDie(e){this.texture&&this.texture._swapAndDie(e),this._textures=null,this.dispose(!0)}_cloneRenderTargetWrapper(){var t,i,r,s,n;let e=null;if(this._isMulti){const o=this.textures;if(o&&o.length>0){let l=!1,c=o.length,h=-1;const f=o[o.length-1]._source;(f===14||f===12)&&(l=!0,h=o[o.length-1].format,c--);const u=[],d=[],_=[],p=[],g=[],E=[],v=[],b={};for(let T=0;T<c;++T){const I=o[T];u.push(I.samplingMode),d.push(I.type),_.push(I.format),b[I.uniqueId]!==void 0?(p.push(-1),v.push(0)):(b[I.uniqueId]=T,I.is2DArray?(p.push(35866),v.push(I.depth)):I.isCube?(p.push(34067),v.push(0)):I.is3D?(p.push(32879),v.push(I.depth)):(p.push(3553),v.push(0))),this._faceIndices&&g.push(this._faceIndices[T]??0),this._layerIndices&&E.push(this._layerIndices[T]??0)}const R={samplingModes:u,generateMipMaps:o[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:l,depthTextureFormat:h,types:d,formats:_,textureCount:c,targetTypes:p,faceIndex:g,layerIndex:E,layerCounts:v,label:this.label},S={width:this.width,height:this.height,depth:this.depth};e=this._engine.createMultipleRenderTarget(S,R);for(let T=0;T<c;++T){if(p[T]!==-1)continue;const I=b[o[T].uniqueId];e.setTexture(e.textures[I],T)}}}else{const o={};if(o.generateDepthBuffer=this._generateDepthBuffer,o.generateMipMaps=((t=this.texture)==null?void 0:t.generateMipMaps)??!1,o.generateStencilBuffer=this._generateStencilBuffer,o.samplingMode=(i=this.texture)==null?void 0:i.samplingMode,o.type=(r=this.texture)==null?void 0:r.type,o.format=(s=this.texture)==null?void 0:s.format,o.noColorAttachment=!this._textures,o.label=this.label,this.isCube)e=this._engine.createRenderTargetCubeTexture(this.width,o);else{const l={width:this.width,height:this.height,layers:this.is2DArray||this.is3D?(n=this.texture)==null?void 0:n.depth:void 0};e=this._engine.createRenderTargetTexture(l,o)}e.texture&&(e.texture.isReady=!0)}return e}_swapRenderTargetWrapper(e){if(this._textures&&e._textures)for(let t=0;t<this._textures.length;++t)this._textures[t]._swapAndDie(e._textures[t],!1),e._textures[t].isReady=!0;this._depthStencilTexture&&e._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(e._depthStencilTexture),e._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null}_rebuild(){const e=this._cloneRenderTargetWrapper();if(e){if(this._depthStencilTexture){const t=this._depthStencilTexture.samplingMode,i=this._depthStencilTexture.format,r=t===2||t===3||t===11;e.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,r,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples,i,this._depthStencilTextureLabel)}this.samples>1&&e.setSamples(this.samples),e._swapRenderTargetWrapper(this),e.dispose()}}releaseTextures(){if(this._textures)for(let e=0;e<this._textures.length;++e)this._textures[e].dispose();this._textures=null}dispose(e=!1){var t;e||((t=this._depthStencilTexture)==null||t.dispose(),this._depthStencilTexture=null,this.releaseTextures()),this._engine._releaseRenderTargetWrapper(this)}}class wR extends FR{setDepthStencilTexture(e,t=!0){if(super.setDepthStencilTexture(e,t),!e)return;const i=this._engine,r=this._context,s=e._hardwareTexture;if(s&&e._autoMSAAManagement&&this._MSAAFramebuffer){const n=i._currentFramebuffer;i._bindUnboundFramebuffer(this._MSAAFramebuffer),r.framebufferRenderbuffer(r.FRAMEBUFFER,bn(e.format)?r.DEPTH_STENCIL_ATTACHMENT:r.DEPTH_ATTACHMENT,r.RENDERBUFFER,s.getMSAARenderBuffer()),i._bindUnboundFramebuffer(n)}}constructor(e,t,i,r,s){super(e,t,i,r),this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._disposeOnlyFramebuffers=!1,this._currentLOD=0,this._context=s}_cloneRenderTargetWrapper(){let e=null;return this._colorTextureArray&&this._depthStencilTextureArray?(e=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),e.texture.isReady=!0):e=super._cloneRenderTargetWrapper(),e}_swapRenderTargetWrapper(e){super._swapRenderTargetWrapper(e),e._framebuffer=this._framebuffer,e._depthStencilBuffer=this._depthStencilBuffer,e._MSAAFramebuffer=this._MSAAFramebuffer,e._colorTextureArray=this._colorTextureArray,e._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null}createDepthStencilTexture(e=0,t=!0,i=!1,r=1,s=14,n){if(this._depthStencilBuffer){const o=this._engine,l=o._currentFramebuffer,c=this._context;o._bindUnboundFramebuffer(this._framebuffer),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_STENCIL_ATTACHMENT,c.RENDERBUFFER,null),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,null),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.STENCIL_ATTACHMENT,c.RENDERBUFFER,null),o._bindUnboundFramebuffer(l),c.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null}return super.createDepthStencilTexture(e,t,i,r,s,n)}shareDepth(e){super.shareDepth(e);const t=this._context,i=this._depthStencilBuffer,r=e._MSAAFramebuffer||e._framebuffer,s=this._engine;e._depthStencilBuffer&&e._depthStencilBuffer!==i&&t.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=i;const n=e._generateStencilBuffer?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;s._bindUnboundFramebuffer(r),t.framebufferRenderbuffer(t.FRAMEBUFFER,n,t.RENDERBUFFER,i),s._bindUnboundFramebuffer(null)}_bindTextureRenderTarget(e,t=0,i,r=0){var h,f;const s=e._hardwareTexture;if(!s)return;const n=this._framebuffer,o=this._engine,l=o._currentFramebuffer;o._bindUnboundFramebuffer(n);let c;if(o.webGLVersion>1){const u=this._context;c=u["COLOR_ATTACHMENT"+t],e.is2DArray||e.is3D?(i=i??((h=this.layerIndices)==null?void 0:h[t])??0,u.framebufferTextureLayer(u.FRAMEBUFFER,c,s.underlyingResource,r,i)):e.isCube?(i=i??((f=this.faceIndices)==null?void 0:f[t])??0,u.framebufferTexture2D(u.FRAMEBUFFER,c,u.TEXTURE_CUBE_MAP_POSITIVE_X+i,s.underlyingResource,r)):u.framebufferTexture2D(u.FRAMEBUFFER,c,u.TEXTURE_2D,s.underlyingResource,r)}else{const u=this._context;c=u["COLOR_ATTACHMENT"+t+"_WEBGL"];const d=i!==void 0?u.TEXTURE_CUBE_MAP_POSITIVE_X+i:u.TEXTURE_2D;u.framebufferTexture2D(u.FRAMEBUFFER,c,d,s.underlyingResource,r)}if(e._autoMSAAManagement&&this._MSAAFramebuffer){const u=this._context;o._bindUnboundFramebuffer(this._MSAAFramebuffer),u.framebufferRenderbuffer(u.FRAMEBUFFER,c,u.RENDERBUFFER,s.getMSAARenderBuffer())}o._bindUnboundFramebuffer(l)}setTexture(e,t=0,i=!0){super.setTexture(e,t,i),this._bindTextureRenderTarget(e,t)}setLayerAndFaceIndices(e,t){var r;if(super.setLayerAndFaceIndices(e,t),!this.textures||!this.layerIndices||!this.faceIndices)return;const i=((r=this._attachments)==null?void 0:r.length)??this.textures.length;for(let s=0;s<i;s++){const n=this.textures[s];n&&(n.is2DArray||n.is3D?this._bindTextureRenderTarget(n,s,this.layerIndices[s]):n.isCube?this._bindTextureRenderTarget(n,s,this.faceIndices[s]):this._bindTextureRenderTarget(n,s))}}setLayerAndFaceIndex(e=0,t,i){if(super.setLayerAndFaceIndex(e,t,i),!this.textures||!this.layerIndices||!this.faceIndices)return;const r=this.textures[e];r.is2DArray||r.is3D?this._bindTextureRenderTarget(this.textures[e],e,this.layerIndices[e]):r.isCube&&this._bindTextureRenderTarget(this.textures[e],e,this.faceIndices[e])}resolveMSAATextures(){const e=this._engine,t=e._currentFramebuffer;e._bindUnboundFramebuffer(this._MSAAFramebuffer),super.resolveMSAATextures(),e._bindUnboundFramebuffer(t)}dispose(e=this._disposeOnlyFramebuffers){const t=this._context;e||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(t.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(t.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(t.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),super.dispose(e)}}H.prototype.createDepthStencilTexture=function(a,e,t){if(e.isCube){const i=a.width||a;return this._createDepthStencilCubeTexture(i,e)}else return this._createDepthStencilTexture(a,e,t)};We.prototype._createHardwareRenderTargetWrapper=function(a,e,t){const i=new wR(a,e,t,this,this._gl);return this._renderTargetWrapperCache.push(i),i};We.prototype.createRenderTargetTexture=function(a,e){const t=this._createHardwareRenderTargetWrapper(!1,!1,a);let i=!0,r=!1,s=!1,n,o=1,l;e!==void 0&&typeof e=="object"&&(i=e.generateDepthBuffer??!0,r=!!e.generateStencilBuffer,s=!!e.noColorAttachment,n=e.colorAttachment,o=e.samples??1,l=e.label);const c=n||(s?null:this._createInternalTexture(a,e,!0,5)),h=a.width||a,f=a.height||a,u=this._currentFramebuffer,d=this._gl,_=d.createFramebuffer();if(this._bindUnboundFramebuffer(_),t._depthStencilBuffer=this._setupFramebufferDepthAttachments(r,i,h,f),c&&!c.is2DArray&&!c.is3D&&d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,c._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(u),t.label=l??"RenderTargetWrapper",t._framebuffer=_,t._generateDepthBuffer=i,t._generateStencilBuffer=r,t.setTextures(c),!n)this.updateRenderTargetTextureSampleCount(t,o);else if(t._samples=n.samples,n.samples>1){const p=n._hardwareTexture.getMSAARenderBuffer(0);t._MSAAFramebuffer=d.createFramebuffer(),this._bindUnboundFramebuffer(t._MSAAFramebuffer),d.framebufferRenderbuffer(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.RENDERBUFFER,p),this._bindUnboundFramebuffer(null)}return t};We.prototype._createDepthStencilTexture=function(a,e,t){const i=this._gl,r=a.layers||0,s=a.depth||0;let n=i.TEXTURE_2D;r!==0?n=i.TEXTURE_2D_ARRAY:s!==0&&(n=i.TEXTURE_3D);const o=new Yt(this,12);if(o.label=e.label,!this._caps.depthTextureExtension)return B.Error("Depth texture is not supported by your browser or hardware."),o;const l={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...e};if(this._bindTextureDirectly(n,o,!0),this._setupDepthStencilTexture(o,a,l.comparisonFunction===0?!1:l.bilinearFiltering,l.comparisonFunction,l.samples),l.depthTextureFormat!==void 0){if(l.depthTextureFormat!==15&&l.depthTextureFormat!==16&&l.depthTextureFormat!==17&&l.depthTextureFormat!==13&&l.depthTextureFormat!==14&&l.depthTextureFormat!==18)return B.Error(`Depth texture ${l.depthTextureFormat} format is not supported.`),o;o.format=l.depthTextureFormat}else o.format=l.generateStencil?13:16;const c=bn(o.format),h=this._getWebGLTextureTypeFromDepthTextureFormat(o.format),f=c?i.DEPTH_STENCIL:i.DEPTH_COMPONENT,u=this._getInternalFormatFromDepthTextureFormat(o.format,!0,c);return o.is2DArray?i.texImage3D(n,0,u,o.width,o.height,r,0,f,h,null):o.is3D?i.texImage3D(n,0,u,o.width,o.height,s,0,f,h,null):i.texImage2D(n,0,u,o.width,o.height,0,f,h,null),this._bindTextureDirectly(n,null),this._internalTexturesCache.push(o),t._depthStencilBuffer&&(i.deleteRenderbuffer(t._depthStencilBuffer),t._depthStencilBuffer=null),this._bindUnboundFramebuffer(t._MSAAFramebuffer??t._framebuffer),t._generateStencilBuffer=c,t._depthStencilTextureWithStencil=c,t._depthStencilBuffer=this._setupFramebufferDepthAttachments(t._generateStencilBuffer,t._generateDepthBuffer,t.width,t.height,t.samples,o.format),this._bindUnboundFramebuffer(null),o};We.prototype.updateRenderTargetTextureSampleCount=function(a,e){var s;if(this.webGLVersion<2||!a)return 1;if(a.samples===e)return e;const t=this._gl;e=Math.min(e,this.getCaps().maxMSAASamples),a._depthStencilBuffer&&(t.deleteRenderbuffer(a._depthStencilBuffer),a._depthStencilBuffer=null),a._MSAAFramebuffer&&(t.deleteFramebuffer(a._MSAAFramebuffer),a._MSAAFramebuffer=null);const i=(s=a.texture)==null?void 0:s._hardwareTexture;if(i==null||i.releaseMSAARenderBuffers(),a.texture&&e>1&&typeof t.renderbufferStorageMultisample=="function"){const n=t.createFramebuffer();if(!n)throw new Error("Unable to create multi sampled framebuffer");a._MSAAFramebuffer=n,this._bindUnboundFramebuffer(a._MSAAFramebuffer);const o=this._createRenderBuffer(a.texture.width,a.texture.height,e,-1,this._getRGBABufferInternalSizedFormat(a.texture.type,a.texture.format,a.texture._useSRGBBuffer),t.COLOR_ATTACHMENT0,!1);if(!o)throw new Error("Unable to create multi sampled framebuffer");i==null||i.addMSAARenderBuffer(o)}this._bindUnboundFramebuffer(a._MSAAFramebuffer??a._framebuffer),a.texture&&(a.texture.samples=e),a._samples=e;const r=a._depthStencilTexture?a._depthStencilTexture.format:void 0;return a._depthStencilBuffer=this._setupFramebufferDepthAttachments(a._generateStencilBuffer,a._generateDepthBuffer,a.width,a.height,e,r),this._bindUnboundFramebuffer(null),e};We.prototype._setupDepthStencilTexture=function(a,e,t,i,r=1){const s=e.width??e,n=e.height??e,o=e.layers||0,l=e.depth||0;a.baseWidth=s,a.baseHeight=n,a.width=s,a.height=n,a.is2DArray=o>0,a.depth=o||l,a.isReady=!0,a.samples=r,a.generateMipMaps=!1,a.samplingMode=t?2:1,a.type=0,a._comparisonFunction=i;const c=this._gl,h=this._getTextureTarget(a),f=this._getSamplingParameters(a.samplingMode,!1);c.texParameteri(h,c.TEXTURE_MAG_FILTER,f.mag),c.texParameteri(h,c.TEXTURE_MIN_FILTER,f.min),c.texParameteri(h,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(h,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),this.webGLVersion>1&&(i===0?(c.texParameteri(h,c.TEXTURE_COMPARE_FUNC,515),c.texParameteri(h,c.TEXTURE_COMPARE_MODE,c.NONE)):(c.texParameteri(h,c.TEXTURE_COMPARE_FUNC,i),c.texParameteri(h,c.TEXTURE_COMPARE_MODE,c.COMPARE_REF_TO_TEXTURE)))};We.prototype.setDepthStencilTexture=function(a,e,t,i){a!==void 0&&(e&&(this._boundUniforms[a]=e),!t||!t.depthStencilTexture?this._setTexture(a,null,void 0,void 0,i):this._setTexture(a,t,!1,!0,i))};We.prototype.createRenderTargetCubeTexture=function(a,e){const t=this._createHardwareRenderTargetWrapper(!1,!0,a),i={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,...e};i.generateStencilBuffer=i.generateDepthBuffer&&i.generateStencilBuffer,(i.type===1&&!this._caps.textureFloatLinearFiltering||i.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(i.samplingMode=1);const r=this._gl,s=new Yt(this,5);this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,s,!0);const n=this._getSamplingParameters(i.samplingMode,i.generateMipMaps);i.type===1&&!this._caps.textureFloat&&(i.type=0,B.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MAG_FILTER,n.mag),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MIN_FILTER,n.min),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE);for(let l=0;l<6;l++)r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,0,this._getRGBABufferInternalSizedFormat(i.type,i.format),a,a,0,this._getInternalFormat(i.format),this._getWebGLTextureType(i.type),null);const o=r.createFramebuffer();return this._bindUnboundFramebuffer(o),t._depthStencilBuffer=this._setupFramebufferDepthAttachments(i.generateStencilBuffer,i.generateDepthBuffer,a,a),i.generateMipMaps&&r.generateMipmap(r.TEXTURE_CUBE_MAP),this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),t._framebuffer=o,t._generateDepthBuffer=i.generateDepthBuffer,t._generateStencilBuffer=i.generateStencilBuffer,s.width=a,s.height=a,s.isReady=!0,s.isCube=!0,s.samples=1,s.generateMipMaps=i.generateMipMaps,s.samplingMode=i.samplingMode,s.type=i.type,s.format=i.format,this._internalTexturesCache.push(s),t.setTextures(s),t};var qh;(function(a){a[a.LOCAL=0]="LOCAL",a[a.WORLD=1]="WORLD",a[a.BONE=2]="BONE"})(qh||(qh={}));class Vi{}Vi.X=new m(1,0,0);Vi.Y=new m(0,1,0);Vi.Z=new m(0,0,1);var jh;(function(a){a[a.X=0]="X",a[a.Y=1]="Y",a[a.Z=2]="Z"})(jh||(jh={}));var Zh;(function(a){a[a.CW=0]="CW",a[a.CCW=1]="CCW"})(Zh||(Zh={}));class BR{static Interpolate(e,t,i,r,s){if(e===0)return 0;const n=1-3*r+3*t,o=3*r-6*t,l=3*t;let c=e;for(let h=0;h<5;h++){const f=c*c,u=f*c,d=n*u+o*f+l*c,_=1/(3*n*f+2*o*c+l);c-=(d-e)*_,c=Math.min(1,Math.max(0,c))}return 3*Math.pow(1-c,2)*c*i+3*(1-c)*Math.pow(c,2)*s+Math.pow(c,3)}}class hr{constructor(e){this._radians=e,this._radians<0&&(this._radians+=2*Math.PI)}degrees(){return this._radians*180/Math.PI}radians(){return this._radians}static BetweenTwoPoints(e,t){const i=t.subtract(e),r=Math.atan2(i.y,i.x);return new hr(r)}static BetweenTwoVectors(e,t){let i=e.lengthSquared()*t.lengthSquared();if(i===0)return new hr(Math.PI/2);i=Math.sqrt(i);let r=e.dot(t)/i;r=je(r,-1,1);const s=Math.acos(r);return new hr(s)}static FromRadians(e){return new hr(e)}static FromDegrees(e){return new hr(e*Math.PI/180)}}class UR{constructor(e,t,i){this.startPoint=e,this.midPoint=t,this.endPoint=i;const r=Math.pow(t.x,2)+Math.pow(t.y,2),s=(Math.pow(e.x,2)+Math.pow(e.y,2)-r)/2,n=(r-Math.pow(i.x,2)-Math.pow(i.y,2))/2,o=(e.x-t.x)*(t.y-i.y)-(t.x-i.x)*(e.y-t.y);this.centerPoint=new ne((s*(t.y-i.y)-n*(e.y-t.y))/o,((e.x-t.x)*n-(t.x-i.x)*s)/o),this.radius=this.centerPoint.subtract(this.startPoint).length(),this.startAngle=hr.BetweenTwoPoints(this.centerPoint,this.startPoint);const l=this.startAngle.degrees();let c=hr.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),h=hr.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();c-l>180&&(c-=360),c-l<-180&&(c+=360),h-c>180&&(h-=360),h-c<-180&&(h+=360),this.orientation=c-l<0?0:1,this.angle=hr.FromDegrees(this.orientation===0?l-h:h-l)}}class ka{constructor(e,t){this._points=new Array,this._length=0,this.closed=!1,this._points.push(new ne(e,t))}addLineTo(e,t){if(this.closed)return this;const i=new ne(e,t),r=this._points[this._points.length-1];return this._points.push(i),this._length+=i.subtract(r).length(),this}addArcTo(e,t,i,r,s=36){if(this.closed)return this;const n=this._points[this._points.length-1],o=new ne(e,t),l=new ne(i,r),c=new UR(n,o,l);let h=c.angle.radians()/s;c.orientation===0&&(h*=-1);let f=c.startAngle.radians()+h;for(let u=0;u<s;u++){const d=Math.cos(f)*c.radius+c.centerPoint.x,_=Math.sin(f)*c.radius+c.centerPoint.y;this.addLineTo(d,_),f+=h}return this}addQuadraticCurveTo(e,t,i,r,s=36){if(this.closed)return this;const n=(l,c,h,f)=>(1-l)*(1-l)*c+2*l*(1-l)*h+l*l*f,o=this._points[this._points.length-1];for(let l=0;l<=s;l++){const c=l/s,h=n(c,o.x,e,i),f=n(c,o.y,t,r);this.addLineTo(h,f)}return this}addBezierCurveTo(e,t,i,r,s,n,o=36){if(this.closed)return this;const l=(h,f,u,d,_)=>(1-h)*(1-h)*(1-h)*f+3*h*(1-h)*(1-h)*u+3*h*h*(1-h)*d+h*h*h*_,c=this._points[this._points.length-1];for(let h=0;h<=o;h++){const f=h/o,u=l(f,c.x,e,i,s),d=l(f,c.y,t,r,n);this.addLineTo(u,d)}return this}isPointInside(e){let t=!1;const i=this._points.length;for(let r=i-1,s=0;s<i;r=s++){let n=this._points[r],o=this._points[s],l=o.x-n.x,c=o.y-n.y;if(Math.abs(c)>Number.EPSILON){if(c<0&&(n=this._points[s],l=-l,o=this._points[r],c=-c),e.y<n.y||e.y>o.y)continue;if(e.y===n.y&&e.x===n.x)return!0;{const h=c*(e.x-n.x)-l*(e.y-n.y);if(h===0)return!0;if(h<0)continue;t=!t}}else{if(e.y!==n.y)continue;if(o.x<=e.x&&e.x<=n.x||n.x<=e.x&&e.x<=o.x)return!0}}return t}close(){return this.closed=!0,this}length(){let e=this._length;if(this.closed){const t=this._points[this._points.length-1],i=this._points[0];e+=i.subtract(t).length()}return e}area(){const e=this._points.length;let t=0;for(let i=e-1,r=0;r<e;i=r++)t+=this._points[i].x*this._points[r].y-this._points[r].x*this._points[i].y;return t*.5}getPoints(){return this._points}getPointAtLengthPosition(e){if(e<0||e>1)return ne.Zero();const t=e*this.length();let i=0;for(let r=0;r<this._points.length;r++){const s=(r+1)%this._points.length,n=this._points[r],l=this._points[s].subtract(n),c=l.length()+i;if(t>=i&&t<=c){const h=l.normalize(),f=t-i;return new ne(n.x+h.x*f,n.y+h.y*f)}i=c}return ne.Zero()}static StartingAt(e,t){return new ka(e,t)}}class xn{constructor(e,t=null,i,r=!1){this.path=e,this._curve=new Array,this._distances=new Array,this._tangents=new Array,this._normals=new Array,this._binormals=new Array,this._pointAtData={id:0,point:m.Zero(),previousPointArrayIndex:0,position:0,subPosition:0,interpolateReady:!1,interpolationMatrix:P.Identity()};for(let s=0;s<e.length;s++)this._curve[s]=e[s].clone();this._raw=i||!1,this._alignTangentsWithPath=r,this._compute(t,r)}getCurve(){return this._curve}getPoints(){return this._curve}length(){return this._distances[this._distances.length-1]}getTangents(){return this._tangents}getNormals(){return this._normals}getBinormals(){return this._binormals}getDistances(){return this._distances}getPointAt(e){return this._updatePointAtData(e).point}getTangentAt(e,t=!1){return this._updatePointAtData(e,t),t?m.TransformCoordinates(m.Forward(),this._pointAtData.interpolationMatrix):this._tangents[this._pointAtData.previousPointArrayIndex]}getNormalAt(e,t=!1){return this._updatePointAtData(e,t),t?m.TransformCoordinates(m.Right(),this._pointAtData.interpolationMatrix):this._normals[this._pointAtData.previousPointArrayIndex]}getBinormalAt(e,t=!1){return this._updatePointAtData(e,t),t?m.TransformCoordinates(m.UpReadOnly,this._pointAtData.interpolationMatrix):this._binormals[this._pointAtData.previousPointArrayIndex]}getDistanceAt(e){return this.length()*e}getPreviousPointIndexAt(e){return this._updatePointAtData(e),this._pointAtData.previousPointArrayIndex}getSubPositionAt(e){return this._updatePointAtData(e),this._pointAtData.subPosition}getClosestPositionTo(e){let t=Number.MAX_VALUE,i=0;for(let r=0;r<this._curve.length-1;r++){const s=this._curve[r+0],n=this._curve[r+1].subtract(s).normalize(),o=this._distances[r+1]-this._distances[r+0],l=Math.min(Math.max(m.Dot(n,e.subtract(s).normalize()),0)*m.Distance(s,e)/o,1),c=m.Distance(s.add(n.scale(l*o)),e);c<t&&(t=c,i=(this._distances[r+0]+o*l)/this.length())}return i}slice(e=0,t=1){if(e<0&&(e=1-e*-1%1),t<0&&(t=1-t*-1%1),e>t){const c=e;e=t,t=c}const i=this.getCurve(),r=this.getPointAt(e);let s=this.getPreviousPointIndexAt(e);const n=this.getPointAt(t),o=this.getPreviousPointIndexAt(t)+1,l=[];return e!==0&&(s++,l.push(r)),l.push(...i.slice(s,o)),(t!==1||e===1)&&l.push(n),new xn(l,this.getNormalAt(e),this._raw,this._alignTangentsWithPath)}update(e,t=null,i=!1){for(let r=0;r<e.length;r++)this._curve[r].x=e[r].x,this._curve[r].y=e[r].y,this._curve[r].z=e[r].z;return this._compute(t,i),this}_compute(e,t=!1){const i=this._curve.length;if(i<2)return;this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[i-1]=this._curve[i-1].subtract(this._curve[i-2]),this._raw||this._tangents[i-1].normalize();const r=this._tangents[0],s=this._normalVector(r,e);this._normals[0]=s,this._raw||this._normals[0].normalize(),this._binormals[0]=m.Cross(r,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;let n,o,l,c,h;for(let f=1;f<i;f++)n=this._getLastNonNullVector(f),f<i-1&&(o=this._getFirstNonNullVector(f),this._tangents[f]=t?o:n.add(o),this._tangents[f].normalize()),this._distances[f]=this._distances[f-1]+this._curve[f].subtract(this._curve[f-1]).length(),l=this._tangents[f],h=this._binormals[f-1],this._normals[f]=m.Cross(h,l),this._raw||(this._normals[f].length()===0?(c=this._normals[f-1],this._normals[f]=c.clone()):this._normals[f].normalize()),this._binormals[f]=m.Cross(l,this._normals[f]),this._raw||this._binormals[f].normalize();this._pointAtData.id=NaN}_getFirstNonNullVector(e){let t=1,i=this._curve[e+t].subtract(this._curve[e]);for(;i.length()===0&&e+t+1<this._curve.length;)t++,i=this._curve[e+t].subtract(this._curve[e]);return i}_getLastNonNullVector(e){let t=1,i=this._curve[e].subtract(this._curve[e-t]);for(;i.length()===0&&e>t+1;)t++,i=this._curve[e].subtract(this._curve[e-t]);return i}_normalVector(e,t){let i,r=e.length();if(r===0&&(r=1),t==null){let s;nt(Math.abs(e.y)/r,1,Ke)?nt(Math.abs(e.x)/r,1,Ke)?nt(Math.abs(e.z)/r,1,Ke)?s=m.Zero():s=new m(0,0,1):s=new m(1,0,0):s=new m(0,-1,0),i=m.Cross(e,s)}else i=m.Cross(e,t),m.CrossToRef(i,e,i);return i.normalize(),i}_updatePointAtData(e,t=!1){if(this._pointAtData.id===e)return this._pointAtData.interpolateReady||this._updateInterpolationMatrix(),this._pointAtData;this._pointAtData.id=e;const i=this.getPoints();if(e<=0)return this._setPointAtData(0,0,i[0],0,t);if(e>=1)return this._setPointAtData(1,1,i[i.length-1],i.length-1,t);let r=i[0],s,n=0;const o=e*this.length();for(let l=1;l<i.length;l++){s=i[l];const c=m.Distance(r,s);if(n+=c,n===o)return this._setPointAtData(e,1,s,l,t);if(n>o){const f=(n-o)/c,u=r.subtract(s),d=s.add(u.scaleInPlace(f));return this._setPointAtData(e,1-f,d,l-1,t)}r=s}return this._pointAtData}_setPointAtData(e,t,i,r,s){return this._pointAtData.point=i,this._pointAtData.position=e,this._pointAtData.subPosition=t,this._pointAtData.previousPointArrayIndex=r,this._pointAtData.interpolateReady=s,s&&this._updateInterpolationMatrix(),this._pointAtData}_updateInterpolationMatrix(){this._pointAtData.interpolationMatrix=P.Identity();const e=this._pointAtData.previousPointArrayIndex;if(e!==this._tangents.length-1){const t=e+1,i=this._tangents[e].clone(),r=this._normals[e].clone(),s=this._binormals[e].clone(),n=this._tangents[t].clone(),o=this._normals[t].clone(),l=this._binormals[t].clone(),c=z.RotationQuaternionFromAxis(r,s,i),h=z.RotationQuaternionFromAxis(o,l,n);z.Slerp(c,h,this._pointAtData.subPosition).toRotationMatrix(this._pointAtData.interpolationMatrix)}}}class br{static CreateQuadraticBezier(e,t,i,r){r=r>2?r:3;const s=[],n=(o,l,c,h)=>(1-o)*(1-o)*l+2*o*(1-o)*c+o*o*h;for(let o=0;o<=r;o++)s.push(new m(n(o/r,e.x,t.x,i.x),n(o/r,e.y,t.y,i.y),n(o/r,e.z,t.z,i.z)));return new br(s)}static CreateCubicBezier(e,t,i,r,s){s=s>3?s:4;const n=[],o=(l,c,h,f,u)=>(1-l)*(1-l)*(1-l)*c+3*l*(1-l)*(1-l)*h+3*l*l*(1-l)*f+l*l*l*u;for(let l=0;l<=s;l++)n.push(new m(o(l/s,e.x,t.x,i.x,r.x),o(l/s,e.y,t.y,i.y,r.y),o(l/s,e.z,t.z,i.z,r.z)));return new br(n)}static CreateHermiteSpline(e,t,i,r,s){const n=[],o=1/s;for(let l=0;l<=s;l++)n.push(m.Hermite(e,t,i,r,l*o));return new br(n)}static CreateCatmullRomSpline(e,t,i){const r=[],s=1/t;let n=0;if(i){const o=e.length;for(let l=0;l<o;l++){n=0;for(let c=0;c<t;c++)r.push(m.CatmullRom(e[l%o],e[(l+1)%o],e[(l+2)%o],e[(l+3)%o],n)),n+=s}r.push(r[0])}else{const o=[];o.push(e[0].clone()),Array.prototype.push.apply(o,e),o.push(e[e.length-1].clone());let l=0;for(;l<o.length-3;l++){n=0;for(let c=0;c<t;c++)r.push(m.CatmullRom(o[l],o[l+1],o[l+2],o[l+3],n)),n+=s}l--,r.push(m.CatmullRom(o[l],o[l+1],o[l+2],o[l+3],n))}return new br(r)}static ArcThru3Points(e,t,i,r=32,s=!1,n=!1){const o=[],l=t.subtract(e),c=i.subtract(t),h=e.subtract(i),f=m.Cross(l,c),u=f.length();if(u<Math.pow(10,-8))return new br(o);const d=l.lengthSquared(),_=c.lengthSquared(),p=h.lengthSquared(),g=f.lengthSquared(),E=l.length(),v=c.length(),b=h.length(),R=.5*E*v*b/u,S=m.Dot(l,h),T=m.Dot(l,c),I=m.Dot(c,h),O=-.5*_*S/g,L=-.5*p*T/g,w=-.5*d*I/g,$=e.scale(O).add(t.scale(L)).add(i.scale(w)),ce=e.subtract($).normalize(),le=m.Cross(f,ce).normalize();if(n){const oe=2*Math.PI/r;for(let ue=0;ue<=2*Math.PI;ue+=oe)o.push($.add(ce.scale(R*Math.cos(ue)).add(le.scale(R*Math.sin(ue)))));o.push(e)}else{const oe=1/r;let ue=0,Pe=m.Zero();do Pe=$.add(ce.scale(R*Math.cos(ue)).add(le.scale(R*Math.sin(ue)))),o.push(Pe),ue+=oe;while(!Pe.equalsWithEpsilon(i,R*oe*1.1));o.push(i),s&&o.push(e)}return new br(o)}constructor(e){this._length=0,this._points=e,this._length=this._computeLength(e)}getPoints(){return this._points}length(){return this._length}continue(e){const t=this._points[this._points.length-1],i=this._points.slice(),r=e.getPoints();for(let n=1;n<r.length;n++)i.push(r[n].subtract(r[0]).add(t));return new br(i)}_computeLength(e){let t=0;for(let i=1;i<e.length;i++)t+=e[i].subtract(e[i-1]).length();return t}}const lr=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],VR=[()=>1,a=>a.y,a=>a.z,a=>a.x,a=>a.x*a.y,a=>a.y*a.z,a=>3*a.z*a.z-1,a=>a.x*a.z,a=>a.x*a.x-a.y*a.y],Cr=(a,e)=>lr[a]*VR[a](e),Ir=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4];class yn{constructor(){this.preScaled=!1,this.l00=m.Zero(),this.l1_1=m.Zero(),this.l10=m.Zero(),this.l11=m.Zero(),this.l2_2=m.Zero(),this.l2_1=m.Zero(),this.l20=m.Zero(),this.l21=m.Zero(),this.l22=m.Zero()}addLight(e,t,i){F.Vector3[0].set(t.r,t.g,t.b);const r=F.Vector3[0],s=F.Vector3[1];r.scaleToRef(i,s),s.scaleToRef(Cr(0,e),F.Vector3[2]),this.l00.addInPlace(F.Vector3[2]),s.scaleToRef(Cr(1,e),F.Vector3[2]),this.l1_1.addInPlace(F.Vector3[2]),s.scaleToRef(Cr(2,e),F.Vector3[2]),this.l10.addInPlace(F.Vector3[2]),s.scaleToRef(Cr(3,e),F.Vector3[2]),this.l11.addInPlace(F.Vector3[2]),s.scaleToRef(Cr(4,e),F.Vector3[2]),this.l2_2.addInPlace(F.Vector3[2]),s.scaleToRef(Cr(5,e),F.Vector3[2]),this.l2_1.addInPlace(F.Vector3[2]),s.scaleToRef(Cr(6,e),F.Vector3[2]),this.l20.addInPlace(F.Vector3[2]),s.scaleToRef(Cr(7,e),F.Vector3[2]),this.l21.addInPlace(F.Vector3[2]),s.scaleToRef(Cr(8,e),F.Vector3[2]),this.l22.addInPlace(F.Vector3[2])}scaleInPlace(e){this.l00.scaleInPlace(e),this.l1_1.scaleInPlace(e),this.l10.scaleInPlace(e),this.l11.scaleInPlace(e),this.l2_2.scaleInPlace(e),this.l2_1.scaleInPlace(e),this.l20.scaleInPlace(e),this.l21.scaleInPlace(e),this.l22.scaleInPlace(e)}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(Ir[0]),this.l1_1.scaleInPlace(Ir[1]),this.l10.scaleInPlace(Ir[2]),this.l11.scaleInPlace(Ir[3]),this.l2_2.scaleInPlace(Ir[4]),this.l2_1.scaleInPlace(Ir[5]),this.l20.scaleInPlace(Ir[6]),this.l21.scaleInPlace(Ir[7]),this.l22.scaleInPlace(Ir[8])}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI)}preScaleForRendering(){this.preScaled=!0,this.l00.scaleInPlace(lr[0]),this.l1_1.scaleInPlace(lr[1]),this.l10.scaleInPlace(lr[2]),this.l11.scaleInPlace(lr[3]),this.l2_2.scaleInPlace(lr[4]),this.l2_1.scaleInPlace(lr[5]),this.l20.scaleInPlace(lr[6]),this.l21.scaleInPlace(lr[7]),this.l22.scaleInPlace(lr[8])}updateFromArray(e){return m.FromArrayToRef(e[0],0,this.l00),m.FromArrayToRef(e[1],0,this.l1_1),m.FromArrayToRef(e[2],0,this.l10),m.FromArrayToRef(e[3],0,this.l11),m.FromArrayToRef(e[4],0,this.l2_2),m.FromArrayToRef(e[5],0,this.l2_1),m.FromArrayToRef(e[6],0,this.l20),m.FromArrayToRef(e[7],0,this.l21),m.FromArrayToRef(e[8],0,this.l22),this}updateFromFloatsArray(e){return m.FromFloatsToRef(e[0],e[1],e[2],this.l00),m.FromFloatsToRef(e[3],e[4],e[5],this.l1_1),m.FromFloatsToRef(e[6],e[7],e[8],this.l10),m.FromFloatsToRef(e[9],e[10],e[11],this.l11),m.FromFloatsToRef(e[12],e[13],e[14],this.l2_2),m.FromFloatsToRef(e[15],e[16],e[17],this.l2_1),m.FromFloatsToRef(e[18],e[19],e[20],this.l20),m.FromFloatsToRef(e[21],e[22],e[23],this.l21),m.FromFloatsToRef(e[24],e[25],e[26],this.l22),this}static FromArray(e){return new yn().updateFromArray(e)}static FromPolynomial(e){const t=new yn;return t.l00=e.xx.scale(.376127).add(e.yy.scale(.376127)).add(e.zz.scale(.376126)),t.l1_1=e.y.scale(.977204),t.l10=e.z.scale(.977204),t.l11=e.x.scale(.977204),t.l2_2=e.xy.scale(1.16538),t.l2_1=e.yz.scale(1.16538),t.l20=e.zz.scale(1.34567).subtract(e.xx.scale(.672834)).subtract(e.yy.scale(.672834)),t.l21=e.zx.scale(1.16538),t.l22=e.xx.scale(1.16538).subtract(e.yy.scale(1.16538)),t.l1_1.scaleInPlace(-1),t.l11.scaleInPlace(-1),t.l2_1.scaleInPlace(-1),t.l21.scaleInPlace(-1),t.scaleInPlace(Math.PI),t}}class Ss{constructor(){this.x=m.Zero(),this.y=m.Zero(),this.z=m.Zero(),this.xx=m.Zero(),this.yy=m.Zero(),this.zz=m.Zero(),this.xy=m.Zero(),this.yz=m.Zero(),this.zx=m.Zero()}get preScaledHarmonics(){return this._harmonics||(this._harmonics=yn.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics}addAmbient(e){F.Vector3[0].copyFromFloats(e.r,e.g,e.b);const t=F.Vector3[0];this.xx.addInPlace(t),this.yy.addInPlace(t),this.zz.addInPlace(t)}scaleInPlace(e){this.x.scaleInPlace(e),this.y.scaleInPlace(e),this.z.scaleInPlace(e),this.xx.scaleInPlace(e),this.yy.scaleInPlace(e),this.zz.scaleInPlace(e),this.yz.scaleInPlace(e),this.zx.scaleInPlace(e),this.xy.scaleInPlace(e)}updateFromHarmonics(e){return this._harmonics=e,this.x.copyFrom(e.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.copyFrom(e.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.copyFrom(e.l10),this.z.scaleInPlace(1.02333),this.xx.copyFrom(e.l00),F.Vector3[0].copyFrom(e.l20).scaleInPlace(.247708),F.Vector3[1].copyFrom(e.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).subtractInPlace(F.Vector3[0]).addInPlace(F.Vector3[1]),this.yy.copyFrom(e.l00),this.yy.scaleInPlace(.886277).subtractInPlace(F.Vector3[0]).subtractInPlace(F.Vector3[1]),this.zz.copyFrom(e.l00),F.Vector3[0].copyFrom(e.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(F.Vector3[0]),this.yz.copyFrom(e.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.copyFrom(e.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.copyFrom(e.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(e){return new Ss().updateFromHarmonics(e)}static FromArray(e){const t=new Ss;return m.FromArrayToRef(e[0],0,t.x),m.FromArrayToRef(e[1],0,t.y),m.FromArrayToRef(e[2],0,t.z),m.FromArrayToRef(e[3],0,t.xx),m.FromArrayToRef(e[4],0,t.yy),m.FromArrayToRef(e[5],0,t.zz),m.FromArrayToRef(e[6],0,t.yz),m.FromArrayToRef(e[7],0,t.zx),m.FromArrayToRef(e[8],0,t.xy),t}}We.prototype.createPrefilteredCubeTexture=function(a,e,t,i,r=null,s=null,n,o=null,l=!0){const c=async h=>{if(!h){r&&r(null);return}const f=h.texture;if(l?h.info.sphericalPolynomial&&(f._sphericalPolynomial=h.info.sphericalPolynomial):f._sphericalPolynomial=new Ss,f._source=9,this.getCaps().textureLOD){r&&r(f);return}const u=3,d=this._gl,_=h.width;if(!_)return;const{DDSTools:p}=await X(async()=>{const{DDSTools:E}=await Promise.resolve().then(()=>uI);return{DDSTools:E}},void 0,import.meta.url),g=[];for(let E=0;E<u;E++){const b=1-E/(u-1),R=i,S=Math.log2(_)*t+i,T=R+(S-R)*b,I=Math.round(Math.min(Math.max(T,0),S)),O=new Yt(this,2);if(O.type=f.type,O.format=f.format,O.width=Math.pow(2,Math.max(Math.log2(_)-I,0)),O.height=O.width,O.isCube=!0,O._cachedWrapU=0,O._cachedWrapV=0,this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,O,!0),O.samplingMode=2,d.texParameteri(d.TEXTURE_CUBE_MAP,d.TEXTURE_MAG_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_CUBE_MAP,d.TEXTURE_MIN_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_CUBE_MAP,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_CUBE_MAP,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),h.isDDS){const w=h.info,$=h.data;this._unpackFlipY(w.isCompressed),p.UploadDDSLevels(this,O,$,w,!0,6,I)}else B.Warn("DDS is the only prefiltered cube map supported so far.");this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,null);const L=new rt(e);L._isCube=!0,L._texture=O,O.isReady=!0,g.push(L)}f._lodTextureHigh=g[2],f._lodTextureMid=g[1],f._lodTextureLow=g[0],r&&r(f)};return this.createCubeTexture(a,e,null,!1,c,s,n,o,l,t,i)};We.prototype.createUniformBuffer=function(a,e){const t=this._gl.createBuffer();if(!t)throw new Error("Unable to create uniform buffer");const i=new In(t);return this.bindUniformBuffer(i),a instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,a,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(a),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),i.references=1,i};We.prototype.createDynamicUniformBuffer=function(a,e){const t=this._gl.createBuffer();if(!t)throw new Error("Unable to create dynamic uniform buffer");const i=new In(t);return this.bindUniformBuffer(i),a instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,a,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(a),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),i.references=1,i};We.prototype.updateUniformBuffer=function(a,e,t,i){this.bindUniformBuffer(a),t===void 0&&(t=0),i===void 0?e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,e):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,new Float32Array(e)):e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,e.subarray(t,t+i)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(e).subarray(t,t+i)),this.bindUniformBuffer(null)};We.prototype.bindUniformBuffer=function(a){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,a?a.underlyingResource:null)};We.prototype.bindUniformBufferBase=function(a,e,t){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,e,a?a.underlyingResource:null)};We.prototype.bindUniformBlock=function(a,e,t){const i=a.program,r=this._gl.getUniformBlockIndex(i,e);r!==4294967295&&this._gl.uniformBlockBinding(i,r,t)};H.prototype.displayLoadingUI=function(){if(!Ht())return;const a=this.loadingScreen;a&&a.displayLoadingUI()};H.prototype.hideLoadingUI=function(){if(!Ht())return;const a=this._loadingScreen;a&&a.hideLoadingUI()};Object.defineProperty(H.prototype,"loadingScreen",{get:function(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=H.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen},set:function(a){this._loadingScreen=a},enumerable:!0,configurable:!0});Object.defineProperty(H.prototype,"loadingUIText",{set:function(a){this.loadingScreen.loadingUIText=a},enumerable:!0,configurable:!0});Object.defineProperty(H.prototype,"loadingUIBackgroundColor",{set:function(a){this.loadingScreen.loadingUIBackgroundColor=a},enumerable:!0,configurable:!0});H.prototype.getInputElement=function(){return this._renderingCanvas};H.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null};H.prototype.getInputElementClientRect=function(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null};H.prototype.getAspectRatio=function(a,e=!1){const t=a.viewport;return this.getRenderWidth(e)*t.width/(this.getRenderHeight(e)*t.height)};H.prototype.getScreenAspectRatio=function(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)};H.prototype._verifyPointerLock=function(){var a;(a=this._onPointerLockChange)==null||a.call(this)};H.prototype.setAlphaEquation=function(a){if(this._alphaEquation!==a){switch(a){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774);break}this._alphaEquation=a}};H.prototype.getInputElement=function(){return this._renderingCanvas};H.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc};H.prototype.setDepthFunction=function(a){this._depthCullingState.depthFunc=a};H.prototype.setDepthFunctionToGreater=function(){this.setDepthFunction(516)};H.prototype.setDepthFunctionToGreaterOrEqual=function(){this.setDepthFunction(518)};H.prototype.setDepthFunctionToLess=function(){this.setDepthFunction(513)};H.prototype.setDepthFunctionToLessOrEqual=function(){this.setDepthFunction(515)};H.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask};H.prototype.setDepthWrite=function(a){this._depthCullingState.depthMask=a};H.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest};H.prototype.setStencilBuffer=function(a){this._stencilState.stencilTest=a};H.prototype.getStencilMask=function(){return this._stencilState.stencilMask};H.prototype.setStencilMask=function(a){this._stencilState.stencilMask=a};H.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc};H.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef};H.prototype.getStencilFunctionMask=function(){return this._stencilState.stencilFuncMask};H.prototype.setStencilFunction=function(a){this._stencilState.stencilFunc=a};H.prototype.setStencilFunctionReference=function(a){this._stencilState.stencilFuncRef=a};H.prototype.setStencilFunctionMask=function(a){this._stencilState.stencilFuncMask=a};H.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail};H.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail};H.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass};H.prototype.setStencilOperationFail=function(a){this._stencilState.stencilOpStencilFail=a};H.prototype.setStencilOperationDepthFail=function(a){this._stencilState.stencilOpDepthFail=a};H.prototype.setStencilOperationPass=function(a){this._stencilState.stencilOpStencilDepthPass=a};H.prototype.cacheStencilState=function(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()};H.prototype.restoreStencilState=function(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)};H.prototype.setAlphaConstants=function(a,e,t,i){this._alphaState.setAlphaBlendConstants(a,e,t,i)};H.prototype.getAlphaMode=function(){return this._alphaMode};H.prototype.getAlphaEquation=function(){return this._alphaEquation};H.prototype.getRenderPassNames=function(){return this._renderPassNames};H.prototype.getCurrentRenderPassName=function(){return this._renderPassNames[this.currentRenderPassId]};H.prototype.createRenderPassId=function(a){const e=++H._RenderPassIdCounter;return this._renderPassNames[e]=a??"NONAME",e};H.prototype.releaseRenderPassId=function(a){this._renderPassNames[a]=void 0;for(let e=0;e<this.scenes.length;++e){const t=this.scenes[e];for(let i=0;i<t.meshes.length;++i){const r=t.meshes[i];if(r.subMeshes)for(let s=0;s<r.subMeshes.length;++s)r.subMeshes[s]._removeDrawWrapper(a)}}};function GR(a){!a||!a.setAttribute||(a.setAttribute("touch-action","none"),a.style.touchAction="none",a.style.webkitTapHighlightColor="transparent")}function kR(a,e,t){a._onCanvasFocus=()=>{a.onCanvasFocusObservable.notifyObservers(a)},a._onCanvasBlur=()=>{a.onCanvasBlurObservable.notifyObservers(a)},a._onCanvasContextMenu=r=>{a.disableContextMenu&&r.preventDefault()},e.addEventListener("focus",a._onCanvasFocus),e.addEventListener("blur",a._onCanvasBlur),e.addEventListener("contextmenu",a._onCanvasContextMenu),a._onBlur=()=>{a.disablePerformanceMonitorInBackground&&a.performanceMonitor.disable(),a._windowIsBackground=!0},a._onFocus=()=>{a.disablePerformanceMonitorInBackground&&a.performanceMonitor.enable(),a._windowIsBackground=!1},a._onCanvasPointerOut=r=>{document.elementFromPoint(r.clientX,r.clientY)!==e&&a.onCanvasPointerOutObservable.notifyObservers(r)};const i=a.getHostWindow();i&&typeof i.addEventListener=="function"&&(i.addEventListener("blur",a._onBlur),i.addEventListener("focus",a._onFocus)),e.addEventListener("pointerout",a._onCanvasPointerOut),t.doNotHandleTouchAction||GR(e),!H.audioEngine&&t.audioEngine&&H.AudioEngineFactory&&(H.audioEngine=H.AudioEngineFactory(a.getRenderingCanvas(),a.getAudioContext(),a.getAudioDestination())),pn()&&(a._onFullscreenChange=()=>{a.isFullscreen=!!document.fullscreenElement,a.isFullscreen&&a._pointerLockRequested&&e&&zm(e)},document.addEventListener("fullscreenchange",a._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",a._onFullscreenChange,!1),a._onPointerLockChange=()=>{a.isPointerLock=document.pointerLockElement===e},document.addEventListener("pointerlockchange",a._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",a._onPointerLockChange,!1)),a.enableOfflineSupport=H.OfflineProviderFactory!==void 0,a._deterministicLockstep=!!t.deterministicLockstep,a._lockstepMaxSteps=t.lockstepMaxSteps||0,a._timeStep=t.timeStep||1/60}function WR(a,e){Re.Instances.length===1&&H.audioEngine&&(H.audioEngine.dispose(),H.audioEngine=null);const t=a.getHostWindow();t&&typeof t.removeEventListener=="function"&&(t.removeEventListener("blur",a._onBlur),t.removeEventListener("focus",a._onFocus)),e&&(e.removeEventListener("focus",a._onCanvasFocus),e.removeEventListener("blur",a._onCanvasBlur),e.removeEventListener("pointerout",a._onCanvasPointerOut),e.removeEventListener("contextmenu",a._onCanvasContextMenu)),pn()&&(document.removeEventListener("fullscreenchange",a._onFullscreenChange),document.removeEventListener("mozfullscreenchange",a._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",a._onFullscreenChange),document.removeEventListener("msfullscreenchange",a._onFullscreenChange),document.removeEventListener("pointerlockchange",a._onPointerLockChange),document.removeEventListener("mspointerlockchange",a._onPointerLockChange),document.removeEventListener("mozpointerlockchange",a._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",a._onPointerLockChange))}function XR(a){const e=document.createElement("span");e.textContent="Hg",e.style.font=a;const t=document.createElement("div");t.style.display="inline-block",t.style.width="1px",t.style.height="0px",t.style.verticalAlign="bottom";const i=document.createElement("div");i.style.whiteSpace="nowrap",i.appendChild(e),i.appendChild(t),document.body.appendChild(i);let r=0,s=0;try{s=t.getBoundingClientRect().top-e.getBoundingClientRect().top,t.style.verticalAlign="baseline",r=t.getBoundingClientRect().top-e.getBoundingClientRect().top}finally{document.body.removeChild(i)}return{ascent:r,height:s,descent:s-r}}function HR(a,e,t){return new Promise((r,s)=>{const n=new Image;n.onload=()=>{n.decode().then(()=>{a.createImageBitmap(n,t).then(o=>{r(o)})})},n.onerror=()=>{s(`Error loading image ${n.src}`)},n.src=e})}function zR(a,e,t,i){const s=a.createCanvas(t,i).getContext("2d");if(!s)throw new Error("Unable to get 2d context for resizeImageBitmap");return s.drawImage(e,0,0),s.getImageData(0,0,t,i).data}function YR(a){const e=a.requestFullscreen||a.webkitRequestFullscreen;e&&e.call(a)}function KR(){const a=document;document.exitFullscreen?document.exitFullscreen():a.webkitCancelFullScreen&&a.webkitCancelFullScreen()}function zm(a){if(a.requestPointerLock){const e=a.requestPointerLock();e instanceof Promise?e.then(()=>{a.focus()}).catch(()=>{}):a.focus()}}function qR(){document.exitPointerLock&&document.exitPointerLock()}class he extends We{static get NpmPackage(){return H.NpmPackage}static get Version(){return H.Version}static get Instances(){return Re.Instances}static get LastCreatedEngine(){return Re.LastCreatedEngine}static get LastCreatedScene(){return Re.LastCreatedScene}static DefaultLoadingScreenFactory(e){return H.DefaultLoadingScreenFactory(e)}get _supportsHardwareTextureRescaling(){return!!he._RescalePostProcessFactory}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}get performanceMonitor(){return this._performanceMonitor}constructor(e,t,i,r=!1){super(e,t,i,r),this.customAnimationFrameRequester=null,this._performanceMonitor=new LR,this._drawCalls=new ur,e&&(this._features.supportRenderPasses=!0,i=this._creationOptions)}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(e){super._sharedInit(e),kR(this,e,this._creationOptions)}resizeImageBitmap(e,t,i){return zR(this,e,t,i)}_createImageBitmapFromSource(e,t){return HR(this,e,t)}switchFullscreen(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e)}enterFullscreen(e){this.isFullscreen||(this._pointerLockRequested=e,this._renderingCanvas&&YR(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&KR()}setDitheringState(e){e?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(e){e?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}setDirectViewport(e,t,i,r){const s=this._cachedViewport;return this._cachedViewport=null,this._viewport(e,t,i,r),s}scissorClear(e,t,i,r,s){this.enableScissor(e,t,i,r),this.clear(s,!0,!0,!0),this.disableScissor()}enableScissor(e,t,i,r){const s=this._gl;s.enable(s.SCISSOR_TEST),s.scissor(e,t,i,r)}disableScissor(){const e=this._gl;e.disable(e.SCISSOR_TEST)}_loadFileAsync(e,t,i){return new Promise((r,s)=>{this._loadFile(e,n=>{r(n)},void 0,t,i,(n,o)=>{s(o)})})}getVertexShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[0]):null}getFragmentShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[1]):null}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e,this._framebufferDimensionsObject&&this.onResizeObservable.notifyObservers(this)}_rebuildBuffers(){for(const e of this.scenes)e.resetCachedMaterial(),e._rebuildGeometries();for(const e of this._virtualScenes)e.resetCachedMaterial(),e._rebuildGeometries();super._rebuildBuffers()}getFontOffset(e){return XR(e)}_cancelFrame(){if(this.customAnimationFrameRequester){if(this._frameHandler!==0){this._frameHandler=0;const{cancelAnimationFrame:e}=this.customAnimationFrameRequester;e&&e(this.customAnimationFrameRequester.requestID)}}else super._cancelFrame()}_renderLoop(e){this._processFrame(e),this._activeRenderLoops.length>0&&this._frameHandler===0&&(this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.requestID):this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()))}enterPointerlock(){this._renderingCanvas&&zm(this._renderingCanvas)}exitPointerlock(){qR()}beginFrame(){this._measureFps(),super.beginFrame()}_deletePipelineContext(e){const t=e;t&&t.program&&t.transformFeedback&&(this.deleteTransformFeedback(t.transformFeedback),t.transformFeedback=null),super._deletePipelineContext(e)}createShaderProgram(e,t,i,r,s,n=null){s=s||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);const o=super.createShaderProgram(e,t,i,r,s,n);return this.onAfterShaderCompilationObservable.notifyObservers(this),o}_createShaderProgram(e,t,i,r,s=null){const n=r.createProgram();if(e.program=n,!n)throw new Error("Unable to create program");if(r.attachShader(n,t),r.attachShader(n,i),this.webGLVersion>1&&s){const o=this.createTransformFeedback();this.bindTransformFeedback(o),this.setTranformFeedbackVaryings(n,s),e.transformFeedback=o}return r.linkProgram(n),this.webGLVersion>1&&s&&this.bindTransformFeedback(null),e.context=r,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||this._finalizePipelineContext(e),n}_releaseTexture(e){super._releaseTexture(e)}_releaseRenderTargetWrapper(e){super._releaseRenderTargetWrapper(e),this.scenes.forEach(t=>{t.postProcesses.forEach(i=>{i._outputTexture===e&&(i._outputTexture=null)}),t.cameras.forEach(i=>{i._postProcesses.forEach(r=>{r&&r._outputTexture===e&&(r._outputTexture=null)})})})}_rescaleTexture(e,t,i,r,s){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);const n=this.createRenderTargetTexture({width:t.width,height:t.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});if(!this._rescalePostProcess&&he._RescalePostProcessFactory&&(this._rescalePostProcess=he._RescalePostProcessFactory(this)),this._rescalePostProcess){this._rescalePostProcess.externalTextureSamplerBinding=!0;const o=()=>{this._rescalePostProcess.onApply=function(h){h._bindTexture("textureSampler",e)};let c=i;c||(c=this.scenes[this.scenes.length-1]),c.postProcessManager.directRender([this._rescalePostProcess],n,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,r,0,0,t.width,t.height,0),this.unBindFramebuffer(n),n.dispose(),s&&s()},l=this._rescalePostProcess.getEffect();l?l.executeWhenCompiled(o):this._rescalePostProcess.onEffectCreatedObservable.addOnce(c=>{c.executeWhenCompiled(o)})}}wrapWebGLTexture(e,t=!1,i=3,r=0,s=0){const n=new wc(e,this._gl),o=new Yt(this,0,!0);return o._hardwareTexture=n,o.baseWidth=r,o.baseHeight=s,o.width=r,o.height=s,o.isReady=!0,o.useMipMaps=t,this.updateTextureSamplingMode(i,o),o}_uploadImageToTexture(e,t,i=0,r=0){const s=this._gl,n=this._getWebGLTextureType(e.type),o=this._getInternalFormat(e.format),l=this._getRGBABufferInternalSizedFormat(e.type,o),c=e.isCube?s.TEXTURE_CUBE_MAP:s.TEXTURE_2D;this._bindTextureDirectly(c,e,!0),this._unpackFlipY(e.invertY);let h=s.TEXTURE_2D;e.isCube&&(h=s.TEXTURE_CUBE_MAP_POSITIVE_X+i),s.texImage2D(h,r,l,o,n,t),this._bindTextureDirectly(c,null,!0)}updateTextureComparisonFunction(e,t){if(this.webGLVersion===1){B.Error("WebGL 1 does not support texture comparison.");return}const i=this._gl;e.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,e,!0),t===0?(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),t===0?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),e._comparisonFunction=t}createInstancesBuffer(e){const t=this._gl.createBuffer();if(!t)throw new Error("Unable to create instance buffer");const i=new In(t);return i.capacity=e,this.bindArrayBuffer(i),this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW),i.references=1,i}deleteInstancesBuffer(e){this._gl.deleteBuffer(e)}_clientWaitAsync(e,t=0,i=10){const r=this._gl;return new Promise((s,n)=>{va(()=>{const o=r.clientWaitSync(e,t,0);if(o==r.WAIT_FAILED)throw new Error("clientWaitSync failed");return o!=r.TIMEOUT_EXPIRED},s,n,i)})}_readPixelsAsync(e,t,i,r,s,n,o){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");const l=this._gl,c=l.createBuffer();l.bindBuffer(l.PIXEL_PACK_BUFFER,c),l.bufferData(l.PIXEL_PACK_BUFFER,o.byteLength,l.STREAM_READ),l.readPixels(e,t,i,r,s,n,0),l.bindBuffer(l.PIXEL_PACK_BUFFER,null);const h=l.fenceSync(l.SYNC_GPU_COMMANDS_COMPLETE,0);return h?(l.flush(),this._clientWaitAsync(h,0,10).then(()=>(l.deleteSync(h),l.bindBuffer(l.PIXEL_PACK_BUFFER,c),l.getBufferSubData(l.PIXEL_PACK_BUFFER,0,o),l.bindBuffer(l.PIXEL_PACK_BUFFER,null),l.deleteBuffer(c),o))):null}dispose(){this.hideLoadingUI(),this._rescalePostProcess&&this._rescalePostProcess.dispose(),WR(this,this._renderingCanvas),super.dispose()}}he.ALPHA_DISABLE=0;he.ALPHA_ADD=1;he.ALPHA_COMBINE=2;he.ALPHA_SUBTRACT=3;he.ALPHA_MULTIPLY=4;he.ALPHA_MAXIMIZED=5;he.ALPHA_ONEONE=6;he.ALPHA_PREMULTIPLIED=7;he.ALPHA_PREMULTIPLIED_PORTERDUFF=8;he.ALPHA_INTERPOLATE=9;he.ALPHA_SCREENMODE=10;he.DELAYLOADSTATE_NONE=0;he.DELAYLOADSTATE_LOADED=1;he.DELAYLOADSTATE_LOADING=2;he.DELAYLOADSTATE_NOTLOADED=4;he.NEVER=512;he.ALWAYS=519;he.LESS=513;he.EQUAL=514;he.LEQUAL=515;he.GREATER=516;he.GEQUAL=518;he.NOTEQUAL=517;he.KEEP=7680;he.REPLACE=7681;he.INCR=7682;he.DECR=7683;he.INVERT=5386;he.INCR_WRAP=34055;he.DECR_WRAP=34056;he.TEXTURE_CLAMP_ADDRESSMODE=0;he.TEXTURE_WRAP_ADDRESSMODE=1;he.TEXTURE_MIRROR_ADDRESSMODE=2;he.TEXTUREFORMAT_ALPHA=0;he.TEXTUREFORMAT_LUMINANCE=1;he.TEXTUREFORMAT_LUMINANCE_ALPHA=2;he.TEXTUREFORMAT_RGB=4;he.TEXTUREFORMAT_RGBA=5;he.TEXTUREFORMAT_RED=6;he.TEXTUREFORMAT_R=6;he.TEXTUREFORMAT_R16_UNORM=33322;he.TEXTUREFORMAT_RG16_UNORM=33324;he.TEXTUREFORMAT_RGB16_UNORM=32852;he.TEXTUREFORMAT_RGBA16_UNORM=32859;he.TEXTUREFORMAT_R16_SNORM=36760;he.TEXTUREFORMAT_RG16_SNORM=36761;he.TEXTUREFORMAT_RGB16_SNORM=36762;he.TEXTUREFORMAT_RGBA16_SNORM=36763;he.TEXTUREFORMAT_RG=7;he.TEXTUREFORMAT_RED_INTEGER=8;he.TEXTUREFORMAT_R_INTEGER=8;he.TEXTUREFORMAT_RG_INTEGER=9;he.TEXTUREFORMAT_RGB_INTEGER=10;he.TEXTUREFORMAT_RGBA_INTEGER=11;he.TEXTURETYPE_UNSIGNED_BYTE=0;he.TEXTURETYPE_UNSIGNED_INT=0;he.TEXTURETYPE_FLOAT=1;he.TEXTURETYPE_HALF_FLOAT=2;he.TEXTURETYPE_BYTE=3;he.TEXTURETYPE_SHORT=4;he.TEXTURETYPE_UNSIGNED_SHORT=5;he.TEXTURETYPE_INT=6;he.TEXTURETYPE_UNSIGNED_INTEGER=7;he.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8;he.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9;he.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10;he.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11;he.TEXTURETYPE_UNSIGNED_INT_24_8=12;he.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13;he.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14;he.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15;he.TEXTURE_NEAREST_SAMPLINGMODE=1;he.TEXTURE_BILINEAR_SAMPLINGMODE=2;he.TEXTURE_TRILINEAR_SAMPLINGMODE=3;he.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8;he.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11;he.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3;he.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4;he.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5;he.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6;he.TEXTURE_NEAREST_LINEAR=7;he.TEXTURE_NEAREST_NEAREST=1;he.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9;he.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10;he.TEXTURE_LINEAR_LINEAR=2;he.TEXTURE_LINEAR_NEAREST=12;he.TEXTURE_EXPLICIT_MODE=0;he.TEXTURE_SPHERICAL_MODE=1;he.TEXTURE_PLANAR_MODE=2;he.TEXTURE_CUBIC_MODE=3;he.TEXTURE_PROJECTION_MODE=4;he.TEXTURE_SKYBOX_MODE=5;he.TEXTURE_INVCUBIC_MODE=6;he.TEXTURE_EQUIRECTANGULAR_MODE=7;he.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8;he.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;he.SCALEMODE_FLOOR=1;he.SCALEMODE_NEAREST=2;he.SCALEMODE_CEILING=3;class $s extends ni{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([X(()=>Promise.resolve().then(()=>KM),void 0,import.meta.url)]))):t.push(Promise.all([X(()=>Promise.resolve().then(()=>wE),void 0,import.meta.url)])),super._gatherImports(e,t)}constructor(e,t=null,i){super({...i,name:e,engine:t||he.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:$s.FragmentUrl})}}$s.FragmentUrl="pass";class Wa extends ni{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([X(()=>Promise.resolve().then(()=>ZM),void 0,import.meta.url)]))):t.push(Promise.all([X(()=>Promise.resolve().then(()=>$M),void 0,import.meta.url)])),super._gatherImports(e,t)}constructor(e,t=null,i){super({...i,name:e,engine:t||he.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Wa.FragmentUrl,defines:"#define POSITIVEX"}),this._face=0}get face(){return this._face}set face(e){if(!(e<0||e>5))switch(this._face=e,this._face){case 0:this.updateEffect("#define POSITIVEX");break;case 1:this.updateEffect("#define NEGATIVEX");break;case 2:this.updateEffect("#define POSITIVEY");break;case 3:this.updateEffect("#define NEGATIVEY");break;case 4:this.updateEffect("#define POSITIVEZ");break;case 5:this.updateEffect("#define NEGATIVEZ");break}}}Wa.FragmentUrl="passCube";class Xa extends At{getClassName(){return"PassPostProcess"}constructor(e,t,i=null,r,s,n,o=0,l=!1){const c={size:typeof t=="number"?t:void 0,camera:i,samplingMode:r,engine:s,reusable:n,textureType:o,blockCompilation:l,...t};super(e,$s.FragmentUrl,{effectWrapper:typeof t=="number"||!t.effectWrapper?new $s(e,s,c):void 0,...c})}static _Parse(e,t,i,r){return ye.Parse(()=>new Xa(e.name,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable),e,i,r)}}Y("BABYLON.PassPostProcess",Xa);class Bc extends At{get face(){return this._effectWrapper.face}set face(e){this._effectWrapper.face=e}getClassName(){return"PassCubePostProcess"}constructor(e,t,i=null,r,s,n,o=0,l=!1){const c={size:typeof t=="number"?t:void 0,camera:i,samplingMode:r,engine:s,reusable:n,textureType:o,blockCompilation:l,...t};super(e,$s.FragmentUrl,{effectWrapper:typeof t=="number"||!t.effectWrapper?new Wa(e,s,c):void 0,...c})}static _Parse(e,t,i,r){return ye.Parse(()=>new Bc(e.name,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable),e,i,r)}}A([y()],Bc.prototype,"face",null);H._RescalePostProcessFactory=a=>new Xa("rescale",1,null,2,a,!1,0);function jR(a,e,t,i,r,s,n,o){const l=e.getEngine();return e.isReady=!1,r=r??e.samplingMode,i=i??e.type,s=s??e.format,n=n??e.width,o=o??e.height,i===-1&&(i=0),new Promise(c=>{const h=new At("postprocess",a,null,null,1,null,r,l,!1,void 0,i,void 0,null,!1,s);h.externalTextureSamplerBinding=!0;const f=l.createRenderTargetTexture({width:n,height:o},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:r,type:i,format:s});h.onEffectCreatedObservable.addOnce(u=>{u.executeWhenCompiled(()=>{h.onApply=d=>{d._bindTexture("textureSampler",e),d.setFloat2("scale",1,1)},t.postProcessManager.directRender([h],f,!0),l.restoreDefaultFramebuffer(),l._releaseTexture(e),h&&h.dispose(),f._swapAndDie(e),e.type=i,e.format=5,e.isReady=!0,c(e)})})})}let na,Qh;function Ds(a){na||(na=new Float32Array(1),Qh=new Int32Array(na.buffer)),na[0]=a;const e=Qh[0];let t=e>>16&32768,i=e>>12&2047;const r=e>>23&255;return r<103?t:r>142?(t|=31744,t|=(r==255?0:1)&&e&8388607,t):r<113?(i|=2048,t|=(i>>114-r)+(i>>113-r&1),t):(t|=r-112<<10|i>>1,t+=i&1,t)}function Xr(a){const e=(a&32768)>>15,t=(a&31744)>>10,i=a&1023;return t===0?(e?-1:1)*Math.pow(2,-14)*(i/Math.pow(2,10)):t==31?i?NaN:(e?-1:1)*(1/0):(e?-1:1)*Math.pow(2,t-15)*(1+i/Math.pow(2,10))}class $h{static ExpandRGBDTexture(e){const t=e._texture;if(!t||!e.isRGBD)return;const i=t.getEngine(),r=i.getCaps(),s=t.isReady;let n=!1;r.textureHalfFloatRender&&r.textureHalfFloatLinearFiltering?(n=!0,t.type=2):r.textureFloatRender&&r.textureFloatLinearFiltering&&(n=!0,t.type=1),n&&(t.isReady=!1,t._isRGBD=!1,t.invertY=!1);const o=async()=>{const l=i.isWebGPU,c=l?1:0;t.isReady=!1,l?await X(()=>Promise.resolve().then(()=>GE),void 0,import.meta.url):await X(()=>Promise.resolve().then(()=>WE),void 0,import.meta.url);const h=new At("rgbdDecode","rgbdDecode",null,null,1,null,3,i,!1,void 0,t.type,void 0,null,!1,void 0,c);h.externalTextureSamplerBinding=!0;const f=i.createRenderTargetTexture(t.width,{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:t.samplingMode,type:t.type,format:5});h.onEffectCreatedObservable.addOnce(u=>{u.executeWhenCompiled(()=>{h.onApply=d=>{d._bindTexture("textureSampler",t),d.setFloat2("scale",1,1)},e.getScene().postProcessManager.directRender([h],f,!0),i.restoreDefaultFramebuffer(),i._releaseTexture(t),h&&h.dispose(),f._swapAndDie(t),t.isReady=!0})})};n&&(s?o():e.onLoadObservable.addOnce(o))}static async EncodeTextureToRGBD(e,t,i=0){return t.getEngine().isWebGPU?await X(()=>Promise.resolve().then(()=>sP),void 0,import.meta.url):await X(()=>Promise.resolve().then(()=>iP),void 0,import.meta.url),jR("rgbdEncode",e,t,i,1,5)}}const ZR="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAgAElEQVR42u29yY5tWXIlZnbuiSaTbZFUkZRKrCKhElASQA0EoQABgn6hJvoXzfUP+gP9hWb6Bg00IgRoQJaKqUxmZmTEe8/v0uB2u7Fm2T7HIyIrnz88uPvt3f2a2WrMbOvf/u3PvvzP/sUf/N6//i8vf/lv/3v5H//d//Sb//Uq/5u8yf8hV/m/5Cp/L1f5hVzlG7nKJ7mKyJuIXN/hPwqXI/g++zq6rPI5u8z+WqfLre+zy7PrVv9L8brsMiGvk8XLmM/sdfHXal4e3ad6GXPdyu2ij8u/+uv/5cuf/OSLfdtEfvUr+dnf/d0X//t3H/7bf/hP//N/928h/0Yg/4VA/kogfyGQP5Wr/IFAvhbIlwK5CGQTPP+9z5uPeePJSW+yo2+s/GtN30Rnv1E+f5zxof9R/lSXv/nr//mrr3+i+5dfyX7ZZQP07Tffys//8R/l/9TtX7790T/7r/8G8pdy+/8XAvnnAvkzgfwzgfyxQP5AIL8vkJ8K5KsmMVzu1U7p5PA5AXxOAJ8TwPf7sX/51ZeXfcemqnp9w/W77/S7X/6T/vzf/7383RWCX3/z05/9i3/13/0PX//eX/2FyP8tIv+PiPy9iPy/IvIzEfm5iPxCRH4lIt/c/393//9BRD6KyKf7f488fP74/PH544dJAF9cLl98IZfLBZtuqterXr/7Dt9982v95S9+Lv+gF/3i7Spv/8lf/vnf/vGf/dF/JfKnIvLnIvLvReQ/NEngn0TklyLy6/v/34jIt00iGJOBlxAsdvv54/PH5493SQCXy9t2ueh2ueimKorrFbjq9eNH+fDtb+TXv/ol/vHyhX4Fxfbx7euPf/Lnf/PfiPyeiPyhiPxxkwB+fk8AvxzQgJcIrGTwFsiAEXH4/PH54/PHUgLY7whgu2C7bLqpQgHB2xvePn6SDx8+6G9+84384vKF/IPu8iVU9Y/+7C/+jWxffiHytYj8VER+X0T+oEEBvxqQwCMJeIngo5EI3goIwVMIPn98/vj8ESaAbbtu2ybbvl8u2ybbdtluSECA65u8ffqIDx8+6G++/VZ/efkV/sO261dQXP7wT/7kX8vl8qXIFyLylbySwe/dE0CLAr65B/9vGn0gQwRMMqgmhM/J4fPH548eAezbZd/lsm3YtssNAYiqiogAAkCvb5/k46cP8u2HD/rrb7+R/2/b9Wu9yJe//8d/9Ney6S5yEZFdRL68/38khG/uKOCnAwoYkcCoEXwkEgGDDq7CeQfyOTl8/vhd1QCum26ybZtu2yabbrKpQvXue1yvuF6v+vbpTT5+/CDffviAX1++1V9sO77WXb/66R/+4V/dgkbllQi+aBLBV/dE8LWRALwkYCWCNyMZXElkwLTMeMkga/P4/PH547ccAVwuctkvdxSw6bbdtYDbTfSZBN7e8PHTR/3u4wf55vKd/nL7DX6mu3791U9//5+/gkNFZGuSgZUQvnKowKgLWLTAQgRtEniTuEfwaELw0MJvf3LQzynud+53uG+X6y3gN9kul+2y6XVT1U27JCDAFVc8ksAn/e7jR/nN5YP+avtWfq6Xy9f7Vz/9w1dgRYngiyYhfNkkgzYBWHTg44AEMmqQUYQKOmDaiCIa8TmsfmzB+DnZDQjgcpGLbti2y3bZHjRAdRMVvb/dcYU8kcDbPQlsH/CrbddfbF98+RPZfvLFnAQeieCRDC5DMvju/vmD4JkEvjRQgKULeGggowdHkAHTYxihg89vu88I5UeGAPSOAFTlrgPopiqbKPSmCKreUoAAkCcSePukHz590m8vH+WbD9/JP335k6/+tA86KxFchv8jMvhiogE4JQm8XhfKqOAqx5qRPyeGzx8/cgSwbXcUoLJtim27C4Oi93+4v6VxQwKAvl2v+Hj9pB8+fZJvt4/yzfbF9lPdv/wJnsE2BogmyeCRED40tGFvksIXiSbgiYSRRpDNDZ6BDI6ghM+J4fPHeyKAO+zX7cb9t4tedMMNAQju5V+f1uAtBSiu1zsduMrHy5t8ePsk3376KN98sX/xE5FPAnm7/782o0DiUINXMkCXCB7/P94/e87AWUmARQWVvgMuKej9t1RLBp+Tw+ePgwngsutFFdu26WXbbl+rSvdfbnqAiuA23QcBgCugV1zl7e1NPm5v+LC96XfbJ/1W9y++fgXjA3bDYXV+MuhRwSPwL3JLMFYC+HS/LU8HYrGwIhwyNOF12SvgM4SgztdifP85MXz+KGsA2C6X7aJ6bXSAOwrY5OYIqGy3d5uq4P5GhABXuV6veLvRAf10fZMPb2/y3b7vX7+g+9v98/WOBq7GG7RNAlYy+Dgkhhb+Xxp0sE8IAC4SGAP/TbgVJK/PoJPBnAiwPKxsXfbbnRg+i3s/JAK4Q/4b9NfLtomBAqCickMBjy7BuywAUVyv8na94tMjCVzf9KNcLl/0SeA6oAEYb1i9g+FtSALb/bKL8/+t+wxXFMyswqiHoK4ToIgKqslgpg1qUC0QoYbvJZg/B/q5v4szHmPX7YEAsD0CX25OwEUVm9xag1+agKg+nxQArnKjAtDr9U0+Xd/k4/UqH7bL5YsewrcBBiMJZPRAp6TwQgWfjM9vgRbgUYGL8AvLWH2gqhesCokeUmCSwPsnhs8fP2YNYMO2XeSmAWxy2VQaXeDmDIhApf33rD4PTUCuV+DtCn27XuXT5ir8VmCJ2G5BpBM8/r/dEcJb8/0lEQMtJHA5TAlqNuLRhJChhEpSqFabH3di+G1AGj+W1/dyAR4IYJNNnuLf6+tWC9CHHiAtFhAIFLjK2/Uqn65X+SS67aK+3QeTDoy/IG2ogQ7fb/dAtz5vBgrYGqrwNtCHsVfgIvwK07OTQBURVNCBFpKCOjqCHn5L/67TgTN+fpySAC56nwSUi256kXsSuFGAVyLoUIDo8/Pz7fdoErr/v17lk162HbgHvFpIYDfoAJJfW4sGPjkU4VNAF8ZEcLmLhdc7kljdY1y1Dq9yLiI4IiRqcLujb138KIPn80ejATwRwIbtBvn1cqv+2J78/5EI5N4cJA8qIPcmwRsKAHDF9WYP6mV7VmrgLuTpxYTcMEW0LAmoQxFsuvAI8tv/a/C5fV2ZMMiKg++FCM7RDPRu8ebWY7VG6VJi+Bzk35MI2LsAckMAgwvQ0gC5DQjd3ABg2HQLAPpEAlZ1Bu7VV7MGHDFRAbo3VKsTbAY9sPWC/uvx86gBbDK3D1eEQS8pbAeSgSwmhepnJb6uBv/o/PzHLzxWA/X7TH77De5j6AGQi6o0CUGfCOD2X7cXAlCFQABtEsGLDtxuOyQB2UTQBKZe5GUPXgkUYCUAbZJRhBDeuq8xBf+bgwbehDm+BFQi2IJksOocvA8ysIMfxluVcRsY/eB3JzH8GFDAXQO48X/dcIf9jyDHptIigDsFkEe066tBSETQUYF7ElDdYEBytN4+rk9UcBPfrKaZqFHWcw3i4J8/X4ev2//bSXqAhwTay6OEIPLD2Ipt8OtAGzxkwLw9WVFRjTc/qC6H3+YK/b1oAA0KuOizHfieCLaHHiAb5NYTIC9EMEbZrVEQt1xwhVy1UfBh8PUOquMizwaap3tQXfY5B//tea/NZdfhsvbz+PURQTDSGWB87VX/7WSd4KxjUqrIgE0IUkoKGnhIvwvawpGf6eECXJ7tv4qbA7DJgwpsKthEmmYgfaAAffYF3HLxo0vwNjJ0SwRWMG4db4eh1gPNm18vQ+us/0eGmxDemu/fnM/X4evq/8342ksGHgLY5LyT/zg0wM8lcMjgGFXwqIOVFJBQw99eCvF9oZL9Mfl3QwAvIXDsBRC9R+fz8x0FPBLB0xJEpwUobrfAkARgIAF41h3wQgP6QAmX5E/7eI43IxGwwf/moIkRyWRJQIPgt9CA9b39nzt4bYUWjAlCjWDPgv8IEjgLJfzuaAsrv9VdVG4OwOXW/fdoA35qAdL0BDwvf6AAUVHd8LIEu94A3K+Q+2YxaB84MOH62P//qoo38fCRDERE2zf0JfmDa+MieElAjcDPKz+mRKCOtdgGtXaBjgNJ4H2owSpNeAW/rRH4CaHSpMwnBYYycjgSJwfie9CR6mPu20Uv8kABF206AvXlBMiIBPSlB9wjBW1fwEuSb94296VCqgMaGCt/G1BbExi3IG+r3a3J6P48Gv/J0YmEYoiGY7V/SxwFCwGoE/xa0AJ0CEiV9QPCJb1OJ5F1VTjEY2/MO9AEJvj1BJTQpqLfTlGwjABuzT962e4IoKnyrdh3+/6mzDVJ4PHOxj0JqGKoy20+wBMN6D1gLWi9NQHfVP5MEEPzjGYy8BMAOnTAJgEr8HUIejRo5xrA5xkR5AngmiSHs+zDDAmMgWzTg55GSJEmHE8IvWPAoYTfhWak/Wn/bQ0CGLSAjv83SUEfKp5q24LXuQICpzrjrgWoza8xVE00CQCORdhMJuTUT/rjuls0gO4Iby8BIEgK6gS7BsGuTtDrScH/fR68biUHNVGBnxjeNyHEvQe/ve3LZQqgG3rof6cEclsNflG9J4KtaQ8WHcVBHS1BtHE4QP9OBMS98mpbKTeDW7dJwRsnHpMBTFJpV4I+b0kY/NqInVFSyBLANbnMSgBM8F+Fqfxq/h657/Up+GaBnwV9hRqc9bZ/vA6vu+T9E8KPJWns94UfTeCj2QXwCHS9dNL8Xf3Ho/rfewSeFODGDV69AU0y6NFAE1DP3qK++rdB7/1HRxf86gT376zOr99T/h/ioBiXWQkgQgVeIrCC/WomhDmQK+hASI2ARQZKooHMLdCJwGEBBXC3+uERwg+VOHZ9ioAt9H80AI06wGgJ3nQA3BoCut6AhxYwgcPOFnxuFnrphk+NIKIGrWPQtgz3b0i7Y6D5rs1GKqTop0nQX52vmQC4BkjA+r4a7Kx9WLENGeegkhSETBCrNXIMdi/444Rw1n6E96ry7OPuj8UfLxtQ78NA2iSBbg7gIiIbdDLsb5agPhLC3RkYKv8NDbS2YGsatNRAG2oQwf9ZIOydgy1MAzBkAw8UwEEIDzSAqdPQ6za0PkeJAMH3Z0wXniUSZoHvBXU2mcjQgv56TedIKglCpIoQfgwCIjOytd8WgN0bfxoR8Fn9Gx0Aj5Zgq0lIZbsH/ibSJoFnS+C98g9ooHEELI3gliy25yONIiE6pb0NfBlyNEYyENoodkKwgl6I6s8kARgJ4ZoEfuYWHLEJa0LhSBXm7kImGeSfVdoJ1DO2G7WXsehAptupSOoyrCSF904k+6vt98X/ZcM98Hsd4JYIXhQAIg3/f9AAUYhsLQKAtkHVBnzjCKhOoYl2ym+iBtvzDzQ2DLXJ4PUmbJHAVnBQX4jkxfvHhNDqAdHXGQJgv0aSDGItgOseHIU+K9hXnIJzkoGlEKzNHagTdJ6VWEUH4iCKH4fd2AwDPaYBm4Wgng4gQ9V/CoGiuNmD04AQtNGMGzSAAQ2I2pzfogY9LRh7BrbOh4+D30sAencljFu2CUFrwY8UAWRfWwGvVOVfbx2uIILM0pwDv082dUTw8hYs8L+uIWiHGpWgClnAa1lMPJogovvvbePPs/q3Xr++kgCsfgB5oQF9WYKPJqEn6G+OE3i5AqouF59FQOmahQC8rlPLj38kg1c2f30vw+XaoIX24/pMGIgSBoZqoH3wo0sIIGlA9PWcCPrAtpPB8eBf6x1o6cHra+2+tpIFP4PgBfxZtZUJfo4qxELT948D9ucK8Mt9+ccjIQw6QJcEbrD/1g340ATuDgDkFfx6twSf1f9xvuBECYxq/7ythQQGm+5JDx6Brw4CkMGT3wgscCUoQ4sU2t6DR2ciBjTgtcpenQoZVX9NuL4Owc+dVaDursYVkVALX+shjSBKBuvCYDUZjE5BdNkxdHAUBexyHwB6NP7Iyw7sxUDViwge1t+mz8B/LAvVx/c3PeBBCToB8IUGOgqA3iV4yUg6UAOxaUFHDx6CYS8SorMOue0CCJGAf5YfRhoAI+A1CvwxqNkAY5yAIx2EQmkFfeWOXi+nEdSQQA0ZHMEItiagJArQxDXIrj8nCfQi4HZPAttrIahso9oPQ/2/JwV5JQU8zw+7I4D7/sBn4EO6rjw0FR+i3Z9fHtahzsFvJgM0X+tmVH5vaYiNDGAigewAz+gyNLThnjCURQFR1b9d3lZvnVqmj9mEPDKIUIC4KCCjBXywS4N+otp/Hk3QVthOkwEKlV9PQwXjT7s/zwF4Qf9toAAzFdjuaEB6S7D1//U5FIQu2MevO0rQQH8ZmoXE6B/IkgE60XCjVoq8gt2iCG0S8L5GdxkM1cGsfsCMArSCAnrr7dzAZxCEEpepvB8tqHJ/q+bmJGGts/AcAXFOMMeTwC7Pw0B6CtCtA2vWgonqBQJFSwH0JQK29OB2kvgj2HHXAoyeAIsCQO0kMNECAhFMqCBf8mElAkyBbX1tJQP2RJ/ha0gpAfS9l+/5n00CkrQpq0MZbOdAuxmMvHswog62jZj7BnYQe19b14kxNq2D/ehX/p68HEcF+x3yP7z/V/A/q/5DA3i5A/dzA5pdgbKp3v3/wQF4Bb70WkCTHGRAA6+KL0bFl6FJaFw0ImZwm6igSwbbwPn9RMBWf3sN2JgA/BVh/Rg0kQBgePf6HglAHLFQwqQQOwDjbdVxNZjR4iM6Qa3WxwvNxh0JFb3g/WzFQQS8b/ttKcDWoABtUMAd8j9hf0MB2uDXhzX4CHj03L9DBU3Qjz0C0l4mLSLQPicOOwZoVCB6P6dA7nDbGkVuxcNr8PU2JQO4wX5trEqmccZaHU4q8oCDFOpzAnOwqyMIMktNNNAHouDGxO37DgArQZzlmp/14W1QlqHTMaIIx7SCx0+5yza7AKJ3IXBrNAHVDcMZAU/BT/vgv/ULPOA+XiLggAREDF2g0ci6xNDRglegd7P7TWWH5oJfayliEg7bScQRBVgI4Ookg/F6rvpLWP29swREqA3CaG8/FpKqS8DTAV4TiBqIqtxfzaQRLys5I0XEFIFrPbZRQb+16Fgi2LvJv8EFUPW1gGfQv1T/F/d/HBnccP7rAwnIIyHI4ArgWeGbU4eHy6Tx/EeTZIb5bo/BsMBjmjBE08f/RB0PHYBd9eVRAGY7cHRwiBf8WeCPHY1bgBTa9xKTELzEkQX9CPtl0gJiqsAmCT7I8xbjivh3JGFI+D2nBcSJQJ8agDX+O9iBL7UfG4bzAkcaICrbtYHz1ycSmGmAjJfL3CMgT3tQpmrfB7gxSzC1DnvdhQMieG47u75+kTouKNkM8c/+vq/Q7ZYjO/hhVvRq8F/9gGfhP8aqE9EIdR6LTwJ1h0BItyDqB8iFwuNqASscRnYioxOg9ApvnYA35f8e9Ohbfe8J4rknoFkO0lmA2gmAG0YK0DkB4ieEjiLoMD8wBzom27ANZkzIoU8EMHk/uo1mzeVoEoRWKn8L/62EYAX/lsB7D/LXg74uAMr9oGivJ0CNJCGD6i9DhZdQF+gtOp4S+NODRzsDVbhdgv4BqTMNyIL9SCKwL9/FGPp5oQKxIf8A/UX6r231H7YIqLML0Ae2GtrADOvRQH5b/MPE9dt9BGLNG8jVTAQvIaK5TtvvvWQgDvyXIClUA78S9Nfg7VtIBlO7cbsEYkQDMot+ygQ7QwmOawTHnAM2XUSnJvPIYRYMmYPS+sv3J+cfP3d04JYIXsF/EwMbBKB9Q9AY+BiSwFj9mzrSXmcJhFPVHySTbgHJCPvRQ/z7G/SVUETsg0ZF+i3CRoCjhf7y1A9mOiDD7TwdwEoEXjLwAv+avLE2B7Jnb+OqDpBoAchoQJskxKnss0vu7Q2YhcDv4ySeLOg9GsCKiUIihP7yfW7zbTsBh0TQfN0iAWn9f72Z56/Ax9P7j5OAH/Qvv3/QxKfk0DgDuP+R3USg3bzBC7bO/QT9Eeh9QvDPG7glBQzJwK740lAFFgFk8P88CqDGAa223YckWYhr+c0BPdwetl2ocnsfzePAWcVnnAIp6gDVhDLyfV4nqFEDPxHsbWD3k4BDkN+pARqKMLYBPzYEvxp9xmCHQQdgWH/9EtH2TIFpu3AH/cdGydv1j0TQbRrq+D/mLcX3ZACZ15bF378CG0My6Kq/zoGOQwhASDFwFbxyNGBuSxbCEhQ/uEPe/6gAERWQObCVVfjPpQX+rexxYhYFxIkgpgX7Y/vPs+Pvxf9vwt8kAs7i32t3QCP+3SPaTwIytQXP38u0PESm+YER+o9B3vr8mETAUfDrEkPI80ck0FZ0dXh9U+HRbhey0cAc2H7A4y4egoD6y8JfkBiigLdFP8v2W00E8deT2IeAKujZ/QAVKpAtKI20gLWksHedfgPcb+0+NEHefd9vB9rayi8h7J91gBbaw20MsnWAF5xHkyDUCOoXp+yrOwwxcKj0aL6fFppaaKDv6OpHR5sgx5BAlK/+fYhuP1D196o8e7lFBaKqv5YIMnFQpd0FGVR35RJCnCDaABaXBtgbiSwtICMtalKC+1JQ6bx/PLcDPQL91QFodQNKpwOgF/9eqcBxBBqRcKAAVk+ArQOMx1RYGgB6naDhlK+uQQwJYx4meQbxtNnYQwMjt/d4f3M9ZE4UOld1LAh99fbfzOxiEkKFCkTJIUIMUeVnJ/9sDt8/e1NEJOi9oVHDGYhgnSLss9DX2IAqw1zALUncKcDr0FB5NP+0cBQNrEezDiyiADPkt9qGpwoPdL0AGPx/NOKeyf3b9WJNdfcFv6bKd2cLMJVfJ6Y3B6wB9WFUfWWEwKMfGiQL+3bz9XGQz2EHKhF41GCtZyDi/gUCsNhYoAr3UNJ58YidHKqnMb/6AB5J4N73/4L+t7mAkeeP3P+1LNSB/l0SkMEd8DcEuUlguEw6t2AU/PCE/q++Akw6QFf1u6SBrj1ZnnhG50AfkoGIdf7gJv1KcSfgzWWkQ9U33Z3tHXYASKJ9e/YhU90rvD+q9Ej69/wxYJVs506Eg/r3DkMDzEdDBRGgcZay49XihLA30P+l8N+hf1f57/0AoxbQbwYaan/rBMirE9Dk+sBzTkC8JNDEUlv5McB8PP19Y01Gayep+hC/2zvQ/2HGLAurowsNGlA1cnqGGzeH5weiYLZm7h3QQC4O2tXdhvMMk1ZS5ebpgI8eMrPvPGkwaxayk8Yc6PMOBPEdC1XZ+2UfbfOPtxLMQQAG9BcZFoF0gp/RKjxe7+oAw9T7ZPWhgedodgz0gf5KBtrtIZhQAZpAV1Bi36w6t98qVfH7hqGI318lLCjLCUFlxRHwqYEH9a2qb4XjWvDT7kBwfbZA5P0+PNuRuW1yf4yNQH3zzwv6b70QOJ0G9OT/dhoYRUGT15uQH/71MjQLtQlxfDuiCXrtM+SkA+icQdH6sU/xz7Ze7FlubV4TpoTQ2osdpaEjtqADmEU7OkBEFoLeC3IWFFeswJXKXzkboNL+wzcFHU8hTGKIboO7CLi1/P+5F+gydQhuvRbwEgxvtACmANikhLTbj0gCYk8KdlYgmj+4Ymaod7TwahwadICuX0Cm2fE5iNHPK0x/CDV66Kyg1MnqjNFBnhBoLQCgUULfaVe5nq/6EQWY67bXCszUb+7232fVPz51iGB12owK9peyP1T4raMFF/OEYJP792mgXYfZ04GHMAhBkCSmSj+dKqRPgVFGHbpLEGMiGFeQWfSgrY52VxaeDUPSNJI0P7NoisG729HHl78z6hxfs9rV3m4JjgM/lsui2qmThjCfDFSb+I9vwUqG5wwL55U7C+6ot8B+7N2o6r3q37T9trfpjgmTvv7PSQATLLeRAOZhIJHBQfDQQJPBdUwEbVW3+L08EcEE/9G4ANrCeWcnPKRHDupbNynMx5AA9IRYLmrc/YLSiD5EaEBS/s/TgnU9ILcH19n+CpHwegLejx7Mn/d25fdN+e9U/1vgb7bqf08MOtf8EXxaoh+GY8L6gDfhvs4i6HQ7seYI2sv1GchdMsBIG3xlvxcCRzdgCPTn+6q/TW00VE8Q9FaFv+R2VlOM1vm/hhjhDCdgNflVKME5B47I9xT8z0YgPAJ8myb/LqHy36j/Mwqw9AALxuO1JVjiuQAYLcFzIhiEPe05fk8tRjGw7yWQbsfuLAT2VqOId1osnr0F49VM8INACPHDoBz4B5mqqSnUgyh3ArjXxfQH5BbgUS8gP7aU+w0zHD9GGD0CGHf+P1p/DeivlhU4BbxR9a2kYFR58YaDZCUR2P0DMmgED2eg77puegy6PgDphEB0CwlG/i9d+/Hs34pBEQrBn0W51mqGnJAk3ACCHeiqkQ1XFQA5AlKH7Lk8yJKWY3/nym14h2C3JvxeMwD9ZVMz0BPMi1n1RbKl1cYhIVblF3G0ATsRiCMUvoK9//OgcwYMoe+ZKOLlC6/Xk50br9NFz9fanqA8UIYSpCwlBO4kHc4WLLBfBHVaKwKgLQjmP4Un61Vq+3s7Bsyi0WztmLjJwJwFeE0I2vD/1Q6MVwefxfUf32skCPbCnxQqf+QMPEUDHZ7vGeyj020JgkPXXwsldA7SYR1RE3h94NvNtugswcgxXEkIcBPCGZ1rmrgDC0A4K88nm2fn/eTnpQtWyZfybRoK8Dro4zYDIMGsf7saTBzvX0SMbkAD6o9CYbsfMK38cJKD9l2FJt9/VGs0h5Gib33pxMKWNsigFUh3G2un+/N1WUglI/EEx8fq27vUNnwsiOoKecL7kQS8VnWAGCFUgn6dBtQhv40CmIYggwK0uwDHRGAuBXVdfwzHUjZzATLMAoyJ4FmBhzaWBlrHld9CCWpPHRqofBqMReMGTJ78q9rDes1Tv7/0m0v0AFHXNR6P6g30SHivin7V1BOhh3iWPwvps/yE836L2XiwnUT8x2iHgfqhnwn667QHEE8oLQjEvtEW7GYBZDrDVkwNIO4G5GiBDf9fGoFM6n+vbEtzXwP6u9AduaWnGYSLAlVdl/AU+ikrSeEIKgwdaZ4AACAASURBVKj4/wtgHcHtdO2nWKcBkPfxcvnNQvsj2Me9f02r76T8q0IBn9OLKfz1HX8yVXQYGoAB/2UeBQ5/5kCL6+H/OGGoRnLSwdd3oH8r7KkGTbgIxEwVWvnF8KOpHnyzfF9Jod5Px+IF1h8owyitDw/XEgRb5bPqbt1uvn7qBIQ16vtS/u+DP3cR7CH0WWJgd5mTJKYgNzoGjQrfvu99NDBC+bnyW1x/qhTatv2OaMKgJWPvv5kwnMgxHYGFRtJW8VMl3uP+MgoqSZyWFKr7+KIDw1d6+IiOgZI4+d5iYL3imzbgyO+tph9t2oSBxOM3ugHtPoFZ1LM0hF4kXNEBssvVgPdjdXZWK7uKvyS3q1Xb1WQwtVDqSUggq+Vw3t56JA2cz7PXOwGNW1ecwxPhfe3QEUsDsFaAz8jg0nf+iZMAHNg/XSazDuC18Iq1HBRrOsAQ8NLB+16g614jmuSgs3bROxE55D+WDDQNA4ivdMJ9M1b309UqknaDU8ObV9/PwmMPATvTMAxpABLBzugUtV9bLdhNDQA+7B9tQJ06/7QNDHGSwtgZOCIA47InIoDdROQGtt0U1HI3GaoUnCnC/rzBMQJteN17+VaAzYNA7e+PFqHQUyXPUYB7iQYa5ZFjq1Zqpx8Uqu/XT7+6BWC1Xaj0GlBIwMoHu7UzcI/6/Acb8KIq+hzmGWmAYnADrIpvKP7TZeLaf0LAeQkGgebbq9FToI44p654F47tekKkI0L5PQNZPsDwPBpy/ni+wKMN76Vav4+2cFZFf8+JwAraMt0DFB7beA/u4Zz/a+RXx0M/ct4/jwaNAS8G17eSwmta0Fhx0VRxJkHMivso+onMXr+YwdWKbgioy1jp4x4AzIKg5lEA7wvHEYCRmdx11TAuT6lDLVl4KvXkAET9P4RT8H2u+lg9EPQIpw+/NpJ7RwE8HaDv/Mu4f3OdNkq/EfAiEiOANjEALvcWL9gfFV4NZbgbQc6qPky4Pm35QZxtH1f4j+P/jXuaYPcWwIEH/fmEPBoAO4m4LGxV3txOQqDU+dXgey+UwSzuqP++uImO/u/6ogCb7wTc1n61sL+vZi87rxnrNas+giTg6QLzaUCjIp6JfhwtGI7AjBBB9JjDY4ePYVR6ZPgN4owVv6Q2N5hhVHwNeYrM+w6dN6K1sMHZm/Ce7bHe3dzKr1xw1w4JrSQMZtgnoQHlr18fzunAszD4qurNUg/TDqzx/lfCaO6t4tACMUQ6P6htWjDPC1hCoZ8kpODzJ70MUR9AODcgwyqyPhmE+wfHYB/hvSqt6qeXUShhXH+d9SR8DzrDaZZdpSp/HxqLMQuATgDU/qDPRgOIeT8cvz/h/XC6BtE7ACLOWPE0KIS4UUjmZaJ2grBphiWgT41BUVWZfP3AnEIT6OrfoF122l2rMycBoU5i/OXoUZ4/aglsXwLzHNU++FVF3qikOj5HXm2PBitT1WuvJRAB+6O//W0/PY8vQH5IrAsMs/WuVmAdHBrQgrbOxJShXwRSsu08h8JMBpo0+aDTALwV4tbswgzHrftG/dJKIAQb5h9KCssWIMeto+GYqG12/HWGjx8kzqNJaa0noMWOr2KwW01AMwJoNvhMQda2/RKQP/3ecABM3g9uD6BY68Ntz9+nDOMb5iV+hIE+dP/Zs/wwJhJ9mgBnohBuStABUXjugF3hkXF9ZZJAjefKdHZCc389LoStKvIl7QIEb1d9RyciQgFDI9Cjyccc/23Aam7/PZJBhgDgin5CtQvbCzX8ip9YgIFtOAt+w0owp/hOiCWgEGbVHuYjRigPGR/YOnEoqPDoV5z5YqB3mRq2ox5ICmSSgAP1Ne+XV2NE+/vuFbCTRADxtS70VRBCjgBk2OyDUQiUgfl77b7DwaHm2rAZ7osRSOOUoHgKfNBSLI767+oDYrfwZvqChSpGfj3pFwZFsCJg2jeIQQBUiyI4WgD68ww4qO8khuWkkIuDrxWv2nv+UTBpJYiPd0KemTA8qqFiuUF1jWS3BoG6pADJq751JqBI0wvAVPyMQvjcX1zbELltKK+zBiXRFiRxG+b7q3M9xuLdzR8g0gCGNzSM5gNYfqGO9CBT8OHct6oB3KsSDBisUnwsFuISQaRHxDSv0vptt2oeLHMERfRn/FG/Cx01EpgIQG8LP+/i37PKw53xn6sYCM4/JwSRrCnIeB1ZkLsawDhaPKv/njU3wnZ/dBdGE8+YTHSG8+ofGgIjsC19YnwdM/KAnTSsqj6ig7uGgIPw3nYFzhhIIvriAxFP9CQd4HSlnzgxONIdrE7A8ZDPx9fjib8ifgegNIliRgdx95+E1T7+3nQVNNhEzDgGA3T2rEDLduwtPpuuouPcs8swwXFjdTaMKt+jA5gUAQPcf95KJQxYU0cYxEDvsBSmYuukp7AwnqniC9Afa5z8vboI68ImT0t26CvwBzSggkj447r9IojvCn7U92J/Hw0QSdwZKNNjxPCfSxRqnATkdwpOwh88oc4J8KTSm/wdbZjrc+4iFP8YO0/5JJDCfaijK5xVXevqfg6zGRrQf83chvX4aRfAE//6vv5+6490U4ADdO7QgM/5bcHP/n4OtCQhBEFeDWSvos8DPq8/IwzLzjpa8/U6MMSkBklDm8e0mn3QIY7XG1Om8wzN48y7HwhOK3P0/ZwUQHHv4psbdoVeb9VlAjChBCdtDDpOKTh9ZfcagOYq31RFjN4/gwBYzp8lAwYNwBELhZoxECeZxMlAzWGdCRV0fQWGHo8+8Kx+AAxnCIzowAxy9KvNepWfsfp4RR9kUrD88CPVTuXRybhqqTHcnxEGndsgub1Gdug8yz9fHt3Hpl57x/mfCOC29FOSQ7/noAZR5W3Ob24UMpuPYAYiQrQgk1gnFoUIKr4vKFpV15pHUJO3Y5rfH3UFHU4bGkU+NKJ9f2hJyOMxDBDpjAgwiYqvk5TqNl9EH2Arb6fA3yaA4cBtPWewhkEcIQJBlGzYp6zRmr1v+e3Fv27xpzvyI44NGDkCIi7CGNV9Dw0M8NtHC2vUwHINumCGNG8erxOwtQINsW88Tlwdoc+F85nI559ngEDpt2F/Uu3hiXYrkN/pBFS26hYDAkFgErMK67y9mGBA3L5ore5izf8b3n805MOq/t7XU4WHv1DUF/5gugCSOAIW/59uMwl6CHWAib8bvfxWl9/rBGEMTTwDfG+ezEYG4yk6FvRPuPwE+wvc39IRjENWM+/cm5b0W4Pf4WuKUnw/vD6eDbB1ETs5vl77Dhnm/51g6wPWwQAqxnivgQaeS3gy/u/1H4hpTPrIgHAN0mSgXUX13YP5PMIuQAfBr/f70cdeE+QoCX3i8nFMLcAjInBoAIYqt1LhC1WdtvmSab28AYffaeivCB+ohdYQgfUa/WS4ToMsNLHLc9nnvPZLwn1/EefPVf+U/xvnCVSEQEkEQEnEQJO7S7RvYDxNeNYKrG7DKMhtsQ8cMmhgPKKKj+F7CiHYFR5KIIPxOmg5IVAtu3ACQSPh7CzUQOgAej5CWEkIe3vgxz0ROGO//qYfz/dnLT+ZxDr4QW0eNCJBorCFOVC312Ec2TiY5Bk0cAaQmiA1VH1MOwDHQ0kHdEDDf+2UTWhS4Z8diQMicLx8MLBfverLcP/jQzF0P8EJj5+NGK9RCz755S6F/f1+X/gxeP+Wsedv+vF8/54aSPJYFjIQd624MDz/UDLQnr8HU3ztKHRf8Qeno1vyAQJBaLcMtTV3cvgP56COCqd/QP9xLgBkH4BxO13n4hNUDtACC6G1S3zqooZ6Ba4lp/zcAFb7iERKQwQcF39IFJjdXECGADw0IE4gg674pYAnk4HoHPx54tD5daO5vxrugSkMjgiiqc7TVKAT6AT8R4ckbHEQCYR/IZBxJgA+XZjsR7vaoRpIxWqeqfXuGC2CxwudicwePEB1kNkaZCuwyF0DuKv/4sz9mzP/Qxdg3BDkBTMC8Q+loD6UGBzx0Kz6eAX/KArOQTlPHFoI4vVtf4rNuLrca9edRn4xBP7k8w+9AgZCgBfEUZWfEs8iFNZ3UO7TqmkjCO/rWdgco/yIqHcQWaC2EGTzgz5y/iXQAvyx3riyxxV/JeBriaGB9OrTA5g9/eokM+37GszqfA/UZk9iW5UnCtBqBl3XoNN6Ag/+zy6A5evPAp+TIFDn15gQw9rjrOzFX0s2JBVAxa/nP1a6AsNWYGjPNGPLTQgBsNUFvOA3Ht9o/rGDN0tWOCcxJGp+f7++kkP7PxcGv1+GjkaLt/fawpwwerQxBJNW4b+PJsYEgiAYYdEAGIlDNaAbRkIgK3ut0jKByp+8yz23X6GttmBmjwDvChgiYLP5V/zhH6/110sGcKo5CkggCngxnIPoPja0j2B+1BRkiYJiviaLJqghDI63G2nAgAxMCuDdnoD0wIQm+urMB3VuAwbBrFGgGgnhAFqg9+ujKsLxB3qGCQNEEtPinIQlAj4WgIw7/iXc9V/x/yUWFs2KH504bAh4aYWf4TrTLGTy9YbftyLeVOWNfYNyt/ji29mQnqMAltU3ioTtbX343yv/1u0YPUBz6zB702tQucnX0gWaFh6DgPdmhXaapGotw0SFz1qDiTMdd8h45HfcqCPRUhA3+NmKz1l9teCPaMd4urGaewRitNBDdahR5c3AfQmDCFT9vmtQEwqAYXX4XI2n23Z9B/Yb1FL+LWox6wHGbZSo6FR1LzyG+3hriSZvWT6jfXhl2cmQZJDrAbuYAqAHo1GA/EOgD8eGcU7A8eDvH4fQBuAhBL/Zp/vamPTrRENDGLTV/7E1WEPLDlP/PwzU4YhusIMUgfIPAr6Dhv5R4y2r8ldFwiFoYHnmr8TAHbhRQSZOctH598ZYhqt6wP7q/ouqe77RJxvzFYaji/z4vna4v5cUMDXqDAJ5ytktqtBDckyjvJg04hl16LB0xFfyMfD77PZjErGQRRjYIfSvoAXntks0ok8MsUC4KARWnYPlJBeIgLeFrUgDOHYCag0/XNAbWgRwQuLAsaQwIhC1g7+jCNKuT38JfnYSyTi+QQEwwHeT4/dWHYxJPxfOj5oAnRQqgU3YgGZSOaDyK3n/qkDYBKptzR3oD6B4fyRKjp2AzSl80YR/3P+/1vBjX18Jbu+YsrMRgbqPP8zrDLTAaupphfeZtyPs9BPztpLSBZjowF3woYRwBwOWaqbev15b7X4RWsiqYiY6ZkFEIoUwUA2OrkeEQE8HYNyD/rl3m88jCGgO/nPW3xy8x4Q/HBcM1dYg5q8N+B/SBSYhtD0EY1PRGLDoKIBHF3yLz4H/gSYQJRETgqeB2d4vC8L2NVnQn4PoVJJAcP0inahAfdXVI8CFszjRagCTtRdV7Sr895NBpRKXIT64RMFw/iw5eChhEvmmyUIH+k+Qu3cLzOAN6ILlFvgWnx3YWFDz0f38ze9GlfP6UQ3ojEY0gtqRIEbA5/WgQFhsEuIeL75uTzvqHktAWfj/OD6sQXssROcGiRgFn0QVkld7OznMDT7CJKzhMIqxW9B+LCOQdH4uyxIcE49VTSeLj0wKjzcp2oDXQA8YoDEGBLMW0BJw+eAxXejPV/IXd59/tp5rVyYXDw5BlRetSpQAcvgfOwVM8ObzBq/AQ2wX4lwkQV3vNhYFfn2LFgaoDU1ogqsfqGkJYmrj9Tr22KQwBLzbLuzDeA9yzyJjVRfwegWq0H+FThDPA6ZhZwX2M2Kh4waovCzAWJTzD/qY00c+6PM8coz08VNqglzx54LfHuTJK7z2rwX35ABLg1DzsZ7Qv7l/f2yXDlbf4C/irg0MJ0aCuD0wP74MrxfdFlX7tq+vtRdCpvt599EG9Yz3V+P+Oj/n4zLruZHcJ7oMt/MNp9eD6HEeFb6/TMfbWo85Pb79HJo8t3371/PuIAZqMvjPC34nVV6ZB4hEuA7AzA5cfU0y2n6ux89D/35/n2/vWY5Bf0qwf3tPLISO1Tap9qzFB6eap/beqI94NCCbGwgqOItY3CGl446CaQ8i2Q9g0AvmgJOnBoAA0gu17tsKtKS7D4udgCYERy2QIceCX/P7mBW+g/7D9S6Mn50CS0eAoQPDcBjopIA5+EcxEjLweRjXq0UbLIjcBxsGx2IZvlf0ATjz/6qypAmY7bhrk4ahsIis6ccXKHdueAfUgk+RWPCLh42c6zEeKyJpRTdRAOqBbl/Wq/uT+q+Fx3FoTIuCzc6+hN8j4veGjuAnhSE5gKnco3A3XwYlq2sq+lmP4yEOpqEoG0M+mGDYuYT0pKCFHgLHKt3T7T9p8GcWH+n1UwGa8X6kQt2x4CeqPexegT6o/Z4Cr313PHdgrsS2ZReLfpKIf+IMFnmVmwxQ9AhithYT73+p2s+JIVfrjwiHnpAZrSsr9CMstQXP1+1+510N/q8E/YoekMN9OMFvi5LvkRDsy9rgFCOoPdpgaQIWBZjf5KCSQszZJ1ivTvLokpen6tsJAVND0NFqb6GUGg2Im4Dyx9Pn7/0dm4pADAslJzTv+dKNrAPQ0wyySm7bj1RQgbAXsRa4R+mBJzpaQmHLmy0BLoL+Nh2ZRca8uUc6P37k97n451fvTieAE8BdZ2ItqFEK6oOJIYPsiU4woo140Oh+H/UC++gatHYcOFT+2y3AYvD1rM/fpxdUcsAi70c0OxAEP45X/hymE9XeoC0zfYhbcqfbhs09HpwnKMDR6g0mmYyKth/UcLl9ITGQ8N1S6s+gA1HvQCc2pluPvN2Br8SyZyfyxPP/VhCi1L1HWX2CQCuAE8TIq/sBYdANZmTIwqq0sb0HIzhhugBeUpBZLFyA8y+EErsBUYDZHYN9QAAooQwOws+uQlhdESSSqk5Qsh8LSYI6LDS1AbmOvLlRBqQIeITvM36+TP63VfE5hFClCTr9zEyVFwS3STQBy66DMHB+PJWIrfgGnYBx2dTboPa2X49GaBVlePA7CFx4iaGi4ns0aLVjMGvtPTDtmO4XEE8E5Kb/8qYai+NHl60LgAICcUCoJPVeiYG6Pxw/X9VFNVbFn9FNPzXoIRDTyzcpREYB5Fm1EQQn3KRi9wKApR8Tz48SwxnV3qM0q7ZhpdKvr0zfY+gO4oQf+EGPFYW/Xf5hwWsUgxiBbShGoGIx+D2eH1h2EeR3UQMH4zMaUKr4033nzkSkfQADelFbLOQCalxdxvN8mInhPas9bxtGJw29Fx3Y8429MAS0fL33Oeo7qFZeiToCC3B/VSNYuU0fgDnkhxGgMFdxiYEY7MYel+OHPH30IMeVFK1C79l+QdXVpFqHlMAXEf3EYDyfkkGdNvJ8f3RAXU0jpgM7jMNA5yCrtfzOicKG/M9bgEkEjqqPPDEcDfqVwGZv6zcO9avDfOhf4OmLFd9OLBHHdxp51HvOBlnAoQksYjASA1xnIhPsapTCPjbsGB2YevpPpgM73EYeSYIftgPgte6CWesVBB9QEgfnWYMgoeC8ql69bWoRIqYHvSIv/u26bj/jdqZ9KSGk74JRo6QS9PuTiSHm6Z62kLUGH0UO4rwWrhtRETkR4iKRdI8giJ2D2nUCMjsA0TXiVDb98NAf/rCMlajA9wesWHZrAe1dlwRyVI2jx4KkyUHSx7YDe6YD4tOC6XW01puEdAJwaEJzf1uATHi6ZlSCpBQscsh6C1xRcWEG4bCFeKcAVhVlDu54JQIkTT21hptIT/Afk0kMcS9BKfjBJozcDXCrtgbWXxbMAw3INQIxtQJPAGwXmYaBbYh4SCsuKwLOAQ5awKskCMmRg8P3xwlBfbosQaDqyZqBkyQe1CLQACoTgN4qbyHsPwkTiF2pYaj6MAXBmUosQHnUEYCsBL3MW39SNKMJ5PfoBsT33DVJCEbFnBCMOkHfvj6Xq8uw+dgRIhGgAiUqf5QgKDFyhe8nnYrlqn9sG1GoAfirubygX4H+8IM1CmQrMFAJ5ExzKIp54nPoVU2Auh6eBShDlTV4u5c4HE/fVvjFrsII0Ik6QX+Iq68jB19ziLoKC27FYe0gC+j1RSS+BgB7AvAM3m8HLdy5fV60C8RMVuhD1ieQB32MCCq0QPJuvuw5IHF/geMKwOPdpmsxBwVEfGEOgeincJqNmuSFIPhPq/xM81CWIIi+gCFBqDX3QPYd2OcCRo6GZBoA3AM+00aesAOQ7/2Pe/vBCXoguD4OBD1WfPwClzcui12AuH+gC0gEwW72KfjBCQRBr05D0IQc7N8PzOCMehPWK384MPVDJQim7yDdoiRTItzzFV/ZOX9sYFetP0fsQzb6O7wOoFjxk89YoQXv+BmSN+yYHYO+BsDRAXHhuJXsEFbdIEGZQWUkNVNzGA9NZUVBIQL7jASR0AclE4Pb7JN3BO72mG92+o8UG3nybj+mASh0FsLKn9GPxDrEcS2Au35BzHO1BksriIJdpqWjKR1wlpR4fN977rZqI+XbYjYDgVDpcYQalOYKMiuQbB3G6Pu/HlMbi9a0EMkksXtjvvXTfgMKAEZRN/i/O7yD8Da2S2Bdh3ICWfp8yuMkYl5a4df4vVWt4UF0yyqEnaT6swYyWB8/j111Y1ERS9oB0SLMtBGDEBD1PEHwtdjUEAHnqmoHU4wCDAoAS+lHwtu9eQLUAgmxVvAuMB9cELMV3m8EUtcBYYI9nkNIEEJYrQeUHfnzzRyC39j8CgSkir/E0P2odnAmAqDnDIhqrtV9BDNS2POjv/0pwKr6z1h/PMz3uf9ykFYq9TtoAXSwpz0HljdvBCVAPY6t7osv6gFhMpkX13rcfXQMIpuTsfTibkfOPRAC2meLRipI4mDPwMD5x+v3+Ey+qEfACwoUEkKQSMZxYJDz9R68PyP43yvo2aYf881rNQbZgRU/jp80QnW/hdXqJxMvCFxXQSNHpE8QiF4XI+wFfQcw7VL2Md7RRajsKgh2D+6SLAKPF356+/7yXYBTUgFy/38StUjFHweD+iiHh8/LV/i/TSvGk4L5x7F6AsIKbgb4C0YjgdGRIToGUx7cgS3JKP8pRcgak95BJGQbjaJdBYQ1qHYnYHL8F45QgHx2gLMQ2cDxBD/4SeR0LSDi5XzPQNjM4ySE/HGG6g+ugltLNSARn281BPtNO72eJLjdX4ITSEgpQvJYFEUg24f1qAYQNQdxx6Q/RcB85j9f+03zf2QV33IDPHegNgPABTfqFR8cZK9TA7/ll0EQbUUHW8Gr1d+MSadia+LRHwhunv87yWoJ3h/pRDwJAbDNQQFd2P2mH4kP/wDT/ZeN3CK3+ZjvgVpw4r20AMafb58j4N1UMknuj6iCx883PU9g2VHVH5JX2eEcPghSgRBCKPzK0Q3fknwPN0Hk0CyC0zBkz//7duEetgFjVtypASDI4CsknYJgYDhqsBxxy29+eyxrAZX75EEf8f+CkOcijMDDHx4ASYGGu8WHgPwpHJc0qOG8FgFTuVk0cRZVePFwHEIUEu8xSHoL5qWg4I7/HgOKXe2dcnu2SSdCGIDTA+AcxY1zYL6Q6AAFu+/1GvjKPSeEoJV3NiM4Dz9C6oWkEav+NWjPWXNOIkKgNTi2I8LeBgaZHJxqrC4oNXoB9pzzMws/OW3ghSyQJgjbygOVEDhoj4nHLld8HPD6UUMFVLIgKrTL7cFoBRLQgEdXIseZ2/HhFPKbk4d5tYWwwR0nIFQSD2P5gQhs6meVfB+Bkyz2fOIvX/zxqsSODuAGIOLtPNnmIPCrv6Kqvgz3q4tCwNl9lWYfnsdHj2HTgQw5IBHwULmfSu1jEV3gDFSxTBmqSEVqiYK2IkWcRiAkwV/cyW9YhqHXDw9dkNQAcO6HFNJT7oChfrPUYc3KY17zAd+evAwF2w5SCKLV4EuCEKsKfjBVWHu9Q9Arh4CoBqEMWYBsNX7YgKP/69uC3M7/mOOz232QT+ox4iCyJGEFP4oBHd+GVvXBwX35nqp7qeIbV6L6tdZub3ueJ+gBIKgC6S5gOQFxDoGr+Bv2nzqbknd7ph/EmXzO0o+kZdc/wqvQkAOUffVMzKtYgx5Vob1/+HAfCdzHSiXHenX35/2JTr3KZ9Ruj2lYiMhLIFoNyMq9hFroeYMTE0bSLbhb4l3YlFPa6hMd2jk8dmrDgdQCnC4/+ANFlYTB6ATlx2GDGXP1rvL+SnWHw+cJes5/rRWt4H2pw9GklD4uSMpwasIQiaYR92gIyFX5S8dtRZt/nCAH48VXW3hRE/HKOsGquj8EM85Q9cfeAV4XwNGAlmIFIwPYrfLKuxV476RRetzcdeAsRSZhiHizCKEIOHn3EMOWy5X4uIJnXX6sFiBFLaBm/THOQAkVJK9j6TKwiSDTBWpwHkSPQJX7U959uAkoaTUuug6oQCBz1Zlxm0OJSIoIw04M+7zCGuYiznCfHww9AN6Ir+HXA7lfn2oBSJ2FOOh8SzINfmcAyITq8JX/sOMPx6A9LeYtVfwgCBZhdu25OB9/XmWWNPUEPD5dUuJ68wd1AqD2+w1PI9KxE9BW5t3z/igdYGWiL7L+wPv9jgVY8f0ZcbCKCuLAHN+c5wa69Zpr0J9t2KnpAGzyiAIPiFalJ8/xXrrA6Y+/8NoDnWCPNwFJzf5DpVkHte8hx76P+HU1+HEytEeSEIzAsu5r6wPJGu6oLz8VrKofXLce+ywIHhNa/Dmw8LrptWXZ4NKZm4pr/QQ7Qk8ehMrPtAF7PQCD309QgRgRZMKgAbFREAfBBXNalbHA9cEHMo4IgIUuPjjBWEUFEQpYTkhVO43eRiynJw9Jjj8TOUIlJExK+0wA4gWgQvcFBHAc7P4/u78/Ff4CC5ATB3P3oUwFClYgcALcxzp/B9Ez4DUV8RjBbsCBrMH4dLNwIDaCGhA6o3pXksdBvYBsktrXDgNJKAFy1Z+ZGIy5NXgXoBT8a3ZgVSPIUAMV6DjLxhsV8wX4n4ibbONObHNyCr8Z4FinNFjg8ziiF5zSV8A99u7Zdf5OisvVaAAAG3VJREFU/kIPAJLWX3hUIFD6o7MD4WkHIMXBk4IftSrPNBJVk0OoC7ice8HGS8XBKDoz/YFBLaQi392lGpCMJfhD9xVkx5Xbj73P9V4m1j0v73x9FjDDPlYvATkgFAVWcdNvJBamliOjAwRV0EpeRymAe717kMYRyy/j5FwFBX0fP7Dyx8gq8wn2ZXi8GfGYR+lFcGJSxa3Y84WgzBHetlU4cvKY44Ps4iP9fsgsPGEhQTAcHqwwGCj61SoPexKwasXFqtxq8qhD9SixoBBYcJEDNzmIoi3J7QkoJActVHocTVpPBCDhElAvMDK1PT/Sq3DwB/ygmyB9GNhYDH4so4Foy48kkPtZfZEv1PQTxYpyX0EI3Bu+/5krcN8fgwVdwWu2JNVNWAk+PcOOPMNdGFyAZ5Aj6gicgzNfwuHZg0HrLxBWfjSRl88fVCo/apX/IBrIvf65ZxtEoK9Bec4KZIPLe76osQns46NwW0pUPCPAyMc4A/KXOwZzFLGbAqD5xhhbgBcWfoJBAlarcCSQgdQJ+Movnih4gjZQTw51rz588y/ZgxVUEAQ8soCfX8OR26JwujCLGFAMsOjnwGrlPuQw9D/PPv8BYVR7pG/eeFtQpsLzR2KFI8SwKj9KlX++HeLOPuSBKrKeHBi7L4b+Kx184+ptAp4Trcscv69oARVYzWgaK01H1X0K3zNSmARKtxXYHvwJuT+8gLGGWgpHcWOmBeljFB2Ckg6wiAYOqfxEK3GMCAj6kIiTWdCBCXhkjUKMgJcLk271N9uLSbtvvK0S69OXAvoA5z94VsFubbmZvx4QAnXgBnJxENyQjy38wef81uPhxMpPJIQzr5ckuUTKe0wZyN57iFTWga8GvCwlh5UqvYgmaNV9XSxEVWs40kkosFwA70RgNOu8mLZfR6wDiwRa35y7j08NksqPQhcfkRBK/J8R75Iz+9C8gJpqzwiIeZII3QnYOkJWbVEI5jNuA+o2BwK82ifwnpSgHwaC+GNAdmW2VXfC+vPu6wR6lBj84C9WfvivZyUhZMJlJhjSukDlFJ3g4AvGJfC1iEpQJ/CaEd7G9wds7p71+odruKrHip/C7RdsxeVjzIxhoNkFGOW/+sk/YVAGtltfzZAIfzix8gcHhZCXpcGN2u69qWqD9OlRFAy7x2fQBhHUiETB+DocqvArYt98f+AEAXApsEmEcNLC0t2uPHCqPQIXwHYDfI4/9+8LMpchqr5HK39MJSrBXwnutNqjovjHFdq+fcHLp7YLR4mGgduW5hFpAXUoL4cTTuW5HJSkB5PC0S7A+8c+837DyoM1J9iv/po/o3BunlDqPjOSO/YbLFd+FGy9sxKFeT8b+nLNPrkAyD53FtT27yUS32yqUaEGTMBiASGcZ0FmK8nWxbvjC1q6WQC4VdWdAcBY8eFoAzIrC0b7Wt8wlPcIdE1FhUWeKU1Igv8Q/0dl4k/NnYSxdlDon8diUDeuQB4c8XVzcahRgyyZmNC+LAgeCfSVALde8/t1DCYawNoePGT83wlOpFUdOZKwxn89OsMEf0X8CxJCBN/dwKbFwkSMgx0ACJJDJD4iC1JEYh6XcEqVHpx4+J4I4UiAl26r5x64sttvSlAn3LBuQCz6edU8C+J5epBrC4YP52EFDgHrCw1B0eU9bOaTgh3wmYvQV3Oqqcf53XnVNXUBELX1xtSgFrirlII5d3HFulxBCNEfZx0h7K2f34XwdHpuYQcguN189Ow/nPXclaUcqMH5leCXjKOjbv3F0a7i2ZaRHmBe5zwnhA9S736ZC8AH8LHkg/T5znYgmES1dtuzGo92qwHIquiWX+4KgVLd8utv9Ml1BQNhEJW/FOgweiTguCUoQHkEwYhjfQIgm8eAzPKzHqAG5xGiiPyxeGRRaYetUpDVpHVC1T9bHGyaknb/TQTnuG7rDYwYCUT7/cMjtILzA+Go/FPw581F/mWeTkDuBsBCAK8ki+A29nMzPn4Rzjv6QV7xWW4fzQFUxb9jQQ1qc28kMi4mDl1NBr4usIsz5ltZqNm7AeJXfuTHd7nioLEyPBISU+8/tP1AC4Il/n+YGmjg2NiBRdl6yCw//zG5ph7bqaBuz8B4VMU/TqSsNPbwCeZA1cdxyG9SgKzRZPL+GXFOiH1/SFZ9wX8M3zUgvH8a4rMBjZj/h1W9MrwTiN6MlsCKiI4gycBzgV/xUaQGjGDHwHiYi0VIzeEAasCpNuL76AC7BIEl7i4AIxnAfoMxk35eJbZ68wWEUChs8IPz/EEE9BkUoNA4RCWSLJkY1h0Y/dG9bVCtUVPe7QRhtStXG4nOECDfUxc4Uw/Ik8JkA9o9+a83IrfHH11EdFUWc4phNgVFWkPsIHBnCvCCYBSgqEN9qtoXuwHhByYoJJA7BxIkkRwpDGgAHo+vQ3ZGOwCFJCJKUAx4MBpFZWvReeLgtBBkDDQu2OJxXa7SE/P4ZiUPHABjY1DsFIhPAaygWewiXK72hHjow/k8gCL6gKES8qcDZ7A+EhYlWCPGCX1wXIwzkQEKt8cP6iqkC0FEhFj/ZYtvXCtwuBLcDT5wXN+9H6ZEIkTwV/x/s78fXFX3siWHEKrC3tw7EFZ31Ll7ttknQyEMGgAqCaVe1bGk8r8nFWCQQR0h7CY0dsU/mIeIuA1AGCo02Q0YVXxub36sG1Qgfo0CBBUXxap+ECFEycQVyViBEBFPt14TK9rZHB9EwMG7DPXOv0OVHkdtx7OSCXfb3av4CFZGTwQBwT7/hKPHE4PzpJ4L4+FM9r1n8B+B+9R9I4Fu9brYUZgCunZWNxdQgIs8mASBQ4F8hJpEiaf4GPihk8FdAxin/kybjZjTj+mAQy6ihZ9whDvHAWB6BKrBXQr+5SBfqPaINwiz12UIwoTmbPACZY/fshBBBKNlW8ZCHwH/cVKSOZMm4Mxk4OwE9JeB+EFkn1IzcPQoiSB4vGgNeJSoik1A7m0TCmE/HrggB+/1M12C1Z18ACGoIeH1pH2IhAqFWgBq+kDFEWAvA3X8tpW0cnSD5WAOriOHhnYraF1eLTkS8P/QsHUBdtMPnOrMaANJE9AZiaKWII5Ue/8PTHn/UcCSTgIF2xN4zdmAQYIAKeBFl6FiO0aKfq5jcImHfPwTxcEdRmD3LcFoAva1Hdjm9UgGggI9YOoPkOBYLsT8HlG3nucMDGkOOJ8CkNOELdSO7D5qqAeJYBb2GpABgRi2gxLITgrOQ9C937HgB+0i7MeRx3gfPWCXLtgbLJAu/gCFBPzRX8eADJqCvA3FViC/BlOQC4LZyrBq8BdQAOUKoKjqR7v7EFfVFMojPgEoSlJesNIePyLHwW9NRgq7E6HvUN8A0yj0wyWDHRZ3J2A1jHdMyu3hCGwSDwdRir7h9VP7AKLgPoMCgKziOFLtrUm8aIFHlgxYfz8WBYUU55iAXauo+evJaIK/NTgRJM9sUcZRzcCnMdNKMJc7usnAyrpxHYkTRHK+n1HxS01LheAHqRWwKIDqLvQC0+PupHZgBawfVGsiniTVHwZHRqbUI/D4Cd+ftgyLAR1ehkIiqaKFw7MJEwUIuK5zsu4svoFYCFKgBJZACBuppOId2RDkPZas8H9kULcA9a0KTCQDGtpnzT+RMJiOGseHl4BQ1C29AWUXIIf/OIwwqoNEK3SCuA7FRiBrE9B4/PcrGJ1OQNj83F4Xbol/TgVHfMiIZLAdcaVkgh8sLrd+liNQH/FqsNTfj15m1J0X+ffZuq/gTY7QnvIfJz6UzBJLs83ItQpt3RfZz5iuGfNPajpngUm0R8DoA5jDlzsOTAwZjzsC3Jjxg7H914PjlcskGdghgx9HG4OOQH34uwQyzz61/0qiYNQjXxECuWYbGM/DrjtPH/Mw/K+gBLLSA+cEfPr4MroArzcDuybbr8Zc72i2UnzeHnTgzD4Ug78SzIvCoARVOQxaFFR3TzWnkkHUVFShEuqKxZnKz4p4YYcf8ZhYhuu8wFgSHcuuwCJagI4bgchJQK/qe9c/RT6nGcg6KGREJpb+MI0EY/b0jcsni3AJBeCQNsBOFVYoApcM2Aom4VFgIRdHpeIG8D3YaxBD+qCiQ+rBOSVnci8hzkAG1t/pgHA4uwDzmu8xFKkkkIqCfkIRs204r/hiDgutoAAcowBMZ9+KS0CcXVBOHCvJw2jMQSJyeoeExF2DuTuRcuWAo9sefyUQ6/oBaIjPtiRH1KvQKvygAHb171d+vc4GRMDPoxN/kL5pwlVh1mBQ1quQJAJ5j0TgOAis+h8d3mnC8xTKE34+8sDNjyVXE6nFMN+H39TQDmocHScENvN74LoGScGU4f7g6IG3n3C3qnG6JBS+Z5tHOOzRYQx+u7MZmAl0OSsRLAS/VIKfRAWU92+12aaVPksGDBWQuCMvgNy2M2Mt8EwqbjosZAec5xLEAmXmcFTHiOWARWglpNpjdEtBQRxJJU5VL5/7F1X86XntXgUK4q+KggsUoIIK8oA+kgy4+zLaACqQGTVOX6MBWdehL6BxHn+tlyBMDGAqufd7WOX5WTJwKYDfXJJP2GXDPk7Tj5Ed7BOG7DMFaBRAJgI/+H2Ngeb2SKb0zkoGlQBHkefDr7xMA5HZeJPtKIzyApI9gmnPgf1c3mulfhe0gFekDCdNFnrOwi4Gs6eTACNjB+Uegcgojog4V25P8bctRYY6RL8AJklE9ACFAGZdBEahd4d4CmghFhbzcwaXYH5qTlS6DY+KfNH5Avzjo2JJ0poDkSCMxLn73H/eB+ifvgvyIFCWAji7BWC8hd0qj0FziMdrS70BlVbgamIgcmotGZDNPwm0L9l5iHv7WRoAFx57ScFS2r2iwot8oKu8l+TOCOg2mZ2nFdjTgOFQENzKkJ8OjEnsE8f6AzyXwT6MNF3RDRnuj0Lwo6wTlBMDIyqaz6G+RiLJMg/KUrQV/rh9uH0tWduwoxmky0kSMQ+rnXxZsGadgnxfgk1pCnsIsGYltvfdzTOBIclIsN8MLAGcz5gBwj94AE8DuC9Molip/JGwB57nRyJiyD3pyk6q5ij+3TzRLohcqyqCEQBTepF15+WVmW8SEr5jMUUkx3oMIsrH3ndwAQganKzyMpOJNxMQooGBYwcByw7axIhgPRGEr6GSGJhkAELoQ1YRg+dPeD5IIRDIqq5PA2Jh0Rq0YcS8XBi0ghGRFpCtWTdum5+yLOsQf2EuYY8AfnbQZDgCjHxBSKwTGpt8QCIDVH3/4H5OwEvldhliINwAFLsEyyIfGKV+vm3eEehVqKTdNxtDiPoLHCRiuwTJxCECxMDqDjTvZ63KaPKvRgV2i/F3ohm88V8LN8hgJcXD5pVGIPPNn9EBqSQC0I4AMxBUcQNCkarkFgSn/oCs9GCVep4eUG5BRAOcQOCWlGSc3If0IFqRfURQGRrKewPKEJ9sLnIowKCcw+f48N6UHjqYtgInaCCkBbPSj8VEkCr2g8U43wY1xX/BNkwreQrzg+oaJghOCGTU8RBxuIp6VFOGoEXgEsBLIgV6gBgxoLSI5CgiYNT+GBHsU01GthrceiMUtv9KgAYktgVNeGrBbtiOQVi9x8WjiAW7UNUnm4Vet7WtsFgDCDYEwQ/EVL1PnQf/xCDLTowTh4c4HPRDoQaiwhKIAae4B7xgCBydI/CDPOrevK0FR4p6w3VfoXgQiB3T1N8Y1PCD0X19JqcHGfzB5WkQE4p/kdeXBcEVUXEIFqSij82lMyrWq/7c+LFHA7z5/dwOHHg8s/Y8C2CmhbmALtare+4UWLfb25BmXABKABTniC8gRAP2yvDAiUAsElnrxFzITQa/sAFecAOY7zPV/8jMQHSbWAiUPGkQNABhw85xrSCv+mMSzFR8+7mjw01A8f4F8S/td4jnDHYxpT8/OEyV3gz2+GTfdAeAszswfJNGlQhEIjB0Bls0BKn4Iw7WKu9f1gmSagmvqleEwJwnZwjO7npz1HdCJ1hS/mlBcRXyF3i/M7NxqJFoeH27z7nnJaBmpUZKHsTbGUc1ALEoIGsGYl9ixS50gjAT/VhB8IzvGTrBVfWEz1MzAkRFTtecW731VdjNQPukVdhdn0Y8d/a7WYH6i/TBPBzUFwAlHwtGHOQISrgb1AMUgDETTA3+THAdeRJhg59V/Ektofa9I8wxVICkC7QQSAd2O3cftzPzdMK6aA4iZI4ILfYRbb9RgqICt2AxVnYZ4kkBvHOBxT/zN9ybHx/f5Ql2fkGCX6ANm6F8WCfqAS+Eq5AGcHJd2IFHagTMHAAj+mWBnDXuc81CjhsAi5dL2K8QCYI1aJ/PJtSSxEFXASv7C2I3ZB9/a0j/7nDn/j1pHsz9Jr8fNpxPBUAUUYD4wz5GBlmyAiORjtAIGDFwzSUwqiNZ1d1tPiB7/Q9VeI9KeJU16/knkEeQJEALjY4rkp74fCZiMDSA/PgvT/aT2gYgp5E/P29AKBQAo6TRth5T4VesQFb0i4K7RA2MZpgyFXCEQHCOixuYMPgy2L7+45ezSSKt2oUkURlpXkEMOLSiXPuDQZjk63N5bmzOSxQdLHX7AhwUEA0BAeQPJIQzkAuFlOK/GtyLdiGDKEBdllQ7YouxV2Xdwza9So4Kp5Z0yAgUhTlJgFzSFrznIHYIwKcCu2/L3LsCg6UI1b1/CA+ApIV5/32HqOIjdQusE4azip5Wc1b0q/QGIAlaWEJbXP3r/L+AEipw/+BtkQVY9fIM2i/ZhgVEgJO6DZ1ksVtlYdoQAPhVO0oKmYBmnAYco4DRCRB3TwCziptaE0auER9/VzRqKNOEYINOQg2m1l9GpGNQAhh1v6UmxNQh2M4+LmlUzll0OTjYQOaGlZAEMCrdhmBphaMBwBADrSQQc3//He8KgFETT7p6BHnjj2X9EXsDjrgBS6ihoAmcSQVYmE4JgYWFpp1waAQRoqDzxDhU+HxSnZHz/9JEY6Y5MJA+cwoWrt99+U3Mc/9g/NQTFaigAEtwB1yBzwzucZSX7RZEILhR1d5GDCsBLVUdIQvsldZfEJt5i/MHx2hGJZFkVVyK242iFeh58oBUFqIQbkfp2DV2X0CkAYgv1sU+P+I/HmBu8nErugdRnUWhfp+A/ddlbEH3uQlBsNobUEMHasK1HOYn8BEEvCUaiuigXRIKj+sGOPA4KAWz9/s7WxcgB4+a6/fI2osEwv4yOENAiPf+wQhbc/5f0gGisWuQaRFmGoIqguARWsBQgTTocDLMT5OJUQnhqdCEig+/EShKSEgTVV0MBMnz04BcshPnLk/+OaV0/dwKzB4QUt1NB6uTDfGOP+cNm9mEsBAFiM7AQh9AKVEU75vy68jeOxrUC4mDEuYO0oLqoSdHaEF2eXYYSm0V+oEOwpLmYFOF3Z4CmAeBTIGueiIw2xoKPzDBJVBXQ5g5O8/twwA+QguIjJt3+g0NQEcDfUXgO5gsqlTBLkQLdl86K3CWneitQ8sg/5oWAUJP2C3V3RoEyji5n4b9lB4t9pz2CA+cAFn1Z9I/uzYsU/ELtEBOCHYQQqGcFejV+yeuRJX31zsKV5IGjway9z6PLDxKwNEPsBuOEiqw57jGgOtZ1Y++T50AuMFl7hPIbhskiOwsATtRoc7rS7dXrpcgrMCGJca6ELJo+Y0be0BW5ZKGcFz4y8W9BduwcDnK9iO5fagsKpp9ANnvDPxeP8THNyIVFo1AMas8Qk5v2Ytm0LCCYAXqn+wQsPTBh/5Bcnne14Os3uCQt28vsK1WUESJFviBgAW//3u9PLxusXchcCR2WsNzv/ImvgZzzkUByDUAIrjTvmSHAowpJBQE4SUlxMxnARlQbIqkArVAJ6pBBvELCCKlkyCDAP45BYfEPfcUpfMch3Vn4bheYK4E66BxAxHSVd5INgEPgU/NBCDfNQ8Ho1CoINAPQAW/QT8OCIZlNFCB84XhoDChFByHGjx35v9BLgyhmojqHYb5QYXnuAecvua0hZe6BV9f7v4ibvgvamrmAc1TmaEir0LQ9h97eYAYVoM/nWA60i8Q3Ifezha9BqaaL3zvqd6IAuwwLSCCuCLuJWch4h30giPtyiAphKEBcCu9BV5wwzkMxID8rhMwdwMhcSFgrBT3RUTQboAUg3+p+Qe1IGarOioVnazmefV3lHpwA0AcLWCahUiXwePHWJsP+GH1gnp/we5KfOhJAbsj0H/BIEb04TbrTPsAyb2LLu93KwfCvn5PLAwrOXAa72eEQRo1CNdw5IprsAZ3hApy9zlcITG2vpCihsRSYxNS+J4vdBZ6B52eqRcQ/QXmSjAWSfa/5GA5qEg4iJFtm624AqXLrSA2gx8p1Mdqcghv41S0lSp/xAYs9gakQc4Ie2RTUYwYgt748mV+FU1Xgp14eW3XYZ6cdqGTNHwHICTwEeTPl0jEZwIgP9gDEaogeg5IHWCF+1eoAhvEKPB/EAeTRsM/pSAP5wjWEUMM1/NJRhwJbpJSgK7S7zF3EOsI5jBQBK9DV80Z8Y0COzvmWzJXgDl40KEC6cqvqgi4OB5cpgLFYK/1CvDiItXqC6/S87wfAUfPtxqfGNzlYaOjlf1IsHPPvffHgDAoEeEST4ZLZUd/RSo91/BjXY5ggWgQ4In3fyj4mUqPrInHOCLKO3wUwRsfyXpt1nEIRLrqcWeTuk7bigsbid1zD4iDRQtnIdQsyIXnFCn1I9D7ADgxEhOvR5AJosoUbu1FkJyYCi9OhQERoIx+4AX/YqUXQhtYEwKN4Cy1HntLMmtaAQpqfrT/UCoLSxeswjA5UWPPi0mjajUWxMTdVusNvt/ChMdmILK5IRMFu90BMEzFYHdg2GAgeYVHMMJIBTA7EFTx/5fpgTFXz9w/en0ZjD8kCDoKPNGwlB01BmoWQbh+AxR689mBponGJOr9OwmMu3dtJ/ylW1Tik4ElUPmR9RqII+pVhD9ychABMQ51gOIZg+/G+5mGIzLB1JJC5WhzYjhJ7IWmLDpA8jzsAafUPkB2WnFBF4iSxkq1ty7f25rv/+EQLOxs2oUdTSA9HIR9swdBlCcFe9owPC3XWDDC0ISVzsEVbSCF/sWdA5Fu4HJqankp2SeQCYYrImNalfmhpVxYrGkUS4LeSUjg8dD7+D7w/ybIfy7vlB9/HJ978zr7/45Qgajzj+4EjIK/ULHPRAOlKr/aG0AFcqCyu0GcW45Igh6JMJmhA49/U+cEssHNJhtXDC1MOya3j/sAiAGcrEtqtgjBD6wEzSDc7D8o6C8rIqAZyPk+NQoNLAZ1hR64Yl1FBY648smUYKnSg1Xwk/0DyRyArByMUobyByhCcPnOaPyoegREFS4jNfYAw+IHCjdC1J2WDZBke/OyN85J24WiXwDYPoJyYuCD238ulvuzwt6KgHf0shWKsqCFFGjB/w8HU8eeTED9wAAAAABJRU5ErkJggg==";let QR=0;const Ym=a=>{if(!a.environmentBRDFTexture){const e=a.useDelayedTextureLoading;a.useDelayedTextureLoading=!1;const t=a._blockEntityCollection;a._blockEntityCollection=!1;const i=Z.CreateFromBase64String(ZR,"EnvironmentBRDFTexture"+QR++,a,!0,!1,Z.BILINEAR_SAMPLINGMODE);a._blockEntityCollection=t;const r=a.getEngine().getLoadedTexturesCache(),s=r.indexOf(i.getInternalTexture());s!==-1&&r.splice(s,1),i.isRGBD=!0,i.wrapU=Z.CLAMP_ADDRESSMODE,i.wrapV=Z.CLAMP_ADDRESSMODE,a.environmentBRDFTexture=i,a.useDelayedTextureLoading=e,$h.ExpandRGBDTexture(i);const n=a.getEngine().onContextRestoredObservable.add(()=>{i.isRGBD=!0;const o=a.onBeforeRenderObservable.add(()=>{i.isReady()&&(a.onBeforeRenderObservable.remove(o),$h.ExpandRGBDTexture(i))})});a.onDisposeObservable.add(()=>{a.getEngine().onContextRestoredObservable.remove(n)})}return a.environmentBRDFTexture};class $R extends ji{constructor(){super(...arguments),this.BRDF_V_HEIGHT_CORRELATED=!1,this.MS_BRDF_ENERGY_CONSERVATION=!1,this.SPHERICAL_HARMONICS=!1,this.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=!1,this.MIX_IBL_RADIANCE_WITH_IRRADIANCE=!0}}class Vt extends Zi{_markAllSubMeshesAsMiscDirty(){this._internalMarkAllSubMeshesAsMiscDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRBRDF",90,new $R,t),this._useEnergyConservation=Vt.DEFAULT_USE_ENERGY_CONSERVATION,this.useEnergyConservation=Vt.DEFAULT_USE_ENERGY_CONSERVATION,this._useSmithVisibilityHeightCorrelated=Vt.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this.useSmithVisibilityHeightCorrelated=Vt.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this._useSphericalHarmonics=Vt.DEFAULT_USE_SPHERICAL_HARMONICS,this.useSphericalHarmonics=Vt.DEFAULT_USE_SPHERICAL_HARMONICS,this._useSpecularGlossinessInputEnergyConservation=Vt.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this.useSpecularGlossinessInputEnergyConservation=Vt.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this._mixIblRadianceWithIrradiance=Vt.DEFAULT_MIX_IBL_RADIANCE_WITH_IRRADIANCE,this.mixIblRadianceWithIrradiance=Vt.DEFAULT_MIX_IBL_RADIANCE_WITH_IRRADIANCE,this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16],this._enable(!0)}prepareDefines(e){e.BRDF_V_HEIGHT_CORRELATED=this._useSmithVisibilityHeightCorrelated,e.MS_BRDF_ENERGY_CONSERVATION=this._useEnergyConservation&&this._useSmithVisibilityHeightCorrelated,e.SPHERICAL_HARMONICS=this._useSphericalHarmonics,e.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=this._useSpecularGlossinessInputEnergyConservation,e.MIX_IBL_RADIANCE_WITH_IRRADIANCE=this._mixIblRadianceWithIrradiance}getClassName(){return"PBRBRDFConfiguration"}}Vt.DEFAULT_USE_ENERGY_CONSERVATION=!0;Vt.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED=!0;Vt.DEFAULT_USE_SPHERICAL_HARMONICS=!0;Vt.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION=!0;Vt.DEFAULT_MIX_IBL_RADIANCE_WITH_IRRADIANCE=!0;A([y(),j("_markAllSubMeshesAsMiscDirty")],Vt.prototype,"useEnergyConservation",void 0);A([y(),j("_markAllSubMeshesAsMiscDirty")],Vt.prototype,"useSmithVisibilityHeightCorrelated",void 0);A([y(),j("_markAllSubMeshesAsMiscDirty")],Vt.prototype,"useSphericalHarmonics",void 0);A([y(),j("_markAllSubMeshesAsMiscDirty")],Vt.prototype,"useSpecularGlossinessInputEnergyConservation",void 0);A([y(),j("_markAllSubMeshesAsMiscDirty")],Vt.prototype,"mixIblRadianceWithIrradiance",void 0);class Ls{constructor(e,t,i,r){this.name=e,this.worldAxisForNormal=t,this.worldAxisForFileX=i,this.worldAxisForFileY=r}}class Gn{static ConvertCubeMapTextureToSphericalPolynomial(e){var u;if(!e.isCube)return null;(u=e.getScene())==null||u.getEngine().flushFramebuffer();const t=e.getSize().width,i=e.readPixels(0,void 0,void 0,!1),r=e.readPixels(1,void 0,void 0,!1);let s,n;e.isRenderTarget?(s=e.readPixels(3,void 0,void 0,!1),n=e.readPixels(2,void 0,void 0,!1)):(s=e.readPixels(2,void 0,void 0,!1),n=e.readPixels(3,void 0,void 0,!1));const o=e.readPixels(4,void 0,void 0,!1),l=e.readPixels(5,void 0,void 0,!1),c=e.gammaSpace,h=5;let f=0;return(e.textureType==1||e.textureType==2)&&(f=1),new Promise(d=>{Promise.all([r,i,s,n,o,l]).then(([_,p,g,E,v,b])=>{const R={size:t,right:p,left:_,up:g,down:E,front:v,back:b,format:h,type:f,gammaSpace:c};d(this.ConvertCubeMapToSphericalPolynomial(R))})})}static _AreaElement(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}static ConvertCubeMapToSphericalPolynomial(e){const t=new yn;let i=0;const r=2/e.size,s=r,n=.5*r,o=n-1;for(let u=0;u<6;u++){const d=this._FileFaces[u],_=e[d.name];let p=o;const g=e.format===5?4:3;for(let E=0;E<e.size;E++){let v=o;for(let b=0;b<e.size;b++){const R=d.worldAxisForFileX.scale(v).add(d.worldAxisForFileY.scale(p)).add(d.worldAxisForNormal);R.normalize();const S=this._AreaElement(v-n,p-n)-this._AreaElement(v-n,p+n)-this._AreaElement(v+n,p-n)+this._AreaElement(v+n,p+n);let T=_[E*e.size*g+b*g+0],I=_[E*e.size*g+b*g+1],O=_[E*e.size*g+b*g+2];isNaN(T)&&(T=0),isNaN(I)&&(I=0),isNaN(O)&&(O=0),e.type===0&&(T/=255,I/=255,O/=255),e.gammaSpace&&(T=Math.pow(je(T),ua),I=Math.pow(je(I),ua),O=Math.pow(je(O),ua));const L=this.MAX_HDRI_VALUE;if(this.PRESERVE_CLAMPED_COLORS){const $=Math.max(T,I,O);if($>L){const J=L/$;T*=J,I*=J,O*=J}}else T=je(T,0,L),I=je(I,0,L),O=je(O,0,L);const w=new ae(T,I,O);t.addLight(R,w,S),i+=S,v+=r}p+=s}}const f=4*Math.PI*6/6/i;return t.scaleInPlace(f),t.convertIncidentRadianceToIrradiance(),t.convertIrradianceToLambertianRadiance(),Ss.FromHarmonics(t)}}Gn._FileFaces=[new Ls("right",new m(1,0,0),new m(0,0,-1),new m(0,-1,0)),new Ls("left",new m(-1,0,0),new m(0,0,1),new m(0,-1,0)),new Ls("up",new m(0,1,0),new m(1,0,0),new m(0,0,1)),new Ls("down",new m(0,-1,0),new m(1,0,0),new m(0,0,-1)),new Ls("front",new m(0,0,1),new m(1,0,0),new m(0,-1,0)),new Ls("back",new m(0,0,-1),new m(-1,0,0),new m(0,-1,0))];Gn.MAX_HDRI_VALUE=4096;Gn.PRESERVE_CLAMPED_COLORS=!1;rt.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)};Object.defineProperty(rt.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=Gn.ConvertCubeMapTextureToSphericalPolynomial(this),this._texture._sphericalPolynomialPromise===null?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then(a=>{this._texture._sphericalPolynomial=a,this._texture._sphericalPolynomialComputed=!0})),null}return null},set:function(a){this._texture&&(this._texture._sphericalPolynomial=a)},enumerable:!0,configurable:!0});class JR extends ji{constructor(){super(...arguments),this.CLEARCOAT=!1,this.CLEARCOAT_DEFAULTIOR=!1,this.CLEARCOAT_TEXTURE=!1,this.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this.CLEARCOAT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,this.CLEARCOAT_BUMP=!1,this.CLEARCOAT_BUMPDIRECTUV=0,this.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,this.CLEARCOAT_REMAP_F0=!1,this.CLEARCOAT_TINT=!1,this.CLEARCOAT_TINT_TEXTURE=!1,this.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TINT_GAMMATEXTURE=!1}}class Zt extends Zi{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRClearCoat",100,new JR,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.roughness=0,this._indexOfRefraction=Zt._DefaultIndexOfRefraction,this.indexOfRefraction=Zt._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._textureRoughness=null,this.textureRoughness=null,this._remapF0OnInterfaceChange=!0,this.remapF0OnInterfaceChange=!0,this._bumpTexture=null,this.bumpTexture=null,this._isTintEnabled=!1,this.isTintEnabled=!1,this.tintColor=ae.White(),this.tintColorAtDistance=1,this.tintThickness=1,this._tintTexture=null,this.tintTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i){if(!this._isEnabled)return!0;const r=this._material._disableBumpMap;return!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Q.ClearCoatTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&Q.ClearCoatTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking()||i.getCaps().standardDerivatives&&this._bumpTexture&&Q.ClearCoatBumpTextureEnabled&&!r&&!this._bumpTexture.isReady()||this._isTintEnabled&&this._tintTexture&&Q.ClearCoatTintTextureEnabled&&!this._tintTexture.isReadyOrNotBlocking()))}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.CLEARCOAT=!0,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.CLEARCOAT_REMAP_F0=this._remapF0OnInterfaceChange,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Q.ClearCoatTextureEnabled?ht(this._texture,e,"CLEARCOAT_TEXTURE"):e.CLEARCOAT_TEXTURE=!1,this._textureRoughness&&Q.ClearCoatTextureEnabled?ht(this._textureRoughness,e,"CLEARCOAT_TEXTURE_ROUGHNESS"):e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this._bumpTexture&&Q.ClearCoatBumpTextureEnabled?ht(this._bumpTexture,e,"CLEARCOAT_BUMP"):e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_DEFAULTIOR=this._indexOfRefraction===Zt._DefaultIndexOfRefraction,this._isTintEnabled?(e.CLEARCOAT_TINT=!0,this._tintTexture&&Q.ClearCoatTintTextureEnabled?(ht(this._tintTexture,e,"CLEARCOAT_TINT_TEXTURE"),e.CLEARCOAT_TINT_GAMMATEXTURE=this._tintTexture.gammaSpace):e.CLEARCOAT_TINT_TEXTURE=!1):(e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1))):(e.CLEARCOAT=!1,e.CLEARCOAT_TEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.CLEARCOAT_DEFAULTIOR=!1,e.CLEARCOAT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,e.CLEARCOAT_BUMPDIRECTUV=0,e.CLEARCOAT_REMAP_F0=!1,e.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TINT_GAMMATEXTURE=!1)}bindForSubMesh(e,t,i,r){var h,f,u,d;if(!this._isEnabled)return;const s=r.materialDefines,n=this._material.isFrozen,o=this._material._disableBumpMap,l=this._material._invertNormalMapX,c=this._material._invertNormalMapY;if(!e.useUbo||!n||!e.isSync){(this._texture||this._textureRoughness)&&Q.ClearCoatTextureEnabled&&(e.updateFloat4("vClearCoatInfos",((h=this._texture)==null?void 0:h.coordinatesIndex)??0,((f=this._texture)==null?void 0:f.level)??0,((u=this._textureRoughness)==null?void 0:u.coordinatesIndex)??0,((d=this._textureRoughness)==null?void 0:d.level)??0),this._texture&&ft(this._texture,e,"clearCoat"),this._textureRoughness&&!s.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&ft(this._textureRoughness,e,"clearCoatRoughness")),this._bumpTexture&&i.getCaps().standardDerivatives&&Q.ClearCoatTextureEnabled&&!o&&(e.updateFloat2("vClearCoatBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level),ft(this._bumpTexture,e,"clearCoatBump"),t._mirroredCameraPosition?e.updateFloat2("vClearCoatTangentSpaceParams",l?1:-1,c?1:-1):e.updateFloat2("vClearCoatTangentSpaceParams",l?-1:1,c?-1:1)),this._tintTexture&&Q.ClearCoatTintTextureEnabled&&(e.updateFloat2("vClearCoatTintInfos",this._tintTexture.coordinatesIndex,this._tintTexture.level),ft(this._tintTexture,e,"clearCoatTint")),e.updateFloat2("vClearCoatParams",this.intensity,this.roughness);const _=1-this._indexOfRefraction,p=1+this._indexOfRefraction,g=Math.pow(-_/p,2),E=1/this._indexOfRefraction;e.updateFloat4("vClearCoatRefractionParams",g,E,_,p),this._isTintEnabled&&(e.updateFloat4("vClearCoatTintParams",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintThickness)),e.updateFloat("clearCoatColorAtDistance",Math.max(1e-5,this.tintColorAtDistance)))}t.texturesEnabled&&(this._texture&&Q.ClearCoatTextureEnabled&&e.setTexture("clearCoatSampler",this._texture),this._textureRoughness&&!s.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&Q.ClearCoatTextureEnabled&&e.setTexture("clearCoatRoughnessSampler",this._textureRoughness),this._bumpTexture&&i.getCaps().standardDerivatives&&Q.ClearCoatBumpTextureEnabled&&!o&&e.setTexture("clearCoatBumpSampler",this._bumpTexture),this._isTintEnabled&&this._tintTexture&&Q.ClearCoatTintTextureEnabled&&e.setTexture("clearCoatTintSampler",this._tintTexture))}hasTexture(e){return this._texture===e||this._textureRoughness===e||this._bumpTexture===e||this._tintTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness),this._bumpTexture&&e.push(this._bumpTexture),this._tintTexture&&e.push(this._tintTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._tintTexture&&this._tintTexture.animations&&this._tintTexture.animations.length>0&&e.push(this._tintTexture)}dispose(e){var t,i,r,s;e&&((t=this._texture)==null||t.dispose(),(i=this._textureRoughness)==null||i.dispose(),(r=this._bumpTexture)==null||r.dispose(),(s=this._tintTexture)==null||s.dispose())}getClassName(){return"PBRClearCoatConfiguration"}addFallbacks(e,t,i){return e.CLEARCOAT_BUMP&&t.addFallback(i++,"CLEARCOAT_BUMP"),e.CLEARCOAT_TINT&&t.addFallback(i++,"CLEARCOAT_TINT"),e.CLEARCOAT&&t.addFallback(i++,"CLEARCOAT"),i}getSamplers(e){e.push("clearCoatSampler","clearCoatRoughnessSampler","clearCoatBumpSampler","clearCoatTintSampler")}getUniforms(){return{ubo:[{name:"vClearCoatParams",size:2,type:"vec2"},{name:"vClearCoatRefractionParams",size:4,type:"vec4"},{name:"vClearCoatInfos",size:4,type:"vec4"},{name:"clearCoatMatrix",size:16,type:"mat4"},{name:"clearCoatRoughnessMatrix",size:16,type:"mat4"},{name:"vClearCoatBumpInfos",size:2,type:"vec2"},{name:"vClearCoatTangentSpaceParams",size:2,type:"vec2"},{name:"clearCoatBumpMatrix",size:16,type:"mat4"},{name:"vClearCoatTintParams",size:4,type:"vec4"},{name:"clearCoatColorAtDistance",size:1,type:"float"},{name:"vClearCoatTintInfos",size:2,type:"vec2"},{name:"clearCoatTintMatrix",size:16,type:"mat4"}]}}}Zt._DefaultIndexOfRefraction=1.5;A([y(),j("_markAllSubMeshesAsTexturesDirty")],Zt.prototype,"isEnabled",void 0);A([y()],Zt.prototype,"intensity",void 0);A([y()],Zt.prototype,"roughness",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],Zt.prototype,"indexOfRefraction",void 0);A([Je(),j("_markAllSubMeshesAsTexturesDirty")],Zt.prototype,"texture",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],Zt.prototype,"useRoughnessFromMainTexture",void 0);A([Je(),j("_markAllSubMeshesAsTexturesDirty")],Zt.prototype,"textureRoughness",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],Zt.prototype,"remapF0OnInterfaceChange",void 0);A([Je(),j("_markAllSubMeshesAsTexturesDirty")],Zt.prototype,"bumpTexture",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],Zt.prototype,"isTintEnabled",void 0);A([Qt()],Zt.prototype,"tintColor",void 0);A([y()],Zt.prototype,"tintColorAtDistance",void 0);A([y()],Zt.prototype,"tintThickness",void 0);A([Je(),j("_markAllSubMeshesAsTexturesDirty")],Zt.prototype,"tintTexture",void 0);class eC extends ji{constructor(){super(...arguments),this.IRIDESCENCE=!1,this.IRIDESCENCE_TEXTURE=!1,this.IRIDESCENCE_TEXTUREDIRECTUV=0,this.IRIDESCENCE_THICKNESS_TEXTURE=!1,this.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0}}class Si extends Zi{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRIridescence",110,new eC,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.minimumThickness=Si._DefaultMinimumThickness,this.maximumThickness=Si._DefaultMaximumThickness,this.indexOfRefraction=Si._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._thicknessTexture=null,this.thicknessTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Q.IridescenceTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._thicknessTexture&&Q.IridescenceTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())):!0}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.IRIDESCENCE=!0,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Q.IridescenceTextureEnabled?ht(this._texture,e,"IRIDESCENCE_TEXTURE"):e.IRIDESCENCE_TEXTURE=!1,this._thicknessTexture&&Q.IridescenceTextureEnabled?ht(this._thicknessTexture,e,"IRIDESCENCE_THICKNESS_TEXTURE"):e.IRIDESCENCE_THICKNESS_TEXTURE=!1)):(e.IRIDESCENCE=!1,e.IRIDESCENCE_TEXTURE=!1,e.IRIDESCENCE_THICKNESS_TEXTURE=!1,e.IRIDESCENCE_TEXTUREDIRECTUV=0,e.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0)}bindForSubMesh(e,t){var r,s,n,o;if(!this._isEnabled)return;const i=this._material.isFrozen;(!e.useUbo||!i||!e.isSync)&&((this._texture||this._thicknessTexture)&&Q.IridescenceTextureEnabled&&(e.updateFloat4("vIridescenceInfos",((r=this._texture)==null?void 0:r.coordinatesIndex)??0,((s=this._texture)==null?void 0:s.level)??0,((n=this._thicknessTexture)==null?void 0:n.coordinatesIndex)??0,((o=this._thicknessTexture)==null?void 0:o.level)??0),this._texture&&ft(this._texture,e,"iridescence"),this._thicknessTexture&&ft(this._thicknessTexture,e,"iridescenceThickness")),e.updateFloat4("vIridescenceParams",this.intensity,this.indexOfRefraction,this.minimumThickness,this.maximumThickness)),t.texturesEnabled&&(this._texture&&Q.IridescenceTextureEnabled&&e.setTexture("iridescenceSampler",this._texture),this._thicknessTexture&&Q.IridescenceTextureEnabled&&e.setTexture("iridescenceThicknessSampler",this._thicknessTexture))}hasTexture(e){return this._texture===e||this._thicknessTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._thicknessTexture&&e.push(this._thicknessTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture)}dispose(e){var t,i;e&&((t=this._texture)==null||t.dispose(),(i=this._thicknessTexture)==null||i.dispose())}getClassName(){return"PBRIridescenceConfiguration"}addFallbacks(e,t,i){return e.IRIDESCENCE&&t.addFallback(i++,"IRIDESCENCE"),i}getSamplers(e){e.push("iridescenceSampler","iridescenceThicknessSampler")}getUniforms(){return{ubo:[{name:"vIridescenceParams",size:4,type:"vec4"},{name:"vIridescenceInfos",size:4,type:"vec4"},{name:"iridescenceMatrix",size:16,type:"mat4"},{name:"iridescenceThicknessMatrix",size:16,type:"mat4"}]}}}Si._DefaultMinimumThickness=100;Si._DefaultMaximumThickness=400;Si._DefaultIndexOfRefraction=1.3;A([y(),j("_markAllSubMeshesAsTexturesDirty")],Si.prototype,"isEnabled",void 0);A([y()],Si.prototype,"intensity",void 0);A([y()],Si.prototype,"minimumThickness",void 0);A([y()],Si.prototype,"maximumThickness",void 0);A([y()],Si.prototype,"indexOfRefraction",void 0);A([Je(),j("_markAllSubMeshesAsTexturesDirty")],Si.prototype,"texture",void 0);A([Je(),j("_markAllSubMeshesAsTexturesDirty")],Si.prototype,"thicknessTexture",void 0);class tC extends ji{constructor(){super(...arguments),this.ANISOTROPIC=!1,this.ANISOTROPIC_TEXTURE=!1,this.ANISOTROPIC_TEXTUREDIRECTUV=0,this.ANISOTROPIC_LEGACY=!1,this.MAINUV1=!1}}class nn extends Zi{set angle(e){this.direction.x=Math.cos(e),this.direction.y=Math.sin(e)}get angle(){return Math.atan2(this.direction.y,this.direction.x)}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markAllSubMeshesAsMiscDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsMiscDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRAnisotropic",110,new tC,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.direction=new ne(1,0),this._texture=null,this.texture=null,this._legacy=!1,this.legacy=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16]}isReadyForSubMesh(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&this._texture&&Q.AnisotropicTextureEnabled&&!this._texture.isReadyOrNotBlocking()):!0}prepareDefinesBeforeAttributes(e,t,i){this._isEnabled?(e.ANISOTROPIC=this._isEnabled,this._isEnabled&&!i.isVerticesDataPresent(x.TangentKind)&&(e._needUVs=!0,e.MAINUV1=!0),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Q.AnisotropicTextureEnabled?ht(this._texture,e,"ANISOTROPIC_TEXTURE"):e.ANISOTROPIC_TEXTURE=!1),e._areMiscDirty&&(e.ANISOTROPIC_LEGACY=this._legacy)):(e.ANISOTROPIC=!1,e.ANISOTROPIC_TEXTURE=!1,e.ANISOTROPIC_TEXTUREDIRECTUV=0,e.ANISOTROPIC_LEGACY=!1)}bindForSubMesh(e,t){if(!this._isEnabled)return;const i=this._material.isFrozen;(!e.useUbo||!i||!e.isSync)&&(this._texture&&Q.AnisotropicTextureEnabled&&(e.updateFloat2("vAnisotropyInfos",this._texture.coordinatesIndex,this._texture.level),ft(this._texture,e,"anisotropy")),e.updateFloat3("vAnisotropy",this.direction.x,this.direction.y,this.intensity)),t.texturesEnabled&&this._texture&&Q.AnisotropicTextureEnabled&&e.setTexture("anisotropySampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){e&&this._texture&&this._texture.dispose()}getClassName(){return"PBRAnisotropicConfiguration"}addFallbacks(e,t,i){return e.ANISOTROPIC&&t.addFallback(i++,"ANISOTROPIC"),i}getSamplers(e){e.push("anisotropySampler")}getUniforms(){return{ubo:[{name:"vAnisotropy",size:3,type:"vec3"},{name:"vAnisotropyInfos",size:2,type:"vec2"},{name:"anisotropyMatrix",size:16,type:"mat4"}]}}parse(e,t,i){super.parse(e,t,i),e.legacy===void 0&&(this.legacy=!0)}}A([y(),j("_markAllSubMeshesAsTexturesDirty")],nn.prototype,"isEnabled",void 0);A([y()],nn.prototype,"intensity",void 0);A([Ec()],nn.prototype,"direction",void 0);A([Je(),j("_markAllSubMeshesAsTexturesDirty")],nn.prototype,"texture",void 0);A([y(),j("_markAllSubMeshesAsMiscDirty")],nn.prototype,"legacy",void 0);class iC extends ji{constructor(){super(...arguments),this.SHEEN=!1,this.SHEEN_TEXTURE=!1,this.SHEEN_GAMMATEXTURE=!1,this.SHEEN_TEXTURE_ROUGHNESS=!1,this.SHEEN_TEXTUREDIRECTUV=0,this.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0,this.SHEEN_LINKWITHALBEDO=!1,this.SHEEN_ROUGHNESS=!1,this.SHEEN_ALBEDOSCALING=!1,this.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1}}class Sr extends Zi{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"Sheen",120,new iC,t),this._isEnabled=!1,this.isEnabled=!1,this._linkSheenWithAlbedo=!1,this.linkSheenWithAlbedo=!1,this.intensity=1,this.color=ae.White(),this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._roughness=null,this.roughness=null,this._textureRoughness=null,this.textureRoughness=null,this._albedoScaling=!1,this.albedoScaling=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Q.SheenTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&Q.SheenTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking())):!0}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.SHEEN=!0,e.SHEEN_LINKWITHALBEDO=this._linkSheenWithAlbedo,e.SHEEN_ROUGHNESS=this._roughness!==null,e.SHEEN_ALBEDOSCALING=this._albedoScaling,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Q.SheenTextureEnabled?(ht(this._texture,e,"SHEEN_TEXTURE"),e.SHEEN_GAMMATEXTURE=this._texture.gammaSpace):e.SHEEN_TEXTURE=!1,this._textureRoughness&&Q.SheenTextureEnabled?ht(this._textureRoughness,e,"SHEEN_TEXTURE_ROUGHNESS"):e.SHEEN_TEXTURE_ROUGHNESS=!1)):(e.SHEEN=!1,e.SHEEN_TEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS=!1,e.SHEEN_LINKWITHALBEDO=!1,e.SHEEN_ROUGHNESS=!1,e.SHEEN_ALBEDOSCALING=!1,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.SHEEN_GAMMATEXTURE=!1,e.SHEEN_TEXTUREDIRECTUV=0,e.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0)}bindForSubMesh(e,t,i,r){var o,l,c,h;if(!this._isEnabled)return;const s=r.materialDefines,n=this._material.isFrozen;(!e.useUbo||!n||!e.isSync)&&((this._texture||this._textureRoughness)&&Q.SheenTextureEnabled&&(e.updateFloat4("vSheenInfos",((o=this._texture)==null?void 0:o.coordinatesIndex)??0,((l=this._texture)==null?void 0:l.level)??0,((c=this._textureRoughness)==null?void 0:c.coordinatesIndex)??0,((h=this._textureRoughness)==null?void 0:h.level)??0),this._texture&&ft(this._texture,e,"sheen"),this._textureRoughness&&!s.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&ft(this._textureRoughness,e,"sheenRoughness")),e.updateFloat4("vSheenColor",this.color.r,this.color.g,this.color.b,this.intensity),this._roughness!==null&&e.updateFloat("vSheenRoughness",this._roughness)),t.texturesEnabled&&(this._texture&&Q.SheenTextureEnabled&&e.setTexture("sheenSampler",this._texture),this._textureRoughness&&!s.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&Q.SheenTextureEnabled&&e.setTexture("sheenRoughnessSampler",this._textureRoughness))}hasTexture(e){return this._texture===e||this._textureRoughness===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness)}dispose(e){var t,i;e&&((t=this._texture)==null||t.dispose(),(i=this._textureRoughness)==null||i.dispose())}getClassName(){return"PBRSheenConfiguration"}addFallbacks(e,t,i){return e.SHEEN&&t.addFallback(i++,"SHEEN"),i}getSamplers(e){e.push("sheenSampler","sheenRoughnessSampler")}getUniforms(){return{ubo:[{name:"vSheenColor",size:4,type:"vec4"},{name:"vSheenRoughness",size:1,type:"float"},{name:"vSheenInfos",size:4,type:"vec4"},{name:"sheenMatrix",size:16,type:"mat4"},{name:"sheenRoughnessMatrix",size:16,type:"mat4"}]}}}A([y(),j("_markAllSubMeshesAsTexturesDirty")],Sr.prototype,"isEnabled",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],Sr.prototype,"linkSheenWithAlbedo",void 0);A([y()],Sr.prototype,"intensity",void 0);A([Qt()],Sr.prototype,"color",void 0);A([Je(),j("_markAllSubMeshesAsTexturesDirty")],Sr.prototype,"texture",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],Sr.prototype,"useRoughnessFromMainTexture",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],Sr.prototype,"roughness",void 0);A([Je(),j("_markAllSubMeshesAsTexturesDirty")],Sr.prototype,"textureRoughness",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],Sr.prototype,"albedoScaling",void 0);class rC extends ji{constructor(){super(...arguments),this.SUBSURFACE=!1,this.SS_REFRACTION=!1,this.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=!1,this.SS_TRANSLUCENCY=!1,this.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=!1,this.SS_SCATTERING=!1,this.SS_DISPERSION=!1,this.SS_THICKNESSANDMASK_TEXTURE=!1,this.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,this.SS_HAS_THICKNESS=!1,this.SS_REFRACTIONINTENSITY_TEXTURE=!1,this.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,this.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYCOLOR_TEXTURE=!1,this.SS_TRANSLUCENCYCOLOR_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYCOLOR_TEXTURE_GAMMA=!1,this.SS_REFRACTIONMAP_3D=!1,this.SS_REFRACTIONMAP_OPPOSITEZ=!1,this.SS_LODINREFRACTIONALPHA=!1,this.SS_GAMMAREFRACTION=!1,this.SS_RGBDREFRACTION=!1,this.SS_LINEARSPECULARREFRACTION=!1,this.SS_LINKREFRACTIONTOTRANSPARENCY=!1,this.SS_ALBEDOFORREFRACTIONTINT=!1,this.SS_ALBEDOFORTRANSLUCENCYTINT=!1,this.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.SS_USE_THICKNESS_AS_DEPTH=!1,this.SS_USE_GLTF_TEXTURES=!1}}class Rt extends Zi{get scatteringDiffusionProfile(){return this._scene.subSurfaceConfiguration?this._scene.subSurfaceConfiguration.ssDiffusionProfileColors[this._scatteringDiffusionProfileIndex]:null}set scatteringDiffusionProfile(e){this._scene.enableSubSurfaceForPrePass()&&e&&(this._scatteringDiffusionProfileIndex=this._scene.subSurfaceConfiguration.addDiffusionProfile(e))}get volumeIndexOfRefraction(){return this._volumeIndexOfRefraction>=1?this._volumeIndexOfRefraction:this._indexOfRefraction}set volumeIndexOfRefraction(e){e>=1?this._volumeIndexOfRefraction=e:this._volumeIndexOfRefraction=-1}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markScenePrePassDirty(){this._enable(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled),this._internalMarkAllSubMeshesAsTexturesDirty(),this._internalMarkScenePrePassDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRSubSurface",130,new rC,t),this._isRefractionEnabled=!1,this.isRefractionEnabled=!1,this._isTranslucencyEnabled=!1,this.isTranslucencyEnabled=!1,this._isDispersionEnabled=!1,this.isDispersionEnabled=!1,this._isScatteringEnabled=!1,this.isScatteringEnabled=!1,this._scatteringDiffusionProfileIndex=0,this.refractionIntensity=1,this.translucencyIntensity=1,this.useAlbedoToTintRefraction=!1,this.useAlbedoToTintTranslucency=!1,this._thicknessTexture=null,this.thicknessTexture=null,this._refractionTexture=null,this.refractionTexture=null,this._indexOfRefraction=1.5,this.indexOfRefraction=1.5,this._volumeIndexOfRefraction=-1,this._invertRefractionY=!1,this.invertRefractionY=!1,this._linkRefractionWithTransparency=!1,this.linkRefractionWithTransparency=!1,this.minimumThickness=0,this.maximumThickness=1,this.useThicknessAsDepth=!1,this.tintColor=ae.White(),this.tintColorAtDistance=1,this.dispersion=0,this.diffusionDistance=ae.White(),this._useMaskFromThicknessTexture=!1,this.useMaskFromThicknessTexture=!1,this._refractionIntensityTexture=null,this.refractionIntensityTexture=null,this._translucencyIntensityTexture=null,this.translucencyIntensityTexture=null,this.translucencyColor=null,this._translucencyColorTexture=null,this.translucencyColorTexture=null,this._useGltfStyleTextures=!0,this.useGltfStyleTextures=!0,this._scene=e.getScene(),this.registerForExtraEvents=!0,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkScenePrePassDirty=e._dirtyCallbacks[32]}isReadyForSubMesh(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return!0;if(e._areTexturesDirty&&t.texturesEnabled){if(this._thicknessTexture&&Q.ThicknessTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking()||this._translucencyColorTexture&&Q.TranslucencyColorTextureEnabled&&!this._translucencyColorTexture.isReadyOrNotBlocking()||this._translucencyIntensityTexture&&Q.TranslucencyIntensityTextureEnabled&&!this._translucencyIntensityTexture.isReadyOrNotBlocking())return!1;const i=this._getRefractionTexture(t);if(i&&Q.RefractionTextureEnabled&&!i.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled){e.SUBSURFACE=!1,e.SS_DISPERSION=!1,e.SS_TRANSLUCENCY=!1,e.SS_SCATTERING=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,e.SS_HAS_THICKNESS=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,e.SS_REFRACTIONMAP_3D=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1,e.SS_USE_GLTF_TEXTURES=!1,e.SS_TRANSLUCENCYCOLOR_TEXTURE=!1,e.SS_TRANSLUCENCYCOLOR_TEXTUREDIRECTUV=0,e.SS_TRANSLUCENCYCOLOR_TEXTURE_GAMMA=!1;return}if(e._areTexturesDirty){if(e.SUBSURFACE=!0,e.SS_DISPERSION=this._isDispersionEnabled,e.SS_TRANSLUCENCY=this._isTranslucencyEnabled,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_SCATTERING=this._isScatteringEnabled,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_HAS_THICKNESS=!1,e.SS_USE_GLTF_TEXTURES=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_REFRACTIONMAP_3D=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1,e.SS_TRANSLUCENCYCOLOR_TEXTURE=!1,e._areTexturesDirty&&t.texturesEnabled&&(this._thicknessTexture&&Q.ThicknessTextureEnabled&&ht(this._thicknessTexture,e,"SS_THICKNESSANDMASK_TEXTURE"),this._refractionIntensityTexture&&Q.RefractionIntensityTextureEnabled&&ht(this._refractionIntensityTexture,e,"SS_REFRACTIONINTENSITY_TEXTURE"),this._translucencyIntensityTexture&&Q.TranslucencyIntensityTextureEnabled&&ht(this._translucencyIntensityTexture,e,"SS_TRANSLUCENCYINTENSITY_TEXTURE"),this._translucencyColorTexture&&Q.TranslucencyColorTextureEnabled&&(ht(this._translucencyColorTexture,e,"SS_TRANSLUCENCYCOLOR_TEXTURE"),e.SS_TRANSLUCENCYCOLOR_TEXTURE_GAMMA=this._translucencyColorTexture.gammaSpace)),e.SS_HAS_THICKNESS=this.maximumThickness-this.minimumThickness!==0,e.SS_USE_GLTF_TEXTURES=this._useGltfStyleTextures,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=this._useMaskFromThicknessTexture&&!this._refractionIntensityTexture,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=this._useMaskFromThicknessTexture&&!this._translucencyIntensityTexture,this._isRefractionEnabled&&t.texturesEnabled){const i=this._getRefractionTexture(t);i&&Q.RefractionTextureEnabled&&(e.SS_REFRACTION=!0,e.SS_REFRACTIONMAP_3D=i.isCube,e.SS_GAMMAREFRACTION=i.gammaSpace,e.SS_RGBDREFRACTION=i.isRGBD,e.SS_LINEARSPECULARREFRACTION=i.linearSpecularLOD,e.SS_REFRACTIONMAP_OPPOSITEZ=this._scene.useRightHandedSystem&&i.isCube?!i.invertZ:i.invertZ,e.SS_LODINREFRACTIONALPHA=i.lodLevelInAlpha,e.SS_LINKREFRACTIONTOTRANSPARENCY=this._linkRefractionWithTransparency,e.SS_ALBEDOFORREFRACTIONTINT=this.useAlbedoToTintRefraction,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=i.isCube&&i.boundingBoxSize,e.SS_USE_THICKNESS_AS_DEPTH=this.useThicknessAsDepth)}this._isTranslucencyEnabled&&(e.SS_ALBEDOFORTRANSLUCENCYTINT=this.useAlbedoToTintTranslucency)}}hardBindForSubMesh(e,t,i,r){if(!(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled))if(this.maximumThickness===0&&this.minimumThickness===0)e.updateFloat2("vThicknessParam",0,0);else{r.getRenderingMesh().getWorldMatrix().decompose(F.Vector3[0]);const s=Math.max(Math.abs(F.Vector3[0].x),Math.abs(F.Vector3[0].y),Math.abs(F.Vector3[0].z));e.updateFloat2("vThicknessParam",this.minimumThickness*s,(this.maximumThickness-this.minimumThickness)*s)}}bindForSubMesh(e,t,i,r){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return;const s=r.materialDefines,n=this._material.isFrozen,o=this._material.realTimeFiltering,l=s.LODBASEDMICROSFURACE,c=this._getRefractionTexture(t);if(!e.useUbo||!n||!e.isSync){if(this._thicknessTexture&&Q.ThicknessTextureEnabled&&(e.updateFloat2("vThicknessInfos",this._thicknessTexture.coordinatesIndex,this._thicknessTexture.level),ft(this._thicknessTexture,e,"thickness")),this._refractionIntensityTexture&&Q.RefractionIntensityTextureEnabled&&s.SS_REFRACTIONINTENSITY_TEXTURE&&(e.updateFloat2("vRefractionIntensityInfos",this._refractionIntensityTexture.coordinatesIndex,this._refractionIntensityTexture.level),ft(this._refractionIntensityTexture,e,"refractionIntensity")),this._translucencyColorTexture&&Q.TranslucencyColorTextureEnabled&&s.SS_TRANSLUCENCYCOLOR_TEXTURE&&(e.updateFloat2("vTranslucencyColorInfos",this._translucencyColorTexture.coordinatesIndex,this._translucencyColorTexture.level),ft(this._translucencyColorTexture,e,"translucencyColor")),this._translucencyIntensityTexture&&Q.TranslucencyIntensityTextureEnabled&&s.SS_TRANSLUCENCYINTENSITY_TEXTURE&&(e.updateFloat2("vTranslucencyIntensityInfos",this._translucencyIntensityTexture.coordinatesIndex,this._translucencyIntensityTexture.level),ft(this._translucencyIntensityTexture,e,"translucencyIntensity")),c&&Q.RefractionTextureEnabled){e.updateMatrix("refractionMatrix",c.getRefractionTextureMatrix());let h=1;c.isCube||c.depth&&(h=c.depth);const f=c.getSize().width,u=this.volumeIndexOfRefraction;if(e.updateFloat4("vRefractionInfos",c.level,1/u,h,this._invertRefractionY?-1:1),e.updateFloat4("vRefractionMicrosurfaceInfos",f,c.lodGenerationScale,c.lodGenerationOffset,1/this.indexOfRefraction),o&&e.updateFloat2("vRefractionFilteringInfo",f,Math.log2(f)),c.boundingBoxSize){const d=c;e.updateVector3("vRefractionPosition",d.boundingBoxPosition),e.updateVector3("vRefractionSize",d.boundingBoxSize)}}this._isScatteringEnabled&&e.updateFloat("scatteringDiffusionProfile",this._scatteringDiffusionProfileIndex),e.updateColor3("vDiffusionDistance",this.diffusionDistance),e.updateFloat4("vTintColor",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintColorAtDistance)),e.updateColor4("vTranslucencyColor",this.translucencyColor??this.tintColor,0),e.updateFloat3("vSubSurfaceIntensity",this.refractionIntensity,this.translucencyIntensity,0),e.updateFloat("dispersion",this.dispersion)}t.texturesEnabled&&(this._thicknessTexture&&Q.ThicknessTextureEnabled&&e.setTexture("thicknessSampler",this._thicknessTexture),this._refractionIntensityTexture&&Q.RefractionIntensityTextureEnabled&&s.SS_REFRACTIONINTENSITY_TEXTURE&&e.setTexture("refractionIntensitySampler",this._refractionIntensityTexture),this._translucencyIntensityTexture&&Q.TranslucencyIntensityTextureEnabled&&s.SS_TRANSLUCENCYINTENSITY_TEXTURE&&e.setTexture("translucencyIntensitySampler",this._translucencyIntensityTexture),this._translucencyColorTexture&&Q.TranslucencyColorTextureEnabled&&s.SS_TRANSLUCENCYCOLOR_TEXTURE&&e.setTexture("translucencyColorSampler",this._translucencyColorTexture),c&&Q.RefractionTextureEnabled&&(l?e.setTexture("refractionSampler",c):(e.setTexture("refractionSampler",c._lodTextureMid||c),e.setTexture("refractionSamplerLow",c._lodTextureLow||c),e.setTexture("refractionSamplerHigh",c._lodTextureHigh||c))))}_getRefractionTexture(e){return this._refractionTexture?this._refractionTexture:this._isRefractionEnabled?e.environmentTexture:null}get disableAlphaBlending(){return this._isRefractionEnabled&&this._linkRefractionWithTransparency}fillRenderTargetTextures(e){Q.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&e.push(this._refractionTexture)}hasTexture(e){return this._thicknessTexture===e||this._refractionTexture===e||this._refractionIntensityTexture===e||this._translucencyIntensityTexture===e||this._translucencyColorTexture===e}hasRenderTargetTextures(){return!!(Q.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)}getActiveTextures(e){this._thicknessTexture&&e.push(this._thicknessTexture),this._refractionTexture&&e.push(this._refractionTexture),this._translucencyColorTexture&&e.push(this._translucencyColorTexture),this._translucencyIntensityTexture&&e.push(this._translucencyIntensityTexture)}getAnimatables(e){this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),this._translucencyColorTexture&&this._translucencyColorTexture.animations&&this._translucencyColorTexture.animations.length>0&&e.push(this._translucencyColorTexture),this._translucencyIntensityTexture&&this._translucencyIntensityTexture.animations&&this._translucencyIntensityTexture.animations.length>0&&e.push(this._translucencyIntensityTexture)}dispose(e){e&&(this._thicknessTexture&&this._thicknessTexture.dispose(),this._refractionTexture&&this._refractionTexture.dispose(),this._translucencyColorTexture&&this._translucencyColorTexture.dispose(),this._translucencyIntensityTexture&&this._translucencyIntensityTexture.dispose())}getClassName(){return"PBRSubSurfaceConfiguration"}addFallbacks(e,t,i){return e.SS_SCATTERING&&t.addFallback(i++,"SS_SCATTERING"),e.SS_TRANSLUCENCY&&t.addFallback(i++,"SS_TRANSLUCENCY"),i}getSamplers(e){e.push("thicknessSampler","refractionIntensitySampler","translucencyIntensitySampler","refractionSampler","refractionSamplerLow","refractionSamplerHigh","translucencyColorSampler")}getUniforms(){return{ubo:[{name:"vRefractionMicrosurfaceInfos",size:4,type:"vec4"},{name:"vRefractionFilteringInfo",size:2,type:"vec2"},{name:"vTranslucencyIntensityInfos",size:2,type:"vec2"},{name:"vRefractionInfos",size:4,type:"vec4"},{name:"refractionMatrix",size:16,type:"mat4"},{name:"vThicknessInfos",size:2,type:"vec2"},{name:"vRefractionIntensityInfos",size:2,type:"vec2"},{name:"thicknessMatrix",size:16,type:"mat4"},{name:"refractionIntensityMatrix",size:16,type:"mat4"},{name:"translucencyIntensityMatrix",size:16,type:"mat4"},{name:"vThicknessParam",size:2,type:"vec2"},{name:"vDiffusionDistance",size:3,type:"vec3"},{name:"vTintColor",size:4,type:"vec4"},{name:"vSubSurfaceIntensity",size:3,type:"vec3"},{name:"vRefractionPosition",size:3,type:"vec3"},{name:"vRefractionSize",size:3,type:"vec3"},{name:"scatteringDiffusionProfile",size:1,type:"float"},{name:"dispersion",size:1,type:"float"},{name:"vTranslucencyColor",size:4,type:"vec4"},{name:"vTranslucencyColorInfos",size:2,type:"vec2"},{name:"translucencyColorMatrix",size:16,type:"mat4"}]}}}A([y(),j("_markAllSubMeshesAsTexturesDirty")],Rt.prototype,"isRefractionEnabled",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],Rt.prototype,"isTranslucencyEnabled",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],Rt.prototype,"isDispersionEnabled",void 0);A([y(),j("_markScenePrePassDirty")],Rt.prototype,"isScatteringEnabled",void 0);A([y()],Rt.prototype,"_scatteringDiffusionProfileIndex",void 0);A([y()],Rt.prototype,"refractionIntensity",void 0);A([y()],Rt.prototype,"translucencyIntensity",void 0);A([y()],Rt.prototype,"useAlbedoToTintRefraction",void 0);A([y()],Rt.prototype,"useAlbedoToTintTranslucency",void 0);A([Je(),j("_markAllSubMeshesAsTexturesDirty")],Rt.prototype,"thicknessTexture",void 0);A([Je(),j("_markAllSubMeshesAsTexturesDirty")],Rt.prototype,"refractionTexture",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],Rt.prototype,"indexOfRefraction",void 0);A([y()],Rt.prototype,"_volumeIndexOfRefraction",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],Rt.prototype,"volumeIndexOfRefraction",null);A([y(),j("_markAllSubMeshesAsTexturesDirty")],Rt.prototype,"invertRefractionY",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],Rt.prototype,"linkRefractionWithTransparency",void 0);A([y()],Rt.prototype,"minimumThickness",void 0);A([y()],Rt.prototype,"maximumThickness",void 0);A([y()],Rt.prototype,"useThicknessAsDepth",void 0);A([Qt()],Rt.prototype,"tintColor",void 0);A([y()],Rt.prototype,"tintColorAtDistance",void 0);A([y()],Rt.prototype,"dispersion",void 0);A([Qt()],Rt.prototype,"diffusionDistance",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],Rt.prototype,"useMaskFromThicknessTexture",void 0);A([Je(),j("_markAllSubMeshesAsTexturesDirty")],Rt.prototype,"refractionIntensityTexture",void 0);A([Je(),j("_markAllSubMeshesAsTexturesDirty")],Rt.prototype,"translucencyIntensityTexture",void 0);A([Qt()],Rt.prototype,"translucencyColor",void 0);A([Je(),j("_markAllSubMeshesAsTexturesDirty")],Rt.prototype,"translucencyColorTexture",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],Rt.prototype,"useGltfStyleTextures",void 0);const Ns={effect:null,subMesh:null};class Jh extends ji{constructor(e){super(e),this.PBR=!0,this.NUM_SAMPLES="0",this.REALTIME_FILTERING=!1,this.IBL_CDF_FILTERING=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.ALBEDO=!1,this.GAMMAALBEDO=!1,this.ALBEDODIRECTUV=0,this.VERTEXCOLOR=!1,this.BASEWEIGHT=!1,this.BASEWEIGHTDIRECTUV=0,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.AMBIENTINGRAYSCALE=!1,this.OPACITY=!1,this.VERTEXALPHA=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHABLEND=!1,this.ALPHAFROMALBEDO=!1,this.ALPHATESTVALUE="0.5",this.SPECULAROVERALPHA=!1,this.RADIANCEOVERALPHA=!1,this.ALPHAFRESNEL=!1,this.LINEARALPHAFRESNEL=!1,this.PREMULTIPLYALPHA=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.GAMMAEMISSIVE=!1,this.REFLECTIVITY=!1,this.REFLECTIVITY_GAMMA=!1,this.REFLECTIVITYDIRECTUV=0,this.SPECULARTERM=!1,this.MICROSURFACEFROMREFLECTIVITYMAP=!1,this.MICROSURFACEAUTOMATIC=!1,this.LODBASEDMICROSFURACE=!1,this.MICROSURFACEMAP=!1,this.MICROSURFACEMAPDIRECTUV=0,this.METALLICWORKFLOW=!1,this.ROUGHNESSSTOREINMETALMAPALPHA=!1,this.ROUGHNESSSTOREINMETALMAPGREEN=!1,this.METALLNESSSTOREINMETALMAPBLUE=!1,this.AOSTOREINMETALMAPRED=!1,this.METALLIC_REFLECTANCE=!1,this.METALLIC_REFLECTANCE_GAMMA=!1,this.METALLIC_REFLECTANCEDIRECTUV=0,this.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=!1,this.REFLECTANCE=!1,this.REFLECTANCE_GAMMA=!1,this.REFLECTANCEDIRECTUV=0,this.ENVIRONMENTBRDF=!1,this.ENVIRONMENTBRDF_RGBD=!1,this.NORMAL=!1,this.TANGENT=!1,this.BUMP=!1,this.BUMPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.PARALLAX=!1,this.PARALLAX_RHS=!1,this.PARALLAXOCCLUSION=!1,this.NORMALXYSCALE=!0,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.USELIGHTMAPASSHADOWMAP=!1,this.GAMMALIGHTMAP=!1,this.RGBDLIGHTMAP=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.USESPHERICALFROMREFLECTIONMAP=!1,this.USEIRRADIANCEMAP=!1,this.USESPHERICALINVERTEX=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.LINEARSPECULARREFLECTION=!1,this.RADIANCEOCCLUSION=!1,this.HORIZONOCCLUSION=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.PREPASS=!1,this.PREPASS_COLOR=!1,this.PREPASS_COLOR_INDEX=-1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO=!1,this.PREPASS_ALBEDO_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_SCREENSPACE_DEPTH=!1,this.PREPASS_SCREENSPACE_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_NORMAL_WORLDSPACE=!1,this.PREPASS_WORLD_NORMAL=!1,this.PREPASS_WORLD_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_LOCAL_POSITION=!1,this.PREPASS_LOCAL_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_VELOCITY_LINEAR=!1,this.PREPASS_VELOCITY_LINEAR_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.NONUNIFORMSCALING=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_POSITION=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.MORPHTARGETS_UV2=!1,this.MORPHTARGETS_COLOR=!1,this.MORPHTARGETTEXTURE_HASPOSITIONS=!1,this.MORPHTARGETTEXTURE_HASNORMALS=!1,this.MORPHTARGETTEXTURE_HASTANGENTS=!1,this.MORPHTARGETTEXTURE_HASUVS=!1,this.MORPHTARGETTEXTURE_HASUV2S=!1,this.MORPHTARGETTEXTURE_HASCOLORS=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.USEPHYSICALLIGHTFALLOFF=!1,this.USEGLTFLIGHTFALLOFF=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.LOGARITHMICDEPTH=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.AREALIGHTSUPPORTED=!0,this.FORCENORMALFORWARD=!1,this.SPECULARAA=!1,this.UNLIT=!1,this.DECAL_AFTER_DETAIL=!1,this.DEBUGMODE=0,this.rebuild()}reset(){super.reset(),this.ALPHATESTVALUE="0.5",this.PBR=!0,this.NORMALXYSCALE=!0}}class ut extends Un{get realTimeFiltering(){return this._realTimeFiltering}set realTimeFiltering(e){this._realTimeFiltering=e,this.markAsDirty(1)}get realTimeFilteringQuality(){return this._realTimeFilteringQuality}set realTimeFilteringQuality(e){this._realTimeFilteringQuality=e,this.markAsDirty(1)}get canRenderToMRT(){return!0}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}constructor(e,t,i=!1){super(e,t,void 0,i||ut.ForceGLSL),this._directIntensity=1,this._emissiveIntensity=1,this._environmentIntensity=1,this._specularIntensity=1,this._lightingInfos=new Fe(this._directIntensity,this._emissiveIntensity,this._environmentIntensity,this._specularIntensity),this._disableBumpMap=!1,this._albedoTexture=null,this._baseWeightTexture=null,this._ambientTexture=null,this._ambientTextureStrength=1,this._ambientTextureImpactOnAnalyticalLights=ut.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._reflectivityTexture=null,this._metallicTexture=null,this._metallic=null,this._roughness=null,this._metallicF0Factor=1,this._metallicReflectanceColor=ae.White(),this._useOnlyMetallicFromMetallicReflectanceTexture=!1,this._metallicReflectanceTexture=null,this._reflectanceTexture=null,this._microSurfaceTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._ambientColor=new ae(0,0,0),this._albedoColor=new ae(1,1,1),this._baseWeight=1,this._reflectivityColor=new ae(1,1,1),this._reflectionColor=new ae(1,1,1),this._emissiveColor=new ae(0,0,0),this._microSurface=.9,this._useLightmapAsShadowmap=!1,this._useHorizonOcclusion=!0,this._useRadianceOcclusion=!0,this._useAlphaFromAlbedoTexture=!1,this._useSpecularOverAlpha=!0,this._useMicroSurfaceFromReflectivityMapAlpha=!1,this._useRoughnessFromMetallicTextureAlpha=!0,this._useRoughnessFromMetallicTextureGreen=!1,this._useMetallnessFromMetallicTextureBlue=!1,this._useAmbientOcclusionFromMetallicTextureRed=!1,this._useAmbientInGrayScale=!1,this._useAutoMicroSurfaceFromReflectivityMap=!1,this._lightFalloff=ut.LIGHTFALLOFF_PHYSICAL,this._useRadianceOverAlpha=!0,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this._parallaxScaleBias=.05,this._disableLighting=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._alphaCutOff=.4,this._useAlphaFresnel=!1,this._useLinearAlphaFresnel=!1,this._environmentBRDFTexture=null,this._forceIrradianceInFragment=!1,this._realTimeFiltering=!1,this._realTimeFilteringQuality=8,this._forceNormalForward=!1,this._enableSpecularAntiAliasing=!1,this._imageProcessingObserver=null,this._renderTargets=new jt(16),this._globalAmbientColor=new ae(0,0,0),this._unlit=!1,this._applyDecalMapAfterDetailMap=!1,this._debugMode=0,this._shadersLoaded=!1,this._breakShaderLoadedCheck=!1,this.debugMode=0,this.debugLimit=-1,this.debugFactor=1,this._cacheHasRenderTargetTextures=!1,this.brdf=new Vt(this),this.clearCoat=new Zt(this),this.iridescence=new Si(this),this.anisotropy=new nn(this),this.sheen=new Sr(this),this.subSurface=new Rt(this),this.detailMap=new ss(this),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),Q.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets),this._environmentBRDFTexture=Ym(this.getScene()),this.prePassConfiguration=new Ia}get hasRenderTargetTextures(){return Q.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget?!0:this._cacheHasRenderTargetTextures}get isPrePassCapable(){return!this.disableDepthWrite}getClassName(){return"PBRBaseMaterial"}get _disableAlphaBlending(){var e;return this._transparencyMode===ut.PBRMATERIAL_OPAQUE||this._transparencyMode===ut.PBRMATERIAL_ALPHATEST||((e=this.subSurface)==null?void 0:e.disableAlphaBlending)}needAlphaBlending(){return this._hasTransparencyMode?this._transparencyModeIsBlend:this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromAlbedoTexture()}needAlphaTesting(){var e;return this._hasTransparencyMode?this._transparencyModeIsTest:(e=this.subSurface)!=null&&e.disableAlphaBlending?!1:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===ut.PBRMATERIAL_ALPHATEST)}_shouldUseAlphaFromAlbedoTexture(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha&&this._useAlphaFromAlbedoTexture&&this._transparencyMode!==ut.PBRMATERIAL_OPAQUE}_hasAlphaChannel(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha||this._opacityTexture!=null}getAlphaTestTexture(){return this._albedoTexture}isReadyForSubMesh(e,t,i){var u;this._uniformBufferLayoutBuilt||this.buildUniformLayout();const r=t._drawWrapper;if(r.effect&&this.isFrozen&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(4,this._eventInfo),t.materialDefines=new Jh(this._eventInfo.defineNames));const s=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const n=this.getScene(),o=n.getEngine();if(s._areTexturesDirty&&(this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,n.texturesEnabled)){if(this._albedoTexture&&Q.DiffuseTextureEnabled&&!this._albedoTexture.isReadyOrNotBlocking()||this._baseWeightTexture&&Q.BaseWeightTextureEnabled&&!this._baseWeightTexture.isReadyOrNotBlocking()||this._ambientTexture&&Q.AmbientTextureEnabled&&!this._ambientTexture.isReadyOrNotBlocking()||this._opacityTexture&&Q.OpacityTextureEnabled&&!this._opacityTexture.isReadyOrNotBlocking())return!1;const d=this._getReflectionTexture();if(d&&Q.ReflectionTextureEnabled){if(!d.isReadyOrNotBlocking())return!1;if(d.irradianceTexture){if(!d.irradianceTexture.isReadyOrNotBlocking())return!1}else if(!d.sphericalPolynomial&&((u=d.getInternalTexture())!=null&&u._sphericalPolynomialPromise))return!1}if(this._lightmapTexture&&Q.LightmapTextureEnabled&&!this._lightmapTexture.isReadyOrNotBlocking()||this._emissiveTexture&&Q.EmissiveTextureEnabled&&!this._emissiveTexture.isReadyOrNotBlocking())return!1;if(Q.SpecularTextureEnabled){if(this._metallicTexture){if(!this._metallicTexture.isReadyOrNotBlocking())return!1}else if(this._reflectivityTexture&&!this._reflectivityTexture.isReadyOrNotBlocking())return!1;if(this._metallicReflectanceTexture&&!this._metallicReflectanceTexture.isReadyOrNotBlocking()||this._reflectanceTexture&&!this._reflectanceTexture.isReadyOrNotBlocking()||this._microSurfaceTexture&&!this._microSurfaceTexture.isReadyOrNotBlocking())return!1}if(o.getCaps().standardDerivatives&&this._bumpTexture&&Q.BumpTextureEnabled&&!this._disableBumpMap&&!this._bumpTexture.isReady()||this._environmentBRDFTexture&&Q.ReflectionTextureEnabled&&!this._environmentBRDFTexture.isReady())return!1}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=s,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh||s._areImageProcessingDirty&&this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady())return!1;if(s.AREALIGHTUSED){for(let d=0;d<e.lightSources.length;d++)if(!e.lightSources[d]._isReady())return!1}!o.getCaps().standardDerivatives&&!e.isVerticesDataPresent(x.NormalKind)&&(e.createNormals(!0),B.Warn("PBRMaterial: Normals have been created for the mesh: "+e.name));const l=t.effect,c=s._areLightsDisposed;let h=this._prepareEffect(e,s,this.onCompiled,this.onError,i,null,t.getRenderingMesh().hasThinInstances),f=!1;if(h)if(this._onEffectCreatedObservable&&(Ns.effect=h,Ns.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Ns)),this.allowShaderHotSwapping&&l&&!h.isReady()){if(h=l,s.markAsUnprocessed(),f=this.isFrozen,c)return s._areLightsDisposed=!0,!1}else n.resetCachedMaterial(),t.setEffect(h,s,this._materialContext);return!t.effect||!t.effect.isReady()?!1:(s._renderId=n.getRenderId(),r._wasPreviouslyReady=!f,r._wasPreviouslyUsingInstances=!!i,this._checkScenePerformancePriority(),!0)}isMetallicWorkflow(){return!!(this._metallic!=null||this._roughness!=null||this._metallicTexture)}_prepareEffect(e,t,i=null,r=null,s=null,n=null,o){if(this._prepareDefines(e,t,s,n,o),!t.isDirty)return null;t.markAsProcessed();const c=this.getScene().getEngine(),h=new Vn;let f=0;t.USESPHERICALINVERTEX&&h.addFallback(f++,"USESPHERICALINVERTEX"),t.FOG&&h.addFallback(f,"FOG"),t.SPECULARAA&&h.addFallback(f,"SPECULARAA"),t.POINTSIZE&&h.addFallback(f,"POINTSIZE"),t.LOGARITHMICDEPTH&&h.addFallback(f,"LOGARITHMICDEPTH"),t.PARALLAX&&h.addFallback(f,"PARALLAX"),t.PARALLAX_RHS&&h.addFallback(f,"PARALLAX_RHS"),t.PARALLAXOCCLUSION&&h.addFallback(f++,"PARALLAXOCCLUSION"),t.ENVIRONMENTBRDF&&h.addFallback(f++,"ENVIRONMENTBRDF"),t.TANGENT&&h.addFallback(f++,"TANGENT"),t.BUMP&&h.addFallback(f++,"BUMP"),f=yc(t,h,this._maxSimultaneousLights,f++),t.SPECULARTERM&&h.addFallback(f++,"SPECULARTERM"),t.USESPHERICALFROMREFLECTIONMAP&&h.addFallback(f++,"USESPHERICALFROMREFLECTIONMAP"),t.USEIRRADIANCEMAP&&h.addFallback(f++,"USEIRRADIANCEMAP"),t.LIGHTMAP&&h.addFallback(f++,"LIGHTMAP"),t.NORMAL&&h.addFallback(f++,"NORMAL"),t.AMBIENT&&h.addFallback(f++,"AMBIENT"),t.EMISSIVE&&h.addFallback(f++,"EMISSIVE"),t.VERTEXCOLOR&&h.addFallback(f++,"VERTEXCOLOR"),t.MORPHTARGETS&&h.addFallback(f++,"MORPHTARGETS"),t.MULTIVIEW&&h.addFallback(0,"MULTIVIEW");const u=[x.PositionKind];t.NORMAL&&u.push(x.NormalKind),t.TANGENT&&u.push(x.TangentKind);for(let S=1;S<=6;++S)t["UV"+S]&&u.push(`uv${S===1?"":S}`);t.VERTEXCOLOR&&u.push(x.ColorKind),bc(u,e,t,h),xc(u,t),Ac(u,e,t),Cc(u,e,t);let d="pbr";const _=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","baseWeight","vReflectivityColor","vMetallicReflectanceFactors","vEmissiveColor","visibility","vReflectionColor","vFogInfos","vFogColor","pointSize","vAlbedoInfos","vBaseWeightInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vReflectionPosition","vReflectionSize","vEmissiveInfos","vReflectivityInfos","vReflectionFilteringInfo","vMetallicReflectanceInfos","vReflectanceInfos","vMicroSurfaceSamplerInfos","vBumpInfos","vLightmapInfos","mBones","albedoMatrix","baseWeightMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","reflectivityMatrix","normalMatrix","microSurfaceSamplerMatrix","bumpMatrix","lightmapMatrix","metallicReflectanceMatrix","reflectanceMatrix","vLightingIntensity","logarithmicDepthConstant","vSphericalX","vSphericalY","vSphericalZ","vSphericalXX_ZZ","vSphericalYY_ZZ","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vSphericalL00","vSphericalL1_1","vSphericalL10","vSphericalL11","vSphericalL2_2","vSphericalL2_1","vSphericalL20","vSphericalL21","vSphericalL22","vReflectionMicrosurfaceInfos","vTangentSpaceParams","boneTextureWidth","vDebugMode","morphTargetTextureInfo","morphTargetTextureIndices"],p=["albedoSampler","baseWeightSampler","reflectivitySampler","ambientSampler","emissiveSampler","bumpSampler","lightmapSampler","opacitySampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh","irradianceSampler","microSurfaceSampler","environmentBrdfSampler","boneSampler","metallicReflectanceSampler","reflectanceSampler","morphTargets","oitDepthSampler","oitFrontColorSampler","icdfSampler","areaLightsLTC1Sampler","areaLightsLTC2Sampler"],g=["Material","Scene","Mesh"],E={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:t.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=h,this._eventInfo.fallbackRank=f,this._eventInfo.defines=t,this._eventInfo.uniforms=_,this._eventInfo.attributes=u,this._eventInfo.samplers=p,this._eventInfo.uniformBuffersNames=g,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=E,this._callbackPluginEventGeneric(128,this._eventInfo),si.AddUniformsAndSamplers(_,p),Ia.AddUniforms(_),Ba(_),ze&&(ze.PrepareUniforms(_,t),ze.PrepareSamplers(p,t)),Fc({uniformsNames:_,uniformBuffersNames:g,samplers:p,defines:t,maxSimultaneousLights:this._maxSimultaneousLights});const v={};this.customShaderNameResolve&&(d=this.customShaderNameResolve(d,_,g,p,t,u,v));const b=t.toString(),R=c.createEffect(d,{attributes:u,uniformsNames:_,uniformBuffersNames:g,samplers:p,defines:b,fallbacks:h,onCompiled:i,onError:r,indexParameters:E,processFinalCode:v.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:t.PREPASS,shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:async()=>{this.shaderLanguage===1?await Promise.all([X(()=>Promise.resolve().then(()=>lP),void 0,import.meta.url),X(()=>Promise.resolve().then(()=>zP),void 0,import.meta.url)]):await Promise.all([X(()=>Promise.resolve().then(()=>ZP),void 0,import.meta.url),X(()=>Promise.resolve().then(()=>NO),void 0,import.meta.url)]),this._shadersLoaded=!0}},c);return this._eventInfo.customCode=void 0,R}_prepareDefines(e,t,i=null,r=null,s=!1){const n=this.getScene(),o=n.getEngine();Pc(n,e,t,!0,this._maxSimultaneousLights,this._disableLighting),t._needNormals=!0,Lc(n,t);const l=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(Nc(n,t,this.canRenderToMRT&&!l),Um(n,t,l),si.PrepareDefines(o.currentRenderPassId,e,t),t.METALLICWORKFLOW=this.isMetallicWorkflow(),t._areTexturesDirty){t._needUVs=!1;for(let c=1;c<=6;++c)t["MAINUV"+c]=!1;if(n.texturesEnabled){t.ALBEDODIRECTUV=0,t.BASEWEIGHTDIRECTUV=0,t.AMBIENTDIRECTUV=0,t.OPACITYDIRECTUV=0,t.EMISSIVEDIRECTUV=0,t.REFLECTIVITYDIRECTUV=0,t.MICROSURFACEMAPDIRECTUV=0,t.METALLIC_REFLECTANCEDIRECTUV=0,t.REFLECTANCEDIRECTUV=0,t.BUMPDIRECTUV=0,t.LIGHTMAPDIRECTUV=0,o.getCaps().textureLOD&&(t.LODBASEDMICROSFURACE=!0),this._albedoTexture&&Q.DiffuseTextureEnabled?(ht(this._albedoTexture,t,"ALBEDO"),t.GAMMAALBEDO=this._albedoTexture.gammaSpace):t.ALBEDO=!1,this._baseWeightTexture&&Q.BaseWeightTextureEnabled?ht(this._baseWeightTexture,t,"BASEWEIGHT"):t.BASEWEIGHT=!1,this._ambientTexture&&Q.AmbientTextureEnabled?(ht(this._ambientTexture,t,"AMBIENT"),t.AMBIENTINGRAYSCALE=this._useAmbientInGrayScale):t.AMBIENT=!1,this._opacityTexture&&Q.OpacityTextureEnabled?(ht(this._opacityTexture,t,"OPACITY"),t.OPACITYRGB=this._opacityTexture.getAlphaFromRGB):t.OPACITY=!1;const c=this._getReflectionTexture();if(c&&Q.ReflectionTextureEnabled){switch(t.REFLECTION=!0,t.GAMMAREFLECTION=c.gammaSpace,t.RGBDREFLECTION=c.isRGBD,t.LODINREFLECTIONALPHA=c.lodLevelInAlpha,t.LINEARSPECULARREFLECTION=c.linearSpecularLOD,this.realTimeFiltering&&this.realTimeFilteringQuality>0?(t.NUM_SAMPLES=""+this.realTimeFilteringQuality,o._features.needTypeSuffixInShaderConstants&&(t.NUM_SAMPLES=t.NUM_SAMPLES+"u"),t.REALTIME_FILTERING=!0,this.getScene().iblCdfGenerator&&(t.IBL_CDF_FILTERING=!0)):t.REALTIME_FILTERING=!1,t.INVERTCUBICMAP=c.coordinatesMode===Z.INVCUBIC_MODE,t.REFLECTIONMAP_3D=c.isCube,t.REFLECTIONMAP_OPPOSITEZ=t.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!c.invertZ:c.invertZ,t.REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,c.coordinatesMode){case Z.EXPLICIT_MODE:t.REFLECTIONMAP_EXPLICIT=!0;break;case Z.PLANAR_MODE:t.REFLECTIONMAP_PLANAR=!0;break;case Z.PROJECTION_MODE:t.REFLECTIONMAP_PROJECTION=!0;break;case Z.SKYBOX_MODE:t.REFLECTIONMAP_SKYBOX=!0;break;case Z.SPHERICAL_MODE:t.REFLECTIONMAP_SPHERICAL=!0;break;case Z.EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case Z.FIXED_EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case Z.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case Z.CUBIC_MODE:case Z.INVCUBIC_MODE:default:t.REFLECTIONMAP_CUBIC=!0,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!!c.boundingBoxSize;break}c.coordinatesMode!==Z.SKYBOX_MODE&&(c.irradianceTexture?(t.USEIRRADIANCEMAP=!0,t.USESPHERICALFROMREFLECTIONMAP=!1,t.USESPHERICALINVERTEX=!1):c.isCube&&(t.USESPHERICALFROMREFLECTIONMAP=!0,t.USEIRRADIANCEMAP=!1,this._forceIrradianceInFragment||this.realTimeFiltering||this._twoSidedLighting||o.getCaps().maxVaryingVectors<=8?t.USESPHERICALINVERTEX=!1:t.USESPHERICALINVERTEX=!0))}else t.REFLECTION=!1,t.REFLECTIONMAP_3D=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_CUBIC=!1,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,t.INVERTCUBICMAP=!1,t.USESPHERICALFROMREFLECTIONMAP=!1,t.USEIRRADIANCEMAP=!1,t.USESPHERICALINVERTEX=!1,t.REFLECTIONMAP_OPPOSITEZ=!1,t.LODINREFLECTIONALPHA=!1,t.GAMMAREFLECTION=!1,t.RGBDREFLECTION=!1,t.LINEARSPECULARREFLECTION=!1;this._lightmapTexture&&Q.LightmapTextureEnabled?(ht(this._lightmapTexture,t,"LIGHTMAP"),t.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,t.GAMMALIGHTMAP=this._lightmapTexture.gammaSpace,t.RGBDLIGHTMAP=this._lightmapTexture.isRGBD):t.LIGHTMAP=!1,this._emissiveTexture&&Q.EmissiveTextureEnabled?(ht(this._emissiveTexture,t,"EMISSIVE"),t.GAMMAEMISSIVE=this._emissiveTexture.gammaSpace):t.EMISSIVE=!1,Q.SpecularTextureEnabled?(this._metallicTexture?(ht(this._metallicTexture,t,"REFLECTIVITY"),t.ROUGHNESSSTOREINMETALMAPALPHA=this._useRoughnessFromMetallicTextureAlpha,t.ROUGHNESSSTOREINMETALMAPGREEN=!this._useRoughnessFromMetallicTextureAlpha&&this._useRoughnessFromMetallicTextureGreen,t.METALLNESSSTOREINMETALMAPBLUE=this._useMetallnessFromMetallicTextureBlue,t.AOSTOREINMETALMAPRED=this._useAmbientOcclusionFromMetallicTextureRed,t.REFLECTIVITY_GAMMA=!1):this._reflectivityTexture?(ht(this._reflectivityTexture,t,"REFLECTIVITY"),t.MICROSURFACEFROMREFLECTIVITYMAP=this._useMicroSurfaceFromReflectivityMapAlpha,t.MICROSURFACEAUTOMATIC=this._useAutoMicroSurfaceFromReflectivityMap,t.REFLECTIVITY_GAMMA=this._reflectivityTexture.gammaSpace):t.REFLECTIVITY=!1,this._metallicReflectanceTexture||this._reflectanceTexture?(t.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=this._useOnlyMetallicFromMetallicReflectanceTexture,this._metallicReflectanceTexture?(ht(this._metallicReflectanceTexture,t,"METALLIC_REFLECTANCE"),t.METALLIC_REFLECTANCE_GAMMA=this._metallicReflectanceTexture.gammaSpace):t.METALLIC_REFLECTANCE=!1,this._reflectanceTexture&&(!this._metallicReflectanceTexture||this._metallicReflectanceTexture&&this._useOnlyMetallicFromMetallicReflectanceTexture)?(ht(this._reflectanceTexture,t,"REFLECTANCE"),t.REFLECTANCE_GAMMA=this._reflectanceTexture.gammaSpace):t.REFLECTANCE=!1):(t.METALLIC_REFLECTANCE=!1,t.REFLECTANCE=!1),this._microSurfaceTexture?ht(this._microSurfaceTexture,t,"MICROSURFACEMAP"):t.MICROSURFACEMAP=!1):(t.REFLECTIVITY=!1,t.MICROSURFACEMAP=!1),o.getCaps().standardDerivatives&&this._bumpTexture&&Q.BumpTextureEnabled&&!this._disableBumpMap?(ht(this._bumpTexture,t,"BUMP"),this._useParallax&&this._albedoTexture&&Q.DiffuseTextureEnabled?(t.PARALLAX=!0,t.PARALLAX_RHS=n.useRightHandedSystem,t.PARALLAXOCCLUSION=!!this._useParallaxOcclusion):t.PARALLAX=!1,t.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap):(t.BUMP=!1,t.PARALLAX=!1,t.PARALLAX_RHS=!1,t.PARALLAXOCCLUSION=!1,t.OBJECTSPACE_NORMALMAP=!1),this._environmentBRDFTexture&&Q.ReflectionTextureEnabled?(t.ENVIRONMENTBRDF=!0,t.ENVIRONMENTBRDF_RGBD=this._environmentBRDFTexture.isRGBD):(t.ENVIRONMENTBRDF=!1,t.ENVIRONMENTBRDF_RGBD=!1),this._shouldUseAlphaFromAlbedoTexture()?t.ALPHAFROMALBEDO=!0:t.ALPHAFROMALBEDO=!1}t.SPECULAROVERALPHA=this._useSpecularOverAlpha,this._lightFalloff===ut.LIGHTFALLOFF_STANDARD?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!1):this._lightFalloff===ut.LIGHTFALLOFF_GLTF?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!0):(t.USEPHYSICALLIGHTFALLOFF=!0,t.USEGLTFLIGHTFALLOFF=!1),t.RADIANCEOVERALPHA=this._useRadianceOverAlpha,!this.backFaceCulling&&this._twoSidedLighting?t.TWOSIDEDLIGHTING=!0:t.TWOSIDEDLIGHTING=!1,t.SPECULARAA=o.getCaps().standardDerivatives&&this._enableSpecularAntiAliasing}(t._areTexturesDirty||t._areMiscDirty)&&(t.ALPHATESTVALUE=`${this._alphaCutOff}${this._alphaCutOff%1===0?".":""}`,t.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,t.ALPHABLEND=this.needAlphaBlendingForMesh(e),t.ALPHAFRESNEL=this._useAlphaFresnel||this._useLinearAlphaFresnel,t.LINEARALPHAFRESNEL=this._useLinearAlphaFresnel),t._areImageProcessingDirty&&this._imageProcessingConfiguration&&this._imageProcessingConfiguration.prepareDefines(t),t.FORCENORMALFORWARD=this._forceNormalForward,t.RADIANCEOCCLUSION=this._useRadianceOcclusion,t.HORIZONOCCLUSION=this._useHorizonOcclusion,t._areMiscDirty&&(Mc(e,n,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this.needAlphaTestingForMesh(e),t,this._applyDecalMapAfterDetailMap),t.UNLIT=this._unlit||(this.pointsCloud||this.wireframe)&&!e.isVerticesDataPresent(x.NormalKind),t.DEBUGMODE=this._debugMode),Oc(n,o,this,t,!!i,r,s),this._eventInfo.defines=t,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),Dc(e,t,!0,!0,!0,this._transparencyMode!==ut.PBRMATERIAL_OPAQUE),this._callbackPluginEventPrepareDefines(this._eventInfo)}forceCompilation(e,t,i){const r={clipPlane:!1,useInstances:!1,...i};this._uniformBufferLayoutBuilt||this.buildUniformLayout(),this._callbackPluginEventGeneric(4,this._eventInfo),(()=>{if(this._breakShaderLoadedCheck)return;const n=new Jh(this._eventInfo.defineNames),o=this._prepareEffect(e,n,void 0,void 0,r.useInstances,r.clipPlane,e.hasThinInstances);this._onEffectCreatedObservable&&(Ns.effect=o,Ns.subMesh=null,this._onEffectCreatedObservable.notifyObservers(Ns)),o.isReady()?t&&t(this):o.onCompileObservable.add(()=>{t&&t(this)})})()}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("vAlbedoInfos",2),e.addUniform("vBaseWeightInfos",2),e.addUniform("vAmbientInfos",4),e.addUniform("vOpacityInfos",2),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vReflectivityInfos",3),e.addUniform("vMicroSurfaceSamplerInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionFilteringInfo",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vBumpInfos",3),e.addUniform("albedoMatrix",16),e.addUniform("baseWeightMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("reflectivityMatrix",16),e.addUniform("microSurfaceSamplerMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("reflectionMatrix",16),e.addUniform("vReflectionColor",3),e.addUniform("vAlbedoColor",4),e.addUniform("baseWeight",1),e.addUniform("vLightingIntensity",4),e.addUniform("vReflectionMicrosurfaceInfos",3),e.addUniform("pointSize",1),e.addUniform("vReflectivityColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vAmbientColor",3),e.addUniform("vDebugMode",2),e.addUniform("vMetallicReflectanceFactors",4),e.addUniform("vMetallicReflectanceInfos",2),e.addUniform("metallicReflectanceMatrix",16),e.addUniform("vReflectanceInfos",2),e.addUniform("reflectanceMatrix",16),e.addUniform("vSphericalL00",3),e.addUniform("vSphericalL1_1",3),e.addUniform("vSphericalL10",3),e.addUniform("vSphericalL11",3),e.addUniform("vSphericalL2_2",3),e.addUniform("vSphericalL2_1",3),e.addUniform("vSphericalL20",3),e.addUniform("vSphericalL21",3),e.addUniform("vSphericalL22",3),e.addUniform("vSphericalX",3),e.addUniform("vSphericalY",3),e.addUniform("vSphericalZ",3),e.addUniform("vSphericalXX_ZZ",3),e.addUniform("vSphericalYY_ZZ",3),e.addUniform("vSphericalZZ",3),e.addUniform("vSphericalXY",3),e.addUniform("vSphericalYZ",3),e.addUniform("vSphericalZX",3),super.buildUniformLayout()}bindForSubMesh(e,t,i){var f,u,d;const r=this.getScene(),s=i.materialDefines;if(!s)return;const n=i.effect;if(!n)return;this._activeEffect=n,t.getMeshUniformBuffer().bindToEffect(n,"Mesh"),t.transferToEffect(e);const o=r.getEngine();this._uniformBuffer.bindToEffect(n,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,r,t,e,this.isFrozen),si.Bind(o.currentRenderPassId,this._activeEffect,t,e,this),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),s.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const l=this._mustRebind(r,n,i,t.visibility);Ga(t,this._activeEffect,this.prePassConfiguration);let c=null;const h=this._uniformBuffer;if(l){if(this.bindViewProjection(n),c=this._getReflectionTexture(),!h.useUbo||!this.isFrozen||!h.isSync||i._drawWrapper._forceRebindOnNextCall){if(r.texturesEnabled){if(this._albedoTexture&&Q.DiffuseTextureEnabled&&(h.updateFloat2("vAlbedoInfos",this._albedoTexture.coordinatesIndex,this._albedoTexture.level),ft(this._albedoTexture,h,"albedo")),this._baseWeightTexture&&Q.BaseWeightTextureEnabled&&(h.updateFloat2("vBaseWeightInfos",this._baseWeightTexture.coordinatesIndex,this._baseWeightTexture.level),ft(this._baseWeightTexture,h,"baseWeight")),this._ambientTexture&&Q.AmbientTextureEnabled&&(h.updateFloat4("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level,this._ambientTextureStrength,this._ambientTextureImpactOnAnalyticalLights),ft(this._ambientTexture,h,"ambient")),this._opacityTexture&&Q.OpacityTextureEnabled&&(h.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),ft(this._opacityTexture,h,"opacity")),c&&Q.ReflectionTextureEnabled){if(h.updateMatrix("reflectionMatrix",c.getReflectionTextureMatrix()),h.updateFloat2("vReflectionInfos",c.level*r.iblIntensity,0),c.boundingBoxSize){const _=c;h.updateVector3("vReflectionPosition",_.boundingBoxPosition),h.updateVector3("vReflectionSize",_.boundingBoxSize)}if(this.realTimeFiltering){const _=c.getSize().width;h.updateFloat2("vReflectionFilteringInfo",_,Math.log2(_))}if(!s.USEIRRADIANCEMAP){const _=c.sphericalPolynomial;if(s.USESPHERICALFROMREFLECTIONMAP&&_)if(s.SPHERICAL_HARMONICS){const p=_.preScaledHarmonics;h.updateVector3("vSphericalL00",p.l00),h.updateVector3("vSphericalL1_1",p.l1_1),h.updateVector3("vSphericalL10",p.l10),h.updateVector3("vSphericalL11",p.l11),h.updateVector3("vSphericalL2_2",p.l2_2),h.updateVector3("vSphericalL2_1",p.l2_1),h.updateVector3("vSphericalL20",p.l20),h.updateVector3("vSphericalL21",p.l21),h.updateVector3("vSphericalL22",p.l22)}else h.updateFloat3("vSphericalX",_.x.x,_.x.y,_.x.z),h.updateFloat3("vSphericalY",_.y.x,_.y.y,_.y.z),h.updateFloat3("vSphericalZ",_.z.x,_.z.y,_.z.z),h.updateFloat3("vSphericalXX_ZZ",_.xx.x-_.zz.x,_.xx.y-_.zz.y,_.xx.z-_.zz.z),h.updateFloat3("vSphericalYY_ZZ",_.yy.x-_.zz.x,_.yy.y-_.zz.y,_.yy.z-_.zz.z),h.updateFloat3("vSphericalZZ",_.zz.x,_.zz.y,_.zz.z),h.updateFloat3("vSphericalXY",_.xy.x,_.xy.y,_.xy.z),h.updateFloat3("vSphericalYZ",_.yz.x,_.yz.y,_.yz.z),h.updateFloat3("vSphericalZX",_.zx.x,_.zx.y,_.zx.z)}h.updateFloat3("vReflectionMicrosurfaceInfos",c.getSize().width,c.lodGenerationScale,c.lodGenerationOffset)}this._emissiveTexture&&Q.EmissiveTextureEnabled&&(h.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),ft(this._emissiveTexture,h,"emissive")),this._lightmapTexture&&Q.LightmapTextureEnabled&&(h.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),ft(this._lightmapTexture,h,"lightmap")),Q.SpecularTextureEnabled&&(this._metallicTexture?(h.updateFloat3("vReflectivityInfos",this._metallicTexture.coordinatesIndex,this._metallicTexture.level,this._ambientTextureStrength),ft(this._metallicTexture,h,"reflectivity")):this._reflectivityTexture&&(h.updateFloat3("vReflectivityInfos",this._reflectivityTexture.coordinatesIndex,this._reflectivityTexture.level,1),ft(this._reflectivityTexture,h,"reflectivity")),this._metallicReflectanceTexture&&(h.updateFloat2("vMetallicReflectanceInfos",this._metallicReflectanceTexture.coordinatesIndex,this._metallicReflectanceTexture.level),ft(this._metallicReflectanceTexture,h,"metallicReflectance")),this._reflectanceTexture&&s.REFLECTANCE&&(h.updateFloat2("vReflectanceInfos",this._reflectanceTexture.coordinatesIndex,this._reflectanceTexture.level),ft(this._reflectanceTexture,h,"reflectance")),this._microSurfaceTexture&&(h.updateFloat2("vMicroSurfaceSamplerInfos",this._microSurfaceTexture.coordinatesIndex,this._microSurfaceTexture.level),ft(this._microSurfaceTexture,h,"microSurfaceSampler"))),this._bumpTexture&&o.getCaps().standardDerivatives&&Q.BumpTextureEnabled&&!this._disableBumpMap&&(h.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level,this._parallaxScaleBias),ft(this._bumpTexture,h,"bump"),r._mirroredCameraPosition?h.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):h.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1))}if(this.pointsCloud&&h.updateFloat("pointSize",this.pointSize),s.METALLICWORKFLOW){tt.Color3[0].r=this._metallic===void 0||this._metallic===null?1:this._metallic,tt.Color3[0].g=this._roughness===void 0||this._roughness===null?1:this._roughness,h.updateColor4("vReflectivityColor",tt.Color3[0],1);const _=((f=this.subSurface)==null?void 0:f._indexOfRefraction)??1.5,p=1,g=Math.pow((_-p)/(_+p),2);this._metallicReflectanceColor.scaleToRef(g*this._metallicF0Factor,tt.Color3[0]);const E=this._metallicF0Factor;h.updateColor4("vMetallicReflectanceFactors",tt.Color3[0],E)}else h.updateColor4("vReflectivityColor",this._reflectivityColor,this._microSurface);h.updateColor3("vEmissiveColor",Q.EmissiveTextureEnabled?this._emissiveColor:ae.BlackReadOnly),h.updateColor3("vReflectionColor",this._reflectionColor),!s.SS_REFRACTION&&((u=this.subSurface)!=null&&u._linkRefractionWithTransparency)?h.updateColor4("vAlbedoColor",this._albedoColor,1):h.updateColor4("vAlbedoColor",this._albedoColor,this.alpha),h.updateFloat("baseWeight",this._baseWeight),this._lightingInfos.x=this._directIntensity,this._lightingInfos.y=this._emissiveIntensity,this._lightingInfos.z=this._environmentIntensity*r.environmentIntensity,this._lightingInfos.w=this._specularIntensity,h.updateVector4("vLightingIntensity",this._lightingInfos),r.ambientColor.multiplyToRef(this._ambientColor,this._globalAmbientColor),h.updateColor3("vAmbientColor",this._globalAmbientColor),h.updateFloat2("vDebugMode",this.debugLimit,this.debugFactor)}if(r.texturesEnabled){if(this._albedoTexture&&Q.DiffuseTextureEnabled&&h.setTexture("albedoSampler",this._albedoTexture),this._baseWeightTexture&&Q.BaseWeightTextureEnabled&&h.setTexture("baseWeightSampler",this._baseWeightTexture),this._ambientTexture&&Q.AmbientTextureEnabled&&h.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&Q.OpacityTextureEnabled&&h.setTexture("opacitySampler",this._opacityTexture),c&&Q.ReflectionTextureEnabled){s.LODBASEDMICROSFURACE?h.setTexture("reflectionSampler",c):(h.setTexture("reflectionSampler",c._lodTextureMid||c),h.setTexture("reflectionSamplerLow",c._lodTextureLow||c),h.setTexture("reflectionSamplerHigh",c._lodTextureHigh||c)),s.USEIRRADIANCEMAP&&h.setTexture("irradianceSampler",c.irradianceTexture);const _=this.getScene().iblCdfGenerator;this.realTimeFiltering&&_&&h.setTexture("icdfSampler",_.getIcdfTexture())}s.ENVIRONMENTBRDF&&h.setTexture("environmentBrdfSampler",this._environmentBRDFTexture),this._emissiveTexture&&Q.EmissiveTextureEnabled&&h.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&Q.LightmapTextureEnabled&&h.setTexture("lightmapSampler",this._lightmapTexture),Q.SpecularTextureEnabled&&(this._metallicTexture?h.setTexture("reflectivitySampler",this._metallicTexture):this._reflectivityTexture&&h.setTexture("reflectivitySampler",this._reflectivityTexture),this._metallicReflectanceTexture&&h.setTexture("metallicReflectanceSampler",this._metallicReflectanceTexture),this._reflectanceTexture&&s.REFLECTANCE&&h.setTexture("reflectanceSampler",this._reflectanceTexture),this._microSurfaceTexture&&h.setTexture("microSurfaceSampler",this._microSurfaceTexture)),this._bumpTexture&&o.getCaps().standardDerivatives&&Q.BumpTextureEnabled&&!this._disableBumpMap&&h.setTexture("bumpSampler",this._bumpTexture)}this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(n),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),Ua(this._activeEffect,this,r),this.bindEyePosition(n)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(l||!this.isFrozen)&&(r.lightsEnabled&&!this._disableLighting&&Ic(r,t,this._activeEffect,s,this._maxSimultaneousLights),(r.fogEnabled&&t.applyFog&&r.fogMode!==Ge.FOGMODE_NONE||c||this.subSurface.refractionTexture||t.receiveShadows||s.PREPASS)&&this.bindView(n),Va(r,t,this._activeEffect,!0),s.NUM_MORPH_INFLUENCERS&&Rc(t,this._activeEffect),s.BAKED_VERTEX_ANIMATION_TEXTURE&&((d=t.bakedVertexAnimationManager)==null||d.bind(n,s.INSTANCES)),this._imageProcessingConfiguration.bind(this._activeEffect),Bn(s,this._activeEffect,r)),this._afterBind(t,this._activeEffect,i),h.update()}getAnimatables(){const e=super.getAnimatables();return this._albedoTexture&&this._albedoTexture.animations&&this._albedoTexture.animations.length>0&&e.push(this._albedoTexture),this._baseWeightTexture&&this._baseWeightTexture.animations&&this._baseWeightTexture.animations.length>0&&e.push(this._baseWeightTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._metallicTexture&&this._metallicTexture.animations&&this._metallicTexture.animations.length>0?e.push(this._metallicTexture):this._reflectivityTexture&&this._reflectivityTexture.animations&&this._reflectivityTexture.animations.length>0&&e.push(this._reflectivityTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._metallicReflectanceTexture&&this._metallicReflectanceTexture.animations&&this._metallicReflectanceTexture.animations.length>0&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&this._reflectanceTexture.animations&&this._reflectanceTexture.animations.length>0&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&this._microSurfaceTexture.animations&&this._microSurfaceTexture.animations.length>0&&e.push(this._microSurfaceTexture),e}_getReflectionTexture(){return this._reflectionTexture?this._reflectionTexture:this.getScene().environmentTexture}getActiveTextures(){const e=super.getActiveTextures();return this._albedoTexture&&e.push(this._albedoTexture),this._baseWeightTexture&&e.push(this._baseWeightTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._reflectivityTexture&&e.push(this._reflectivityTexture),this._metallicTexture&&e.push(this._metallicTexture),this._metallicReflectanceTexture&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&e.push(this._microSurfaceTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),e}hasTexture(e){return!!(super.hasTexture(e)||this._albedoTexture===e||this._baseWeightTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._reflectivityTexture===e||this._metallicTexture===e||this._metallicReflectanceTexture===e||this._reflectanceTexture===e||this._microSurfaceTexture===e||this._bumpTexture===e||this._lightmapTexture===e)}setPrePassRenderer(){var t;if(!((t=this.subSurface)!=null&&t.isScatteringEnabled))return!1;const e=this.getScene().enableSubSurfaceForPrePass();return e&&(e.enabled=!0),!0}dispose(e,t){var i,r,s,n,o,l,c,h,f,u,d,_,p;this._breakShaderLoadedCheck=!0,t&&(this._environmentBRDFTexture&&this.getScene().environmentBRDFTexture!==this._environmentBRDFTexture&&this._environmentBRDFTexture.dispose(),(i=this._albedoTexture)==null||i.dispose(),(r=this._baseWeightTexture)==null||r.dispose(),(s=this._ambientTexture)==null||s.dispose(),(n=this._opacityTexture)==null||n.dispose(),(o=this._reflectionTexture)==null||o.dispose(),(l=this._emissiveTexture)==null||l.dispose(),(c=this._metallicTexture)==null||c.dispose(),(h=this._reflectivityTexture)==null||h.dispose(),(f=this._bumpTexture)==null||f.dispose(),(u=this._lightmapTexture)==null||u.dispose(),(d=this._metallicReflectanceTexture)==null||d.dispose(),(_=this._reflectanceTexture)==null||_.dispose(),(p=this._microSurfaceTexture)==null||p.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}}ut.PBRMATERIAL_OPAQUE=q.MATERIAL_OPAQUE;ut.PBRMATERIAL_ALPHATEST=q.MATERIAL_ALPHATEST;ut.PBRMATERIAL_ALPHABLEND=q.MATERIAL_ALPHABLEND;ut.PBRMATERIAL_ALPHATESTANDBLEND=q.MATERIAL_ALPHATESTANDBLEND;ut.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=0;ut.LIGHTFALLOFF_PHYSICAL=0;ut.LIGHTFALLOFF_GLTF=1;ut.LIGHTFALLOFF_STANDARD=2;ut.ForceGLSL=!1;A([Pm()],ut.prototype,"_imageProcessingConfiguration",void 0);A([j("_markAllSubMeshesAsMiscDirty")],ut.prototype,"debugMode",void 0);class be extends ut{get refractionTexture(){return this.subSurface.refractionTexture}set refractionTexture(e){this.subSurface.refractionTexture=e,e?this.subSurface.isRefractionEnabled=!0:this.subSurface.linkRefractionWithTransparency||(this.subSurface.isRefractionEnabled=!1)}get indexOfRefraction(){return this.subSurface.indexOfRefraction}set indexOfRefraction(e){this.subSurface.indexOfRefraction=e}get invertRefractionY(){return this.subSurface.invertRefractionY}set invertRefractionY(e){this.subSurface.invertRefractionY=e}get linkRefractionWithTransparency(){return this.subSurface.linkRefractionWithTransparency}set linkRefractionWithTransparency(e){this.subSurface.linkRefractionWithTransparency=e,e&&(this.subSurface.isRefractionEnabled=!0)}get usePhysicalLightFalloff(){return this._lightFalloff===ut.LIGHTFALLOFF_PHYSICAL}set usePhysicalLightFalloff(e){e!==this.usePhysicalLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=ut.LIGHTFALLOFF_PHYSICAL:this._lightFalloff=ut.LIGHTFALLOFF_STANDARD)}get useGLTFLightFalloff(){return this._lightFalloff===ut.LIGHTFALLOFF_GLTF}set useGLTFLightFalloff(e){e!==this.useGLTFLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=ut.LIGHTFALLOFF_GLTF:this._lightFalloff=ut.LIGHTFALLOFF_STANDARD)}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}constructor(e,t,i=!1){super(e,t,i),this.directIntensity=1,this.emissiveIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.disableBumpMap=!1,this.ambientTextureStrength=1,this.ambientTextureImpactOnAnalyticalLights=be.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this.metallicF0Factor=1,this.metallicReflectanceColor=ae.White(),this.useOnlyMetallicFromMetallicReflectanceTexture=!1,this.ambientColor=new ae(0,0,0),this.albedoColor=new ae(1,1,1),this.baseWeight=1,this.reflectivityColor=new ae(1,1,1),this.reflectionColor=new ae(1,1,1),this.emissiveColor=new ae(0,0,0),this.microSurface=1,this.useLightmapAsShadowmap=!1,this.useAlphaFromAlbedoTexture=!1,this.forceAlphaTest=!1,this.alphaCutOff=.4,this.useSpecularOverAlpha=!0,this.useMicroSurfaceFromReflectivityMapAlpha=!1,this.useRoughnessFromMetallicTextureAlpha=!0,this.useRoughnessFromMetallicTextureGreen=!1,this.useMetallnessFromMetallicTextureBlue=!1,this.useAmbientOcclusionFromMetallicTextureRed=!1,this.useAmbientInGrayScale=!1,this.useAutoMicroSurfaceFromReflectivityMap=!1,this.useRadianceOverAlpha=!0,this.useObjectSpaceNormalMap=!1,this.useParallax=!1,this.useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this.disableLighting=!1,this.forceIrradianceInFragment=!1,this.maxSimultaneousLights=4,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.twoSidedLighting=!1,this.useAlphaFresnel=!1,this.useLinearAlphaFresnel=!1,this.environmentBRDFTexture=null,this.forceNormalForward=!1,this.enableSpecularAntiAliasing=!1,this.useHorizonOcclusion=!0,this.useRadianceOcclusion=!0,this.unlit=!1,this.applyDecalMapAfterDetailMap=!1,this._environmentBRDFTexture=Ym(this.getScene())}getClassName(){return"PBRMaterial"}clone(e,t=!0,i=""){const r=ye.Clone(()=>new be(e,this.getScene()),this,{cloneTexturesOnlyOnce:t});return r.id=e,r.name=e,this.stencil.copyTo(r.stencil),this._clonePlugins(r,i),r}serialize(){const e=super.serialize();return e.customType="BABYLON.PBRMaterial",e}static Parse(e,t,i){const r=ye.Parse(()=>new be(e.name,t),e,t,i);return e.stencil&&r.stencil.parse(e.stencil,t,i),q._ParsePlugins(e,r,t,i),e.clearCoat&&r.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&r.anisotropy.parse(e.anisotropy,t,i),e.brdf&&r.brdf.parse(e.brdf,t,i),e.sheen&&r.sheen.parse(e.sheen,t,i),e.subSurface&&r.subSurface.parse(e.subSurface,t,i),e.iridescence&&r.iridescence.parse(e.iridescence,t,i),r}}be.PBRMATERIAL_OPAQUE=ut.PBRMATERIAL_OPAQUE;be.PBRMATERIAL_ALPHATEST=ut.PBRMATERIAL_ALPHATEST;be.PBRMATERIAL_ALPHABLEND=ut.PBRMATERIAL_ALPHABLEND;be.PBRMATERIAL_ALPHATESTANDBLEND=ut.PBRMATERIAL_ALPHATESTANDBLEND;be.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=ut.DEFAULT_AO_ON_ANALYTICAL_LIGHTS;A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"directIntensity",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"emissiveIntensity",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"environmentIntensity",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"specularIntensity",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"disableBumpMap",void 0);A([Je(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"albedoTexture",void 0);A([Je(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"baseWeightTexture",void 0);A([Je(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"ambientTexture",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"ambientTextureStrength",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"ambientTextureImpactOnAnalyticalLights",void 0);A([Je(),j("_markAllSubMeshesAsTexturesAndMiscDirty")],be.prototype,"opacityTexture",void 0);A([Je(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"reflectionTexture",void 0);A([Je(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"emissiveTexture",void 0);A([Je(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"reflectivityTexture",void 0);A([Je(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"metallicTexture",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"metallic",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"roughness",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"metallicF0Factor",void 0);A([Qt(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"metallicReflectanceColor",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"useOnlyMetallicFromMetallicReflectanceTexture",void 0);A([Je(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"metallicReflectanceTexture",void 0);A([Je(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"reflectanceTexture",void 0);A([Je(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"microSurfaceTexture",void 0);A([Je(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"bumpTexture",void 0);A([Je(),j("_markAllSubMeshesAsTexturesDirty",null)],be.prototype,"lightmapTexture",void 0);A([Qt("ambient"),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"ambientColor",void 0);A([Qt("albedo"),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"albedoColor",void 0);A([y("baseWeight"),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"baseWeight",void 0);A([Qt("reflectivity"),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"reflectivityColor",void 0);A([Qt("reflection"),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"reflectionColor",void 0);A([Qt("emissive"),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"emissiveColor",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"microSurface",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"useLightmapAsShadowmap",void 0);A([y(),j("_markAllSubMeshesAsTexturesAndMiscDirty")],be.prototype,"useAlphaFromAlbedoTexture",void 0);A([y(),j("_markAllSubMeshesAsTexturesAndMiscDirty")],be.prototype,"forceAlphaTest",void 0);A([y(),j("_markAllSubMeshesAsTexturesAndMiscDirty")],be.prototype,"alphaCutOff",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"useSpecularOverAlpha",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"useRoughnessFromMetallicTextureAlpha",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"useRoughnessFromMetallicTextureGreen",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"useMetallnessFromMetallicTextureBlue",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"useAmbientInGrayScale",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0);A([y()],be.prototype,"usePhysicalLightFalloff",null);A([y()],be.prototype,"useGLTFLightFalloff",null);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"useRadianceOverAlpha",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"useObjectSpaceNormalMap",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"useParallax",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"useParallaxOcclusion",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"parallaxScaleBias",void 0);A([y(),j("_markAllSubMeshesAsLightsDirty")],be.prototype,"disableLighting",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"forceIrradianceInFragment",void 0);A([y(),j("_markAllSubMeshesAsLightsDirty")],be.prototype,"maxSimultaneousLights",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"invertNormalMapX",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"invertNormalMapY",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"twoSidedLighting",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"useAlphaFresnel",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"useLinearAlphaFresnel",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"environmentBRDFTexture",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"forceNormalForward",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"enableSpecularAntiAliasing",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"useHorizonOcclusion",void 0);A([y(),j("_markAllSubMeshesAsTexturesDirty")],be.prototype,"useRadianceOcclusion",void 0);A([y(),j("_markAllSubMeshesAsMiscDirty")],be.prototype,"unlit",void 0);A([y(),j("_markAllSubMeshesAsMiscDirty")],be.prototype,"applyDecalMapAfterDetailMap",void 0);Y("BABYLON.PBRMaterial",be);class sC{constructor(){this._doNotSerialize=!1,this._isDisposed=!1,this._sceneRootNodesIndex=-1,this._isEnabled=!0,this._isParentEnabled=!0,this._isReady=!0,this._onEnabledStateChangedObservable=new U,this._onClonedObservable=new U}}class gt{static AddNodeConstructor(e,t){this._NodeConstructors[e]=t}static Construct(e,t,i,r){const s=this._NodeConstructors[e];return s?s(t,i,r):null}set accessibilityTag(e){this._accessibilityTag=e,this.onAccessibilityTagChangedObservable.notifyObservers(e)}get accessibilityTag(){return this._accessibilityTag}get doNotSerialize(){return this._nodeDataStorage._doNotSerialize?!0:this._parentNode?this._parentNode.doNotSerialize:!1}set doNotSerialize(e){this._nodeDataStorage._doNotSerialize=e}isDisposed(){return this._nodeDataStorage._isDisposed}set parent(e){if(this._parentNode===e)return;const t=this._parentNode;if(this._parentNode&&this._parentNode._children!==void 0&&this._parentNode._children!==null){const i=this._parentNode._children.indexOf(this);i!==-1&&this._parentNode._children.splice(i,1),!e&&!this._nodeDataStorage._isDisposed&&this._addToSceneRootNodes()}this._parentNode=e,this._isDirty=!0,this._parentNode&&((this._parentNode._children===void 0||this._parentNode._children===null)&&(this._parentNode._children=new Array),this._parentNode._children.push(this),t||this._removeFromSceneRootNodes()),this._syncParentEnabledState()}get parent(){return this._parentNode}_serializeAsParent(e){e.parentId=this.uniqueId}_addToSceneRootNodes(){this._nodeDataStorage._sceneRootNodesIndex===-1&&(this._nodeDataStorage._sceneRootNodesIndex=this._scene.rootNodes.length,this._scene.rootNodes.push(this))}_removeFromSceneRootNodes(){if(this._nodeDataStorage._sceneRootNodesIndex!==-1){const e=this._scene.rootNodes,t=e.length-1;e[this._nodeDataStorage._sceneRootNodesIndex]=e[t],e[this._nodeDataStorage._sceneRootNodesIndex]._nodeDataStorage._sceneRootNodesIndex=this._nodeDataStorage._sceneRootNodesIndex,this._scene.rootNodes.pop(),this._nodeDataStorage._sceneRootNodesIndex=-1}}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}getClassName(){return"Node"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onEnabledStateChangedObservable(){return this._nodeDataStorage._onEnabledStateChangedObservable}get onClonedObservable(){return this._nodeDataStorage._onClonedObservable}constructor(e,t=null,i=!0){this._isDirty=!1,this._nodeDataStorage=new sC,this.state="",this.metadata=null,this.reservedDataStore=null,this._accessibilityTag=null,this.onAccessibilityTagChangedObservable=new U,this._parentContainer=null,this.animations=[],this._ranges={},this.onReady=null,this._currentRenderId=-1,this._parentUpdateId=-1,this._childUpdateId=-1,this._waitingParentId=null,this._waitingParentInstanceIndex=null,this._waitingParsedUniqueId=null,this._cache={},this._parentNode=null,this._children=null,this._worldMatrix=P.Identity(),this._worldMatrixDeterminant=0,this._worldMatrixDeterminantIsDirty=!0,this._animationPropertiesOverride=null,this._isNode=!0,this.onDisposeObservable=new U,this._onDisposeObserver=null,this._behaviors=new Array,this.name=e,this.id=e,this._scene=t||Re.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._initCache(),i&&this._addToSceneRootNodes()}getScene(){return this._scene}getEngine(){return this._scene.getEngine()}addBehavior(e,t=!1){return this._behaviors.indexOf(e)!==-1?this:(e.init(),this._scene.isLoading&&!t?this._scene.onDataLoadedObservable.addOnce(()=>{e.attach(this)}):e.attach(this),this._behaviors.push(e),this)}removeBehavior(e){const t=this._behaviors.indexOf(e);return t===-1?this:(this._behaviors[t].detach(),this._behaviors.splice(t,1),this)}get behaviors(){return this._behaviors}getBehaviorByName(e){for(const t of this._behaviors)if(t.name===e)return t;return null}getWorldMatrix(){return this._currentRenderId!==this._scene.getRenderId()&&this.computeWorldMatrix(),this._worldMatrix}_getWorldMatrixDeterminant(){return this._worldMatrixDeterminantIsDirty&&(this._worldMatrixDeterminantIsDirty=!1,this._worldMatrixDeterminant=this._worldMatrix.determinant()),this._worldMatrixDeterminant}get worldMatrixFromCache(){return this._worldMatrix}_initCache(){this._cache={}}updateCache(e){!e&&this.isSynchronized()||this._updateCache()}_getActionManagerForTrigger(e,t=!0){return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_updateCache(e){}_isSynchronized(){return!0}_markSyncedWithParent(){this._parentNode&&(this._parentUpdateId=this._parentNode._childUpdateId)}isSynchronizedWithParent(){return this._parentNode?this._parentNode._isDirty||this._parentUpdateId!==this._parentNode._childUpdateId?!1:this._parentNode.isSynchronized():!0}isSynchronized(){return this._parentNode&&!this.isSynchronizedWithParent()?!1:this._isSynchronized()}isReady(e=!1){return this._nodeDataStorage._isReady}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}isEnabled(e=!0){return e===!1?this._nodeDataStorage._isEnabled:this._nodeDataStorage._isEnabled?this._nodeDataStorage._isParentEnabled:!1}_syncParentEnabledState(){this._nodeDataStorage._isParentEnabled=this._parentNode?this._parentNode.isEnabled():!0,this._children&&this._children.forEach(e=>{e._syncParentEnabledState()})}setEnabled(e){this._nodeDataStorage._isEnabled!==e&&(this._nodeDataStorage._isEnabled=e,this._syncParentEnabledState(),this._nodeDataStorage._onEnabledStateChangedObservable.notifyObservers(e))}isDescendantOf(e){return this.parent?this.parent===e?!0:this.parent.isDescendantOf(e):!1}_getDescendants(e,t=!1,i){if(this._children)for(let r=0;r<this._children.length;r++){const s=this._children[r];(!i||i(s))&&e.push(s),t||s._getDescendants(e,!1,i)}}getDescendants(e,t){const i=[];return this._getDescendants(i,e,t),i}getChildMeshes(e,t){const i=[];return this._getDescendants(i,e,r=>(!t||t(r))&&r.cullingStrategy!==void 0),i}getChildren(e,t=!0){return this.getDescendants(t,e)}_setReady(e){if(e!==this._nodeDataStorage._isReady){if(!e){this._nodeDataStorage._isReady=!1;return}this.onReady&&this.onReady(this),this._nodeDataStorage._isReady=!0}}getAnimationByName(e){for(let t=0;t<this.animations.length;t++){const i=this.animations[t];if(i.name===e)return i}return null}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=gt._AnimationRangeFactory(e,t,i);for(let r=0,s=this.animations.length;r<s;r++)this.animations[r]&&this.animations[r].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,r=this.animations.length;i<r;i++)this.animations[i]&&this.animations[i].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}clone(e,t,i){const r=ye.Clone(()=>new gt(e,this.getScene()),this);if(t&&(r.parent=t),!i){const s=this.getDescendants(!0);for(let n=0;n<s.length;n++){const o=s[n];o.clone(e+"."+o.name,r)}}return r}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}beginAnimation(e,t,i,r){const s=this.getAnimationRange(e);return s?this._scene.beginAnimation(this,s.from,s.to,t,i,r):null}serializeAnimationRanges(){const e=[];for(const t in this._ranges){const i=this._ranges[t];if(!i)continue;const r={};r.name=t,r.from=i.from,r.to=i.to,e.push(r)}return e}computeWorldMatrix(e){return this._worldMatrix||(this._worldMatrix=P.Identity()),this._worldMatrix}dispose(e,t=!1){if(this._nodeDataStorage._isDisposed=!0,!e){const i=this.getDescendants(!0);for(const r of i)r.dispose(e,t)}this.parent?this.parent=null:this._removeFromSceneRootNodes(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onEnabledStateChangedObservable.clear(),this.onClonedObservable.clear();for(const i of this._behaviors)i.detach();this._behaviors.length=0,this.metadata=null}static ParseAnimationRanges(e,t,i){if(t.ranges)for(let r=0;r<t.ranges.length;r++){const s=t.ranges[r];e.createAnimationRange(s.name,s.from,s.to)}}getHierarchyBoundingVectors(e=!0,t=null){this.getScene().incrementRenderId(),this.computeWorldMatrix(!0);let i,r;const s=this;if(s.getBoundingInfo&&s.subMeshes){const n=s.getBoundingInfo();i=n.boundingBox.minimumWorld.clone(),r=n.boundingBox.maximumWorld.clone()}else i=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),r=new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(e){const n=this.getDescendants(!1);for(const o of n){const l=o;if(l.computeWorldMatrix(!0),t&&!t(l)||!l.getBoundingInfo||l.getTotalVertices()===0)continue;const h=l.getBoundingInfo().boundingBox,f=h.minimumWorld,u=h.maximumWorld;m.CheckExtends(f,i,r),m.CheckExtends(u,i,r)}}return{min:i,max:r}}}gt._AnimationRangeFactory=(a,e,t)=>{throw Le("AnimationRange")};gt._NodeConstructors={};A([y()],gt.prototype,"name",void 0);A([y()],gt.prototype,"id",void 0);A([y()],gt.prototype,"uniqueId",void 0);A([y()],gt.prototype,"state",void 0);A([y()],gt.prototype,"metadata",void 0);class ke extends gt{get range(){return this._range}set range(e){this._range=e,this._inverseSquaredRange=1/(this.range*this.range)}get intensityMode(){return this._intensityMode}set intensityMode(e){this._intensityMode=e,this._computePhotometricScale()}get radius(){return this._radius}set radius(e){this._radius=e,this._computePhotometricScale()}get shadowEnabled(){return this._shadowEnabled}set shadowEnabled(e){this._shadowEnabled!==e&&(this._shadowEnabled=e,this._markMeshesAsLightDirty())}get includedOnlyMeshes(){return this._includedOnlyMeshes}set includedOnlyMeshes(e){this._includedOnlyMeshes=e,this._hookArrayForIncludedOnly(e)}get excludedMeshes(){return this._excludedMeshes}set excludedMeshes(e){this._excludedMeshes=e,this._hookArrayForExcluded(e)}get excludeWithLayerMask(){return this._excludeWithLayerMask}set excludeWithLayerMask(e){this._excludeWithLayerMask=e,this._resyncMeshes()}get includeOnlyWithLayerMask(){return this._includeOnlyWithLayerMask}set includeOnlyWithLayerMask(e){this._includeOnlyWithLayerMask=e,this._resyncMeshes()}get lightmapMode(){return this._lightmapMode}set lightmapMode(e){this._lightmapMode!==e&&(this._lightmapMode=e,this._markMeshesAsLightDirty())}getViewMatrix(e){return null}getProjectionMatrix(e,t){return null}constructor(e,t){super(e,t,!1),this.diffuse=new ae(1,1,1),this.specular=new ae(1,1,1),this.falloffType=ke.FALLOFF_DEFAULT,this.intensity=1,this._range=Number.MAX_VALUE,this._inverseSquaredRange=0,this._photometricScale=1,this._intensityMode=ke.INTENSITYMODE_AUTOMATIC,this._radius=1e-5,this.renderPriority=0,this._shadowEnabled=!0,this._excludeWithLayerMask=0,this._includeOnlyWithLayerMask=0,this._lightmapMode=0,this._shadowGenerators=null,this._excludedMeshesIds=new Array,this._includedOnlyMeshesIds=new Array,this._isLight=!0,this.getScene().addLight(this),this._uniformBuffer=new _e(this.getScene().getEngine(),void 0,void 0,e),this._buildUniformLayout(),this.includedOnlyMeshes=[],this.excludedMeshes=[],this._resyncMeshes()}transferTexturesToEffect(e,t){return this}_bindLight(e,t,i,r,s=!0){const n=e.toString();let o=!1;if(this._uniformBuffer.bindToEffect(i,"Light"+n),this._renderId!==t.getRenderId()||this._lastUseSpecular!==r||!this._uniformBuffer.useUbo){this._renderId=t.getRenderId(),this._lastUseSpecular=r;const l=this.getScaledIntensity();this.transferToEffect(i,n),this.diffuse.scaleToRef(l,tt.Color3[0]),this._uniformBuffer.updateColor4("vLightDiffuse",tt.Color3[0],this.range,n),r&&(this.specular.scaleToRef(l,tt.Color3[1]),this._uniformBuffer.updateColor4("vLightSpecular",tt.Color3[1],this.radius,n)),o=!0}if(this.transferTexturesToEffect(i,n),t.shadowsEnabled&&this.shadowEnabled&&s){const l=this.getShadowGenerator(t.activeCamera)??this.getShadowGenerator();l&&(l.bindShadowLight(n,i),o=!0)}o?this._uniformBuffer.update():this._uniformBuffer.bindUniformBuffer()}getClassName(){return"Light"}toString(e){let t="Name: "+this.name;if(t+=", type: "+["Point","Directional","Spot","Hemispheric"][this.getTypeID()],this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}_syncParentEnabledState(){super._syncParentEnabledState(),this.isDisposed()||this._resyncMeshes()}setEnabled(e){super.setEnabled(e),this._resyncMeshes()}getShadowGenerator(e=null){return this._shadowGenerators===null?null:this._shadowGenerators.get(e)??null}getShadowGenerators(){return this._shadowGenerators}getAbsolutePosition(){return m.Zero()}canAffectMesh(e){return e?!(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&this.includedOnlyMeshes.indexOf(e)===-1||this.excludedMeshes&&this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(e)!==-1||this.includeOnlyWithLayerMask!==0&&!(this.includeOnlyWithLayerMask&e.layerMask)||this.excludeWithLayerMask!==0&&this.excludeWithLayerMask&e.layerMask):!0}dispose(e,t=!1){if(this._shadowGenerators){const i=this._shadowGenerators.values();for(let r=i.next();r.done!==!0;r=i.next())r.value.dispose();this._shadowGenerators=null}if(this.getScene().stopAnimation(this),this._parentContainer){const i=this._parentContainer.lights.indexOf(this);i>-1&&this._parentContainer.lights.splice(i,1),this._parentContainer=null}for(const i of this.getScene().meshes)i._removeLightSource(this,!0);this._uniformBuffer.dispose(),this.getScene().removeLight(this),super.dispose(e,t)}getTypeID(){return 0}getScaledIntensity(){return this._photometricScale*this.intensity}clone(e,t=null){const i=ke.GetConstructorFromName(this.getTypeID(),e,this.getScene());if(!i)return null;const r=ye.Clone(i,this);return e&&(r.name=e),t&&(r.parent=t),r.setEnabled(this.isEnabled()),this.onClonedObservable.notifyObservers(r),r}serialize(){const e=ye.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getTypeID(),this.parent&&this.parent._serializeAsParent(e),this.excludedMeshes.length>0&&(e.excludedMeshesIds=[],this.excludedMeshes.forEach(t=>{e.excludedMeshesIds.push(t.id)})),this.includedOnlyMeshes.length>0&&(e.includedOnlyMeshesIds=[],this.includedOnlyMeshes.forEach(t=>{e.includedOnlyMeshesIds.push(t.id)})),ye.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}static GetConstructorFromName(e,t,i){const r=gt.Construct("Light_Type_"+e,t,i);return r||null}static Parse(e,t){const i=ke.GetConstructorFromName(e.type,e.name,t);if(!i)return null;const r=ye.Parse(i,e,t);if(e.excludedMeshesIds&&(r._excludedMeshesIds=e.excludedMeshesIds),e.includedOnlyMeshesIds&&(r._includedOnlyMeshesIds=e.includedOnlyMeshesIds),e.parentId!==void 0&&(r._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),e.falloffType!==void 0&&(r.falloffType=e.falloffType),e.lightmapMode!==void 0&&(r.lightmapMode=e.lightmapMode),e.animations){for(let s=0;s<e.animations.length;s++){const n=e.animations[s],o=Ui("BABYLON.Animation");o&&r.animations.push(o.Parse(n))}gt.ParseAnimationRanges(r,e,t)}return e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.isEnabled!==void 0&&r.setEnabled(e.isEnabled),r}_hookArrayForExcluded(e){const t=e.push;e.push=(...r)=>{const s=t.apply(e,r);for(const n of r)n._resyncLightSource(this);return s};const i=e.splice;e.splice=(r,s)=>{const n=i.apply(e,[r,s]);for(const o of n)o._resyncLightSource(this);return n};for(const r of e)r._resyncLightSource(this)}_hookArrayForIncludedOnly(e){const t=e.push;e.push=(...r)=>{const s=t.apply(e,r);return this._resyncMeshes(),s};const i=e.splice;e.splice=(r,s)=>{const n=i.apply(e,[r,s]);return this._resyncMeshes(),n},this._resyncMeshes()}_resyncMeshes(){for(const e of this.getScene().meshes)e._resyncLightSource(this)}_markMeshesAsLightDirty(){for(const e of this.getScene().meshes)e.lightSources.indexOf(this)!==-1&&e._markSubMeshesAsLightDirty()}_computePhotometricScale(){this._photometricScale=this._getPhotometricScale(),this.getScene().resetCachedMaterial()}_getPhotometricScale(){let e=0;const t=this.getTypeID();let i=this.intensityMode;switch(i===ke.INTENSITYMODE_AUTOMATIC&&(t===ke.LIGHTTYPEID_DIRECTIONALLIGHT?i=ke.INTENSITYMODE_ILLUMINANCE:i=ke.INTENSITYMODE_LUMINOUSINTENSITY),t){case ke.LIGHTTYPEID_POINTLIGHT:case ke.LIGHTTYPEID_SPOTLIGHT:switch(i){case ke.INTENSITYMODE_LUMINOUSPOWER:e=1/(4*Math.PI);break;case ke.INTENSITYMODE_LUMINOUSINTENSITY:e=1;break;case ke.INTENSITYMODE_LUMINANCE:e=this.radius*this.radius;break}break;case ke.LIGHTTYPEID_DIRECTIONALLIGHT:switch(i){case ke.INTENSITYMODE_ILLUMINANCE:e=1;break;case ke.INTENSITYMODE_LUMINANCE:{let r=this.radius;r=Math.max(r,.001),e=2*Math.PI*(1-Math.cos(r));break}}break;case ke.LIGHTTYPEID_HEMISPHERICLIGHT:e=1;break}return e}_reorderLightsInScene(){const e=this.getScene();this._renderPriority!=0&&(e.requireLightSorting=!0),this.getScene().sortLightsByPriority()}_isReady(){return!0}}ke.FALLOFF_DEFAULT=it.FALLOFF_DEFAULT;ke.FALLOFF_PHYSICAL=it.FALLOFF_PHYSICAL;ke.FALLOFF_GLTF=it.FALLOFF_GLTF;ke.FALLOFF_STANDARD=it.FALLOFF_STANDARD;ke.LIGHTMAP_DEFAULT=it.LIGHTMAP_DEFAULT;ke.LIGHTMAP_SPECULAR=it.LIGHTMAP_SPECULAR;ke.LIGHTMAP_SHADOWSONLY=it.LIGHTMAP_SHADOWSONLY;ke.INTENSITYMODE_AUTOMATIC=it.INTENSITYMODE_AUTOMATIC;ke.INTENSITYMODE_LUMINOUSPOWER=it.INTENSITYMODE_LUMINOUSPOWER;ke.INTENSITYMODE_LUMINOUSINTENSITY=it.INTENSITYMODE_LUMINOUSINTENSITY;ke.INTENSITYMODE_ILLUMINANCE=it.INTENSITYMODE_ILLUMINANCE;ke.INTENSITYMODE_LUMINANCE=it.INTENSITYMODE_LUMINANCE;ke.LIGHTTYPEID_POINTLIGHT=it.LIGHTTYPEID_POINTLIGHT;ke.LIGHTTYPEID_DIRECTIONALLIGHT=it.LIGHTTYPEID_DIRECTIONALLIGHT;ke.LIGHTTYPEID_SPOTLIGHT=it.LIGHTTYPEID_SPOTLIGHT;ke.LIGHTTYPEID_HEMISPHERICLIGHT=it.LIGHTTYPEID_HEMISPHERICLIGHT;ke.LIGHTTYPEID_RECT_AREALIGHT=it.LIGHTTYPEID_RECT_AREALIGHT;A([Qt()],ke.prototype,"diffuse",void 0);A([Qt()],ke.prototype,"specular",void 0);A([y()],ke.prototype,"falloffType",void 0);A([y()],ke.prototype,"intensity",void 0);A([y()],ke.prototype,"range",null);A([y()],ke.prototype,"intensityMode",null);A([y()],ke.prototype,"radius",null);A([y()],ke.prototype,"_renderPriority",void 0);A([j("_reorderLightsInScene")],ke.prototype,"renderPriority",void 0);A([y("shadowEnabled")],ke.prototype,"_shadowEnabled",void 0);A([y("excludeWithLayerMask")],ke.prototype,"_excludeWithLayerMask",void 0);A([y("includeOnlyWithLayerMask")],ke.prototype,"_includeOnlyWithLayerMask",void 0);A([y("lightmapMode")],ke.prototype,"_lightmapMode",void 0);gt.AddNodeConstructor("Light_Type_3",(a,e)=>()=>new an(a,m.Zero(),e));class an extends ke{constructor(e,t,i){super(e,i),this.groundColor=new ae(0,0,0),this.direction=t||m.Up()}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightGround",3),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}getClassName(){return"HemisphericLight"}setDirectionToTarget(e){return this.direction=m.Normalize(e.subtract(m.Zero())),this.direction}getShadowGenerator(){return null}transferToEffect(e,t){const i=m.Normalize(this.direction);return this._uniformBuffer.updateFloat4("vLightData",i.x,i.y,i.z,0,t),this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),t),this}transferToNodeMaterialEffect(e,t){const i=m.Normalize(this.direction);return e.setFloat3(t,i.x,i.y,i.z),this}computeWorldMatrix(){return this._worldMatrix||(this._worldMatrix=P.Identity()),this._worldMatrix}getTypeID(){return ke.LIGHTTYPEID_HEMISPHERICLIGHT}prepareLightSpecificDefines(e,t){e["HEMILIGHT"+t]=!0}}A([Qt()],an.prototype,"groundColor",void 0);A([di()],an.prototype,"direction",void 0);Y("BABYLON.HemisphericLight",an);function hl(a,e,t){try{const i=a.next();i.done?e(i):i.value?i.value.then(()=>{i.value=void 0,e(i)},t):e(i)}catch(i){t(i)}}function nC(a=25){let e;return(t,i,r)=>{const s=performance.now();e===void 0||s-e>a?(e=s,setTimeout(()=>{hl(t,i,r)},0)):hl(t,i,r)}}function Km(a,e,t,i,r){const s=()=>{let n;const o=l=>{l.done?t(l.value):n===void 0?n=!0:s()};do n=void 0,e(a,o,i),n===void 0&&(n=!1);while(n)};s()}function Uc(a,e){let t;return Km(a,hl,i=>t=i,i=>{throw i}),t}function aC(a,e,t){return new Promise((i,r)=>{Km(a,e,i,r)})}function oC(a,e){return(...t)=>Uc(a(...t))}class Ce extends gt{get position(){return this._position}set position(e){this._position=e}set upVector(e){this._upVector=e}get upVector(){return this._upVector}get screenArea(){let e=0,t=0;if(this.mode===Ce.PERSPECTIVE_CAMERA)this.fovMode===Ce.FOVMODE_VERTICAL_FIXED?(t=this.minZ*2*Math.tan(this.fov/2),e=this.getEngine().getAspectRatio(this)*t):(e=this.minZ*2*Math.tan(this.fov/2),t=e/this.getEngine().getAspectRatio(this));else{const i=this.getEngine().getRenderWidth()/2,r=this.getEngine().getRenderHeight()/2;e=(this.orthoRight??i)-(this.orthoLeft??-i),t=(this.orthoTop??r)-(this.orthoBottom??-r)}return e*t}set orthoLeft(e){this._orthoLeft=e;for(const t of this._rigCameras)t.orthoLeft=e}get orthoLeft(){return this._orthoLeft}set orthoRight(e){this._orthoRight=e;for(const t of this._rigCameras)t.orthoRight=e}get orthoRight(){return this._orthoRight}set orthoBottom(e){this._orthoBottom=e;for(const t of this._rigCameras)t.orthoBottom=e}get orthoBottom(){return this._orthoBottom}set orthoTop(e){this._orthoTop=e;for(const t of this._rigCameras)t.orthoTop=e}get orthoTop(){return this._orthoTop}set mode(e){this._mode=e;for(const t of this._rigCameras)t.mode=e}get mode(){return this._mode}get hasMoved(){return this._hasMoved}constructor(e,t,i,r=!0){super(e,i,!1),this._position=m.Zero(),this._upVector=m.Up(),this.oblique=null,this._orthoLeft=null,this._orthoRight=null,this._orthoBottom=null,this._orthoTop=null,this.fov=.8,this.projectionPlaneTilt=0,this.minZ=1,this.maxZ=1e4,this.inertia=.9,this._mode=Ce.PERSPECTIVE_CAMERA,this.isIntermediate=!1,this.viewport=new Er(0,0,1,1),this.layerMask=268435455,this.fovMode=Ce.FOVMODE_VERTICAL_FIXED,this.cameraRigMode=Ce.RIG_MODE_NONE,this.customRenderTargets=[],this.outputRenderTarget=null,this.onViewMatrixChangedObservable=new U,this.onProjectionMatrixChangedObservable=new U,this.onAfterCheckInputsObservable=new U,this.onRestoreStateObservable=new U,this.isRigCamera=!1,this._hasMoved=!1,this._rigCameras=new Array,this._skipRendering=!1,this._projectionMatrix=new P,this._postProcesses=new Array,this._activeMeshes=new jt(256),this._globalPosition=m.Zero(),this._computedViewMatrix=P.Identity(),this._doNotComputeProjectionMatrix=!1,this._transformMatrix=P.Zero(),this._refreshFrustumPlanes=!0,this._absoluteRotation=z.Identity(),this._isCamera=!0,this._isLeftCamera=!1,this._isRightCamera=!1,this.getScene().addCamera(this),r&&!this.getScene().activeCamera&&(this.getScene().activeCamera=this),this.position=t,this.renderPassId=this.getScene().getEngine().createRenderPassId(`Camera ${e}`)}storeState(){return this._stateStored=!0,this._storedFov=this.fov,this}hasStateStored(){return!!this._stateStored}_restoreStateValues(){return this._stateStored?(this.fov=this._storedFov,!0):!1}restoreState(){return this._restoreStateValues()?(this.onRestoreStateObservable.notifyObservers(this),!0):!1}getClassName(){return"Camera"}toString(e){let t="Name: "+this.name;if(t+=", type: "+this.getClassName(),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}applyVerticalCorrection(){const e=this.absoluteRotation.toEulerAngles();this.projectionPlaneTilt=this._scene.useRightHandedSystem?-e.x:e.x}get globalPosition(){return this._globalPosition}getActiveMeshes(){return this._activeMeshes}isActiveMesh(e){return this._activeMeshes.indexOf(e)!==-1}isReady(e=!1){if(e){for(const t of this._postProcesses)if(t&&!t.isReady())return!1}return super.isReady(e)}_initCache(){super._initCache(),this._cache.position=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.fovMode=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.obliqueAngle=void 0,this._cache.obliqueLength=void 0,this._cache.obliqueOffset=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0}_updateCache(e){e||super._updateCache(),this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector)}_isSynchronized(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()}_isSynchronizedViewMatrix(){return super._isSynchronized()?this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent():!1}_isSynchronizedProjectionMatrix(){let e=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!e)return!1;const t=this.getEngine();return this.mode===Ce.PERSPECTIVE_CAMERA?e=this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===t.getAspectRatio(this)&&this._cache.projectionPlaneTilt===this.projectionPlaneTilt:(e=this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===t.getRenderWidth()&&this._cache.renderHeight===t.getRenderHeight(),this.oblique&&(e=e&&this._cache.obliqueAngle===this.oblique.angle&&this._cache.obliqueLength===this.oblique.length&&this._cache.obliqueOffset===this.oblique.offset)),e}attachControl(e,t){}detachControl(e){}update(){this._hasMoved=!1,this._checkInputs(),this.cameraRigMode!==Ce.RIG_MODE_NONE&&this._updateRigCameras(),this.getViewMatrix(),this.getProjectionMatrix()}_checkInputs(){this.onAfterCheckInputsObservable.notifyObservers(this)}get rigCameras(){return this._rigCameras}get rigPostProcess(){return this._rigPostProcess}_getFirstPostProcess(){for(let e=0;e<this._postProcesses.length;e++)if(this._postProcesses[e]!==null)return this._postProcesses[e];return null}_cascadePostProcessesToRigCams(){const e=this._getFirstPostProcess();e&&e.markTextureDirty();for(let t=0,i=this._rigCameras.length;t<i;t++){const r=this._rigCameras[t],s=r._rigPostProcess;s?(s.getEffectName()==="pass"&&(r.isIntermediate=this._postProcesses.length===0),r._postProcesses=this._postProcesses.slice(0).concat(s),s.markTextureDirty()):r._postProcesses=this._postProcesses.slice(0)}}attachPostProcess(e,t=null){return!e.isReusable()&&this._postProcesses.indexOf(e)>-1?(B.Error("You're trying to reuse a post process not defined as reusable."),0):(t==null||t<0?this._postProcesses.push(e):this._postProcesses[t]===null?this._postProcesses[t]=e:this._postProcesses.splice(t,0,e),this._cascadePostProcessesToRigCams(),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._postProcesses.indexOf(e))}detachPostProcess(e){const t=this._postProcesses.indexOf(e);t!==-1&&(this._postProcesses[t]=null),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._cascadePostProcessesToRigCams()}getWorldMatrix(){return this._isSynchronizedViewMatrix()?this._worldMatrix:(this.getViewMatrix(),this._worldMatrix)}_getViewMatrix(){return P.Identity()}getViewMatrix(e){return!e&&this._isSynchronizedViewMatrix()?this._computedViewMatrix:(this._hasMoved=!0,this.updateCache(),this._computedViewMatrix=this._getViewMatrix(),this._currentRenderId=this.getScene().getRenderId(),this._childUpdateId++,this._refreshFrustumPlanes=!0,this._cameraRigParams&&this._cameraRigParams.vrPreViewMatrix&&this._computedViewMatrix.multiplyToRef(this._cameraRigParams.vrPreViewMatrix,this._computedViewMatrix),this.parent&&this.parent.onViewMatrixChangedObservable&&this.parent.onViewMatrixChangedObservable.notifyObservers(this.parent),this.onViewMatrixChangedObservable.notifyObservers(this),this._computedViewMatrix.invertToRef(this._worldMatrix),this._computedViewMatrix)}freezeProjectionMatrix(e){this._doNotComputeProjectionMatrix=!0,e!==void 0&&(this._projectionMatrix=e)}unfreezeProjectionMatrix(){this._doNotComputeProjectionMatrix=!1}getProjectionMatrix(e){var s,n,o;if(this._doNotComputeProjectionMatrix||!e&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._refreshFrustumPlanes=!0;const t=this.getEngine(),i=this.getScene(),r=t.useReverseDepthBuffer;if(this.mode===Ce.PERSPECTIVE_CAMERA){this._cache.fov=this.fov,this._cache.fovMode=this.fovMode,this._cache.aspectRatio=t.getAspectRatio(this),this._cache.projectionPlaneTilt=this.projectionPlaneTilt,this.minZ<=0&&(this.minZ=.1);let l;i.useRightHandedSystem?l=P.PerspectiveFovRHToRef:l=P.PerspectiveFovLHToRef,l(this.fov,t.getAspectRatio(this),r?this.maxZ:this.minZ,r?this.minZ:this.maxZ,this._projectionMatrix,this.fovMode===Ce.FOVMODE_VERTICAL_FIXED,t.isNDCHalfZRange,this.projectionPlaneTilt,r)}else{const l=t.getRenderWidth()/2,c=t.getRenderHeight()/2;i.useRightHandedSystem?this.oblique?P.ObliqueOffCenterRHToRef(this.orthoLeft??-l,this.orthoRight??l,this.orthoBottom??-c,this.orthoTop??c,r?this.maxZ:this.minZ,r?this.minZ:this.maxZ,this.oblique.length,this.oblique.angle,this._computeObliqueDistance(this.oblique.offset),this._projectionMatrix,t.isNDCHalfZRange):P.OrthoOffCenterRHToRef(this.orthoLeft??-l,this.orthoRight??l,this.orthoBottom??-c,this.orthoTop??c,r?this.maxZ:this.minZ,r?this.minZ:this.maxZ,this._projectionMatrix,t.isNDCHalfZRange):this.oblique?P.ObliqueOffCenterLHToRef(this.orthoLeft??-l,this.orthoRight??l,this.orthoBottom??-c,this.orthoTop??c,r?this.maxZ:this.minZ,r?this.minZ:this.maxZ,this.oblique.length,this.oblique.angle,this._computeObliqueDistance(this.oblique.offset),this._projectionMatrix,t.isNDCHalfZRange):P.OrthoOffCenterLHToRef(this.orthoLeft??-l,this.orthoRight??l,this.orthoBottom??-c,this.orthoTop??c,r?this.maxZ:this.minZ,r?this.minZ:this.maxZ,this._projectionMatrix,t.isNDCHalfZRange),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.obliqueAngle=(s=this.oblique)==null?void 0:s.angle,this._cache.obliqueLength=(n=this.oblique)==null?void 0:n.length,this._cache.obliqueOffset=(o=this.oblique)==null?void 0:o.offset,this._cache.renderWidth=t.getRenderWidth(),this._cache.renderHeight=t.getRenderHeight()}return this.onProjectionMatrixChangedObservable.notifyObservers(this),this._projectionMatrix}getTransformationMatrix(){return this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._transformMatrix}_computeObliqueDistance(e){const t=this,i=this;return(t.radius||(i.target?m.Distance(this.position,i.target):this.position.length()))+e}_updateFrustumPlanes(){this._refreshFrustumPlanes&&(this.getTransformationMatrix(),this._frustumPlanes?Li.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=Li.GetPlanes(this._transformMatrix),this._refreshFrustumPlanes=!1)}isInFrustum(e,t=!1){if(this._updateFrustumPlanes(),t&&this.rigCameras.length>0){let i=!1;return this.rigCameras.forEach(r=>{r._updateFrustumPlanes(),i=i||e.isInFrustum(r._frustumPlanes)}),i}else return e.isInFrustum(this._frustumPlanes)}isCompletelyInFrustum(e){return this._updateFrustumPlanes(),e.isCompletelyInFrustum(this._frustumPlanes)}getForwardRay(e=100,t,i){throw Le("Ray")}getForwardRayToRef(e,t=100,i,r){throw Le("Ray")}dispose(e,t=!1){for(this.onViewMatrixChangedObservable.clear(),this.onProjectionMatrixChangedObservable.clear(),this.onAfterCheckInputsObservable.clear(),this.onRestoreStateObservable.clear(),this.inputs&&this.inputs.clear(),this.getScene().stopAnimation(this),this.getScene().removeCamera(this);this._rigCameras.length>0;){const r=this._rigCameras.pop();r&&r.dispose()}if(this._parentContainer){const r=this._parentContainer.cameras.indexOf(this);r>-1&&this._parentContainer.cameras.splice(r,1),this._parentContainer=null}if(this._rigPostProcess)this._rigPostProcess.dispose(this),this._rigPostProcess=null,this._postProcesses.length=0;else if(this.cameraRigMode!==Ce.RIG_MODE_NONE)this._rigPostProcess=null,this._postProcesses.length=0;else{let r=this._postProcesses.length;for(;--r>=0;){const s=this._postProcesses[r];s&&s.dispose(this)}}let i=this.customRenderTargets.length;for(;--i>=0;)this.customRenderTargets[i].dispose();this.customRenderTargets.length=0,this._activeMeshes.dispose(),this.getScene().getEngine().releaseRenderPassId(this.renderPassId),super.dispose(e,t)}get isLeftCamera(){return this._isLeftCamera}get isRightCamera(){return this._isRightCamera}get leftCamera(){return this._rigCameras.length<1?null:this._rigCameras[0]}get rightCamera(){return this._rigCameras.length<2?null:this._rigCameras[1]}getLeftTarget(){return this._rigCameras.length<1?null:this._rigCameras[0].getTarget()}getRightTarget(){return this._rigCameras.length<2?null:this._rigCameras[1].getTarget()}setCameraRigMode(e,t){if(this.cameraRigMode!==e){for(;this._rigCameras.length>0;){const i=this._rigCameras.pop();i&&i.dispose()}if(this.cameraRigMode=e,this._cameraRigParams={},this._cameraRigParams.interaxialDistance=t.interaxialDistance||.0637,this._cameraRigParams.stereoHalfAngle=k.ToRadians(this._cameraRigParams.interaxialDistance/.0637),this.cameraRigMode!==Ce.RIG_MODE_NONE){const i=this.createRigCamera(this.name+"_L",0);i&&(i._isLeftCamera=!0);const r=this.createRigCamera(this.name+"_R",1);r&&(r._isRightCamera=!0),i&&r&&(this._rigCameras.push(i),this._rigCameras.push(r))}this._setRigMode(t),this._cascadePostProcessesToRigCams(),this.update()}}_setRigMode(e){}_getVRProjectionMatrix(){return P.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix,!0,this.getEngine().isNDCHalfZRange),this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix),this._projectionMatrix}setCameraRigParameter(e,t){this._cameraRigParams||(this._cameraRigParams={}),this._cameraRigParams[e]=t,e==="interaxialDistance"&&(this._cameraRigParams.stereoHalfAngle=k.ToRadians(t/.0637))}createRigCamera(e,t){return null}_updateRigCameras(){for(let e=0;e<this._rigCameras.length;e++)this._rigCameras[e].minZ=this.minZ,this._rigCameras[e].maxZ=this.maxZ,this._rigCameras[e].fov=this.fov,this._rigCameras[e].upVector.copyFrom(this.upVector);this.cameraRigMode===Ce.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport)}_setupInputs(){}serialize(){const e=ye.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getClassName(),this.parent&&this.parent._serializeAsParent(e),this.inputs&&this.inputs.serialize(e),ye.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}clone(e,t=null){const i=ye.Clone(Ce.GetConstructorFromName(this.getClassName(),e,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this);return i.name=e,i.parent=t,this.onClonedObservable.notifyObservers(i),i}getDirection(e){const t=m.Zero();return this.getDirectionToRef(e,t),t}get absoluteRotation(){return this.getWorldMatrix().decompose(void 0,this._absoluteRotation),this._absoluteRotation}getDirectionToRef(e,t){m.TransformNormalToRef(e,this.getWorldMatrix(),t)}static GetConstructorFromName(e,t,i,r=0,s=!0){const n=gt.Construct(e,t,i,{interaxial_distance:r,isStereoscopicSideBySide:s});return n||(()=>Ce._CreateDefaultParsedCamera(t,i))}computeWorldMatrix(){return this.getWorldMatrix()}static Parse(e,t){const i=e.type,r=Ce.GetConstructorFromName(i,e.name,t,e.interaxial_distance,e.isStereoscopicSideBySide),s=ye.Parse(r,e,t);if(e.parentId!==void 0&&(s._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),s.inputs&&(s.inputs.parse(e),s._setupInputs()),e.upVector&&(s.upVector=m.FromArray(e.upVector)),s.setPosition&&(s.position.copyFromFloats(0,0,0),s.setPosition(m.FromArray(e.position))),e.target&&s.setTarget&&s.setTarget(m.FromArray(e.target)),e.cameraRigMode){const n=e.interaxial_distance?{interaxialDistance:e.interaxial_distance}:{};s.setCameraRigMode(e.cameraRigMode,n)}if(e.animations){for(let n=0;n<e.animations.length;n++){const o=e.animations[n],l=Ui("BABYLON.Animation");l&&s.animations.push(l.Parse(o))}gt.ParseAnimationRanges(s,e,t)}return e.autoAnimate&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.isEnabled!==void 0&&s.setEnabled(e.isEnabled),s}_calculateHandednessMultiplier(){let e=this.getScene().useRightHandedSystem?-1:1;return this.parent&&this.parent._getWorldMatrixDeterminant()<0&&(e*=-1),e}}Ce._CreateDefaultParsedCamera=(a,e)=>{throw Le("UniversalCamera")};Ce.PERSPECTIVE_CAMERA=0;Ce.ORTHOGRAPHIC_CAMERA=1;Ce.FOVMODE_VERTICAL_FIXED=0;Ce.FOVMODE_HORIZONTAL_FIXED=1;Ce.RIG_MODE_NONE=0;Ce.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10;Ce.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11;Ce.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12;Ce.RIG_MODE_STEREOSCOPIC_OVERUNDER=13;Ce.RIG_MODE_STEREOSCOPIC_INTERLACED=14;Ce.RIG_MODE_VR=20;Ce.RIG_MODE_CUSTOM=22;Ce.ForceAttachControlToAlwaysPreventDefault=!1;A([di("position")],Ce.prototype,"_position",void 0);A([di("upVector")],Ce.prototype,"_upVector",void 0);A([y()],Ce.prototype,"orthoLeft",null);A([y()],Ce.prototype,"orthoRight",null);A([y()],Ce.prototype,"orthoBottom",null);A([y()],Ce.prototype,"orthoTop",null);A([y()],Ce.prototype,"fov",void 0);A([y()],Ce.prototype,"projectionPlaneTilt",void 0);A([y()],Ce.prototype,"minZ",void 0);A([y()],Ce.prototype,"maxZ",void 0);A([y()],Ce.prototype,"inertia",void 0);A([y()],Ce.prototype,"mode",null);A([y()],Ce.prototype,"layerMask",void 0);A([y()],Ce.prototype,"fovMode",void 0);A([y()],Ce.prototype,"cameraRigMode",void 0);A([y()],Ce.prototype,"interaxialDistance",void 0);A([y()],Ce.prototype,"isStereoscopicSideBySide",void 0);class Vo{}class ee{constructor(){this.uniqueId=0,this.metadata={},this._applyTo=oC(this._applyToCoroutine.bind(this)),this.uniqueId=ee._UniqueIDGenerator,ee._UniqueIDGenerator++}set(e,t){switch(e.length||B.Warn(`Setting vertex data kind '${t}' with an empty array`),t){case x.PositionKind:this.positions=e;break;case x.NormalKind:this.normals=e;break;case x.TangentKind:this.tangents=e;break;case x.UVKind:this.uvs=e;break;case x.UV2Kind:this.uvs2=e;break;case x.UV3Kind:this.uvs3=e;break;case x.UV4Kind:this.uvs4=e;break;case x.UV5Kind:this.uvs5=e;break;case x.UV6Kind:this.uvs6=e;break;case x.ColorKind:this.colors=e;break;case x.MatricesIndicesKind:this.matricesIndices=e;break;case x.MatricesWeightsKind:this.matricesWeights=e;break;case x.MatricesIndicesExtraKind:this.matricesIndicesExtra=e;break;case x.MatricesWeightsExtraKind:this.matricesWeightsExtra=e;break}}applyToMesh(e,t){return this._applyTo(e,t,!1),this}applyToGeometry(e,t){return this._applyTo(e,t,!1),this}updateMesh(e){return this._update(e),this}updateGeometry(e){return this._update(e),this}*_applyToCoroutine(e,t=!1,i){if(this.positions&&(e.setVerticesData(x.PositionKind,this.positions,t),i&&(yield)),this.normals&&(e.setVerticesData(x.NormalKind,this.normals,t),i&&(yield)),this.tangents&&(e.setVerticesData(x.TangentKind,this.tangents,t),i&&(yield)),this.uvs&&(e.setVerticesData(x.UVKind,this.uvs,t),i&&(yield)),this.uvs2&&(e.setVerticesData(x.UV2Kind,this.uvs2,t),i&&(yield)),this.uvs3&&(e.setVerticesData(x.UV3Kind,this.uvs3,t),i&&(yield)),this.uvs4&&(e.setVerticesData(x.UV4Kind,this.uvs4,t),i&&(yield)),this.uvs5&&(e.setVerticesData(x.UV5Kind,this.uvs5,t),i&&(yield)),this.uvs6&&(e.setVerticesData(x.UV6Kind,this.uvs6,t),i&&(yield)),this.colors){const r=this.positions&&this.colors.length===this.positions.length?3:4;e.setVerticesData(x.ColorKind,this.colors,t,r),this.hasVertexAlpha&&e.hasVertexAlpha!==void 0&&(e.hasVertexAlpha=!0),i&&(yield)}if(this.matricesIndices&&(e.setVerticesData(x.MatricesIndicesKind,this.matricesIndices,t),i&&(yield)),this.matricesWeights&&(e.setVerticesData(x.MatricesWeightsKind,this.matricesWeights,t),i&&(yield)),this.matricesIndicesExtra&&(e.setVerticesData(x.MatricesIndicesExtraKind,this.matricesIndicesExtra,t),i&&(yield)),this.matricesWeightsExtra&&(e.setVerticesData(x.MatricesWeightsExtraKind,this.matricesWeightsExtra,t),i&&(yield)),this.indices?(e.setIndices(this.indices,null,t),i&&(yield)):e.setIndices([],null),e.subMeshes&&this.materialInfos&&this.materialInfos.length>1){const r=e;r.subMeshes=[];for(const s of this.materialInfos)new Ei(s.materialIndex,s.verticesStart,s.verticesCount,s.indexStart,s.indexCount,r)}return this}_update(e,t,i){return this.positions&&e.updateVerticesData(x.PositionKind,this.positions,t,i),this.normals&&e.updateVerticesData(x.NormalKind,this.normals,t,i),this.tangents&&e.updateVerticesData(x.TangentKind,this.tangents,t,i),this.uvs&&e.updateVerticesData(x.UVKind,this.uvs,t,i),this.uvs2&&e.updateVerticesData(x.UV2Kind,this.uvs2,t,i),this.uvs3&&e.updateVerticesData(x.UV3Kind,this.uvs3,t,i),this.uvs4&&e.updateVerticesData(x.UV4Kind,this.uvs4,t,i),this.uvs5&&e.updateVerticesData(x.UV5Kind,this.uvs5,t,i),this.uvs6&&e.updateVerticesData(x.UV6Kind,this.uvs6,t,i),this.colors&&e.updateVerticesData(x.ColorKind,this.colors,t,i),this.matricesIndices&&e.updateVerticesData(x.MatricesIndicesKind,this.matricesIndices,t,i),this.matricesWeights&&e.updateVerticesData(x.MatricesWeightsKind,this.matricesWeights,t,i),this.matricesIndicesExtra&&e.updateVerticesData(x.MatricesIndicesExtraKind,this.matricesIndicesExtra,t,i),this.matricesWeightsExtra&&e.updateVerticesData(x.MatricesWeightsExtraKind,this.matricesWeightsExtra,t,i),this.indices&&e.setIndices(this.indices,null),this}static _TransformVector3Coordinates(e,t,i=0,r=e.length){const s=F.Vector3[0],n=F.Vector3[1];for(let o=i;o<i+r;o+=3)m.FromArrayToRef(e,o,s),m.TransformCoordinatesToRef(s,t,n),e[o]=n.x,e[o+1]=n.y,e[o+2]=n.z}static _TransformVector3Normals(e,t,i=0,r=e.length){const s=F.Vector3[0],n=F.Vector3[1];for(let o=i;o<i+r;o+=3)m.FromArrayToRef(e,o,s),m.TransformNormalToRef(s,t,n),e[o]=n.x,e[o+1]=n.y,e[o+2]=n.z}static _TransformVector4Normals(e,t,i=0,r=e.length){const s=F.Vector4[0],n=F.Vector4[1];for(let o=i;o<i+r;o+=4)Fe.FromArrayToRef(e,o,s),Fe.TransformNormalToRef(s,t,n),e[o]=n.x,e[o+1]=n.y,e[o+2]=n.z,e[o+3]=n.w}static _FlipFaces(e,t=0,i=e.length){for(let r=t;r<t+i;r+=3){const s=e[r+1];e[r+1]=e[r+2],e[r+2]=s}}transform(e){const t=e.determinant()<0;return this.positions&&ee._TransformVector3Coordinates(this.positions,e),this.normals&&ee._TransformVector3Normals(this.normals,e),this.tangents&&ee._TransformVector4Normals(this.tangents,e),t&&this.indices&&ee._FlipFaces(this.indices),this}splitBasedOnMaterialID(){if(!this.materialInfos||this.materialInfos.length<2)return[this];const e=[];for(const t of this.materialInfos){const i=new ee;if(this.positions&&(i.positions=this.positions.slice(t.verticesStart*3,(t.verticesCount+t.verticesStart)*3)),this.normals&&(i.normals=this.normals.slice(t.verticesStart*3,(t.verticesCount+t.verticesStart)*3)),this.tangents&&(i.tangents=this.tangents.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.colors&&(i.colors=this.colors.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.uvs&&(i.uvs=this.uvs.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs2&&(i.uvs2=this.uvs2.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs3&&(i.uvs3=this.uvs3.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs4&&(i.uvs4=this.uvs4.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs5&&(i.uvs5=this.uvs5.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs6&&(i.uvs6=this.uvs6.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.matricesIndices&&(i.matricesIndices=this.matricesIndices.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.matricesIndicesExtra&&(i.matricesIndicesExtra=this.matricesIndicesExtra.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.matricesWeights&&(i.matricesWeights=this.matricesWeights.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.matricesWeightsExtra&&(i.matricesWeightsExtra=this.matricesWeightsExtra.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.indices){i.indices=[];for(let s=t.indexStart;s<t.indexStart+t.indexCount;s++)i.indices.push(this.indices[s]-t.verticesStart)}const r=new Vo;r.indexStart=0,r.indexCount=i.indices?i.indices.length:0,r.materialIndex=t.materialIndex,r.verticesStart=0,r.verticesCount=(i.positions?i.positions.length:0)/3,i.materialInfos=[r],e.push(i)}return e}merge(e,t=!1,i=!1,r=!1,s=!1){const n=Array.isArray(e)?e.map(o=>({vertexData:o})):[{vertexData:e}];return Uc(this._mergeCoroutine(void 0,n,t,!1,i,r,s))}*_mergeCoroutine(e,t,i=!1,r,s,n=!1,o=!1){var d,_;this._validate();let l=t.map(p=>p.vertexData),c=this;if(o)for(const p of l)p&&(p._validate(),!this.normals&&p.normals&&(this.normals=new Float32Array(this.positions.length)),!this.tangents&&p.tangents&&(this.tangents=new Float32Array(this.positions.length/3*4)),!this.uvs&&p.uvs&&(this.uvs=new Float32Array(this.positions.length/3*2)),!this.uvs2&&p.uvs2&&(this.uvs2=new Float32Array(this.positions.length/3*2)),!this.uvs3&&p.uvs3&&(this.uvs3=new Float32Array(this.positions.length/3*2)),!this.uvs4&&p.uvs4&&(this.uvs4=new Float32Array(this.positions.length/3*2)),!this.uvs5&&p.uvs5&&(this.uvs5=new Float32Array(this.positions.length/3*2)),!this.uvs6&&p.uvs6&&(this.uvs6=new Float32Array(this.positions.length/3*2)),!this.colors&&p.colors&&(this.colors=new Float32Array(this.positions.length/3*4),this.colors.fill(1)),!this.matricesIndices&&p.matricesIndices&&(this.matricesIndices=new Float32Array(this.positions.length/3*4)),!this.matricesWeights&&p.matricesWeights&&(this.matricesWeights=new Float32Array(this.positions.length/3*4)),!this.matricesIndicesExtra&&p.matricesIndicesExtra&&(this.matricesIndicesExtra=new Float32Array(this.positions.length/3*4)),!this.matricesWeightsExtra&&p.matricesWeightsExtra&&(this.matricesWeightsExtra=new Float32Array(this.positions.length/3*4)));for(const p of l)if(p){if(o)this.normals&&!p.normals&&(p.normals=new Float32Array(p.positions.length)),this.tangents&&!p.tangents&&(p.tangents=new Float32Array(p.positions.length/3*4)),this.uvs&&!p.uvs&&(p.uvs=new Float32Array(p.positions.length/3*2)),this.uvs2&&!p.uvs2&&(p.uvs2=new Float32Array(p.positions.length/3*2)),this.uvs3&&!p.uvs3&&(p.uvs3=new Float32Array(p.positions.length/3*2)),this.uvs4&&!p.uvs4&&(p.uvs4=new Float32Array(p.positions.length/3*2)),this.uvs5&&!p.uvs5&&(p.uvs5=new Float32Array(p.positions.length/3*2)),this.uvs6&&!p.uvs6&&(p.uvs6=new Float32Array(p.positions.length/3*2)),this.colors&&!p.colors&&(p.colors=new Float32Array(p.positions.length/3*4),p.colors.fill(1)),this.matricesIndices&&!p.matricesIndices&&(p.matricesIndices=new Float32Array(p.positions.length/3*4)),this.matricesWeights&&!p.matricesWeights&&(p.matricesWeights=new Float32Array(p.positions.length/3*4)),this.matricesIndicesExtra&&!p.matricesIndicesExtra&&(p.matricesIndicesExtra=new Float32Array(p.positions.length/3*4)),this.matricesWeightsExtra&&!p.matricesWeightsExtra&&(p.matricesWeightsExtra=new Float32Array(p.positions.length/3*4));else if(p._validate(),!this.normals!=!p.normals||!this.tangents!=!p.tangents||!this.uvs!=!p.uvs||!this.uvs2!=!p.uvs2||!this.uvs3!=!p.uvs3||!this.uvs4!=!p.uvs4||!this.uvs5!=!p.uvs5||!this.uvs6!=!p.uvs6||!this.colors!=!p.colors||!this.matricesIndices!=!p.matricesIndices||!this.matricesWeights!=!p.matricesWeights||!this.matricesIndicesExtra!=!p.matricesIndicesExtra||!this.matricesWeightsExtra!=!p.matricesWeightsExtra)throw new Error("Cannot merge vertex data that do not have the same set of attributes")}if(n){let p=0,g=0,E=0;const v=[];let b=null;const R=[];for(const T of this.splitBasedOnMaterialID())R.push({vertexData:T,transform:e});for(const T of t)if(T.vertexData)for(const I of T.vertexData.splitBasedOnMaterialID())R.push({vertexData:I,transform:T.transform});R.sort((T,I)=>{const O=T.vertexData.materialInfos?T.vertexData.materialInfos[0].materialIndex:0,L=I.vertexData.materialInfos?I.vertexData.materialInfos[0].materialIndex:0;return O>L?1:O===L?0:-1});for(const T of R){const I=T.vertexData;if(I.materialInfos?p=I.materialInfos[0].materialIndex:p=0,b&&b.materialIndex===p)b.indexCount+=I.indices.length,b.verticesCount+=I.positions.length/3;else{const O=new Vo;O.materialIndex=p,O.indexStart=g,O.indexCount=I.indices.length,O.verticesStart=E,O.verticesCount=I.positions.length/3,v.push(O),b=O}g+=I.indices.length,E+=I.positions.length/3}const S=R.splice(0,1)[0];c=S.vertexData,e=S.transform,l=R.map(T=>T.vertexData),t=R,this.materialInfos=v}const h=l.reduce((p,g)=>{var E;return p+(((E=g.indices)==null?void 0:E.length)??0)},((d=c.indices)==null?void 0:d.length)??0);let u=s||l.some(p=>p.indices===c.indices)?(_=c.indices)==null?void 0:_.slice():c.indices;if(h>0){let p=(u==null?void 0:u.length)??0;if(u||(u=new Array(h)),u.length!==h){if(Array.isArray(u))u.length=h;else{const E=i||u instanceof Uint32Array?new Uint32Array(h):new Uint16Array(h);E.set(u),u=E}e&&e.determinant()<0&&ee._FlipFaces(u,0,p)}let g=c.positions?c.positions.length/3:0;for(const{vertexData:E,transform:v}of t)if(E.indices){for(let b=0;b<E.indices.length;b++)u[p+b]=E.indices[b]+g;v&&v.determinant()<0&&ee._FlipFaces(u,p,E.indices.length),g+=E.positions.length/3,p+=E.indices.length,r&&(yield)}}return this.indices=u,this.positions=ee._MergeElement(x.PositionKind,c.positions,e,t.map(p=>[p.vertexData.positions,p.transform])),r&&(yield),c.normals&&(this.normals=ee._MergeElement(x.NormalKind,c.normals,e,t.map(p=>[p.vertexData.normals,p.transform])),r&&(yield)),c.tangents&&(this.tangents=ee._MergeElement(x.TangentKind,c.tangents,e,t.map(p=>[p.vertexData.tangents,p.transform])),r&&(yield)),c.uvs&&(this.uvs=ee._MergeElement(x.UVKind,c.uvs,e,t.map(p=>[p.vertexData.uvs,p.transform])),r&&(yield)),c.uvs2&&(this.uvs2=ee._MergeElement(x.UV2Kind,c.uvs2,e,t.map(p=>[p.vertexData.uvs2,p.transform])),r&&(yield)),c.uvs3&&(this.uvs3=ee._MergeElement(x.UV3Kind,c.uvs3,e,t.map(p=>[p.vertexData.uvs3,p.transform])),r&&(yield)),c.uvs4&&(this.uvs4=ee._MergeElement(x.UV4Kind,c.uvs4,e,t.map(p=>[p.vertexData.uvs4,p.transform])),r&&(yield)),c.uvs5&&(this.uvs5=ee._MergeElement(x.UV5Kind,c.uvs5,e,t.map(p=>[p.vertexData.uvs5,p.transform])),r&&(yield)),c.uvs6&&(this.uvs6=ee._MergeElement(x.UV6Kind,c.uvs6,e,t.map(p=>[p.vertexData.uvs6,p.transform])),r&&(yield)),c.colors&&(this.colors=ee._MergeElement(x.ColorKind,c.colors,e,t.map(p=>[p.vertexData.colors,p.transform])),(c.hasVertexAlpha!==void 0||t.some(p=>p.vertexData.hasVertexAlpha!==void 0))&&(this.hasVertexAlpha=c.hasVertexAlpha||t.some(p=>p.vertexData.hasVertexAlpha)),r&&(yield)),c.matricesIndices&&(this.matricesIndices=ee._MergeElement(x.MatricesIndicesKind,c.matricesIndices,e,t.map(p=>[p.vertexData.matricesIndices,p.transform])),r&&(yield)),c.matricesWeights&&(this.matricesWeights=ee._MergeElement(x.MatricesWeightsKind,c.matricesWeights,e,t.map(p=>[p.vertexData.matricesWeights,p.transform])),r&&(yield)),c.matricesIndicesExtra&&(this.matricesIndicesExtra=ee._MergeElement(x.MatricesIndicesExtraKind,c.matricesIndicesExtra,e,t.map(p=>[p.vertexData.matricesIndicesExtra,p.transform])),r&&(yield)),c.matricesWeightsExtra&&(this.matricesWeightsExtra=ee._MergeElement(x.MatricesWeightsExtraKind,c.matricesWeightsExtra,e,t.map(p=>[p.vertexData.matricesWeightsExtra,p.transform]))),this}static _MergeElement(e,t,i,r){const s=r.filter(l=>l[0]!==null&&l[0]!==void 0);if(!t&&s.length==0)return t;if(!t)return this._MergeElement(e,s[0][0],s[0][1],s.slice(1));const n=s.reduce((l,c)=>l+c[0].length,t.length),o=e===x.PositionKind?ee._TransformVector3Coordinates:e===x.NormalKind?ee._TransformVector3Normals:e===x.TangentKind?ee._TransformVector4Normals:()=>{};if(t instanceof Float32Array){const l=new Float32Array(n);l.set(t),i&&o(l,i,0,t.length);let c=t.length;for(const[h,f]of s)l.set(h,c),f&&o(l,f,c,h.length),c+=h.length;return l}else{const l=new Array(n);for(let h=0;h<t.length;h++)l[h]=t[h];i&&o(l,i,0,t.length);let c=t.length;for(const[h,f]of s){for(let u=0;u<h.length;u++)l[c+u]=h[u];f&&o(l,f,c,h.length),c+=h.length}return l}}_validate(){if(!this.positions)throw new Ur("Positions are required",bs.MeshInvalidPositionsError);const e=(r,s)=>{const n=x.DeduceStride(r);if(s.length%n!==0)throw new Error("The "+r+"s array count must be a multiple of "+n);return s.length/n},t=e(x.PositionKind,this.positions),i=(r,s)=>{const n=e(r,s);if(n!==t)throw new Error("The "+r+"s element count ("+n+") does not match the positions count ("+t+")")};this.normals&&i(x.NormalKind,this.normals),this.tangents&&i(x.TangentKind,this.tangents),this.uvs&&i(x.UVKind,this.uvs),this.uvs2&&i(x.UV2Kind,this.uvs2),this.uvs3&&i(x.UV3Kind,this.uvs3),this.uvs4&&i(x.UV4Kind,this.uvs4),this.uvs5&&i(x.UV5Kind,this.uvs5),this.uvs6&&i(x.UV6Kind,this.uvs6),this.colors&&i(x.ColorKind,this.colors),this.matricesIndices&&i(x.MatricesIndicesKind,this.matricesIndices),this.matricesWeights&&i(x.MatricesWeightsKind,this.matricesWeights),this.matricesIndicesExtra&&i(x.MatricesIndicesExtraKind,this.matricesIndicesExtra),this.matricesWeightsExtra&&i(x.MatricesWeightsExtraKind,this.matricesWeightsExtra)}clone(){const e=this.serialize();return ee.Parse(e)}serialize(){const e={};if(this.positions&&(e.positions=Array.from(this.positions)),this.normals&&(e.normals=Array.from(this.normals)),this.tangents&&(e.tangents=Array.from(this.tangents)),this.uvs&&(e.uvs=Array.from(this.uvs)),this.uvs2&&(e.uvs2=Array.from(this.uvs2)),this.uvs3&&(e.uvs3=Array.from(this.uvs3)),this.uvs4&&(e.uvs4=Array.from(this.uvs4)),this.uvs5&&(e.uvs5=Array.from(this.uvs5)),this.uvs6&&(e.uvs6=Array.from(this.uvs6)),this.colors&&(e.colors=Array.from(this.colors),e.hasVertexAlpha=this.hasVertexAlpha),this.matricesIndices&&(e.matricesIndices=Array.from(this.matricesIndices),e.matricesIndices._isExpanded=!0),this.matricesWeights&&(e.matricesWeights=Array.from(this.matricesWeights)),this.matricesIndicesExtra&&(e.matricesIndicesExtra=Array.from(this.matricesIndicesExtra),e.matricesIndicesExtra._isExpanded=!0),this.matricesWeightsExtra&&(e.matricesWeightsExtra=Array.from(this.matricesWeightsExtra)),e.indices=this.indices?Array.from(this.indices):[],this.materialInfos){e.materialInfos=[];for(const t of this.materialInfos){const i={indexStart:t.indexStart,indexCount:t.indexCount,materialIndex:t.materialIndex,verticesStart:t.verticesStart,verticesCount:t.verticesCount};e.materialInfos.push(i)}}return e}static ExtractFromMesh(e,t,i){return ee._ExtractFrom(e,t,i)}static ExtractFromGeometry(e,t,i){return ee._ExtractFrom(e,t,i)}static _ExtractFrom(e,t,i){const r=new ee;if(e.isVerticesDataPresent(x.PositionKind)&&(r.positions=e.getVerticesData(x.PositionKind,t,i)),e.isVerticesDataPresent(x.NormalKind)&&(r.normals=e.getVerticesData(x.NormalKind,t,i)),e.isVerticesDataPresent(x.TangentKind)&&(r.tangents=e.getVerticesData(x.TangentKind,t,i)),e.isVerticesDataPresent(x.UVKind)&&(r.uvs=e.getVerticesData(x.UVKind,t,i)),e.isVerticesDataPresent(x.UV2Kind)&&(r.uvs2=e.getVerticesData(x.UV2Kind,t,i)),e.isVerticesDataPresent(x.UV3Kind)&&(r.uvs3=e.getVerticesData(x.UV3Kind,t,i)),e.isVerticesDataPresent(x.UV4Kind)&&(r.uvs4=e.getVerticesData(x.UV4Kind,t,i)),e.isVerticesDataPresent(x.UV5Kind)&&(r.uvs5=e.getVerticesData(x.UV5Kind,t,i)),e.isVerticesDataPresent(x.UV6Kind)&&(r.uvs6=e.getVerticesData(x.UV6Kind,t,i)),e.isVerticesDataPresent(x.ColorKind)){const s=e.geometry||e,n=s.getVertexBuffer(x.ColorKind),o=s.getVerticesData(x.ColorKind,t,i);if(n.getSize()===3){const l=new Float32Array(o.length*4/3);for(let c=0,h=0;c<o.length;c+=3,h+=4)l[h]=o[c],l[h+1]=o[c+1],l[h+2]=o[c+2],l[h+3]=1;r.colors=l}else if(n.getSize()===4)r.colors=o;else throw new Error(`Unexpected number of color components: ${n.getSize()}`)}return e.isVerticesDataPresent(x.MatricesIndicesKind)&&(r.matricesIndices=e.getVerticesData(x.MatricesIndicesKind,t,i)),e.isVerticesDataPresent(x.MatricesWeightsKind)&&(r.matricesWeights=e.getVerticesData(x.MatricesWeightsKind,t,i)),e.isVerticesDataPresent(x.MatricesIndicesExtraKind)&&(r.matricesIndicesExtra=e.getVerticesData(x.MatricesIndicesExtraKind,t,i)),e.isVerticesDataPresent(x.MatricesWeightsExtraKind)&&(r.matricesWeightsExtra=e.getVerticesData(x.MatricesWeightsExtraKind,t,i)),r.indices=e.getIndices(t,i),r}static CreateRibbon(e){throw Le("ribbonBuilder")}static CreateBox(e){throw Le("boxBuilder")}static CreateTiledBox(e){throw Le("tiledBoxBuilder")}static CreateTiledPlane(e){throw Le("tiledPlaneBuilder")}static CreateSphere(e){throw Le("sphereBuilder")}static CreateCylinder(e){throw Le("cylinderBuilder")}static CreateTorus(e){throw Le("torusBuilder")}static CreateLineSystem(e){throw Le("linesBuilder")}static CreateDashedLines(e){throw Le("linesBuilder")}static CreateGround(e){throw Le("groundBuilder")}static CreateTiledGround(e){throw Le("groundBuilder")}static CreateGroundFromHeightMap(e){throw Le("groundBuilder")}static CreatePlane(e){throw Le("planeBuilder")}static CreateDisc(e){throw Le("discBuilder")}static CreatePolygon(e,t,i,r,s,n,o){throw Le("polygonBuilder")}static CreateIcoSphere(e){throw Le("icoSphereBuilder")}static CreatePolyhedron(e){throw Le("polyhedronBuilder")}static CreateCapsule(e={orientation:m.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){throw Le("capsuleBuilder")}static CreateTorusKnot(e){throw Le("torusKnotBuilder")}static ComputeNormals(e,t,i,r){let s=0,n=0,o=0,l=0,c=0,h=0,f=0,u=0,d=0,_=0,p=0,g=0,E=0,v=0,b=0,R=0,S=0,T=0,I=0,O=0,L=!1,w=!1,$=!1,J=!1,ce=1,le=0,oe=null;r&&(L=!!r.facetNormals,w=!!r.facetPositions,$=!!r.facetPartitioning,ce=r.useRightHandedSystem===!0?-1:1,le=r.ratio||0,J=!!r.depthSort,oe=r.distanceTo,J&&oe===void 0&&(oe=m.Zero()));let ue=0,Pe=0,Se=0,ie=0;for($&&r&&r.bbSize&&(ue=r.subDiv.X*le/r.bbSize.x,Pe=r.subDiv.Y*le/r.bbSize.y,Se=r.subDiv.Z*le/r.bbSize.z,ie=r.subDiv.max*r.subDiv.max,r.facetPartitioning.length=0),s=0;s<e.length;s++)i[s]=0;const K=t.length/3|0;for(s=0;s<K;s++){if(g=t[s*3]*3,E=g+1,v=g+2,b=t[s*3+1]*3,R=b+1,S=b+2,T=t[s*3+2]*3,I=T+1,O=T+2,n=e[g]-e[b],o=e[E]-e[R],l=e[v]-e[S],c=e[T]-e[b],h=e[I]-e[R],f=e[O]-e[S],u=ce*(o*f-l*h),d=ce*(l*c-n*f),_=ce*(n*h-o*c),p=Math.sqrt(u*u+d*d+_*_),p=p===0?1:p,u/=p,d/=p,_/=p,L&&r&&(r.facetNormals[s].x=u,r.facetNormals[s].y=d,r.facetNormals[s].z=_),w&&r&&(r.facetPositions[s].x=(e[g]+e[b]+e[T])/3,r.facetPositions[s].y=(e[E]+e[R]+e[I])/3,r.facetPositions[s].z=(e[v]+e[S]+e[O])/3),$&&r){const M=Math.floor((r.facetPositions[s].x-r.bInfo.minimum.x*le)*ue),V=Math.floor((r.facetPositions[s].y-r.bInfo.minimum.y*le)*Pe),re=Math.floor((r.facetPositions[s].z-r.bInfo.minimum.z*le)*Se),ve=Math.floor((e[g]-r.bInfo.minimum.x*le)*ue),Be=Math.floor((e[E]-r.bInfo.minimum.y*le)*Pe),fe=Math.floor((e[v]-r.bInfo.minimum.z*le)*Se),me=Math.floor((e[b]-r.bInfo.minimum.x*le)*ue),Oe=Math.floor((e[R]-r.bInfo.minimum.y*le)*Pe),Ee=Math.floor((e[S]-r.bInfo.minimum.z*le)*Se),Ue=Math.floor((e[T]-r.bInfo.minimum.x*le)*ue),vt=Math.floor((e[I]-r.bInfo.minimum.y*le)*Pe),xe=Math.floor((e[O]-r.bInfo.minimum.z*le)*Se),Ye=ve+r.subDiv.max*Be+ie*fe,Me=me+r.subDiv.max*Oe+ie*Ee,Tt=Ue+r.subDiv.max*vt+ie*xe,Lt=M+r.subDiv.max*V+ie*re;r.facetPartitioning[Lt]=r.facetPartitioning[Lt]?r.facetPartitioning[Lt]:new Array,r.facetPartitioning[Ye]=r.facetPartitioning[Ye]?r.facetPartitioning[Ye]:new Array,r.facetPartitioning[Me]=r.facetPartitioning[Me]?r.facetPartitioning[Me]:new Array,r.facetPartitioning[Tt]=r.facetPartitioning[Tt]?r.facetPartitioning[Tt]:new Array,r.facetPartitioning[Ye].push(s),Me!=Ye&&r.facetPartitioning[Me].push(s),Tt==Me||Tt==Ye||r.facetPartitioning[Tt].push(s),Lt==Ye||Lt==Me||Lt==Tt||r.facetPartitioning[Lt].push(s)}if(J&&r&&r.facetPositions){const M=r.depthSortedFacets[s];M.ind=s*3,M.sqDistance=m.DistanceSquared(r.facetPositions[s],oe)}i[g]+=u,i[E]+=d,i[v]+=_,i[b]+=u,i[R]+=d,i[S]+=_,i[T]+=u,i[I]+=d,i[O]+=_}for(s=0;s<i.length/3;s++)u=i[s*3],d=i[s*3+1],_=i[s*3+2],p=Math.sqrt(u*u+d*d+_*_),p=p===0?1:p,u/=p,d/=p,_/=p,i[s*3]=u,i[s*3+1]=d,i[s*3+2]=_}static _ComputeSides(e,t,i,r,s,n,o){const l=i.length,c=r.length;let h,f;switch(e=e||ee.DEFAULTSIDE,e){case ee.FRONTSIDE:break;case ee.BACKSIDE:for(h=0;h<l;h+=3){const u=i[h];i[h]=i[h+2],i[h+2]=u}for(f=0;f<c;f++)r[f]=-r[f];break;case ee.DOUBLESIDE:{const u=t.length,d=u/3;for(let g=0;g<u;g++)t[u+g]=t[g];for(h=0;h<l;h+=3)i[h+l]=i[h+2]+d,i[h+1+l]=i[h+1]+d,i[h+2+l]=i[h]+d;for(f=0;f<c;f++)r[c+f]=-r[f];const _=s.length;let p=0;for(p=0;p<_;p++)s[p+_]=s[p];for(n=n||new Fe(0,0,1,1),o=o||new Fe(0,0,1,1),p=0,h=0;h<_/2;h++)s[p]=n.x+(n.z-n.x)*s[p],s[p+1]=n.y+(n.w-n.y)*s[p+1],s[p+_]=o.x+(o.z-o.x)*s[p+_],s[p+_+1]=o.y+(o.w-o.y)*s[p+_+1],p+=2;break}}}static Parse(e){const t=new ee,i=e.positions;i&&t.set(i,x.PositionKind);const r=e.normals;r&&t.set(r,x.NormalKind);const s=e.tangents;s&&t.set(s,x.TangentKind);const n=e.uvs;n&&t.set(n,x.UVKind);const o=e.uvs2;o&&t.set(o,x.UV2Kind);const l=e.uvs3;l&&t.set(l,x.UV3Kind);const c=e.uvs4;c&&t.set(c,x.UV4Kind);const h=e.uvs5;h&&t.set(h,x.UV5Kind);const f=e.uvs6;f&&t.set(f,x.UV6Kind);const u=e.colors;u&&(t.set(Ne.CheckColors4(u,i.length/3),x.ColorKind),e.hasVertexAlpha!==void 0&&(t.hasVertexAlpha=e.hasVertexAlpha));const d=e.matricesIndices;d&&t.set(d,x.MatricesIndicesKind);const _=e.matricesWeights;_&&t.set(_,x.MatricesWeightsKind);const p=e.indices;p&&(t.indices=p);const g=e.materialInfos;if(g){t.materialInfos=[];for(const E of g){const v=new Vo;v.indexCount=E.indexCount,v.indexStart=E.indexStart,v.verticesCount=E.verticesCount,v.verticesStart=E.verticesStart,v.materialIndex=E.materialIndex,t.materialInfos.push(v)}}return t}static ImportVertexData(e,t){const i=ee.Parse(e);t.setAllVerticesData(i,e.updatable)}}ee.FRONTSIDE=0;ee.BACKSIDE=1;ee.DOUBLESIDE=2;ee.DEFAULTSIDE=0;ee._UniqueIDGenerator=0;A([Fr.filter((...[a])=>!Array.isArray(a))],ee,"_TransformVector3Coordinates",null);A([Fr.filter((...[a])=>!Array.isArray(a))],ee,"_TransformVector3Normals",null);A([Fr.filter((...[a])=>!Array.isArray(a))],ee,"_TransformVector4Normals",null);A([Fr.filter((...[a])=>!Array.isArray(a))],ee,"_FlipFaces",null);class Bt{static get ForceFullSceneLoadingForIncremental(){return Bt._ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){Bt._ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return Bt._ShowLoadingScreen}static set ShowLoadingScreen(e){Bt._ShowLoadingScreen=e}static get loggingLevel(){return Bt._LoggingLevel}static set loggingLevel(e){Bt._LoggingLevel=e}static get CleanBoneMatrixWeights(){return Bt._CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){Bt._CleanBoneMatrixWeights=e}}Bt._ForceFullSceneLoadingForIncremental=!1;Bt._ShowLoadingScreen=!0;Bt._CleanBoneMatrixWeights=!1;Bt._LoggingLevel=0;class ri{get boundingBias(){return this._boundingBias}set boundingBias(e){this._boundingBias?this._boundingBias.copyFrom(e):this._boundingBias=e.clone(),this._updateBoundingInfo(!0,null)}static CreateGeometryForMesh(e){const t=new ri(ri.RandomId(),e.getScene());return t.applyToMesh(e),t}get meshes(){return this._meshes}constructor(e,t,i,r=!1,s=null){this.delayLoadState=0,this._totalVertices=0,this._isDisposed=!1,this._extend={minimum:new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),maximum:new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},this._indexBufferIsUpdatable=!1,this._positionsCache=[],this._parentContainer=null,this.useBoundingInfoFromGeometry=!1,this._scene=t||Re.LastCreatedScene,this._scene&&(this.id=e,this.uniqueId=this._scene.getUniqueId(),this._engine=this._scene.getEngine(),this._meshes=[],this._vertexBuffers={},this._indices=[],this._updatable=r,i?this.setAllVerticesData(i,r):this._totalVertices=0,this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObjects={}),s&&(this.applyToMesh(s),s.computeWorldMatrix(!0)))}get extend(){return this._extend}getScene(){return this._scene}getEngine(){return this._engine}isReady(){return this.delayLoadState===1||this.delayLoadState===0}get doNotSerialize(){for(let e=0;e<this._meshes.length;e++)if(!this._meshes[e].doNotSerialize)return!1;return!0}_rebuild(){this._vertexArrayObjects&&(this._vertexArrayObjects={}),this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable,"Geometry_"+this.id+"_IndexBuffer"));const e=new Set;for(const t in this._vertexBuffers)e.add(this._vertexBuffers[t].getWrapperBuffer());e.forEach(t=>{t._rebuild()})}setAllVerticesData(e,t){e.applyToGeometry(this,t),this._notifyUpdate()}setVerticesData(e,t,i=!1,r){i&&Array.isArray(t)&&(t=new Float32Array(t));const s=new x(this._engine,t,e,{updatable:i,postponeInternalCreation:this._meshes.length===0,stride:r,label:"Geometry_"+this.id+"_"+e});this.setVerticesBuffer(s)}removeVerticesData(e){this._vertexBuffers[e]&&(this._vertexBuffers[e].dispose(),delete this._vertexBuffers[e]),this._vertexArrayObjects&&this._disposeVertexArrayObjects()}setVerticesBuffer(e,t=null,i=!0){const r=e.getKind();this._vertexBuffers[r]&&i&&this._vertexBuffers[r].dispose(),e._buffer&&e._buffer._increaseReferences(),this._vertexBuffers[r]=e;const s=this._meshes,n=s.length;if(r===x.PositionKind){this._totalVertices=t??e._maxVerticesCount,this._updateExtend(e.getFloatData(this._totalVertices)),this._resetPointsArrayCache();const o=this._extend&&this._extend.minimum||new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),l=this._extend&&this._extend.maximum||new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);for(let c=0;c<n;c++){const h=s[c];h.buildBoundingInfo(o,l),h._createGlobalSubMesh(h.isUnIndexed),h.computeWorldMatrix(!0),h.synchronizeInstances()}}this._notifyUpdate(r)}updateVerticesDataDirectly(e,t,i,r=!1){const s=this.getVertexBuffer(e);s&&(s.updateDirectly(t,i,r),this._notifyUpdate(e))}updateVerticesData(e,t,i=!1){const r=this.getVertexBuffer(e);r&&(r.update(t),e===x.PositionKind&&this._updateBoundingInfo(i,t),this._notifyUpdate(e))}_updateBoundingInfo(e,t){if(e&&this._updateExtend(t),this._resetPointsArrayCache(),e){const i=this._meshes;for(const r of i){r.hasBoundingInfo?r.getBoundingInfo().reConstruct(this._extend.minimum,this._extend.maximum):r.buildBoundingInfo(this._extend.minimum,this._extend.maximum);const s=r.subMeshes;for(const n of s)n.refreshBoundingInfo()}}}_bind(e,t,i,r){if(!e)return;t===void 0&&(t=this._indexBuffer);const s=this.getVertexBuffers();if(!s)return;if(t!=this._indexBuffer||!this._vertexArrayObjects&&!r){this._engine.bindBuffers(s,t,e,i);return}const n=r||this._vertexArrayObjects,o=this._engine;n[e.key]||(n[e.key]=o.recordVertexArrayObject(s,t,e,i)),o.bindVertexArrayObject(n[e.key],t)}getTotalVertices(){return this.isReady()?this._totalVertices:0}getVerticesData(e,t,i){const r=this.getVertexBuffer(e);return r?r.getFloatData(this._totalVertices,i||t&&this._meshes.length!==1):null}copyVerticesData(e,t){const i=this.getVertexBuffer(e);if(!i)return;t[e]||(t[e]=new Float32Array(this._totalVertices*i.getSize()));const r=i.getData();r&&$A(r,i.getSize(),i.type,i.byteOffset,i.byteStride,i.normalized,this._totalVertices,t[e])}isVertexBufferUpdatable(e){const t=this._vertexBuffers[e];return t?t.isUpdatable():!1}getVertexBuffer(e){return this.isReady()?this._vertexBuffers[e]:null}getVertexBuffers(){return this.isReady()?this._vertexBuffers:null}isVerticesDataPresent(e){return this._vertexBuffers?this._vertexBuffers[e]!==void 0:this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1}getVerticesDataKinds(){const e=[];let t;if(!this._vertexBuffers&&this._delayInfo)for(t in this._delayInfo)e.push(t);else for(t in this._vertexBuffers)e.push(t);return e}updateIndices(e,t,i=!1){if(this._indexBuffer)if(!this._indexBufferIsUpdatable)this.setIndices(e,null,!0);else{const r=e.length!==this._indices.length;if(i||(this._indices=e.slice()),this._engine.updateDynamicIndexBuffer(this._indexBuffer,e,t),r)for(const s of this._meshes)s._createGlobalSubMesh(!0)}}setIndexBuffer(e,t,i,r=null){this._indices=[],this._indexBufferIsUpdatable=!1,this._indexBuffer=e,this._totalVertices=t,this._totalIndices=i,r===null?e.is32Bits=t>65535:e.is32Bits=r;for(const s of this._meshes)s._createGlobalSubMesh(!0),s.synchronizeInstances();this._notifyUpdate()}setIndices(e,t=null,i=!1,r=!1){this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indices=e,this._indexBufferIsUpdatable=i,this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,i,"Geometry_"+this.id+"_IndexBuffer")),t!=null&&(this._totalVertices=t);for(const s of this._meshes)s._createGlobalSubMesh(!r),s.synchronizeInstances();this._notifyUpdate()}getTotalIndices(){return this.isReady()?this._totalIndices!==void 0?this._totalIndices:this._indices.length:0}getIndices(e,t){if(!this.isReady())return null;const i=this._indices;return!t&&(!e||this._meshes.length===1)?i:i.slice()}getIndexBuffer(){return this.isReady()?this._indexBuffer:null}_releaseVertexArrayObject(e=null){!e||!this._vertexArrayObjects||this._vertexArrayObjects[e.key]&&(this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e.key]),delete this._vertexArrayObjects[e.key])}releaseForMesh(e,t){const i=this._meshes,r=i.indexOf(e);r!==-1&&(i.splice(r,1),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject(),e._geometry=null,i.length===0&&t&&this.dispose())}applyToMesh(e){if(e._geometry===this)return;const t=e._geometry;t&&t.releaseForMesh(e),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject();const i=this._meshes;e._geometry=this,e._internalAbstractMeshDataInfo._positions=null,this._scene.pushGeometry(this),i.push(e),this.isReady()?this._applyToMesh(e):this._boundingInfo&&e.setBoundingInfo(this._boundingInfo)}_updateExtend(e=null){if(this.useBoundingInfoFromGeometry&&this._boundingInfo)this._extend={minimum:this._boundingInfo.minimum.clone(),maximum:this._boundingInfo.maximum.clone()};else{if(!e&&(e=this.getVerticesData(x.PositionKind),!e))return;this._extend=Fm(e,0,this._totalVertices,this.boundingBias,3)}}_applyToMesh(e){const t=this._meshes.length;for(const i in this._vertexBuffers)t===1&&this._vertexBuffers[i].create(),i===x.PositionKind&&(this._extend||this._updateExtend(),e.buildBoundingInfo(this._extend.minimum,this._extend.maximum),e._createGlobalSubMesh(e.isUnIndexed),e._updateBoundingInfo());t===1&&this._indices&&this._indices.length>0&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable,"Geometry_"+this.id+"_IndexBuffer")),e._syncGeometryWithMorphTargetManager(),e.synchronizeInstances()}_notifyUpdate(e){this.onGeometryUpdated&&this.onGeometryUpdated(this,e),this._vertexArrayObjects&&this._disposeVertexArrayObjects();for(const t of this._meshes)t._markSubMeshesAsAttributesDirty()}load(e,t){if(this.delayLoadState!==2){if(this.isReady()){t&&t();return}this.delayLoadState=2,this._queueLoad(e,t)}}_queueLoad(e,t){this.delayLoadingFile&&(e.addPendingData(this),e._loadFile(this.delayLoadingFile,i=>{if(!this._delayLoadingFunction)return;this._delayLoadingFunction(JSON.parse(i),this),this.delayLoadState=1,this._delayInfo=[],e.removePendingData(this);const r=this._meshes,s=r.length;for(let n=0;n<s;n++)this._applyToMesh(r[n]);t&&t()},void 0,!0))}toLeftHanded(){const e=this.getIndices(!1);if(e!=null&&e.length>0){for(let r=0;r<e.length;r+=3){const s=e[r+0];e[r+0]=e[r+2],e[r+2]=s}this.setIndices(e)}const t=this.getVerticesData(x.PositionKind,!1);if(t!=null&&t.length>0){for(let r=0;r<t.length;r+=3)t[r+2]=-t[r+2];this.setVerticesData(x.PositionKind,t,!1)}const i=this.getVerticesData(x.NormalKind,!1);if(i!=null&&i.length>0){for(let r=0;r<i.length;r+=3)i[r+2]=-i[r+2];this.setVerticesData(x.NormalKind,i,!1)}}_resetPointsArrayCache(){this._positions=null}_generatePointsArray(){if(this._positions)return!0;const e=this.getVerticesData(x.PositionKind);if(!e||e.length===0)return!1;for(let t=this._positionsCache.length*3,i=this._positionsCache.length;t<e.length;t+=3,++i)this._positionsCache[i]=m.FromArray(e,t);for(let t=0,i=0;t<e.length;t+=3,++i)this._positionsCache[i].set(e[0+t],e[1+t],e[2+t]);return this._positionsCache.length=e.length/3,this._positions=this._positionsCache,!0}isDisposed(){return this._isDisposed}_disposeVertexArrayObjects(){if(this._vertexArrayObjects){for(const i in this._vertexArrayObjects)this._engine.releaseVertexArrayObject(this._vertexArrayObjects[i]);this._vertexArrayObjects={};const e=this._meshes,t=e.length;for(let i=0;i<t;i++)e[i]._invalidateInstanceVertexArrayObject()}}dispose(){const e=this._meshes,t=e.length;let i;for(i=0;i<t;i++)this.releaseForMesh(e[i]);this._meshes.length=0,this._disposeVertexArrayObjects();for(const r in this._vertexBuffers)this._vertexBuffers[r].dispose();if(this._vertexBuffers={},this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=0,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null,this._scene.removeGeometry(this),this._parentContainer){const r=this._parentContainer.geometries.indexOf(this);r>-1&&this._parentContainer.geometries.splice(r,1),this._parentContainer=null}this._isDisposed=!0}copy(e){const t=new ee;t.indices=[];const i=this.getIndices();if(i)for(let l=0;l<i.length;l++)t.indices.push(i[l]);let r=!1,s=!1,n;for(n in this._vertexBuffers){const l=this.getVerticesData(n);if(l&&(l instanceof Float32Array?t.set(new Float32Array(l),n):t.set(l.slice(0),n),!s)){const c=this.getVertexBuffer(n);c&&(r=c.isUpdatable(),s=!r)}}const o=new ri(e,this._scene,t,r);o.delayLoadState=this.delayLoadState,o.delayLoadingFile=this.delayLoadingFile,o._delayLoadingFunction=this._delayLoadingFunction;for(n in this._delayInfo)o._delayInfo=o._delayInfo||[],o._delayInfo.push(n);return o._boundingInfo=new Mi(this._extend.minimum,this._extend.maximum),o}serialize(){const e={};return e.id=this.id,e.uniqueId=this.uniqueId,e.updatable=this._updatable,qe&&qe.HasTags(this)&&(e.tags=qe.GetTags(this)),e}_toNumberArray(e){return Array.isArray(e)?e:Array.prototype.slice.call(e)}clearCachedData(){this._indices=[],this._resetPointsArrayCache();for(const e in this._vertexBuffers)Object.prototype.hasOwnProperty.call(this._vertexBuffers,e)&&(this._vertexBuffers[e]._buffer._data=null)}serializeVerticeData(){const e=this.serialize();return this.isVerticesDataPresent(x.PositionKind)&&(e.positions=this._toNumberArray(this.getVerticesData(x.PositionKind)),this.isVertexBufferUpdatable(x.PositionKind)&&(e.positions._updatable=!0)),this.isVerticesDataPresent(x.NormalKind)&&(e.normals=this._toNumberArray(this.getVerticesData(x.NormalKind)),this.isVertexBufferUpdatable(x.NormalKind)&&(e.normals._updatable=!0)),this.isVerticesDataPresent(x.TangentKind)&&(e.tangents=this._toNumberArray(this.getVerticesData(x.TangentKind)),this.isVertexBufferUpdatable(x.TangentKind)&&(e.tangents._updatable=!0)),this.isVerticesDataPresent(x.UVKind)&&(e.uvs=this._toNumberArray(this.getVerticesData(x.UVKind)),this.isVertexBufferUpdatable(x.UVKind)&&(e.uvs._updatable=!0)),this.isVerticesDataPresent(x.UV2Kind)&&(e.uvs2=this._toNumberArray(this.getVerticesData(x.UV2Kind)),this.isVertexBufferUpdatable(x.UV2Kind)&&(e.uvs2._updatable=!0)),this.isVerticesDataPresent(x.UV3Kind)&&(e.uvs3=this._toNumberArray(this.getVerticesData(x.UV3Kind)),this.isVertexBufferUpdatable(x.UV3Kind)&&(e.uvs3._updatable=!0)),this.isVerticesDataPresent(x.UV4Kind)&&(e.uvs4=this._toNumberArray(this.getVerticesData(x.UV4Kind)),this.isVertexBufferUpdatable(x.UV4Kind)&&(e.uvs4._updatable=!0)),this.isVerticesDataPresent(x.UV5Kind)&&(e.uvs5=this._toNumberArray(this.getVerticesData(x.UV5Kind)),this.isVertexBufferUpdatable(x.UV5Kind)&&(e.uvs5._updatable=!0)),this.isVerticesDataPresent(x.UV6Kind)&&(e.uvs6=this._toNumberArray(this.getVerticesData(x.UV6Kind)),this.isVertexBufferUpdatable(x.UV6Kind)&&(e.uvs6._updatable=!0)),this.isVerticesDataPresent(x.ColorKind)&&(e.colors=this._toNumberArray(this.getVerticesData(x.ColorKind)),this.isVertexBufferUpdatable(x.ColorKind)&&(e.colors._updatable=!0)),this.isVerticesDataPresent(x.MatricesIndicesKind)&&(e.matricesIndices=this._toNumberArray(this.getVerticesData(x.MatricesIndicesKind)),e.matricesIndices._isExpanded=!0,this.isVertexBufferUpdatable(x.MatricesIndicesKind)&&(e.matricesIndices._updatable=!0)),this.isVerticesDataPresent(x.MatricesWeightsKind)&&(e.matricesWeights=this._toNumberArray(this.getVerticesData(x.MatricesWeightsKind)),this.isVertexBufferUpdatable(x.MatricesWeightsKind)&&(e.matricesWeights._updatable=!0)),e.indices=this._toNumberArray(this.getIndices()),e}static ExtractFromMesh(e,t){const i=e._geometry;return i?i.copy(t):null}static RandomId(){return k.RandomId()}static _GetGeometryByLoadedUniqueId(e,t){for(let i=0;i<t.geometries.length;i++)if(t.geometries[i]._loadedUniqueId===e)return t.geometries[i];return null}static _ImportGeometry(e,t){const i=t.getScene(),r=e.geometryUniqueId,s=e.geometryId;if(r||s){const n=r?this._GetGeometryByLoadedUniqueId(r,i):i.getGeometryById(s);n&&n.applyToMesh(t)}else if(e instanceof ArrayBuffer){const n=t._binaryInfo;if(n.positionsAttrDesc&&n.positionsAttrDesc.count>0){const o=new Float32Array(e,n.positionsAttrDesc.offset,n.positionsAttrDesc.count);t.setVerticesData(x.PositionKind,o,!1)}if(n.normalsAttrDesc&&n.normalsAttrDesc.count>0){const o=new Float32Array(e,n.normalsAttrDesc.offset,n.normalsAttrDesc.count);t.setVerticesData(x.NormalKind,o,!1)}if(n.tangetsAttrDesc&&n.tangetsAttrDesc.count>0){const o=new Float32Array(e,n.tangetsAttrDesc.offset,n.tangetsAttrDesc.count);t.setVerticesData(x.TangentKind,o,!1)}if(n.uvsAttrDesc&&n.uvsAttrDesc.count>0){const o=new Float32Array(e,n.uvsAttrDesc.offset,n.uvsAttrDesc.count);t.setVerticesData(x.UVKind,o,!1)}if(n.uvs2AttrDesc&&n.uvs2AttrDesc.count>0){const o=new Float32Array(e,n.uvs2AttrDesc.offset,n.uvs2AttrDesc.count);t.setVerticesData(x.UV2Kind,o,!1)}if(n.uvs3AttrDesc&&n.uvs3AttrDesc.count>0){const o=new Float32Array(e,n.uvs3AttrDesc.offset,n.uvs3AttrDesc.count);t.setVerticesData(x.UV3Kind,o,!1)}if(n.uvs4AttrDesc&&n.uvs4AttrDesc.count>0){const o=new Float32Array(e,n.uvs4AttrDesc.offset,n.uvs4AttrDesc.count);t.setVerticesData(x.UV4Kind,o,!1)}if(n.uvs5AttrDesc&&n.uvs5AttrDesc.count>0){const o=new Float32Array(e,n.uvs5AttrDesc.offset,n.uvs5AttrDesc.count);t.setVerticesData(x.UV5Kind,o,!1)}if(n.uvs6AttrDesc&&n.uvs6AttrDesc.count>0){const o=new Float32Array(e,n.uvs6AttrDesc.offset,n.uvs6AttrDesc.count);t.setVerticesData(x.UV6Kind,o,!1)}if(n.colorsAttrDesc&&n.colorsAttrDesc.count>0){const o=new Float32Array(e,n.colorsAttrDesc.offset,n.colorsAttrDesc.count);t.setVerticesData(x.ColorKind,o,!1,n.colorsAttrDesc.stride)}if(n.matricesIndicesAttrDesc&&n.matricesIndicesAttrDesc.count>0){const o=new Int32Array(e,n.matricesIndicesAttrDesc.offset,n.matricesIndicesAttrDesc.count),l=[];for(let c=0;c<o.length;c++){const h=o[c];l.push(h&255),l.push((h&65280)>>8),l.push((h&16711680)>>16),l.push(h>>24&255)}t.setVerticesData(x.MatricesIndicesKind,l,!1)}if(n.matricesIndicesExtraAttrDesc&&n.matricesIndicesExtraAttrDesc.count>0){const o=new Int32Array(e,n.matricesIndicesExtraAttrDesc.offset,n.matricesIndicesExtraAttrDesc.count),l=[];for(let c=0;c<o.length;c++){const h=o[c];l.push(h&255),l.push((h&65280)>>8),l.push((h&16711680)>>16),l.push(h>>24&255)}t.setVerticesData(x.MatricesIndicesExtraKind,l,!1)}if(n.matricesWeightsAttrDesc&&n.matricesWeightsAttrDesc.count>0){const o=new Float32Array(e,n.matricesWeightsAttrDesc.offset,n.matricesWeightsAttrDesc.count);t.setVerticesData(x.MatricesWeightsKind,o,!1)}if(n.indicesAttrDesc&&n.indicesAttrDesc.count>0){const o=new Int32Array(e,n.indicesAttrDesc.offset,n.indicesAttrDesc.count);t.setIndices(o,null)}if(n.subMeshesAttrDesc&&n.subMeshesAttrDesc.count>0){const o=new Int32Array(e,n.subMeshesAttrDesc.offset,n.subMeshesAttrDesc.count*5);t.subMeshes=[];for(let l=0;l<n.subMeshesAttrDesc.count;l++){const c=o[l*5+0],h=o[l*5+1],f=o[l*5+2],u=o[l*5+3],d=o[l*5+4];Ei.AddToMesh(c,h,f,u,d,t)}}}else if(e.positions&&e.normals&&e.indices){if(t.setVerticesData(x.PositionKind,e.positions,e.positions._updatable),t.setVerticesData(x.NormalKind,e.normals,e.normals._updatable),e.tangents&&t.setVerticesData(x.TangentKind,e.tangents,e.tangents._updatable),e.uvs&&t.setVerticesData(x.UVKind,e.uvs,e.uvs._updatable),e.uvs2&&t.setVerticesData(x.UV2Kind,e.uvs2,e.uvs2._updatable),e.uvs3&&t.setVerticesData(x.UV3Kind,e.uvs3,e.uvs3._updatable),e.uvs4&&t.setVerticesData(x.UV4Kind,e.uvs4,e.uvs4._updatable),e.uvs5&&t.setVerticesData(x.UV5Kind,e.uvs5,e.uvs5._updatable),e.uvs6&&t.setVerticesData(x.UV6Kind,e.uvs6,e.uvs6._updatable),e.colors&&t.setVerticesData(x.ColorKind,Ne.CheckColors4(e.colors,e.positions.length/3),e.colors._updatable),e.matricesIndices)if(e.matricesIndices._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(x.MatricesIndicesKind,e.matricesIndices,e.matricesIndices._updatable);else{const n=[];for(let o=0;o<e.matricesIndices.length;o++){const l=e.matricesIndices[o];n.push(l&255),n.push((l&65280)>>8),n.push((l&16711680)>>16),n.push(l>>24&255)}t.setVerticesData(x.MatricesIndicesKind,n,e.matricesIndices._updatable)}if(e.matricesIndicesExtra)if(e.matricesIndicesExtra._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(x.MatricesIndicesExtraKind,e.matricesIndicesExtra,e.matricesIndicesExtra._updatable);else{const n=[];for(let o=0;o<e.matricesIndicesExtra.length;o++){const l=e.matricesIndicesExtra[o];n.push(l&255),n.push((l&65280)>>8),n.push((l&16711680)>>16),n.push(l>>24&255)}t.setVerticesData(x.MatricesIndicesExtraKind,n,e.matricesIndicesExtra._updatable)}e.matricesWeights&&(ri._CleanMatricesWeights(e,t),t.setVerticesData(x.MatricesWeightsKind,e.matricesWeights,e.matricesWeights._updatable)),e.matricesWeightsExtra&&t.setVerticesData(x.MatricesWeightsExtraKind,e.matricesWeightsExtra,e.matricesWeights._updatable),t.setIndices(e.indices,null)}if(e.subMeshes){t.subMeshes=[];for(let n=0;n<e.subMeshes.length;n++){const o=e.subMeshes[n];Ei.AddToMesh(o.materialIndex,o.verticesStart,o.verticesCount,o.indexStart,o.indexCount,t)}}t._shouldGenerateFlatShading&&(t.convertToFlatShadedMesh(),t._shouldGenerateFlatShading=!1),t.computeWorldMatrix(!0),i.onMeshImportedObservable.notifyObservers(t)}static _CleanMatricesWeights(e,t){if(!Bt.CleanBoneMatrixWeights)return;let r=0;if(e.skeletonId>-1){const f=t.getScene().getLastSkeletonById(e.skeletonId);if(!f)return;r=f.bones.length}else return;const s=t.getVerticesData(x.MatricesIndicesKind),n=t.getVerticesData(x.MatricesIndicesExtraKind),o=e.matricesWeights,l=e.matricesWeightsExtra,c=e.numBoneInfluencer,h=o.length;for(let f=0;f<h;f+=4){let u=0,d=-1;for(let _=0;_<4;_++){const p=o[f+_];u+=p,p<.001&&d<0&&(d=_)}if(l)for(let _=0;_<4;_++){const p=l[f+_];u+=p,p<.001&&d<0&&(d=_+4)}if((d<0||d>c-1)&&(d=c-1),u>.001){const _=1/u;for(let p=0;p<4;p++)o[f+p]*=_;if(l)for(let p=0;p<4;p++)l[f+p]*=_}else d>=4?(l[f+d-4]=1-u,n[f+d-4]=r):(o[f+d]=1-u,s[f+d]=r)}t.setVerticesData(x.MatricesIndicesKind,s),e.matricesWeightsExtra&&t.setVerticesData(x.MatricesIndicesExtraKind,n)}static Parse(e,t,i){const r=new ri(e.id,t,void 0,e.updatable);return r._loadedUniqueId=e.uniqueId,qe&&qe.AddTagsTo(r,e.tags),e.delayLoadingFile?(r.delayLoadState=4,r.delayLoadingFile=i+e.delayLoadingFile,r._boundingInfo=new Mi(m.FromArray(e.boundingBoxMinimum),m.FromArray(e.boundingBoxMaximum)),r._delayInfo=[],e.hasUVs&&r._delayInfo.push(x.UVKind),e.hasUVs2&&r._delayInfo.push(x.UV2Kind),e.hasUVs3&&r._delayInfo.push(x.UV3Kind),e.hasUVs4&&r._delayInfo.push(x.UV4Kind),e.hasUVs5&&r._delayInfo.push(x.UV5Kind),e.hasUVs6&&r._delayInfo.push(x.UV6Kind),e.hasColors&&r._delayInfo.push(x.ColorKind),e.hasMatricesIndices&&r._delayInfo.push(x.MatricesIndicesKind),e.hasMatricesWeights&&r._delayInfo.push(x.MatricesWeightsKind),r._delayLoadingFunction=ee.ImportVertexData):ee.ImportVertexData(e,r),t.pushGeometry(r,!0),r}}const lC=P.Compose(m.One(),z.FromEulerAngles(0,Math.PI,0),m.Zero());class we extends gt{get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._cache.useBillboardPosition=(this._billboardMode&we.BILLBOARDMODE_USE_POSITION)!==0,this._computeUseBillboardPath())}get preserveParentRotationForBillboard(){return this._preserveParentRotationForBillboard}set preserveParentRotationForBillboard(e){e!==this._preserveParentRotationForBillboard&&(this._preserveParentRotationForBillboard=e,this._computeUseBillboardPath())}_computeUseBillboardPath(){this._cache.useBillboardPath=this._billboardMode!==we.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}get infiniteDistance(){return this._infiniteDistance}set infiniteDistance(e){this._infiniteDistance!==e&&(this._infiniteDistance=e)}constructor(e,t=null,i=!0){super(e,t,!1),this._forward=new m(0,0,1),this._up=new m(0,1,0),this._right=new m(1,0,0),this._position=m.Zero(),this._rotation=m.Zero(),this._rotationQuaternion=null,this._scaling=m.One(),this._transformToBoneReferal=null,this._isAbsoluteSynced=!1,this._billboardMode=we.BILLBOARDMODE_NONE,this._preserveParentRotationForBillboard=!1,this.scalingDeterminant=1,this._infiniteDistance=!1,this.ignoreNonUniformScaling=!1,this.reIntegrateRotationIntoRotationQuaternion=!1,this._poseMatrix=null,this._localMatrix=P.Zero(),this._usePivotMatrix=!1,this._absolutePosition=m.Zero(),this._absoluteScaling=m.Zero(),this._absoluteRotationQuaternion=z.Identity(),this._pivotMatrix=P.Identity(),this._postMultiplyPivotMatrix=!1,this._isWorldMatrixFrozen=!1,this._indexInSceneTransformNodesArray=-1,this.onAfterWorldMatrixUpdateObservable=new U,this._nonUniformScaling=!1,i&&this.getScene().addTransformNode(this)}getClassName(){return"TransformNode"}get position(){return this._position}set position(e){this._position=e,this._markAsDirtyInternal()}isUsingPivotMatrix(){return this._usePivotMatrix}isUsingPostMultiplyPivotMatrix(){return this._postMultiplyPivotMatrix}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._rotationQuaternion=null,this._markAsDirtyInternal()}get scaling(){return this._scaling}set scaling(e){this._scaling=e,this._markAsDirtyInternal()}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(e){this._rotationQuaternion=e,e&&this._rotation.setAll(0),this._markAsDirtyInternal()}_markAsDirtyInternal(){this._isDirty||(this._isDirty=!0,this.customMarkAsDirty&&this.customMarkAsDirty())}get forward(){return m.TransformNormalFromFloatsToRef(0,0,this.getScene().useRightHandedSystem?-1:1,this.getWorldMatrix(),this._forward),this._forward.normalize()}get up(){return m.TransformNormalFromFloatsToRef(0,1,0,this.getWorldMatrix(),this._up),this._up.normalize()}get right(){return m.TransformNormalFromFloatsToRef(this.getScene().useRightHandedSystem?-1:1,0,0,this.getWorldMatrix(),this._right),this._right.normalize()}updatePoseMatrix(e){return this._poseMatrix?(this._poseMatrix.copyFrom(e),this):(this._poseMatrix=e.clone(),this)}getPoseMatrix(){return this._poseMatrix||(this._poseMatrix=P.Identity()),this._poseMatrix}_isSynchronized(){const e=this._cache;return!(this._billboardMode!==e.billboardMode||this._billboardMode!==we.BILLBOARDMODE_NONE||e.pivotMatrixUpdated||this._infiniteDistance||this._position._isDirty||this._scaling._isDirty||this._rotationQuaternion&&this._rotationQuaternion._isDirty||this._rotation._isDirty)}_initCache(){super._initCache();const e=this._cache;e.localMatrixUpdated=!1,e.billboardMode=-1,e.infiniteDistance=!1,e.useBillboardPosition=!1,e.useBillboardPath=!1}get absolutePosition(){return this.getAbsolutePosition()}get absoluteScaling(){return this._syncAbsoluteScalingAndRotation(),this._absoluteScaling}get absoluteRotationQuaternion(){return this._syncAbsoluteScalingAndRotation(),this._absoluteRotationQuaternion}setPreTransformMatrix(e){return this.setPivotMatrix(e,!1)}setPivotMatrix(e,t=!0){return this._pivotMatrix.copyFrom(e),this._usePivotMatrix=!this._pivotMatrix.isIdentity(),this._cache.pivotMatrixUpdated=!0,this._postMultiplyPivotMatrix=t,this._postMultiplyPivotMatrix&&(this._pivotMatrixInverse?this._pivotMatrix.invertToRef(this._pivotMatrixInverse):this._pivotMatrixInverse=P.Invert(this._pivotMatrix)),this}getPivotMatrix(){return this._pivotMatrix}instantiateHierarchy(e=null,t,i){const r=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0);r&&i&&i(this,r);for(const s of this.getChildTransformNodes(!0))s.instantiateHierarchy(r,t,i);return r}freezeWorldMatrix(e=null,t=!1){return e?t?(this._rotation.setAll(0),this._rotationQuaternion=this._rotationQuaternion||z.Identity(),e.decompose(this._scaling,this._rotationQuaternion,this._position),this.computeWorldMatrix(!0)):(this._worldMatrix=e,this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._afterComputeWorldMatrix()):(this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0)),this._isDirty=!1,this._isWorldMatrixFrozen=!0,this}unfreezeWorldMatrix(){return this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this}get isWorldMatrixFrozen(){return this._isWorldMatrixFrozen}getAbsolutePosition(){return this.computeWorldMatrix(),this._absolutePosition}setAbsolutePosition(e){if(!e)return this;let t,i,r;if(e.x===void 0){if(arguments.length<3)return this;t=arguments[0],i=arguments[1],r=arguments[2]}else t=e.x,i=e.y,r=e.z;if(this.parent){const s=F.Matrix[0];this.parent.getWorldMatrix().invertToRef(s),m.TransformCoordinatesFromFloatsToRef(t,i,r,s,this.position)}else this.position.x=t,this.position.y=i,this.position.z=r;return this._absolutePosition.copyFrom(e),this}setPositionWithLocalVector(e){return this.computeWorldMatrix(),this.position=m.TransformNormal(e,this._localMatrix),this}getPositionExpressedInLocalSpace(){this.computeWorldMatrix();const e=F.Matrix[0];return this._localMatrix.invertToRef(e),m.TransformNormal(this.position,e)}locallyTranslate(e){return this.computeWorldMatrix(!0),this.position=m.TransformCoordinates(e,this._localMatrix),this}lookAt(e,t=0,i=0,r=0,s=0){const n=we._LookAtVectorCache,o=s===0?this.position:this.getAbsolutePosition();if(e.subtractToRef(o,n),this.setDirection(n,t,i,r),s===1&&this.parent)if(this.rotationQuaternion){const l=F.Matrix[0];this.rotationQuaternion.toRotationMatrix(l);const c=F.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(c),c.invert(),l.multiplyToRef(c,l),this.rotationQuaternion.fromRotationMatrix(l)}else{const l=F.Quaternion[0];z.FromEulerVectorToRef(this.rotation,l);const c=F.Matrix[0];l.toRotationMatrix(c);const h=F.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(h),h.invert(),c.multiplyToRef(h,c),l.fromRotationMatrix(c),l.toEulerAnglesToRef(this.rotation)}return this}getDirection(e){const t=m.Zero();return this.getDirectionToRef(e,t),t}getDirectionToRef(e,t){return m.TransformNormalToRef(e,this.getWorldMatrix(),t),this}setDirection(e,t=0,i=0,r=0){const s=-Math.atan2(e.z,e.x)+Math.PI/2,n=Math.sqrt(e.x*e.x+e.z*e.z),o=-Math.atan2(e.y,n);return this.rotationQuaternion?z.RotationYawPitchRollToRef(s+t,o+i,r,this.rotationQuaternion):(this.rotation.x=o+i,this.rotation.y=s+t,this.rotation.z=r),this}setPivotPoint(e,t=0){this.getScene().getRenderId()==0&&this.computeWorldMatrix(!0);const i=this.getWorldMatrix();if(t==1){const r=F.Matrix[0];i.invertToRef(r),e=m.TransformCoordinates(e,r)}return this.setPivotMatrix(P.Translation(-e.x,-e.y,-e.z),!0)}getPivotPoint(){const e=m.Zero();return this.getPivotPointToRef(e),e}getPivotPointToRef(e){return e.x=-this._pivotMatrix.m[12],e.y=-this._pivotMatrix.m[13],e.z=-this._pivotMatrix.m[14],this}getAbsolutePivotPoint(){const e=m.Zero();return this.getAbsolutePivotPointToRef(e),e}getAbsolutePivotPointToRef(e){return this.getPivotPointToRef(e),m.TransformCoordinatesToRef(e,this.getWorldMatrix(),e),this}markAsDirty(e){if(this._isDirty)return this;if(this._children)for(const t of this._children)t.markAsDirty(e);return super.markAsDirty(e)}setParent(e,t=!1,i=!1){if(!e&&!this.parent)return this;const r=F.Quaternion[0],s=F.Vector3[0],n=F.Vector3[1],o=F.Matrix[1];P.IdentityToRef(o);const l=F.Matrix[0];this.computeWorldMatrix(!0);let c=this.rotationQuaternion;return c||(c=we._TmpRotation,z.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,c)),P.ComposeToRef(this.scaling,c,this.position,l),this.parent&&l.multiplyToRef(this.parent.computeWorldMatrix(!0),l),e&&(e.computeWorldMatrix(!0).invertToRef(o),l.multiplyToRef(o,l)),l.decompose(n,r,s,t?this:void 0),this.rotationQuaternion?this.rotationQuaternion.copyFrom(r):r.toEulerAnglesToRef(this.rotation),this.scaling.copyFrom(n),this.position.copyFrom(s),this.parent=e,i&&this.setPivotMatrix(P.Identity()),this}addChild(e,t=!1){return e.setParent(this,t),this}removeChild(e,t=!1){return e.parent!==this?this:(e.setParent(null,t),this)}get nonUniformScaling(){return this._nonUniformScaling}_updateNonUniformScalingState(e){return this._nonUniformScaling===e?!1:(this._nonUniformScaling=e,!0)}attachToBone(e,t){return this._currentParentWhenAttachingToBone=this.parent,this._transformToBoneReferal=t,this.parent=e,e.getSkeleton().prepare(!0),e.getFinalMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this}detachFromBone(e=!1){return this.parent?(this.parent.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this._transformToBoneReferal=null,e?this.parent=this._currentParentWhenAttachingToBone:this.parent=null,this):(e&&(this.parent=this._currentParentWhenAttachingToBone),this)}rotate(e,t,i){e.normalize(),this.rotationQuaternion||(this.rotationQuaternion=this.rotation.toQuaternion(),this.rotation.setAll(0));let r;if(!i||i===0)r=z.RotationAxisToRef(e,t,we._RotationAxisCache),this.rotationQuaternion.multiplyToRef(r,this.rotationQuaternion);else{if(this.parent){const s=this.parent.getWorldMatrix(),n=F.Matrix[0];s.invertToRef(n),e=m.TransformNormal(e,n),s.determinant()<0&&(t*=-1)}r=z.RotationAxisToRef(e,t,we._RotationAxisCache),r.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}return this}rotateAround(e,t,i){t.normalize(),this.rotationQuaternion||(this.rotationQuaternion=z.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation.setAll(0));const r=F.Vector3[0],s=F.Vector3[1],n=F.Vector3[2],o=F.Quaternion[0],l=F.Matrix[0],c=F.Matrix[1],h=F.Matrix[2],f=F.Matrix[3];return e.subtractToRef(this.position,r),P.TranslationToRef(r.x,r.y,r.z,l),P.TranslationToRef(-r.x,-r.y,-r.z,c),P.RotationAxisToRef(t,i,h),c.multiplyToRef(h,f),f.multiplyToRef(l,f),f.decompose(s,o,n),this.position.addInPlace(n),o.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion),this}translate(e,t,i){const r=e.scale(t);if(!i||i===0){const s=this.getPositionExpressedInLocalSpace().add(r);this.setPositionWithLocalVector(s)}else this.setAbsolutePosition(this.getAbsolutePosition().add(r));return this}addRotation(e,t,i){let r;this.rotationQuaternion?r=this.rotationQuaternion:(r=F.Quaternion[1],z.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,r));const s=F.Quaternion[0];return z.RotationYawPitchRollToRef(t,e,i,s),r.multiplyInPlace(s),this.rotationQuaternion||r.toEulerAnglesToRef(this.rotation),this}_getEffectiveParent(){return this.parent}isWorldMatrixCameraDependent(){return this._infiniteDistance&&!this.parent||this._billboardMode!==we.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}computeWorldMatrix(e=!1,t=null){if(this._isWorldMatrixFrozen&&!this._isDirty)return this._worldMatrix;const i=this.getScene().getRenderId();if(!this._isDirty&&!e&&(this._currentRenderId===i||this.isSynchronized()))return this._currentRenderId=i,this._worldMatrix;t=t||this.getScene().activeCamera,this._updateCache();const r=this._cache;r.pivotMatrixUpdated=!1,r.billboardMode=this.billboardMode,r.infiniteDistance=this.infiniteDistance,r.parent=this._parentNode,this._currentRenderId=i,this._childUpdateId+=1,this._isDirty=!1,this._position._isDirty=!1,this._rotation._isDirty=!1,this._scaling._isDirty=!1;const s=this._getEffectiveParent(),n=we._TmpScaling;let o=this._position;if(this._infiniteDistance&&!this.parent&&t){const c=t.getWorldMatrix(),h=new m(c.m[12],c.m[13],c.m[14]);o=we._TmpTranslation,o.copyFromFloats(this._position.x+h.x,this._position.y+h.y,this._position.z+h.z)}n.copyFromFloats(this._scaling.x*this.scalingDeterminant,this._scaling.y*this.scalingDeterminant,this._scaling.z*this.scalingDeterminant);let l;if(this._rotationQuaternion?(this._rotationQuaternion._isDirty=!1,l=this._rotationQuaternion,this.reIntegrateRotationIntoRotationQuaternion&&this.rotation.lengthSquared()&&(this._rotationQuaternion.multiplyInPlace(z.RotationYawPitchRoll(this._rotation.y,this._rotation.x,this._rotation.z)),this._rotation.copyFromFloats(0,0,0))):(l=we._TmpRotation,z.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,l)),this._usePivotMatrix){const c=F.Matrix[1];P.ScalingToRef(n.x,n.y,n.z,c);const h=F.Matrix[0];l.toRotationMatrix(h),this._pivotMatrix.multiplyToRef(c,F.Matrix[4]),F.Matrix[4].multiplyToRef(h,this._localMatrix),this._postMultiplyPivotMatrix&&this._localMatrix.multiplyToRef(this._pivotMatrixInverse,this._localMatrix),this._localMatrix.addTranslationFromFloats(o.x,o.y,o.z)}else P.ComposeToRef(n,l,o,this._localMatrix);if(s&&s.getWorldMatrix){if(e&&s.computeWorldMatrix(e),r.useBillboardPath){if(this._transformToBoneReferal){const u=this.parent;u.getSkeleton().prepare(),u.getFinalMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),F.Matrix[7])}else F.Matrix[7].copyFrom(s.getWorldMatrix());const c=F.Vector3[5],h=F.Vector3[6],f=F.Quaternion[0];F.Matrix[7].decompose(h,f,c),P.ScalingToRef(h.x,h.y,h.z,F.Matrix[7]),F.Matrix[7].setTranslation(c),we.BillboardUseParentOrientation&&(this._position.applyRotationQuaternionToRef(f,c),this._localMatrix.setTranslation(c)),this._localMatrix.multiplyToRef(F.Matrix[7],this._worldMatrix)}else if(this._transformToBoneReferal){const c=this.parent;c.getSkeleton().prepare(),this._localMatrix.multiplyToRef(c.getFinalMatrix(),F.Matrix[6]),F.Matrix[6].multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),this._worldMatrix)}else this._localMatrix.multiplyToRef(s.getWorldMatrix(),this._worldMatrix);this._markSyncedWithParent()}else this._worldMatrix.copyFrom(this._localMatrix);if(r.useBillboardPath&&t&&this.billboardMode&&!r.useBillboardPosition){const c=F.Vector3[0];if(this._worldMatrix.getTranslationToRef(c),F.Matrix[1].copyFrom(t.getViewMatrix()),this._scene.useRightHandedSystem&&F.Matrix[1].multiplyToRef(lC,F.Matrix[1]),F.Matrix[1].setTranslationFromFloats(0,0,0),F.Matrix[1].invertToRef(F.Matrix[0]),(this.billboardMode&we.BILLBOARDMODE_ALL)!==we.BILLBOARDMODE_ALL){F.Matrix[0].decompose(void 0,F.Quaternion[0],void 0);const h=F.Vector3[1];F.Quaternion[0].toEulerAnglesToRef(h),(this.billboardMode&we.BILLBOARDMODE_X)!==we.BILLBOARDMODE_X&&(h.x=0),(this.billboardMode&we.BILLBOARDMODE_Y)!==we.BILLBOARDMODE_Y&&(h.y=0),(this.billboardMode&we.BILLBOARDMODE_Z)!==we.BILLBOARDMODE_Z&&(h.z=0),P.RotationYawPitchRollToRef(h.y,h.x,h.z,F.Matrix[0])}this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(F.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(F.Vector3[0])}else if(r.useBillboardPath&&t&&r.useBillboardPosition){const c=F.Vector3[0];this._worldMatrix.getTranslationToRef(c);const h=t.globalPosition;this._worldMatrix.invertToRef(F.Matrix[1]);const f=F.Vector3[1];m.TransformCoordinatesToRef(h,F.Matrix[1],f),f.normalize();const u=-Math.atan2(f.z,f.x)+Math.PI/2,d=Math.sqrt(f.x*f.x+f.z*f.z),_=-Math.atan2(f.y,d);if(z.RotationYawPitchRollToRef(u,_,0,F.Quaternion[0]),(this.billboardMode&we.BILLBOARDMODE_ALL)!==we.BILLBOARDMODE_ALL){const p=F.Vector3[1];F.Quaternion[0].toEulerAnglesToRef(p),(this.billboardMode&we.BILLBOARDMODE_X)!==we.BILLBOARDMODE_X&&(p.x=0),(this.billboardMode&we.BILLBOARDMODE_Y)!==we.BILLBOARDMODE_Y&&(p.y=0),(this.billboardMode&we.BILLBOARDMODE_Z)!==we.BILLBOARDMODE_Z&&(p.z=0),P.RotationYawPitchRollToRef(p.y,p.x,p.z,F.Matrix[0])}else P.FromQuaternionToRef(F.Quaternion[0],F.Matrix[0]);this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(F.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(F.Vector3[0])}return this.ignoreNonUniformScaling?this._updateNonUniformScalingState(!1):this._scaling.isNonUniformWithinEpsilon(1e-6)?this._updateNonUniformScalingState(!0):s&&s._nonUniformScaling?this._updateNonUniformScalingState(s._nonUniformScaling):this._updateNonUniformScalingState(!1),this._afterComputeWorldMatrix(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._isAbsoluteSynced=!1,this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||(this._poseMatrix=P.Invert(this._worldMatrix)),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix}resetLocalMatrix(e=!0){if(this.computeWorldMatrix(),e){const t=this.getChildren();for(let i=0;i<t.length;++i){const r=t[i];if(r){r.computeWorldMatrix();const s=F.Matrix[0];r._localMatrix.multiplyToRef(this._localMatrix,s);const n=F.Quaternion[0];s.decompose(r.scaling,n,r.position),r.rotationQuaternion?r.rotationQuaternion.copyFrom(n):n.toEulerAnglesToRef(r.rotation)}}}this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&(this.rotationQuaternion=z.Identity()),this._worldMatrix=P.Identity()}_afterComputeWorldMatrix(){}registerAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.add(e),this}unregisterAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.removeCallback(e),this}getPositionInCameraSpace(e=null){return e||(e=this.getScene().activeCamera),m.TransformCoordinates(this.getAbsolutePosition(),e.getViewMatrix())}getDistanceToCamera(e=null){return e||(e=this.getScene().activeCamera),this.getAbsolutePosition().subtract(e.globalPosition).length()}clone(e,t,i){const r=ye.Clone(()=>new we(e,this.getScene()),this);if(r.name=e,r.id=e,t&&(r.parent=t),!i){const s=this.getDescendants(!0);for(let n=0;n<s.length;n++){const o=s[n];o.clone&&o.clone(e+"."+o.name,r)}}return r}serialize(e){const t=ye.Serialize(this,e);return t.type=this.getClassName(),t.uniqueId=this.uniqueId,this.parent&&this.parent._serializeAsParent(t),t.localMatrix=this.getPivotMatrix().asArray(),t.isEnabled=this.isEnabled(),ye.AppendSerializedAnimations(this,t),t.ranges=this.serializeAnimationRanges(),t}static Parse(e,t,i){const r=ye.Parse(()=>new we(e.name,t),e,t,i);if(e.localMatrix?r.setPreTransformMatrix(P.FromArray(e.localMatrix)):e.pivotMatrix&&r.setPivotMatrix(P.FromArray(e.pivotMatrix)),r.setEnabled(e.isEnabled),r._waitingParsedUniqueId=e.uniqueId,e.parentId!==void 0&&(r._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),e.animations){for(let s=0;s<e.animations.length;s++){const n=e.animations[s],o=Ui("BABYLON.Animation");o&&r.animations.push(o.Parse(n))}gt.ParseAnimationRanges(r,e,t)}return e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),r}getChildTransformNodes(e,t){const i=[];return this._getDescendants(i,e,r=>(!t||t(r))&&r instanceof we),i}dispose(e,t=!1){if(this.getScene().stopAnimation(this),this.getScene().removeTransformNode(this),this._parentContainer){const i=this._parentContainer.transformNodes.indexOf(this);i>-1&&this._parentContainer.transformNodes.splice(i,1),this._parentContainer=null}if(this.onAfterWorldMatrixUpdateObservable.clear(),e){const i=this.getChildTransformNodes(!0);for(const r of i)r.parent=null,r.computeWorldMatrix(!0)}super.dispose(e,t)}normalizeToUnitCube(e=!0,t=!1,i){let r=null,s=null;t&&(this.rotationQuaternion?(s=this.rotationQuaternion.clone(),this.rotationQuaternion.copyFromFloats(0,0,0,1)):this.rotation&&(r=this.rotation.clone(),this.rotation.copyFromFloats(0,0,0)));const n=this.getHierarchyBoundingVectors(e,i),o=n.max.subtract(n.min),l=Math.max(o.x,o.y,o.z);if(l===0)return this;const c=1/l;return this.scaling.scaleInPlace(c),t&&(this.rotationQuaternion&&s?this.rotationQuaternion.copyFrom(s):this.rotation&&r&&this.rotation.copyFrom(r)),this}_syncAbsoluteScalingAndRotation(){this._isAbsoluteSynced||(this._worldMatrix.decompose(this._absoluteScaling,this._absoluteRotationQuaternion),this._isAbsoluteSynced=!0)}}we.BILLBOARDMODE_NONE=0;we.BILLBOARDMODE_X=1;we.BILLBOARDMODE_Y=2;we.BILLBOARDMODE_Z=4;we.BILLBOARDMODE_ALL=7;we.BILLBOARDMODE_USE_POSITION=128;we.BillboardUseParentOrientation=!1;we._TmpRotation=z.Zero();we._TmpScaling=m.Zero();we._TmpTranslation=m.Zero();we._LookAtVectorCache=new m(0,0,0);we._RotationAxisCache=new z;A([di("position")],we.prototype,"_position",void 0);A([di("rotation")],we.prototype,"_rotation",void 0);A([KA("rotationQuaternion")],we.prototype,"_rotationQuaternion",void 0);A([di("scaling")],we.prototype,"_scaling",void 0);A([y("billboardMode")],we.prototype,"_billboardMode",void 0);A([y()],we.prototype,"scalingDeterminant",void 0);A([y("infiniteDistance")],we.prototype,"_infiniteDistance",void 0);A([y()],we.prototype,"ignoreNonUniformScaling",void 0);A([y()],we.prototype,"reIntegrateRotationIntoRotationQuaternion",void 0);class cC{constructor(){this._checkCollisions=!1,this._collisionMask=-1,this._collisionGroup=-1,this._surroundingMeshes=null,this._collider=null,this._oldPositionForCollisions=new m(0,0,0),this._diffPositionForCollisions=new m(0,0,0),this._collisionResponse=!0}}function hC(a,e,t){let i=null;switch(e){case x.PositionKind:i=r=>r.getPositions();break;case x.NormalKind:i=r=>r.getNormals();break;case x.TangentKind:i=r=>r.getTangents();break;case x.UVKind:i=r=>r.getUVs();break;case x.UV2Kind:i=r=>r.getUV2s();break;case x.ColorKind:i=r=>r.getColors();break;default:return}for(let r=0;r<a.length;r++){let s=a[r];for(let n=0;n<t.numTargets;n++){const o=t.getTarget(n),l=o.influence;if(l!==0){const c=i(o);c&&(s+=(c[r]-a[r])*l)}}a[r]=s}}function fC(a,e,t,i,r,s,n){const o=F.Vector3[0],l=F.Matrix[0],c=F.Matrix[1],h=e===x.NormalKind?m.TransformNormalFromFloatsToRef:m.TransformCoordinatesFromFloatsToRef;for(let f=0,u=0;f<a.length;f+=3,u+=4){l.reset();let d,_;for(d=0;d<4;d++)_=r[u+d],_>0&&(P.FromFloat32ArrayToRefScaled(t,Math.floor(i[u+d]*16),_,c),l.addToSelf(c));if(s&&n)for(d=0;d<4;d++)_=n[u+d],_>0&&(P.FromFloat32ArrayToRefScaled(t,Math.floor(s[u+d]*16),_,c),l.addToSelf(c));h(a[f],a[f+1],a[f+2],l,o),o.toArray(a,f)}}class uC{constructor(){this.facetNb=0,this.partitioningSubdivisions=10,this.partitioningBBoxRatio=1.01,this.facetDataEnabled=!1,this.facetParameters={},this.bbSize=m.Zero(),this.subDiv={max:1,X:1,Y:1,Z:1},this.facetDepthSort=!1,this.facetDepthSortEnabled=!1}}class dC{constructor(){this._hasVertexAlpha=!1,this._useVertexColors=!0,this._numBoneInfluencers=4,this._applyFog=!0,this._receiveShadows=!1,this._facetData=new uC,this._visibility=1,this._skeleton=null,this._layerMask=268435455,this._computeBonesUsingShaders=!0,this._isActive=!1,this._onlyForInstances=!1,this._isActiveIntermediate=!1,this._onlyForInstancesIntermediate=!1,this._actAsRegularMesh=!1,this._currentLOD=new Map,this._collisionRetryCount=3,this._morphTargetManager=null,this._renderingGroupId=0,this._bakedVertexAnimationManager=null,this._material=null,this._positions=null,this._pointerOverDisableMeshTesting=!1,this._meshCollisionData=new cC,this._enableDistantPicking=!1,this._rawBoundingInfo=null,this._sideOrientationHint=!1,this._inheritVisibility=!1}}class ei extends we{static get BILLBOARDMODE_NONE(){return we.BILLBOARDMODE_NONE}static get BILLBOARDMODE_X(){return we.BILLBOARDMODE_X}static get BILLBOARDMODE_Y(){return we.BILLBOARDMODE_Y}static get BILLBOARDMODE_Z(){return we.BILLBOARDMODE_Z}static get BILLBOARDMODE_ALL(){return we.BILLBOARDMODE_ALL}static get BILLBOARDMODE_USE_POSITION(){return we.BILLBOARDMODE_USE_POSITION}get facetNb(){return this._internalAbstractMeshDataInfo._facetData.facetNb}get partitioningSubdivisions(){return this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions}set partitioningSubdivisions(e){this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions=e}get partitioningBBoxRatio(){return this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio}set partitioningBBoxRatio(e){this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio=e}get mustDepthSortFacets(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSort}set mustDepthSortFacets(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSort=e}get facetDepthSortFrom(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom}set facetDepthSortFrom(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom=e}get collisionRetryCount(){return this._internalAbstractMeshDataInfo._collisionRetryCount}set collisionRetryCount(e){this._internalAbstractMeshDataInfo._collisionRetryCount=e}get isFacetDataEnabled(){return this._internalAbstractMeshDataInfo._facetData.facetDataEnabled}get morphTargetManager(){return this._internalAbstractMeshDataInfo._morphTargetManager}set morphTargetManager(e){this._internalAbstractMeshDataInfo._morphTargetManager!==e&&(this._internalAbstractMeshDataInfo._morphTargetManager=e,this._syncGeometryWithMorphTargetManager())}get bakedVertexAnimationManager(){return this._internalAbstractMeshDataInfo._bakedVertexAnimationManager}set bakedVertexAnimationManager(e){this._internalAbstractMeshDataInfo._bakedVertexAnimationManager!==e&&(this._internalAbstractMeshDataInfo._bakedVertexAnimationManager=e,this._markSubMeshesAsAttributesDirty())}_syncGeometryWithMorphTargetManager(){}_updateNonUniformScalingState(e){return super._updateNonUniformScalingState(e)?(this._markSubMeshesAsMiscDirty(),!0):!1}get rawBoundingInfo(){return this._internalAbstractMeshDataInfo._rawBoundingInfo}set rawBoundingInfo(e){this._internalAbstractMeshDataInfo._rawBoundingInfo=e}set onCollide(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver&&this.onCollideObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver=this.onCollideObservable.add(e)}set onCollisionPositionChange(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver&&this.onCollisionPositionChangeObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(e)}get visibility(){return this._internalAbstractMeshDataInfo._visibility}set visibility(e){if(this._internalAbstractMeshDataInfo._visibility===e)return;const t=this._internalAbstractMeshDataInfo._visibility;this._internalAbstractMeshDataInfo._visibility=e,(t===1&&e!==1||t!==1&&e===1)&&this._markSubMeshesAsDirty(i=>{i.markAsMiscDirty(),i.markAsPrePassDirty()})}get inheritVisibility(){return this._internalAbstractMeshDataInfo._inheritVisibility}set inheritVisibility(e){this._internalAbstractMeshDataInfo._inheritVisibility=e}get isVisible(){if(!this._isVisible||!this.inheritVisibility||!this._parentNode)return this._isVisible;if(this._isVisible){let e=this._parentNode;for(;e;){const t=e.isVisible;if(typeof t<"u")return t;e=e.parent}}return this._isVisible}set isVisible(e){this._isVisible=e}get pointerOverDisableMeshTesting(){return this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting}set pointerOverDisableMeshTesting(e){this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting=e}get renderingGroupId(){return this._internalAbstractMeshDataInfo._renderingGroupId}set renderingGroupId(e){this._internalAbstractMeshDataInfo._renderingGroupId=e}get material(){return this._internalAbstractMeshDataInfo._material}set material(e){this._setMaterial(e)}_setMaterial(e){this._internalAbstractMeshDataInfo._material!==e&&(this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._material=e,e&&e.meshMap&&(e.meshMap[this.uniqueId]=this),this.onMaterialChangedObservable.hasObservers()&&this.onMaterialChangedObservable.notifyObservers(this),this.subMeshes&&(this.resetDrawCache(void 0,e==null),this._unBindEffect()))}getMaterialForRenderPass(e){var t;return(t=this._internalAbstractMeshDataInfo._materialForRenderPass)==null?void 0:t[e]}setMaterialForRenderPass(e,t){var r;this.resetDrawCache(e),this._internalAbstractMeshDataInfo._materialForRenderPass||(this._internalAbstractMeshDataInfo._materialForRenderPass=[]);const i=this._internalAbstractMeshDataInfo._materialForRenderPass[e];(r=i==null?void 0:i.meshMap)!=null&&r[this.uniqueId]&&(i.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._materialForRenderPass[e]=t,t&&t.meshMap&&(t.meshMap[this.uniqueId]=this)}get receiveShadows(){return this._internalAbstractMeshDataInfo._receiveShadows}set receiveShadows(e){this._internalAbstractMeshDataInfo._receiveShadows!==e&&(this._internalAbstractMeshDataInfo._receiveShadows=e,this._markSubMeshesAsLightDirty())}get hasVertexAlpha(){return this._internalAbstractMeshDataInfo._hasVertexAlpha}set hasVertexAlpha(e){this._internalAbstractMeshDataInfo._hasVertexAlpha!==e&&(this._internalAbstractMeshDataInfo._hasVertexAlpha=e,this._markSubMeshesAsAttributesDirty(),this._markSubMeshesAsMiscDirty())}get useVertexColors(){return this._internalAbstractMeshDataInfo._useVertexColors}set useVertexColors(e){this._internalAbstractMeshDataInfo._useVertexColors!==e&&(this._internalAbstractMeshDataInfo._useVertexColors=e,this._markSubMeshesAsAttributesDirty())}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get numBoneInfluencers(){return this._internalAbstractMeshDataInfo._numBoneInfluencers}set numBoneInfluencers(e){this._internalAbstractMeshDataInfo._numBoneInfluencers!==e&&(this._internalAbstractMeshDataInfo._numBoneInfluencers=e,this._markSubMeshesAsAttributesDirty())}get applyFog(){return this._internalAbstractMeshDataInfo._applyFog}set applyFog(e){this._internalAbstractMeshDataInfo._applyFog!==e&&(this._internalAbstractMeshDataInfo._applyFog=e,this._markSubMeshesAsMiscDirty())}get enableDistantPicking(){return this._internalAbstractMeshDataInfo._enableDistantPicking}set enableDistantPicking(e){this._internalAbstractMeshDataInfo._enableDistantPicking=e}get layerMask(){return this._internalAbstractMeshDataInfo._layerMask}set layerMask(e){e!==this._internalAbstractMeshDataInfo._layerMask&&(this._internalAbstractMeshDataInfo._layerMask=e,this._resyncLightSources())}get collisionMask(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask}set collisionMask(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask=isNaN(e)?-1:e}get collisionResponse(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse}set collisionResponse(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse=e}get collisionGroup(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup}set collisionGroup(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup=isNaN(e)?-1:e}get surroundingMeshes(){return this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes}set surroundingMeshes(e){this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes=e}get lightSources(){return this._lightSources}set skeleton(e){const t=this._internalAbstractMeshDataInfo._skeleton;t&&t.needInitialSkinMatrix&&t._unregisterMeshWithPoseMatrix(this),e&&e.needInitialSkinMatrix&&e._registerMeshWithPoseMatrix(this),this._internalAbstractMeshDataInfo._skeleton=e,this._internalAbstractMeshDataInfo._skeleton||(this._bonesTransformMatrices=null),this._markSubMeshesAsAttributesDirty()}get skeleton(){return this._internalAbstractMeshDataInfo._skeleton}constructor(e,t=null){switch(super(e,t,!1),this._internalAbstractMeshDataInfo=new dC,this._waitingMaterialId=null,this._waitingMorphTargetManagerId=null,this.cullingStrategy=ei.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this.onCollideObservable=new U,this.onCollisionPositionChangeObservable=new U,this.onMaterialChangedObservable=new U,this.definedFacingForward=!0,this._occlusionQuery=null,this._renderingGroup=null,this.alphaIndex=Number.MAX_VALUE,this._isVisible=!0,this.isPickable=!0,this.isNearPickable=!1,this.isNearGrabbable=!1,this.showSubMeshesBoundingBox=!1,this.isBlocker=!1,this.enablePointerMoveEvents=!1,this.outlineColor=ae.Red(),this.outlineWidth=.02,this.overlayColor=ae.Red(),this.overlayAlpha=.5,this.useOctreeForRenderingSelection=!0,this.useOctreeForPicking=!0,this.useOctreeForCollisions=!0,this.alwaysSelectAsActiveMesh=!1,this.doNotSyncBoundingInfo=!1,this.actionManager=null,this.ellipsoid=new m(.5,1,.5),this.ellipsoidOffset=new m(0,0,0),this.edgesWidth=1,this.edgesColor=new Ne(1,0,0,1),this._edgesRenderer=null,this._masterMesh=null,this._boundingInfo=null,this._boundingInfoIsDirty=!0,this._renderId=0,this._intersectionsInProgress=new Array,this._unIndexed=!1,this._lightSources=new Array,this._waitingData={lods:null,actions:null,freezeWorldMatrix:null},this._bonesTransformMatrices=null,this._transformMatrixTexture=null,this.onRebuildObservable=new U,this._onCollisionPositionChange=(i,r,s=null)=>{r.subtractToRef(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions.length()>H.CollisionsEpsilon&&this.position.addInPlace(this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),s&&this.onCollideObservable.notifyObservers(s),this.onCollisionPositionChangeObservable.notifyObservers(this.position)},t=this.getScene(),t.addMesh(this),this._resyncLightSources(),this._uniformBuffer=new _e(this.getScene().getEngine(),void 0,void 0,e,!this.getScene().getEngine().isWebGPU),this._buildUniformLayout(),t.performancePriority){case 2:this.doNotSyncBoundingInfo=!0;case 1:this.alwaysSelectAsActiveMesh=!0,this.isPickable=!1;break}}_buildUniformLayout(){this._uniformBuffer.addUniform("world",16),this._uniformBuffer.addUniform("visibility",1),this._uniformBuffer.create()}transferToEffect(e){const t=this._uniformBuffer;t.updateMatrix("world",e),t.updateFloat("visibility",this._internalAbstractMeshDataInfo._visibility),t.update()}getMeshUniformBuffer(){return this._uniformBuffer}getClassName(){return"AbstractMesh"}toString(e){let t="Name: "+this.name+", isInstance: "+(this.getClassName()!=="InstancedMesh"?"YES":"NO");t+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0);const i=this._internalAbstractMeshDataInfo._skeleton;return i&&(t+=", skeleton: "+i.name),e&&(t+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode],t+=", freeze wrld mat: "+(this._isWorldMatrixFrozen||this._waitingData.freezeWorldMatrix?"YES":"NO")),t}_getEffectiveParent(){return this._masterMesh&&this.billboardMode!==we.BILLBOARDMODE_NONE?this._masterMesh:super._getEffectiveParent()}_getActionManagerForTrigger(e,t=!0){if(this.actionManager&&(t||this.actionManager.isRecursive))if(e){if(this.actionManager.hasSpecificTrigger(e))return this.actionManager}else return this.actionManager;return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_rebuild(e=!1){if(this.onRebuildObservable.notifyObservers(this),this._occlusionQuery!==null&&(this._occlusionQuery=null),!!this.subMeshes){for(const t of this.subMeshes)t._rebuild();this.resetDrawCache()}}_resyncLightSources(){this._lightSources.length=0;for(const e of this.getScene().lights)e.isEnabled()&&e.canAffectMesh(this)&&this._lightSources.push(e);this._markSubMeshesAsLightDirty()}_resyncLightSource(e){const t=e.isEnabled()&&e.canAffectMesh(this),i=this._lightSources.indexOf(e);let r=!1;if(i===-1){if(!t)return;this._lightSources.push(e)}else{if(t)return;r=!0,this._lightSources.splice(i,1)}this._markSubMeshesAsLightDirty(r)}_unBindEffect(){for(const e of this.subMeshes)e.setEffect(null)}_removeLightSource(e,t){const i=this._lightSources.indexOf(e);i!==-1&&(this._lightSources.splice(i,1),this._markSubMeshesAsLightDirty(t))}_markSubMeshesAsDirty(e){if(this.subMeshes)for(const t of this.subMeshes)for(let i=0;i<t._drawWrappers.length;++i){const r=t._drawWrappers[i];!r||!r.defines||!r.defines.markAllAsDirty||e(r.defines)}}_markSubMeshesAsLightDirty(e=!1){this._markSubMeshesAsDirty(t=>t.markAsLightDirty(e))}_markSubMeshesAsAttributesDirty(){this._markSubMeshesAsDirty(e=>e.markAsAttributesDirty())}_markSubMeshesAsMiscDirty(){this._markSubMeshesAsDirty(e=>e.markAsMiscDirty())}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,super.markAsDirty(e),this._isDirty=!0,this}resetDrawCache(e,t=!1){if(this.subMeshes)for(const i of this.subMeshes)i.resetDrawCache(e,t)}get isBlocked(){return!1}getLOD(e){return this}getTotalVertices(){return 0}getTotalIndices(){return 0}getIndices(){return null}getVerticesData(e){return null}setVerticesData(e,t,i,r){return this}updateVerticesData(e,t,i,r){return this}setIndices(e,t){return this}isVerticesDataPresent(e){return!1}getBoundingInfo(){return this._masterMesh?this._masterMesh.getBoundingInfo():(this._boundingInfoIsDirty&&(this._boundingInfoIsDirty=!1,this._updateBoundingInfo()),this._boundingInfo)}getRawBoundingInfo(){return this.rawBoundingInfo??this.getBoundingInfo()}setBoundingInfo(e){return this._boundingInfo=e,this}get hasBoundingInfo(){return this._boundingInfo!==null}buildBoundingInfo(e,t,i){return this._boundingInfo=new Mi(e,t,i),this._boundingInfo}normalizeToUnitCube(e=!0,t=!1,i){return super.normalizeToUnitCube(e,t,i)}get useBones(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(x.MatricesIndicesKind)&&this.isVerticesDataPresent(x.MatricesWeightsKind)}_preActivate(){}_preActivateForIntermediateRendering(e){}_activate(e,t){return this._renderId=e,!0}_postActivate(){}_freeze(){}_unFreeze(){}getWorldMatrix(){return this._masterMesh&&this.billboardMode===we.BILLBOARDMODE_NONE?this._masterMesh.getWorldMatrix():super.getWorldMatrix()}_getWorldMatrixDeterminant(){return this._masterMesh?this._masterMesh._getWorldMatrixDeterminant():super._getWorldMatrixDeterminant()}get isAnInstance(){return!1}get hasInstances(){return!1}get hasThinInstances(){return!1}movePOV(e,t,i){return this.position.addInPlace(this.calcMovePOV(e,t,i)),this}calcMovePOV(e,t,i){const r=new P;(this.rotationQuaternion?this.rotationQuaternion:z.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)).toRotationMatrix(r);const n=m.Zero(),o=this.definedFacingForward?-1:1;return m.TransformCoordinatesFromFloatsToRef(e*o,t,i*o,r,n),n}rotatePOV(e,t,i){return this.rotation.addInPlace(this.calcRotatePOV(e,t,i)),this}calcRotatePOV(e,t,i){const r=this.definedFacingForward?1:-1;return new m(e*r,t,i*r)}_refreshBoundingInfo(e,t){if(e){const i=Fm(e,0,this.getTotalVertices(),t);this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new Mi(i.minimum,i.maximum)}if(this.subMeshes)for(let i=0;i<this.subMeshes.length;i++)this.subMeshes[i].refreshBoundingInfo(e);this._updateBoundingInfo()}_refreshBoundingInfoDirect(e){if(this._boundingInfo?this._boundingInfo.reConstruct(e.minimum,e.maximum):this._boundingInfo=new Mi(e.minimum,e.maximum),this.subMeshes)for(let t=0;t<this.subMeshes.length;t++)this.subMeshes[t].refreshBoundingInfo(null);this._updateBoundingInfo()}static _ApplySkeleton(e,t,i,r,s,n,o){fC(e,t,i,r,s,n,o)}_getData(e,t,i=x.PositionKind){const r=e.cache,s=n=>{if(r){const o=r._vertexData||(r._vertexData={});return o[n]||this.copyVerticesData(n,o),o[n]}return this.getVerticesData(n)};if(t||(t=s(i)),!t)return null;if(r?(r._outputData?r._outputData.set(t):r._outputData=new Float32Array(t),t=r._outputData):(e.applyMorph&&this.morphTargetManager||e.applySkeleton&&this.skeleton)&&(t=t.slice()),e.applyMorph&&this.morphTargetManager&&hC(t,i,this.morphTargetManager),e.applySkeleton&&this.skeleton){const n=s(x.MatricesIndicesKind),o=s(x.MatricesWeightsKind);if(o&&n){const l=this.numBoneInfluencers>4,c=l?s(x.MatricesIndicesExtraKind):null,h=l?s(x.MatricesWeightsExtraKind):null,f=this.skeleton.getTransformMatrices(this);ei._ApplySkeleton(t,i,f,n,o,c,h)}}if(e.updatePositionsArray!==!1&&i===x.PositionKind){const n=this._internalAbstractMeshDataInfo._positions||[],o=n.length;if(n.length=t.length/3,o<n.length)for(let l=o;l<n.length;l++)n[l]=new m;for(let l=0,c=0;l<n.length;l++,c+=3)n[l].copyFromFloats(t[c],t[c+1],t[c+2]);this._internalAbstractMeshDataInfo._positions=n}return t}getNormalsData(e=!1,t=!1){return this._getData({applySkeleton:e,applyMorph:t,updatePositionsArray:!1},null,x.NormalKind)}getPositionData(e=!1,t=!1,i=null){return this._getData({applySkeleton:e,applyMorph:t,updatePositionsArray:!1},i,x.PositionKind)}_updateBoundingInfo(){return this._boundingInfo?this._boundingInfo.update(this.worldMatrixFromCache):this._boundingInfo=new Mi(m.Zero(),m.Zero(),this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}_updateSubMeshesBoundingInfo(e){if(!this.subMeshes)return this;const t=this.subMeshes.length;for(let i=0;i<t;i++){const r=this.subMeshes[i];(t>1||!r.IsGlobal)&&r.updateBoundingInfo(e)}return this}_afterComputeWorldMatrix(){this.doNotSyncBoundingInfo||(this._boundingInfoIsDirty=!0)}isInFrustum(e){return this.getBoundingInfo().isInFrustum(e,this.cullingStrategy)}isCompletelyInFrustum(e){return this.getBoundingInfo().isCompletelyInFrustum(e)}intersectsMesh(e,t=!1,i){const r=this.getBoundingInfo(),s=e.getBoundingInfo();if(r.intersects(s,t))return!0;if(i){for(const n of this.getChildMeshes())if(n.intersectsMesh(e,t,!0))return!0}return!1}intersectsPoint(e){return this.getBoundingInfo().intersectsPoint(e)}get checkCollisions(){return this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions}set checkCollisions(e){this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions=e}get collider(){return this._internalAbstractMeshDataInfo._meshCollisionData._collider}moveWithCollisions(e){this.getAbsolutePosition().addToRef(this.ellipsoidOffset,this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions);const i=this.getScene().collisionCoordinator;return this._internalAbstractMeshDataInfo._meshCollisionData._collider||(this._internalAbstractMeshDataInfo._meshCollisionData._collider=i.createCollider()),this._internalAbstractMeshDataInfo._meshCollisionData._collider._radius=this.ellipsoid,i.getNewPosition(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,e,this._internalAbstractMeshDataInfo._meshCollisionData._collider,this.collisionRetryCount,this,this._onCollisionPositionChange,this.uniqueId),this}_collideForSubMesh(e,t,i){var r;if(this._generatePointsArray(),!this._positions)return this;if(!e._lastColliderWorldVertices||!e._lastColliderTransformMatrix.equals(t)){e._lastColliderTransformMatrix=t.clone(),e._lastColliderWorldVertices=[],e._trianglePlanes=[];const s=e.verticesStart,n=e.verticesStart+e.verticesCount;for(let o=s;o<n;o++)e._lastColliderWorldVertices.push(m.TransformCoordinates(this._positions[o],t))}return i._collide(e._trianglePlanes,e._lastColliderWorldVertices,this.getIndices(),e.indexStart,e.indexStart+e.indexCount,e.verticesStart,!!e.getMaterial(),this,this._shouldConvertRHS(),((r=e.getMaterial())==null?void 0:r.fillMode)===7),this}_processCollisionsForSubMeshes(e,t){const i=this._scene.getCollidingSubMeshCandidates(this,e),r=i.length;for(let s=0;s<r;s++){const n=i.data[s];r>1&&!n._checkCollision(e)||this._collideForSubMesh(n,t,e)}return this}_shouldConvertRHS(){return!1}_checkCollision(e){if(!this.getBoundingInfo()._checkCollision(e))return this;const t=F.Matrix[0],i=F.Matrix[1];return P.ScalingToRef(1/e._radius.x,1/e._radius.y,1/e._radius.z,t),this.worldMatrixFromCache.multiplyToRef(t,i),this._processCollisionsForSubMeshes(e,i),this}_generatePointsArray(){return!1}intersects(e,t,i,r=!1,s,n=!1){const o=new oi,l=this.getClassName(),c=l==="InstancedLinesMesh"||l==="LinesMesh"||l==="GreasedLineMesh"?this.intersectionThreshold:0,h=this.getBoundingInfo();if(!this.subMeshes||!n&&(!e.intersectsSphere(h.boundingSphere,c)||!e.intersectsBox(h.boundingBox,c)))return o;if(r)return o.hit=!n,o.pickedMesh=n?null:this,o.distance=n?0:m.Distance(e.origin,h.boundingSphere.center),o.subMeshId=0,o;if(!this._generatePointsArray())return o;let f=null;const u=this._scene.getIntersectingSubMeshCandidates(this,e),d=u.length;let _=!1;for(let p=0;p<d;p++){const E=u.data[p].getMaterial();if(E&&(E.fillMode==7||E.fillMode==0||E.fillMode==1||E.fillMode==2||E.fillMode==4)){_=!0;break}}if(!_)return o.hit=!0,o.pickedMesh=this,o.distance=m.Distance(e.origin,h.boundingSphere.center),o.subMeshId=-1,o;for(let p=0;p<d;p++){const g=u.data[p];if(d>1&&!n&&!g.canIntersects(e))continue;const E=g.intersects(e,this._positions,this.getIndices(),t,i);if(E&&(t||!f||E.distance<f.distance)&&(f=E,f.subMeshId=p,t))break}if(f){const p=s??this.getWorldMatrix(),g=F.Vector3[0],E=F.Vector3[1];m.TransformCoordinatesToRef(e.origin,p,g),e.direction.scaleToRef(f.distance,E);const b=m.TransformNormal(E,p).addInPlace(g);return o.hit=!0,o.distance=m.Distance(g,b),o.pickedPoint=b,o.pickedMesh=this,o.bu=f.bu||0,o.bv=f.bv||0,o.subMeshFaceId=f.faceId,o.faceId=f.faceId+u.data[f.subMeshId].indexStart/(this.getClassName().indexOf("LinesMesh")!==-1?2:3),o.subMeshId=f.subMeshId,o}return o}clone(e,t,i){return null}releaseSubMeshes(e=!1){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose(e);else this.subMeshes=[];return this}dispose(e,t=!1){let i;const r=this.getScene();for(this._scene.useMaterialMeshMap&&this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),r.freeActiveMeshes(),r.freeRenderingGroups(),r.renderingManager.maintainStateBetweenFrames&&r.renderingManager.restoreDispachedFlags(),this.actionManager!==void 0&&this.actionManager!==null&&(this.actionManager.disposeWhenUnowned&&!this._scene.meshes.some(o=>o!==this&&o.actionManager===this.actionManager)&&this.actionManager.dispose(),this.actionManager=null),this._internalAbstractMeshDataInfo._skeleton=null,this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null),i=0;i<this._intersectionsInProgress.length;i++){const o=this._intersectionsInProgress[i],l=o._intersectionsInProgress.indexOf(this);o._intersectionsInProgress.splice(l,1)}this._intersectionsInProgress.length=0,r.lights.forEach(o=>{let l=o.includedOnlyMeshes.indexOf(this);l!==-1&&o.includedOnlyMeshes.splice(l,1),l=o.excludedMeshes.indexOf(this),l!==-1&&o.excludedMeshes.splice(l,1);const c=o.getShadowGenerators();if(c){const h=c.values();for(let f=h.next();f.done!==!0;f=h.next()){const d=f.value.getShadowMap();d&&d.renderList&&(l=d.renderList.indexOf(this),l!==-1&&d.renderList.splice(l,1))}}}),(this.getClassName()!=="InstancedMesh"||this.getClassName()!=="InstancedLinesMesh")&&this.releaseSubMeshes(!0);const n=r.getEngine();if(this._occlusionQuery!==null&&(this.isOcclusionQueryInProgress=!1,n.deleteQuery(this._occlusionQuery),this._occlusionQuery=null),n.wipeCaches(),r.removeMesh(this),this._parentContainer){const o=this._parentContainer.meshes.indexOf(this);o>-1&&this._parentContainer.meshes.splice(o,1),this._parentContainer=null}if(t&&this.material&&(this.material.getClassName()==="MultiMaterial"?this.material.dispose(!1,!0,!0):this.material.dispose(!1,!0)),!e)for(i=0;i<r.particleSystems.length;i++)r.particleSystems[i].emitter===this&&(r.particleSystems[i].dispose(),i--);this._internalAbstractMeshDataInfo._facetData.facetDataEnabled&&this.disableFacetData(),this._uniformBuffer.dispose(),this.onAfterWorldMatrixUpdateObservable.clear(),this.onCollideObservable.clear(),this.onCollisionPositionChangeObservable.clear(),this.onRebuildObservable.clear(),super.dispose(e,t)}_initFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;e.facetNormals||(e.facetNormals=[]),e.facetPositions||(e.facetPositions=[]),e.facetPartitioning||(e.facetPartitioning=new Array),e.facetNb=this.getIndices().length/3|0,e.partitioningSubdivisions=e.partitioningSubdivisions?e.partitioningSubdivisions:10,e.partitioningBBoxRatio=e.partitioningBBoxRatio?e.partitioningBBoxRatio:1.01;for(let t=0;t<e.facetNb;t++)e.facetNormals[t]=m.Zero(),e.facetPositions[t]=m.Zero();return e.facetDataEnabled=!0,this}updateFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;e.facetDataEnabled||this._initFacetData();const t=this.getVerticesData(x.PositionKind),i=this.getIndices(),r=this.getVerticesData(x.NormalKind),s=this.getBoundingInfo();if(e.facetDepthSort&&!e.facetDepthSortEnabled){if(e.facetDepthSortEnabled=!0,i instanceof Uint16Array)e.depthSortedIndices=new Uint16Array(i);else if(i instanceof Uint32Array)e.depthSortedIndices=new Uint32Array(i);else{let o=!1;for(let l=0;l<i.length;l++)if(i[l]>65535){o=!0;break}o?e.depthSortedIndices=new Uint32Array(i):e.depthSortedIndices=new Uint16Array(i)}if(e.facetDepthSortFunction=function(o,l){return l.sqDistance-o.sqDistance},!e.facetDepthSortFrom){const o=this.getScene().activeCamera;e.facetDepthSortFrom=o?o.position:m.Zero()}e.depthSortedFacets=[];for(let o=0;o<e.facetNb;o++){const l={ind:o*3,sqDistance:0};e.depthSortedFacets.push(l)}e.invertedMatrix=P.Identity(),e.facetDepthSortOrigin=m.Zero()}e.bbSize.x=s.maximum.x-s.minimum.x>Ke?s.maximum.x-s.minimum.x:Ke,e.bbSize.y=s.maximum.y-s.minimum.y>Ke?s.maximum.y-s.minimum.y:Ke,e.bbSize.z=s.maximum.z-s.minimum.z>Ke?s.maximum.z-s.minimum.z:Ke;let n=e.bbSize.x>e.bbSize.y?e.bbSize.x:e.bbSize.y;if(n=n>e.bbSize.z?n:e.bbSize.z,e.subDiv.max=e.partitioningSubdivisions,e.subDiv.X=Math.floor(e.subDiv.max*e.bbSize.x/n),e.subDiv.Y=Math.floor(e.subDiv.max*e.bbSize.y/n),e.subDiv.Z=Math.floor(e.subDiv.max*e.bbSize.z/n),e.subDiv.X=e.subDiv.X<1?1:e.subDiv.X,e.subDiv.Y=e.subDiv.Y<1?1:e.subDiv.Y,e.subDiv.Z=e.subDiv.Z<1?1:e.subDiv.Z,e.facetParameters.facetNormals=this.getFacetLocalNormals(),e.facetParameters.facetPositions=this.getFacetLocalPositions(),e.facetParameters.facetPartitioning=this.getFacetLocalPartitioning(),e.facetParameters.bInfo=s,e.facetParameters.bbSize=e.bbSize,e.facetParameters.subDiv=e.subDiv,e.facetParameters.ratio=this.partitioningBBoxRatio,e.facetParameters.depthSort=e.facetDepthSort,e.facetDepthSort&&e.facetDepthSortEnabled&&(this.computeWorldMatrix(!0),this._worldMatrix.invertToRef(e.invertedMatrix),m.TransformCoordinatesToRef(e.facetDepthSortFrom,e.invertedMatrix,e.facetDepthSortOrigin),e.facetParameters.distanceTo=e.facetDepthSortOrigin),e.facetParameters.depthSortedFacets=e.depthSortedFacets,r&&ee.ComputeNormals(t,i,r,e.facetParameters),e.facetDepthSort&&e.facetDepthSortEnabled){e.depthSortedFacets.sort(e.facetDepthSortFunction);const o=e.depthSortedIndices.length/3|0;for(let l=0;l<o;l++){const c=e.depthSortedFacets[l].ind;e.depthSortedIndices[l*3]=i[c],e.depthSortedIndices[l*3+1]=i[c+1],e.depthSortedIndices[l*3+2]=i[c+2]}this.updateIndices(e.depthSortedIndices,void 0,!0)}return this}getFacetLocalNormals(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetNormals||this.updateFacetData(),e.facetNormals}getFacetLocalPositions(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetPositions||this.updateFacetData(),e.facetPositions}getFacetLocalPartitioning(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetPartitioning||this.updateFacetData(),e.facetPartitioning}getFacetPosition(e){const t=m.Zero();return this.getFacetPositionToRef(e,t),t}getFacetPositionToRef(e,t){const i=this.getFacetLocalPositions()[e],r=this.getWorldMatrix();return m.TransformCoordinatesToRef(i,r,t),this}getFacetNormal(e){const t=m.Zero();return this.getFacetNormalToRef(e,t),t}getFacetNormalToRef(e,t){const i=this.getFacetLocalNormals()[e];return m.TransformNormalToRef(i,this.getWorldMatrix(),t),this}getFacetsAtLocalCoordinates(e,t,i){const r=this.getBoundingInfo(),s=this._internalAbstractMeshDataInfo._facetData,n=Math.floor((e-r.minimum.x*s.partitioningBBoxRatio)*s.subDiv.X*s.partitioningBBoxRatio/s.bbSize.x),o=Math.floor((t-r.minimum.y*s.partitioningBBoxRatio)*s.subDiv.Y*s.partitioningBBoxRatio/s.bbSize.y),l=Math.floor((i-r.minimum.z*s.partitioningBBoxRatio)*s.subDiv.Z*s.partitioningBBoxRatio/s.bbSize.z);return n<0||n>s.subDiv.max||o<0||o>s.subDiv.max||l<0||l>s.subDiv.max?null:s.facetPartitioning[n+s.subDiv.max*o+s.subDiv.max*s.subDiv.max*l]}getClosestFacetAtCoordinates(e,t,i,r,s=!1,n=!0){const o=this.getWorldMatrix(),l=F.Matrix[5];o.invertToRef(l);const c=F.Vector3[8];m.TransformCoordinatesFromFloatsToRef(e,t,i,l,c);const h=this.getClosestFacetAtLocalCoordinates(c.x,c.y,c.z,r,s,n);return r&&m.TransformCoordinatesFromFloatsToRef(r.x,r.y,r.z,o,r),h}getClosestFacetAtLocalCoordinates(e,t,i,r,s=!1,n=!0){let o=null,l=0,c=0,h=0,f=0,u=0,d=0,_=0,p=0;const g=this.getFacetLocalPositions(),E=this.getFacetLocalNormals(),v=this.getFacetsAtLocalCoordinates(e,t,i);if(!v)return null;let b=Number.MAX_VALUE,R=b,S,T,I;for(let O=0;O<v.length;O++)S=v[O],T=E[S],I=g[S],f=(e-I.x)*T.x+(t-I.y)*T.y+(i-I.z)*T.z,(!s||s&&n&&f>=0||s&&!n&&f<=0)&&(f=T.x*I.x+T.y*I.y+T.z*I.z,u=-(T.x*e+T.y*t+T.z*i-f)/(T.x*T.x+T.y*T.y+T.z*T.z),d=e+T.x*u,_=t+T.y*u,p=i+T.z*u,l=d-e,c=_-t,h=p-i,R=l*l+c*c+h*h,R<b&&(b=R,o=S,r&&(r.x=d,r.y=_,r.z=p)));return o}getFacetDataParameters(){return this._internalAbstractMeshDataInfo._facetData.facetParameters}disableFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetDataEnabled&&(e.facetDataEnabled=!1,e.facetPositions=[],e.facetNormals=[],e.facetPartitioning=new Array,e.facetParameters={},e.depthSortedIndices=new Uint32Array(0)),this}updateIndices(e,t,i=!1){return this}createNormals(e){const t=this.getVerticesData(x.PositionKind),i=this.getIndices();let r;return this.isVerticesDataPresent(x.NormalKind)?r=this.getVerticesData(x.NormalKind):r=[],ee.ComputeNormals(t,i,r,{useRightHandedSystem:this.getScene().useRightHandedSystem}),this.setVerticesData(x.NormalKind,r,e),this}async optimizeIndicesAsync(){const e=this.getIndices();if(!e)return this;const{OptimizeIndices:t}=await X(async()=>{const{OptimizeIndices:i}=await Promise.resolve().then(()=>BO);return{OptimizeIndices:i}},void 0,import.meta.url);return t(e),this.setIndices(e,this.getTotalVertices()),this}alignWithNormal(e,t){t||(t=Vi.Y);const i=F.Vector3[0],r=F.Vector3[1];return m.CrossToRef(t,e,r),m.CrossToRef(e,r,i),this.rotationQuaternion?z.RotationQuaternionFromAxisToRef(i,e,r,this.rotationQuaternion):m.RotationFromAxisToRef(i,e,r,this.rotation),this}_checkOcclusionQuery(){return!1}disableEdgesRendering(){throw Le("EdgesRenderer")}enableEdgesRendering(e,t,i){throw Le("EdgesRenderer")}getConnectedParticleSystems(){return this._scene.particleSystems.filter(e=>e.emitter===this)}}ei.OCCLUSION_TYPE_NONE=0;ei.OCCLUSION_TYPE_OPTIMISTIC=1;ei.OCCLUSION_TYPE_STRICT=2;ei.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0;ei.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1;ei.CULLINGSTRATEGY_STANDARD=0;ei.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1;ei.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2;ei.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3;A([Fr.filter((...[a,e,t,i,r])=>!Array.isArray(a)&&!Array.isArray(e)&&!Array.isArray(t)&&!Array.isArray(i)&&!Array.isArray(r))],ei,"_ApplySkeleton",null);Y("BABYLON.AbstractMesh",ei);class Js extends q{get subMaterials(){return this._subMaterials}set subMaterials(e){this._subMaterials=e,this._hookArray(e)}getChildren(){return this.subMaterials}constructor(e,t){super(e,t,!0),this._waitingSubMaterialsUniqueIds=[],this.getScene().addMultiMaterial(this),this.subMaterials=[],this._storeEffectOnSubMeshes=!0}_hookArray(e){const t=e.push;e.push=(...r)=>{const s=t.apply(e,r);return this._markAllSubMeshesAsTexturesDirty(),s};const i=e.splice;e.splice=(r,s)=>{const n=i.apply(e,[r,s]);return this._markAllSubMeshesAsTexturesDirty(),n}}getSubMaterial(e){return e<0||e>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[e]}getActiveTextures(){return super.getActiveTextures().concat(...this.subMaterials.map(e=>e?e.getActiveTextures():[]))}hasTexture(e){var t;if(super.hasTexture(e))return!0;for(let i=0;i<this.subMaterials.length;i++)if((t=this.subMaterials[i])!=null&&t.hasTexture(e))return!0;return!1}getClassName(){return"MultiMaterial"}isReadyForSubMesh(e,t,i){for(let r=0;r<this.subMaterials.length;r++){const s=this.subMaterials[r];if(s){if(s._storeEffectOnSubMeshes){if(!s.isReadyForSubMesh(e,t,i))return!1;continue}if(!s.isReady(e))return!1}}return!0}clone(e,t){const i=new Js(e,this.getScene());for(let r=0;r<this.subMaterials.length;r++){let s=null;const n=this.subMaterials[r];t&&n?s=n.clone(e+"-"+n.name):s=this.subMaterials[r],i.subMaterials.push(s)}return i}serialize(){const e={};e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,qe&&(e.tags=qe.GetTags(this)),e.materialsUniqueIds=[],e.materials=[];for(let t=0;t<this.subMaterials.length;t++){const i=this.subMaterials[t];i?(e.materialsUniqueIds.push(i.uniqueId),e.materials.push(i.id)):(e.materialsUniqueIds.push(null),e.materials.push(null))}return e}dispose(e,t,i){const r=this.getScene();if(!r)return;if(i)for(let n=0;n<this.subMaterials.length;n++){const o=this.subMaterials[n];o&&o.dispose(e,t)}const s=r.multiMaterials.indexOf(this);s>=0&&r.multiMaterials.splice(s,1),super.dispose(e,t)}static ParseMultiMaterial(e,t){const i=new Js(e.name,t);return i.id=e.id,i._loadedUniqueId=e.uniqueId,qe&&qe.AddTagsTo(i,e.tags),e.materialsUniqueIds?i._waitingSubMaterialsUniqueIds=e.materialsUniqueIds:e.materials.forEach(r=>i.subMaterials.push(t.getLastMaterialById(r))),i}}Y("BABYLON.MultiMaterial",Js);class _C{constructor(e,t){this.distanceOrScreenCoverage=e,this.mesh=t}}class qm{}class pC{constructor(){this.visibleInstances={},this.batchCache=new ef,this.batchCacheReplacementModeInFrozenMode=new ef,this.instancesBufferSize=32*16*4}}class ef{constructor(){this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=[],this.hardwareInstancedRendering=[]}}class mC{constructor(){this.instancesCount=0,this.matrixBuffer=null,this.previousMatrixBuffer=null,this.matrixBufferSize=32*16,this.matrixData=null,this.boundingVectors=[],this.worldMatrices=null}}class gC{constructor(){this._areNormalsFrozen=!1,this._source=null,this.meshMap=null,this._preActivateId=-1,this._LODLevels=new Array,this._useLODScreenCoverage=!1,this._effectiveMaterial=null,this._forcedInstanceCount=0,this._overrideRenderingFillMode=null}}const or={source:null,parent:null,doNotCloneChildren:!1,clonePhysicsImpostor:!0,cloneThinInstances:!1};class N extends ei{static _GetDefaultSideOrientation(e){return e||N.FRONTSIDE}get useLODScreenCoverage(){return this._internalMeshDataInfo._useLODScreenCoverage}set useLODScreenCoverage(e){this._internalMeshDataInfo._useLODScreenCoverage=e,this._sortLODLevels()}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(e&&this._internalMeshDataInfo._sourcePositions&&(this.setVerticesData(x.PositionKind,this._internalMeshDataInfo._sourcePositions,!0),this._internalMeshDataInfo._sourceNormals&&this.setVerticesData(x.NormalKind,this._internalMeshDataInfo._sourceNormals,!0),this._internalMeshDataInfo._sourcePositions=null,this._internalMeshDataInfo._sourceNormals=null),this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get onBeforeRenderObservable(){return this._internalMeshDataInfo._onBeforeRenderObservable||(this._internalMeshDataInfo._onBeforeRenderObservable=new U),this._internalMeshDataInfo._onBeforeRenderObservable}get onBeforeBindObservable(){return this._internalMeshDataInfo._onBeforeBindObservable||(this._internalMeshDataInfo._onBeforeBindObservable=new U),this._internalMeshDataInfo._onBeforeBindObservable}get onAfterRenderObservable(){return this._internalMeshDataInfo._onAfterRenderObservable||(this._internalMeshDataInfo._onAfterRenderObservable=new U),this._internalMeshDataInfo._onAfterRenderObservable}get onBetweenPassObservable(){return this._internalMeshDataInfo._onBetweenPassObservable||(this._internalMeshDataInfo._onBetweenPassObservable=new U),this._internalMeshDataInfo._onBetweenPassObservable}get onBeforeDrawObservable(){return this._internalMeshDataInfo._onBeforeDrawObservable||(this._internalMeshDataInfo._onBeforeDrawObservable=new U),this._internalMeshDataInfo._onBeforeDrawObservable}set onBeforeDraw(e){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(e)}get hasInstances(){return this.instances.length>0}get hasThinInstances(){return(this.forcedInstanceCount||this._thinInstanceDataStorage.instancesCount||0)>0}get forcedInstanceCount(){return this._internalMeshDataInfo._forcedInstanceCount}set forcedInstanceCount(e){this._internalMeshDataInfo._forcedInstanceCount=e}get sideOrientation(){return this._internalMeshDataInfo._sideOrientation}set sideOrientation(e){this._internalMeshDataInfo._sideOrientation=e,this._internalAbstractMeshDataInfo._sideOrientationHint=this._scene.useRightHandedSystem&&e===1||!this._scene.useRightHandedSystem&&e===0}get overrideMaterialSideOrientation(){return this.sideOrientation}set overrideMaterialSideOrientation(e){this.sideOrientation=e,this.material&&(this.material.sideOrientation=null)}get overrideRenderingFillMode(){return this._internalMeshDataInfo._overrideRenderingFillMode}set overrideRenderingFillMode(e){this._internalMeshDataInfo._overrideRenderingFillMode=e}get material(){return this._internalAbstractMeshDataInfo._material}set material(e){e&&(this.material&&this.material.sideOrientation===null||this._internalAbstractMeshDataInfo._sideOrientationHint)&&(e.sideOrientation=null),this._setMaterial(e)}get source(){return this._internalMeshDataInfo._source}get cloneMeshMap(){return this._internalMeshDataInfo.meshMap}get isUnIndexed(){return this._unIndexed}set isUnIndexed(e){this._unIndexed!==e&&(this._unIndexed=e,this._markSubMeshesAsAttributesDirty())}get worldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesData}get previousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesPreviousData}get manualUpdateOfWorldMatrixInstancedBuffer(){return this._instanceDataStorage.manualUpdate}set manualUpdateOfWorldMatrixInstancedBuffer(e){this._instanceDataStorage.manualUpdate=e}get manualUpdateOfPreviousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.previousManualUpdate}set manualUpdateOfPreviousWorldMatrixInstancedBuffer(e){this._instanceDataStorage.previousManualUpdate=e}get forceWorldMatrixInstancedBufferUpdate(){return this._instanceDataStorage.forceMatrixUpdates}set forceWorldMatrixInstancedBufferUpdate(e){this._instanceDataStorage.forceMatrixUpdates=e}_copySource(e,t,i=!0,r=!1){var n,o;const s=this.getScene();if(e._geometry&&e._geometry.applyToMesh(this),Da.DeepCopy(e,this,["name","material","skeleton","instances","parent","uniqueId","source","metadata","morphTargetManager","hasInstances","worldMatrixInstancedBuffer","previousWorldMatrixInstancedBuffer","hasLODLevels","geometry","isBlocked","areNormalsFrozen","facetNb","isFacetDataEnabled","lightSources","useBones","isAnInstance","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","cloneMeshMap","hasBoundingInfo","physicsBody","physicsImpostor"],["_poseMatrix"]),this._internalMeshDataInfo._source=e,s.useClonedMeshMap&&(e._internalMeshDataInfo.meshMap||(e._internalMeshDataInfo.meshMap={}),e._internalMeshDataInfo.meshMap[this.uniqueId]=this),this._originalBuilderSideOrientation=e._originalBuilderSideOrientation,this._creationDataStorage=e._creationDataStorage,e._ranges){const l=e._ranges;for(const c in l)Object.prototype.hasOwnProperty.call(l,c)&&l[c]&&this.createAnimationRange(c,l[c].from,l[c].to)}if(e.metadata&&e.metadata.clone?this.metadata=e.metadata.clone():this.metadata=e.metadata,this._internalMetadata=e._internalMetadata,qe&&qe.HasTags(e)&&qe.AddTagsTo(this,qe.GetTags(e,!0)),this.setEnabled(e.isEnabled(!1)),this.parent=e.parent,this.setPivotMatrix(e.getPivotMatrix(),this._postMultiplyPivotMatrix),this.id=this.name+"."+e.id,this.material=e.material,!t){const l=e.getDescendants(!0);for(let c=0;c<l.length;c++){const h=l[c];h._isMesh?(or.parent=this,or.doNotCloneChildren=t,or.clonePhysicsImpostor=i,or.cloneThinInstances=r,h.clone(this.name+"."+h.name,or)):h.clone&&h.clone(this.name+"."+h.name,this)}}if(e.morphTargetManager&&(this.morphTargetManager=e.morphTargetManager),s.getPhysicsEngine){const l=s.getPhysicsEngine();if(i&&l)if(l.getPluginVersion()===1){const c=l.getImpostorForPhysicsObject(e);c&&(this.physicsImpostor=c.clone(this))}else l.getPluginVersion()===2&&e.physicsBody&&e.physicsBody.clone(this)}for(let l=0;l<s.particleSystems.length;l++){const c=s.particleSystems[l];c.emitter===e&&c.clone(c.name,this)}if(this.skeleton=e.skeleton,r&&(e._thinInstanceDataStorage.matrixData?(this.thinInstanceSetBuffer("matrix",new Float32Array(e._thinInstanceDataStorage.matrixData),16,!e._thinInstanceDataStorage.matrixBuffer.isUpdatable()),this._thinInstanceDataStorage.matrixBufferSize=e._thinInstanceDataStorage.matrixBufferSize,this._thinInstanceDataStorage.instancesCount=e._thinInstanceDataStorage.instancesCount):this._thinInstanceDataStorage.matrixBufferSize=e._thinInstanceDataStorage.matrixBufferSize,e._userThinInstanceBuffersStorage)){const l=e._userThinInstanceBuffersStorage;for(const c in l.data)this.thinInstanceSetBuffer(c,new Float32Array(l.data[c]),l.strides[c],!((o=(n=l.vertexBuffers)==null?void 0:n[c])!=null&&o.isUpdatable())),this._userThinInstanceBuffersStorage.sizes[c]=l.sizes[c]}this.refreshBoundingInfo(!0,!0),this.computeWorldMatrix(!0)}constructor(e,t=null,i=null,r=null,s,n=!0){super(e,t),this._internalMeshDataInfo=new gC,this.delayLoadState=0,this.instances=[],this._creationDataStorage=null,this._geometry=null,this._instanceDataStorage=new pC,this._thinInstanceDataStorage=new mC,this._shouldGenerateFlatShading=!1,this._originalBuilderSideOrientation=N.DEFAULTSIDE,this.ignoreCameraMaxZ=!1,t=this.getScene(),this._scene.useRightHandedSystem?this.sideOrientation=0:this.sideOrientation=1,this._onBeforeDraw=(c,h,f)=>{c&&f&&(this._uniformBuffer?this.transferToEffect(h):f.bindOnlyWorldMatrix(h))};let o=null,l=!1;if(i&&i._addToSceneRootNodes===void 0){const c=i;o=c.parent??null,r=c.source??null,s=c.doNotCloneChildren??!1,n=c.clonePhysicsImpostor??!0,l=c.cloneThinInstances??!1}else o=i;r&&this._copySource(r,s,n,l),o!==null&&(this.parent=o),this._instanceDataStorage.hardwareInstancedRendering=this.getEngine().getCaps().instancedArrays,this._internalMeshDataInfo._onMeshReadyObserverAdded=c=>{c.unregisterOnNextCall=!0,this.isReady(!0)?this.onMeshReadyObservable.notifyObservers(this):this._internalMeshDataInfo._checkReadinessObserver||(this._internalMeshDataInfo._checkReadinessObserver=this._scene.onBeforeRenderObservable.add(()=>{this.isReady(!0)&&(this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),this._internalMeshDataInfo._checkReadinessObserver=null,this.onMeshReadyObservable.notifyObservers(this))}))},this.onMeshReadyObservable=new U(this._internalMeshDataInfo._onMeshReadyObserverAdded),r&&r.onClonedObservable.notifyObservers(this)}instantiateHierarchy(e=null,t,i){const r=this.getTotalVertices()===0||t&&t.doNotInstantiate&&(t.doNotInstantiate===!0||t.doNotInstantiate(this))?this.clone("Clone of "+(this.name||this.id),e||this.parent,!0):this.createInstance("instance of "+(this.name||this.id));r.parent=e||this.parent,r.position=this.position.clone(),r.scaling=this.scaling.clone(),this.rotationQuaternion?r.rotationQuaternion=this.rotationQuaternion.clone():r.rotation=this.rotation.clone(),i&&i(this,r);for(const s of this.getChildTransformNodes(!0))s.getClassName()==="InstancedMesh"&&r.getClassName()==="Mesh"&&s.sourceMesh===this?s.instantiateHierarchy(r,{doNotInstantiate:t&&t.doNotInstantiate||!1,newSourcedMesh:r},i):s.instantiateHierarchy(r,t,i);return r}getClassName(){return"Mesh"}get _isMesh(){return!0}toString(e){let t=super.toString(e);if(t+=", n vertices: "+this.getTotalVertices(),t+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);if(e)if(this._geometry){const i=this.getIndices(),r=this.getVerticesData(x.PositionKind);r&&i&&(t+=", flat shading: "+(r.length/3===i.length?"YES":"NO"))}else t+=", flat shading: UNKNOWN";return t}_unBindEffect(){super._unBindEffect();for(const e of this.instances)e._unBindEffect()}get hasLODLevels(){return this._internalMeshDataInfo._LODLevels.length>0}getLODLevels(){return this._internalMeshDataInfo._LODLevels}_sortLODLevels(){const e=this._internalMeshDataInfo._useLODScreenCoverage?-1:1;this._internalMeshDataInfo._LODLevels.sort((t,i)=>t.distanceOrScreenCoverage<i.distanceOrScreenCoverage?e:t.distanceOrScreenCoverage>i.distanceOrScreenCoverage?-e:0)}addLODLevel(e,t){if(t&&t._masterMesh)return B.Warn("You cannot use a mesh as LOD level twice"),this;const i=new _C(e,t);return this._internalMeshDataInfo._LODLevels.push(i),t&&(t._masterMesh=this),this._sortLODLevels(),this}getLODLevelAtDistance(e){const t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++){const r=t._LODLevels[i];if(r.distanceOrScreenCoverage===e)return r.mesh}return null}removeLODLevel(e){const t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++)t._LODLevels[i].mesh===e&&(t._LODLevels.splice(i,1),e&&(e._masterMesh=null));return this._sortLODLevels(),this}getLOD(e,t){const i=this._internalMeshDataInfo;if(!i._LODLevels||i._LODLevels.length===0)return this;const r=t||this.getBoundingInfo().boundingSphere,s=e.mode===Ce.ORTHOGRAPHIC_CAMERA?e.minZ:r.centerWorld.subtract(e.globalPosition).length();let n=s,o=1;if(i._useLODScreenCoverage){const l=e.screenArea;let c=r.radiusWorld*e.minZ/s;c=c*c*Math.PI,n=c/l,o=-1}if(o*i._LODLevels[i._LODLevels.length-1].distanceOrScreenCoverage>o*n)return this.onLODLevelSelection&&this.onLODLevelSelection(n,this,this),this;for(let l=0;l<i._LODLevels.length;l++){const c=i._LODLevels[l];if(o*c.distanceOrScreenCoverage<o*n){if(c.mesh){if(c.mesh.delayLoadState===4)return c.mesh._checkDelayState(),this;if(c.mesh.delayLoadState===2)return this;c.mesh._preActivate(),c.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)}return this.onLODLevelSelection&&this.onLODLevelSelection(n,this,c.mesh),c.mesh}}return this.onLODLevelSelection&&this.onLODLevelSelection(n,this,this),this}get geometry(){return this._geometry}getTotalVertices(){return this._geometry===null||this._geometry===void 0?0:this._geometry.getTotalVertices()}getVerticesData(e,t,i,r){var n,o;if(!this._geometry)return null;let s=r||(o=(n=this._userInstancedBuffersStorage)==null?void 0:n.vertexBuffers[e])==null?void 0:o.getFloatData(this.instances.length+1,i||t&&this._geometry.meshes.length!==1);return s||(s=this._geometry.getVerticesData(e,t,i)),s}copyVerticesData(e,t){this._geometry&&this._geometry.copyVerticesData(e,t)}getVertexBuffer(e,t){var i;return this._geometry?(t||(i=this._userInstancedBuffersStorage)==null?void 0:i.vertexBuffers[e])??this._geometry.getVertexBuffer(e):null}isVerticesDataPresent(e,t){var i;return this._geometry?!t&&((i=this._userInstancedBuffersStorage)==null?void 0:i.vertexBuffers[e])!==void 0||this._geometry.isVerticesDataPresent(e):this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1}isVertexBufferUpdatable(e,t){var i;if(!this._geometry)return this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1;if(!t){const r=(i=this._userInstancedBuffersStorage)==null?void 0:i.vertexBuffers[e];if(r)return r.isUpdatable()}return this._geometry.isVertexBufferUpdatable(e)}getVerticesDataKinds(e){if(!this._geometry){const i=[];return this._delayInfo&&this._delayInfo.forEach(function(r){i.push(r)}),i}const t=this._geometry.getVerticesDataKinds();if(!e&&this._userInstancedBuffersStorage)for(const i in this._userInstancedBuffersStorage.vertexBuffers)t.indexOf(i)===-1&&t.push(i);return t}getTotalIndices(){return this._geometry?this._geometry.getTotalIndices():0}getIndices(e,t){return this._geometry?this._geometry.getIndices(e,t):[]}get isBlocked(){return this._masterMesh!==null&&this._masterMesh!==void 0}isReady(e=!1,t=!1){var l,c,h,f,u;if(this.delayLoadState===2||!super.isReady(e))return!1;if(!this.subMeshes||this.subMeshes.length===0||!e)return!0;const i=this.getEngine(),r=this.getScene(),s=t||i.getCaps().instancedArrays&&(this.instances.length>0||this.hasThinInstances);this.computeWorldMatrix();const n=this.material||r.defaultMaterial;if(n){if(n._storeEffectOnSubMeshes)for(const d of this.subMeshes){const _=d.getMaterial();if(_){if(_._storeEffectOnSubMeshes){if(!_.isReadyForSubMesh(this,d,s))return!1}else if(!_.isReady(this,s))return!1}}else if(!n.isReady(this,s))return!1}const o=i.currentRenderPassId;for(const d of this.lightSources){const _=d.getShadowGenerators();if(!_)continue;const p=_.values();for(let g=p.next();g.done!==!0;g=p.next()){const E=g.value;if(E&&(!((l=E.getShadowMap())!=null&&l.renderList)||(c=E.getShadowMap())!=null&&c.renderList&&((f=(h=E.getShadowMap())==null?void 0:h.renderList)==null?void 0:f.indexOf(this))!==-1)){const b=E.getShadowMap().renderPassIds??[i.currentRenderPassId];for(let R=0;R<b.length;++R){i.currentRenderPassId=b[R];for(const S of this.subMeshes)if(!E.isReady(S,s,((u=S.getMaterial())==null?void 0:u.needAlphaBlendingForMesh(this))??!1))return i.currentRenderPassId=o,!1}i.currentRenderPassId=o}}}for(const d of this._internalMeshDataInfo._LODLevels)if(d.mesh&&!d.mesh.isReady(s))return!1;return!0}get areNormalsFrozen(){return this._internalMeshDataInfo._areNormalsFrozen}freezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!0,this}unfreezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!1,this}set overridenInstanceCount(e){this._instanceDataStorage.overridenInstanceCount=e}_preActivate(){const e=this._internalMeshDataInfo,t=this.getScene().getRenderId();return e._preActivateId===t?this:(e._preActivateId=t,this._instanceDataStorage.visibleInstances=null,this)}_preActivateForIntermediateRendering(e){return this._instanceDataStorage.visibleInstances&&(this._instanceDataStorage.visibleInstances.intermediateDefaultRenderId=e),this}_registerInstanceForRenderId(e,t){return this._instanceDataStorage.visibleInstances||(this._instanceDataStorage.visibleInstances={defaultRenderId:t,selfDefaultRenderId:this._renderId}),this._instanceDataStorage.visibleInstances[t]||(this._instanceDataStorage.previousRenderId!==void 0&&this._instanceDataStorage.isFrozen&&(this._instanceDataStorage.visibleInstances[this._instanceDataStorage.previousRenderId]=null),this._instanceDataStorage.previousRenderId=t,this._instanceDataStorage.visibleInstances[t]=new Array),this._instanceDataStorage.visibleInstances[t].push(e),this}_afterComputeWorldMatrix(){super._afterComputeWorldMatrix(),this.hasThinInstances&&(this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1))}_postActivate(){this.edgesShareWithInstances&&this.edgesRenderer&&this.edgesRenderer.isEnabled&&this._renderingGroup&&(this._renderingGroup._edgesRenderers.pushNoDuplicate(this.edgesRenderer),this.edgesRenderer.customInstances.push(this.getWorldMatrix()))}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;let i;typeof e=="object"?i=e:i={applySkeleton:e,applyMorph:t};const r=this.geometry?this.geometry.boundingBias:null;return this._refreshBoundingInfo(this._getData(i,null,x.PositionKind),r),this}_createGlobalSubMesh(e){const t=this.getTotalVertices();if(!t||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){const i=this.getIndices();if(!i)return null;const r=i.length;let s=!1;if(e)s=!0;else for(const n of this.subMeshes){if(n.indexStart+n.indexCount>r){s=!0;break}if(n.verticesStart+n.verticesCount>t){s=!0;break}}if(!s)return this.subMeshes[0]}return this.releaseSubMeshes(),new Ei(0,0,t,0,this.getTotalIndices()||t,this)}subdivide(e){if(e<1)return;const t=this.getTotalIndices();let i=t/e|0,r=0;for(;i%3!==0;)i++;this.releaseSubMeshes();for(let s=0;s<e&&!(r>=t);s++)Ei.CreateFromIndices(0,r,s===e-1?t-r:i,this,void 0,!1),r+=i;this.refreshBoundingInfo(),this.synchronizeInstances()}setVerticesData(e,t,i=!1,r){if(this._geometry)this._geometry.setVerticesData(e,t,i,r);else{const s=new ee;s.set(t,e);const n=this.getScene();new ri(ri.RandomId(),n,s,i,this)}return this}removeVerticesData(e){this._geometry&&this._geometry.removeVerticesData(e)}markVerticesDataAsUpdatable(e,t=!0){const i=this.getVertexBuffer(e);!i||i.isUpdatable()===t||this.setVerticesData(e,this.getVerticesData(e),t)}setVerticesBuffer(e,t=!0){return this._geometry||(this._geometry=ri.CreateGeometryForMesh(this)),this._geometry.setVerticesBuffer(e,null,t),this}updateVerticesData(e,t,i,r){return this._geometry?(r?(this.makeGeometryUnique(),this.updateVerticesData(e,t,i,!1)):this._geometry.updateVerticesData(e,t,i),this):this}updateMeshPositions(e,t=!0){const i=this.getVerticesData(x.PositionKind);if(!i)return this;if(e(i),this.updateVerticesData(x.PositionKind,i,!1,!1),t){const r=this.getIndices(),s=this.getVerticesData(x.NormalKind);if(!s)return this;ee.ComputeNormals(i,r,s),this.updateVerticesData(x.NormalKind,s,!1,!1)}return this}makeGeometryUnique(){if(!this._geometry)return this;if(this._geometry.meshes.length===1)return this;const e=this._geometry,t=this._geometry.copy(ri.RandomId());return e.releaseForMesh(this,!0),t.applyToMesh(this),this}setIndexBuffer(e,t,i,r=null){let s=this._geometry;s||(s=new ri(ri.RandomId(),this.getScene(),void 0,void 0,this)),s.setIndexBuffer(e,t,i,r)}setIndices(e,t=null,i=!1,r=!1){if(this._geometry)this._geometry.setIndices(e,t,i,r);else{const s=new ee;s.indices=e;const n=this.getScene();new ri(ri.RandomId(),n,s,i,this)}return this}updateIndices(e,t,i=!1){return this._geometry?(this._geometry.updateIndices(e,t,i),this):this}toLeftHanded(){return this._geometry?(this._geometry.toLeftHanded(),this):this}_bind(e,t,i,r=!0){if(!this._geometry)return this;const s=this.getScene().getEngine();let n;if(this._unIndexed)switch(this._getRenderingFillMode(i)){case q.WireFrameFillMode:n=e._getLinesIndexBuffer(this.getIndices(),s);break;default:n=null;break}else switch(this._getRenderingFillMode(i)){case q.PointFillMode:n=null;break;case q.WireFrameFillMode:n=e._getLinesIndexBuffer(this.getIndices(),s);break;default:case q.TriangleFillMode:n=this._geometry.getIndexBuffer();break}return this._bindDirect(t,n,r)}_bindDirect(e,t,i=!0){return this._geometry?(this.morphTargetManager&&this.morphTargetManager.isUsingTextureForTargets&&this.morphTargetManager._bind(e),!i||!this._userInstancedBuffersStorage||this.hasThinInstances?this._geometry._bind(e,t):this._geometry._bind(e,t,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects),this):this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this._internalMeshDataInfo._onBeforeDrawObservable&&this._internalMeshDataInfo._onBeforeDrawObservable.notifyObservers(this);const s=this.getScene().getEngine();return this._unIndexed&&t!==q.WireFrameFillMode||t==q.PointFillMode?s.drawArraysType(t,e.verticesStart,e.verticesCount,this.forcedInstanceCount||i):t==q.WireFrameFillMode?s.drawElementsType(t,0,e._linesIndexCount,this.forcedInstanceCount||i):s.drawElementsType(t,e.indexStart,e.indexCount,this.forcedInstanceCount||i),this}registerBeforeRender(e){return this.onBeforeRenderObservable.add(e),this}unregisterBeforeRender(e){return this.onBeforeRenderObservable.removeCallback(e),this}registerAfterRender(e){return this.onAfterRenderObservable.add(e),this}unregisterAfterRender(e){return this.onAfterRenderObservable.removeCallback(e),this}_getInstancesRenderList(e,t=!1){if(this._instanceDataStorage.isFrozen){if(t)return this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.hardwareInstancedRendering[e]=!1,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.renderSelf[e]=!0,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode;if(this._instanceDataStorage.previousBatch)return this._instanceDataStorage.previousBatch}const i=this.getScene(),r=i._isInIntermediateRendering(),s=r?this._internalAbstractMeshDataInfo._onlyForInstancesIntermediate:this._internalAbstractMeshDataInfo._onlyForInstances,n=this._instanceDataStorage.batchCache;if(n.mustReturn=!1,n.renderSelf[e]=t||!s&&this.isEnabled()&&this.isVisible,n.visibleInstances[e]=null,this._instanceDataStorage.visibleInstances&&!t){const o=this._instanceDataStorage.visibleInstances,l=i.getRenderId(),c=r?o.intermediateDefaultRenderId:o.defaultRenderId;n.visibleInstances[e]=o[l],!n.visibleInstances[e]&&c&&(n.visibleInstances[e]=o[c])}return n.hardwareInstancedRendering[e]=!t&&this._instanceDataStorage.hardwareInstancedRendering&&n.visibleInstances[e]!==null&&n.visibleInstances[e]!==void 0,this._instanceDataStorage.previousBatch=n,n}_updateInstancedBuffers(e,t,i,r,s,n){var g;const o=t.visibleInstances[e._id],l=o?o.length:0,c=this._instanceDataStorage;let h=c.instancesBuffer,f=c.instancesPreviousBuffer,u=0,d=0;const _=t.renderSelf[e._id],p=!h||i!==c.instancesBufferSize||this._scene.needsPreviousWorldMatrices&&!c.instancesPreviousBuffer;if(!this._instanceDataStorage.manualUpdate&&(!c.isFrozen||p)){const E=this.getWorldMatrix();if(_&&(this._scene.needsPreviousWorldMatrices&&(c.masterMeshPreviousWorldMatrix?(c.masterMeshPreviousWorldMatrix.copyToArray(c.instancesPreviousData,u),c.masterMeshPreviousWorldMatrix.copyFrom(E)):(c.masterMeshPreviousWorldMatrix=E.clone(),c.masterMeshPreviousWorldMatrix.copyToArray(c.instancesPreviousData,u))),E.copyToArray(c.instancesData,u),u+=16,d++),o){if(N.INSTANCEDMESH_SORT_TRANSPARENT&&this._scene.activeCamera&&((g=e.getMaterial())!=null&&g.needAlphaBlendingForMesh(e.getRenderingMesh()))){const v=this._scene.activeCamera.globalPosition;for(let b=0;b<o.length;b++){const R=o[b];R._distanceToCamera=m.Distance(R.getBoundingInfo().boundingSphere.centerWorld,v)}o.sort((b,R)=>b._distanceToCamera>R._distanceToCamera?-1:b._distanceToCamera<R._distanceToCamera?1:0)}for(let v=0;v<o.length;v++){const b=o[v],R=b.getWorldMatrix();R.copyToArray(c.instancesData,u),this._scene.needsPreviousWorldMatrices&&(b._previousWorldMatrix?(b._previousWorldMatrix.copyToArray(c.instancesPreviousData,u),b._previousWorldMatrix.copyFrom(R)):(b._previousWorldMatrix=R.clone(),b._previousWorldMatrix.copyToArray(c.instancesPreviousData,u))),u+=16,d++}}}else d=(_?1:0)+l;p?(h&&h.dispose(),f&&f.dispose(),h=new Cn(r,c.instancesData,!0,16,!1,!0),c.instancesBuffer=h,this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this._userInstancedBuffersStorage.vertexBuffers.world0=h.createVertexBuffer("world0",0,4),this._userInstancedBuffersStorage.vertexBuffers.world1=h.createVertexBuffer("world1",4,4),this._userInstancedBuffersStorage.vertexBuffers.world2=h.createVertexBuffer("world2",8,4),this._userInstancedBuffersStorage.vertexBuffers.world3=h.createVertexBuffer("world3",12,4),this._scene.needsPreviousWorldMatrices&&(f=new Cn(r,c.instancesPreviousData,!0,16,!1,!0),c.instancesPreviousBuffer=f,this._userInstancedBuffersStorage.vertexBuffers.previousWorld0=f.createVertexBuffer("previousWorld0",0,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld1=f.createVertexBuffer("previousWorld1",4,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld2=f.createVertexBuffer("previousWorld2",8,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld3=f.createVertexBuffer("previousWorld3",12,4)),this._invalidateInstanceVertexArrayObject()):(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&(h.updateDirectly(c.instancesData,0,d),this._scene.needsPreviousWorldMatrices&&(!this._instanceDataStorage.manualUpdate||this._instanceDataStorage.previousManualUpdate)&&f.updateDirectly(c.instancesPreviousData,0,d)),this._processInstancedBuffers(o,_),n&&s!==void 0&&(this.getScene()._activeIndices.addCount(e.indexCount*d,!1),r._currentDrawContext&&(r._currentDrawContext.useInstancing=!0),this._bind(e,n,s),this._draw(e,s,d)),this._scene.needsPreviousWorldMatrices&&!p&&this._instanceDataStorage.manualUpdate&&(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&!this._instanceDataStorage.previousManualUpdate&&f.updateDirectly(c.instancesData,0,d)}_renderWithInstances(e,t,i,r,s){const n=i.visibleInstances[e._id],o=n?n.length:0,l=this._instanceDataStorage,c=l.instancesBufferSize,f=(o+1)*16*4;for(;l.instancesBufferSize<f;)l.instancesBufferSize*=2;return(!l.instancesData||c!=l.instancesBufferSize)&&(l.instancesData=new Float32Array(l.instancesBufferSize/4)),(this._scene.needsPreviousWorldMatrices&&!l.instancesPreviousData||c!=l.instancesBufferSize)&&(l.instancesPreviousData=new Float32Array(l.instancesBufferSize/4)),this._updateInstancedBuffers(e,i,c,s,t,r),s.unbindInstanceAttributes(),this}_renderWithThinInstances(e,t,i,r){var n;const s=((n=this._thinInstanceDataStorage)==null?void 0:n.instancesCount)??0;this.getScene()._activeIndices.addCount(e.indexCount*s,!1),r._currentDrawContext&&(r._currentDrawContext.useInstancing=!0),this._bind(e,i,t),this._draw(e,t,s),this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&this._thinInstanceDataStorage.matrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?this._thinInstanceDataStorage.previousMatrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,s):this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.matrixData,!1)),r.unbindInstanceAttributes()}_processInstancedBuffers(e,t){}_processRendering(e,t,i,r,s,n,o,l){const c=this.getScene(),h=c.getEngine();if(r=this._getRenderingFillMode(r),n&&t.getRenderingMesh().hasThinInstances)return this._renderWithThinInstances(t,r,i,h),this;if(n)this._renderWithInstances(t,r,s,i,h);else{h._currentDrawContext&&(h._currentDrawContext.useInstancing=!1);let f=0;s.renderSelf[t._id]&&(o&&o(!1,e.getWorldMatrix(),l),f++,this._draw(t,r,this._instanceDataStorage.overridenInstanceCount));const u=s.visibleInstances[t._id];if(u){const d=u.length;f+=d;for(let _=0;_<d;_++){const g=u[_].getWorldMatrix();o&&o(!0,g,l),this._draw(t,r)}}c._activeIndices.addCount(t.indexCount*f,!1)}return this}_rebuild(e=!1){if(this._instanceDataStorage.instancesBuffer&&(e&&this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null),this._userInstancedBuffersStorage){for(const t in this._userInstancedBuffersStorage.vertexBuffers){const i=this._userInstancedBuffersStorage.vertexBuffers[t];i&&(e&&i.dispose(),this._userInstancedBuffersStorage.vertexBuffers[t]=null)}this._userInstancedBuffersStorage.vertexArrayObjects&&(this._userInstancedBuffersStorage.vertexArrayObjects={})}this._internalMeshDataInfo._effectiveMaterial=null,super._rebuild(e)}_freeze(){if(this.subMeshes){for(let e=0;e<this.subMeshes.length;e++)this._getInstancesRenderList(e);this._internalMeshDataInfo._effectiveMaterial=null,this._instanceDataStorage.isFrozen=!0}}_unFreeze(){this._instanceDataStorage.isFrozen=!1,this._instanceDataStorage.previousBatch=null}renderWithRenderPassId(e,t,i,r,s=!0){const n=this._scene.getEngine(),o=n.currentRenderPassId;if(e!==void 0&&(n.currentRenderPassId=e),r)(!s||s&&r.isInFrustum(this._scene._frustumPlanes))&&this.render(r,!!t,i);else for(let l=0;l<this.subMeshes.length;l++){const c=this.subMeshes[l];(!s||s&&c.isInFrustum(this._scene._frustumPlanes))&&this.render(c,!!t,i)}return e!==void 0&&(n.currentRenderPassId=o),this}directRender(){if(!this.subMeshes)return this;for(const e of this.subMeshes)this.render(e,!1);return this}render(e,t,i){var I,O;const r=this.getScene();this._internalAbstractMeshDataInfo._isActiveIntermediate?this._internalAbstractMeshDataInfo._isActiveIntermediate=!1:this._internalAbstractMeshDataInfo._isActive=!1;const s=((I=r.activeCameras)==null?void 0:I.length)??0;if((s>1&&r.activeCamera===r.activeCameras[0]||s<=1)&&this._checkOcclusionQuery()&&!this._occlusionDataStorage.forceRenderingWhenOccluded)return this;const o=this._getInstancesRenderList(e._id,!!i);if(o.mustReturn)return this;if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;const l=r.getEngine();let c=0,h=null;this.ignoreCameraMaxZ&&r.activeCamera&&!r._isInIntermediateRendering()&&(c=r.activeCamera.maxZ,h=r.activeCamera,r.activeCamera.maxZ=0,r.updateTransformMatrix(!0)),this._internalMeshDataInfo._onBeforeRenderObservable&&this._internalMeshDataInfo._onBeforeRenderObservable.notifyObservers(this);const f=e.getRenderingMesh(),u=o.hardwareInstancedRendering[e._id]||f.hasThinInstances||!!this._userInstancedBuffersStorage&&!e.getMesh()._internalAbstractMeshDataInfo._actAsRegularMesh,d=this._instanceDataStorage,_=e.getMaterial();if(!_)return h&&(h.maxZ=c,r.updateTransformMatrix(!0)),this;if(!d.isFrozen||!this._internalMeshDataInfo._effectiveMaterial||this._internalMeshDataInfo._effectiveMaterial!==_){if(_._storeEffectOnSubMeshes){if(!_.isReadyForSubMesh(this,e,u))return h&&(h.maxZ=c,r.updateTransformMatrix(!0)),this}else if(!_.isReady(this,u))return h&&(h.maxZ=c,r.updateTransformMatrix(!0)),this;this._internalMeshDataInfo._effectiveMaterial=_}else if(_._storeEffectOnSubMeshes&&!((O=e._drawWrapper)!=null&&O._wasPreviouslyReady)||!_._storeEffectOnSubMeshes&&!_._getDrawWrapper()._wasPreviouslyReady)return h&&(h.maxZ=c,r.updateTransformMatrix(!0)),this;t&&l.setAlphaMode(this._internalMeshDataInfo._effectiveMaterial.alphaMode);let p;this._internalMeshDataInfo._effectiveMaterial._storeEffectOnSubMeshes?p=e._drawWrapper:p=this._internalMeshDataInfo._effectiveMaterial._getDrawWrapper();const g=(p==null?void 0:p.effect)??null;for(const L of r._beforeRenderingMeshStage)L.action(this,e,o,g);if(!p||!g)return h&&(h.maxZ=c,r.updateTransformMatrix(!0)),this;const E=i||this;let v;if(!d.isFrozen&&(this._internalMeshDataInfo._effectiveMaterial.backFaceCulling||this._internalMeshDataInfo._effectiveMaterial.sideOrientation!==null||this._internalMeshDataInfo._effectiveMaterial.twoSidedLighting)){const L=E._getWorldMatrixDeterminant();v=this._internalMeshDataInfo._effectiveMaterial._getEffectiveOrientation(this),L<0&&(v=v===q.ClockWiseSideOrientation?q.CounterClockWiseSideOrientation:q.ClockWiseSideOrientation),d.sideOrientation=v}else v=d.sideOrientation;const b=this._internalMeshDataInfo._effectiveMaterial._preBind(p,v);this._internalMeshDataInfo._effectiveMaterial.forceDepthWrite&&l.setDepthWrite(!0);const R=this._internalMeshDataInfo._effectiveMaterial,S=R.fillMode;this._internalMeshDataInfo._onBeforeBindObservable&&this._internalMeshDataInfo._onBeforeBindObservable.notifyObservers(this),u||this._bind(e,g,S,!1);const T=E.getWorldMatrix();R._storeEffectOnSubMeshes?R.bindForSubMesh(T,this,e):R.bind(T,this),!R.backFaceCulling&&R.separateCullingPass&&(l.setState(!0,R.zOffset,!1,!b,R.cullBackFaces,R.stencil,R.zOffsetUnits),this._processRendering(this,e,g,S,o,u,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),l.setState(!0,R.zOffset,!1,b,R.cullBackFaces,R.stencil,R.zOffsetUnits),this._internalMeshDataInfo._onBetweenPassObservable&&this._internalMeshDataInfo._onBetweenPassObservable.notifyObservers(e)),this._processRendering(this,e,g,S,o,u,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),this._internalMeshDataInfo._effectiveMaterial.unbind();for(const L of r._afterRenderingMeshStage)L.action(this,e,o,g);return this._internalMeshDataInfo._onAfterRenderObservable&&this._internalMeshDataInfo._onAfterRenderObservable.notifyObservers(this),h&&(h.maxZ=c,r.updateTransformMatrix(!0)),r.performancePriority===2&&!d.isFrozen&&this._freeze(),this}cleanMatrixWeights(){this.isVerticesDataPresent(x.MatricesWeightsKind)&&(this.isVerticesDataPresent(x.MatricesWeightsExtraKind)?this._normalizeSkinWeightsAndExtra():this._normalizeSkinFourWeights())}_normalizeSkinFourWeights(){const e=this.getVerticesData(x.MatricesWeightsKind),t=e.length;for(let i=0;i<t;i+=4){const r=e[i]+e[i+1]+e[i+2]+e[i+3];if(r===0)e[i]=1;else{const s=1/r;e[i]*=s,e[i+1]*=s,e[i+2]*=s,e[i+3]*=s}}this.setVerticesData(x.MatricesWeightsKind,e)}_normalizeSkinWeightsAndExtra(){const e=this.getVerticesData(x.MatricesWeightsExtraKind),t=this.getVerticesData(x.MatricesWeightsKind),i=t.length;for(let r=0;r<i;r+=4){let s=t[r]+t[r+1]+t[r+2]+t[r+3];if(s+=e[r]+e[r+1]+e[r+2]+e[r+3],s===0)t[r]=1;else{const n=1/s;t[r]*=n,t[r+1]*=n,t[r+2]*=n,t[r+3]*=n,e[r]*=n,e[r+1]*=n,e[r+2]*=n,e[r+3]*=n}}this.setVerticesData(x.MatricesWeightsKind,t),this.setVerticesData(x.MatricesWeightsKind,e)}validateSkinning(){const e=this.getVerticesData(x.MatricesWeightsExtraKind),t=this.getVerticesData(x.MatricesWeightsKind);if(t===null||this.skeleton==null)return{skinned:!1,valid:!0,report:"not skinned"};const i=t.length;let r=0,s=0,n=0,o=0;const l=e===null?4:8,c=[];for(let g=0;g<=l;g++)c[g]=0;const h=.001;for(let g=0;g<i;g+=4){let E=t[g],v=E,b=v===0?0:1;for(let R=1;R<l;R++){const S=R<4?t[g+R]:e[g+R-4];S>E&&r++,S!==0&&b++,v+=S,E=S}if(c[b]++,b>n&&(n=b),v===0)s++;else{const R=1/v;let S=0;for(let T=0;T<l;T++)T<4?S+=Math.abs(t[g+T]-t[g+T]*R):S+=Math.abs(e[g+T-4]-e[g+T-4]*R);S>h&&o++}}const f=this.skeleton.bones.length,u=this.getVerticesData(x.MatricesIndicesKind),d=this.getVerticesData(x.MatricesIndicesExtraKind);let _=0;for(let g=0;g<i;g+=4)for(let E=0;E<l;E++){const v=E<4?u[g+E]:d[g+E-4];(v>=f||v<0)&&_++}const p="Number of Weights = "+i/4+`
Maximum influences = `+n+`
Missing Weights = `+s+`
Not Sorted = `+r+`
Not Normalized = `+o+`
WeightCounts = [`+c+`]
Number of bones = `+f+`
Bad Bone Indices = `+_;return{skinned:!0,valid:s===0&&o===0&&_===0,report:p}}_checkDelayState(){const e=this.getScene();return this._geometry?this._geometry.load(e):this.delayLoadState===4&&(this.delayLoadState=2,this._queueLoad(e)),this}_queueLoad(e){e.addPendingData(this);const t=this.delayLoadingFile.indexOf(".babylonbinarymeshdata")!==-1;return k.LoadFile(this.delayLoadingFile,i=>{i instanceof ArrayBuffer?this._delayLoadingFunction(i,this):this._delayLoadingFunction(JSON.parse(i),this),this.instances.forEach(r=>{r.refreshBoundingInfo(),r._syncSubMeshes()}),this.delayLoadState=1,e.removePendingData(this)},()=>{},e.offlineProvider,t),this}isInFrustum(e){return this.delayLoadState===2||!super.isInFrustum(e)?!1:(this._checkDelayState(),!0)}setMaterialById(e){const t=this.getScene().materials;let i;for(i=t.length-1;i>-1;i--)if(t[i].id===e)return this.material=t[i],this;const r=this.getScene().multiMaterials;for(i=r.length-1;i>-1;i--)if(r[i].id===e)return this.material=r[i],this;return this}getAnimatables(){const e=[];return this.material&&e.push(this.material),this.skeleton&&e.push(this.skeleton),e}bakeTransformIntoVertices(e){if(!this.isVerticesDataPresent(x.PositionKind))return this;const t=this.subMeshes.splice(0);this._resetPointsArrayCache();let i=this.getVerticesData(x.PositionKind);const r=m.Zero();let s;for(s=0;s<i.length;s+=3)m.TransformCoordinatesFromFloatsToRef(i[s],i[s+1],i[s+2],e,r).toArray(i,s);if(this.setVerticesData(x.PositionKind,i,this.getVertexBuffer(x.PositionKind).isUpdatable()),this.isVerticesDataPresent(x.NormalKind)){for(i=this.getVerticesData(x.NormalKind),s=0;s<i.length;s+=3)m.TransformNormalFromFloatsToRef(i[s],i[s+1],i[s+2],e,r).normalize().toArray(i,s);this.setVerticesData(x.NormalKind,i,this.getVertexBuffer(x.NormalKind).isUpdatable())}if(this.isVerticesDataPresent(x.TangentKind)){for(i=this.getVerticesData(x.TangentKind),s=0;s<i.length;s+=4)m.TransformNormalFromFloatsToRef(i[s],i[s+1],i[s+2],e,r).normalize().toArray(i,s);this.setVerticesData(x.TangentKind,i,this.getVertexBuffer(x.TangentKind).isUpdatable())}return e.determinant()<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=t,this}bakeCurrentTransformIntoVertices(e=!0,t=!1){return t&&this.makeGeometryUnique(),this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.resetLocalMatrix(e),this}get _positions(){return this._internalAbstractMeshDataInfo._positions||this._geometry&&this._geometry._positions||null}_resetPointsArrayCache(){return this._geometry&&this._geometry._resetPointsArrayCache(),this}_generatePointsArray(){return this._geometry?this._geometry._generatePointsArray():!1}clone(e="",t=null,i,r=!0){if(t&&t._addToSceneRootNodes===void 0){const s=t;return or.source=this,or.doNotCloneChildren=s.doNotCloneChildren,or.clonePhysicsImpostor=s.clonePhysicsImpostor,or.cloneThinInstances=s.cloneThinInstances,new N(e,this.getScene(),or)}return new N(e,this.getScene(),t,this,i,r)}dispose(e,t=!1){this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,!0);const i=this._internalMeshDataInfo;if(i._onBeforeDrawObservable&&i._onBeforeDrawObservable.clear(),i._onBeforeBindObservable&&i._onBeforeBindObservable.clear(),i._onBeforeRenderObservable&&i._onBeforeRenderObservable.clear(),i._onAfterRenderObservable&&i._onAfterRenderObservable.clear(),i._onBetweenPassObservable&&i._onBetweenPassObservable.clear(),this._scene.useClonedMeshMap){if(i.meshMap)for(const r in i.meshMap){const s=i.meshMap[r];s&&(s._internalMeshDataInfo._source=null,i.meshMap[r]=void 0)}i._source&&i._source._internalMeshDataInfo.meshMap&&(i._source._internalMeshDataInfo.meshMap[this.uniqueId]=void 0)}else{const r=this.getScene().meshes;for(const s of r){const n=s;n._internalMeshDataInfo&&n._internalMeshDataInfo._source&&n._internalMeshDataInfo._source===this&&(n._internalMeshDataInfo._source=null)}}i._source=null,this._instanceDataStorage.visibleInstances={},this._disposeInstanceSpecificData(),this._disposeThinInstanceSpecificData(),this._internalMeshDataInfo._checkReadinessObserver&&this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),super.dispose(e,t)}_disposeInstanceSpecificData(){}_disposeThinInstanceSpecificData(){}_invalidateInstanceVertexArrayObject(){}applyDisplacementMap(e,t,i,r,s,n,o=!1,l){const c=this.getScene(),h=f=>{const u=f.width,d=f.height,p=this.getEngine().createCanvas(u,d).getContext("2d");p.drawImage(f,0,0);const g=p.getImageData(0,0,u,d).data;this.applyDisplacementMapFromBuffer(g,u,d,t,i,s,n,o),r&&r(this)};return k.LoadImage(e,h,l||(()=>{}),c.offlineProvider),this}applyDisplacementMapFromBuffer(e,t,i,r,s,n,o,l=!1){if(!this.isVerticesDataPresent(x.PositionKind)||!this.isVerticesDataPresent(x.NormalKind)||!this.isVerticesDataPresent(x.UVKind))return B.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing"),this;const c=this.getVerticesData(x.PositionKind,!0,!0),h=this.getVerticesData(x.NormalKind),f=this.getVerticesData(x.UVKind);let u=m.Zero();const d=m.Zero(),_=ne.Zero();n=n||ne.Zero(),o=o||new ne(1,1);for(let p=0;p<c.length;p+=3){m.FromArrayToRef(c,p,u),m.FromArrayToRef(h,p,d),ne.FromArrayToRef(f,p/3*2,_);const g=Math.abs(_.x*o.x+n.x%1)*(t-1)%t|0,E=Math.abs(_.y*o.y+n.y%1)*(i-1)%i|0,v=(g+E*t)*4,b=e[v]/255,R=e[v+1]/255,S=e[v+2]/255,T=b*.3+R*.59+S*.11;d.normalize(),d.scaleInPlace(r+(s-r)*T),u=u.add(d),u.toArray(c,p)}return ee.ComputeNormals(c,this.getIndices(),h),l?(this.setVerticesData(x.PositionKind,c),this.setVerticesData(x.NormalKind,h),this.setVerticesData(x.UVKind,f)):(this.updateVerticesData(x.PositionKind,c),this.updateVerticesData(x.NormalKind,h)),this}_getFlattenedNormals(e,t){const i=new Float32Array(e.length*3);let r=0;const s=this.sideOrientation===(this._scene.useRightHandedSystem?1:0);for(let n=0;n<e.length;n+=3){const o=m.FromArray(t,e[n]*3),l=m.FromArray(t,e[n+1]*3),c=m.FromArray(t,e[n+2]*3),h=o.subtract(l),f=c.subtract(l),u=m.Normalize(m.Cross(h,f));s&&u.scaleInPlace(-1);for(let d=0;d<3;d++)i[r++]=u.x,i[r++]=u.y,i[r++]=u.z}return i}_convertToUnIndexedMesh(e=!1){const t=this.getVerticesDataKinds().filter(l=>{var c;return!((c=this.getVertexBuffer(l))!=null&&c.getIsInstanced())}),i=this.getIndices(),r={},s=(l,c)=>{const h=new Float32Array(i.length*c);let f=0;for(let u=0;u<i.length;u++)for(let d=0;d<c;d++)h[f++]=l[i[u]*c+d];return h},n=this.getBoundingInfo(),o=this.geometry?this.subMeshes.slice(0):[];for(const l of t)r[l]=this.getVerticesData(l);for(const l of t){const c=this.getVertexBuffer(l),h=c.getSize();if(e&&l===x.NormalKind){const f=this._getFlattenedNormals(i,r[x.PositionKind]);this.setVerticesData(x.NormalKind,f,c.isUpdatable(),h)}else this.setVerticesData(l,s(r[l],h),c.isUpdatable(),h)}if(this.morphTargetManager){for(let l=0;l<this.morphTargetManager.numTargets;l++){const c=this.morphTargetManager.getTarget(l),h=c.getPositions();c.setPositions(s(h,3));const f=c.getNormals();f&&c.setNormals(e?this._getFlattenedNormals(i,h):s(f,3));const u=c.getTangents();u&&c.setTangents(s(u,3));const d=c.getUVs();d&&c.setUVs(s(d,2));const _=c.getColors();_&&c.setColors(s(_,4))}this.morphTargetManager.synchronize()}for(let l=0;l<i.length;l++)i[l]=l;this.setIndices(i),this._unIndexed=!0,this.releaseSubMeshes();for(const l of o){const c=l.getBoundingInfo();Ei.AddToMesh(l.materialIndex,l.indexStart,l.indexCount,l.indexStart,l.indexCount,this).setBoundingInfo(c)}return this.setBoundingInfo(n),this.synchronizeInstances(),this}convertToFlatShadedMesh(){return this._convertToUnIndexedMesh(!0)}convertToUnIndexedMesh(){return this._convertToUnIndexedMesh()}flipFaces(e=!1){const t=ee.ExtractFromMesh(this);let i;if(e&&this.isVerticesDataPresent(x.NormalKind)&&t.normals){for(i=0;i<t.normals.length;i++)t.normals[i]*=-1;this.setVerticesData(x.NormalKind,t.normals,this.isVertexBufferUpdatable(x.NormalKind))}if(t.indices){let r;for(i=0;i<t.indices.length;i+=3)r=t.indices[i+1],t.indices[i+1]=t.indices[i+2],t.indices[i+2]=r;this.setIndices(t.indices,null,this.isVertexBufferUpdatable(x.PositionKind),!0)}return this}increaseVertices(e=1){const t=ee.ExtractFromMesh(this),i=t.indices&&!Array.isArray(t.indices)&&Array.from?Array.from(t.indices):t.indices,r=t.positions&&!Array.isArray(t.positions)&&Array.from?Array.from(t.positions):t.positions,s=t.uvs&&!Array.isArray(t.uvs)&&Array.from?Array.from(t.uvs):t.uvs,n=t.normals&&!Array.isArray(t.normals)&&Array.from?Array.from(t.normals):t.normals;if(!i||!r)B.Warn("Couldn't increase number of vertices : VertexData must contain at least indices and positions");else{t.indices=i,t.positions=r,s&&(t.uvs=s),n&&(t.normals=n);const o=e+1,l=new Array;for(let S=0;S<o+1;S++)l[S]=new Array;let c,h;const f=new m(0,0,0),u=new m(0,0,0),d=new ne(0,0),_=new Array,p=new Array,g=new Array;let E,v=r.length,b;s&&(b=s.length);let R;n&&(R=n.length);for(let S=0;S<i.length;S+=3){p[0]=i[S],p[1]=i[S+1],p[2]=i[S+2];for(let T=0;T<3;T++)if(c=p[T],h=p[(T+1)%3],g[c]===void 0&&g[h]===void 0?(g[c]=new Array,g[h]=new Array):(g[c]===void 0&&(g[c]=new Array),g[h]===void 0&&(g[h]=new Array)),g[c][h]===void 0&&g[h][c]===void 0){g[c][h]=[],f.x=(r[3*h]-r[3*c])/o,f.y=(r[3*h+1]-r[3*c+1])/o,f.z=(r[3*h+2]-r[3*c+2])/o,n&&(u.x=(n[3*h]-n[3*c])/o,u.y=(n[3*h+1]-n[3*c+1])/o,u.z=(n[3*h+2]-n[3*c+2])/o),s&&(d.x=(s[2*h]-s[2*c])/o,d.y=(s[2*h+1]-s[2*c+1])/o),g[c][h].push(c);for(let I=1;I<o;I++)g[c][h].push(r.length/3),r[v++]=r[3*c]+I*f.x,r[v++]=r[3*c+1]+I*f.y,r[v++]=r[3*c+2]+I*f.z,n&&(n[R++]=n[3*c]+I*u.x,n[R++]=n[3*c+1]+I*u.y,n[R++]=n[3*c+2]+I*u.z),s&&(s[b++]=s[2*c]+I*d.x,s[b++]=s[2*c+1]+I*d.y);g[c][h].push(h),g[h][c]=new Array,E=g[c][h].length;for(let I=0;I<E;I++)g[h][c][I]=g[c][h][E-1-I]}l[0][0]=i[S],l[1][0]=g[i[S]][i[S+1]][1],l[1][1]=g[i[S]][i[S+2]][1];for(let T=2;T<o;T++){l[T][0]=g[i[S]][i[S+1]][T],l[T][T]=g[i[S]][i[S+2]][T],f.x=(r[3*l[T][T]]-r[3*l[T][0]])/T,f.y=(r[3*l[T][T]+1]-r[3*l[T][0]+1])/T,f.z=(r[3*l[T][T]+2]-r[3*l[T][0]+2])/T,n&&(u.x=(n[3*l[T][T]]-n[3*l[T][0]])/T,u.y=(n[3*l[T][T]+1]-n[3*l[T][0]+1])/T,u.z=(n[3*l[T][T]+2]-n[3*l[T][0]+2])/T),s&&(d.x=(s[2*l[T][T]]-s[2*l[T][0]])/T,d.y=(s[2*l[T][T]+1]-s[2*l[T][0]+1])/T);for(let I=1;I<T;I++)l[T][I]=r.length/3,r[v++]=r[3*l[T][0]]+I*f.x,r[v++]=r[3*l[T][0]+1]+I*f.y,r[v++]=r[3*l[T][0]+2]+I*f.z,n&&(n[R++]=n[3*l[T][0]]+I*u.x,n[R++]=n[3*l[T][0]+1]+I*u.y,n[R++]=n[3*l[T][0]+2]+I*u.z),s&&(s[b++]=s[2*l[T][0]]+I*d.x,s[b++]=s[2*l[T][0]+1]+I*d.y)}l[o]=g[i[S+1]][i[S+2]],_.push(l[0][0],l[1][0],l[1][1]);for(let T=1;T<o;T++){let I;for(I=0;I<T;I++)_.push(l[T][I],l[T+1][I],l[T+1][I+1]),_.push(l[T][I],l[T+1][I+1],l[T][I+1]);_.push(l[T][I],l[T+1][I],l[T+1][I+1])}}t.indices=_,t.applyToMesh(this,this.isVertexBufferUpdatable(x.PositionKind))}}forceSharedVertices(){const e=ee.ExtractFromMesh(this),t=e.uvs,i=e.indices,r=e.positions,s=e.colors,n=e.matricesIndices,o=e.matricesWeights,l=e.matricesIndicesExtra,c=e.matricesWeightsExtra;if(i===void 0||r===void 0||i===null||r===null)B.Warn("VertexData contains empty entries");else{const h=new Array,f=new Array,u=new Array,d=new Array,_=new Array,p=new Array,g=new Array,E=new Array;let v=new Array,b=0;const R={};let S,T;for(let O=0;O<i.length;O+=3){T=[i[O],i[O+1],i[O+2]],v=[];for(let L=0;L<3;L++){v[L]="";for(let w=0;w<3;w++)Math.abs(r[3*T[L]+w])<1e-8&&(r[3*T[L]+w]=0),v[L]+=r[3*T[L]+w]+"|"}if(!(v[0]==v[1]||v[0]==v[2]||v[1]==v[2]))for(let L=0;L<3;L++){if(S=R[v[L]],S===void 0){R[v[L]]=b,S=b++;for(let w=0;w<3;w++)h.push(r[3*T[L]+w]);if(s!=null)for(let w=0;w<4;w++)d.push(s[4*T[L]+w]);if(t!=null)for(let w=0;w<2;w++)u.push(t[2*T[L]+w]);if(n!=null)for(let w=0;w<4;w++)_.push(n[4*T[L]+w]);if(o!=null)for(let w=0;w<4;w++)p.push(o[4*T[L]+w]);if(l!=null)for(let w=0;w<4;w++)g.push(l[4*T[L]+w]);if(c!=null)for(let w=0;w<4;w++)E.push(c[4*T[L]+w])}f.push(S)}}const I=new Array;ee.ComputeNormals(h,f,I),e.positions=h,e.indices=f,e.normals=I,t!=null&&(e.uvs=u),s!=null&&(e.colors=d),n!=null&&(e.matricesIndices=_),o!=null&&(e.matricesWeights=p),l!=null&&(e.matricesIndicesExtra=g),o!=null&&(e.matricesWeightsExtra=E),e.applyToMesh(this,this.isVertexBufferUpdatable(x.PositionKind))}}static _instancedMeshFactory(e,t){throw Le("InstancedMesh")}static _PhysicsImpostorParser(e,t,i){throw Le("PhysicsImpostor")}createInstance(e){const t=N._instancedMeshFactory(e,this);return t.parent=this.parent,t}synchronizeInstances(){for(let e=0;e<this.instances.length;e++)this.instances[e]._syncSubMeshes();return this}optimizeIndices(e){const t=this.getIndices(),i=this.getVerticesData(x.PositionKind);if(!i||!t)return this;const r=[];for(let n=0;n<i.length;n=n+3)r.push(m.FromArray(i,n));const s=[];return Ra.SyncAsyncForLoop(r.length,40,n=>{const o=r.length-1-n,l=r[o];for(let c=0;c<o;++c){const h=r[c];if(l.equals(h)){s[o]=c;break}}},()=>{for(let o=0;o<t.length;++o)t[o]=s[t[o]]||t[o];const n=this.subMeshes.slice(0);this.setIndices(t),this.subMeshes=n,e&&e(this)}),this}serialize(e={}){e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,e.type=this.getClassName(),qe&&qe.HasTags(this)&&(e.tags=qe.GetTags(this)),e.position=this.position.asArray(),this.rotationQuaternion?e.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(e.rotation=this.rotation.asArray()),e.scaling=this.scaling.asArray(),this._postMultiplyPivotMatrix?e.pivotMatrix=this.getPivotMatrix().asArray():e.localMatrix=this.getPivotMatrix().asArray(),e.isEnabled=this.isEnabled(!1),e.isVisible=this.isVisible,e.infiniteDistance=this.infiniteDistance,e.pickable=this.isPickable,e.receiveShadows=this.receiveShadows,e.billboardMode=this.billboardMode,e.visibility=this.visibility,e.alwaysSelectAsActiveMesh=this.alwaysSelectAsActiveMesh,e.checkCollisions=this.checkCollisions,e.ellipsoid=this.ellipsoid.asArray(),e.ellipsoidOffset=this.ellipsoidOffset.asArray(),e.doNotSyncBoundingInfo=this.doNotSyncBoundingInfo,e.isBlocker=this.isBlocker,e.sideOrientation=this.sideOrientation,this.parent&&this.parent._serializeAsParent(e),e.isUnIndexed=this.isUnIndexed;const t=this._geometry;if(t&&this.subMeshes){e.geometryUniqueId=t.uniqueId,e.geometryId=t.id,e.subMeshes=[];for(let i=0;i<this.subMeshes.length;i++){const r=this.subMeshes[i];e.subMeshes.push({materialIndex:r.materialIndex,verticesStart:r.verticesStart,verticesCount:r.verticesCount,indexStart:r.indexStart,indexCount:r.indexCount})}}if(this.material?this.material.doNotSerialize||(e.materialUniqueId=this.material.uniqueId,e.materialId=this.material.id):(this.material=null,e.materialUniqueId=this._scene.defaultMaterial.uniqueId,e.materialId=this._scene.defaultMaterial.id),this.morphTargetManager&&(e.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(e.skeletonId=this.skeleton.id,e.numBoneInfluencers=this.numBoneInfluencers),this.getScene()._getComponent(Ae.NAME_PHYSICSENGINE)){const i=this.getPhysicsImpostor();i&&(e.physicsMass=i.getParam("mass"),e.physicsFriction=i.getParam("friction"),e.physicsRestitution=i.getParam("mass"),e.physicsImpostor=i.type)}this.metadata&&(e.metadata=this.metadata),e.instances=[];for(let i=0;i<this.instances.length;i++){const r=this.instances[i];if(r.doNotSerialize)continue;const s={name:r.name,id:r.id,isEnabled:r.isEnabled(!1),isVisible:r.isVisible,isPickable:r.isPickable,checkCollisions:r.checkCollisions,position:r.position.asArray(),scaling:r.scaling.asArray()};if(r.parent&&r.parent._serializeAsParent(s),r.rotationQuaternion?s.rotationQuaternion=r.rotationQuaternion.asArray():r.rotation&&(s.rotation=r.rotation.asArray()),this.getScene()._getComponent(Ae.NAME_PHYSICSENGINE)){const n=r.getPhysicsImpostor();n&&(s.physicsMass=n.getParam("mass"),s.physicsFriction=n.getParam("friction"),s.physicsRestitution=n.getParam("mass"),s.physicsImpostor=n.type)}r.metadata&&(s.metadata=r.metadata),r.actionManager&&(s.actions=r.actionManager.serialize(r.name)),e.instances.push(s),ye.AppendSerializedAnimations(r,s),s.ranges=r.serializeAnimationRanges()}if(this._thinInstanceDataStorage.instancesCount&&this._thinInstanceDataStorage.matrixData&&(e.thinInstances={instancesCount:this._thinInstanceDataStorage.instancesCount,matrixData:Array.from(this._thinInstanceDataStorage.matrixData),matrixBufferSize:this._thinInstanceDataStorage.matrixBufferSize,enablePicking:this.thinInstanceEnablePicking},this._userThinInstanceBuffersStorage)){const i={data:{},sizes:{},strides:{}};for(const r in this._userThinInstanceBuffersStorage.data)i.data[r]=Array.from(this._userThinInstanceBuffersStorage.data[r]),i.sizes[r]=this._userThinInstanceBuffersStorage.sizes[r],i.strides[r]=this._userThinInstanceBuffersStorage.strides[r];e.thinInstances.userThinInstance=i}return ye.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.layerMask=this.layerMask,e.alphaIndex=this.alphaIndex,e.hasVertexAlpha=this.hasVertexAlpha,e.overlayAlpha=this.overlayAlpha,e.overlayColor=this.overlayColor.asArray(),e.renderOverlay=this.renderOverlay,e.applyFog=this.applyFog,this.actionManager&&(e.actions=this.actionManager.serialize(this.name)),e}_syncGeometryWithMorphTargetManager(){if(!this.geometry)return;this._markSubMeshesAsAttributesDirty();const e=this._internalAbstractMeshDataInfo._morphTargetManager;if(e&&e.vertexCount){if(e.vertexCount!==this.getTotalVertices()){B.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count."),this.morphTargetManager=null;return}if(e.isUsingTextureForTargets)return;for(let t=0;t<e.numInfluencers;t++){const i=e.getActiveTarget(t),r=i.getPositions();if(!r){B.Error("Invalid morph target. Target must have positions.");return}this.geometry.setVerticesData(x.PositionKind+t,r,!1,3);const s=i.getNormals();s&&this.geometry.setVerticesData(x.NormalKind+t,s,!1,3);const n=i.getTangents();n&&this.geometry.setVerticesData(x.TangentKind+t,n,!1,3);const o=i.getUVs();o&&this.geometry.setVerticesData(x.UVKind+"_"+t,o,!1,2);const l=i.getUV2s();l&&this.geometry.setVerticesData(x.UV2Kind+"_"+t,l,!1,2);const c=i.getColors();c&&this.geometry.setVerticesData(x.ColorKind+t,c,!1,4)}}else{let t=0;for(;this.geometry.isVerticesDataPresent(x.PositionKind+t);)this.geometry.removeVerticesData(x.PositionKind+t),this.geometry.isVerticesDataPresent(x.NormalKind+t)&&this.geometry.removeVerticesData(x.NormalKind+t),this.geometry.isVerticesDataPresent(x.TangentKind+t)&&this.geometry.removeVerticesData(x.TangentKind+t),this.geometry.isVerticesDataPresent(x.UVKind+t)&&this.geometry.removeVerticesData(x.UVKind+"_"+t),this.geometry.isVerticesDataPresent(x.UV2Kind+t)&&this.geometry.removeVerticesData(x.UV2Kind+"_"+t),this.geometry.isVerticesDataPresent(x.ColorKind+t)&&this.geometry.removeVerticesData(x.ColorKind+t),t++}}static Parse(e,t,i){let r;if(e.type&&e.type==="LinesMesh"?r=N._LinesMeshParser(e,t):e.type&&e.type==="GroundMesh"?r=N._GroundMeshParser(e,t):e.type&&e.type==="GoldbergMesh"?r=N._GoldbergMeshParser(e,t):e.type&&e.type==="GreasedLineMesh"?r=N._GreasedLineMeshParser(e,t):e.type&&e.type==="TrailMesh"?r=N._TrailMeshParser(e,t):r=new N(e.name,t),r.id=e.id,r._waitingParsedUniqueId=e.uniqueId,qe&&qe.AddTagsTo(r,e.tags),r.position=m.FromArray(e.position),e.metadata!==void 0&&(r.metadata=e.metadata),e.rotationQuaternion?r.rotationQuaternion=z.FromArray(e.rotationQuaternion):e.rotation&&(r.rotation=m.FromArray(e.rotation)),r.scaling=m.FromArray(e.scaling),e.localMatrix?r.setPreTransformMatrix(P.FromArray(e.localMatrix)):e.pivotMatrix&&r.setPivotMatrix(P.FromArray(e.pivotMatrix)),r.setEnabled(e.isEnabled),r.isVisible=e.isVisible,r.infiniteDistance=e.infiniteDistance,r.alwaysSelectAsActiveMesh=!!e.alwaysSelectAsActiveMesh,r.showBoundingBox=e.showBoundingBox,r.showSubMeshesBoundingBox=e.showSubMeshesBoundingBox,e.applyFog!==void 0&&(r.applyFog=e.applyFog),e.pickable!==void 0&&(r.isPickable=e.pickable),e.alphaIndex!==void 0&&(r.alphaIndex=e.alphaIndex),r.receiveShadows=e.receiveShadows,e.billboardMode!==void 0&&(r.billboardMode=e.billboardMode),e.visibility!==void 0&&(r.visibility=e.visibility),r.checkCollisions=e.checkCollisions,r.doNotSyncBoundingInfo=!!e.doNotSyncBoundingInfo,e.ellipsoid&&(r.ellipsoid=m.FromArray(e.ellipsoid)),e.ellipsoidOffset&&(r.ellipsoidOffset=m.FromArray(e.ellipsoidOffset)),e.overrideMaterialSideOrientation!=null&&(r.sideOrientation=e.overrideMaterialSideOrientation),e.sideOrientation!==void 0&&(r.sideOrientation=e.sideOrientation),e.isBlocker!==void 0&&(r.isBlocker=e.isBlocker),r._shouldGenerateFlatShading=e.useFlatShading,e.freezeWorldMatrix&&(r._waitingData.freezeWorldMatrix=e.freezeWorldMatrix),e.parentId!==void 0&&(r._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),e.actions!==void 0&&(r._waitingData.actions=e.actions),e.overlayAlpha!==void 0&&(r.overlayAlpha=e.overlayAlpha),e.overlayColor!==void 0&&(r.overlayColor=ae.FromArray(e.overlayColor)),e.renderOverlay!==void 0&&(r.renderOverlay=e.renderOverlay),r.isUnIndexed=!!e.isUnIndexed,r.hasVertexAlpha=e.hasVertexAlpha,e.delayLoadingFile?(r.delayLoadState=4,r.delayLoadingFile=i+e.delayLoadingFile,r.buildBoundingInfo(m.FromArray(e.boundingBoxMinimum),m.FromArray(e.boundingBoxMaximum)),e._binaryInfo&&(r._binaryInfo=e._binaryInfo),r._delayInfo=[],e.hasUVs&&r._delayInfo.push(x.UVKind),e.hasUVs2&&r._delayInfo.push(x.UV2Kind),e.hasUVs3&&r._delayInfo.push(x.UV3Kind),e.hasUVs4&&r._delayInfo.push(x.UV4Kind),e.hasUVs5&&r._delayInfo.push(x.UV5Kind),e.hasUVs6&&r._delayInfo.push(x.UV6Kind),e.hasColors&&r._delayInfo.push(x.ColorKind),e.hasMatricesIndices&&r._delayInfo.push(x.MatricesIndicesKind),e.hasMatricesWeights&&r._delayInfo.push(x.MatricesWeightsKind),r._delayLoadingFunction=ri._ImportGeometry,Bt.ForceFullSceneLoadingForIncremental&&r._checkDelayState()):ri._ImportGeometry(e,r),e.materialUniqueId?r._waitingMaterialId=e.materialUniqueId:e.materialId&&(r._waitingMaterialId=e.materialId),e.morphTargetManagerId>-1&&(r._waitingMorphTargetManagerId=e.morphTargetManagerId),e.skeletonId!==void 0&&e.skeletonId!==null&&(r.skeleton=t.getLastSkeletonById(e.skeletonId),e.numBoneInfluencers&&(r.numBoneInfluencers=e.numBoneInfluencers)),e.animations){for(let s=0;s<e.animations.length;s++){const n=e.animations[s],o=Ui("BABYLON.Animation");o&&r.animations.push(o.Parse(n))}gt.ParseAnimationRanges(r,e,t)}if(e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.layerMask&&!isNaN(e.layerMask)?r.layerMask=Math.abs(parseInt(e.layerMask)):r.layerMask=268435455,e.physicsImpostor&&(r.physicsImpostor=N._PhysicsImpostorParser(t,r,e)),e.lodMeshIds&&(r._waitingData.lods={ids:e.lodMeshIds,distances:e.lodDistances?e.lodDistances:null,coverages:e.lodCoverages?e.lodCoverages:null}),e.instances)for(let s=0;s<e.instances.length;s++){const n=e.instances[s],o=r.createInstance(n.name);if(n.id&&(o.id=n.id),qe&&(n.tags?qe.AddTagsTo(o,n.tags):qe.AddTagsTo(o,e.tags)),o.position=m.FromArray(n.position),n.metadata!==void 0&&(o.metadata=n.metadata),n.parentId!==void 0&&(o._waitingParentId=n.parentId),n.parentInstanceIndex!==void 0&&(o._waitingParentInstanceIndex=n.parentInstanceIndex),n.isEnabled!==void 0&&n.isEnabled!==null&&o.setEnabled(n.isEnabled),n.isVisible!==void 0&&n.isVisible!==null&&(o.isVisible=n.isVisible),n.isPickable!==void 0&&n.isPickable!==null&&(o.isPickable=n.isPickable),n.rotationQuaternion?o.rotationQuaternion=z.FromArray(n.rotationQuaternion):n.rotation&&(o.rotation=m.FromArray(n.rotation)),o.scaling=m.FromArray(n.scaling),n.checkCollisions!=null&&n.checkCollisions!=null&&(o.checkCollisions=n.checkCollisions),n.pickable!=null&&n.pickable!=null&&(o.isPickable=n.pickable),n.showBoundingBox!=null&&n.showBoundingBox!=null&&(o.showBoundingBox=n.showBoundingBox),n.showSubMeshesBoundingBox!=null&&n.showSubMeshesBoundingBox!=null&&(o.showSubMeshesBoundingBox=n.showSubMeshesBoundingBox),n.alphaIndex!=null&&n.showSubMeshesBoundingBox!=null&&(o.alphaIndex=n.alphaIndex),n.physicsImpostor&&(o.physicsImpostor=N._PhysicsImpostorParser(t,o,n)),n.actions!==void 0&&(o._waitingData.actions=n.actions),n.animations){for(let l=0;l<n.animations.length;l++){const c=n.animations[l],h=Ui("BABYLON.Animation");h&&o.animations.push(h.Parse(c))}gt.ParseAnimationRanges(o,n,t),n.autoAnimate&&t.beginAnimation(o,n.autoAnimateFrom,n.autoAnimateTo,n.autoAnimateLoop,n.autoAnimateSpeed||1)}}if(e.thinInstances){const s=e.thinInstances;if(r.thinInstanceEnablePicking=!!s.enablePicking,s.matrixData?(r.thinInstanceSetBuffer("matrix",new Float32Array(s.matrixData),16,!1),r._thinInstanceDataStorage.matrixBufferSize=s.matrixBufferSize,r._thinInstanceDataStorage.instancesCount=s.instancesCount):r._thinInstanceDataStorage.matrixBufferSize=s.matrixBufferSize,e.thinInstances.userThinInstance){const n=e.thinInstances.userThinInstance;for(const o in n.data)r.thinInstanceSetBuffer(o,new Float32Array(n.data[o]),n.strides[o],!1),r._userThinInstanceBuffersStorage.sizes[o]=n.sizes[o]}}return r}setPositionsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourcePositions){const t=this.getVerticesData(x.PositionKind);if(!t)return e._sourcePositions;e._sourcePositions=new Float32Array(t),this.isVertexBufferUpdatable(x.PositionKind)||this.setVerticesData(x.PositionKind,t,!0)}return e._sourcePositions}setNormalsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourceNormals){const t=this.getVerticesData(x.NormalKind);if(!t)return e._sourceNormals;e._sourceNormals=new Float32Array(t),this.isVertexBufferUpdatable(x.NormalKind)||this.setVerticesData(x.NormalKind,t,!0)}return e._sourceNormals}applySkeleton(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId==this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(x.PositionKind))return this;if(!this.isVerticesDataPresent(x.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(x.MatricesWeightsKind))return this;const t=this.isVerticesDataPresent(x.NormalKind),i=this._internalMeshDataInfo;if(!i._sourcePositions){const E=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=E}t&&!i._sourceNormals&&this.setNormalsForCPUSkinning();let r=this.getVerticesData(x.PositionKind);if(!r)return this;r instanceof Float32Array||(r=new Float32Array(r));let s=this.getVerticesData(x.NormalKind);if(t){if(!s)return this;s instanceof Float32Array||(s=new Float32Array(s))}const n=this.getVerticesData(x.MatricesIndicesKind),o=this.getVerticesData(x.MatricesWeightsKind);if(!o||!n)return this;const l=this.numBoneInfluencers>4,c=l?this.getVerticesData(x.MatricesIndicesExtraKind):null,h=l?this.getVerticesData(x.MatricesWeightsExtraKind):null,f=e.getTransformMatrices(this),u=m.Zero(),d=new P,_=new P;let p=0,g;for(let E=0;E<r.length;E+=3,p+=4){let v;for(g=0;g<4;g++)v=o[p+g],v>0&&(P.FromFloat32ArrayToRefScaled(f,Math.floor(n[p+g]*16),v,_),d.addToSelf(_));if(l)for(g=0;g<4;g++)v=h[p+g],v>0&&(P.FromFloat32ArrayToRefScaled(f,Math.floor(c[p+g]*16),v,_),d.addToSelf(_));m.TransformCoordinatesFromFloatsToRef(i._sourcePositions[E],i._sourcePositions[E+1],i._sourcePositions[E+2],d,u),u.toArray(r,E),t&&(m.TransformNormalFromFloatsToRef(i._sourceNormals[E],i._sourceNormals[E+1],i._sourceNormals[E+2],d,u),u.toArray(s,E)),d.reset()}return this.updateVerticesData(x.PositionKind,r),t&&this.updateVerticesData(x.NormalKind,s),this}static MinMax(e){let t=null,i=null;return e.forEach(function(r){const n=r.getBoundingInfo().boundingBox;!t||!i?(t=n.minimumWorld,i=n.maximumWorld):(t.minimizeInPlace(n.minimumWorld),i.maximizeInPlace(n.maximumWorld))}),!t||!i?{min:m.Zero(),max:m.Zero()}:{min:t,max:i}}static Center(e){const t=e instanceof Array?N.MinMax(e):e;return m.Center(t.min,t.max)}static MergeMeshes(e,t=!0,i,r,s,n){return Uc(N._MergeMeshesCoroutine(e,t,i,r,s,n,!1))}static MergeMeshesAsync(e,t=!0,i,r,s,n){return aC(N._MergeMeshesCoroutine(e,t,i,r,s,n,!0),nC())}static*_MergeMeshesCoroutine(e,t=!0,i,r,s,n,o){if(e=e.filter(Boolean),e.length===0)return null;let l;if(!i){let I=0;for(l=0;l<e.length;l++)if(I+=e[l].getTotalVertices(),I>=65536)return B.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),null}n&&(s=!1);const c=new Array,h=new Array,f=new Array,u=e[0].sideOrientation;for(l=0;l<e.length;l++){const I=e[l];if(I.isAnInstance)return B.Warn("Cannot merge instance meshes."),null;if(u!==I.sideOrientation)return B.Warn("Cannot merge meshes with different sideOrientation values."),null;if(s&&f.push(I.getTotalIndices()),n)if(I.material){const O=I.material;if(O instanceof Js){for(let L=0;L<O.subMaterials.length;L++)c.indexOf(O.subMaterials[L])<0&&c.push(O.subMaterials[L]);for(let L=0;L<I.subMeshes.length;L++)h.push(c.indexOf(O.subMaterials[I.subMeshes[L].materialIndex])),f.push(I.subMeshes[L].indexCount)}else{c.indexOf(O)<0&&c.push(O);for(let L=0;L<I.subMeshes.length;L++)h.push(c.indexOf(O)),f.push(I.subMeshes[L].indexCount)}}else for(let O=0;O<I.subMeshes.length;O++)h.push(0),f.push(I.subMeshes[O].indexCount)}const d=e[0],_=I=>{const O=I.computeWorldMatrix(!0);return{vertexData:ee.ExtractFromMesh(I,!1,!1),transform:O}},{vertexData:p,transform:g}=_(d);o&&(yield);const E=new Array(e.length-1);for(let I=1;I<e.length;I++)E[I-1]=_(e[I]),o&&(yield);const v=p._mergeCoroutine(g,E,i,o,!t);let b=v.next();for(;!b.done;)o&&(yield),b=v.next();const R=b.value;r||(r=new N(d.name+"_merged",d.getScene()));const S=R._applyToCoroutine(r,void 0,o);let T=S.next();for(;!T.done;)o&&(yield),T=S.next();if(r.checkCollisions=d.checkCollisions,r.sideOrientation=d.sideOrientation,t)for(l=0;l<e.length;l++)e[l].dispose();if(s||n){r.releaseSubMeshes(),l=0;let I=0;for(;l<f.length;)Ei.CreateFromIndices(0,I,f[l],r,void 0,!1),I+=f[l],l++;for(const O of r.subMeshes)O.refreshBoundingInfo();r.computeWorldMatrix(!0)}if(n){const I=new Js(d.name+"_merged",d.getScene());I.subMaterials=c;for(let O=0;O<r.subMeshes.length;O++)r.subMeshes[O].materialIndex=h[O];r.material=I}else r.material=d.material;return r}addInstance(e){e._indexInSourceMeshInstanceArray=this.instances.length,this.instances.push(e)}removeInstance(e){const t=e._indexInSourceMeshInstanceArray;if(t!=-1){if(t!==this.instances.length-1){const i=this.instances[this.instances.length-1];this.instances[t]=i,i._indexInSourceMeshInstanceArray=t}e._indexInSourceMeshInstanceArray=-1,this.instances.pop()}}_shouldConvertRHS(){return this._scene.useRightHandedSystem&&this.sideOrientation===q.CounterClockWiseSideOrientation}_getRenderingFillMode(e){const t=this.getScene();return t.forcePointsCloud?q.PointFillMode:t.forceWireframe?q.WireFrameFillMode:this.overrideRenderingFillMode??e}setMaterialByID(e){return this.setMaterialById(e)}static CreateRibbon(e,t,i,r,s,n,o,l,c){throw new Error("Import MeshBuilder to populate this function")}static CreateDisc(e,t,i,r,s,n){throw new Error("Import MeshBuilder to populate this function")}static CreateBox(e,t,i,r,s){throw new Error("Import MeshBuilder to populate this function")}static CreateSphere(e,t,i,r,s,n){throw new Error("Import MeshBuilder to populate this function")}static CreateHemisphere(e,t,i,r){throw new Error("Import MeshBuilder to populate this function")}static CreateCylinder(e,t,i,r,s,n,o,l,c){throw new Error("Import MeshBuilder to populate this function")}static CreateTorus(e,t,i,r,s,n,o){throw new Error("Import MeshBuilder to populate this function")}static CreateTorusKnot(e,t,i,r,s,n,o,l,c,h){throw new Error("Import MeshBuilder to populate this function")}static CreateLines(e,t,i,r,s){throw new Error("Import MeshBuilder to populate this function")}static CreateDashedLines(e,t,i,r,s,n,o,l){throw new Error("Import MeshBuilder to populate this function")}static CreatePolygon(e,t,i,r,s,n,o){throw new Error("Import MeshBuilder to populate this function")}static ExtrudePolygon(e,t,i,r,s,n,o,l){throw new Error("Import MeshBuilder to populate this function")}static ExtrudeShape(e,t,i,r,s,n,o,l,c,h){throw new Error("Import MeshBuilder to populate this function")}static ExtrudeShapeCustom(e,t,i,r,s,n,o,l,c,h,f,u){throw new Error("Import MeshBuilder to populate this function")}static CreateLathe(e,t,i,r,s,n,o){throw new Error("Import MeshBuilder to populate this function")}static CreatePlane(e,t,i,r,s){throw new Error("Import MeshBuilder to populate this function")}static CreateGround(e,t,i,r,s,n){throw new Error("Import MeshBuilder to populate this function")}static CreateTiledGround(e,t,i,r,s,n,o,l,c){throw new Error("Import MeshBuilder to populate this function")}static CreateGroundFromHeightMap(e,t,i,r,s,n,o,l,c,h,f){throw new Error("Import MeshBuilder to populate this function")}static CreateTube(e,t,i,r,s,n,o,l,c,h){throw new Error("Import MeshBuilder to populate this function")}static CreatePolyhedron(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static CreateIcoSphere(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static CreateDecal(e,t,i,r,s,n){throw new Error("Import MeshBuilder to populate this function")}static CreateCapsule(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static ExtendToGoldberg(e){throw new Error("Import MeshBuilder to populate this function")}}N.FRONTSIDE=ee.FRONTSIDE;N.BACKSIDE=ee.BACKSIDE;N.DOUBLESIDE=ee.DOUBLESIDE;N.DEFAULTSIDE=ee.DEFAULTSIDE;N.NO_CAP=0;N.CAP_START=1;N.CAP_END=2;N.CAP_ALL=3;N.NO_FLIP=0;N.FLIP_TILE=1;N.ROTATE_TILE=2;N.FLIP_ROW=3;N.ROTATE_ROW=4;N.FLIP_N_ROTATE_TILE=5;N.FLIP_N_ROTATE_ROW=6;N.CENTER=0;N.LEFT=1;N.RIGHT=2;N.TOP=3;N.BOTTOM=4;N.INSTANCEDMESH_SORT_TRANSPARENT=!1;N._GroundMeshParser=(a,e)=>{throw Le("GroundMesh")};N._GoldbergMeshParser=(a,e)=>{throw Le("GoldbergMesh")};N._LinesMeshParser=(a,e)=>{throw Le("LinesMesh")};N._GreasedLineMeshParser=(a,e)=>{throw Le("GreasedLineMesh")};N._GreasedLineRibbonMeshParser=(a,e)=>{throw Le("GreasedLineRibbonMesh")};N._TrailMeshParser=(a,e)=>{throw Le("TrailMesh")};Y("BABYLON.Mesh",N);class EC{constructor(){this._zoomStopsAnimation=!1,this._idleRotationSpeed=.05,this._idleRotationWaitTime=2e3,this._idleRotationSpinupTime=2e3,this.targetAlpha=null,this._isPointerDown=!1,this._lastFrameTime=null,this._lastInteractionTime=-1/0,this._cameraRotationSpeed=0,this._lastFrameRadius=0}get name(){return"AutoRotation"}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set idleRotationSpeed(e){this._idleRotationSpeed=e}get idleRotationSpeed(){return this._idleRotationSpeed}set idleRotationWaitTime(e){this._idleRotationWaitTime=e}get idleRotationWaitTime(){return this._idleRotationWaitTime}set idleRotationSpinupTime(e){this._idleRotationSpinupTime=e}get idleRotationSpinupTime(){return this._idleRotationSpinupTime}get rotationInProgress(){return Math.abs(this._cameraRotationSpeed)>0}init(){}attach(e){this._attachedCamera=e;const t=this._attachedCamera.getScene();this._onPrePointerObservableObserver=t.onPrePointerObservable.add(i=>{if(i.type===ge.POINTERDOWN){this._isPointerDown=!0;return}i.type===ge.POINTERUP&&(this._isPointerDown=!1)}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{if(this._reachTargetAlpha())return;const i=Ti.Now;let r=0;this._lastFrameTime!=null&&(r=i-this._lastFrameTime),this._lastFrameTime=i,this._applyUserInteraction();const s=i-this._lastInteractionTime-this._idleRotationWaitTime,n=Math.max(Math.min(s/this._idleRotationSpinupTime,1),0);this._cameraRotationSpeed=this._idleRotationSpeed*n,this._attachedCamera&&(this._attachedCamera.alpha-=this._cameraRotationSpeed*(r/1e3))})}detach(){if(!this._attachedCamera)return;const e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._attachedCamera=null,this._lastFrameTime=null}resetLastInteractionTime(e){this._lastInteractionTime=e??Ti.Now}_reachTargetAlpha(){return this._attachedCamera&&this.targetAlpha?Math.abs(this._attachedCamera.alpha-this.targetAlpha)<Ke:!1}_userIsZooming(){return this._attachedCamera?this._attachedCamera.inertialRadiusOffset!==0:!1}_shouldAnimationStopForInteraction(){if(!this._attachedCamera)return!1;let e=!1;return this._lastFrameRadius===this._attachedCamera.radius&&this._attachedCamera.inertialRadiusOffset!==0&&(e=!0),this._lastFrameRadius=this._attachedCamera.radius,this._zoomStopsAnimation?e:this._userIsZooming()}_applyUserInteraction(){this._userIsMoving()&&!this._shouldAnimationStopForInteraction()&&(this._lastInteractionTime=Ti.Now)}_userIsMoving(){return this._attachedCamera?this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown:!1}}class kt{constructor(){this._easingMode=kt.EASINGMODE_EASEIN}setEasingMode(e){const t=Math.min(Math.max(e,0),2);this._easingMode=t}getEasingMode(){return this._easingMode}easeInCore(e){throw new Error("You must implement this method")}ease(e){switch(this._easingMode){case kt.EASINGMODE_EASEIN:return this.easeInCore(e);case kt.EASINGMODE_EASEOUT:return 1-this.easeInCore(1-e)}return e>=.5?(1-this.easeInCore((1-e)*2))*.5+.5:this.easeInCore(e*2)*.5}}kt.EASINGMODE_EASEIN=0;kt.EASINGMODE_EASEOUT=1;kt.EASINGMODE_EASEINOUT=2;class jm extends kt{easeInCore(e){return e=Math.max(0,Math.min(1,e)),1-Math.sqrt(1-e*e)}}class Zm extends kt{constructor(e=1){super(),this.amplitude=e}easeInCore(e){const t=Math.max(0,this.amplitude);return Math.pow(e,3)-e*t*Math.sin(3.141592653589793*e)}}class vC extends kt{constructor(e=3,t=2){super(),this.bounces=e,this.bounciness=t}easeInCore(e){const t=Math.max(0,this.bounces);let i=this.bounciness;i<=1&&(i=1.001);const r=Math.pow(i,t),s=1-i,n=(1-r)/s+r*.5,o=e*n,l=Math.log(-o*(1-i)+1)/Math.log(i),c=Math.floor(l),h=c+1,f=(1-Math.pow(i,c))/(s*n),u=(1-Math.pow(i,h))/(s*n),d=(f+u)*.5,_=e-d,p=d-f;return-Math.pow(1/i,t-c)/(p*p)*(_-p)*(_+p)}}class TC extends kt{easeInCore(e){return e*e*e}}class SC extends kt{constructor(e=3,t=3){super(),this.oscillations=e,this.springiness=t}easeInCore(e){let t;const i=Math.max(0,this.oscillations),r=Math.max(0,this.springiness);return r==0?t=e:t=(Math.exp(r*e)-1)/(Math.exp(r)-1),t*Math.sin((6.283185307179586*i+1.5707963267948966)*e)}}class Qm extends kt{constructor(e=2){super(),this.exponent=e}easeInCore(e){return this.exponent<=0?e:(Math.exp(this.exponent*e)-1)/(Math.exp(this.exponent)-1)}}class AC extends kt{easeInCore(e){return e*e}}class $m extends kt{easeInCore(e){return 1-Math.sin(1.5707963267948966*(1-e))}}class Jm extends kt{constructor(e=0,t=0,i=1,r=1){super(),this.x1=e,this.y1=t,this.x2=i,this.y2=r}easeInCore(e){return BR.Interpolate(e,this.x1,this.y1,this.x2,this.y2)}}class en{constructor(e,t,i){this.name=e,this.from=t,this.to=i}clone(){return new en(this.name,this.from,this.to)}}const eg=Object.freeze(new z(0,0,0,0)),tg=Object.freeze(m.Zero()),ig=Object.freeze(ne.Zero()),rg=Object.freeze(Ni.Zero()),sg=Object.freeze(ae.Black()),ng=Object.freeze(new Ne(0,0,0,0)),$i={key:0,repeatCount:0,loopMode:2};class W{static _PrepareAnimation(e,t,i,r,s,n,o,l){let c;if(!isNaN(parseFloat(s))&&isFinite(s)?c=W.ANIMATIONTYPE_FLOAT:s instanceof z?c=W.ANIMATIONTYPE_QUATERNION:s instanceof m?c=W.ANIMATIONTYPE_VECTOR3:s instanceof ne?c=W.ANIMATIONTYPE_VECTOR2:s instanceof ae?c=W.ANIMATIONTYPE_COLOR3:s instanceof Ne?c=W.ANIMATIONTYPE_COLOR4:s instanceof Ni&&(c=W.ANIMATIONTYPE_SIZE),c==null)return null;const h=new W(e,t,i,c,o),f=[{frame:0,value:s},{frame:r,value:n}];return h.setKeys(f),l!==void 0&&h.setEasingFunction(l),h}static CreateAnimation(e,t,i,r){const s=new W(e+"Animation",e,i,t,W.ANIMATIONLOOPMODE_CONSTANT);return s.setEasingFunction(r),s}static CreateAndStartAnimation(e,t,i,r,s,n,o,l,c,h,f){const u=W._PrepareAnimation(e,i,r,s,n,o,l,c);return!u||(t.getScene&&(f=t.getScene()),!f)?null:f.beginDirectAnimation(t,[u],0,s,u.loopMode!==W.ANIMATIONLOOPMODE_CONSTANT,1,h)}static CreateAndStartHierarchyAnimation(e,t,i,r,s,n,o,l,c,h,f){const u=W._PrepareAnimation(e,r,s,n,o,l,c,h);return u?t.getScene().beginDirectHierarchyAnimation(t,i,[u],0,n,u.loopMode===1,1,f):null}static CreateMergeAndStartAnimation(e,t,i,r,s,n,o,l,c,h){const f=W._PrepareAnimation(e,i,r,s,n,o,l,c);return f?(t.animations.push(f),t.getScene().beginAnimation(t,0,s,f.loopMode===1,1,h)):null}static MakeAnimationAdditive(e,t,i,r=!1,s){let n;typeof t=="object"?n=t:n={referenceFrame:t??0,range:i,cloneOriginalAnimation:r,clonedAnimationName:s};let o=e;if(n.cloneOriginalAnimation&&(o=e.clone(),o.name=n.clonedAnimationName||o.name),!o._keys.length)return o;const l=n.referenceFrame&&n.referenceFrame>=0?n.referenceFrame:0;let c=0;const h=o._keys[0];let f=o._keys.length-1;const u=o._keys[f],d={referenceValue:h.value,referencePosition:F.Vector3[0],referenceQuaternion:F.Quaternion[0],referenceScaling:F.Vector3[1],keyPosition:F.Vector3[2],keyQuaternion:F.Quaternion[1],keyScaling:F.Vector3[3]};let _=h.frame,p=u.frame;if(n.range){const v=o.getRange(n.range);v&&(_=v.from,p=v.to)}else _=n.fromFrame??_,p=n.toFrame??p;if(_!==h.frame&&(c=o.createKeyForFrame(_)),p!==u.frame&&(f=o.createKeyForFrame(p)),o._keys.length===1){const v=o._getKeyValue(o._keys[0]);d.referenceValue=v.clone?v.clone():v}else if(l<=h.frame){const v=o._getKeyValue(h.value);d.referenceValue=v.clone?v.clone():v}else if(l>=u.frame){const v=o._getKeyValue(u.value);d.referenceValue=v.clone?v.clone():v}else{$i.key=0;const v=o._interpolate(l,$i);d.referenceValue=v.clone?v.clone():v}o.dataType===W.ANIMATIONTYPE_QUATERNION?d.referenceValue.normalize().conjugateInPlace():o.dataType===W.ANIMATIONTYPE_MATRIX&&(d.referenceValue.decompose(d.referenceScaling,d.referenceQuaternion,d.referencePosition),d.referenceQuaternion.normalize().conjugateInPlace());let g=Number.MAX_VALUE;const E=n.clipKeys?[]:null;for(let v=c;v<=f;v++){let b=o._keys[v];if((E||n.cloneOriginalAnimation)&&(b={frame:b.frame,value:b.value.clone?b.value.clone():b.value,inTangent:b.inTangent,outTangent:b.outTangent,interpolation:b.interpolation,lockedTangent:b.lockedTangent},E&&(g===Number.MAX_VALUE&&(g=b.frame),b.frame-=g,E.push(b))),!(v&&o.dataType!==W.ANIMATIONTYPE_FLOAT&&b.value===h.value))switch(o.dataType){case W.ANIMATIONTYPE_MATRIX:b.value.decompose(d.keyScaling,d.keyQuaternion,d.keyPosition),d.keyPosition.subtractInPlace(d.referencePosition),d.keyScaling.divideInPlace(d.referenceScaling),d.referenceQuaternion.multiplyToRef(d.keyQuaternion,d.keyQuaternion),P.ComposeToRef(d.keyScaling,d.keyQuaternion,d.keyPosition,b.value);break;case W.ANIMATIONTYPE_QUATERNION:d.referenceValue.multiplyToRef(b.value,b.value);break;case W.ANIMATIONTYPE_VECTOR2:case W.ANIMATIONTYPE_VECTOR3:case W.ANIMATIONTYPE_COLOR3:case W.ANIMATIONTYPE_COLOR4:b.value.subtractToRef(d.referenceValue,b.value);break;case W.ANIMATIONTYPE_SIZE:b.value.width-=d.referenceValue.width,b.value.height-=d.referenceValue.height;break;default:b.value-=d.referenceValue}}return E&&o.setKeys(E,!0),o}static TransitionTo(e,t,i,r,s,n,o,l=null){if(o<=0)return i[e]=t,l&&l(),null;const c=s*(o/1e3);n.setKeys([{frame:0,value:i[e].clone?i[e].clone():i[e]},{frame:c,value:t}]),i.animations||(i.animations=[]),i.animations.push(n);const h=r.beginAnimation(i,0,c,!1);return h.onAnimationEnd=l,h}get runtimeAnimations(){return this._runtimeAnimations}get hasRunningRuntimeAnimations(){for(const e of this._runtimeAnimations)if(!e.isStopped())return!0;return!1}constructor(e,t,i,r,s,n){this.name=e,this.targetProperty=t,this.framePerSecond=i,this.dataType=r,this.loopMode=s,this.enableBlending=n,this._easingFunction=null,this._runtimeAnimations=new Array,this._events=new Array,this.blendingSpeed=.01,this._ranges={},this.targetPropertyPath=t.split("."),this.dataType=r,this.loopMode=s===void 0?W.ANIMATIONLOOPMODE_CYCLE:s,this.uniqueId=W._UniqueIdGenerator++}toString(e){let t="Name: "+this.name+", property: "+this.targetProperty;if(t+=", datatype: "+["Float","Vector3","Quaternion","Matrix","Color3","Vector2"][this.dataType],t+=", nKeys: "+(this._keys?this._keys.length:"none"),t+=", nRanges: "+(this._ranges?Object.keys(this._ranges).length:"none"),e){t+=", Ranges: {";let i=!0;for(const r in this._ranges)i&&(t+=", ",i=!1),t+=r;t+="}"}return t}addEvent(e){this._events.push(e),this._events.sort((t,i)=>t.frame-i.frame)}removeEvents(e){for(let t=0;t<this._events.length;t++)this._events[t].frame===e&&(this._events.splice(t,1),t--)}getEvents(){return this._events}createRange(e,t,i){this._ranges[e]||(this._ranges[e]=new en(e,t,i))}deleteRange(e,t=!0){const i=this._ranges[e];if(i){if(t){const r=i.from,s=i.to;for(let n=this._keys.length-1;n>=0;n--)this._keys[n].frame>=r&&this._keys[n].frame<=s&&this._keys.splice(n,1)}this._ranges[e]=null}}getRange(e){return this._ranges[e]}getKeys(){return this._keys}getHighestFrame(){let e=0;for(let t=0,i=this._keys.length;t<i;t++)e<this._keys[t].frame&&(e=this._keys[t].frame);return e}getEasingFunction(){return this._easingFunction}setEasingFunction(e){this._easingFunction=e}floatInterpolateFunction(e,t,i){return Qr(e,t,i)}floatInterpolateFunctionWithTangents(e,t,i,r,s){return Rm(e,t,i,r,s)}quaternionInterpolateFunction(e,t,i){return z.Slerp(e,t,i)}quaternionInterpolateFunctionWithTangents(e,t,i,r,s){return z.Hermite(e,t,i,r,s).normalize()}vector3InterpolateFunction(e,t,i){return m.Lerp(e,t,i)}vector3InterpolateFunctionWithTangents(e,t,i,r,s){return m.Hermite(e,t,i,r,s)}vector2InterpolateFunction(e,t,i){return ne.Lerp(e,t,i)}vector2InterpolateFunctionWithTangents(e,t,i,r,s){return ne.Hermite(e,t,i,r,s)}sizeInterpolateFunction(e,t,i){return Ni.Lerp(e,t,i)}color3InterpolateFunction(e,t,i){return ae.Lerp(e,t,i)}color3InterpolateFunctionWithTangents(e,t,i,r,s){return ae.Hermite(e,t,i,r,s)}color4InterpolateFunction(e,t,i){return Ne.Lerp(e,t,i)}color4InterpolateFunctionWithTangents(e,t,i,r,s){return Ne.Hermite(e,t,i,r,s)}_getKeyValue(e){return typeof e=="function"?e():e}evaluate(e){return $i.key=0,this._interpolate(e,$i)}_interpolate(e,t,i=!1){if(t.loopMode===W.ANIMATIONLOOPMODE_CONSTANT&&t.repeatCount>0)return t.highLimitValue.clone?t.highLimitValue.clone():t.highLimitValue;const r=this._keys,s=r.length;let n=t.key;for(;n>=0&&e<r[n].frame;)--n;for(;n+1<=s-1&&e>=r[n+1].frame;)++n;if(t.key=n,n<0)return i?void 0:this._getKeyValue(r[0].value);if(n+1>s-1)return i?void 0:this._getKeyValue(r[s-1].value);const o=r[n],l=r[n+1];if(i&&(e===o.frame||e===l.frame))return;const c=this._getKeyValue(o.value),h=this._getKeyValue(l.value);if(o.interpolation===1)return l.frame>e?c:h;const f=o.outTangent!==void 0&&l.inTangent!==void 0,u=l.frame-o.frame;let d=(e-o.frame)/u;const _=o.easingFunction||this.getEasingFunction();switch(_&&(d=_.ease(d)),this.dataType){case W.ANIMATIONTYPE_FLOAT:{const p=f?this.floatInterpolateFunctionWithTangents(c,o.outTangent*u,h,l.inTangent*u,d):this.floatInterpolateFunction(c,h,d);switch(t.loopMode){case W.ANIMATIONLOOPMODE_CYCLE:case W.ANIMATIONLOOPMODE_CONSTANT:case W.ANIMATIONLOOPMODE_YOYO:return p;case W.ANIMATIONLOOPMODE_RELATIVE:case W.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return(t.offsetValue??0)*t.repeatCount+p}break}case W.ANIMATIONTYPE_QUATERNION:{const p=f?this.quaternionInterpolateFunctionWithTangents(c,o.outTangent.scale(u),h,l.inTangent.scale(u),d):this.quaternionInterpolateFunction(c,h,d);switch(t.loopMode){case W.ANIMATIONLOOPMODE_CYCLE:case W.ANIMATIONLOOPMODE_CONSTANT:case W.ANIMATIONLOOPMODE_YOYO:return p;case W.ANIMATIONLOOPMODE_RELATIVE:case W.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return p.addInPlace((t.offsetValue||eg).scale(t.repeatCount))}return p}case W.ANIMATIONTYPE_VECTOR3:{const p=f?this.vector3InterpolateFunctionWithTangents(c,o.outTangent.scale(u),h,l.inTangent.scale(u),d):this.vector3InterpolateFunction(c,h,d);switch(t.loopMode){case W.ANIMATIONLOOPMODE_CYCLE:case W.ANIMATIONLOOPMODE_CONSTANT:case W.ANIMATIONLOOPMODE_YOYO:return p;case W.ANIMATIONLOOPMODE_RELATIVE:case W.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return p.add((t.offsetValue||tg).scale(t.repeatCount))}break}case W.ANIMATIONTYPE_VECTOR2:{const p=f?this.vector2InterpolateFunctionWithTangents(c,o.outTangent.scale(u),h,l.inTangent.scale(u),d):this.vector2InterpolateFunction(c,h,d);switch(t.loopMode){case W.ANIMATIONLOOPMODE_CYCLE:case W.ANIMATIONLOOPMODE_CONSTANT:case W.ANIMATIONLOOPMODE_YOYO:return p;case W.ANIMATIONLOOPMODE_RELATIVE:case W.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return p.add((t.offsetValue||ig).scale(t.repeatCount))}break}case W.ANIMATIONTYPE_SIZE:{switch(t.loopMode){case W.ANIMATIONLOOPMODE_CYCLE:case W.ANIMATIONLOOPMODE_CONSTANT:case W.ANIMATIONLOOPMODE_YOYO:return this.sizeInterpolateFunction(c,h,d);case W.ANIMATIONLOOPMODE_RELATIVE:case W.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return this.sizeInterpolateFunction(c,h,d).add((t.offsetValue||rg).scale(t.repeatCount))}break}case W.ANIMATIONTYPE_COLOR3:{const p=f?this.color3InterpolateFunctionWithTangents(c,o.outTangent.scale(u),h,l.inTangent.scale(u),d):this.color3InterpolateFunction(c,h,d);switch(t.loopMode){case W.ANIMATIONLOOPMODE_CYCLE:case W.ANIMATIONLOOPMODE_CONSTANT:case W.ANIMATIONLOOPMODE_YOYO:return p;case W.ANIMATIONLOOPMODE_RELATIVE:case W.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return p.add((t.offsetValue||sg).scale(t.repeatCount))}break}case W.ANIMATIONTYPE_COLOR4:{const p=f?this.color4InterpolateFunctionWithTangents(c,o.outTangent.scale(u),h,l.inTangent.scale(u),d):this.color4InterpolateFunction(c,h,d);switch(t.loopMode){case W.ANIMATIONLOOPMODE_CYCLE:case W.ANIMATIONLOOPMODE_CONSTANT:case W.ANIMATIONLOOPMODE_YOYO:return p;case W.ANIMATIONLOOPMODE_RELATIVE:case W.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return p.add((t.offsetValue||ng).scale(t.repeatCount))}break}case W.ANIMATIONTYPE_MATRIX:{switch(t.loopMode){case W.ANIMATIONLOOPMODE_CYCLE:case W.ANIMATIONLOOPMODE_CONSTANT:case W.ANIMATIONLOOPMODE_YOYO:return W.AllowMatricesInterpolation?this.matrixInterpolateFunction(c,h,d,t.workValue):c;case W.ANIMATIONLOOPMODE_RELATIVE:case W.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return c}break}}return 0}matrixInterpolateFunction(e,t,i,r){return W.AllowMatrixDecomposeForInterpolation?r?(P.DecomposeLerpToRef(e,t,i,r),r):P.DecomposeLerp(e,t,i):r?(P.LerpToRef(e,t,i,r),r):P.Lerp(e,t,i)}clone(){const e=new W(this.name,this.targetPropertyPath.join("."),this.framePerSecond,this.dataType,this.loopMode);if(e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,this._keys&&e.setKeys(this._keys),this._ranges){e._ranges={};for(const t in this._ranges){const i=this._ranges[t];i&&(e._ranges[t]=i.clone())}}return e}setKeys(e,t=!1){this._keys=t?e:e.slice(0)}createKeyForFrame(e){$i.key=0;const t=this._interpolate(e,$i,!0);if(!t)return this._keys[$i.key].frame===e?$i.key:$i.key+1;const i={frame:e,value:t.clone?t.clone():t};return this._keys.splice($i.key+1,0,i),$i.key+1}serialize(){const e={};e.name=this.name,e.property=this.targetProperty,e.framePerSecond=this.framePerSecond,e.dataType=this.dataType,e.loopBehavior=this.loopMode,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed;const t=this.dataType;e.keys=[];const i=this.getKeys();for(let r=0;r<i.length;r++){const s=i[r],n={};switch(n.frame=s.frame,t){case W.ANIMATIONTYPE_FLOAT:n.values=[s.value],s.inTangent!==void 0&&n.values.push(s.inTangent),s.outTangent!==void 0&&(s.inTangent===void 0&&n.values.push(void 0),n.values.push(s.outTangent)),s.interpolation!==void 0&&(s.inTangent===void 0&&n.values.push(void 0),s.outTangent===void 0&&n.values.push(void 0),n.values.push(s.interpolation));break;case W.ANIMATIONTYPE_QUATERNION:case W.ANIMATIONTYPE_MATRIX:case W.ANIMATIONTYPE_VECTOR3:case W.ANIMATIONTYPE_COLOR3:case W.ANIMATIONTYPE_COLOR4:n.values=s.value.asArray(),s.inTangent!=null&&n.values.push(s.inTangent.asArray()),s.outTangent!=null&&(s.inTangent===void 0&&n.values.push(void 0),n.values.push(s.outTangent.asArray())),s.interpolation!==void 0&&(s.inTangent===void 0&&n.values.push(void 0),s.outTangent===void 0&&n.values.push(void 0),n.values.push(s.interpolation));break}e.keys.push(n)}e.ranges=[];for(const r in this._ranges){const s=this._ranges[r];if(!s)continue;const n={};n.name=r,n.from=s.from,n.to=s.to,e.ranges.push(n)}return e}static _UniversalLerp(e,t,i){const r=e.constructor;return r.Lerp?r.Lerp(e,t,i):r.Slerp?r.Slerp(e,t,i):e.toFixed?e*(1-i)+i*t:t}static Parse(e){const t=new W(e.name,e.property,e.framePerSecond,e.dataType,e.loopBehavior),i=e.dataType,r=[];let s,n;for(e.enableBlending&&(t.enableBlending=e.enableBlending),e.blendingSpeed&&(t.blendingSpeed=e.blendingSpeed),n=0;n<e.keys.length;n++){const o=e.keys[n];let l,c,h;switch(i){case W.ANIMATIONTYPE_FLOAT:s=o.values[0],o.values.length>=2&&(l=o.values[1]),o.values.length>=3&&(c=o.values[2]),o.values.length>=4&&(h=o.values[3]);break;case W.ANIMATIONTYPE_QUATERNION:if(s=z.FromArray(o.values),o.values.length>=8){const u=z.FromArray(o.values.slice(4,8));u.equals(z.Zero())||(l=u)}if(o.values.length>=12){const u=z.FromArray(o.values.slice(8,12));u.equals(z.Zero())||(c=u)}o.values.length>=13&&(h=o.values[12]);break;case W.ANIMATIONTYPE_MATRIX:s=P.FromArray(o.values),o.values.length>=17&&(h=o.values[16]);break;case W.ANIMATIONTYPE_COLOR3:s=ae.FromArray(o.values),o.values[3]&&(l=ae.FromArray(o.values[3])),o.values[4]&&(c=ae.FromArray(o.values[4])),o.values[5]&&(h=o.values[5]);break;case W.ANIMATIONTYPE_COLOR4:s=Ne.FromArray(o.values),o.values[4]&&(l=Ne.FromArray(o.values[4])),o.values[5]&&(c=Ne.FromArray(o.values[5])),o.values[6]&&(h=Ne.FromArray(o.values[6]));break;case W.ANIMATIONTYPE_VECTOR3:default:s=m.FromArray(o.values),o.values[3]&&(l=m.FromArray(o.values[3])),o.values[4]&&(c=m.FromArray(o.values[4])),o.values[5]&&(h=o.values[5]);break}const f={};f.frame=o.frame,f.value=s,l!=null&&(f.inTangent=l),c!=null&&(f.outTangent=c),h!=null&&(f.interpolation=h),r.push(f)}if(t.setKeys(r),e.ranges)for(n=0;n<e.ranges.length;n++)s=e.ranges[n],t.createRange(s.name,s.from,s.to);return t}static AppendSerializedAnimations(e,t){ye.AppendSerializedAnimations(e,t)}static ParseFromFileAsync(e,t){return new Promise((i,r)=>{const s=new Gt;s.addEventListener("readystatechange",()=>{if(s.readyState==4)if(s.status==200){let n=JSON.parse(s.responseText);if(n.animations&&(n=n.animations),n.length){const o=[];for(const l of n)o.push(this.Parse(l));i(o)}else{const o=this.Parse(n);e&&(o.name=e),i(o)}}else r("Unable to load the animation")}),s.open("GET",t),s.send()})}static ParseFromSnippetAsync(e){return new Promise((t,i)=>{const r=new Gt;r.addEventListener("readystatechange",()=>{if(r.readyState==4)if(r.status==200){const s=JSON.parse(JSON.parse(r.responseText).jsonPayload);if(s.animations){const n=JSON.parse(s.animations),o=[];for(const l of n.animations){const c=this.Parse(l);c.snippetId=e,o.push(c)}t(o)}else{const n=JSON.parse(s.animation),o=this.Parse(n);o.snippetId=e,t(o)}}else i("Unable to load the snippet "+e)}),r.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),r.send()})}}W._UniqueIdGenerator=0;W.AllowMatricesInterpolation=!1;W.AllowMatrixDecomposeForInterpolation=!0;W.SnippetUrl="https://snippet.babylonjs.com";W.ANIMATIONTYPE_FLOAT=0;W.ANIMATIONTYPE_VECTOR3=1;W.ANIMATIONTYPE_QUATERNION=2;W.ANIMATIONTYPE_MATRIX=3;W.ANIMATIONTYPE_COLOR3=4;W.ANIMATIONTYPE_COLOR4=7;W.ANIMATIONTYPE_VECTOR2=5;W.ANIMATIONTYPE_SIZE=6;W.ANIMATIONLOOPMODE_RELATIVE=0;W.ANIMATIONLOOPMODE_CYCLE=1;W.ANIMATIONLOOPMODE_CONSTANT=2;W.ANIMATIONLOOPMODE_YOYO=4;W.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT=5;W.CreateFromSnippetAsync=W.ParseFromSnippetAsync;Y("BABYLON.Animation",W);gt._AnimationRangeFactory=(a,e,t)=>new en(a,e,t);class Es{constructor(){this.transitionDuration=450,this.lowerRadiusTransitionRange=2,this.upperRadiusTransitionRange=-2,this._autoTransitionRange=!1,this._radiusIsAnimating=!1,this._radiusBounceTransition=null,this._animatables=new Array}get name(){return"Bouncing"}get autoTransitionRange(){return this._autoTransitionRange}set autoTransitionRange(e){if(this._autoTransitionRange===e)return;this._autoTransitionRange=e;const t=this._attachedCamera;t&&(e?this._onMeshTargetChangedObserver=t.onMeshTargetChangedObservable.add(i=>{if(i&&(i.computeWorldMatrix(!0),i.getBoundingInfo)){const r=i.getBoundingInfo().diagonalLength;this.lowerRadiusTransitionRange=r*.05,this.upperRadiusTransitionRange=r*.05}}):this._onMeshTargetChangedObserver&&t.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver))}init(){}attach(e){this._attachedCamera=e,this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{this._attachedCamera&&(this._isRadiusAtLimit(this._attachedCamera.lowerRadiusLimit)&&this._applyBoundRadiusAnimation(this.lowerRadiusTransitionRange),this._isRadiusAtLimit(this._attachedCamera.upperRadiusLimit)&&this._applyBoundRadiusAnimation(this.upperRadiusTransitionRange))})}detach(){this._attachedCamera&&(this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null)}_isRadiusAtLimit(e){return this._attachedCamera?this._attachedCamera.radius===e&&!this._radiusIsAnimating:!1}_applyBoundRadiusAnimation(e){if(!this._attachedCamera)return;this._radiusBounceTransition||(Es.EasingFunction.setEasingMode(Es.EasingMode),this._radiusBounceTransition=W.CreateAnimation("radius",W.ANIMATIONTYPE_FLOAT,60,Es.EasingFunction)),this._cachedWheelPrecision=this._attachedCamera.wheelPrecision,this._attachedCamera.wheelPrecision=1/0,this._attachedCamera.inertialRadiusOffset=0,this.stopAllAnimations(),this._radiusIsAnimating=!0;const t=W.TransitionTo("radius",this._attachedCamera.radius+e,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusBounceTransition,this.transitionDuration,()=>this._clearAnimationLocks());t&&this._animatables.push(t)}_clearAnimationLocks(){this._radiusIsAnimating=!1,this._attachedCamera&&(this._attachedCamera.wheelPrecision=this._cachedWheelPrecision)}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0].onAnimationEnd=null,this._animatables[0].stop(),this._animatables.shift()}}Es.EasingFunction=new Zm(.3);Es.EasingMode=kt.EASINGMODE_EASEOUT;class mi{constructor(){this.onTargetFramingAnimationEndObservable=new U,this._mode=mi.FitFrustumSidesMode,this._radiusScale=1,this._positionScale=.5,this._defaultElevation=.3,this._elevationReturnTime=1500,this._elevationReturnWaitTime=1e3,this._zoomStopsAnimation=!1,this._framingTime=1500,this.autoCorrectCameraLimitsAndSensibility=!0,this._isPointerDown=!1,this._lastInteractionTime=-1/0,this._animatables=new Array,this._betaIsAnimating=!1}get name(){return"Framing"}set mode(e){this._mode=e}get mode(){return this._mode}set radiusScale(e){this._radiusScale=e}get radiusScale(){return this._radiusScale}set positionScale(e){this._positionScale=e}get positionScale(){return this._positionScale}set defaultElevation(e){this._defaultElevation=e}get defaultElevation(){return this._defaultElevation}set elevationReturnTime(e){this._elevationReturnTime=e}get elevationReturnTime(){return this._elevationReturnTime}set elevationReturnWaitTime(e){this._elevationReturnWaitTime=e}get elevationReturnWaitTime(){return this._elevationReturnWaitTime}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set framingTime(e){this._framingTime=e}get framingTime(){return this._framingTime}init(){}attach(e){this._attachedCamera=e;const t=this._attachedCamera.getScene();mi.EasingFunction.setEasingMode(mi.EasingMode),this._onPrePointerObservableObserver=t.onPrePointerObservable.add(i=>{if(i.type===ge.POINTERDOWN){this._isPointerDown=!0;return}i.type===ge.POINTERUP&&(this._isPointerDown=!1)}),this._onMeshTargetChangedObserver=e.onMeshTargetChangedObservable.add(i=>{i&&i.getBoundingInfo&&this.zoomOnMesh(i,void 0,()=>{this.onTargetFramingAnimationEndObservable.notifyObservers()})}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{this._applyUserInteraction(),this._maintainCameraAboveGround()})}detach(){if(!this._attachedCamera)return;const e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null}zoomOnMesh(e,t=!1,i=null){e.computeWorldMatrix(!0);const r=e.getBoundingInfo().boundingBox;this.zoomOnBoundingInfo(r.minimumWorld,r.maximumWorld,t,i)}zoomOnMeshHierarchy(e,t=!1,i=null){e.computeWorldMatrix(!0);const r=e.getHierarchyBoundingVectors(!0);this.zoomOnBoundingInfo(r.min,r.max,t,i)}zoomOnMeshesHierarchy(e,t=!1,i=null){const r=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),s=new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(let n=0;n<e.length;n++){const o=e[n].getHierarchyBoundingVectors(!0);m.CheckExtends(o.min,r,s),m.CheckExtends(o.max,r,s)}this.zoomOnBoundingInfo(r,s,t,i)}zoomOnBoundingInfo(e,t,i=!1,r=null){let s;if(!this._attachedCamera)return!1;const n=e.y,o=t.y,l=n+(o-n)*this._positionScale,c=t.subtract(e).scale(.5);if(!isFinite(l))return!1;if(i)s=new m(0,l,0);else{const u=e.add(c);s=new m(u.x,l,u.z)}this._vectorTransition||(this._vectorTransition=W.CreateAnimation("target",W.ANIMATIONTYPE_VECTOR3,60,mi.EasingFunction)),this._betaIsAnimating=!0;let h=W.TransitionTo("target",s,this._attachedCamera,this._attachedCamera.getScene(),60,this._vectorTransition,this._framingTime);h&&this._animatables.push(h);let f=0;if(this._mode===mi.FitFrustumSidesMode){const u=this._calculateLowerRadiusFromModelBoundingSphere(e,t);this.autoCorrectCameraLimitsAndSensibility&&(this._attachedCamera.lowerRadiusLimit=c.length()+this._attachedCamera.minZ),f=u}else this._mode===mi.IgnoreBoundsSizeMode&&(f=this._calculateLowerRadiusFromModelBoundingSphere(e,t),this.autoCorrectCameraLimitsAndSensibility&&this._attachedCamera.lowerRadiusLimit===null&&(this._attachedCamera.lowerRadiusLimit=this._attachedCamera.minZ));if(this.autoCorrectCameraLimitsAndSensibility){const u=t.subtract(e).length();this._attachedCamera.panningSensibility=5e3/u,this._attachedCamera.wheelPrecision=100/f}return this._radiusTransition||(this._radiusTransition=W.CreateAnimation("radius",W.ANIMATIONTYPE_FLOAT,60,mi.EasingFunction)),h=W.TransitionTo("radius",f,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusTransition,this._framingTime,()=>{this.stopAllAnimations(),r&&r(),this._attachedCamera&&this._attachedCamera.useInputToRestoreState&&this._attachedCamera.storeState()}),h&&this._animatables.push(h),!0}_calculateLowerRadiusFromModelBoundingSphere(e,t){const i=this._attachedCamera;if(!i)return 0;let r=i._calculateLowerRadiusFromModelBoundingSphere(e,t,this._radiusScale);return i.lowerRadiusLimit&&this._mode===mi.IgnoreBoundsSizeMode&&(r=r<i.lowerRadiusLimit?i.lowerRadiusLimit:r),i.upperRadiusLimit&&(r=r>i.upperRadiusLimit?i.upperRadiusLimit:r),r}_maintainCameraAboveGround(){if(this._elevationReturnTime<0)return;const e=Ti.Now-this._lastInteractionTime,t=Math.PI*.5-this._defaultElevation,i=Math.PI*.5;if(this._attachedCamera&&!this._betaIsAnimating&&this._attachedCamera.beta>i&&e>=this._elevationReturnWaitTime){this._betaIsAnimating=!0,this.stopAllAnimations(),this._betaTransition||(this._betaTransition=W.CreateAnimation("beta",W.ANIMATIONTYPE_FLOAT,60,mi.EasingFunction));const r=W.TransitionTo("beta",t,this._attachedCamera,this._attachedCamera.getScene(),60,this._betaTransition,this._elevationReturnTime,()=>{this._clearAnimationLocks(),this.stopAllAnimations()});r&&this._animatables.push(r)}}_clearAnimationLocks(){this._betaIsAnimating=!1}_applyUserInteraction(){this.isUserIsMoving&&(this._lastInteractionTime=Ti.Now,this.stopAllAnimations(),this._clearAnimationLocks())}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0]&&(this._animatables[0].onAnimationEnd=null,this._animatables[0].stop()),this._animatables.shift()}get isUserIsMoving(){return this._attachedCamera?this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown:!1}}mi.EasingFunction=new Qm;mi.EasingMode=kt.EASINGMODE_EASEINOUT;mi.IgnoreBoundsSizeMode=0;mi.FitFrustumSidesMode=1;gt.AddNodeConstructor("TargetCamera",(a,e)=>()=>new Dt(a,m.Zero(),e));class Dt extends Ce{constructor(e,t,i,r=!0){super(e,t,i,r),this._tmpUpVector=m.Zero(),this._tmpTargetVector=m.Zero(),this.cameraDirection=new m(0,0,0),this.cameraRotation=new ne(0,0),this.ignoreParentScaling=!1,this.updateUpVectorFromRotation=!1,this._tmpQuaternion=new z,this.rotation=new m(0,0,0),this.speed=2,this.noRotationConstraint=!1,this.invertRotation=!1,this.inverseRotationSpeed=.2,this.lockedTarget=null,this._currentTarget=m.Zero(),this._initialFocalDistance=1,this._viewMatrix=P.Zero(),this._camMatrix=P.Zero(),this._cameraTransformMatrix=P.Zero(),this._cameraRotationMatrix=P.Zero(),this._referencePoint=new m(0,0,1),this._transformedReferencePoint=m.Zero(),this._deferredPositionUpdate=new m,this._deferredRotationQuaternionUpdate=new z,this._deferredRotationUpdate=new m,this._deferredUpdated=!1,this._deferOnly=!1,this._defaultUp=m.Up(),this._cachedRotationZ=0,this._cachedQuaternionRotationZ=0}getFrontPosition(e){this.getWorldMatrix();const t=F.Vector3[0],i=F.Vector3[1];return i.set(0,0,this._scene.useRightHandedSystem?-1:1),this.getDirectionToRef(i,t),t.scaleInPlace(e),this.globalPosition.add(t)}_getLockedTargetPosition(){if(!this.lockedTarget)return null;if(this.lockedTarget.absolutePosition){const e=this.lockedTarget;e.computeWorldMatrix().getTranslationToRef(e.absolutePosition)}return this.lockedTarget.absolutePosition||this.lockedTarget}storeState(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this.rotationQuaternion&&(this._storedRotationQuaternion=this.rotationQuaternion.clone()),super.storeState()}_restoreStateValues(){return super._restoreStateValues()?(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.rotationQuaternion&&(this.rotationQuaternion=this._storedRotationQuaternion.clone()),this.cameraDirection.copyFromFloats(0,0,0),this.cameraRotation.copyFromFloats(0,0),!0):!1}_initCache(){super._initCache(),this._cache.lockedTarget=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotationQuaternion=new z(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)}_updateCache(e){e||super._updateCache();const t=this._getLockedTargetPosition();t?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(t):this._cache.lockedTarget=t.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation),this.rotationQuaternion&&this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)}_isSynchronizedViewMatrix(){if(!super._isSynchronizedViewMatrix())return!1;const e=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(e):!e)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))}_computeLocalCameraSpeed(){const e=this.getEngine();return this.speed*Math.sqrt(e.getDeltaTime()/(e.getFps()*100))}setTarget(e){this.upVector.normalize(),this._initialFocalDistance=e.subtract(this.position).length(),this.position.z===e.z&&(this.position.z+=Ke),this._referencePoint.normalize().scaleInPlace(this._initialFocalDistance),P.LookAtLHToRef(this.position,e,this._defaultUp,this._camMatrix),this._camMatrix.invert(),this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);const t=e.subtract(this.position);t.x>=0?this.rotation.y=-Math.atan(t.z/t.x)+Math.PI/2:this.rotation.y=-Math.atan(t.z/t.x)-Math.PI/2,this.rotation.z=0,isNaN(this.rotation.x)&&(this.rotation.x=0),isNaN(this.rotation.y)&&(this.rotation.y=0),isNaN(this.rotation.z)&&(this.rotation.z=0),this.rotationQuaternion&&z.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)}get target(){return this.getTarget()}set target(e){this.setTarget(e)}getTarget(){return this._currentTarget}_decideIfNeedsToMove(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){if(this.parent){this.parent.getWorldMatrix().invertToRef(F.Matrix[0]),m.TransformNormalToRef(this.cameraDirection,F.Matrix[0],F.Vector3[0]),this._deferredPositionUpdate.addInPlace(F.Vector3[0]),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate);return}this._deferredPositionUpdate.addInPlace(this.cameraDirection),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate)}_checkInputs(){const e=this.invertRotation?-this.inverseRotationSpeed:1,t=this._decideIfNeedsToMove(),i=this.cameraRotation.x||this.cameraRotation.y;this._deferredUpdated=!1,this._deferredRotationUpdate.copyFrom(this.rotation),this._deferredPositionUpdate.copyFrom(this.position),this.rotationQuaternion&&this._deferredRotationQuaternionUpdate.copyFrom(this.rotationQuaternion),t&&this._updatePosition(),i&&(this.rotationQuaternion&&this.rotationQuaternion.toEulerAnglesToRef(this._deferredRotationUpdate),this._deferredRotationUpdate.x+=this.cameraRotation.x*e,this._deferredRotationUpdate.y+=this.cameraRotation.y*e,this.noRotationConstraint||(this._deferredRotationUpdate.x>1.570796&&(this._deferredRotationUpdate.x=1.570796),this._deferredRotationUpdate.x<-1.570796&&(this._deferredRotationUpdate.x=-1.570796)),this._deferOnly?this._deferredUpdated=!0:this.rotation.copyFrom(this._deferredRotationUpdate),this.rotationQuaternion&&this._deferredRotationUpdate.lengthSquared()&&(z.RotationYawPitchRollToRef(this._deferredRotationUpdate.y,this._deferredRotationUpdate.x,this._deferredRotationUpdate.z,this._deferredRotationQuaternionUpdate),this._deferOnly?this._deferredUpdated=!0:this.rotationQuaternion.copyFrom(this._deferredRotationQuaternionUpdate))),t&&(Math.abs(this.cameraDirection.x)<this.speed*Ke&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<this.speed*Ke&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<this.speed*Ke&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),i&&(Math.abs(this.cameraRotation.x)<this.speed*Ke&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<this.speed*Ke&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia)),super._checkInputs()}_updateCameraRotationMatrix(){this.rotationQuaternion?this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix):P.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix)}_rotateUpVectorWithCameraRotationMatrix(){return m.TransformNormalToRef(this._defaultUp,this._cameraRotationMatrix,this.upVector),this}_getViewMatrix(){return this.lockedTarget&&this.setTarget(this._getLockedTargetPosition()),this._updateCameraRotationMatrix(),this.rotationQuaternion&&this._cachedQuaternionRotationZ!=this.rotationQuaternion.z?(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedQuaternionRotationZ=this.rotationQuaternion.z):this._cachedRotationZ!==this.rotation.z&&(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedRotationZ=this.rotation.z),m.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),this.updateUpVectorFromRotation&&(this.rotationQuaternion?Vi.Y.rotateByQuaternionToRef(this.rotationQuaternion,this.upVector):(z.FromEulerVectorToRef(this.rotation,this._tmpQuaternion),Vi.Y.rotateByQuaternionToRef(this._tmpQuaternion,this.upVector))),this._computeViewMatrix(this.position,this._currentTarget,this.upVector),this._viewMatrix}_computeViewMatrix(e,t,i){if(this.ignoreParentScaling){if(this.parent){const r=this.parent.getWorldMatrix();m.TransformCoordinatesToRef(e,r,this._globalPosition),m.TransformCoordinatesToRef(t,r,this._tmpTargetVector),m.TransformNormalToRef(i,r,this._tmpUpVector),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e),this._tmpTargetVector.copyFrom(t),this._tmpUpVector.copyFrom(i);this.getScene().useRightHandedSystem?P.LookAtRHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix):P.LookAtLHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix);return}if(this.getScene().useRightHandedSystem?P.LookAtRHToRef(e,t,i,this._viewMatrix):P.LookAtLHToRef(e,t,i,this._viewMatrix),this.parent){const r=this.parent.getWorldMatrix();this._viewMatrix.invert(),this._viewMatrix.multiplyToRef(r,this._viewMatrix),this._viewMatrix.getTranslationToRef(this._globalPosition),this._viewMatrix.invert(),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e)}createRigCamera(e,t){if(this.cameraRigMode!==Ce.RIG_MODE_NONE){const i=new Dt(e,this.position.clone(),this.getScene());return i.isRigCamera=!0,i.rigParent=this,this.cameraRigMode===Ce.RIG_MODE_VR&&(this.rotationQuaternion||(this.rotationQuaternion=new z),i._cameraRigParams={},i.rotationQuaternion=new z),i.mode=this.mode,i.orthoLeft=this.orthoLeft,i.orthoRight=this.orthoRight,i.orthoTop=this.orthoTop,i.orthoBottom=this.orthoBottom,i}return null}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];switch(this.computeWorldMatrix(),this.cameraRigMode){case Ce.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Ce.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Ce.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case Ce.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Ce.RIG_MODE_STEREOSCOPIC_INTERLACED:{const i=this.cameraRigMode===Ce.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1,r=this.cameraRigMode===Ce.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*i,e),this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*r,t);break}case Ce.RIG_MODE_VR:e.rotationQuaternion?(e.rotationQuaternion.copyFrom(this.rotationQuaternion),t.rotationQuaternion.copyFrom(this.rotationQuaternion)):(e.rotation.copyFrom(this.rotation),t.rotation.copyFrom(this.rotation)),e.position.copyFrom(this.position),t.position.copyFrom(this.position);break}super._updateRigCameras()}_getRigCamPositionAndTarget(e,t){this.getTarget().subtractToRef(this.position,Dt._TargetFocalPoint),Dt._TargetFocalPoint.normalize().scaleInPlace(this._initialFocalDistance);const r=Dt._TargetFocalPoint.addInPlace(this.position);P.TranslationToRef(-r.x,-r.y,-r.z,Dt._TargetTransformMatrix),Dt._TargetTransformMatrix.multiplyToRef(P.RotationAxis(t.upVector,e),Dt._RigCamTransformMatrix),P.TranslationToRef(r.x,r.y,r.z,Dt._TargetTransformMatrix),Dt._RigCamTransformMatrix.multiplyToRef(Dt._TargetTransformMatrix,Dt._RigCamTransformMatrix),m.TransformCoordinatesToRef(this.position,Dt._RigCamTransformMatrix,t.position),t.setTarget(r)}getClassName(){return"TargetCamera"}}Dt._RigCamTransformMatrix=new P;Dt._TargetTransformMatrix=new P;Dt._TargetFocalPoint=new m;A([y()],Dt.prototype,"ignoreParentScaling",void 0);A([y()],Dt.prototype,"updateUpVectorFromRotation",void 0);A([di()],Dt.prototype,"rotation",void 0);A([y()],Dt.prototype,"speed",void 0);A([ym("lockedTargetId")],Dt.prototype,"lockedTarget",void 0);var Ki={};class ag{constructor(e){this.attachedToElement=!1,this.attached={},this.camera=e,this.checkInputs=()=>{}}add(e){const t=e.getSimpleName();if(this.attached[t]){B.Warn("camera input of type "+t+" already exists on camera");return}this.attached[t]=e,e.camera=this.camera,e.checkInputs&&(this.checkInputs=this._addCheckInputs(e.checkInputs.bind(e))),this.attachedToElement&&e.attachControl(this.noPreventDefault)}remove(e){for(const t in this.attached){const i=this.attached[t];if(i===e){i.detachControl(),i.camera=null,delete this.attached[t],this.rebuildInputCheck();return}}}removeByType(e){for(const t in this.attached){const i=this.attached[t];i.getClassName()===e&&(i.detachControl(),i.camera=null,delete this.attached[t],this.rebuildInputCheck())}}_addCheckInputs(e){const t=this.checkInputs;return()=>{t(),e()}}attachInput(e){this.attachedToElement&&e.attachControl(this.noPreventDefault)}attachElement(e=!1){if(!this.attachedToElement){e=Ce.ForceAttachControlToAlwaysPreventDefault?!1:e,this.attachedToElement=!0,this.noPreventDefault=e;for(const t in this.attached)this.attached[t].attachControl(e)}}detachElement(e=!1){for(const t in this.attached)this.attached[t].detachControl(),e&&(this.attached[t].camera=null);this.attachedToElement=!1}rebuildInputCheck(){this.checkInputs=()=>{};for(const e in this.attached){const t=this.attached[e];t.checkInputs&&(this.checkInputs=this._addCheckInputs(t.checkInputs.bind(t)))}}clear(){this.attachedToElement&&this.detachElement(!0),this.attached={},this.attachedToElement=!1,this.checkInputs=()=>{}}serialize(e){const t={};for(const i in this.attached){const r=this.attached[i],s=ye.Serialize(r);t[r.getClassName()]=s}e.inputsmgr=t}parse(e){const t=e.inputsmgr;if(t){this.clear();for(const i in t){const r=Ki[i];if(r){const s=t[i],n=ye.Parse(()=>new r,s,null);this.add(n)}}}else for(const i in this.attached){const r=Ki[this.attached[i].getClassName()];if(r){const s=ye.Parse(()=>new r,e,null);this.remove(this.attached[i]),this.add(s)}}}}class og{constructor(){this._currentMousePointerIdDown=-1,this.buttons=[0,1,2]}attachControl(e){e=k.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),i=t.getInputElement();let r=0,s=null;this._pointA=null,this._pointB=null,this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._pointerInput=o=>{var f,u;const l=o.event,c=l.pointerType==="touch";if(o.type!==ge.POINTERMOVE&&this.buttons.indexOf(l.button)===-1)return;const h=l.target;if(this._altKey=l.altKey,this._ctrlKey=l.ctrlKey,this._metaKey=l.metaKey,this._shiftKey=l.shiftKey,this._buttonsPressed=l.buttons,t.isPointerLock){const d=l.movementX,_=l.movementY;this.onTouch(null,d,_),this._pointA=null,this._pointB=null}else{if(o.type!==ge.POINTERDOWN&&o.type!==ge.POINTERDOUBLETAP&&c&&((f=this._pointA)==null?void 0:f.pointerId)!==l.pointerId&&((u=this._pointB)==null?void 0:u.pointerId)!==l.pointerId)return;if(o.type===ge.POINTERDOWN&&(this._currentMousePointerIdDown===-1||c)){try{h==null||h.setPointerCapture(l.pointerId)}catch{}if(this._pointA===null)this._pointA={x:l.clientX,y:l.clientY,pointerId:l.pointerId,type:l.pointerType};else if(this._pointB===null)this._pointB={x:l.clientX,y:l.clientY,pointerId:l.pointerId,type:l.pointerType};else return;this._currentMousePointerIdDown===-1&&!c&&(this._currentMousePointerIdDown=l.pointerId),this.onButtonDown(l),e||(l.preventDefault(),i&&i.focus())}else if(o.type===ge.POINTERDOUBLETAP)this.onDoubleTap(l.pointerType);else if(o.type===ge.POINTERUP&&(this._currentMousePointerIdDown===l.pointerId||c)){try{h==null||h.releasePointerCapture(l.pointerId)}catch{}c||(this._pointB=null),t._badOS?this._pointA=this._pointB=null:this._pointB&&this._pointA&&this._pointA.pointerId==l.pointerId?(this._pointA=this._pointB,this._pointB=null):this._pointA&&this._pointB&&this._pointB.pointerId==l.pointerId?this._pointB=null:this._pointA=this._pointB=null,(r!==0||s)&&(this.onMultiTouch(this._pointA,this._pointB,r,0,s,null),r=0,s=null),this._currentMousePointerIdDown=-1,this.onButtonUp(l),e||l.preventDefault()}else if(o.type===ge.POINTERMOVE){if(e||l.preventDefault(),this._pointA&&this._pointB===null){const d=l.clientX-this._pointA.x,_=l.clientY-this._pointA.y;this._pointA.x=l.clientX,this._pointA.y=l.clientY,this.onTouch(this._pointA,d,_)}else if(this._pointA&&this._pointB){const d=this._pointA.pointerId===l.pointerId?this._pointA:this._pointB;d.x=l.clientX,d.y=l.clientY;const _=this._pointA.x-this._pointB.x,p=this._pointA.y-this._pointB.y,g=_*_+p*p,E={x:(this._pointA.x+this._pointB.x)/2,y:(this._pointA.y+this._pointB.y)/2,pointerId:l.pointerId,type:o.type};this.onMultiTouch(this._pointA,this._pointB,r,g,s,E),s=E,r=g}}}},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,ge.POINTERDOWN|ge.POINTERUP|ge.POINTERMOVE|ge.POINTERDOUBLETAP),this._onLostFocus=()=>{this._pointA=this._pointB=null,r=0,s=null,this.onLostFocus()},this._contextMenuBind=o=>this.onContextMenu(o),i&&i.addEventListener("contextmenu",this._contextMenuBind,!1);const n=this.camera.getScene().getEngine().getHostWindow();n&&k.RegisterTopRootEvents(n,[{name:"blur",handler:this._onLostFocus}])}detachControl(){if(this._onLostFocus){const e=this.camera.getScene().getEngine().getHostWindow();e&&k.UnregisterTopRootEvents(e,[{name:"blur",handler:this._onLostFocus}])}if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._contextMenuBind){const e=this.camera.getScene().getEngine().getInputElement();e&&e.removeEventListener("contextmenu",this._contextMenuBind)}this._onLostFocus=null}this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._currentMousePointerIdDown=-1}getClassName(){return"BaseCameraPointersInput"}getSimpleName(){return"pointers"}onDoubleTap(e){}onTouch(e,t,i){}onMultiTouch(e,t,i,r,s,n){}onContextMenu(e){e.preventDefault()}onButtonDown(e){}onButtonUp(e){}onLostFocus(){}}A([y()],og.prototype,"buttons",void 0);class Ri extends og{constructor(){super(...arguments),this.buttons=[0,1,2],this.angularSensibilityX=1e3,this.angularSensibilityY=1e3,this.pinchPrecision=12,this.pinchDeltaPercentage=0,this.useNaturalPinchZoom=!1,this.pinchZoom=!0,this.panningSensibility=1e3,this.multiTouchPanning=!0,this.multiTouchPanAndZoom=!0,this.pinchInwards=!0,this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}getClassName(){return"ArcRotateCameraPointersInput"}_computeMultiTouchPanning(e,t){if(this.panningSensibility!==0&&e&&t){const i=t.x-e.x,r=t.y-e.y;this.camera.inertialPanningX+=-i/this.panningSensibility,this.camera.inertialPanningY+=r/this.panningSensibility}}_computePinchZoom(e,t){const i=this.camera.radius||Ri.MinimumRadiusForPinch;this.useNaturalPinchZoom?this.camera.radius=i*Math.sqrt(e)/Math.sqrt(t):this.pinchDeltaPercentage?this.camera.inertialRadiusOffset+=(t-e)*.001*i*this.pinchDeltaPercentage:this.camera.inertialRadiusOffset+=(t-e)/(this.pinchPrecision*(this.pinchInwards?1:-1)*(this.angularSensibilityX+this.angularSensibilityY)/2)}onTouch(e,t,i){this.panningSensibility!==0&&(this._ctrlKey&&this.camera._useCtrlForPanning||this._isPanClick)?(this.camera.inertialPanningX+=-t/this.panningSensibility,this.camera.inertialPanningY+=i/this.panningSensibility):(this.camera.inertialAlphaOffset-=t/this.angularSensibilityX,this.camera.inertialBetaOffset-=i/this.angularSensibilityY)}onDoubleTap(){this.camera.useInputToRestoreState&&this.camera.restoreState()}onMultiTouch(e,t,i,r,s,n){i===0&&s===null||r===0&&n===null||(this.multiTouchPanAndZoom?(this._computePinchZoom(i,r),this._computeMultiTouchPanning(s,n)):this.multiTouchPanning&&this.pinchZoom?(this._twoFingerActivityCount++,this._isPinching||this._twoFingerActivityCount<20&&Math.abs(Math.sqrt(r)-Math.sqrt(i))>this.camera.pinchToPanMaxDistance?(this._computePinchZoom(i,r),this._isPinching=!0):this._computeMultiTouchPanning(s,n)):this.multiTouchPanning?this._computeMultiTouchPanning(s,n):this.pinchZoom&&this._computePinchZoom(i,r))}onButtonDown(e){this._isPanClick=e.button===this.camera._panningMouseButton}onButtonUp(e){this._twoFingerActivityCount=0,this._isPinching=!1}onLostFocus(){this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}}Ri.MinimumRadiusForPinch=.001;A([y()],Ri.prototype,"buttons",void 0);A([y()],Ri.prototype,"angularSensibilityX",void 0);A([y()],Ri.prototype,"angularSensibilityY",void 0);A([y()],Ri.prototype,"pinchPrecision",void 0);A([y()],Ri.prototype,"pinchDeltaPercentage",void 0);A([y()],Ri.prototype,"useNaturalPinchZoom",void 0);A([y()],Ri.prototype,"pinchZoom",void 0);A([y()],Ri.prototype,"panningSensibility",void 0);A([y()],Ri.prototype,"multiTouchPanning",void 0);A([y()],Ri.prototype,"multiTouchPanAndZoom",void 0);Ki.ArcRotateCameraPointersInput=Ri;class nr{constructor(){this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this.keysReset=[220],this.panningSensibility=50,this.zoomingSensibility=25,this.useAltToZoom=!0,this.angularSpeed=.01,this._keys=new Array}attachControl(e){e=k.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const i=t.event;if(!i.metaKey){if(t.type===Qs.KEYDOWN)this._ctrlPressed=i.ctrlKey,this._altPressed=i.altKey,(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysReset.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),i.preventDefault&&(e||i.preventDefault()));else if(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysReset.indexOf(i.keyCode)!==-1){const r=this._keys.indexOf(i.keyCode);r>=0&&this._keys.splice(r,1),i.preventDefault&&(e||i.preventDefault())}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t];this.keysLeft.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX-=1/this.panningSensibility:e.inertialAlphaOffset-=this.angularSpeed:this.keysUp.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY+=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset+=1/this.zoomingSensibility:e.inertialBetaOffset-=this.angularSpeed:this.keysRight.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX+=1/this.panningSensibility:e.inertialAlphaOffset+=this.angularSpeed:this.keysDown.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY-=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset-=1/this.zoomingSensibility:e.inertialBetaOffset+=this.angularSpeed:this.keysReset.indexOf(i)!==-1&&e.useInputToRestoreState&&e.restoreState()}}}getClassName(){return"ArcRotateCameraKeyboardMoveInput"}getSimpleName(){return"keyboard"}}A([y()],nr.prototype,"keysUp",void 0);A([y()],nr.prototype,"keysDown",void 0);A([y()],nr.prototype,"keysLeft",void 0);A([y()],nr.prototype,"keysRight",void 0);A([y()],nr.prototype,"keysReset",void 0);A([y()],nr.prototype,"panningSensibility",void 0);A([y()],nr.prototype,"zoomingSensibility",void 0);A([y()],nr.prototype,"useAltToZoom",void 0);A([y()],nr.prototype,"angularSpeed",void 0);Ki.ArcRotateCameraKeyboardMoveInput=nr;const RC=40;class kn{constructor(){this.wheelPrecision=3,this.zoomToMouseLocation=!1,this.wheelDeltaPercentage=0,this.customComputeDeltaFromMouseWheel=null,this._viewOffset=new m(0,0,0),this._globalOffset=new m(0,0,0),this._inertialPanning=m.Zero()}_computeDeltaFromMouseWheelLegacyEvent(e,t){let i=0;const r=e*.01*this.wheelDeltaPercentage*t;return e>0?i=r/(1+this.wheelDeltaPercentage):i=r*(1+this.wheelDeltaPercentage),i}attachControl(e){e=k.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==ge.POINTERWHEEL)return;const i=t.event;let r=0;const s=i.deltaMode===sn.DOM_DELTA_LINE?RC:1,n=-(i.deltaY*s);if(this.customComputeDeltaFromMouseWheel)r=this.customComputeDeltaFromMouseWheel(n,this,i);else if(this.wheelDeltaPercentage){if(r=this._computeDeltaFromMouseWheelLegacyEvent(n,this.camera.radius),r>0){let o=this.camera.radius,l=this.camera.inertialRadiusOffset+r;for(let c=0;c<20&&Math.abs(l)>.001;c++)o-=l,l*=this.camera.inertia;o=je(o,0,Number.MAX_VALUE),r=this._computeDeltaFromMouseWheelLegacyEvent(n,o)}}else r=n/(this.wheelPrecision*40);r&&(this.zoomToMouseLocation?(this._hitPlane||this._updateHitPlane(),this._zoomToMouse(r)):this.camera.inertialRadiusOffset+=r),i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,ge.POINTERWHEEL),this.zoomToMouseLocation&&this._inertialPanning.setAll(0)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null)}checkInputs(){if(!this.zoomToMouseLocation)return;const e=this.camera;0+e.inertialAlphaOffset+e.inertialBetaOffset+e.inertialRadiusOffset&&(this._updateHitPlane(),e.target.addInPlace(this._inertialPanning),this._inertialPanning.scaleInPlace(e.inertia),this._zeroIfClose(this._inertialPanning))}getClassName(){return"ArcRotateCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}_updateHitPlane(){const e=this.camera,t=e.target.subtract(e.position);this._hitPlane=hi.FromPositionAndNormal(e.target,t)}_getPosition(){const e=this.camera,t=e.getScene(),i=t.createPickingRay(t.pointerX,t.pointerY,P.Identity(),e,!1);(e.targetScreenOffset.x!==0||e.targetScreenOffset.y!==0)&&(this._viewOffset.set(e.targetScreenOffset.x,e.targetScreenOffset.y,0),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),this._globalOffset=m.TransformNormal(this._viewOffset,e._cameraTransformMatrix),i.origin.addInPlace(this._globalOffset));let r=0;return this._hitPlane&&(r=i.intersectsPlane(this._hitPlane)??0),i.origin.addInPlace(i.direction.scaleInPlace(r))}_zoomToMouse(e){const t=this.camera,i=1-t.inertia;if(t.lowerRadiusLimit){const l=t.lowerRadiusLimit??0;t.radius-(t.inertialRadiusOffset+e)/i<l&&(e=(t.radius-l)*i-t.inertialRadiusOffset)}if(t.upperRadiusLimit){const l=t.upperRadiusLimit??0;t.radius-(t.inertialRadiusOffset+e)/i>l&&(e=(t.radius-l)*i-t.inertialRadiusOffset)}const s=e/i/t.radius,n=this._getPosition(),o=F.Vector3[6];n.subtractToRef(t.target,o),o.scaleInPlace(s),o.scaleInPlace(i),this._inertialPanning.addInPlace(o),t.inertialRadiusOffset+=e}_zeroIfClose(e){Math.abs(e.x)<Ke&&(e.x=0),Math.abs(e.y)<Ke&&(e.y=0),Math.abs(e.z)<Ke&&(e.z=0)}}A([y()],kn.prototype,"wheelPrecision",void 0);A([y()],kn.prototype,"zoomToMouseLocation",void 0);A([y()],kn.prototype,"wheelDeltaPercentage",void 0);Ki.ArcRotateCameraMouseWheelInput=kn;class lg extends ag{constructor(e){super(e)}addMouseWheel(){return this.add(new kn),this}addPointers(){return this.add(new Ri),this}addKeyboard(){return this.add(new nr),this}}gt.AddNodeConstructor("ArcRotateCamera",(a,e)=>()=>new dt(a,0,0,1,m.Zero(),e));function CC(a){let e=Math.PI/2;return a.x===0&&a.z===0||(e=Math.acos(a.x/Math.sqrt(Math.pow(a.x,2)+Math.pow(a.z,2)))),a.z<0&&(e=2*Math.PI-e),e}function IC(a,e){return Math.acos(a/e)}class dt extends Dt{get target(){return this._target}set target(e){this.setTarget(e)}get targetHost(){return this._targetHost}set targetHost(e){e&&this.setTarget(e)}getTarget(){return this.target}get position(){return this._position}set position(e){this.setPosition(e)}set upVector(e){this._upToYMatrix||(this._yToUpMatrix=new P,this._upToYMatrix=new P,this._upVector=m.Zero()),e.normalize(),this._upVector.copyFrom(e),this.setMatUp()}get upVector(){return this._upVector}setMatUp(){P.RotationAlignToRef(m.UpReadOnly,this._upVector,this._yToUpMatrix),P.RotationAlignToRef(this._upVector,m.UpReadOnly,this._upToYMatrix)}get angularSensibilityX(){const e=this.inputs.attached.pointers;return e?e.angularSensibilityX:0}set angularSensibilityX(e){const t=this.inputs.attached.pointers;t&&(t.angularSensibilityX=e)}get angularSensibilityY(){const e=this.inputs.attached.pointers;return e?e.angularSensibilityY:0}set angularSensibilityY(e){const t=this.inputs.attached.pointers;t&&(t.angularSensibilityY=e)}get pinchPrecision(){const e=this.inputs.attached.pointers;return e?e.pinchPrecision:0}set pinchPrecision(e){const t=this.inputs.attached.pointers;t&&(t.pinchPrecision=e)}get pinchDeltaPercentage(){const e=this.inputs.attached.pointers;return e?e.pinchDeltaPercentage:0}set pinchDeltaPercentage(e){const t=this.inputs.attached.pointers;t&&(t.pinchDeltaPercentage=e)}get useNaturalPinchZoom(){const e=this.inputs.attached.pointers;return e?e.useNaturalPinchZoom:!1}set useNaturalPinchZoom(e){const t=this.inputs.attached.pointers;t&&(t.useNaturalPinchZoom=e)}get panningSensibility(){const e=this.inputs.attached.pointers;return e?e.panningSensibility:0}set panningSensibility(e){const t=this.inputs.attached.pointers;t&&(t.panningSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get wheelPrecision(){const e=this.inputs.attached.mousewheel;return e?e.wheelPrecision:0}set wheelPrecision(e){const t=this.inputs.attached.mousewheel;t&&(t.wheelPrecision=e)}get zoomToMouseLocation(){const e=this.inputs.attached.mousewheel;return e?e.zoomToMouseLocation:!1}set zoomToMouseLocation(e){const t=this.inputs.attached.mousewheel;t&&(t.zoomToMouseLocation=e)}get wheelDeltaPercentage(){const e=this.inputs.attached.mousewheel;return e?e.wheelDeltaPercentage:0}set wheelDeltaPercentage(e){const t=this.inputs.attached.mousewheel;t&&(t.wheelDeltaPercentage=e)}get bouncingBehavior(){return this._bouncingBehavior}get useBouncingBehavior(){return this._bouncingBehavior!=null}set useBouncingBehavior(e){e!==this.useBouncingBehavior&&(e?(this._bouncingBehavior=new Es,this.addBehavior(this._bouncingBehavior)):this._bouncingBehavior&&(this.removeBehavior(this._bouncingBehavior),this._bouncingBehavior=null))}get framingBehavior(){return this._framingBehavior}get useFramingBehavior(){return this._framingBehavior!=null}set useFramingBehavior(e){e!==this.useFramingBehavior&&(e?(this._framingBehavior=new mi,this.addBehavior(this._framingBehavior)):this._framingBehavior&&(this.removeBehavior(this._framingBehavior),this._framingBehavior=null))}get autoRotationBehavior(){return this._autoRotationBehavior}get useAutoRotationBehavior(){return this._autoRotationBehavior!=null}set useAutoRotationBehavior(e){e!==this.useAutoRotationBehavior&&(e?(this._autoRotationBehavior=new EC,this.addBehavior(this._autoRotationBehavior)):this._autoRotationBehavior&&(this.removeBehavior(this._autoRotationBehavior),this._autoRotationBehavior=null))}constructor(e,t,i,r,s,n,o=!0){super(e,m.Zero(),n,o),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.lowerAlphaLimit=null,this.upperAlphaLimit=null,this.lowerBetaLimit=.01,this.upperBetaLimit=Math.PI-.01,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.lowerTargetYLimit=-1/0,this.inertialPanningX=0,this.inertialPanningY=0,this.pinchToPanMaxDistance=20,this.panningDistanceLimit=null,this.panningOriginTarget=m.Zero(),this.panningInertia=.9,this.zoomOnFactor=1,this.targetScreenOffset=ne.Zero(),this.allowUpsideDown=!0,this.useInputToRestoreState=!0,this.restoreStateInterpolationFactor=0,this._currentInterpolationFactor=0,this._viewMatrix=new P,this.panningAxis=new m(1,1,0),this._transformedDirection=new m,this.mapPanning=!1,this._progressiveRestore=!1,this.onMeshTargetChangedObservable=new U,this.checkCollisions=!1,this.collisionRadius=new m(.5,.5,.5),this._previousPosition=m.Zero(),this._collisionVelocity=m.Zero(),this._newPosition=m.Zero(),this._computationVector=m.Zero(),this._onCollisionPositionChange=(l,c,h=null)=>{h?(this.setPosition(c),this.onCollide&&this.onCollide(h)):this._previousPosition.copyFrom(this._position);const f=Math.cos(this.alpha),u=Math.sin(this.alpha),d=Math.cos(this.beta);let _=Math.sin(this.beta);_===0&&(_=1e-4);const p=this._getTargetPosition();this._computationVector.copyFromFloats(this.radius*f*_,this.radius*d,this.radius*u*_),p.addToRef(this._computationVector,this._newPosition),this._position.copyFrom(this._newPosition);let g=this.upVector;this.allowUpsideDown&&this.beta<0&&(g=g.clone(),g=g.negate()),this._computeViewMatrix(this._position,p,g),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y),this._collisionTriggered=!1},this._target=m.Zero(),s&&this.setTarget(s),this.alpha=t,this.beta=i,this.radius=r,this.getViewMatrix(),this.inputs=new lg(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}_initCache(){super._initCache(),this._cache._target=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.alpha=void 0,this._cache.beta=void 0,this._cache.radius=void 0,this._cache.targetScreenOffset=ne.Zero()}_updateCache(e){e||super._updateCache(),this._cache._target.copyFrom(this._getTargetPosition()),this._cache.alpha=this.alpha,this._cache.beta=this.beta,this._cache.radius=this.radius,this._cache.targetScreenOffset.copyFrom(this.targetScreenOffset)}_getTargetPosition(){if(this._targetHost&&this._targetHost.getAbsolutePosition){const t=this._targetHost.getAbsolutePosition();this._targetBoundingCenter?t.addToRef(this._targetBoundingCenter,this._target):this._target.copyFrom(t)}const e=this._getLockedTargetPosition();return e||this._target}storeState(){return this._storedAlpha=this._goalAlpha=this.alpha,this._storedBeta=this._goalBeta=this.beta,this._storedRadius=this._goalRadius=this.radius,this._storedTarget=this._goalTarget=this._getTargetPosition().clone(),this._storedTargetScreenOffset=this._goalTargetScreenOffset=this.targetScreenOffset.clone(),super.storeState()}_restoreStateValues(){return this.hasStateStored()&&this.restoreStateInterpolationFactor>Ke&&this.restoreStateInterpolationFactor<1?(this.interpolateTo(this._storedAlpha,this._storedBeta,this._storedRadius,this._storedTarget,this._storedTargetScreenOffset,this.restoreStateInterpolationFactor),!0):super._restoreStateValues()?(this.setTarget(this._storedTarget.clone()),this.alpha=this._storedAlpha,this.beta=this._storedBeta,this.radius=this._storedRadius,this.targetScreenOffset=this._storedTargetScreenOffset.clone(),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,!0):!1}interpolateTo(e=this.alpha,t=this.beta,i=this.radius,r=this.target,s=this.targetScreenOffset,n){this._progressiveRestore=!0,this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,n!=null?this._currentInterpolationFactor=n:this.restoreStateInterpolationFactor!==0?this._currentInterpolationFactor=this.restoreStateInterpolationFactor:this._currentInterpolationFactor=.1,e=je(e,this.lowerAlphaLimit??-1/0,this.upperAlphaLimit??1/0),t=je(t,this.lowerBetaLimit??-1/0,this.upperBetaLimit??1/0),i=je(i,this.lowerRadiusLimit??-1/0,this.upperRadiusLimit??1/0),r.y=je(r.y,this.lowerTargetYLimit??-1/0,1/0),this._goalAlpha=e,this._goalBeta=t,this._goalRadius=i,this._goalTarget=r,this._goalTargetScreenOffset=s}_isSynchronizedViewMatrix(){return super._isSynchronizedViewMatrix()?this._cache._target.equals(this._getTargetPosition())&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius&&this._cache.targetScreenOffset.equals(this.targetScreenOffset):!1}attachControl(e,t,i=!0,r=2){const s=arguments;t=k.BackCompatCameraNoPreventDefault(s),this._useCtrlForPanning=i,this._panningMouseButton=r,typeof s[0]=="boolean"&&(s.length>1&&(this._useCtrlForPanning=s[1]),s.length>2&&(this._panningMouseButton=s[2])),this.inputs.attachElement(t),this._reset=()=>{this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0}}detachControl(){this.inputs.detachElement(),this._reset&&this._reset()}_checkInputs(){if(!this._collisionTriggered){if(this.inputs.checkInputs(),this._progressiveRestore){const e=this._scene.getEngine().getDeltaTime()/1e3,t=1-Math.pow(2,-e/this._currentInterpolationFactor);this.setTarget(m.Lerp(this.getTarget(),this._goalTarget,t)),z.RotationAlphaBetaGammaToRef(this._goalAlpha,this._goalBeta,0,F.Quaternion[0]),z.RotationAlphaBetaGammaToRef(this.alpha,this.beta,0,F.Quaternion[1]),z.SlerpToRef(F.Quaternion[1],F.Quaternion[0],t,F.Quaternion[2]),F.Quaternion[2].normalize(),F.Quaternion[2].toAlphaBetaGammaToRef(F.Vector3[0]),this.alpha=F.Vector3[0].x,this.beta=F.Vector3[0].y,this.radius+=(this._goalRadius-this.radius)*t,ne.LerpToRef(this.targetScreenOffset,this._goalTargetScreenOffset,t,this.targetScreenOffset),(m.DistanceSquared(this.getTarget(),this._goalTarget)<Ke&&F.Quaternion[2].isApprox(F.Quaternion[0])&&Math.pow(this._goalRadius-this.radius,2)<Ke&&ne.Distance(this.targetScreenOffset,this._goalTargetScreenOffset)<Ke||this.inertialAlphaOffset!==0||this.inertialBetaOffset!==0||this.inertialRadiusOffset!==0||this.inertialPanningX!==0||this.inertialPanningY!==0)&&(this._progressiveRestore=!1)}if(this.inertialAlphaOffset!==0||this.inertialBetaOffset!==0||this.inertialRadiusOffset!==0){const e=this.invertRotation?-1:1,t=this._calculateHandednessMultiplier();let i=this.inertialAlphaOffset*t;this.beta<0&&(i*=-1),this.alpha+=i*e,this.beta+=this.inertialBetaOffset*e,this.radius-=this.inertialRadiusOffset,this.inertialAlphaOffset*=this.inertia,this.inertialBetaOffset*=this.inertia,this.inertialRadiusOffset*=this.inertia,Math.abs(this.inertialAlphaOffset)<Ke&&(this.inertialAlphaOffset=0),Math.abs(this.inertialBetaOffset)<Ke&&(this.inertialBetaOffset=0),Math.abs(this.inertialRadiusOffset)<this.speed*Ke&&(this.inertialRadiusOffset=0)}if(this.inertialPanningX!==0||this.inertialPanningY!==0){const e=new m(this.inertialPanningX,this.inertialPanningY,this.inertialPanningY);if(this._viewMatrix.invertToRef(this._cameraTransformMatrix),e.multiplyInPlace(this.panningAxis),m.TransformNormalToRef(e,this._cameraTransformMatrix,this._transformedDirection),this.mapPanning){const t=this.upVector,i=m.CrossToRef(this._transformedDirection,t,this._transformedDirection);m.CrossToRef(t,i,this._transformedDirection)}else this.panningAxis.y||(this._transformedDirection.y=0);if(!this._targetHost)if(this.panningDistanceLimit)this._transformedDirection.addInPlace(this._target),m.DistanceSquared(this._transformedDirection,this.panningOriginTarget)<=this.panningDistanceLimit*this.panningDistanceLimit&&this._target.copyFrom(this._transformedDirection);else{if(this.parent){const t=F.Matrix[0];this.parent.getWorldMatrix().getRotationMatrixToRef(t),t.transposeToRef(t),m.TransformCoordinatesToRef(this._transformedDirection,t,this._transformedDirection)}this._target.addInPlace(this._transformedDirection)}this.inertialPanningX*=this.panningInertia,this.inertialPanningY*=this.panningInertia,Math.abs(this.inertialPanningX)<this.speed*Ke&&(this.inertialPanningX=0),Math.abs(this.inertialPanningY)<this.speed*Ke&&(this.inertialPanningY=0)}this._checkLimits(),super._checkInputs()}}_checkLimits(){this.lowerBetaLimit===null||this.lowerBetaLimit===void 0?this.allowUpsideDown&&this.beta>Math.PI&&(this.beta=this.beta-2*Math.PI):this.beta<this.lowerBetaLimit&&(this.beta=this.lowerBetaLimit),this.upperBetaLimit===null||this.upperBetaLimit===void 0?this.allowUpsideDown&&this.beta<-Math.PI&&(this.beta=this.beta+2*Math.PI):this.beta>this.upperBetaLimit&&(this.beta=this.upperBetaLimit),this.lowerAlphaLimit!==null&&this.alpha<this.lowerAlphaLimit&&(this.alpha=this.lowerAlphaLimit),this.upperAlphaLimit!==null&&this.alpha>this.upperAlphaLimit&&(this.alpha=this.upperAlphaLimit),this.lowerRadiusLimit!==null&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit,this.inertialRadiusOffset=0),this.upperRadiusLimit!==null&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit,this.inertialRadiusOffset=0),this.target.y=Math.max(this.target.y,this.lowerTargetYLimit)}rebuildAnglesAndRadius(){this._position.subtractToRef(this._getTargetPosition(),this._computationVector),(this._upVector.x!==0||this._upVector.y!==1||this._upVector.z!==0)&&m.TransformCoordinatesToRef(this._computationVector,this._upToYMatrix,this._computationVector),this.radius=this._computationVector.length(),this.radius===0&&(this.radius=1e-4);const e=this.alpha;this.alpha=CC(this._computationVector),this.beta=IC(this._computationVector.y,this.radius);const t=Math.round((e-this.alpha)/(2*Math.PI));this.alpha+=t*2*Math.PI,this._checkLimits()}setPosition(e){this._position.equals(e)||(this._position.copyFrom(e),this.rebuildAnglesAndRadius())}setTarget(e,t=!1,i=!1,r=!1){if(r=this.overrideCloneAlphaBetaRadius??r,e.computeWorldMatrix)t&&e.getBoundingInfo?this._targetBoundingCenter=e.getBoundingInfo().boundingBox.centerWorld.clone():this._targetBoundingCenter=null,e.computeWorldMatrix(),this._targetHost=e,this._target=this._getTargetPosition(),this.onMeshTargetChangedObservable.notifyObservers(this._targetHost);else{const s=e,n=this._getTargetPosition();if(n&&!i&&n.equals(s))return;this._targetHost=null,this._target=s,this._targetBoundingCenter=null,this.onMeshTargetChangedObservable.notifyObservers(null)}r||this.rebuildAnglesAndRadius()}_getViewMatrix(){const e=Math.cos(this.alpha),t=Math.sin(this.alpha),i=Math.cos(this.beta);let r=Math.sin(this.beta);r===0&&(r=1e-4),this.radius===0&&(this.radius=1e-4);const s=this._getTargetPosition();if(this._computationVector.copyFromFloats(this.radius*e*r,this.radius*i,this.radius*t*r),(this._upVector.x!==0||this._upVector.y!==1||this._upVector.z!==0)&&m.TransformCoordinatesToRef(this._computationVector,this._yToUpMatrix,this._computationVector),s.addToRef(this._computationVector,this._newPosition),this.getScene().collisionsEnabled&&this.checkCollisions){const n=this.getScene().collisionCoordinator;this._collider||(this._collider=n.createCollider()),this._collider._radius=this.collisionRadius,this._newPosition.subtractToRef(this._position,this._collisionVelocity),this._collisionTriggered=!0,n.getNewPosition(this._position,this._collisionVelocity,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}else{this._position.copyFrom(this._newPosition);let n=this.upVector;this.allowUpsideDown&&r<0&&(n=n.negate()),this._computeViewMatrix(this._position,s,n),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y)}return this._currentTarget=s,this._viewMatrix}zoomOn(e,t=!1){e=e||this.getScene().meshes;const i=N.MinMax(e);let r=this._calculateLowerRadiusFromModelBoundingSphere(i.min,i.max);r=Math.max(Math.min(r,this.upperRadiusLimit||Number.MAX_VALUE),this.lowerRadiusLimit||0),this.radius=r*this.zoomOnFactor,this.focusOn({min:i.min,max:i.max,distance:r},t)}focusOn(e,t=!1){let i,r;if(e.min===void 0){const s=e||this.getScene().meshes;i=N.MinMax(s),r=m.Distance(i.min,i.max)}else{const s=e;i=s,r=s.distance}this._target=N.Center(i),t||(this.maxZ=r*2)}createRigCamera(e,t){let i=0;switch(this.cameraRigMode){case Ce.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Ce.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Ce.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Ce.RIG_MODE_STEREOSCOPIC_INTERLACED:case Ce.RIG_MODE_VR:i=this._cameraRigParams.stereoHalfAngle*(t===0?1:-1);break;case Ce.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:i=this._cameraRigParams.stereoHalfAngle*(t===0?-1:1);break}const r=new dt(e,this.alpha+i,this.beta,this.radius,this._target,this.getScene());return r._cameraRigParams={},r.isRigCamera=!0,r.rigParent=this,r.upVector=this.upVector,r.mode=this.mode,r.orthoLeft=this.orthoLeft,r.orthoRight=this.orthoRight,r.orthoBottom=this.orthoBottom,r.orthoTop=this.orthoTop,r}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];switch(e.beta=t.beta=this.beta,this.cameraRigMode){case Ce.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Ce.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Ce.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Ce.RIG_MODE_STEREOSCOPIC_INTERLACED:case Ce.RIG_MODE_VR:e.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle;break;case Ce.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:e.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle;break}super._updateRigCameras()}_calculateLowerRadiusFromModelBoundingSphere(e,t,i=1){const r=m.Distance(e,t),n=this.getScene().getEngine().getAspectRatio(this),o=Math.tan(this.fov/2),l=o*n,h=r*.5*i,f=h*Math.sqrt(1+1/(l*l)),u=h*Math.sqrt(1+1/(o*o));return Math.max(f,u)}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"ArcRotateCamera"}}A([y()],dt.prototype,"alpha",void 0);A([y()],dt.prototype,"beta",void 0);A([y()],dt.prototype,"radius",void 0);A([y()],dt.prototype,"overrideCloneAlphaBetaRadius",void 0);A([di("target")],dt.prototype,"_target",void 0);A([ym("targetHost")],dt.prototype,"_targetHost",void 0);A([y()],dt.prototype,"inertialAlphaOffset",void 0);A([y()],dt.prototype,"inertialBetaOffset",void 0);A([y()],dt.prototype,"inertialRadiusOffset",void 0);A([y()],dt.prototype,"lowerAlphaLimit",void 0);A([y()],dt.prototype,"upperAlphaLimit",void 0);A([y()],dt.prototype,"lowerBetaLimit",void 0);A([y()],dt.prototype,"upperBetaLimit",void 0);A([y()],dt.prototype,"lowerRadiusLimit",void 0);A([y()],dt.prototype,"upperRadiusLimit",void 0);A([y()],dt.prototype,"lowerTargetYLimit",void 0);A([y()],dt.prototype,"inertialPanningX",void 0);A([y()],dt.prototype,"inertialPanningY",void 0);A([y()],dt.prototype,"pinchToPanMaxDistance",void 0);A([y()],dt.prototype,"panningDistanceLimit",void 0);A([di()],dt.prototype,"panningOriginTarget",void 0);A([y()],dt.prototype,"panningInertia",void 0);A([y()],dt.prototype,"zoomToMouseLocation",null);A([y()],dt.prototype,"zoomOnFactor",void 0);A([Ec()],dt.prototype,"targetScreenOffset",void 0);A([y()],dt.prototype,"allowUpsideDown",void 0);A([y()],dt.prototype,"useInputToRestoreState",void 0);A([y()],dt.prototype,"restoreStateInterpolationFactor",void 0);Y("BABYLON.ArcRotateCamera",dt);class yi extends ni{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([X(()=>Promise.resolve().then(()=>XO),void 0,import.meta.url),X(()=>Promise.resolve().then(()=>YO),void 0,import.meta.url)]))):t.push(Promise.all([X(()=>Promise.resolve().then(()=>$O),void 0,import.meta.url),X(()=>Promise.resolve().then(()=>tD),void 0,import.meta.url)]))}constructor(e,t=null,i,r,s){const n=!!(s!=null&&s.blockCompilation);super({...s,name:e,engine:t||he.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:yi.FragmentUrl,uniforms:yi.Uniforms,samplers:yi.Samplers,vertexUrl:yi.VertexUrl,blockCompilation:!0}),this._packedFloat=!1,this._staticDefines="",this.textureWidth=0,this.textureHeight=0,this.options.blockCompilation=n,i!==void 0&&(this.direction=i),r!==void 0&&(this.kernel=r)}set kernel(e){this._idealKernel!==e&&(e=Math.max(e,1),this._idealKernel=e,this._kernel=this._nearestBestKernel(e),this.options.blockCompilation||this._updateParameters())}get kernel(){return this._idealKernel}set packedFloat(e){this._packedFloat!==e&&(this._packedFloat=e,this.options.blockCompilation||this._updateParameters())}get packedFloat(){return this._packedFloat}bind(){super.bind(),this._drawWrapper.effect.setFloat2("delta",1/this.textureWidth*this.direction.x,1/this.textureHeight*this.direction.y)}_updateParameters(e,t){const i=this._kernel,r=(i-1)/2;let s=[],n=[],o=0;for(let g=0;g<i;g++){const E=g/(i-1),v=this._gaussianWeight(E*2-1);s[g]=g-r,n[g]=v,o+=v}for(let g=0;g<n.length;g++)n[g]/=o;const l=[],c=[],h=[];for(let g=0;g<=r;g+=2){const E=Math.min(g+1,Math.floor(r));if(g===E)h.push({o:s[g],w:n[g]});else{const b=E===r,R=n[g]+n[E]*(b?.5:1),S=s[g]+1/(1+n[g]/n[E]);S===0?(h.push({o:s[g],w:n[g]}),h.push({o:s[g+1],w:n[g+1]})):(h.push({o:S,w:R}),h.push({o:-S,w:R}))}}for(let g=0;g<h.length;g++)c[g]=h[g].o,l[g]=h[g].w;s=c,n=l;const f=this.options.engine.getCaps().maxVaryingVectors-(this.options.shaderLanguage===1?1:0),u=Math.max(f,0)-1;let d=Math.min(s.length,u),_="";_+=this._staticDefines,this._staticDefines.indexOf("DOF")!=-1&&(_+=`#define CENTER_WEIGHT ${this._glslFloat(n[d-1])}
`,d--);for(let g=0;g<d;g++)_+=`#define KERNEL_OFFSET${g} ${this._glslFloat(s[g])}
`,_+=`#define KERNEL_WEIGHT${g} ${this._glslFloat(n[g])}
`;let p=0;for(let g=u;g<s.length;g++)_+=`#define KERNEL_DEP_OFFSET${p} ${this._glslFloat(s[g])}
`,_+=`#define KERNEL_DEP_WEIGHT${p} ${this._glslFloat(n[g])}
`,p++;this.packedFloat&&(_+="#define PACKEDFLOAT 1"),this.options.blockCompilation=!1,this.updateEffect(_,null,null,{varyingCount:d,depCount:p},e,t)}_nearestBestKernel(e){const t=Math.round(e);for(const i of[t,t-1,t+1,t-2,t+2])if(i%2!==0&&Math.floor(i/2)%2===0&&i>0)return Math.max(i,3);return Math.max(t,3)}_gaussianWeight(e){const t=.3333333333333333,i=Math.sqrt(2*Math.PI)*t,r=-(e*e/(2*t*t));return 1/i*Math.exp(r)}_glslFloat(e,t=8){return e.toFixed(t).replace(/0+$/,"")}}yi.VertexUrl="kernelBlur";yi.FragmentUrl="kernelBlur";yi.Uniforms=["delta","direction"];yi.Samplers=["circleOfConfusionSampler"];class es extends At{get direction(){return this._effectWrapper.direction}set direction(e){this._effectWrapper.direction=e}set kernel(e){this._effectWrapper.kernel=e}get kernel(){return this._effectWrapper.kernel}set packedFloat(e){this._effectWrapper.packedFloat=e}get packedFloat(){return this._effectWrapper.packedFloat}getClassName(){return"BlurPostProcess"}constructor(e,t,i,r,s=null,n=Z.BILINEAR_SAMPLINGMODE,o,l,c=0,h="",f=!1,u=5){const d=typeof r=="number"?f:!!r.blockCompilation,_={uniforms:yi.Uniforms,samplers:yi.Samplers,size:typeof r=="number"?r:void 0,camera:s,samplingMode:n,engine:o,reusable:l,textureType:c,vertexUrl:yi.VertexUrl,indexParameters:{varyingCount:0,depCount:0},textureFormat:u,defines:h,...r,blockCompilation:!0};super(e,yi.FragmentUrl,{effectWrapper:typeof r=="number"||!r.effectWrapper?new yi(e,o,void 0,void 0,_):void 0,..._}),this._effectWrapper.options.blockCompilation=d,this.direction=t,this.onApplyObservable.add(()=>{this._effectWrapper.textureWidth=this._outputTexture?this._outputTexture.width:this.width,this._effectWrapper.textureHeight=this._outputTexture?this._outputTexture.height:this.height}),this.kernel=i}updateEffect(e=null,t=null,i=null,r,s,n){this._effectWrapper._updateParameters(s,n)}static _Parse(e,t,i,r){return ye.Parse(()=>new es(e.name,e.direction,e.kernel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,void 0,!1),e,i,r)}}A([Ec()],es.prototype,"direction",null);A([y()],es.prototype,"kernel",null);A([y()],es.prototype,"packedFloat",null);Y("BABYLON.BlurPostProcess",es);class Ha extends rr{set blurRatio(e){this._blurRatio!==e&&(this._blurRatio=e,this._preparePostProcesses())}get blurRatio(){return this._blurRatio}set adaptiveBlurKernel(e){this._adaptiveBlurKernel=e,this._autoComputeBlurKernel()}set blurKernel(e){this.blurKernelX=e,this.blurKernelY=e}set blurKernelX(e){this._blurKernelX!==e&&(this._blurKernelX=e,this._preparePostProcesses())}get blurKernelX(){return this._blurKernelX}set blurKernelY(e){this._blurKernelY!==e&&(this._blurKernelY=e,this._preparePostProcesses())}get blurKernelY(){return this._blurKernelY}_autoComputeBlurKernel(){const e=this.getScene().getEngine(),t=this.getRenderWidth()/e.getRenderWidth(),i=this.getRenderHeight()/e.getRenderHeight();this.blurKernelX=this._adaptiveBlurKernel*t,this.blurKernelY=this._adaptiveBlurKernel*i}_onRatioRescale(){this._sizeRatio&&(this.resize(this._initialSizeParameter),this._adaptiveBlurKernel||this._preparePostProcesses()),this._adaptiveBlurKernel&&this._autoComputeBlurKernel()}_updateGammaSpace(){const e=this.getScene();e&&(this.gammaSpace=!e.imageProcessingConfiguration.isEnabled||!e.imageProcessingConfiguration.applyByPostProcess)}constructor(e,t,i,r,s=0,n=Z.BILINEAR_SAMPLINGMODE,o=!0){if(super(e,t,i,r,!0,s,!1,n,o),this.mirrorPlane=new hi(0,1,0,1),this._transformMatrix=P.Zero(),this._mirrorMatrix=P.Zero(),this._adaptiveBlurKernel=0,this._blurKernelX=0,this._blurKernelY=0,this._blurRatio=1,i=this.getScene(),!i)return this;this.ignoreCameraViewport=!0,this._updateGammaSpace(),this._imageProcessingConfigChangeObserver=i.imageProcessingConfiguration.onUpdateParameters.add(()=>{this._updateGammaSpace()}),i.getEngine().supportsUniformBuffers&&(this._sceneUBO=i.createSceneUniformBuffer(`Scene for Mirror Texture (name "${e}")`));let c;this.onBeforeRenderObservable.add(()=>{this._sceneUBO&&(this._currentSceneUBO=i.getSceneUniformBuffer(),i.setSceneUniformBuffer(this._sceneUBO),i.getSceneUniformBuffer().unbindEffect()),P.ReflectionToRef(this.mirrorPlane,this._mirrorMatrix),this._mirrorMatrix.multiplyToRef(i.getViewMatrix(),this._transformMatrix),i.setTransformMatrix(this._transformMatrix,i.getProjectionMatrix()),c=i.clipPlane,i.clipPlane=this.mirrorPlane,i._mirroredCameraPosition=m.TransformCoordinates(i.activeCamera.globalPosition,this._mirrorMatrix)}),this.onAfterRenderObservable.add(()=>{this._sceneUBO&&i.setSceneUniformBuffer(this._currentSceneUBO),i.updateTransformMatrix(),i._mirroredCameraPosition=null,i.clipPlane=c})}_preparePostProcesses(){if(this.clearPostProcesses(!0),this._blurKernelX&&this._blurKernelY){const e=this.getScene().getEngine(),t=e.getCaps().textureFloatRender&&e.getCaps().textureFloatLinearFiltering?1:2;this._blurX=new es("horizontal blur",new ne(1,0),this._blurKernelX,this._blurRatio,null,Z.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurX.autoClear=!1,this._blurRatio===1&&this.samples<2&&this._texture?this._blurX.inputTexture=this._renderTarget:this._blurX.alwaysForcePOT=!0,this._blurY=new es("vertical blur",new ne(0,1),this._blurKernelY,this._blurRatio,null,Z.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurY.autoClear=!1,this._blurY.alwaysForcePOT=this._blurRatio!==1,this.addPostProcess(this._blurX),this.addPostProcess(this._blurY)}else this._blurY&&(this.removePostProcess(this._blurY),this._blurY.dispose(),this._blurY=null),this._blurX&&(this.removePostProcess(this._blurX),this._blurX.dispose(),this._blurX=null)}clone(){const e=this.getScene();if(!e)return this;const t=this.getSize(),i=new Ha(this.name,t.width,e,this._renderTargetOptions.generateMipMaps,this._renderTargetOptions.type,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.mirrorPlane=this.mirrorPlane.clone(),this.renderList&&(i.renderList=this.renderList.slice(0)),i}serialize(){if(!this.name)return null;const e=super.serialize();return e.mirrorPlane=this.mirrorPlane.asArray(),e}dispose(){var t;super.dispose();const e=this.getScene();e&&e.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigChangeObserver),(t=this._sceneUBO)==null||t.dispose()}}Z._CreateMirror=(a,e,t,i)=>new Ha(a,e,t,i);function bC(a){const e=a.split("?")[0],t=e.lastIndexOf(".");return t>-1?e.substring(t).toLowerCase():""}H.prototype._partialLoadFile=function(a,e,t,i,r=null){const s=o=>{t[e]=o,t._internalCount++,t._internalCount===6&&i(t)},n=(o,l)=>{r&&o&&r(o.status+" "+o.statusText,l)};this._loadFile(a,s,void 0,void 0,!0,n)};H.prototype._cascadeLoadFiles=function(a,e,t,i=null){const r=[];r._internalCount=0;for(let s=0;s<6;s++)this._partialLoadFile(t[s],s,r,e,i)};H.prototype._cascadeLoadImgs=function(a,e,t,i,r=null,s){const n=[];n._internalCount=0;for(let o=0;o<6;o++)this._partialLoadImg(i[o],o,n,a,e,t,r,s)};H.prototype._partialLoadImg=function(a,e,t,i,r,s,n=null,o){const l=xs();La(a,f=>{t[e]=f,t._internalCount++,i&&i.removePendingData(l),t._internalCount===6&&s&&s(r,t)},(f,u)=>{i&&i.removePendingData(l),n&&n(f,u)},i?i.offlineProvider:null,o),i&&i.addPendingData(l)};H.prototype.createCubeTextureBase=function(a,e,t,i,r=null,s=null,n,o=null,l=!1,c=0,h=0,f=null,u=null,d=null,_=!1,p=null){const g=f||new Yt(this,7);g.isCube=!0,g.url=a,g.generateMipMaps=!i,g._lodGenerationScale=c,g._lodGenerationOffset=h,g._useSRGBBuffer=!!_&&this._caps.supportSRGBBuffers&&(this.version>1||this.isWebGPU||!!i),g!==f&&(g.label=a.substring(0,60)),this._doNotHandleContextLost||(g._extension=o,g._files=t,g._buffer=p);const E=a;this._transformTextureUrl&&!f&&(a=this._transformTextureUrl(a));const v=o??bC(a),b=_m(v),R=(S,T)=>{a===E?s&&S&&s(S.status+" "+S.statusText,T):(B.Warn(`Failed to load ${a}, falling back to the ${E}`),this.createCubeTextureBase(E,e,t,!!i,r,s,n,o,l,c,h,g,u,d,_,p))};if(b)b.then(S=>{const T=I=>{u&&u(g,I),S.loadCubeData(I,g,l,r,s)};p?T(p):t&&t.length===6?S.supportCascades?this._cascadeLoadFiles(e,I=>T(I.map(O=>new Uint8Array(O))),t,s):s?s("Textures type does not support cascades."):B.Warn("Texture loader does not support cascades."):this._loadFile(a,I=>T(new Uint8Array(I)),void 0,void 0,!0,R)});else{if(!t||t.length===0)throw new Error("Cannot load cubemap because files were not defined, or the correct loader was not found.");this._cascadeLoadImgs(e,g,(S,T)=>{d&&d(S,T)},t,s)}return this._internalTexturesCache.push(g),g};const tf=.8;class Jt extends rt{set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(P.RotationY(this._rotationY))}get rotationY(){return this._rotationY}get noMipmap(){return this._noMipmap}get forcedExtension(){return this._forcedExtension}static CreateFromImages(e,t,i){let r="";return e.forEach(s=>r+=s),new Jt(r,t,null,i,e)}static CreateFromPrefilteredData(e,t,i=null,r=!0){const s=t.useDelayedTextureLoading;t.useDelayedTextureLoading=!1;const n=new Jt(e,t,null,!1,null,null,null,void 0,!0,i,r);return t.useDelayedTextureLoading=s,n}constructor(e,t,i=null,r=!1,s=null,n=null,o=null,l=5,c=!1,h=null,f=!1,u=tf,d=0,_,p){var v;super(t),this.onLoadObservable=new U,this.boundingBoxPosition=m.Zero(),this._rotationY=0,this._files=null,this._forcedExtension=null,this._extensions=null,this._textureMatrixRefraction=new P,this._buffer=null,this.name=e,this.url=e,this._noMipmap=r,this.hasAlpha=!1,this.isCube=!0,this._textureMatrix=P.Identity(),this.coordinatesMode=Z.CUBIC_MODE;let g=null,E=null;i!==null&&!Array.isArray(i)?(g=i.extensions??null,this._noMipmap=i.noMipmap??!1,s=i.files??null,E=i.buffer??null,this._format=i.format??5,c=i.prefiltered??!1,h=i.forcedExtension??null,this._createPolynomials=i.createPolynomials??!1,this._lodScale=i.lodScale??tf,this._lodOffset=i.lodOffset??0,this._loaderOptions=i.loaderOptions,this._useSRGBBuffer=i.useSRGBBuffer,n=i.onLoad??null,o=i.onError??null):(this._noMipmap=r,this._format=l,this._createPolynomials=f,g=i,this._loaderOptions=_,this._useSRGBBuffer=p,this._lodScale=u,this._lodOffset=d),!(!e&&!s)&&this.updateURL(e,h,n,c,o,g,(v=this.getScene())==null?void 0:v.useDelayedTextureLoading,s,E)}getClassName(){return"CubeTexture"}updateURL(e,t=null,i=null,r=!1,s=null,n=null,o=!1,l=null,c=null){(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,t&&(this._forcedExtension=t);const h=e.lastIndexOf("."),f=t||(h>-1?e.substring(h).toLowerCase():""),u=f.indexOf(".dds")===0,d=f.indexOf(".env")===0,_=f.indexOf(".basis")===0;if(d?(this.gammaSpace=!1,this._prefiltered=!1,this.anisotropicFilteringLevel=1):(this._prefiltered=r,r&&(this.gammaSpace=!1,this.anisotropicFilteringLevel=1)),l)this._files=l;else if(!_&&!d&&!u&&!n&&(n=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this._files=this._files||[],this._files.length=0,n){for(let p=0;p<n.length;p++)this._files.push(e+n[p]);this._extensions=n}this._buffer=c,o?(this.delayLoadState=4,this._delayedOnLoad=i,this._delayedOnError=s):this._loadTexture(i,s)}delayLoad(e){this.delayLoadState===4&&(e&&(this._forcedExtension=e),this.delayLoadState=1,this._loadTexture(this._delayedOnLoad,this._delayedOnError))}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){var s,n;if(e.updateFlag===this._textureMatrix.updateFlag||(e.isIdentity()!==this._textureMatrix.isIdentity()&&((s=this.getScene())==null||s.markAllMaterialsAsDirty(1,o=>o.getActiveTextures().indexOf(this)!==-1)),this._textureMatrix=e,!((n=this.getScene())!=null&&n.useRightHandedSystem)))return;const t=F.Vector3[0],i=F.Quaternion[0],r=F.Vector3[1];this._textureMatrix.decompose(t,i,r),i.z*=-1,i.w*=-1,P.ComposeToRef(t,i,r,this._textureMatrixRefraction)}getRefractionTextureMatrix(){var e;return(e=this.getScene())!=null&&e.useRightHandedSystem?this._textureMatrixRefraction:this._textureMatrix}_loadTexture(e=null,t=null){var o;const i=this.getScene(),r=this._texture;this._texture=this._getFromCache(this.url,this._noMipmap,void 0,void 0,this._useSRGBBuffer,this.isCube);const s=()=>{var l;this.onLoadObservable.notifyObservers(this),r&&(r.dispose(),(l=this.getScene())==null||l.markAllMaterialsAsDirty(1)),e&&e()},n=(l,c)=>{this._loadingError=!0,this._errorObject={message:l,exception:c},t&&t(l,c),Z.OnTextureLoadErrorObservable.notifyObservers(this)};this._texture?this._texture.isReady?k.SetImmediate(()=>s()):this._texture.onLoadedObservable.add(()=>s()):(this._prefiltered?this._texture=this._getEngine().createPrefilteredCubeTexture(this.url,i,this._lodScale,this._lodOffset,e,n,this._format,this._forcedExtension,this._createPolynomials):this._texture=this._getEngine().createCubeTexture(this.url,i,this._files,this._noMipmap,e,n,this._format,this._forcedExtension,!1,this._lodScale,this._lodOffset,null,this._loaderOptions,!!this._useSRGBBuffer,this._buffer),(o=this._texture)==null||o.onLoadedObservable.add(()=>this.onLoadObservable.notifyObservers(this)))}static Parse(e,t,i){const r=ye.Parse(()=>{let s=!1;return e.prefiltered&&(s=e.prefiltered),new Jt(i+(e.url??e.name),t,e.extensions,!1,e.files||null,null,null,void 0,s,e.forcedExtension)},e,t);if(e.boundingBoxPosition&&(r.boundingBoxPosition=m.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(r.boundingBoxSize=m.FromArray(e.boundingBoxSize)),e.animations)for(let s=0;s<e.animations.length;s++){const n=e.animations[s],o=Ui("BABYLON.Animation");o&&r.animations.push(o.Parse(n))}return r}clone(){let e=0;const t=ye.Clone(()=>{const i=new Jt(this.url,this.getScene()||this._getEngine(),this._extensions,this._noMipmap,this._files);return e=i.uniqueId,i},this);return t.uniqueId=e,t}}A([y()],Jt.prototype,"url",void 0);A([di()],Jt.prototype,"boundingBoxPosition",void 0);A([di()],Jt.prototype,"boundingBoxSize",null);A([y("rotationY")],Jt.prototype,"rotationY",null);A([y("files")],Jt.prototype,"_files",void 0);A([y("forcedExtension")],Jt.prototype,"_forcedExtension",void 0);A([y("extensions")],Jt.prototype,"_extensions",void 0);A([Om("textureMatrix")],Jt.prototype,"_textureMatrix",void 0);A([Om("textureMatrixRefraction")],Jt.prototype,"_textureMatrixRefraction",void 0);Z._CubeTextureParser=Jt.Parse;Y("BABYLON.CubeTexture",Jt);class xC extends ji{constructor(){super(),this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.GAMMADIFFUSE=!1,this.DIFFUSEHASALPHA=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONBLUR=!1,this.REFLECTIONFRESNEL=!1,this.REFLECTIONFALLOFF=!1,this.TEXTURELODSUPPORT=!1,this.PREMULTIPLYALPHA=!1,this.USERGBCOLOR=!1,this.USEHIGHLIGHTANDSHADOWCOLORS=!1,this.BACKMAT_SHADOWONLY=!1,this.NOISE=!1,this.REFLECTIONBGR=!1,this.PROJECTED_GROUND=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.EQUIRECTANGULAR_RELFECTION_FOV=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.UV1=!1,this.UV2=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.NORMAL=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.INSTANCES=!1,this.SHADOWFLOAT=!1,this.LOGARITHMICDEPTH=!1,this.NONUNIFORMSCALING=!1,this.ALPHATEST=!1,this.rebuild()}}class Xe extends Un{get _perceptualColor(){return this.__perceptualColor}set _perceptualColor(e){this.__perceptualColor=e,this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsLightsDirty()}get primaryColorShadowLevel(){return this._primaryColorShadowLevel}set primaryColorShadowLevel(e){this._primaryColorShadowLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}get primaryColorHighlightLevel(){return this._primaryColorHighlightLevel}set primaryColorHighlightLevel(e){this._primaryColorHighlightLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}set reflectionStandardFresnelWeight(e){let t=e;t<.5?(t=t*2,this.reflectionReflectance0=Xe.StandardReflectance0*t,this.reflectionReflectance90=Xe.StandardReflectance90*t):(t=t*2-1,this.reflectionReflectance0=Xe.StandardReflectance0+(1-Xe.StandardReflectance0)*t,this.reflectionReflectance90=Xe.StandardReflectance90+(1-Xe.StandardReflectance90)*t)}get fovMultiplier(){return this._fovMultiplier}set fovMultiplier(e){isNaN(e)&&(e=1),this._fovMultiplier=Math.max(0,Math.min(2,e))}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsImageProcessingDirty()})))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this.imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this.imageProcessingConfiguration.colorCurves=e}constructor(e,t,i=!1){super(e,t,void 0,i),this.primaryColor=ae.White(),this._primaryColorShadowLevel=0,this._primaryColorHighlightLevel=0,this.reflectionTexture=null,this.reflectionBlur=0,this.diffuseTexture=null,this._shadowLights=null,this.shadowLights=null,this.shadowLevel=0,this.sceneCenter=m.Zero(),this.opacityFresnel=!0,this.reflectionFresnel=!1,this.reflectionFalloffDistance=0,this.reflectionAmount=1,this.reflectionReflectance0=.05,this.reflectionReflectance90=.5,this.useRGBColor=!0,this.enableNoise=!1,this._fovMultiplier=1,this.useEquirectangularFOV=!1,this._maxSimultaneousLights=4,this.maxSimultaneousLights=4,this._shadowOnly=!1,this.shadowOnly=!1,this._imageProcessingObserver=null,this.switchToBGR=!1,this._enableGroundProjection=!1,this.enableGroundProjection=!1,this.projectedGroundRadius=1e3,this.projectedGroundHeight=10,this._renderTargets=new jt(16),this._reflectionControls=Fe.Zero(),this._white=ae.White(),this._primaryShadowColor=ae.Black(),this._primaryHighlightColor=ae.Black(),this._shadersLoaded=!1,this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._renderTargets.push(this._diffuseTexture),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._renderTargets)}get hasRenderTargetTextures(){return!!(this._diffuseTexture&&this._diffuseTexture.isRenderTarget||this._reflectionTexture&&this._reflectionTexture.isRenderTarget)}needAlphaTesting(){return!0}needAlphaBlending(){return this.alpha<1||this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._shadowOnly}isReadyForSubMesh(e,t,i=!1){const r=t._drawWrapper;if(r.effect&&this.isFrozen&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new xC);const s=this.getScene(),n=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const o=s.getEngine();if(Pc(s,e,n,!1,this._maxSimultaneousLights),n._needNormals=!0,Lc(s,n),n._areTexturesDirty){if(n._needUVs=!1,s.texturesEnabled){if(s.getEngine().getCaps().textureLOD&&(n.TEXTURELODSUPPORT=!0),this._diffuseTexture&&Q.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;ht(this._diffuseTexture,n,"DIFFUSE"),n.DIFFUSEHASALPHA=this._diffuseTexture.hasAlpha,n.GAMMADIFFUSE=this._diffuseTexture.gammaSpace,n.OPACITYFRESNEL=this._opacityFresnel}else n.DIFFUSE=!1,n.DIFFUSEDIRECTUV=0,n.DIFFUSEHASALPHA=!1,n.GAMMADIFFUSE=!1,n.OPACITYFRESNEL=!1;const l=this._reflectionTexture;if(l&&Q.ReflectionTextureEnabled){if(!l.isReadyOrNotBlocking())return!1;switch(n.REFLECTION=!0,n.GAMMAREFLECTION=l.gammaSpace,n.RGBDREFLECTION=l.isRGBD,n.REFLECTIONBLUR=this._reflectionBlur>0,n.LODINREFLECTIONALPHA=l.lodLevelInAlpha,n.EQUIRECTANGULAR_RELFECTION_FOV=this.useEquirectangularFOV,n.REFLECTIONBGR=this.switchToBGR,l.coordinatesMode===Z.INVCUBIC_MODE&&(n.INVERTCUBICMAP=!0),n.REFLECTIONMAP_3D=l.isCube,n.REFLECTIONMAP_OPPOSITEZ=n.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!l.invertZ:l.invertZ,l.coordinatesMode){case Z.EXPLICIT_MODE:n.REFLECTIONMAP_EXPLICIT=!0;break;case Z.PLANAR_MODE:n.REFLECTIONMAP_PLANAR=!0;break;case Z.PROJECTION_MODE:n.REFLECTIONMAP_PROJECTION=!0;break;case Z.SKYBOX_MODE:n.REFLECTIONMAP_SKYBOX=!0;break;case Z.SPHERICAL_MODE:n.REFLECTIONMAP_SPHERICAL=!0;break;case Z.EQUIRECTANGULAR_MODE:n.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case Z.FIXED_EQUIRECTANGULAR_MODE:n.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case Z.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:n.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case Z.CUBIC_MODE:case Z.INVCUBIC_MODE:default:n.REFLECTIONMAP_CUBIC=!0;break}this.reflectionFresnel?(n.REFLECTIONFRESNEL=!0,n.REFLECTIONFALLOFF=this.reflectionFalloffDistance>0,this._reflectionControls.x=this.reflectionAmount,this._reflectionControls.y=this.reflectionReflectance0,this._reflectionControls.z=this.reflectionReflectance90,this._reflectionControls.w=1/this.reflectionFalloffDistance):(n.REFLECTIONFRESNEL=!1,n.REFLECTIONFALLOFF=!1)}else n.REFLECTION=!1,n.REFLECTIONFRESNEL=!1,n.REFLECTIONFALLOFF=!1,n.REFLECTIONBLUR=!1,n.REFLECTIONMAP_3D=!1,n.REFLECTIONMAP_SPHERICAL=!1,n.REFLECTIONMAP_PLANAR=!1,n.REFLECTIONMAP_CUBIC=!1,n.REFLECTIONMAP_PROJECTION=!1,n.REFLECTIONMAP_SKYBOX=!1,n.REFLECTIONMAP_EXPLICIT=!1,n.REFLECTIONMAP_EQUIRECTANGULAR=!1,n.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,n.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,n.INVERTCUBICMAP=!1,n.REFLECTIONMAP_OPPOSITEZ=!1,n.LODINREFLECTIONALPHA=!1,n.GAMMAREFLECTION=!1,n.RGBDREFLECTION=!1}n.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,n.USERGBCOLOR=this._useRGBColor,n.NOISE=this._enableNoise}if(n._areLightsDirty&&(n.USEHIGHLIGHTANDSHADOWCOLORS=!this._useRGBColor&&(this._primaryColorShadowLevel!==0||this._primaryColorHighlightLevel!==0),n.BACKMAT_SHADOWONLY=this._shadowOnly),n._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(n)}if(n._areMiscDirty&&(n.REFLECTIONMAP_3D&&this._enableGroundProjection?(n.PROJECTED_GROUND=!0,n.REFLECTIONMAP_SKYBOX=!0):n.PROJECTED_GROUND=!1),Mc(e,s,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this.needAlphaTestingForMesh(e),n),Oc(s,o,this,n,i,null,t.getRenderingMesh().hasThinInstances),Dc(e,n,!1,!0,!1)&&e&&!s.getEngine().getCaps().standardDerivatives&&!e.isVerticesDataPresent(x.NormalKind)&&(e.createNormals(!0),B.Warn("BackgroundMaterial: Normals have been created for the mesh: "+e.name)),n.isDirty){n.markAsProcessed(),s.resetCachedMaterial();const l=new Vn;n.FOG&&l.addFallback(0,"FOG"),n.POINTSIZE&&l.addFallback(1,"POINTSIZE"),n.MULTIVIEW&&l.addFallback(0,"MULTIVIEW"),yc(n,l,this._maxSimultaneousLights);const c=[x.PositionKind];n.NORMAL&&c.push(x.NormalKind),n.UV1&&c.push(x.UVKind),n.UV2&&c.push(x.UV2Kind),bc(c,e,n,l),xc(c,n);const h=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","mBones","vPrimaryColor","vPrimaryColorShadow","vReflectionInfos","reflectionMatrix","vReflectionMicrosurfaceInfos","fFovMultiplier","shadowLevel","alpha","vBackgroundCenter","vReflectionControl","vDiffuseInfos","diffuseMatrix","projectedGroundInfos","logarithmicDepthConstant"];Ba(h);const f=["diffuseSampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh"],u=["Material","Scene"];ze&&(ze.PrepareUniforms(h,n),ze.PrepareSamplers(f,n)),Fc({uniformsNames:h,uniformBuffersNames:u,samplers:f,defines:n,maxSimultaneousLights:this._maxSimultaneousLights});const d=n.toString(),_=s.getEngine().createEffect("background",{attributes:c,uniformsNames:h,uniformBuffersNames:u,samplers:f,defines:d,fallbacks:l,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights},shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:async()=>{this.shaderLanguage===1?await Promise.all([X(()=>Promise.resolve().then(()=>sD),void 0,import.meta.url),X(()=>Promise.resolve().then(()=>oD),void 0,import.meta.url)]):await Promise.all([X(()=>Promise.resolve().then(()=>fD),void 0,import.meta.url),X(()=>Promise.resolve().then(()=>pD),void 0,import.meta.url)]),this._shadersLoaded=!0}},o);t.setEffect(_,n,this._materialContext),this.buildUniformLayout()}return!t.effect||!t.effect.isReady()?!1:(n._renderId=s.getRenderId(),r._wasPreviouslyReady=!0,r._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),!0)}_computePrimaryColorFromPerceptualColor(){this.__perceptualColor&&(this._primaryColor.copyFrom(this.__perceptualColor),this._primaryColor.toLinearSpaceToRef(this._primaryColor,this.getScene().getEngine().useExactSrgbConversions),this._imageProcessingConfiguration&&this._primaryColor.scaleToRef(1/this._imageProcessingConfiguration.exposure,this._primaryColor),this._computePrimaryColors())}_computePrimaryColors(){this._primaryColorShadowLevel===0&&this._primaryColorHighlightLevel===0||(this._primaryColor.scaleToRef(this._primaryColorShadowLevel,this._primaryShadowColor),this._primaryColor.subtractToRef(this._primaryShadowColor,this._primaryShadowColor),this._white.subtractToRef(this._primaryColor,this._primaryHighlightColor),this._primaryHighlightColor.scaleToRef(this._primaryColorHighlightLevel,this._primaryHighlightColor),this._primaryColor.addToRef(this._primaryHighlightColor,this._primaryHighlightColor))}buildUniformLayout(){this._uniformBuffer.addUniform("vPrimaryColor",4),this._uniformBuffer.addUniform("vPrimaryColorShadow",4),this._uniformBuffer.addUniform("vDiffuseInfos",2),this._uniformBuffer.addUniform("vReflectionInfos",2),this._uniformBuffer.addUniform("diffuseMatrix",16),this._uniformBuffer.addUniform("reflectionMatrix",16),this._uniformBuffer.addUniform("vReflectionMicrosurfaceInfos",3),this._uniformBuffer.addUniform("fFovMultiplier",1),this._uniformBuffer.addUniform("pointSize",1),this._uniformBuffer.addUniform("shadowLevel",1),this._uniformBuffer.addUniform("alpha",1),this._uniformBuffer.addUniform("vBackgroundCenter",3),this._uniformBuffer.addUniform("vReflectionControl",4),this._uniformBuffer.addUniform("projectedGroundInfos",2),this._uniformBuffer.create()}unbind(){this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._uniformBuffer.setTexture("diffuseSampler",null),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._uniformBuffer.setTexture("reflectionSampler",null),super.unbind()}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindForSubMesh(e,t,i){const r=this.getScene(),s=i.materialDefines;if(!s)return;const n=i.effect;if(!n)return;this._activeEffect=n,this.bindOnlyWorldMatrix(e),Ga(t,this._activeEffect);const o=this._mustRebind(r,n,i,t.visibility);if(o){this._uniformBuffer.bindToEffect(n,"Material"),this.bindViewProjection(n);const l=this._reflectionTexture;(!this._uniformBuffer.useUbo||!this.isFrozen||!this._uniformBuffer.isSync||i._drawWrapper._forceRebindOnNextCall)&&(r.texturesEnabled&&(this._diffuseTexture&&Q.DiffuseTextureEnabled&&(this._uniformBuffer.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),ft(this._diffuseTexture,this._uniformBuffer,"diffuse")),l&&Q.ReflectionTextureEnabled&&(this._uniformBuffer.updateMatrix("reflectionMatrix",l.getReflectionTextureMatrix()),this._uniformBuffer.updateFloat2("vReflectionInfos",l.level,this._reflectionBlur),this._uniformBuffer.updateFloat3("vReflectionMicrosurfaceInfos",l.getSize().width,l.lodGenerationScale,l.lodGenerationOffset))),this.shadowLevel>0&&this._uniformBuffer.updateFloat("shadowLevel",this.shadowLevel),this._uniformBuffer.updateFloat("alpha",this.alpha),this.pointsCloud&&this._uniformBuffer.updateFloat("pointSize",this.pointSize),s.USEHIGHLIGHTANDSHADOWCOLORS?(this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryHighlightColor,1),this._uniformBuffer.updateColor4("vPrimaryColorShadow",this._primaryShadowColor,1)):this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryColor,1)),this._uniformBuffer.updateFloat("fFovMultiplier",this._fovMultiplier),r.texturesEnabled&&(this._diffuseTexture&&Q.DiffuseTextureEnabled&&this._uniformBuffer.setTexture("diffuseSampler",this._diffuseTexture),l&&Q.ReflectionTextureEnabled&&(s.REFLECTIONBLUR&&s.TEXTURELODSUPPORT?this._uniformBuffer.setTexture("reflectionSampler",l):s.REFLECTIONBLUR?(this._uniformBuffer.setTexture("reflectionSampler",l._lodTextureMid||l),this._uniformBuffer.setTexture("reflectionSamplerLow",l._lodTextureLow||l),this._uniformBuffer.setTexture("reflectionSamplerHigh",l._lodTextureHigh||l)):this._uniformBuffer.setTexture("reflectionSampler",l),s.REFLECTIONFRESNEL&&(this._uniformBuffer.updateFloat3("vBackgroundCenter",this.sceneCenter.x,this.sceneCenter.y,this.sceneCenter.z),this._uniformBuffer.updateFloat4("vReflectionControl",this._reflectionControls.x,this._reflectionControls.y,this._reflectionControls.z,this._reflectionControls.w))),s.PROJECTED_GROUND&&this._uniformBuffer.updateFloat2("projectedGroundInfos",this.projectedGroundRadius,this.projectedGroundHeight)),Ua(this._activeEffect,this,r),r.bindEyePosition(n)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._uniformBuffer.bindToEffect(n,"Material"),this._needToBindSceneUbo=!0);(o||!this.isFrozen)&&(r.lightsEnabled&&Ic(r,t,this._activeEffect,s,this._maxSimultaneousLights),this.bindView(n),Va(r,t,this._activeEffect,!0),this._useLogarithmicDepth&&Bn(s,n,r),this._imageProcessingConfiguration&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect,i),this._uniformBuffer.update()}hasTexture(e){return!!(super.hasTexture(e)||this._reflectionTexture===e||this._diffuseTexture===e)}dispose(e=!1,t=!1){t&&(this.diffuseTexture&&this.diffuseTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e)}clone(e){return ye.Clone(()=>new Xe(e,this.getScene()),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.BackgroundMaterial",e}getClassName(){return"BackgroundMaterial"}static Parse(e,t,i){return ye.Parse(()=>new Xe(e.name,t),e,t,i)}}Xe.StandardReflectance0=.05;Xe.StandardReflectance90=.5;A([Qt()],Xe.prototype,"_primaryColor",void 0);A([j("_markAllSubMeshesAsLightsDirty")],Xe.prototype,"primaryColor",void 0);A([Qt()],Xe.prototype,"__perceptualColor",void 0);A([y()],Xe.prototype,"_primaryColorShadowLevel",void 0);A([y()],Xe.prototype,"_primaryColorHighlightLevel",void 0);A([j("_markAllSubMeshesAsLightsDirty")],Xe.prototype,"primaryColorHighlightLevel",null);A([Je()],Xe.prototype,"_reflectionTexture",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],Xe.prototype,"reflectionTexture",void 0);A([y()],Xe.prototype,"_reflectionBlur",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],Xe.prototype,"reflectionBlur",void 0);A([Je()],Xe.prototype,"_diffuseTexture",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],Xe.prototype,"diffuseTexture",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],Xe.prototype,"shadowLights",void 0);A([y()],Xe.prototype,"_shadowLevel",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],Xe.prototype,"shadowLevel",void 0);A([di()],Xe.prototype,"_sceneCenter",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],Xe.prototype,"sceneCenter",void 0);A([y()],Xe.prototype,"_opacityFresnel",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],Xe.prototype,"opacityFresnel",void 0);A([y()],Xe.prototype,"_reflectionFresnel",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],Xe.prototype,"reflectionFresnel",void 0);A([y()],Xe.prototype,"_reflectionFalloffDistance",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],Xe.prototype,"reflectionFalloffDistance",void 0);A([y()],Xe.prototype,"_reflectionAmount",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],Xe.prototype,"reflectionAmount",void 0);A([y()],Xe.prototype,"_reflectionReflectance0",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],Xe.prototype,"reflectionReflectance0",void 0);A([y()],Xe.prototype,"_reflectionReflectance90",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],Xe.prototype,"reflectionReflectance90",void 0);A([y()],Xe.prototype,"_useRGBColor",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],Xe.prototype,"useRGBColor",void 0);A([y()],Xe.prototype,"_enableNoise",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],Xe.prototype,"enableNoise",void 0);A([y()],Xe.prototype,"_maxSimultaneousLights",void 0);A([j("_markAllSubMeshesAsTexturesDirty")],Xe.prototype,"maxSimultaneousLights",void 0);A([y()],Xe.prototype,"_shadowOnly",void 0);A([j("_markAllSubMeshesAsLightsDirty")],Xe.prototype,"shadowOnly",void 0);A([Pm()],Xe.prototype,"_imageProcessingConfiguration",void 0);A([y(),j("_markAllSubMeshesAsMiscDirty")],Xe.prototype,"enableGroundProjection",void 0);A([y()],Xe.prototype,"projectedGroundRadius",void 0);A([y()],Xe.prototype,"projectedGroundHeight",void 0);Y("BABYLON.BackgroundMaterial",Xe);function cg(a){const e=[],t=[],i=[],r=[],s=a.width!==void 0?a.width:a.size!==void 0?a.size:1,n=a.height!==void 0?a.height:a.size!==void 0?a.size:1,o=a.sideOrientation===0?0:a.sideOrientation||ee.DEFAULTSIDE,l=s/2,c=n/2;t.push(-l,-c,0),i.push(0,0,-1),r.push(0,0),t.push(l,-c,0),i.push(0,0,-1),r.push(1,0),t.push(l,c,0),i.push(0,0,-1),r.push(1,1),t.push(-l,c,0),i.push(0,0,-1),r.push(0,1),e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),ee._ComputeSides(o,t,e,i,r,a.frontUVs,a.backUVs);const h=new ee;return h.indices=e,h.positions=t,h.normals=i,h.uvs=r,h}function Vc(a,e={},t=null){const i=new N(a,t);return e.sideOrientation=N._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,cg(e).applyToMesh(i,e.updatable),e.sourcePlane&&(i.translate(e.sourcePlane.normal,-e.sourcePlane.d),i.setDirection(e.sourcePlane.normal.scale(-1))),i}ee.CreatePlane=cg;N.CreatePlane=(a,e,t,i,r)=>Vc(a,{size:e,width:e,height:e,sideOrientation:r,updatable:i},t);N._GroundMeshParser=(a,e)=>Wn.Parse(a,e);class Wn extends N{constructor(e,t){super(e,t),this.generateOctree=!1}getClassName(){return"GroundMesh"}get subdivisions(){return Math.min(this._subdivisionsX,this._subdivisionsY)}get subdivisionsX(){return this._subdivisionsX}get subdivisionsY(){return this._subdivisionsY}optimize(e,t=32){this._subdivisionsX=e,this._subdivisionsY=e,this.subdivide(e);const i=this;i.createOrUpdateSubmeshesOctree&&i.createOrUpdateSubmeshesOctree(t)}getHeightAtCoordinates(e,t){const i=this.getWorldMatrix(),r=F.Matrix[5];i.invertToRef(r);const s=F.Vector3[8];if(m.TransformCoordinatesFromFloatsToRef(e,0,t,r,s),e=s.x,t=s.z,e<this._minX||e>=this._maxX||t<=this._minZ||t>this._maxZ)return this.position.y;(!this._heightQuads||this._heightQuads.length==0)&&(this._initHeightQuads(),this._computeHeightQuads());const n=this._getFacetAt(e,t),o=-(n.x*e+n.z*t+n.w)/n.y;return m.TransformCoordinatesFromFloatsToRef(0,o,0,i,s),s.y}getNormalAtCoordinates(e,t){const i=new m(0,1,0);return this.getNormalAtCoordinatesToRef(e,t,i),i}getNormalAtCoordinatesToRef(e,t,i){const r=this.getWorldMatrix(),s=F.Matrix[5];r.invertToRef(s);const n=F.Vector3[8];if(m.TransformCoordinatesFromFloatsToRef(e,0,t,s,n),e=n.x,t=n.z,e<this._minX||e>this._maxX||t<this._minZ||t>this._maxZ)return this;(!this._heightQuads||this._heightQuads.length==0)&&(this._initHeightQuads(),this._computeHeightQuads());const o=this._getFacetAt(e,t);return m.TransformNormalFromFloatsToRef(o.x,o.y,o.z,r,i),this}updateCoordinateHeights(){return(!this._heightQuads||this._heightQuads.length==0)&&this._initHeightQuads(),this._computeHeightQuads(),this}_getFacetAt(e,t){const i=Math.floor((e+this._maxX)*this._subdivisionsX/this._width),r=Math.floor(-(t+this._maxZ)*this._subdivisionsY/this._height+this._subdivisionsY),s=this._heightQuads[r*this._subdivisionsX+i];let n;return t<s.slope.x*e+s.slope.y?n=s.facet1:n=s.facet2,n}_initHeightQuads(){const e=this._subdivisionsX,t=this._subdivisionsY;this._heightQuads=new Array;for(let i=0;i<t;i++)for(let r=0;r<e;r++){const s={slope:ne.Zero(),facet1:new Fe(0,0,0,0),facet2:new Fe(0,0,0,0)};this._heightQuads[i*e+r]=s}return this}_computeHeightQuads(){const e=this.getVerticesData(x.PositionKind);if(!e)return this;const t=F.Vector3[3],i=F.Vector3[2],r=F.Vector3[1],s=F.Vector3[0],n=F.Vector3[4],o=F.Vector3[5],l=F.Vector3[6],c=F.Vector3[7],h=F.Vector3[8];let f=0,u=0,d=0,_=0,p=0,g=0,E=0;const v=this._subdivisionsX,b=this._subdivisionsY;for(let R=0;R<b;R++)for(let S=0;S<v;S++){f=S*3,u=R*(v+1)*3,d=(R+1)*(v+1)*3,t.x=e[u+f],t.y=e[u+f+1],t.z=e[u+f+2],i.x=e[u+f+3],i.y=e[u+f+4],i.z=e[u+f+5],r.x=e[d+f],r.y=e[d+f+1],r.z=e[d+f+2],s.x=e[d+f+3],s.y=e[d+f+4],s.z=e[d+f+5],_=(s.z-t.z)/(s.x-t.x),p=t.z-_*t.x,i.subtractToRef(t,n),r.subtractToRef(t,o),s.subtractToRef(t,l),m.CrossToRef(l,o,c),m.CrossToRef(n,l,h),c.normalize(),h.normalize(),g=-(c.x*t.x+c.y*t.y+c.z*t.z),E=-(h.x*i.x+h.y*i.y+h.z*i.z);const T=this._heightQuads[R*v+S];T.slope.copyFromFloats(_,p),T.facet1.copyFromFloats(c.x,c.y,c.z,g),T.facet2.copyFromFloats(h.x,h.y,h.z,E)}return this}serialize(e){super.serialize(e),e.subdivisionsX=this._subdivisionsX,e.subdivisionsY=this._subdivisionsY,e.minX=this._minX,e.maxX=this._maxX,e.minZ=this._minZ,e.maxZ=this._maxZ,e.width=this._width,e.height=this._height}static Parse(e,t){const i=new Wn(e.name,t);return i._subdivisionsX=e.subdivisionsX||1,i._subdivisionsY=e.subdivisionsY||1,i._minX=e.minX,i._maxX=e.maxX,i._minZ=e.minZ,i._maxZ=e.maxZ,i._width=e.width,i._height=e.height,i}}function hg(a){const e=[],t=[],i=[],r=[];let s,n;const o=a.width||a.size||1,l=a.height||a.size||1,c=(a.subdivisionsX||a.subdivisions||1)|0,h=(a.subdivisionsY||a.subdivisions||1)|0;for(s=0;s<=h;s++)for(n=0;n<=c;n++){const u=new m(n*o/c-o/2,0,(h-s)*l/h-l/2),d=new m(0,1,0);t.push(u.x,u.y,u.z),i.push(d.x,d.y,d.z),r.push(n/c,1-s/h)}for(s=0;s<h;s++)for(n=0;n<c;n++)e.push(n+1+(s+1)*(c+1)),e.push(n+1+s*(c+1)),e.push(n+s*(c+1)),e.push(n+(s+1)*(c+1)),e.push(n+1+(s+1)*(c+1)),e.push(n+s*(c+1));const f=new ee;return f.indices=e,f.positions=t,f.normals=i,f.uvs=r,f}function fg(a){const e=a.xmin!==void 0&&a.xmin!==null?a.xmin:-1,t=a.zmin!==void 0&&a.zmin!==null?a.zmin:-1,i=a.xmax!==void 0&&a.xmax!==null?a.xmax:1,r=a.zmax!==void 0&&a.zmax!==null?a.zmax:1,s=a.subdivisions||{w:1,h:1},n=a.precision||{w:1,h:1},o=[],l=[],c=[],h=[];let f,u,d,_;s.h=s.h<1?1:s.h,s.w=s.w<1?1:s.w,n.w=n.w<1?1:n.w,n.h=n.h<1?1:n.h;const p={w:(i-e)/s.w,h:(r-t)/s.h};function g(v,b,R,S){const T=l.length/3,I=n.w+1;for(f=0;f<n.h;f++)for(u=0;u<n.w;u++){const w=[T+u+f*I,T+(u+1)+f*I,T+(u+1)+(f+1)*I,T+u+(f+1)*I];o.push(w[1]),o.push(w[2]),o.push(w[3]),o.push(w[0]),o.push(w[1]),o.push(w[3])}const O=m.Zero(),L=new m(0,1,0);for(f=0;f<=n.h;f++)for(O.z=f*(S-b)/n.h+b,u=0;u<=n.w;u++)O.x=u*(R-v)/n.w+v,O.y=0,l.push(O.x,O.y,O.z),c.push(L.x,L.y,L.z),h.push(u/n.w,f/n.h)}for(d=0;d<s.h;d++)for(_=0;_<s.w;_++)g(e+_*p.w,t+d*p.h,e+(_+1)*p.w,t+(d+1)*p.h);const E=new ee;return E.indices=o,E.positions=l,E.normals=c,E.uvs=h,E}function ug(a){const e=[],t=[],i=[],r=[];let s,n;const o=a.colorFilter||new ae(.3,.59,.11),l=a.alphaFilter||0;let c=!1;if(a.minHeight>a.maxHeight){c=!0;const f=a.maxHeight;a.maxHeight=a.minHeight,a.minHeight=f}for(s=0;s<=a.subdivisions;s++)for(n=0;n<=a.subdivisions;n++){const f=new m(n*a.width/a.subdivisions-a.width/2,0,(a.subdivisions-s)*a.height/a.subdivisions-a.height/2),u=(f.x+a.width/2)/a.width*(a.bufferWidth-1)|0,d=(1-(f.z+a.height/2)/a.height)*(a.bufferHeight-1)|0,_=(u+d*a.bufferWidth)*4;let p=a.buffer[_]/255,g=a.buffer[_+1]/255,E=a.buffer[_+2]/255;const v=a.buffer[_+3]/255;c&&(p=1-p,g=1-g,E=1-E);const b=p*o.r+g*o.g+E*o.b;v>=l?f.y=a.minHeight+(a.maxHeight-a.minHeight)*b:f.y=a.minHeight-Ke,a.heightBuffer&&(a.heightBuffer[s*(a.subdivisions+1)+n]=f.y),t.push(f.x,f.y,f.z),i.push(0,0,0),r.push(n/a.subdivisions,1-s/a.subdivisions)}for(s=0;s<a.subdivisions;s++)for(n=0;n<a.subdivisions;n++){const f=n+1+(s+1)*(a.subdivisions+1),u=n+1+s*(a.subdivisions+1),d=n+s*(a.subdivisions+1),_=n+(s+1)*(a.subdivisions+1),p=t[f*3+1]>=a.minHeight,g=t[u*3+1]>=a.minHeight,E=t[d*3+1]>=a.minHeight;p&&g&&E&&(e.push(f),e.push(u),e.push(d)),t[_*3+1]>=a.minHeight&&p&&E&&(e.push(_),e.push(f),e.push(d))}ee.ComputeNormals(t,e,i);const h=new ee;return h.indices=e,h.positions=t,h.normals=i,h.uvs=r,h}function za(a,e={},t){const i=new Wn(a,t);return i._setReady(!1),i._subdivisionsX=e.subdivisionsX||e.subdivisions||1,i._subdivisionsY=e.subdivisionsY||e.subdivisions||1,i._width=e.width||1,i._height=e.height||1,i._maxX=i._width/2,i._maxZ=i._height/2,i._minX=-i._maxX,i._minZ=-i._maxZ,hg(e).applyToMesh(i,e.updatable),i._setReady(!0),i}function dg(a,e,t=null){const i=new N(a,t);return fg(e).applyToMesh(i,e.updatable),i}function _g(a,e,t={},i=null){const r=t.width||10,s=t.height||10,n=t.subdivisions||1,o=t.minHeight||0,l=t.maxHeight||1,c=t.colorFilter||new ae(.3,.59,.11),h=t.alphaFilter||0,f=t.updatable,u=t.onReady;i=i||Re.LastCreatedScene;const d=new Wn(a,i);d._subdivisionsX=n,d._subdivisionsY=n,d._width=r,d._height=s,d._maxX=d._width/2,d._maxZ=d._height/2,d._minX=-d._maxX,d._minZ=-d._maxZ,d._setReady(!1);let _;t.passHeightBufferInCallback&&(_=new Float32Array((n+1)*(n+1)));const p=(g,E,v)=>{ug({width:r,height:s,subdivisions:n,minHeight:o,maxHeight:l,colorFilter:c,buffer:g,bufferWidth:E,bufferHeight:v,alphaFilter:h,heightBuffer:_}).applyToMesh(d,f),u&&u(d,_),d._setReady(!0)};if(typeof e=="string"){const g=E=>{const v=E.width,b=E.height;if(i.isDisposed)return;const R=i==null?void 0:i.getEngine().resizeImageBitmap(E,v,b);p(R,v,b)};k.LoadImage(e,g,t.onError?t.onError:()=>{},i.offlineProvider)}else p(e.data,e.width,e.height);return d}ee.CreateGround=hg;ee.CreateTiledGround=fg;ee.CreateGroundFromHeightMap=ug;N.CreateGround=(a,e,t,i,r,s)=>za(a,{width:e,height:t,subdivisions:i,updatable:s},r);N.CreateTiledGround=(a,e,t,i,r,s,n,o,l)=>dg(a,{xmin:e,zmin:t,xmax:i,zmax:r,subdivisions:s,precision:n,updatable:l},o);N.CreateGroundFromHeightMap=(a,e,t,i,r,s,n,o,l,c,h)=>_g(a,e,{width:t,height:i,subdivisions:r,minHeight:s,maxHeight:n,updatable:l,onReady:c,alphaFilter:h},o);function pg(a){let t=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];const i=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],r=[];let s=[];const n=a.width||a.size||1,o=a.height||a.size||1,l=a.depth||a.size||1,c=a.wrap||!1;let h=a.topBaseAt===void 0?1:a.topBaseAt,f=a.bottomBaseAt===void 0?0:a.bottomBaseAt;h=(h+4)%4,f=(f+4)%4;const u=[2,0,3,1],d=[2,0,1,3];let _=u[h],p=d[f],g=[1,-1,1,-1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,-1,-1,-1,1];if(c){t=[2,3,0,2,0,1,4,5,6,4,6,7,9,10,11,9,11,8,12,14,15,12,13,14],g=[-1,1,1,1,1,1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1];let I=[[1,1,1],[-1,1,1],[-1,1,-1],[1,1,-1]],O=[[-1,-1,1],[1,-1,1],[1,-1,-1],[-1,-1,-1]];const L=[17,18,19,16],w=[22,23,20,21];for(;_>0;)I.unshift(I.pop()),L.unshift(L.pop()),_--;for(;p>0;)O.unshift(O.pop()),w.unshift(w.pop()),p--;I=I.flat(),O=O.flat(),g=g.concat(I).concat(O),t.push(L[0],L[2],L[3],L[0],L[1],L[2]),t.push(w[0],w[2],w[3],w[0],w[1],w[2])}const E=[n/2,o/2,l/2];s=g.reduce((I,O,L)=>I.concat(O*E[L%3]),[]);const v=a.sideOrientation===0?0:a.sideOrientation||ee.DEFAULTSIDE,b=a.faceUV||new Array(6),R=a.faceColors,S=[];for(let I=0;I<6;I++)b[I]===void 0&&(b[I]=new Fe(0,0,1,1)),R&&R[I]===void 0&&(R[I]=new Ne(1,1,1,1));for(let I=0;I<6;I++)if(r.push(b[I].z,b[I].w),r.push(b[I].x,b[I].w),r.push(b[I].x,b[I].y),r.push(b[I].z,b[I].y),R)for(let O=0;O<4;O++)S.push(R[I].r,R[I].g,R[I].b,R[I].a);ee._ComputeSides(v,s,t,i,r,a.frontUVs,a.backUVs);const T=new ee;if(T.indices=t,T.positions=s,T.normals=i,T.uvs=r,R){const I=v===ee.DOUBLESIDE?S.concat(S):S;T.colors=I}return T}function Ya(a,e={},t=null){const i=new N(a,t);return e.sideOrientation=N._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,pg(e).applyToMesh(i,e.updatable),i}ee.CreateBox=pg;N.CreateBox=(a,e,t=null,i,r)=>Ya(a,{size:e,sideOrientation:r,updatable:i},t);class As{static _GetDefaultOptions(e){return{createGround:!0,groundSize:15,groundTexture:k.GetAssetUrl(this._GroundTextureCDNUrl),groundColor:new ae(.2,.2,.3).toLinearSpace(e.getEngine().useExactSrgbConversions).scale(3),groundOpacity:.9,enableGroundShadow:!0,groundShadowLevel:.5,enableGroundMirror:!1,groundMirrorSizeRatio:.3,groundMirrorBlurKernel:64,groundMirrorAmount:1,groundMirrorFresnelWeight:1,groundMirrorFallOffDistance:0,groundMirrorTextureType:0,groundYBias:1e-5,createSkybox:!0,skyboxSize:20,skyboxTexture:k.GetAssetUrl(this._SkyboxTextureCDNUrl),skyboxColor:new ae(.2,.2,.3).toLinearSpace(e.getEngine().useExactSrgbConversions).scale(3),backgroundYRotation:0,sizeAuto:!0,rootPosition:m.Zero(),setupImageProcessing:!0,environmentTexture:k.GetAssetUrl(this._EnvironmentTextureCDNUrl),cameraExposure:.8,cameraContrast:1.2,toneMappingEnabled:!0}}get rootMesh(){return this._rootMesh}get skybox(){return this._skybox}get skyboxTexture(){return this._skyboxTexture}get skyboxMaterial(){return this._skyboxMaterial}get ground(){return this._ground}get groundTexture(){return this._groundTexture}get groundMirror(){return this._groundMirror}get groundMirrorRenderList(){return this._groundMirror?this._groundMirror.renderList:null}get groundMaterial(){return this._groundMaterial}constructor(e,t){this._errorHandler=(i,r)=>{this.onErrorObservable.notifyObservers({message:i,exception:r})},this._options={...As._GetDefaultOptions(t),...e},this._scene=t,this.onErrorObservable=new U,this._setupBackground(),this._setupImageProcessing()}updateOptions(e){const t={...this._options,...e};this._ground&&!t.createGround&&(this._ground.dispose(),this._ground=null),this._groundMaterial&&!t.createGround&&(this._groundMaterial.dispose(),this._groundMaterial=null),this._groundTexture&&this._options.groundTexture!=t.groundTexture&&(this._groundTexture.dispose(),this._groundTexture=null),this._skybox&&!t.createSkybox&&(this._skybox.dispose(),this._skybox=null),this._skyboxMaterial&&!t.createSkybox&&(this._skyboxMaterial.dispose(),this._skyboxMaterial=null),this._skyboxTexture&&this._options.skyboxTexture!=t.skyboxTexture&&(this._skyboxTexture.dispose(),this._skyboxTexture=null),this._groundMirror&&!t.enableGroundMirror&&(this._groundMirror.dispose(),this._groundMirror=null),this._scene.environmentTexture&&this._options.environmentTexture!=t.environmentTexture&&this._scene.environmentTexture.dispose(),this._options=t,this._setupBackground(),this._setupImageProcessing()}setMainColor(e){this.groundMaterial&&(this.groundMaterial.primaryColor=e),this.skyboxMaterial&&(this.skyboxMaterial.primaryColor=e),this.groundMirror&&(this.groundMirror.clearColor=new Ne(e.r,e.g,e.b,1))}_setupImageProcessing(){this._options.setupImageProcessing&&(this._scene.imageProcessingConfiguration.contrast=this._options.cameraContrast,this._scene.imageProcessingConfiguration.exposure=this._options.cameraExposure,this._scene.imageProcessingConfiguration.toneMappingEnabled=this._options.toneMappingEnabled,this._setupEnvironmentTexture())}_setupEnvironmentTexture(){if(this._scene.environmentTexture)return;if(this._options.environmentTexture instanceof rt){this._scene.environmentTexture=this._options.environmentTexture;return}const e=Jt.CreateFromPrefilteredData(this._options.environmentTexture,this._scene);this._scene.environmentTexture=e}_setupBackground(){this._rootMesh||(this._rootMesh=new N("BackgroundHelper",this._scene)),this._rootMesh.rotation.y=this._options.backgroundYRotation;const e=this._getSceneSize();this._options.createGround&&(this._setupGround(e),this._setupGroundMaterial(),this._setupGroundDiffuseTexture(),this._options.enableGroundMirror&&this._setupGroundMirrorTexture(e),this._setupMirrorInGroundMaterial()),this._options.createSkybox&&(this._setupSkybox(e),this._setupSkyboxMaterial(),this._setupSkyboxReflectionTexture()),this._rootMesh.position.x=e.rootPosition.x,this._rootMesh.position.z=e.rootPosition.z,this._rootMesh.position.y=e.rootPosition.y}_getSceneSize(){let e=this._options.groundSize,t=this._options.skyboxSize,i=this._options.rootPosition;if(!this._scene.meshes||this._scene.meshes.length===1)return{groundSize:e,skyboxSize:t,rootPosition:i};const r=this._scene.getWorldExtends(n=>n!==this._ground&&n!==this._rootMesh&&n!==this._skybox),s=r.max.subtract(r.min);if(this._options.sizeAuto){this._scene.activeCamera instanceof dt&&this._scene.activeCamera.upperRadiusLimit&&(e=this._scene.activeCamera.upperRadiusLimit*2,t=e);const n=s.length();n>e&&(e=n*2,t=e),e*=1.1,t*=1.5,i=r.min.add(s.scale(.5)),i.y=r.min.y-this._options.groundYBias}return{groundSize:e,skyboxSize:t,rootPosition:i}}_setupGround(e){(!this._ground||this._ground.isDisposed())&&(this._ground=Vc("BackgroundPlane",{size:e.groundSize},this._scene),this._ground.rotation.x=Math.PI/2,this._ground.isPickable=!1,this._ground.parent=this._rootMesh,this._ground.onDisposeObservable.add(()=>{this._ground=null})),this._ground.receiveShadows=this._options.enableGroundShadow}_setupGroundMaterial(){this._groundMaterial||(this._groundMaterial=new Xe("BackgroundPlaneMaterial",this._scene)),this._groundMaterial.alpha=this._options.groundOpacity,this._groundMaterial.alphaMode=8,this._groundMaterial.shadowLevel=this._options.groundShadowLevel,this._groundMaterial.primaryColor=this._options.groundColor,this._groundMaterial.useRGBColor=!1,this._groundMaterial.enableNoise=!0,this._ground&&(this._ground.material=this._groundMaterial)}_setupGroundDiffuseTexture(){if(this._groundMaterial&&!this._groundTexture){if(this._options.groundTexture instanceof rt){this._groundMaterial.diffuseTexture=this._options.groundTexture;return}this._groundTexture=new Z(this._options.groundTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._groundTexture.gammaSpace=!1,this._groundTexture.hasAlpha=!0,this._groundMaterial.diffuseTexture=this._groundTexture}}_setupGroundMirrorTexture(e){const t=Z.CLAMP_ADDRESSMODE;if(!this._groundMirror&&(this._groundMirror=new Ha("BackgroundPlaneMirrorTexture",{ratio:this._options.groundMirrorSizeRatio},this._scene,!1,this._options.groundMirrorTextureType,Z.BILINEAR_SAMPLINGMODE,!0),this._groundMirror.mirrorPlane=new hi(0,-1,0,e.rootPosition.y),this._groundMirror.anisotropicFilteringLevel=1,this._groundMirror.wrapU=t,this._groundMirror.wrapV=t,this._groundMirror.renderList))for(let r=0;r<this._scene.meshes.length;r++){const s=this._scene.meshes[r];s!==this._ground&&s!==this._skybox&&s!==this._rootMesh&&this._groundMirror.renderList.push(s)}const i=this._options.groundColor.toGammaSpace(this._scene.getEngine().useExactSrgbConversions);this._groundMirror.clearColor=new Ne(i.r,i.g,i.b,1),this._groundMirror.adaptiveBlurKernel=this._options.groundMirrorBlurKernel}_setupMirrorInGroundMaterial(){this._groundMaterial&&(this._groundMaterial.reflectionTexture=this._groundMirror,this._groundMaterial.reflectionFresnel=!0,this._groundMaterial.reflectionAmount=this._options.groundMirrorAmount,this._groundMaterial.reflectionStandardFresnelWeight=this._options.groundMirrorFresnelWeight,this._groundMaterial.reflectionFalloffDistance=this._options.groundMirrorFallOffDistance)}_setupSkybox(e){(!this._skybox||this._skybox.isDisposed())&&(this._skybox=Ya("BackgroundSkybox",{size:e.skyboxSize,sideOrientation:N.BACKSIDE},this._scene),this._skybox.isPickable=!1,this._skybox.onDisposeObservable.add(()=>{this._skybox=null})),this._skybox.parent=this._rootMesh}_setupSkyboxMaterial(){this._skybox&&(this._skyboxMaterial||(this._skyboxMaterial=new Xe("BackgroundSkyboxMaterial",this._scene)),this._skyboxMaterial.useRGBColor=!1,this._skyboxMaterial.primaryColor=this._options.skyboxColor,this._skyboxMaterial.enableNoise=!0,this._skybox.material=this._skyboxMaterial)}_setupSkyboxReflectionTexture(){if(this._skyboxMaterial&&!this._skyboxTexture){if(this._options.skyboxTexture instanceof rt){this._skyboxMaterial.reflectionTexture=this._options.skyboxTexture;return}this._skyboxTexture=new Jt(this._options.skyboxTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._skyboxTexture.coordinatesMode=Z.SKYBOX_MODE,this._skyboxTexture.gammaSpace=!1,this._skyboxMaterial.reflectionTexture=this._skyboxTexture}}dispose(){this._groundMaterial&&this._groundMaterial.dispose(!0,!0),this._skyboxMaterial&&this._skyboxMaterial.dispose(!0,!0),this._rootMesh.dispose(!1)}}As._GroundTextureCDNUrl="https://assets.babylonjs.com/core/environments/backgroundGround.png";As._SkyboxTextureCDNUrl="https://assets.babylonjs.com/core/environments/backgroundSkybox.dds";As._EnvironmentTextureCDNUrl="https://assets.babylonjs.com/core/environments/environmentSpecular.env";class ki{constructor(){this.keysUp=[38],this.keysUpward=[33],this.keysDown=[40],this.keysDownward=[34],this.keysLeft=[37],this.keysRight=[39],this.rotationSpeed=.5,this.keysRotateLeft=[],this.keysRotateRight=[],this.keysRotateUp=[],this.keysRotateDown=[],this._keys=new Array}attachControl(e){e=k.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const i=t.event;if(!i.metaKey){if(t.type===Qs.KEYDOWN)(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysUpward.indexOf(i.keyCode)!==-1||this.keysDownward.indexOf(i.keyCode)!==-1||this.keysRotateLeft.indexOf(i.keyCode)!==-1||this.keysRotateRight.indexOf(i.keyCode)!==-1||this.keysRotateUp.indexOf(i.keyCode)!==-1||this.keysRotateDown.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),e||i.preventDefault());else if(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysUpward.indexOf(i.keyCode)!==-1||this.keysDownward.indexOf(i.keyCode)!==-1||this.keysRotateLeft.indexOf(i.keyCode)!==-1||this.keysRotateRight.indexOf(i.keyCode)!==-1||this.keysRotateUp.indexOf(i.keyCode)!==-1||this.keysRotateDown.indexOf(i.keyCode)!==-1){const r=this._keys.indexOf(i.keyCode);r>=0&&this._keys.splice(r,1),e||i.preventDefault()}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t],r=e._computeLocalCameraSpeed();this.keysLeft.indexOf(i)!==-1?e._localDirection.copyFromFloats(-r,0,0):this.keysUp.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,r):this.keysRight.indexOf(i)!==-1?e._localDirection.copyFromFloats(r,0,0):this.keysDown.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,-r):this.keysUpward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,r,0):this.keysDownward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,-r,0):this.keysRotateLeft.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y-=this._getLocalRotation()):this.keysRotateRight.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y+=this._getLocalRotation()):this.keysRotateUp.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x-=this._getLocalRotation()):this.keysRotateDown.indexOf(i)!==-1&&(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x+=this._getLocalRotation()),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),m.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}getClassName(){return"FreeCameraKeyboardMoveInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}_getLocalRotation(){const e=this.camera._calculateHandednessMultiplier();return this.rotationSpeed*this._engine.getDeltaTime()/1e3*e}}A([y()],ki.prototype,"keysUp",void 0);A([y()],ki.prototype,"keysUpward",void 0);A([y()],ki.prototype,"keysDown",void 0);A([y()],ki.prototype,"keysDownward",void 0);A([y()],ki.prototype,"keysLeft",void 0);A([y()],ki.prototype,"keysRight",void 0);A([y()],ki.prototype,"rotationSpeed",void 0);A([y()],ki.prototype,"keysRotateLeft",void 0);A([y()],ki.prototype,"keysRotateRight",void 0);A([y()],ki.prototype,"keysRotateUp",void 0);A([y()],ki.prototype,"keysRotateDown",void 0);Ki.FreeCameraKeyboardMoveInput=ki;class Ka{constructor(e=!0){this.touchEnabled=e,this.buttons=[0,1,2],this.angularSensibility=2e3,this._previousPosition=null,this.onPointerMovedObservable=new U,this._allowCameraRotation=!0,this._currentActiveButton=-1,this._activePointerId=-1}attachControl(e){e=k.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),i=t.getInputElement();this._pointerInput||(this._pointerInput=r=>{const s=r.event,n=s.pointerType==="touch";if(!this.touchEnabled&&n||r.type!==ge.POINTERMOVE&&this.buttons.indexOf(s.button)===-1)return;const o=s.target;if(r.type===ge.POINTERDOWN){if(n&&this._activePointerId!==-1||!n&&this._currentActiveButton!==-1)return;this._activePointerId=s.pointerId;try{o==null||o.setPointerCapture(s.pointerId)}catch{}this._currentActiveButton===-1&&(this._currentActiveButton=s.button),this._previousPosition={x:s.clientX,y:s.clientY},e||(s.preventDefault(),i&&i.focus()),t.isPointerLock&&this._onMouseMove&&this._onMouseMove(r.event)}else if(r.type===ge.POINTERUP){if(n&&this._activePointerId!==s.pointerId||!n&&this._currentActiveButton!==s.button)return;try{o==null||o.releasePointerCapture(s.pointerId)}catch{}this._currentActiveButton=-1,this._previousPosition=null,e||s.preventDefault(),this._activePointerId=-1}else if(r.type===ge.POINTERMOVE&&(this._activePointerId===s.pointerId||!n)){if(t.isPointerLock&&this._onMouseMove)this._onMouseMove(r.event);else if(this._previousPosition){const l=this.camera._calculateHandednessMultiplier(),c=(s.clientX-this._previousPosition.x)*l,h=s.clientY-this._previousPosition.y;this._allowCameraRotation&&(this.camera.cameraRotation.y+=c/this.angularSensibility,this.camera.cameraRotation.x+=h/this.angularSensibility),this.onPointerMovedObservable.notifyObservers({offsetX:c,offsetY:h}),this._previousPosition={x:s.clientX,y:s.clientY},e||s.preventDefault()}}}),this._onMouseMove=r=>{if(!t.isPointerLock)return;const s=this.camera._calculateHandednessMultiplier(),n=r.movementX*s;this.camera.cameraRotation.y+=n/this.angularSensibility;const o=r.movementY;this.camera.cameraRotation.x+=o/this.angularSensibility,this._previousPosition=null,e||r.preventDefault()},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,ge.POINTERDOWN|ge.POINTERUP|ge.POINTERMOVE),i&&(this._contextMenuBind=r=>this.onContextMenu(r),i.addEventListener("contextmenu",this._contextMenuBind,!1))}onContextMenu(e){e.preventDefault()}detachControl(){if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._contextMenuBind){const t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("contextmenu",this._contextMenuBind)}this.onPointerMovedObservable&&this.onPointerMovedObservable.clear(),this._observer=null,this._onMouseMove=null,this._previousPosition=null}this._activePointerId=-1,this._currentActiveButton=-1}getClassName(){return"FreeCameraMouseInput"}getSimpleName(){return"mouse"}}A([y()],Ka.prototype,"buttons",void 0);A([y()],Ka.prototype,"angularSensibility",void 0);Ki.FreeCameraMouseInput=Ka;class qa{constructor(){this.wheelPrecisionX=3,this.wheelPrecisionY=3,this.wheelPrecisionZ=3,this.onChangedObservable=new U,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._ffMultiplier=12,this._normalize=120}attachControl(e){e=k.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==ge.POINTERWHEEL)return;const i=t.event,r=i.deltaMode===sn.DOM_DELTA_LINE?this._ffMultiplier:1;this._wheelDeltaX+=this.wheelPrecisionX*r*i.deltaX/this._normalize,this._wheelDeltaY-=this.wheelPrecisionY*r*i.deltaY/this._normalize,this._wheelDeltaZ+=this.wheelPrecisionZ*r*i.deltaZ/this._normalize,i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,ge.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null),this.onChangedObservable&&this.onChangedObservable.clear()}checkInputs(){this.onChangedObservable.notifyObservers({wheelDeltaX:this._wheelDeltaX,wheelDeltaY:this._wheelDeltaY,wheelDeltaZ:this._wheelDeltaZ}),this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0}getClassName(){return"BaseCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}}A([y()],qa.prototype,"wheelPrecisionX",void 0);A([y()],qa.prototype,"wheelPrecisionY",void 0);A([y()],qa.prototype,"wheelPrecisionZ",void 0);var ct;(function(a){a[a.MoveRelative=0]="MoveRelative",a[a.RotateRelative=1]="RotateRelative",a[a.MoveScene=2]="MoveScene"})(ct||(ct={}));class ar extends qa{constructor(){super(...arguments),this._moveRelative=m.Zero(),this._rotateRelative=m.Zero(),this._moveScene=m.Zero(),this._wheelXAction=ct.MoveRelative,this._wheelXActionCoordinate=0,this._wheelYAction=ct.MoveRelative,this._wheelYActionCoordinate=2,this._wheelZAction=null,this._wheelZActionCoordinate=null}getClassName(){return"FreeCameraMouseWheelInput"}set wheelXMoveRelative(e){e===null&&this._wheelXAction!==ct.MoveRelative||(this._wheelXAction=ct.MoveRelative,this._wheelXActionCoordinate=e)}get wheelXMoveRelative(){return this._wheelXAction!==ct.MoveRelative?null:this._wheelXActionCoordinate}set wheelYMoveRelative(e){e===null&&this._wheelYAction!==ct.MoveRelative||(this._wheelYAction=ct.MoveRelative,this._wheelYActionCoordinate=e)}get wheelYMoveRelative(){return this._wheelYAction!==ct.MoveRelative?null:this._wheelYActionCoordinate}set wheelZMoveRelative(e){e===null&&this._wheelZAction!==ct.MoveRelative||(this._wheelZAction=ct.MoveRelative,this._wheelZActionCoordinate=e)}get wheelZMoveRelative(){return this._wheelZAction!==ct.MoveRelative?null:this._wheelZActionCoordinate}set wheelXRotateRelative(e){e===null&&this._wheelXAction!==ct.RotateRelative||(this._wheelXAction=ct.RotateRelative,this._wheelXActionCoordinate=e)}get wheelXRotateRelative(){return this._wheelXAction!==ct.RotateRelative?null:this._wheelXActionCoordinate}set wheelYRotateRelative(e){e===null&&this._wheelYAction!==ct.RotateRelative||(this._wheelYAction=ct.RotateRelative,this._wheelYActionCoordinate=e)}get wheelYRotateRelative(){return this._wheelYAction!==ct.RotateRelative?null:this._wheelYActionCoordinate}set wheelZRotateRelative(e){e===null&&this._wheelZAction!==ct.RotateRelative||(this._wheelZAction=ct.RotateRelative,this._wheelZActionCoordinate=e)}get wheelZRotateRelative(){return this._wheelZAction!==ct.RotateRelative?null:this._wheelZActionCoordinate}set wheelXMoveScene(e){e===null&&this._wheelXAction!==ct.MoveScene||(this._wheelXAction=ct.MoveScene,this._wheelXActionCoordinate=e)}get wheelXMoveScene(){return this._wheelXAction!==ct.MoveScene?null:this._wheelXActionCoordinate}set wheelYMoveScene(e){e===null&&this._wheelYAction!==ct.MoveScene||(this._wheelYAction=ct.MoveScene,this._wheelYActionCoordinate=e)}get wheelYMoveScene(){return this._wheelYAction!==ct.MoveScene?null:this._wheelYActionCoordinate}set wheelZMoveScene(e){e===null&&this._wheelZAction!==ct.MoveScene||(this._wheelZAction=ct.MoveScene,this._wheelZActionCoordinate=e)}get wheelZMoveScene(){return this._wheelZAction!==ct.MoveScene?null:this._wheelZActionCoordinate}checkInputs(){if(this._wheelDeltaX===0&&this._wheelDeltaY===0&&this._wheelDeltaZ==0)return;this._moveRelative.setAll(0),this._rotateRelative.setAll(0),this._moveScene.setAll(0),this._updateCamera(),this.camera.getScene().useRightHandedSystem&&(this._moveRelative.z*=-1);const e=P.Zero();this.camera.getViewMatrix().invertToRef(e);const t=m.Zero();m.TransformNormalToRef(this._moveRelative,e,t),this.camera.cameraRotation.x+=this._rotateRelative.x/200,this.camera.cameraRotation.y+=this._rotateRelative.y/200,this.camera.cameraDirection.addInPlace(t),this.camera.cameraDirection.addInPlace(this._moveScene),super.checkInputs()}_updateCamera(){this._updateCameraProperty(this._wheelDeltaX,this._wheelXAction,this._wheelXActionCoordinate),this._updateCameraProperty(this._wheelDeltaY,this._wheelYAction,this._wheelYActionCoordinate),this._updateCameraProperty(this._wheelDeltaZ,this._wheelZAction,this._wheelZActionCoordinate)}_updateCameraProperty(e,t,i){if(e===0||t===null||i===null)return;let r=null;switch(t){case ct.MoveRelative:r=this._moveRelative;break;case ct.RotateRelative:r=this._rotateRelative;break;case ct.MoveScene:r=this._moveScene;break}switch(i){case 0:r.set(e,0,0);break;case 1:r.set(0,e,0);break;case 2:r.set(0,0,e);break}}}A([y()],ar.prototype,"wheelXMoveRelative",null);A([y()],ar.prototype,"wheelYMoveRelative",null);A([y()],ar.prototype,"wheelZMoveRelative",null);A([y()],ar.prototype,"wheelXRotateRelative",null);A([y()],ar.prototype,"wheelYRotateRelative",null);A([y()],ar.prototype,"wheelZRotateRelative",null);A([y()],ar.prototype,"wheelXMoveScene",null);A([y()],ar.prototype,"wheelYMoveScene",null);A([y()],ar.prototype,"wheelZMoveScene",null);Ki.FreeCameraMouseWheelInput=ar;class ja{constructor(e=!1){this.allowMouse=e,this.touchAngularSensibility=2e5,this.touchMoveSensibility=250,this.singleFingerRotate=!1,this._offsetX=null,this._offsetY=null,this._pointerPressed=new Array,this._isSafari=k.IsSafari()}attachControl(e){e=k.BackCompatCameraNoPreventDefault(arguments);let t=null;if(this._pointerInput===void 0&&(this._onLostFocus=()=>{this._offsetX=null,this._offsetY=null},this._pointerInput=i=>{const r=i.event,s=r.pointerType==="mouse"||this._isSafari&&typeof r.pointerType>"u";if(!(!this.allowMouse&&s)){if(i.type===ge.POINTERDOWN){if(e||r.preventDefault(),this._pointerPressed.push(r.pointerId),this._pointerPressed.length!==1)return;t={x:r.clientX,y:r.clientY}}else if(i.type===ge.POINTERUP){e||r.preventDefault();const n=this._pointerPressed.indexOf(r.pointerId);if(n===-1||(this._pointerPressed.splice(n,1),n!=0))return;t=null,this._offsetX=null,this._offsetY=null}else if(i.type===ge.POINTERMOVE){if(e||r.preventDefault(),!t||this._pointerPressed.indexOf(r.pointerId)!=0)return;this._offsetX=r.clientX-t.x,this._offsetY=-(r.clientY-t.y)}}}),this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,ge.POINTERDOWN|ge.POINTERUP|ge.POINTERMOVE),this._onLostFocus){const r=this.camera.getEngine().getInputElement();r&&r.addEventListener("blur",this._onLostFocus)}}detachControl(){if(this._pointerInput){if(this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null),this._onLostFocus){const t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null}this._pointerPressed.length=0,this._offsetX=null,this._offsetY=null}}checkInputs(){if(this._offsetX===null||this._offsetY===null||this._offsetX===0&&this._offsetY===0)return;const e=this.camera,t=e._calculateHandednessMultiplier();if(e.cameraRotation.y=t*this._offsetX/this.touchAngularSensibility,this.singleFingerRotate&&this._pointerPressed.length===1||!this.singleFingerRotate&&this._pointerPressed.length>1)e.cameraRotation.x=-this._offsetY/this.touchAngularSensibility;else{const r=e._computeLocalCameraSpeed(),s=new m(0,0,this.touchMoveSensibility!==0?r*this._offsetY/this.touchMoveSensibility:0);P.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,e._cameraRotationMatrix),e.cameraDirection.addInPlace(m.TransformCoordinates(s,e._cameraRotationMatrix))}}getClassName(){return"FreeCameraTouchInput"}getSimpleName(){return"touch"}}A([y()],ja.prototype,"touchAngularSensibility",void 0);A([y()],ja.prototype,"touchMoveSensibility",void 0);Ki.FreeCameraTouchInput=ja;class Gc extends ag{constructor(e){super(e),this._mouseInput=null,this._mouseWheelInput=null}addKeyboard(){return this.add(new ki),this}addMouse(e=!0){return this._mouseInput||(this._mouseInput=new Ka(e),this.add(this._mouseInput)),this}removeMouse(){return this._mouseInput&&this.remove(this._mouseInput),this}addMouseWheel(){return this._mouseWheelInput||(this._mouseWheelInput=new ar,this.add(this._mouseWheelInput)),this}removeMouseWheel(){return this._mouseWheelInput&&this.remove(this._mouseWheelInput),this}addTouch(){return this.add(new ja),this}clear(){super.clear(),this._mouseInput=null}}class sr extends Dt{get angularSensibility(){const e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){const t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysUpward(){const e=this.inputs.attached.keyboard;return e?e.keysUpward:[]}set keysUpward(e){const t=this.inputs.attached.keyboard;t&&(t.keysUpward=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysDownward(){const e=this.inputs.attached.keyboard;return e?e.keysDownward:[]}set keysDownward(e){const t=this.inputs.attached.keyboard;t&&(t.keysDownward=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get keysRotateLeft(){const e=this.inputs.attached.keyboard;return e?e.keysRotateLeft:[]}set keysRotateLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateLeft=e)}get keysRotateRight(){const e=this.inputs.attached.keyboard;return e?e.keysRotateRight:[]}set keysRotateRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateRight=e)}get keysRotateUp(){const e=this.inputs.attached.keyboard;return e?e.keysRotateUp:[]}set keysRotateUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateUp=e)}get keysRotateDown(){const e=this.inputs.attached.keyboard;return e?e.keysRotateDown:[]}set keysRotateDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateDown=e)}constructor(e,t,i,r=!0){super(e,t,i,r),this.ellipsoid=new m(.5,1,.5),this.ellipsoidOffset=new m(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this._needMoveForGravity=!1,this._oldPosition=m.Zero(),this._diffPosition=m.Zero(),this._newPosition=m.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(s,n,o=null)=>{this._newPosition.copyFrom(n),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>H.CollisionsEpsilon&&(this.position.addToRef(this._diffPosition,this._deferredPositionUpdate),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate),this.onCollide&&o&&this.onCollide(o))},this.inputs=new Gc(this),this.inputs.addKeyboard().addMouse()}attachControl(e,t){t=k.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new m(0,0,0),this.cameraRotation=new ne(0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;this.parent?t=m.TransformCoordinates(this.position,this.parent.getWorldMatrix()):t=this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);const i=this.getScene().collisionCoordinator;this._collider||(this._collider=i.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let r=e;this.applyGravity&&(r=e.add(this.getScene().gravity)),i.getNewPosition(this._oldPosition,r,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=m.Zero(),this._transformedDirection=m.Zero()),this.inputs.checkInputs(),super._checkInputs()}set needMoveForGravity(e){this._needMoveForGravity=e}get needMoveForGravity(){return this._needMoveForGravity}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FreeCamera"}}A([di()],sr.prototype,"ellipsoid",void 0);A([di()],sr.prototype,"ellipsoidOffset",void 0);A([y()],sr.prototype,"checkCollisions",void 0);A([y()],sr.prototype,"applyGravity",void 0);Y("BABYLON.FreeCamera",sr);Gc.prototype.addDeviceOrientation=function(a){return this._deviceOrientationInput||(this._deviceOrientationInput=new mg,a&&(this._deviceOrientationInput.smoothFactor=a),this.add(this._deviceOrientationInput)),this};class mg{static WaitForOrientationChangeAsync(e){return new Promise((t,i)=>{let r=!1;const s=()=>{window.removeEventListener("deviceorientation",s),r=!0,t()};e&&setTimeout(()=>{r||(window.removeEventListener("deviceorientation",s),i("WaitForOrientationChangeAsync timed out"))},e),typeof DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(n=>{n=="granted"?window.addEventListener("deviceorientation",s):k.Warn("Permission not granted.")}).catch(n=>{k.Error(n)}):window.addEventListener("deviceorientation",s)})}constructor(){this._screenOrientationAngle=0,this._screenQuaternion=new z,this._alpha=0,this._beta=0,this._gamma=0,this.smoothFactor=0,this._onDeviceOrientationChangedObservable=new U,this._orientationChanged=()=>{this._screenOrientationAngle=window.orientation!==void 0?+window.orientation:window.screen.orientation&&window.screen.orientation.angle?window.screen.orientation.angle:0,this._screenOrientationAngle=-k.ToRadians(this._screenOrientationAngle/2),this._screenQuaternion.copyFromFloats(0,Math.sin(this._screenOrientationAngle),0,Math.cos(this._screenOrientationAngle))},this._deviceOrientation=e=>{this.smoothFactor?(this._alpha=e.alpha!==null?k.SmoothAngleChange(this._alpha,e.alpha,this.smoothFactor):0,this._beta=e.beta!==null?k.SmoothAngleChange(this._beta,e.beta,this.smoothFactor):0,this._gamma=e.gamma!==null?k.SmoothAngleChange(this._gamma,e.gamma,this.smoothFactor):0):(this._alpha=e.alpha!==null?e.alpha:0,this._beta=e.beta!==null?e.beta:0,this._gamma=e.gamma!==null?e.gamma:0),e.alpha!==null&&this._onDeviceOrientationChangedObservable.notifyObservers()},this._constantTransform=new z(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this._orientationChanged()}get camera(){return this._camera}set camera(e){this._camera=e,this._camera!=null&&!this._camera.rotationQuaternion&&(this._camera.rotationQuaternion=new z),this._camera&&this._camera.onDisposeObservable.add(()=>{this._onDeviceOrientationChangedObservable.clear()})}attachControl(){const e=this.camera.getScene().getEngine().getHostWindow();if(e){const t=()=>{e.addEventListener("orientationchange",this._orientationChanged),e.addEventListener("deviceorientation",this._deviceOrientation),this._orientationChanged()};typeof DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(i=>{i==="granted"?t():k.Warn("Permission not granted.")}).catch(i=>{k.Error(i)}):t()}}detachControl(){window.removeEventListener("orientationchange",this._orientationChanged),window.removeEventListener("deviceorientation",this._deviceOrientation),this._alpha=0}checkInputs(){this._alpha&&(z.RotationYawPitchRollToRef(k.ToRadians(this._alpha),k.ToRadians(this._beta),-k.ToRadians(this._gamma),this.camera.rotationQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._screenQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._constantTransform),this._camera.getScene().useRightHandedSystem?this._camera.rotationQuaternion.y*=-1:this._camera.rotationQuaternion.z*=-1,this._camera.rotationQuaternion.w*=-1)}getClassName(){return"FreeCameraDeviceOrientationInput"}getSimpleName(){return"deviceOrientation"}}Ki.FreeCameraDeviceOrientationInput=mg;gt.AddNodeConstructor("DeviceOrientationCamera",(a,e)=>()=>new kc(a,m.Zero(),e));class kc extends sr{constructor(e,t,i){super(e,t,i),this._tmpDragQuaternion=new z,this._disablePointerInputWhenUsingDeviceOrientation=!0,this._dragFactor=0,this._quaternionCache=new z,this.inputs.addDeviceOrientation(),this.inputs._deviceOrientationInput&&this.inputs._deviceOrientationInput._onDeviceOrientationChangedObservable.addOnce(()=>{this._disablePointerInputWhenUsingDeviceOrientation&&this.inputs._mouseInput&&(this.inputs._mouseInput._allowCameraRotation=!1,this.inputs._mouseInput.onPointerMovedObservable.add(r=>{this._dragFactor!=0&&(this._initialQuaternion||(this._initialQuaternion=new z),z.FromEulerAnglesToRef(0,r.offsetX*this._dragFactor,0,this._tmpDragQuaternion),this._initialQuaternion.multiplyToRef(this._tmpDragQuaternion,this._initialQuaternion))}))})}get disablePointerInputWhenUsingDeviceOrientation(){return this._disablePointerInputWhenUsingDeviceOrientation}set disablePointerInputWhenUsingDeviceOrientation(e){this._disablePointerInputWhenUsingDeviceOrientation=e}enableHorizontalDragging(e=1/300){this._dragFactor=e}getClassName(){return"DeviceOrientationCamera"}_checkInputs(){super._checkInputs(),this._quaternionCache.copyFrom(this.rotationQuaternion),this._initialQuaternion&&this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}resetToCurrentRotation(e=Vi.Y){this.rotationQuaternion&&(this._initialQuaternion||(this._initialQuaternion=new z),this._initialQuaternion.copyFrom(this._quaternionCache||this.rotationQuaternion),["x","y","z"].forEach(t=>{e[t]?this._initialQuaternion[t]*=-1:this._initialQuaternion[t]=0}),this._initialQuaternion.normalize(),this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion))}}class Za{constructor(){this.compensateDistortion=!0,this.multiviewEnabled=!1}get aspectRatio(){return this.hResolution/(2*this.vResolution)}get aspectRatioFov(){return 2*Math.atan(this.postProcessScaleFactor*this.vScreenSize/(2*this.eyeToScreenDistance))}get leftHMatrix(){const t=4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize;return P.Translation(t,0,0)}get rightHMatrix(){const t=4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize;return P.Translation(-t,0,0)}get leftPreViewMatrix(){return P.Translation(.5*this.interpupillaryDistance,0,0)}get rightPreViewMatrix(){return P.Translation(-.5*this.interpupillaryDistance,0,0)}static GetDefault(){const e=new Za;return e.hResolution=1280,e.vResolution=800,e.hScreenSize=.149759993,e.vScreenSize=.0935999975,e.vScreenCenter=.0467999987,e.eyeToScreenDistance=.0410000011,e.lensSeparationDistance=.063500002,e.interpupillaryDistance=.064000003,e.distortionK=[1,.219999999,.239999995,0],e.chromaAbCorrection=[.995999992,-.00400000019,1.01400006,0],e.postProcessScaleFactor=1.714605507808412,e.lensCenterOffset=.151976421,e}}class rf extends At{getClassName(){return"VRDistortionCorrectionPostProcess"}constructor(e,t,i,r){super(e,"vrDistortionCorrection",["LensCenter","Scale","ScaleIn","HmdWarpParam"],null,r.postProcessScaleFactor,t,Z.BILINEAR_SAMPLINGMODE),this._isRightEye=i,this._distortionFactors=r.distortionK,this._postProcessScaleFactor=r.postProcessScaleFactor,this._lensCenterOffset=r.lensCenterOffset,this.adaptScaleToCurrentViewport=!0,this.onSizeChangedObservable.add(()=>{this._scaleIn=new ne(2,2/this.aspectRatio),this._scaleFactor=new ne(.5*(1/this._postProcessScaleFactor),.5*(1/this._postProcessScaleFactor)*this.aspectRatio),this._lensCenter=new ne(this._isRightEye?.5-this._lensCenterOffset*.5:.5+this._lensCenterOffset*.5,.5)}),this.onApplyObservable.add(s=>{s.setFloat2("LensCenter",this._lensCenter.x,this._lensCenter.y),s.setFloat2("Scale",this._scaleFactor.x,this._scaleFactor.y),s.setFloat2("ScaleIn",this._scaleIn.x,this._scaleIn.y),s.setFloat4("HmdWarpParam",this._distortionFactors[0],this._distortionFactors[1],this._distortionFactors[2],this._distortionFactors[3])})}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(X(()=>Promise.resolve().then(()=>gD),void 0,import.meta.url))):t.push(X(()=>Promise.resolve().then(()=>vD),void 0,import.meta.url)),super._gatherImports(e,t)}}const sf="vrMultiviewToSingleviewPixelShader",yC=`precision mediump sampler2DArray;varying vec2 vUV;uniform sampler2DArray multiviewSampler;uniform int imageIndex;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{gl_FragColor=texture2D(multiviewSampler,vec3(vUV,imageIndex));}`;C.ShadersStore[sf]||(C.ShadersStore[sf]=yC);class fl extends rr{set samples(e){this._samples=e}get samples(){return this._samples}constructor(e,t=512){super("multiview rtt",t,e,!1,!0,0,!1,void 0,!1,!1,!0,void 0,!0),this._renderTarget=this.getScene().getEngine().createMultiviewRenderTargetTexture(this.getRenderWidth(),this.getRenderHeight()),this._texture=this._renderTarget.texture,this._texture.isMultiview=!0,this._texture.format=5,this.samples=this._getEngine().getCaps().maxSamples||this.samples,this._texture.samples=this._samples}_bindFrameBuffer(){this._renderTarget&&this.getScene().getEngine().bindMultiviewFramebuffer(this._renderTarget)}getViewCount(){return 2}}he.prototype.createMultiviewRenderTargetTexture=function(a,e,t,i){const r=this._gl;if(!this.getCaps().multiview)throw"Multiview is not supported";const s=this._createHardwareRenderTargetWrapper(!1,!1,{width:a,height:e});s._framebuffer=r.createFramebuffer();const n=new Yt(this,0,!0);return n.width=a,n.height=e,n.isMultiview=!0,t||(t=r.createTexture(),r.bindTexture(r.TEXTURE_2D_ARRAY,t),r.texStorage3D(r.TEXTURE_2D_ARRAY,1,r.RGBA8,a,e,2)),s._colorTextureArray=t,i||(i=r.createTexture(),r.bindTexture(r.TEXTURE_2D_ARRAY,i),r.texStorage3D(r.TEXTURE_2D_ARRAY,1,r.DEPTH24_STENCIL8,a,e,2)),s._depthStencilTextureArray=i,n.isReady=!0,s.setTextures(n),s._depthStencilTexture=n,s};he.prototype.bindMultiviewFramebuffer=function(a){const e=a,t=this._gl,i=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(e,void 0,void 0,void 0,!0),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer),e._colorTextureArray&&e._depthStencilTextureArray)this.getCaps().oculusMultiview?(i.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,e.samples,0,2),i.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,e._depthStencilTextureArray,0,e.samples,0,2)):(i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,0,2),i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,e._depthStencilTextureArray,0,0,2));else throw"Invalid multiview frame buffer"};he.prototype.bindSpaceWarpFramebuffer=function(a){const e=a,t=this._gl,i=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(e,void 0,void 0,void 0,!0),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer),e._colorTextureArray&&e._depthStencilTextureArray)i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,0,2),i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_ATTACHMENT,e._depthStencilTextureArray,0,0,2);else throw new Error("Invalid Space Warp framebuffer")};Ce.prototype._useMultiviewToSingleView=!1;Ce.prototype._multiviewTexture=null;Ce.prototype._resizeOrCreateMultiviewTexture=function(a,e){this._multiviewTexture?(this._multiviewTexture.getRenderWidth()!=a||this._multiviewTexture.getRenderHeight()!=e)&&(this._multiviewTexture.dispose(),this._multiviewTexture=new fl(this.getScene(),{width:a,height:e})):this._multiviewTexture=new fl(this.getScene(),{width:a,height:e})};function gg(a,e){const t=new _e(a,void 0,!0,e);return t.addUniform("viewProjection",16),t.addUniform("viewProjectionR",16),t.addUniform("view",16),t.addUniform("projection",16),t.addUniform("vEyePosition",4),t}const MC=Ge.prototype.createSceneUniformBuffer;Ge.prototype._transformMatrixR=P.Zero();Ge.prototype._multiviewSceneUbo=null;Ge.prototype._createMultiviewUbo=function(){this._multiviewSceneUbo=gg(this.getEngine(),"scene_multiview")};Ge.prototype.createSceneUniformBuffer=function(a){return this._multiviewSceneUbo?gg(this.getEngine(),a):MC.bind(this)(a)};Ge.prototype._updateMultiviewUbo=function(a,e){a&&e&&a.multiplyToRef(e,this._transformMatrixR),a&&e&&(a.multiplyToRef(e,F.Matrix[0]),Li.GetRightPlaneToRef(F.Matrix[0],this._frustumPlanes[3])),this._multiviewSceneUbo&&(this._multiviewSceneUbo.updateMatrix("viewProjection",this.getTransformMatrix()),this._multiviewSceneUbo.updateMatrix("viewProjectionR",this._transformMatrixR),this._multiviewSceneUbo.updateMatrix("view",this._viewMatrix),this._multiviewSceneUbo.updateMatrix("projection",this._projectionMatrix))};Ge.prototype._renderMultiviewToSingleView=function(a){a._resizeOrCreateMultiviewTexture(a._rigPostProcess&&a._rigPostProcess&&a._rigPostProcess.width>0?a._rigPostProcess.width:this.getEngine().getRenderWidth(!0),a._rigPostProcess&&a._rigPostProcess&&a._rigPostProcess.height>0?a._rigPostProcess.height:this.getEngine().getRenderHeight(!0)),this._multiviewSceneUbo||this._createMultiviewUbo(),a.outputRenderTarget=a._multiviewTexture,this._renderForCamera(a),a.outputRenderTarget=null;for(let e=0;e<a._rigCameras.length;e++){const t=this.getEngine();this._activeCamera=a._rigCameras[e],t.setViewport(this._activeCamera.viewport),this.postProcessManager&&(this.postProcessManager._prepareFrame(),this.postProcessManager._finalizeFrame(this._activeCamera.isIntermediate))}};class PC extends At{getClassName(){return"VRMultiviewToSingleviewPostProcess"}constructor(e,t,i){super(e,"vrMultiviewToSingleview",["imageIndex"],["multiviewSampler"],i,t,Z.BILINEAR_SAMPLINGMODE);const r=t??this.getCamera();this.onSizeChangedObservable.add(()=>{}),this.onApplyObservable.add(s=>{r._scene.activeCamera&&r._scene.activeCamera.isLeftCamera?s.setInt("imageIndex",0):s.setInt("imageIndex",1),s.setTexture("multiviewSampler",r._multiviewTexture)})}}function OC(a,e){const t=e.vrCameraMetrics||Za.GetDefault();a._rigCameras[0]._cameraRigParams.vrMetrics=t,a._rigCameras[0].viewport=new Er(0,0,.5,1),a._rigCameras[0]._cameraRigParams.vrWorkMatrix=new P,a._rigCameras[0]._cameraRigParams.vrHMatrix=t.leftHMatrix,a._rigCameras[0]._cameraRigParams.vrPreViewMatrix=t.leftPreViewMatrix,a._rigCameras[0].getProjectionMatrix=a._rigCameras[0]._getVRProjectionMatrix,a._rigCameras[1]._cameraRigParams.vrMetrics=t,a._rigCameras[1].viewport=new Er(.5,0,.5,1),a._rigCameras[1]._cameraRigParams.vrWorkMatrix=new P,a._rigCameras[1]._cameraRigParams.vrHMatrix=t.rightHMatrix,a._rigCameras[1]._cameraRigParams.vrPreViewMatrix=t.rightPreViewMatrix,a._rigCameras[1].getProjectionMatrix=a._rigCameras[1]._getVRProjectionMatrix,t.multiviewEnabled&&(a.getScene().getEngine().getCaps().multiview?(a._useMultiviewToSingleView=!0,a._rigPostProcess=new PC("VRMultiviewToSingleview",a,t.postProcessScaleFactor)):(B.Warn("Multiview is not supported, falling back to standard rendering"),t.multiviewEnabled=!1)),t.compensateDistortion&&(a._rigCameras[0]._rigPostProcess=new rf("VR_Distort_Compensation_Left",a._rigCameras[0],!1,t),a._rigCameras[1]._rigPostProcess=new rf("VR_Distort_Compensation_Right",a._rigCameras[1],!0,t))}gt.AddNodeConstructor("VRDeviceOrientationFreeCamera",(a,e)=>()=>new Eg(a,m.Zero(),e));class Eg extends kc{constructor(e,t,i,r=!0,s=Za.GetDefault()){super(e,t,i),this._setRigMode=n=>OC(this,n),s.compensateDistortion=r,this.setCameraRigMode(Ce.RIG_MODE_VR,{vrCameraMetrics:s})}getClassName(){return"VRDeviceOrientationFreeCamera"}}class Wt{get isConnected(){return this._isConnected}constructor(e,t,i,r=0,s=1,n=2,o=3){this.id=e,this.index=t,this.browserGamepad=i,this._leftStick={x:0,y:0},this._rightStick={x:0,y:0},this._isConnected=!0,this._invertLeftStickY=!1,this.type=Wt.GAMEPAD,this._leftStickAxisX=r,this._leftStickAxisY=s,this._rightStickAxisX=n,this._rightStickAxisY=o,this.browserGamepad.axes.length>=2&&(this._leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]}),this.browserGamepad.axes.length>=4&&(this._rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}onleftstickchanged(e){this._onleftstickchanged=e}onrightstickchanged(e){this._onrightstickchanged=e}get leftStick(){return this._leftStick}set leftStick(e){this._onleftstickchanged&&(this._leftStick.x!==e.x||this._leftStick.y!==e.y)&&this._onleftstickchanged(e),this._leftStick=e}get rightStick(){return this._rightStick}set rightStick(e){this._onrightstickchanged&&(this._rightStick.x!==e.x||this._rightStick.y!==e.y)&&this._onrightstickchanged(e),this._rightStick=e}update(){this._leftStick&&(this.leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]},this._invertLeftStickY&&(this.leftStick.y*=-1)),this._rightStick&&(this.rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}dispose(){}}Wt.GAMEPAD=0;Wt.GENERIC=1;Wt.XBOX=2;Wt.POSE_ENABLED=3;Wt.DUALSHOCK=4;class DC extends Wt{onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}constructor(e,t,i){super(e,t,i),this.onButtonDownObservable=new U,this.onButtonUpObservable=new U,this.type=Wt.GENERIC,this._buttons=new Array(i.buttons.length)}_setButtonValue(e,t,i){return e!==t&&(e===1&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),e===0&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}update(){super.update();for(let e=0;e<this._buttons.length;e++)this._buttons[e]=this._setButtonValue(this.browserGamepad.buttons[e].value,this._buttons[e],e)}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear()}}class He{constructor(e,t,i=Number.MAX_VALUE,r=Ke){this.origin=e,this.direction=t,this.length=i,this.epsilon=r}clone(){return new He(this.origin.clone(),this.direction.clone(),this.length)}intersectsBoxMinMax(e,t,i=0){const r=He._TmpVector3[0].copyFromFloats(e.x-i,e.y-i,e.z-i),s=He._TmpVector3[1].copyFromFloats(t.x+i,t.y+i,t.z+i);let n=0,o=Number.MAX_VALUE,l,c,h,f;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<r.x||this.origin.x>s.x)return!1}else if(l=1/this.direction.x,c=(r.x-this.origin.x)*l,h=(s.x-this.origin.x)*l,h===-1/0&&(h=1/0),c>h&&(f=c,c=h,h=f),n=Math.max(c,n),o=Math.min(h,o),n>o)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<r.y||this.origin.y>s.y)return!1}else if(l=1/this.direction.y,c=(r.y-this.origin.y)*l,h=(s.y-this.origin.y)*l,h===-1/0&&(h=1/0),c>h&&(f=c,c=h,h=f),n=Math.max(c,n),o=Math.min(h,o),n>o)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<r.z||this.origin.z>s.z)return!1}else if(l=1/this.direction.z,c=(r.z-this.origin.z)*l,h=(s.z-this.origin.z)*l,h===-1/0&&(h=1/0),c>h&&(f=c,c=h,h=f),n=Math.max(c,n),o=Math.min(h,o),n>o)return!1;return!0}intersectsBox(e,t=0){return this.intersectsBoxMinMax(e.minimum,e.maximum,t)}intersectsSphere(e,t=0){const i=e.center.x-this.origin.x,r=e.center.y-this.origin.y,s=e.center.z-this.origin.z,n=i*i+r*r+s*s,o=e.radius+t,l=o*o;if(n<=l)return!0;const c=i*this.direction.x+r*this.direction.y+s*this.direction.z;return c<0?!1:n-c*c<=l}intersectsTriangle(e,t,i){const r=He._TmpVector3[0],s=He._TmpVector3[1],n=He._TmpVector3[2],o=He._TmpVector3[3],l=He._TmpVector3[4];t.subtractToRef(e,r),i.subtractToRef(e,s),m.CrossToRef(this.direction,s,n);const c=m.Dot(r,n);if(c===0)return null;const h=1/c;this.origin.subtractToRef(e,o);const f=m.Dot(o,n)*h;if(f<-this.epsilon||f>1+this.epsilon)return null;m.CrossToRef(o,r,l);const u=m.Dot(this.direction,l)*h;if(u<-this.epsilon||f+u>1+this.epsilon)return null;const d=m.Dot(s,l)*h;return d>this.length?null:new ll(1-f-u,f,d)}intersectsPlane(e){let t;const i=m.Dot(e.normal,this.direction);if(Math.abs(i)<999999997475243e-21)return null;{const r=m.Dot(e.normal,this.origin);return t=(-e.d-r)/i,t<0?t<-999999997475243e-21?null:0:t}}intersectsAxis(e,t=0){switch(e){case"y":{const i=(this.origin.y-t)/this.direction.y;return i>0?null:new m(this.origin.x+this.direction.x*-i,t,this.origin.z+this.direction.z*-i)}case"x":{const i=(this.origin.x-t)/this.direction.x;return i>0?null:new m(t,this.origin.y+this.direction.y*-i,this.origin.z+this.direction.z*-i)}case"z":{const i=(this.origin.z-t)/this.direction.z;return i>0?null:new m(this.origin.x+this.direction.x*-i,this.origin.y+this.direction.y*-i,t)}default:return null}}intersectsMesh(e,t,i,r=!1,s,n=!1){const o=F.Matrix[0];return e.getWorldMatrix().invertToRef(o),this._tmpRay?He.TransformToRef(this,o,this._tmpRay):this._tmpRay=He.Transform(this,o),e.intersects(this._tmpRay,t,i,r,s,n)}intersectsMeshes(e,t,i){i?i.length=0:i=[];for(let r=0;r<e.length;r++){const s=this.intersectsMesh(e[r],t);s.hit&&i.push(s)}return i.sort(this._comparePickingInfo),i}_comparePickingInfo(e,t){return e.distance<t.distance?-1:e.distance>t.distance?1:0}intersectionSegment(e,t,i){const r=this.origin,s=F.Vector3[0],n=F.Vector3[1],o=F.Vector3[2],l=F.Vector3[3];t.subtractToRef(e,s),this.direction.scaleToRef(He._Rayl,o),r.addToRef(o,n),e.subtractToRef(r,l);const c=m.Dot(s,s),h=m.Dot(s,o),f=m.Dot(o,o),u=m.Dot(s,l),d=m.Dot(o,l),_=c*f-h*h;let p,g=_,E,v=_;_<He._Smallnum?(p=0,g=1,E=d,v=f):(p=h*d-f*u,E=c*d-h*u,p<0?(p=0,E=d,v=f):p>g&&(p=g,E=d+h,v=f)),E<0?(E=0,-u<0?p=0:-u>c?p=g:(p=-u,g=c)):E>v&&(E=v,-u+h<0?p=0:-u+h>c?p=g:(p=-u+h,g=c));const b=Math.abs(p)<He._Smallnum?0:p/g,R=Math.abs(E)<He._Smallnum?0:E/v,S=F.Vector3[4];o.scaleToRef(R,S);const T=F.Vector3[5];s.scaleToRef(b,T),T.addInPlace(l);const I=F.Vector3[6];return T.subtractToRef(S,I),R>0&&R<=this.length&&I.lengthSquared()<i*i?T.length():-1}update(e,t,i,r,s,n,o,l=!1){if(l){He._RayDistant||(He._RayDistant=He.Zero()),He._RayDistant.unprojectRayToRef(e,t,i,r,P.IdentityReadOnly,n,o);const c=F.Matrix[0];s.invertToRef(c),He.TransformToRef(He._RayDistant,c,this)}else this.unprojectRayToRef(e,t,i,r,s,n,o);return this}static Zero(){return new He(m.Zero(),m.Zero())}static CreateNew(e,t,i,r,s,n,o){return He.Zero().update(e,t,i,r,s,n,o)}static CreateNewFromTo(e,t,i=P.IdentityReadOnly){const r=new He(new m(0,0,0),new m(0,0,0));return He.CreateFromToToRef(e,t,r,i)}static CreateFromToToRef(e,t,i,r=P.IdentityReadOnly){i.origin.copyFrom(e);const s=t.subtractToRef(e,i.direction),n=Math.sqrt(s.x*s.x+s.y*s.y+s.z*s.z);return i.length=n,i.direction.normalize(),He.TransformToRef(i,r,i)}static Transform(e,t){const i=new He(new m(0,0,0),new m(0,0,0));return He.TransformToRef(e,t,i),i}static TransformToRef(e,t,i){m.TransformCoordinatesToRef(e.origin,t,i.origin),m.TransformNormalToRef(e.direction,t,i.direction),i.length=e.length,i.epsilon=e.epsilon;const r=i.direction,s=r.length();if(!(s===0||s===1)){const n=1/s;r.x*=n,r.y*=n,r.z*=n,i.length*=s}return i}unprojectRayToRef(e,t,i,r,s,n,o){const l=F.Matrix[0];s.multiplyToRef(n,l),l.multiplyToRef(o,l),l.invert();const c=Re.LastCreatedEngine,h=F.Vector3[0];h.x=e/i*2-1,h.y=-(t/r*2-1),h.z=c!=null&&c.useReverseDepthBuffer?1:c!=null&&c.isNDCHalfZRange?0:-1;const f=F.Vector3[1].copyFromFloats(h.x,h.y,1-1e-8),u=F.Vector3[2],d=F.Vector3[3];m._UnprojectFromInvertedMatrixToRef(h,l,u),m._UnprojectFromInvertedMatrixToRef(f,l,d),this.origin.copyFrom(u),d.subtractToRef(u,this.direction),this.direction.normalize()}}He._TmpVector3=Bi(6,m.Zero);He._RayDistant=He.Zero();He._Smallnum=1e-8;He._Rayl=1e9;function Qa(a,e,t,i,r,s=!1){const n=He.Zero();return $a(a,e,t,i,n,r,s),n}function $a(a,e,t,i,r,s,n=!1,o=!1){const l=a.getEngine();if(!s&&!(s=a.activeCamera))return a;const c=s.viewport,h=l.getRenderHeight(),{x:f,y:u,width:d,height:_}=c.toGlobal(l.getRenderWidth(),h),p=1/l.getHardwareScalingLevel();return e=e*p-f,t=t*p-(h-u-_),r.update(e,t,d,_,i||P.IdentityReadOnly,n?P.IdentityReadOnly:s.getViewMatrix(),s.getProjectionMatrix(),o),a}function LC(a,e,t,i){const r=He.Zero();return vg(a,e,t,r,i),r}function vg(a,e,t,i,r){if(!oi)return a;const s=a.getEngine();if(!r&&!(r=a.activeCamera))throw new Error("Active camera not set");const n=r.viewport,o=s.getRenderHeight(),{x:l,y:c,width:h,height:f}=n.toGlobal(s.getRenderWidth(),o),u=P.Identity(),d=1/s.getHardwareScalingLevel();return e=e*d-l,t=t*d-(o-c-f),i.update(e,t,h,f,u,u,r.getProjectionMatrix()),a}function Tg(a,e,t,i,r,s,n,o){const l=e(i,t.enableDistantPicking),c=t.intersects(l,r,n,s,i,o);return!c||!c.hit||!r&&a!=null&&c.distance>=a.distance?null:c}function Wc(a,e,t,i,r,s){let n=null;const o=!!(a.activeCameras&&a.activeCameras.length>1&&a.cameraToUseForPointers!==a.activeCamera),l=a.cameraToUseForPointers||a.activeCamera,c=Tg;for(let h=0;h<a.meshes.length;h++){const f=a.meshes[h];if(t){if(!t(f,-1))continue}else if(!f.isEnabled()||!f.isVisible||!f.isPickable)continue;const u=o&&f.isWorldMatrixCameraDependent(),d=f.computeWorldMatrix(u,l);if(f.hasThinInstances&&f.thinInstanceEnablePicking){const _=c(n,e,f,d,!0,!0,s);if(_){if(r)return _;const p=F.Matrix[1],g=f.thinInstanceGetWorldMatrices();for(let E=0;E<g.length;E++){if(t&&!t(f,E))continue;g[E].multiplyToRef(d,p);const b=c(n,e,f,p,i,r,s,!0);if(b&&(n=b,n.thinInstanceIndex=E,i))return n}}}else{const _=c(n,e,f,d,i,r,s);if(_&&(n=_,i))return n}}return n||new oi}function Sg(a,e,t,i){if(!oi)return null;const r=[],s=!!(a.activeCameras&&a.activeCameras.length>1&&a.cameraToUseForPointers!==a.activeCamera),n=a.cameraToUseForPointers||a.activeCamera,o=Tg;for(let l=0;l<a.meshes.length;l++){const c=a.meshes[l];if(t){if(!t(c,-1))continue}else if(!c.isEnabled()||!c.isVisible||!c.isPickable)continue;const h=s&&c.isWorldMatrixCameraDependent(),f=c.computeWorldMatrix(h,n);if(c.hasThinInstances&&c.thinInstanceEnablePicking){if(o(null,e,c,f,!0,!0,i)){const d=F.Matrix[1],_=c.thinInstanceGetWorldMatrices();for(let p=0;p<_.length;p++){if(t&&!t(c,p))continue;_[p].multiplyToRef(f,d);const E=o(null,e,c,d,!1,!1,i,!0);E&&(E.thinInstanceIndex=p,r.push(E))}}}else{const u=o(null,e,c,f,!1,!1,i);u&&r.push(u)}}return r}function NC(a,e,t,i,r,s){if(!oi)return null;const n=Wc(a,o=>(a._tempPickingRay||(a._tempPickingRay=He.Zero()),$a(a,e,t,o,a._tempPickingRay,s||null),a._tempPickingRay),i,r,!0);return n&&(n.ray=Qa(a,e,t,P.Identity(),s||null)),n}function FC(a,e,t,i,r,s,n,o=!1){const l=Wc(a,(c,h)=>(a._tempPickingRay||(a._tempPickingRay=He.Zero()),$a(a,e,t,c,a._tempPickingRay,s||null,!1,h),a._tempPickingRay),i,r,!1,n);return l&&(l.ray=Qa(a,e,t,P.Identity(),s||null)),l}function wC(a,e,t,i,r){const s=Wc(a,n=>(a._pickWithRayInverseMatrix||(a._pickWithRayInverseMatrix=P.Identity()),n.invertToRef(a._pickWithRayInverseMatrix),a._cachedRayForTransform||(a._cachedRayForTransform=He.Zero()),He.TransformToRef(e,a._pickWithRayInverseMatrix,a._cachedRayForTransform),a._cachedRayForTransform),t,i,!1,r);return s&&(s.ray=e),s}function BC(a,e,t,i,r,s){return Sg(a,n=>Qa(a,e,t,n,r||null),i,s)}function UC(a,e,t,i){return Sg(a,r=>(a._pickWithRayInverseMatrix||(a._pickWithRayInverseMatrix=P.Identity()),r.invertToRef(a._pickWithRayInverseMatrix),a._cachedRayForTransform||(a._cachedRayForTransform=He.Zero()),He.TransformToRef(e,a._pickWithRayInverseMatrix,a._cachedRayForTransform),a._cachedRayForTransform),t,i)}function nf(a,e,t=100,i,r){i||(i=a.getWorldMatrix()),e.length=t,r?e.origin.copyFrom(r):e.origin.copyFrom(a.position);const s=F.Vector3[2];s.set(0,0,a._scene.useRightHandedSystem?-1:1);const n=F.Vector3[3];return m.TransformNormalToRef(s,i,n),m.NormalizeToRef(n,e.direction),e}function VC(a,e){e&&(e.prototype.getForwardRay=function(t=100,i,r){return nf(this,new He(m.Zero(),m.Zero(),t),t,i,r)},e.prototype.getForwardRayToRef=function(t,i=100,r,s){return nf(this,t,i,r,s)}),a&&(vc._IsPickingAvailable=!0,a.prototype.createPickingRay=function(t,i,r,s,n=!1){return Qa(this,t,i,r,s,n)})}VC(Ge,Ce);Ge.prototype.createPickingRayToRef=function(a,e,t,i,r,s=!1,n=!1){return $a(this,a,e,t,i,r,s,n)};Ge.prototype.createPickingRayInCameraSpace=function(a,e,t){return LC(this,a,e,t)};Ge.prototype.createPickingRayInCameraSpaceToRef=function(a,e,t,i){return vg(this,a,e,t,i)};Ge.prototype.pickWithBoundingInfo=function(a,e,t,i,r){return NC(this,a,e,t,i,r)};Ge.prototype.pick=function(a,e,t,i,r,s,n=!1){return FC(this,a,e,t,i,r,s,n)};Ge.prototype.pickWithRay=function(a,e,t,i){return wC(this,a,e,t,i)};Ge.prototype.multiPick=function(a,e,t,i,r){return BC(this,a,e,t,i,r)};Ge.prototype.multiPickWithRay=function(a,e,t){return UC(this,a,e,t)};We.prototype.createDynamicTexture=function(a,e,t,i){const r=new Yt(this,4);return r.baseWidth=a,r.baseHeight=e,t&&(a=this.needPOTTextures?Ts(a,this._caps.maxTextureSize):a,e=this.needPOTTextures?Ts(e,this._caps.maxTextureSize):e),r.width=a,r.height=e,r.isReady=!1,r.generateMipMaps=t,r.samplingMode=i,this.updateTextureSamplingMode(i,r),this._internalTexturesCache.push(r),r};We.prototype.updateDynamicTexture=function(a,e,t,i=!1,r,s=!1,n=!1){if(!a)return;const o=this._gl,l=o.TEXTURE_2D,c=this._bindTextureDirectly(l,a,!0,s);this._unpackFlipY(t===void 0?a.invertY:t),i&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);const h=this._getWebGLTextureType(a.type),f=this._getInternalFormat(r||a.format),u=this._getRGBABufferInternalSizedFormat(a.type,f);o.texImage2D(l,0,u,f,h,e),a.generateMipMaps&&o.generateMipmap(l),c||this._bindTextureDirectly(l,null),i&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),r&&(a.format=r),a._dynamicTextureSource=e,a._premulAlpha=i,a.invertY=t||!1,a.isReady=!0};class Mn extends Z{constructor(e,t,i,r=!1,s=3,n=5,o){const l=!i||i._isScene,c=l?i:i==null?void 0:i.scene,h=l?!r:i;super(null,c,h,o,s,void 0,void 0,void 0,void 0,n),this.name=e,this.wrapU=Z.CLAMP_ADDRESSMODE,this.wrapV=Z.CLAMP_ADDRESSMODE,this._generateMipMaps=r;const f=this._getEngine();if(!f)return;if(t.getContext)this._canvas=t,this._ownCanvas=!1,this._texture=f.createDynamicTexture(this._canvas.width,this._canvas.height,r,s);else{this._canvas=f.createCanvas(1,1),this._ownCanvas=!0;const d=t;d.width||d.width===0?this._texture=f.createDynamicTexture(d.width,d.height,r,s):this._texture=f.createDynamicTexture(t,t,r,s)}const u=this.getSize();this._canvas.width!==u.width&&(this._canvas.width=u.width),this._canvas.height!==u.height&&(this._canvas.height=u.height),this._context=this._canvas.getContext("2d")}getClassName(){return"DynamicTexture"}get canRescale(){return!0}_recreate(e){this._canvas.width=e.width,this._canvas.height=e.height,this.releaseInternalTexture(),this._texture=this._getEngine().createDynamicTexture(e.width,e.height,this._generateMipMaps,this.samplingMode)}scale(e){const t=this.getSize();t.width*=e,t.height*=e,this._recreate(t)}scaleTo(e,t){const i=this.getSize();i.width=e,i.height=t,this._recreate(i)}getContext(){return this._context}clear(e){const t=this.getSize();e&&(this._context.fillStyle=e),this._context.clearRect(0,0,t.width,t.height)}update(e,t=!1,i=!1){this._getEngine().updateDynamicTexture(this._texture,this._canvas,e===void 0?!0:e,t,this._format||void 0,void 0,i)}drawText(e,t,i,r,s,n,o,l=!0){const c=this.getSize();if(n&&(this._context.fillStyle=n,this._context.fillRect(0,0,c.width,c.height)),this._context.font=r,t==null){const h=this._context.measureText(e);t=(c.width-h.width)/2}if(i==null){const h=parseInt(r.replace(/\D/g,""));i=c.height/2+h/3.65}this._context.fillStyle=s||"",this._context.fillText(e,t,i),l&&this.update(o)}dispose(){var e,t;super.dispose(),this._ownCanvas&&((t=(e=this._canvas)==null?void 0:e.remove)==null||t.call(e)),this._canvas=null,this._context=null}clone(){const e=this.getScene();if(!e)return this;const t=this.getSize(),i=new Mn(this.name,t,e,this._generateMipMaps);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.wrapU=this.wrapU,i.wrapV=this.wrapV,i}serialize(){const e=this.getScene();e&&!e.isReady()&&B.Warn("The scene must be ready before serializing the dynamic texture");const t=super.serialize();return Mn._IsCanvasElement(this._canvas)&&(t.base64String=this._canvas.toDataURL()),t.invertY=this._invertY,t.samplingMode=this.samplingMode,t}static _IsCanvasElement(e){return e.toDataURL!==void 0}_rebuild(){this.update()}}var af;(function(a){a[a.A=0]="A",a[a.B=1]="B",a[a.X=2]="X",a[a.Y=3]="Y",a[a.LB=4]="LB",a[a.RB=5]="RB",a[a.Back=8]="Back",a[a.Start=9]="Start",a[a.LeftStick=10]="LeftStick",a[a.RightStick=11]="RightStick"})(af||(af={}));var of;(function(a){a[a.Up=12]="Up",a[a.Down=13]="Down",a[a.Left=14]="Left",a[a.Right=15]="Right"})(of||(of={}));class GC extends Wt{constructor(e,t,i,r=!1){super(e,t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new U,this.onButtonUpObservable=new U,this.onPadDownObservable=new U,this.onPadUpObservable=new U,this._buttonA=0,this._buttonB=0,this._buttonX=0,this._buttonY=0,this._buttonBack=0,this._buttonStart=0,this._buttonLB=0,this._buttonRB=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this._isXboxOnePad=!1,this.type=Wt.XBOX,this._isXboxOnePad=r}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(e===1&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),e===0&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDPadValue(e,t,i){return e!==t&&(e===1&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),e===0&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonA(){return this._buttonA}set buttonA(e){this._buttonA=this._setButtonValue(e,this._buttonA,0)}get buttonB(){return this._buttonB}set buttonB(e){this._buttonB=this._setButtonValue(e,this._buttonB,1)}get buttonX(){return this._buttonX}set buttonX(e){this._buttonX=this._setButtonValue(e,this._buttonX,2)}get buttonY(){return this._buttonY}set buttonY(e){this._buttonY=this._setButtonValue(e,this._buttonY,3)}get buttonStart(){return this._buttonStart}set buttonStart(e){this._buttonStart=this._setButtonValue(e,this._buttonStart,9)}get buttonBack(){return this._buttonBack}set buttonBack(e){this._buttonBack=this._setButtonValue(e,this._buttonBack,8)}get buttonLB(){return this._buttonLB}set buttonLB(e){this._buttonLB=this._setButtonValue(e,this._buttonLB,4)}get buttonRB(){return this._buttonRB}set buttonRB(e){this._buttonRB=this._setButtonValue(e,this._buttonRB,5)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,10)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,11)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,12)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,13)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,14)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,15)}update(){super.update(),this._isXboxOnePad?(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value):(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value)}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}var lf;(function(a){a[a.Cross=0]="Cross",a[a.Circle=1]="Circle",a[a.Square=2]="Square",a[a.Triangle=3]="Triangle",a[a.L1=4]="L1",a[a.R1=5]="R1",a[a.Share=8]="Share",a[a.Options=9]="Options",a[a.LeftStick=10]="LeftStick",a[a.RightStick=11]="RightStick"})(lf||(lf={}));var cf;(function(a){a[a.Up=12]="Up",a[a.Down=13]="Down",a[a.Left=14]="Left",a[a.Right=15]="Right"})(cf||(cf={}));class kC extends Wt{constructor(e,t,i){super(e.replace("STANDARD GAMEPAD","SONY PLAYSTATION DUALSHOCK"),t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new U,this.onButtonUpObservable=new U,this.onPadDownObservable=new U,this.onPadUpObservable=new U,this._buttonCross=0,this._buttonCircle=0,this._buttonSquare=0,this._buttonTriangle=0,this._buttonShare=0,this._buttonOptions=0,this._buttonL1=0,this._buttonR1=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this.type=Wt.DUALSHOCK}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(e===1&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),e===0&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDPadValue(e,t,i){return e!==t&&(e===1&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),e===0&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonCross(){return this._buttonCross}set buttonCross(e){this._buttonCross=this._setButtonValue(e,this._buttonCross,0)}get buttonCircle(){return this._buttonCircle}set buttonCircle(e){this._buttonCircle=this._setButtonValue(e,this._buttonCircle,1)}get buttonSquare(){return this._buttonSquare}set buttonSquare(e){this._buttonSquare=this._setButtonValue(e,this._buttonSquare,2)}get buttonTriangle(){return this._buttonTriangle}set buttonTriangle(e){this._buttonTriangle=this._setButtonValue(e,this._buttonTriangle,3)}get buttonOptions(){return this._buttonOptions}set buttonOptions(e){this._buttonOptions=this._setButtonValue(e,this._buttonOptions,9)}get buttonShare(){return this._buttonShare}set buttonShare(e){this._buttonShare=this._setButtonValue(e,this._buttonShare,8)}get buttonL1(){return this._buttonL1}set buttonL1(e){this._buttonL1=this._setButtonValue(e,this._buttonL1,4)}get buttonR1(){return this._buttonR1}set buttonR1(e){this._buttonR1=this._setButtonValue(e,this._buttonR1,5)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,10)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,11)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,12)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,13)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,14)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,15)}update(){super.update(),this.buttonCross=this.browserGamepad.buttons[0].value,this.buttonCircle=this.browserGamepad.buttons[1].value,this.buttonSquare=this.browserGamepad.buttons[2].value,this.buttonTriangle=this.browserGamepad.buttons[3].value,this.buttonL1=this.browserGamepad.buttons[4].value,this.buttonR1=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonShare=this.browserGamepad.buttons[8].value,this.buttonOptions=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}class WC{constructor(e){if(this._scene=e,this._babylonGamepads=[],this._oneGamepadConnected=!1,this._isMonitoring=!1,this.onGamepadDisconnectedObservable=new U,Ht()?(this._gamepadEventSupported="GamepadEvent"in window,this._gamepadSupport=navigator&&navigator.getGamepads):this._gamepadEventSupported=!1,this.onGamepadConnectedObservable=new U(t=>{for(const i in this._babylonGamepads){const r=this._babylonGamepads[i];r&&r._isConnected&&this.onGamepadConnectedObservable.notifyObserver(t,r)}}),this._onGamepadConnectedEvent=t=>{const i=t.gamepad;if(i.index in this._babylonGamepads&&this._babylonGamepads[i.index].isConnected)return;let r;this._babylonGamepads[i.index]?(r=this._babylonGamepads[i.index],r.browserGamepad=i,r._isConnected=!0):r=this._addNewGamepad(i),this.onGamepadConnectedObservable.notifyObservers(r),this._startMonitoringGamepads()},this._onGamepadDisconnectedEvent=t=>{const i=t.gamepad;for(const r in this._babylonGamepads)if(this._babylonGamepads[r].index===i.index){const s=this._babylonGamepads[r];s._isConnected=!1,this.onGamepadDisconnectedObservable.notifyObservers(s),s.dispose&&s.dispose();break}},this._gamepadSupport)if(this._updateGamepadObjects(),this._babylonGamepads.length&&this._startMonitoringGamepads(),this._gamepadEventSupported){const t=this._scene?this._scene.getEngine().getHostWindow():window;t&&(t.addEventListener("gamepadconnected",this._onGamepadConnectedEvent,!1),t.addEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent,!1))}else this._startMonitoringGamepads()}get gamepads(){return this._babylonGamepads}getGamepadByType(e=Wt.XBOX){for(const t of this._babylonGamepads)if(t&&t.type===e)return t;return null}dispose(){this._gamepadEventSupported&&(this._onGamepadConnectedEvent&&window.removeEventListener("gamepadconnected",this._onGamepadConnectedEvent),this._onGamepadDisconnectedEvent&&window.removeEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent),this._onGamepadConnectedEvent=null,this._onGamepadDisconnectedEvent=null),this._babylonGamepads.forEach(e=>{e.dispose()}),this.onGamepadConnectedObservable.clear(),this.onGamepadDisconnectedObservable.clear(),this._oneGamepadConnected=!1,this._stopMonitoringGamepads(),this._babylonGamepads=[]}_addNewGamepad(e){this._oneGamepadConnected||(this._oneGamepadConnected=!0);let t;const i=e.id.search("054c")!==-1&&e.id.search("0ce6")===-1,r=e.id.search("Xbox One")!==-1;return r||e.id.search("Xbox 360")!==-1||e.id.search("xinput")!==-1||e.id.search("045e")!==-1&&e.id.search("Surface Dock")===-1?t=new GC(e.id,e.index,e,r):i?t=new kC(e.id,e.index,e):t=new DC(e.id,e.index,e),this._babylonGamepads[t.index]=t,t}_startMonitoringGamepads(){this._isMonitoring||(this._isMonitoring=!0,this._checkGamepadsStatus())}_stopMonitoringGamepads(){this._isMonitoring=!1}_checkGamepadsStatus(){this._updateGamepadObjects();for(const e in this._babylonGamepads){const t=this._babylonGamepads[e];if(!(!t||!t.isConnected))try{t.update()}catch{this._loggedErrors.indexOf(t.index)===-1&&(k.Warn(`Error updating gamepad ${t.id}`),this._loggedErrors.push(t.index))}}this._isMonitoring&&H.QueueNewFrame(()=>{this._checkGamepadsStatus()})}_updateGamepadObjects(){const e=navigator.getGamepads?navigator.getGamepads():[];for(let t=0;t<e.length;t++){const i=e[t];if(i)if(this._babylonGamepads[i.index])this._babylonGamepads[t].browserGamepad=i,this._babylonGamepads[t].isConnected||(this._babylonGamepads[t]._isConnected=!0,this.onGamepadConnectedObservable.notifyObservers(this._babylonGamepads[t]));else{const r=this._addNewGamepad(i);this.onGamepadConnectedObservable.notifyObservers(r)}}}}class Ja{constructor(){this.gamepadAngularSensibility=200,this.gamepadMoveSensibility=40,this.deadzoneDelta=.1,this._yAxisScale=1,this._cameraTransform=P.Identity(),this._deltaTransform=m.Zero(),this._vector3=m.Zero(),this._vector2=ne.Zero()}get invertYAxis(){return this._yAxisScale!==1}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){const e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(t=>{t.type!==Wt.POSE_ENABLED&&(!this.gamepad||t.type===Wt.XBOX)&&(this.gamepad=t)}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(t=>{this.gamepad===t&&(this.gamepad=null)}),this.gamepad=e.getGamepadByType(Wt.XBOX),!this.gamepad&&e.gamepads.length&&(this.gamepad=e.gamepads[0])}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad&&this.gamepad.leftStick){const e=this.camera,t=this.gamepad.leftStick;this.gamepadMoveSensibility!==0&&(t.x=Math.abs(t.x)>this.deadzoneDelta?t.x/this.gamepadMoveSensibility:0,t.y=Math.abs(t.y)>this.deadzoneDelta?t.y/this.gamepadMoveSensibility:0);let i=this.gamepad.rightStick;i&&this.gamepadAngularSensibility!==0?(i.x=Math.abs(i.x)>this.deadzoneDelta?i.x/this.gamepadAngularSensibility:0,i.y=(Math.abs(i.y)>this.deadzoneDelta?i.y/this.gamepadAngularSensibility:0)*this._yAxisScale):i={x:0,y:0},e.rotationQuaternion?e.rotationQuaternion.toRotationMatrix(this._cameraTransform):P.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,this._cameraTransform);const r=e._computeLocalCameraSpeed()*50;this._vector3.copyFromFloats(t.x*r,0,-t.y*r),m.TransformCoordinatesToRef(this._vector3,this._cameraTransform,this._deltaTransform),e.cameraDirection.addInPlace(this._deltaTransform),this._vector2.copyFromFloats(i.y,i.x),e.cameraRotation.addInPlace(this._vector2)}}getClassName(){return"FreeCameraGamepadInput"}getSimpleName(){return"gamepad"}}A([y()],Ja.prototype,"gamepadAngularSensibility",void 0);A([y()],Ja.prototype,"gamepadMoveSensibility",void 0);Ki.FreeCameraGamepadInput=Ja;class eo{constructor(){this.gamepadRotationSensibility=80,this.gamepadMoveSensibility=40,this._yAxisScale=1}get invertYAxis(){return this._yAxisScale!==1}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){const e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(t=>{t.type!==Wt.POSE_ENABLED&&(!this.gamepad||t.type===Wt.XBOX)&&(this.gamepad=t)}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(t=>{this.gamepad===t&&(this.gamepad=null)}),this.gamepad=e.getGamepadByType(Wt.XBOX),!this.gamepad&&e.gamepads.length&&(this.gamepad=e.gamepads[0])}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad){const e=this.camera,t=this.gamepad.rightStick;if(t){if(t.x!=0){const r=t.x/this.gamepadRotationSensibility;r!=0&&Math.abs(r)>.005&&(e.inertialAlphaOffset+=r)}if(t.y!=0){const r=t.y/this.gamepadRotationSensibility*this._yAxisScale;r!=0&&Math.abs(r)>.005&&(e.inertialBetaOffset+=r)}}const i=this.gamepad.leftStick;if(i&&i.y!=0){const r=i.y/this.gamepadMoveSensibility;r!=0&&Math.abs(r)>.005&&(this.camera.inertialRadiusOffset-=r)}}}getClassName(){return"ArcRotateCameraGamepadInput"}getSimpleName(){return"gamepad"}}A([y()],eo.prototype,"gamepadRotationSensibility",void 0);A([y()],eo.prototype,"gamepadMoveSensibility",void 0);Ki.ArcRotateCameraGamepadInput=eo;Object.defineProperty(Ge.prototype,"gamepadManager",{get:function(){if(!this._gamepadManager){this._gamepadManager=new WC(this);let a=this._getComponent(Ae.NAME_GAMEPAD);a||(a=new XC(this),this._addComponent(a))}return this._gamepadManager},enumerable:!0,configurable:!0});Gc.prototype.addGamepad=function(){return this.add(new Ja),this};lg.prototype.addGamepad=function(){return this.add(new eo),this};class XC{constructor(e){this.name=Ae.NAME_GAMEPAD,this.scene=e}register(){}rebuild(){}dispose(){const e=this.scene._gamepadManager;e&&(e.dispose(),this.scene._gamepadManager=null)}}class mt extends gt{get _matrix(){return this._compose(),this._localMatrix}set _matrix(e){e.updateFlag===this._localMatrix.updateFlag&&!this._needToCompose||(this._needToCompose=!1,this._localMatrix.copyFrom(e),this._markAsDirtyAndDecompose())}constructor(e,t,i=null,r=null,s=null,n=null,o=null){super(e,t.getScene(),!1),this.name=e,this.children=[],this.animations=[],this._index=null,this._scalingDeterminant=1,this._needToDecompose=!0,this._needToCompose=!1,this._linkedTransformNode=null,this._waitingTransformNodeId=null,this._skeleton=t,this._localMatrix=(r==null?void 0:r.clone())??P.Identity(),this._restMatrix=s??this._localMatrix.clone(),this._bindMatrix=n??this._localMatrix.clone(),this._index=o,this._absoluteMatrix=new P,this._absoluteBindMatrix=new P,this._absoluteInverseBindMatrix=new P,this._finalMatrix=new P,t.bones.push(this),this.setParent(i,!1),this._updateAbsoluteBindMatrices()}getClassName(){return"Bone"}getSkeleton(){return this._skeleton}get parent(){return this._parentNode}getParent(){return this.parent}getChildren(){return this.children}getIndex(){return this._index===null?this.getSkeleton().bones.indexOf(this):this._index}set parent(e){this.setParent(e)}setParent(e,t=!0){if(this.parent!==e){if(this.parent){const i=this.parent.children.indexOf(this);i!==-1&&this.parent.children.splice(i,1)}this._parentNode=e,this.parent&&this.parent.children.push(this),t&&this._updateAbsoluteBindMatrices(),this.markAsDirty()}}getLocalMatrix(){return this._compose(),this._localMatrix}getBindMatrix(){return this._bindMatrix}getBaseMatrix(){return this.getBindMatrix()}getRestMatrix(){return this._restMatrix}getRestPose(){return this.getRestMatrix()}setRestMatrix(e){this._restMatrix.copyFrom(e)}setRestPose(e){this.setRestMatrix(e)}getBindPose(){return this.getBindMatrix()}setBindMatrix(e){this.updateMatrix(e)}setBindPose(e){this.setBindMatrix(e)}getFinalMatrix(){return this._finalMatrix}getWorldMatrix(){return this.getFinalMatrix()}returnToRest(){if(this._linkedTransformNode){const e=F.Vector3[0],t=F.Quaternion[0],i=F.Vector3[1];this.getRestMatrix().decompose(e,t,i),this._linkedTransformNode.position.copyFrom(i),this._linkedTransformNode.rotationQuaternion=this._linkedTransformNode.rotationQuaternion??z.Identity(),this._linkedTransformNode.rotationQuaternion.copyFrom(t),this._linkedTransformNode.scaling.copyFrom(e)}else this._matrix=this._restMatrix}getAbsoluteInverseBindMatrix(){return this._absoluteInverseBindMatrix}getInvertedAbsoluteTransform(){return this.getAbsoluteInverseBindMatrix()}getAbsoluteMatrix(){return this._absoluteMatrix}getAbsoluteTransform(){return this._absoluteMatrix}linkTransformNode(e){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=e,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++}getTransformNode(){return this._linkedTransformNode}get position(){return this._decompose(),this._localPosition}set position(e){this._decompose(),this._localPosition.copyFrom(e),this._markAsDirtyAndCompose()}get rotation(){return this.getRotation()}set rotation(e){this.setRotation(e)}get rotationQuaternion(){return this._decompose(),this._localRotation}set rotationQuaternion(e){this.setRotationQuaternion(e)}get scaling(){return this.getScale()}set scaling(e){this.setScale(e)}get animationPropertiesOverride(){return this._skeleton.animationPropertiesOverride}_decompose(){this._needToDecompose&&(this._needToDecompose=!1,this._localScaling||(this._localScaling=m.Zero(),this._localRotation=z.Zero(),this._localPosition=m.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))}_compose(){if(this._needToCompose){if(!this._localScaling){this._needToCompose=!1;return}this._needToCompose=!1,P.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)}}updateMatrix(e,t=!0,i=!0){this._bindMatrix.copyFrom(e),t&&this._updateAbsoluteBindMatrices(),i?this._matrix=e:this.markAsDirty()}_updateAbsoluteBindMatrices(e,t=!0){if(e||(e=this._bindMatrix),this.parent?e.multiplyToRef(this.parent._absoluteBindMatrix,this._absoluteBindMatrix):this._absoluteBindMatrix.copyFrom(e),this._absoluteBindMatrix.invertToRef(this._absoluteInverseBindMatrix),t)for(let i=0;i<this.children.length;i++)this.children[i]._updateAbsoluteBindMatrices();this._scalingDeterminant=this._absoluteBindMatrix.determinant()<0?-1:1}markAsDirty(){return this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty(),this}_markAsDirtyAndCompose(){this.markAsDirty(),this._needToCompose=!0}_markAsDirtyAndDecompose(){this.markAsDirty(),this._needToDecompose=!0}_updatePosition(e,t=0,i,r=!0){const s=this.getLocalMatrix();if(t==0)r?(s.addAtIndex(12,e.x),s.addAtIndex(13,e.y),s.addAtIndex(14,e.z)):s.setTranslationFromFloats(e.x,e.y,e.z);else{let n=null;i&&(n=i.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const o=mt._TmpMats[0],l=mt._TmpVecs[0];this.parent?i&&n?(o.copyFrom(this.parent.getAbsoluteMatrix()),o.multiplyToRef(n,o)):o.copyFrom(this.parent.getAbsoluteMatrix()):P.IdentityToRef(o),r&&o.setTranslationFromFloats(0,0,0),o.invert(),m.TransformCoordinatesToRef(e,o,l),r?(s.addAtIndex(12,l.x),s.addAtIndex(13,l.y),s.addAtIndex(14,l.z)):s.setTranslationFromFloats(l.x,l.y,l.z)}this._markAsDirtyAndDecompose()}translate(e,t=0,i){this._updatePosition(e,t,i,!0)}setPosition(e,t=0,i){this._updatePosition(e,t,i,!1)}setAbsolutePosition(e,t){this.setPosition(e,1,t)}scale(e,t,i,r=!1){const s=this.getLocalMatrix(),n=mt._TmpMats[0];P.ScalingToRef(e,t,i,n),n.multiplyToRef(s,s),n.invert();for(const o of this.children){const l=o.getLocalMatrix();l.multiplyToRef(n,l),l.multiplyAtIndex(12,e),l.multiplyAtIndex(13,t),l.multiplyAtIndex(14,i),o._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),r)for(const o of this.children)o.scale(e,t,i,r)}setScale(e){this._decompose(),this._localScaling.copyFrom(e),this._markAsDirtyAndCompose()}getScale(){return this._decompose(),this._localScaling}getScaleToRef(e){this._decompose(),e.copyFrom(this._localScaling)}setYawPitchRoll(e,t,i,r=0,s){if(r===0){const l=mt._TmpQuat;z.RotationYawPitchRollToRef(e,t,i,l),this.setRotationQuaternion(l,r,s);return}const n=mt._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(n,s))return;const o=mt._TmpMats[1];P.RotationYawPitchRollToRef(e,t,i,o),n.multiplyToRef(o,o),this._rotateWithMatrix(o,r,s)}rotate(e,t,i=0,r){const s=mt._TmpMats[0];s.setTranslationFromFloats(0,0,0),P.RotationAxisToRef(e,t,s),this._rotateWithMatrix(s,i,r)}setAxisAngle(e,t,i=0,r){if(i===0){const o=mt._TmpQuat;z.RotationAxisToRef(e,t,o),this.setRotationQuaternion(o,i,r);return}const s=mt._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(s,r))return;const n=mt._TmpMats[1];P.RotationAxisToRef(e,t,n),s.multiplyToRef(n,n),this._rotateWithMatrix(n,i,r)}setRotation(e,t=0,i){this.setYawPitchRoll(e.y,e.x,e.z,t,i)}setRotationQuaternion(e,t=0,i){if(t===0){this._decompose(),this._localRotation.copyFrom(e),this._markAsDirtyAndCompose();return}const r=mt._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(r,i))return;const s=mt._TmpMats[1];P.FromQuaternionToRef(e,s),r.multiplyToRef(s,s),this._rotateWithMatrix(s,t,i)}setRotationMatrix(e,t=0,i){if(t===0){const n=mt._TmpQuat;z.FromRotationMatrixToRef(e,n),this.setRotationQuaternion(n,t,i);return}const r=mt._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(r,i))return;const s=mt._TmpMats[1];s.copyFrom(e),r.multiplyToRef(e,s),this._rotateWithMatrix(s,t,i)}_rotateWithMatrix(e,t=0,i){const r=this.getLocalMatrix(),s=r.m[12],n=r.m[13],o=r.m[14],l=this.getParent(),c=mt._TmpMats[3],h=mt._TmpMats[4];l&&t==1?(i?(c.copyFrom(i.getWorldMatrix()),l.getAbsoluteMatrix().multiplyToRef(c,c)):c.copyFrom(l.getAbsoluteMatrix()),h.copyFrom(c),h.invert(),r.multiplyToRef(c,r),r.multiplyToRef(e,r),r.multiplyToRef(h,r)):t==1&&i?(c.copyFrom(i.getWorldMatrix()),h.copyFrom(c),h.invert(),r.multiplyToRef(c,r),r.multiplyToRef(e,r),r.multiplyToRef(h,r)):r.multiplyToRef(e,r),r.setTranslationFromFloats(s,n,o),this.computeAbsoluteMatrices(),this._markAsDirtyAndDecompose()}_getAbsoluteInverseMatrixUnscaledToRef(e,t){const i=mt._TmpMats[2];return e.copyFrom(this.getAbsoluteMatrix()),t?(e.multiplyToRef(t.getWorldMatrix(),e),P.ScalingToRef(t.scaling.x,t.scaling.y,t.scaling.z,i)):P.IdentityToRef(i),e.invert(),isNaN(e.m[0])?!1:(i.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyToRef(i,e),!0)}getPosition(e=0,t=null){const i=m.Zero();return this.getPositionToRef(e,t,i),i}getPositionToRef(e=0,t,i){if(e==0){const r=this.getLocalMatrix();i.x=r.m[12],i.y=r.m[13],i.z=r.m[14]}else{let r=null;t&&(r=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();let s=mt._TmpMats[0];t&&r?(s.copyFrom(this.getAbsoluteMatrix()),s.multiplyToRef(r,s)):s=this.getAbsoluteMatrix(),i.x=s.m[12],i.y=s.m[13],i.z=s.m[14]}}getAbsolutePosition(e=null){const t=m.Zero();return this.getPositionToRef(1,e,t),t}getAbsolutePositionToRef(e,t){this.getPositionToRef(1,e,t)}computeAbsoluteMatrices(){if(this._compose(),this.parent)this._localMatrix.multiplyToRef(this.parent._absoluteMatrix,this._absoluteMatrix);else{this._absoluteMatrix.copyFrom(this._localMatrix);const i=this._skeleton.getPoseMatrix();i&&this._absoluteMatrix.multiplyToRef(i,this._absoluteMatrix)}const e=this.children,t=e.length;for(let i=0;i<t;i++)e[i].computeAbsoluteMatrices()}computeAbsoluteTransforms(){this.computeAbsoluteMatrices()}getDirection(e,t=null){const i=m.Zero();return this.getDirectionToRef(e,t,i),i}getDirectionToRef(e,t=null,i){let r=null;t&&(r=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const s=mt._TmpMats[0];s.copyFrom(this.getAbsoluteMatrix()),t&&r&&s.multiplyToRef(r,s),m.TransformNormalToRef(e,s,i),i.normalize()}getRotation(e=0,t=null){const i=m.Zero();return this.getRotationToRef(e,t,i),i}getRotationToRef(e=0,t=null,i){const r=mt._TmpQuat;this.getRotationQuaternionToRef(e,t,r),r.toEulerAnglesToRef(i)}getRotationQuaternion(e=0,t=null){const i=z.Identity();return this.getRotationQuaternionToRef(e,t,i),i}getRotationQuaternionToRef(e=0,t=null,i){if(e==0)this._decompose(),i.copyFrom(this._localRotation);else{const r=mt._TmpMats[0],s=this.getAbsoluteMatrix();t?s.multiplyToRef(t.getWorldMatrix(),r):r.copyFrom(s),r.multiplyAtIndex(0,this._scalingDeterminant),r.multiplyAtIndex(1,this._scalingDeterminant),r.multiplyAtIndex(2,this._scalingDeterminant),r.decompose(void 0,i,void 0)}}getRotationMatrix(e=0,t){const i=P.Identity();return this.getRotationMatrixToRef(e,t,i),i}getRotationMatrixToRef(e=0,t,i){if(e==0)this.getLocalMatrix().getRotationMatrixToRef(i);else{const r=mt._TmpMats[0],s=this.getAbsoluteMatrix();t?s.multiplyToRef(t.getWorldMatrix(),r):r.copyFrom(s),r.multiplyAtIndex(0,this._scalingDeterminant),r.multiplyAtIndex(1,this._scalingDeterminant),r.multiplyAtIndex(2,this._scalingDeterminant),r.getRotationMatrixToRef(i)}}getAbsolutePositionFromLocal(e,t=null){const i=m.Zero();return this.getAbsolutePositionFromLocalToRef(e,t,i),i}getAbsolutePositionFromLocalToRef(e,t=null,i){let r=null;t&&(r=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const s=mt._TmpMats[0];s.copyFrom(this.getAbsoluteMatrix()),t&&r&&s.multiplyToRef(r,s),m.TransformCoordinatesToRef(e,s,i)}getLocalPositionFromAbsolute(e,t=null){const i=m.Zero();return this.getLocalPositionFromAbsoluteToRef(e,t,i),i}getLocalPositionFromAbsoluteToRef(e,t=null,i){let r=null;t&&(r=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const s=mt._TmpMats[0];s.copyFrom(this.getAbsoluteMatrix()),t&&r&&s.multiplyToRef(r,s),s.invert(),m.TransformCoordinatesToRef(e,s,i)}setCurrentPoseAsRest(){this.setRestMatrix(this.getLocalMatrix())}dispose(){this._linkedTransformNode=null;const e=this._skeleton.bones.indexOf(this);if(e!==-1&&this._skeleton.bones.splice(e,1),this._parentNode&&this._parentNode.children){const t=this._parentNode.children,i=t.indexOf(this);i!==-1&&t.splice(i,1)}super.dispose()}}mt._TmpVecs=Bi(2,m.Zero);mt._TmpQuat=z.Identity();mt._TmpMats=Bi(5,P.Identity);class HC{get currentFrame(){return this._currentFrame}get weight(){return this._weight}get currentValue(){return this._currentValue}get targetPath(){return this._targetPath}get target(){return this._currentActiveTarget}get isAdditive(){return this._host&&this._host.isAdditive}constructor(e,t,i,r){if(this._events=new Array,this._currentFrame=0,this._originalValue=new Array,this._originalBlendValue=null,this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this._blendingFactor=0,this._currentValue=null,this._currentActiveTarget=null,this._directTarget=null,this._targetPath="",this._weight=1,this._absoluteFrameOffset=0,this._previousElapsedTime=0,this._yoyoDirection=1,this._previousAbsoluteFrame=0,this._targetIsArray=!1,this._animation=t,this._target=e,this._scene=i,this._host=r,this._activeTargets=[],t._runtimeAnimations.push(this),this._animationState={key:0,repeatCount:0,loopMode:this._getCorrectLoopMode()},this._animation.dataType===W.ANIMATIONTYPE_MATRIX&&(this._animationState.workValue=P.Zero()),this._keys=this._animation.getKeys(),this._minFrame=this._keys[0].frame,this._maxFrame=this._keys[this._keys.length-1].frame,this._minValue=this._keys[0].value,this._maxValue=this._keys[this._keys.length-1].value,this._minFrame!==0){const n={frame:0,value:this._minValue};this._keys.splice(0,0,n)}if(this._target instanceof Array){let n=0;for(const o of this._target)this._preparePath(o,n),this._getOriginalValues(n),n++;this._targetIsArray=!0}else this._preparePath(this._target),this._getOriginalValues(),this._targetIsArray=!1,this._directTarget=this._activeTargets[0];const s=t.getEvents();s&&s.length>0&&s.forEach(n=>{this._events.push(n._clone())}),this._enableBlending=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.enableBlending:this._animation.enableBlending}_preparePath(e,t=0){const i=this._animation.targetPropertyPath;if(i.length>1){let r=e;for(let s=0;s<i.length-1;s++){const n=i[s];if(r=r[n],r===void 0)throw new Error(`Invalid property (${n}) in property path (${i.join(".")})`)}this._targetPath=i[i.length-1],this._activeTargets[t]=r}else this._targetPath=i[0],this._activeTargets[t]=e;if(this._activeTargets[t][this._targetPath]===void 0)throw new Error(`Invalid property (${this._targetPath}) in property path (${i.join(".")})`)}get animation(){return this._animation}reset(e=!1){if(e)if(this._target instanceof Array){let t=0;for(const i of this._target)this._originalValue[t]!==void 0&&this._setValue(i,this._activeTargets[t],this._originalValue[t],-1,t),t++}else this._originalValue[0]!==void 0&&this._setValue(this._target,this._directTarget,this._originalValue[0],-1,0);this._offsetsCache={},this._highLimitsCache={},this._currentFrame=0,this._blendingFactor=0;for(let t=0;t<this._events.length;t++)this._events[t].isDone=!1}isStopped(){return this._stopped}dispose(){const e=this._animation.runtimeAnimations.indexOf(this);e>-1&&this._animation.runtimeAnimations.splice(e,1)}setValue(e,t){if(this._targetIsArray){for(let i=0;i<this._target.length;i++){const r=this._target[i];this._setValue(r,this._activeTargets[i],e,t,i)}return}this._setValue(this._target,this._directTarget,e,t,0)}_getOriginalValues(e=0){let t;const i=this._activeTargets[e];i.getLocalMatrix&&this._targetPath==="_matrix"?t=i.getLocalMatrix():t=i[this._targetPath],t&&t.clone?this._originalValue[e]=t.clone():this._originalValue[e]=t}_registerTargetForLateAnimationBinding(e,t){const i=e.target;this._scene._registeredForLateAnimationBindings.pushNoDuplicate(i),i._lateAnimationHolders||(i._lateAnimationHolders={}),i._lateAnimationHolders[e.targetPath]||(i._lateAnimationHolders[e.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:t}),e.isAdditive?(i._lateAnimationHolders[e.targetPath].additiveAnimations.push(e),i._lateAnimationHolders[e.targetPath].totalAdditiveWeight+=e.weight):(i._lateAnimationHolders[e.targetPath].animations.push(e),i._lateAnimationHolders[e.targetPath].totalWeight+=e.weight)}_setValue(e,t,i,r,s){if(this._currentActiveTarget=t,this._weight=r,this._enableBlending&&this._blendingFactor<=1){if(!this._originalBlendValue){const o=t[this._targetPath];o.clone?this._originalBlendValue=o.clone():this._originalBlendValue=o}this._originalBlendValue.m?W.AllowMatrixDecomposeForInterpolation?this._currentValue?P.DecomposeLerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=P.DecomposeLerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue?P.LerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=P.Lerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue=W._UniversalLerp(this._originalBlendValue,i,this._blendingFactor);const n=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.blendingSpeed:this._animation.blendingSpeed;this._blendingFactor+=n}else this._currentValue?this._currentValue.copyFrom?this._currentValue.copyFrom(i):this._currentValue=i:i!=null&&i.clone?this._currentValue=i.clone():this._currentValue=i;r!==-1?this._registerTargetForLateAnimationBinding(this,this._originalValue[s]):this._animationState.loopMode===W.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT?this._currentValue.addToRef?this._currentValue.addToRef(this._originalValue[s],t[this._targetPath]):t[this._targetPath]=this._originalValue[s]+this._currentValue:t[this._targetPath]=this._currentValue,e.markAsDirty&&e.markAsDirty(this._animation.targetProperty)}_getCorrectLoopMode(){return this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.loopMode:this._animation.loopMode}goToFrame(e,t=-1){const i=this._animation.getKeys();e<i[0].frame?e=i[0].frame:e>i[i.length-1].frame&&(e=i[i.length-1].frame);const r=this._events;if(r.length)for(let n=0;n<r.length;n++)r[n].onlyOnce||(r[n].isDone=r[n].frame<e);this._currentFrame=e;const s=this._animation._interpolate(e,this._animationState);this.setValue(s,t)}_prepareForSpeedRatioChange(e){const t=this._previousElapsedTime*(this._animation.framePerSecond*e)/1e3;this._absoluteFrameOffset=this._previousAbsoluteFrame-t}animate(e,t,i,r,s,n=-1){const o=this._animation,l=o.targetPropertyPath;if(!l||l.length<1)return this._stopped=!0,!1;let c=!0;(t<this._minFrame||t>this._maxFrame)&&(t=this._minFrame),(i<this._minFrame||i>this._maxFrame)&&(i=this._maxFrame);const h=i-t;let f,u=e*(o.framePerSecond*s)/1e3+this._absoluteFrameOffset,d=0,_=!1;const p=r&&this._animationState.loopMode===W.ANIMATIONLOOPMODE_YOYO;if(p){const b=(u-t)/h,R=Math.sin(b*Math.PI);u=Math.abs(R)*h+t;const T=R>=0?1:-1;this._yoyoDirection!==T&&(_=!0),this._yoyoDirection=T}if(this._previousElapsedTime=e,this._previousAbsoluteFrame=u,!r&&i>=t&&(u>=h&&s>0||u<=0&&s<0))c=!1,d=o._getKeyValue(this._maxValue);else if(!r&&t>=i&&(u<=h&&s<0||u>=0&&s>0))c=!1,d=o._getKeyValue(this._minValue);else if(this._animationState.loopMode!==W.ANIMATIONLOOPMODE_CYCLE){const b=i.toString()+t.toString();if(!this._offsetsCache[b]){this._animationState.repeatCount=0,this._animationState.loopMode=W.ANIMATIONLOOPMODE_CYCLE;const R=o._interpolate(t,this._animationState),S=o._interpolate(i,this._animationState);switch(this._animationState.loopMode=this._getCorrectLoopMode(),o.dataType){case W.ANIMATIONTYPE_FLOAT:this._offsetsCache[b]=S-R;break;case W.ANIMATIONTYPE_QUATERNION:this._offsetsCache[b]=S.subtract(R);break;case W.ANIMATIONTYPE_VECTOR3:this._offsetsCache[b]=S.subtract(R);break;case W.ANIMATIONTYPE_VECTOR2:this._offsetsCache[b]=S.subtract(R);break;case W.ANIMATIONTYPE_SIZE:this._offsetsCache[b]=S.subtract(R);break;case W.ANIMATIONTYPE_COLOR3:this._offsetsCache[b]=S.subtract(R);break}this._highLimitsCache[b]=S}d=this._highLimitsCache[b],f=this._offsetsCache[b]}if(f===void 0)switch(o.dataType){case W.ANIMATIONTYPE_FLOAT:f=0;break;case W.ANIMATIONTYPE_QUATERNION:f=eg;break;case W.ANIMATIONTYPE_VECTOR3:f=tg;break;case W.ANIMATIONTYPE_VECTOR2:f=ig;break;case W.ANIMATIONTYPE_SIZE:f=rg;break;case W.ANIMATIONTYPE_COLOR3:f=sg;break;case W.ANIMATIONTYPE_COLOR4:f=ng;break}let g;if(this._host&&this._host.syncRoot){const b=this._host.syncRoot,R=(b.masterFrame-b.fromFrame)/(b.toFrame-b.fromFrame);g=t+h*R}else u>0&&t>i||u<0&&t<i?g=c&&h!==0?i+u%h:t:g=c&&h!==0?t+u%h:i;const E=this._events;if(!p&&(s>0&&this.currentFrame>g||s<0&&this.currentFrame<g)||p&&_){this._onLoop();for(let b=0;b<E.length;b++)E[b].onlyOnce||(E[b].isDone=!1);this._animationState.key=s>0?0:o.getKeys().length-1}this._currentFrame=g,this._animationState.repeatCount=h===0?0:u/h>>0,this._animationState.highLimitValue=d,this._animationState.offsetValue=f;const v=o._interpolate(g,this._animationState);if(this.setValue(v,n),E.length){for(let b=0;b<E.length;b++)if(h>=0&&g>=E[b].frame&&E[b].frame>=t||h<0&&g<=E[b].frame&&E[b].frame<=t){const R=E[b];R.isDone||(R.onlyOnce&&(E.splice(b,1),b--),R.isDone=!0,R.action(g))}}return c||(this._stopped=!0),c}}class hf{get syncRoot(){return this._syncRoot}get masterFrame(){return this._runtimeAnimations.length===0?0:this._runtimeAnimations[0].currentFrame}get weight(){return this._weight}set weight(e){if(e===-1){this._weight=-1;return}this._weight=Math.min(Math.max(e,0),1)}get speedRatio(){return this._speedRatio}set speedRatio(e){for(let t=0;t<this._runtimeAnimations.length;t++)this._runtimeAnimations[t]._prepareForSpeedRatioChange(e);this._speedRatio=e,this._goToFrame!==null&&this.goToFrame(this._goToFrame)}get elapsedTime(){return this._localDelayOffset===null?0:this._scene._animationTime-this._localDelayOffset}constructor(e,t,i=0,r=100,s=!1,n=1,o,l,c,h=!1,f=0){this.target=t,this.fromFrame=i,this.toFrame=r,this.loopAnimation=s,this.onAnimationEnd=o,this.onAnimationLoop=c,this.isAdditive=h,this.playOrder=f,this._localDelayOffset=null,this._pausedDelay=null,this._manualJumpDelay=null,this._runtimeAnimations=new Array,this._paused=!1,this._speedRatio=1,this._weight=-1,this._previousWeight=-1,this._syncRoot=null,this._frameToSyncFromJump=null,this._goToFrame=null,this.disposeOnEnd=!0,this.animationStarted=!1,this.onAnimationEndObservable=new U,this.onAnimationLoopObservable=new U,this._scene=e,l&&this.appendAnimations(t,l),this._speedRatio=n,e._activeAnimatables.push(this)}syncWith(e){if(this._syncRoot=e,e){const t=this._scene._activeAnimatables.indexOf(this);t>-1&&(this._scene._activeAnimatables.splice(t,1),this._scene._activeAnimatables.push(this))}return this}getAnimations(){return this._runtimeAnimations}appendAnimations(e,t){for(let i=0;i<t.length;i++){const r=t[i],s=new HC(e,r,this._scene,this);s._onLoop=()=>{this.onAnimationLoopObservable.notifyObservers(this),this.onAnimationLoop&&this.onAnimationLoop()},this._runtimeAnimations.push(s)}}getAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i].animation;return null}getRuntimeAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i];return null}reset(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].reset(!0);this._localDelayOffset=null,this._pausedDelay=null}enableBlending(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)t[i].animation.enableBlending=!0,t[i].animation.blendingSpeed=e}disableBlending(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].animation.enableBlending=!1}goToFrame(e,t=!1){const i=this._runtimeAnimations;if(i[0]){const r=i[0].animation.framePerSecond;this._frameToSyncFromJump=this._frameToSyncFromJump??i[0].currentFrame;const s=this.speedRatio===0?0:(e-this._frameToSyncFromJump)/r*1e3/this.speedRatio;this._manualJumpDelay=-s}for(let r=0;r<i.length;r++)i[r].goToFrame(e,t?this._weight:-1);this._goToFrame=e}get paused(){return this._paused}pause(){this._paused||(this._paused=!0)}restart(){this._paused=!1}_raiseOnAnimationEnd(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this)}stop(e,t,i=!1,r=!1){if(e||t){const s=this._scene._activeAnimatables.indexOf(this);if(s>-1){const n=this._runtimeAnimations;for(let o=n.length-1;o>=0;o--){const l=n[o];e&&l.animation.name!=e||t&&!t(l.target)||(l.dispose(),n.splice(o,1))}n.length==0&&(i||this._scene._activeAnimatables.splice(s,1),r||this._raiseOnAnimationEnd())}}else{const s=this._scene._activeAnimatables.indexOf(this);if(s>-1){i||this._scene._activeAnimatables.splice(s,1);const n=this._runtimeAnimations;for(let o=0;o<n.length;o++)n[o].dispose();this._runtimeAnimations.length=0,r||this._raiseOnAnimationEnd()}}}waitAsync(){return new Promise(e=>{this.onAnimationEndObservable.add(()=>{e(this)},void 0,void 0,this,!0)})}_animate(e){if(this._paused)return this.animationStarted=!1,this._pausedDelay===null&&(this._pausedDelay=e),!0;if(this._localDelayOffset===null?(this._localDelayOffset=e,this._pausedDelay=null):this._pausedDelay!==null&&(this._localDelayOffset+=e-this._pausedDelay,this._pausedDelay=null),this._manualJumpDelay!==null&&(this._localDelayOffset+=this._manualJumpDelay,this._manualJumpDelay=null,this._frameToSyncFromJump=null),this._goToFrame=null,this._weight===0&&this._previousWeight===0)return!0;this._previousWeight=this._weight;let t=!1;const i=this._runtimeAnimations;let r;for(r=0;r<i.length;r++){const n=i[r].animate(e-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);t=t||n}if(this.animationStarted=t,!t){if(this.disposeOnEnd)for(r=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(r,1),r=0;r<i.length;r++)i[r].dispose();this._raiseOnAnimationEnd(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear())}return t}}function zC(a){if(a.totalWeight===0&&a.totalAdditiveWeight===0)return a.originalValue;let e=1;const t=F.Vector3[0],i=F.Vector3[1],r=F.Quaternion[0];let s=0;const n=a.animations[0],o=a.originalValue;let l=1,c=!1;if(a.totalWeight<1)l=1-a.totalWeight,o.decompose(i,r,t);else{if(s=1,e=a.totalWeight,l=n.weight/e,l==1)if(a.totalAdditiveWeight)c=!0;else return n.currentValue;n.currentValue.decompose(i,r,t)}if(!c){i.scaleInPlace(l),t.scaleInPlace(l),r.scaleInPlace(l);for(let f=s;f<a.animations.length;f++){const u=a.animations[f];if(u.weight===0)continue;l=u.weight/e;const d=F.Vector3[2],_=F.Vector3[3],p=F.Quaternion[1];u.currentValue.decompose(_,p,d),_.scaleAndAddToRef(l,i),p.scaleAndAddToRef(z.Dot(r,p)>0?l:-l,r),d.scaleAndAddToRef(l,t)}r.normalize()}for(let f=0;f<a.additiveAnimations.length;f++){const u=a.additiveAnimations[f];if(u.weight===0)continue;const d=F.Vector3[2],_=F.Vector3[3],p=F.Quaternion[1];u.currentValue.decompose(_,p,d),_.multiplyToRef(i,_),m.LerpToRef(i,_,u.weight,i),r.multiplyToRef(p,p),z.SlerpToRef(r,p,u.weight,r),d.scaleAndAddToRef(u.weight,t)}const h=n?n._animationState.workValue:F.Matrix[0].clone();return P.ComposeToRef(i,r,t,h),h}function YC(a,e){if(a.totalWeight===0&&a.totalAdditiveWeight===0)return e;const t=a.animations[0],i=a.originalValue;let r=e;if(a.totalWeight===0&&a.totalAdditiveWeight>0)r.copyFrom(i);else if(a.animations.length===1){if(z.SlerpToRef(i,t.currentValue,Math.min(1,a.totalWeight),r),a.totalAdditiveWeight===0)return r}else if(a.animations.length>1){let s=1,n,o;if(a.totalWeight<1){const c=1-a.totalWeight;n=[],o=[],n.push(i),o.push(c)}else{if(a.animations.length===2&&(z.SlerpToRef(a.animations[0].currentValue,a.animations[1].currentValue,a.animations[1].weight/a.totalWeight,e),a.totalAdditiveWeight===0))return e;n=[],o=[],s=a.totalWeight}for(let c=0;c<a.animations.length;c++){const h=a.animations[c];n.push(h.currentValue),o.push(h.weight/s)}let l=0;for(let c=0;c<n.length;){if(!c){z.SlerpToRef(n[c],n[c+1],o[c+1]/(o[c]+o[c+1]),e),r=e,l=o[c]+o[c+1],c+=2;continue}l+=o[c],z.SlerpToRef(r,n[c],o[c]/l,r),c++}}for(let s=0;s<a.additiveAnimations.length;s++){const n=a.additiveAnimations[s];n.weight!==0&&(r.multiplyToRef(n.currentValue,F.Quaternion[0]),z.SlerpToRef(r,F.Quaternion[0],n.weight,r))}return r}function KC(a){if(a._registeredForLateAnimationBindings.length){for(let e=0;e<a._registeredForLateAnimationBindings.length;e++){const t=a._registeredForLateAnimationBindings.data[e];for(const i in t._lateAnimationHolders){const r=t._lateAnimationHolders[i],s=r.animations[0],n=r.originalValue;if(n==null)continue;const o=W.AllowMatrixDecomposeForInterpolation&&n.m;let l=t[i];if(o)l=zC(r);else if(n.w!==void 0)l=YC(r,l||z.Identity());else{let h=0,f=1;const u=s&&s._animationState.loopMode===W.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT;if(r.totalWeight<1)u?l=n.clone?n.clone():n:s&&n.scale?l=n.scale(1-r.totalWeight):s?l=n*(1-r.totalWeight):n.clone?l=n.clone():l=n;else if(s){f=r.totalWeight;const d=s.weight/f;d!==1?s.currentValue.scale?l=s.currentValue.scale(d):l=s.currentValue*d:l=s.currentValue,u&&(l.addToRef?l.addToRef(n,l):l+=n),h=1}for(let d=h;d<r.animations.length;d++){const _=r.animations[d],p=_.weight/f;if(p)_.currentValue.scaleAndAddToRef?_.currentValue.scaleAndAddToRef(p,l):l+=_.currentValue*p;else continue}for(let d=0;d<r.additiveAnimations.length;d++){const _=r.additiveAnimations[d],p=_.weight;if(p)_.currentValue.scaleAndAddToRef?_.currentValue.scaleAndAddToRef(p,l):l+=_.currentValue*p;else continue}}t[i]=l}t._lateAnimationHolders={}}a._registeredForLateAnimationBindings.reset()}}function qC(a,e){e&&(e.prototype.copyAnimationRange=function(t,i,r,s=!1,n=null){this.animations.length===0&&(this.animations.push(new W(this.name,"_matrix",t.animations[0].framePerSecond,W.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));const o=t.animations[0].getRange(i);if(!o)return!1;const l=o.from,c=o.to,h=t.animations[0].getKeys(),f=t.length,u=t.getParent(),d=this.getParent(),_=s&&u&&f&&this.length&&f!==this.length,p=_&&d&&u?d.length/u.length:1,g=s&&!d&&n&&(n.x!==1||n.y!==1||n.z!==1),E=this.animations[0].getKeys();let v,b,R;for(let S=0,T=h.length;S<T;S++)v=h[S],v.frame>=l&&v.frame<=c&&(s?(R=v.value.clone(),_?(b=R.getTranslation(),R.setTranslation(b.scaleInPlace(p))):g&&n?(b=R.getTranslation(),R.setTranslation(b.multiplyInPlace(n))):R=v.value):R=v.value,E.push({frame:v.frame+r,value:R}));return this.animations[0].createRange(i,l+r,c+r),!0}),a&&(a.prototype._animate=function(t){if(!this.animationsEnabled)return;const i=Ti.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=i}this.deltaTime=t!==void 0?t:this.useConstantAnimationDeltaTime?16:(i-this._animationTimeLast)*this.animationTimeScale,this._animationTimeLast=i;const r=this._activeAnimatables;if(r.length===0)return;this._animationTime+=this.deltaTime;const s=this._animationTime;for(let n=0;n<r.length;n++){const o=r[n];!o._animate(s)&&o.disposeOnEnd&&n--}KC(this)},a.prototype.sortActiveAnimatables=function(){this._activeAnimatables.sort((t,i)=>t.playOrder-i.playOrder)},a.prototype.beginWeightedAnimation=function(t,i,r,s=1,n,o=1,l,c,h,f,u=!1){const d=this.beginAnimation(t,i,r,n,o,l,c,!1,h,f,u);return d.weight=s,d},a.prototype.beginAnimation=function(t,i,r,s,n=1,o,l,c=!0,h,f,u=!1){if(n<0){const _=i;i=r,r=_,n=-n}i>r&&(n=-n),c&&this.stopAnimation(t,void 0,h),l||(l=new hf(this,t,i,r,s,n,o,void 0,f,u));const d=h?h(t):!0;if(t.animations&&d&&l.appendAnimations(t,t.animations),t.getAnimatables){const _=t.getAnimatables();for(let p=0;p<_.length;p++)this.beginAnimation(_[p],i,r,s,n,o,l,c,h,f)}return l.reset(),l},a.prototype.beginHierarchyAnimation=function(t,i,r,s,n,o=1,l,c,h=!0,f,u,d=!1){const _=t.getDescendants(i),p=[];p.push(this.beginAnimation(t,r,s,n,o,l,c,h,f,void 0,d));for(const g of _)p.push(this.beginAnimation(g,r,s,n,o,l,c,h,f,void 0,d));return p},a.prototype.beginDirectAnimation=function(t,i,r,s,n,o=1,l,c,h=!1){if(o<0){const u=r;r=s,s=u,o=-o}return r>s&&(o=-o),new hf(this,t,r,s,n,o,l,i,c,h)},a.prototype.beginDirectHierarchyAnimation=function(t,i,r,s,n,o,l,c,h,f=!1){const u=t.getDescendants(i),d=[];d.push(this.beginDirectAnimation(t,r,s,n,o,l,c,h,f));for(const _ of u)d.push(this.beginDirectAnimation(_,r,s,n,o,l,c,h,f));return d},a.prototype.getAnimatableByTarget=function(t){for(let i=0;i<this._activeAnimatables.length;i++)if(this._activeAnimatables[i].target===t)return this._activeAnimatables[i];return null},a.prototype.getAllAnimatablesByTarget=function(t){const i=[];for(let r=0;r<this._activeAnimatables.length;r++)this._activeAnimatables[r].target===t&&i.push(this._activeAnimatables[r]);return i},a.prototype.stopAnimation=function(t,i,r){const s=this.getAllAnimatablesByTarget(t);for(const n of s)n.stop(i,r)},a.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(let t=0;t<this._activeAnimatables.length;t++)this._activeAnimatables[t].stop(void 0,void 0,!0);this._activeAnimatables.length=0}for(const t of this.animationGroups)t.stop()})}qC(Ge,mt);class Ag{get isFixedFoveationSupported(){return this.layerType=="XRWebGLLayer"&&typeof this.layer.fixedFoveation=="number"}get fixedFoveation(){return this.isFixedFoveationSupported?this.layer.fixedFoveation:null}set fixedFoveation(e){if(this.isFixedFoveationSupported){const t=Math.max(0,Math.min(1,e||0));this.layer.fixedFoveation=t}}createRenderTargetTextureProvider(e){return this._rttWrapper=this._createRenderTargetTextureProvider(e),this._rttWrapper}dispose(){this._rttWrapper&&(this._rttWrapper.dispose(),this._rttWrapper=null)}constructor(e,t,i,r,s){this.getWidth=e,this.getHeight=t,this.layer=i,this.layerType=r,this._createRenderTargetTextureProvider=s,this._rttWrapper=null}}class Rg{constructor(e,t){this._scene=e,this.layerWrapper=t,this._renderTargetTextures=new Array,this._engine=e.getEngine()}_createInternalTexture(e,t){const i=new Yt(this._engine,0,!0);return i.width=e.width,i.height=e.height,i._hardwareTexture=new wc(t,this._engine._gl),i.isReady=!0,i}_createRenderTargetTexture(e,t,i,r,s,n){if(!this._engine)throw new Error("Engine is disposed");const o={width:e,height:t},l=n?new fl(this._scene,o):new rr("XR renderTargetTexture",o,this._scene),c=l.renderTarget;if(c._samples=l.samples,(i||!r)&&(c._framebuffer=i),r)if(n)c._colorTextureArray=r;else{const h=this._createInternalTexture(o,r);c.setTexture(h,0),l._texture=h}return s&&(n?c._depthStencilTextureArray=s:c._depthStencilTexture=this._createInternalTexture(o,s)),l.disableRescaling(),this._renderTargetTextures.push(l),l}_destroyRenderTargetTexture(e){this._renderTargetTextures.splice(this._renderTargetTextures.indexOf(e),1),e.dispose()}getFramebufferDimensions(){return this._framebufferDimensions}dispose(){this._renderTargetTextures.forEach(e=>e.dispose()),this._renderTargetTextures.length=0}}class Cg extends Ag{constructor(e){super(()=>e.framebufferWidth,()=>e.framebufferHeight,e,"XRWebGLLayer",t=>new jC(t.scene,this)),this.layer=e}}class jC extends Rg{constructor(e,t){super(e,t),this.layerWrapper=t,this._layer=t.layer,this._framebufferDimensions={framebufferWidth:this._layer.framebufferWidth,framebufferHeight:this._layer.framebufferHeight}}trySetViewportForView(e,t){const i=this._layer.getViewport(t);if(!i)return!1;const r=this._framebufferDimensions.framebufferWidth,s=this._framebufferDimensions.framebufferHeight;return e.x=i.x/r,e.y=i.y/s,e.width=i.width/r,e.height=i.height/s,!0}getRenderTargetTextureForEye(e){const t=this._layer.framebufferWidth,i=this._layer.framebufferHeight,r=this._layer.framebuffer;return(!this._rtt||t!==this._framebufferDimensions.framebufferWidth||i!==this._framebufferDimensions.framebufferHeight||r!==this._framebuffer)&&(this._rtt=this._createRenderTargetTexture(t,i,r),this._framebufferDimensions.framebufferWidth=t,this._framebufferDimensions.framebufferHeight=i,this._framebuffer=r),this._rtt}getRenderTargetTextureForView(e){return this.getRenderTargetTextureForEye(e.eye)}}class to{static GetDefaults(e){const t=new to;return t.canvasOptions={antialias:!0,depth:!0,stencil:e?e.isStencilEnable:!0,alpha:!0,framebufferScaleFactor:1},t.newCanvasCssStyle="position:absolute; bottom:0px;right:0px;z-index:10;width:90%;height:100%;background-color: #000000;",t}}class ZC{constructor(e,t=to.GetDefaults()){if(this._options=t,this._canvas=null,this._engine=null,this.xrLayer=null,this._xrLayerWrapper=null,this.onXRLayerInitObservable=new U,this._engine=e.scene.getEngine(),this._engine.onDisposeObservable.addOnce(()=>{this._engine=null}),t.canvasElement)this._setManagedOutputCanvas(t.canvasElement);else{const i=document.createElement("canvas");i.style.cssText=this._options.newCanvasCssStyle||"position:absolute; bottom:0px;right:0px;",this._setManagedOutputCanvas(i)}e.onXRSessionInit.add(()=>{this._addCanvas()}),e.onXRSessionEnded.add(()=>{this._removeCanvas()}),this._makeCanvasCompatibleAsync()}dispose(){this._removeCanvas(),this._setManagedOutputCanvas(null),this.onXRLayerInitObservable.clear()}_makeCanvasCompatibleAsync(){this._canvasCompatiblePromise=new Promise((e,t)=>{try{this.canvasContext&&this.canvasContext.makeXRCompatible?this.canvasContext.makeXRCompatible().then(()=>{e()},()=>{k.Warn("Error executing makeXRCompatible. This does not mean that the session will work incorrectly."),e()}):e()}catch(i){t(i)}})}async initializeXRLayerAsync(e){const t=()=>(this.xrLayer=new XRWebGLLayer(e,this.canvasContext,this._options.canvasOptions),this._xrLayerWrapper=new Cg(this.xrLayer),this.onXRLayerInitObservable.notifyObservers(this.xrLayer),this.xrLayer);return this._canvasCompatiblePromise.then(()=>{},()=>{}).then(()=>t())}_addCanvas(){this._canvas&&this._engine&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.appendChild(this._canvas),this.xrLayer?this._setCanvasSize(!0):this.onXRLayerInitObservable.addOnce(()=>{this._setCanvasSize(!0)})}_removeCanvas(){this._canvas&&this._engine&&document.body.contains(this._canvas)&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.removeChild(this._canvas),this._setCanvasSize(!1)}_setCanvasSize(e=!0,t=this._xrLayerWrapper){!this._canvas||!this._engine||(e?t&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=t.getWidth()+"px",this._canvas.style.height=t.getHeight()+"px"):this._engine.setSize(t.getWidth(),t.getHeight())):this._originalCanvasSize&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=this._originalCanvasSize.width+"px",this._canvas.style.height=this._originalCanvasSize.height+"px"):this._engine.setSize(this._originalCanvasSize.width,this._originalCanvasSize.height)))}_setManagedOutputCanvas(e){this._removeCanvas(),e?(this._originalCanvasSize={width:e.offsetWidth,height:e.offsetHeight},this._canvas=e,this.canvasContext=this._canvas.getContext("webgl2"),this.canvasContext||(this.canvasContext=this._canvas.getContext("webgl"))):(this._canvas=null,this.canvasContext=null)}}class QC extends Ag{constructor(e){super(()=>e.framebufferWidth,()=>e.framebufferHeight,e,"XRWebGLLayer",t=>new $C(t,this)),this.layer=e}}class $C extends Rg{constructor(e,t){super(e.scene,t),this.layerWrapper=t,this._nativeRTTProvider=navigator.xr.getNativeRenderTargetProvider(e.session,this._createRenderTargetTexture.bind(this),this._destroyRenderTargetTexture.bind(this)),this._nativeLayer=t.layer}trySetViewportForView(e){return e.x=0,e.y=0,e.width=1,e.height=1,!0}getRenderTargetTextureForEye(e){return this._nativeRTTProvider.getRenderTargetForEye(e)}getRenderTargetTextureForView(e){return this._nativeRTTProvider.getRenderTargetForEye(e.eye)}getFramebufferDimensions(){return{framebufferWidth:this._nativeLayer.framebufferWidth,framebufferHeight:this._nativeLayer.framebufferHeight}}}class JC{constructor(e){this._nativeRenderTarget=navigator.xr.getWebXRRenderTarget(e.scene.getEngine())}async initializeXRLayerAsync(e){return await this._nativeRenderTarget.initializeXRLayerAsync(e),this.xrLayer=this._nativeRenderTarget.xrLayer,this.xrLayer}dispose(){}}class io{get worldScalingFactor(){return this._worldScalingFactor}set worldScalingFactor(e){const t=this._worldScalingFactor;this._worldScalingFactor=e,this.onWorldScaleFactorChangedObservable.notifyObservers({previousScaleFactor:t,newScaleFactor:e})}constructor(e){this.scene=e,this.currentTimestamp=-1,this.defaultHeightCompensation=1.7,this.onXRFrameObservable=new U,this.onXRReferenceSpaceChanged=new U,this.onXRSessionEnded=new U,this.onXRSessionInit=new U,this.onXRReferenceSpaceInitialized=new U,this.onXRReady=new U,this.inXRFrameLoop=!1,this.inXRSession=!1,this._worldScalingFactor=1,this.onWorldScaleFactorChangedObservable=new U(void 0,!0),this._engine=e.getEngine(),this._onEngineDisposedObserver=this._engine.onDisposeObservable.addOnce(()=>{this._engine=null}),e.onDisposeObservable.addOnce(()=>{this.dispose()})}get referenceSpace(){return this._referenceSpace}set referenceSpace(e){this._referenceSpace=e,this.onXRReferenceSpaceChanged.notifyObservers(this._referenceSpace)}get sessionMode(){return this._sessionMode}dispose(){var e;this.inXRSession&&this.exitXRAsync(),this.onXRReady.clear(),this.onXRFrameObservable.clear(),this.onXRSessionEnded.clear(),this.onXRReferenceSpaceChanged.clear(),this.onXRSessionInit.clear(),this.onWorldScaleFactorChangedObservable.clear(),(e=this._engine)==null||e.onDisposeObservable.remove(this._onEngineDisposedObserver),this._engine=null}async exitXRAsync(){if(this.session&&this.inXRSession){this.inXRSession=!1;try{return await this.session.end()}catch{B.Warn("Could not end XR session.")}}return Promise.resolve()}trySetViewportForView(e,t){var i;return((i=this._baseLayerRTTProvider)==null?void 0:i.trySetViewportForView(e,t))||!1}getRenderTargetTextureForEye(e){var t;return((t=this._baseLayerRTTProvider)==null?void 0:t.getRenderTargetTextureForEye(e))||null}getRenderTargetTextureForView(e){var t;return((t=this._baseLayerRTTProvider)==null?void 0:t.getRenderTargetTextureForView(e))||null}getWebXRRenderTarget(e){const t=this.scene.getEngine();return this._xrNavigator.xr.native?new JC(this):(e=e||to.GetDefaults(t),e.canvasElement=e.canvasElement||t.getRenderingCanvas()||void 0,new ZC(this,e))}initializeAsync(){return this._xrNavigator=navigator,this._xrNavigator.xr?Promise.resolve():Promise.reject("WebXR not available")}initializeSessionAsync(e="immersive-vr",t={}){return this._xrNavigator.xr.requestSession(e,t).then(i=>(this.session=i,this._sessionMode=e,this.inXRSession=!0,this.onXRSessionInit.notifyObservers(i),this.session.addEventListener("end",()=>{var r;this.inXRSession=!1,this.onXRSessionEnded.notifyObservers(null),this._engine&&(this._engine.framebufferDimensionsObject=null,this._engine.restoreDefaultFramebuffer(),this._engine.customAnimationFrameRequester=null,this._engine._renderLoop()),this.isNative&&((r=this._baseLayerRTTProvider)==null||r.dispose()),this._baseLayerRTTProvider=null,this._baseLayerWrapper=null},{once:!0}),this.session))}isSessionSupportedAsync(e){return io.IsSessionSupportedAsync(e)}resetReferenceSpace(){this.referenceSpace=this.baseReferenceSpace}runXRRenderLoop(){var e;!this.inXRSession||!this._engine||(this._engine.customAnimationFrameRequester={requestAnimationFrame:t=>this.session.requestAnimationFrame(t),renderFunction:(t,i)=>{var r;if(!(!this.inXRSession||!this._engine)&&(this.currentFrame=i,this.currentTimestamp=t,i)){this.inXRFrameLoop=!0;const s=((r=this._baseLayerRTTProvider)==null?void 0:r.getFramebufferDimensions())||null;this._engine.framebufferDimensionsObject!==s&&(this._engine.framebufferDimensionsObject=s),this.onXRFrameObservable.notifyObservers(i),this._engine._renderLoop(),this._engine.framebufferDimensionsObject=null,this.inXRFrameLoop=!1}}},this._engine.framebufferDimensionsObject=((e=this._baseLayerRTTProvider)==null?void 0:e.getFramebufferDimensions())||null,this.onXRFrameObservable.addOnce(()=>{this.onXRReady.notifyObservers(this)}),typeof window<"u"&&window.cancelAnimationFrame&&window.cancelAnimationFrame(this._engine._frameHandler),this._engine._renderLoop())}setReferenceSpaceTypeAsync(e="local-floor"){return this.session.requestReferenceSpace(e).then(t=>t,t=>(B.Error("XR.requestReferenceSpace failed for the following reason: "),B.Error(t),B.Log('Defaulting to universally-supported "viewer" reference space type.'),this.session.requestReferenceSpace("viewer").then(i=>{const r=new XRRigidTransform({x:0,y:-this.defaultHeightCompensation,z:0});return i.getOffsetReferenceSpace(r)},i=>{throw B.Error(i),'XR initialization failed: required "viewer" reference space type not supported.'}))).then(t=>this.session.requestReferenceSpace("viewer").then(i=>(this.viewerReferenceSpace=i,t))).then(t=>(this.referenceSpace=this.baseReferenceSpace=t,this.onXRReferenceSpaceInitialized.notifyObservers(t),this.referenceSpace))}updateRenderStateAsync(e){return Promise.resolve(this.session.updateRenderState(e))}_setBaseLayerWrapper(e){var t,i;this.isNative&&((t=this._baseLayerRTTProvider)==null||t.dispose()),this._baseLayerWrapper=e,this._baseLayerRTTProvider=((i=this._baseLayerWrapper)==null?void 0:i.createRenderTargetTextureProvider(this))||null}_getBaseLayerWrapper(){return this._baseLayerWrapper}updateRenderState(e){e.baseLayer&&this._setBaseLayerWrapper(this.isNative?new QC(e.baseLayer):new Cg(e.baseLayer)),this.session.updateRenderState(e)}static IsSessionSupportedAsync(e){if(!navigator.xr)return Promise.resolve(!1);const t=navigator.xr.isSessionSupported||navigator.xr.supportsSession;return t?t.call(navigator.xr,e).then(i=>{const r=typeof i>"u"?!0:i;return Promise.resolve(r)}).catch(i=>(B.Warn(i),Promise.resolve(!1))):Promise.resolve(!1)}get isNative(){return this._xrNavigator.xr.native??!1}get currentFrameRate(){var e;return(e=this.session)==null?void 0:e.frameRate}get supportedFrameRates(){var e;return(e=this.session)==null?void 0:e.supportedFrameRates}updateTargetFrameRate(e){return this.session.updateTargetFrameRate(e)}runInXRFrame(e,t=!0){this.inXRFrameLoop?e():(this.inXRSession||!t)&&this.onXRFrameObservable.addOnce(e)}get isFixedFoveationSupported(){var e;return((e=this._baseLayerWrapper)==null?void 0:e.isFixedFoveationSupported)||!1}get fixedFoveation(){var e;return((e=this._baseLayerWrapper)==null?void 0:e.fixedFoveation)||null}set fixedFoveation(e){const t=Math.max(0,Math.min(1,e||0));this._baseLayerWrapper&&(this._baseLayerWrapper.fixedFoveation=t)}get enabledFeatures(){var e;return((e=this.session)==null?void 0:e.enabledFeatures)??null}}function Ig(a){const e=[],t=[],i=[],r=[],s=a.diameter||1,n=a.thickness||.5,o=(a.tessellation||16)|0,l=a.sideOrientation===0?0:a.sideOrientation||ee.DEFAULTSIDE,c=o+1;for(let f=0;f<=o;f++){const u=f/o,d=f*Math.PI*2/o-Math.PI/2,_=P.Translation(s/2,0,0).multiply(P.RotationY(d));for(let p=0;p<=o;p++){const g=1-p/o,E=p*Math.PI*2/o+Math.PI,v=Math.cos(E),b=Math.sin(E);let R=new m(v,b,0),S=R.scale(n/2);const T=new ne(u,g);S=m.TransformCoordinates(S,_),R=m.TransformNormal(R,_),t.push(S.x,S.y,S.z),i.push(R.x,R.y,R.z),r.push(T.x,T.y);const I=(f+1)%c,O=(p+1)%c;e.push(f*c+p),e.push(f*c+O),e.push(I*c+p),e.push(f*c+O),e.push(I*c+O),e.push(I*c+p)}}ee._ComputeSides(l,t,e,i,r,a.frontUVs,a.backUVs);const h=new ee;return h.indices=e,h.positions=t,h.normals=i,h.uvs=r,h}function Rs(a,e={},t){const i=new N(a,t);return e.sideOrientation=N._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,Ig(e).applyToMesh(i,e.updatable),i}ee.CreateTorus=Ig;N.CreateTorus=(a,e,t,i,r,s,n)=>Rs(a,{diameter:e,thickness:t,tessellation:i,sideOrientation:n,updatable:s},r);class ro{constructor(e,t=null){if(this.scene=e,this._pointerDownOnMeshAsked=!1,this._isActionableMesh=!1,this._teleportationRequestInitiated=!1,this._teleportationBackRequestInitiated=!1,this._rotationRightAsked=!1,this._rotationLeftAsked=!1,this._dpadPressed=!0,this._activePointer=!1,this._id=ro._IdCounter++,t)this._gazeTracker=t.clone("gazeTracker");else{this._gazeTracker=Rs("gazeTracker",{diameter:.0035,thickness:.0025,tessellation:20,updatable:!1},e),this._gazeTracker.bakeCurrentTransformIntoVertices(),this._gazeTracker.isPickable=!1,this._gazeTracker.isVisible=!1;const i=new se("targetMat",e);i.specularColor=ae.Black(),i.emissiveColor=new ae(.7,.7,.7),i.backFaceCulling=!1,this._gazeTracker.material=i}}_getForwardRay(e){return new He(m.Zero(),new m(0,0,e))}_selectionPointerDown(){this._pointerDownOnMeshAsked=!0,this._currentHit&&this.scene.simulatePointerDown(this._currentHit,{pointerId:this._id})}_selectionPointerUp(){this._currentHit&&this.scene.simulatePointerUp(this._currentHit,{pointerId:this._id}),this._pointerDownOnMeshAsked=!1}_activatePointer(){this._activePointer=!0}_deactivatePointer(){this._activePointer=!1}_updatePointerDistance(e=100){}dispose(){this._interactionsEnabled=!1,this._teleportationEnabled=!1,this._gazeTracker&&this._gazeTracker.dispose()}}ro._IdCounter=0;class ff extends ro{constructor(e,t){super(t),this._getCamera=e}_getForwardRay(e){const t=this._getCamera();return t?t.getForwardRay(e):new He(m.Zero(),m.Forward())}}class tn{get onEnteringVR(){return this.onEnteringVRObservable}get onExitingVR(){return this.onExitingVRObservable}get teleportationTarget(){return this._teleportationTarget}set teleportationTarget(e){e&&(e.name="teleportationTarget",this._isDefaultTeleportationTarget=!1,this._teleportationTarget=e)}get gazeTrackerMesh(){return this._cameraGazer._gazeTracker}set gazeTrackerMesh(e){e&&(this._cameraGazer._gazeTracker&&this._cameraGazer._gazeTracker.dispose(),this._cameraGazer._gazeTracker=e,this._cameraGazer._gazeTracker.bakeCurrentTransformIntoVertices(),this._cameraGazer._gazeTracker.isPickable=!1,this._cameraGazer._gazeTracker.isVisible=!1,this._cameraGazer._gazeTracker.name="gazeTracker")}get displayGaze(){return this._displayGaze}set displayGaze(e){this._displayGaze=e,e||(this._cameraGazer._gazeTracker.isVisible=!1)}get displayLaserPointer(){return this._displayLaserPointer}set displayLaserPointer(e){this._displayLaserPointer=e}get deviceOrientationCamera(){return this._deviceOrientationCamera}get currentVRCamera(){return this._scene.activeCamera}get vrDeviceOrientationCamera(){return this._vrDeviceOrientationCamera}get vrButton(){return this._btnVR}get _teleportationRequestInitiated(){return this._cameraGazer._teleportationRequestInitiated}constructor(e,t={}){if(this.webVROptions=t,this._fullscreenVRpresenting=!1,this.enableGazeEvenWhenNoPointerLock=!1,this.exitVROnDoubleTap=!0,this.onEnteringVRObservable=new U,this.onAfterEnteringVRObservable=new U,this.onExitingVRObservable=new U,this._useCustomVRButton=!1,this._teleportActive=!1,this._floorMeshesCollection=[],this._teleportationMode=tn.TELEPORTATIONMODE_CONSTANTTIME,this._teleportationTime=122,this._teleportationSpeed=20,this._rotationAllowed=!0,this._teleportBackwardsVector=new m(0,-1,-1),this._isDefaultTeleportationTarget=!0,this._teleportationFillColor="#444444",this._teleportationBorderColor="#FFFFFF",this._rotationAngle=0,this._haloCenter=new m(0,0,0),this._padSensibilityUp=.65,this._padSensibilityDown=.35,this._pickedLaserColor=new ae(.2,.2,1),this._pickedGazeColor=new ae(0,0,1),this.onNewMeshSelected=new U,this.onNewMeshPicked=new U,this.onBeforeCameraTeleport=new U,this.onAfterCameraTeleport=new U,this.onSelectedMeshUnselected=new U,this.teleportationEnabled=!0,this._teleportationInitialized=!1,this._interactionsEnabled=!1,this._displayGaze=!0,this._displayLaserPointer=!0,this.updateGazeTrackerScale=!0,this.updateGazeTrackerColor=!0,this.updateControllerLaserColor=!0,this.requestPointerLockOnFullScreen=!0,this.xrTestDone=!1,this._onResize=()=>{this._moveButtonToBottomRight()},this._onFullscreenChange=()=>{this._fullscreenVRpresenting=!!document.fullscreenElement,!this._fullscreenVRpresenting&&this._inputElement&&(this.exitVR(),!this._useCustomVRButton&&this._btnVR&&(this._btnVR.style.top=this._inputElement.offsetTop+this._inputElement.offsetHeight-70+"px",this._btnVR.style.left=this._inputElement.offsetLeft+this._inputElement.offsetWidth-100+"px",this._updateButtonVisibility()))},this._cachedAngularSensibility={angularSensibilityX:null,angularSensibilityY:null,angularSensibility:null},this._beforeRender=()=>{this._scene.getEngine().isPointerLock||this.enableGazeEvenWhenNoPointerLock||(this._cameraGazer._gazeTracker.isVisible=!1)},this._onNewGamepadConnected=r=>{r.type!==Wt.POSE_ENABLED&&(r.leftStick&&r.onleftstickchanged(s=>{this._teleportationInitialized&&this.teleportationEnabled&&(this._checkTeleportWithRay(s,this._cameraGazer),this._checkTeleportBackwards(s,this._cameraGazer))}),r.rightStick&&r.onrightstickchanged(s=>{this._teleportationInitialized&&this._checkRotate(s,this._cameraGazer)}),r.type===Wt.XBOX&&(r.onbuttondown(s=>{this._interactionsEnabled&&s===0&&this._cameraGazer._selectionPointerDown()}),r.onbuttonup(s=>{this._interactionsEnabled&&s===0&&this._cameraGazer._selectionPointerUp()})))},this._workingVector=m.Zero(),this._workingQuaternion=z.Identity(),this._workingMatrix=P.Identity(),B.Warn("WebVR is deprecated. Please avoid using this experience helper and use the WebXR experience helper instead"),this._scene=e,this._inputElement=e.getEngine().getInputElement(),!("getVRDisplays"in navigator)&&t.useXR===void 0&&(t.useXR=!0),t.createFallbackVRDeviceOrientationFreeCamera===void 0&&(t.createFallbackVRDeviceOrientationFreeCamera=!0),t.createDeviceOrientationCamera===void 0&&(t.createDeviceOrientationCamera=!0),t.laserToggle===void 0&&(t.laserToggle=!0),this._hasEnteredVR=!1,this._scene.activeCamera?this._position=this._scene.activeCamera.position.clone():this._position=new m(0,this._defaultHeight,0),t.createDeviceOrientationCamera||!this._scene.activeCamera){if(this._deviceOrientationCamera=new kc("deviceOrientationVRHelper",this._position.clone(),e),this._scene.activeCamera&&(this._deviceOrientationCamera.minZ=this._scene.activeCamera.minZ,this._deviceOrientationCamera.maxZ=this._scene.activeCamera.maxZ,this._scene.activeCamera instanceof Dt&&this._scene.activeCamera.rotation)){const r=this._scene.activeCamera;r.rotationQuaternion?this._deviceOrientationCamera.rotationQuaternion.copyFrom(r.rotationQuaternion):this._deviceOrientationCamera.rotationQuaternion.copyFrom(z.RotationYawPitchRoll(r.rotation.y,r.rotation.x,r.rotation.z)),this._deviceOrientationCamera.rotation=r.rotation.clone()}this._scene.activeCamera=this._deviceOrientationCamera,this._inputElement&&this._scene.activeCamera.attachControl()}else this._existingCamera=this._scene.activeCamera;this.webVROptions.useXR&&navigator.xr?io.IsSessionSupportedAsync("immersive-vr").then(r=>{r?(B.Log("Using WebXR. It is recommended to use the WebXRDefaultExperience directly"),e.createDefaultXRExperienceAsync({floorMeshes:t.floorMeshes||[]}).then(s=>{this.xr=s,this.xrTestDone=!0,this._cameraGazer=new ff(()=>this.xr.baseExperience.camera,e),this.xr.baseExperience.onStateChangedObservable.add(n=>{switch(n){case 0:this.onEnteringVRObservable.notifyObservers(this),this._interactionsEnabled||this.xr.pointerSelection.detach(),this.xr.pointerSelection.displayLaserPointer=this._displayLaserPointer;break;case 1:this.onExitingVRObservable.notifyObservers(this),this._scene.getEngine().resize();break;case 2:this._hasEnteredVR=!0;break;case 3:this._hasEnteredVR=!1;break}})})):this._completeVRInit(e,t)}):this._completeVRInit(e,t)}_completeVRInit(e,t){if(this.xrTestDone=!0,t.createFallbackVRDeviceOrientationFreeCamera&&(this._vrDeviceOrientationCamera=new Eg("VRDeviceOrientationVRHelper",this._position,this._scene,!0,t.vrDeviceOrientationCameraMetrics),this._vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._cameraGazer=new ff(()=>this.currentVRCamera,e),!this._useCustomVRButton){this._btnVR=document.createElement("BUTTON"),this._btnVR.className="babylonVRicon",this._btnVR.id="babylonVRiconbtn",this._btnVR.title="Click to switch to VR";let s=".babylonVRicon { position: absolute; right: 20px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+(window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A":"https://cdn.babylonjs.com/Assets/vrButton.png")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";s+=".babylonVRicon.vrdisplaypresenting { display: none; }";const n=document.createElement("style");n.appendChild(document.createTextNode(s)),document.getElementsByTagName("head")[0].appendChild(n),this._moveButtonToBottomRight()}this._btnVR&&this._btnVR.addEventListener("click",()=>{this.isInVRMode||this.enterVR()});const i=this._scene.getEngine().getHostWindow();i&&(i.addEventListener("resize",this._onResize),document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),t.createFallbackVRDeviceOrientationFreeCamera&&this._displayVRButton(),this._onKeyDown=r=>{r.keyCode===27&&this.isInVRMode&&this.exitVR()},document.addEventListener("keydown",this._onKeyDown),this._scene.onPrePointerObservable.add(()=>{this._hasEnteredVR&&this.exitVROnDoubleTap&&(this.exitVR(),this._fullscreenVRpresenting&&this._scene.getEngine().exitFullscreen())},ge.POINTERDOUBLETAP,!1),e.onDisposeObservable.add(()=>{this.dispose()}),this._updateButtonVisibility(),this._circleEase=new jm,this._circleEase.setEasingMode(kt.EASINGMODE_EASEINOUT),this._teleportationEasing=this._circleEase,e.onPointerObservable.add(r=>{this._interactionsEnabled&&e.activeCamera===this.vrDeviceOrientationCamera&&r.event.pointerType==="mouse"&&(r.type===ge.POINTERDOWN?this._cameraGazer._selectionPointerDown():r.type===ge.POINTERUP&&this._cameraGazer._selectionPointerUp())}),this.webVROptions.floorMeshes&&this.enableTeleportation({floorMeshes:this.webVROptions.floorMeshes}))}get isInVRMode(){return this.xr&&this.webVROptions.useXR&&this.xr.baseExperience.state===2||this._fullscreenVRpresenting}_moveButtonToBottomRight(){if(this._inputElement&&!this._useCustomVRButton&&this._btnVR){const e=this._inputElement.getBoundingClientRect();this._btnVR.style.top=e.top+e.height-70+"px",this._btnVR.style.left=e.left+e.width-100+"px"}}_displayVRButton(){!this._useCustomVRButton&&!this._btnVRDisplayed&&this._btnVR&&(document.body.appendChild(this._btnVR),this._btnVRDisplayed=!0)}_updateButtonVisibility(){!this._btnVR||this._useCustomVRButton||(this._btnVR.className="babylonVRicon",this.isInVRMode&&(this._btnVR.className+=" vrdisplaypresenting"))}enterVR(){if(this.xr){this.xr.baseExperience.enterXRAsync("immersive-vr","local-floor",this.xr.renderTarget);return}if(this.onEnteringVRObservable)try{this.onEnteringVRObservable.notifyObservers(this)}catch(e){B.Warn("Error in your custom logic onEnteringVR: "+e)}this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone(),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.rotation=z.FromRotationMatrix(this._scene.activeCamera.getWorldMatrix().getRotationMatrix()).toEulerAngles(),this.vrDeviceOrientationCamera.angularSensibility=2e3),this._existingCamera=this._scene.activeCamera,this._existingCamera.angularSensibilityX&&(this._cachedAngularSensibility.angularSensibilityX=this._existingCamera.angularSensibilityX,this._existingCamera.angularSensibilityX=Number.MAX_VALUE),this._existingCamera.angularSensibilityY&&(this._cachedAngularSensibility.angularSensibilityY=this._existingCamera.angularSensibilityY,this._existingCamera.angularSensibilityY=Number.MAX_VALUE),this._existingCamera.angularSensibility&&(this._cachedAngularSensibility.angularSensibility=this._existingCamera.angularSensibility,this._existingCamera.angularSensibility=Number.MAX_VALUE)),this._vrDeviceOrientationCamera&&(this._vrDeviceOrientationCamera.position=this._position,this._scene.activeCamera&&(this._vrDeviceOrientationCamera.minZ=this._scene.activeCamera.minZ),this._scene.activeCamera=this._vrDeviceOrientationCamera,this._scene.getEngine().enterFullscreen(this.requestPointerLockOnFullScreen),this._updateButtonVisibility(),this._vrDeviceOrientationCamera.onViewMatrixChangedObservable.addOnce(()=>{this.onAfterEnteringVRObservable.notifyObservers({success:!0})})),this._scene.activeCamera&&this._inputElement&&this._scene.activeCamera.attachControl(),this._interactionsEnabled&&this._scene.registerBeforeRender(this._beforeRender),this._hasEnteredVR=!0}exitVR(){if(this.xr){this.xr.baseExperience.exitXRAsync();return}if(this._hasEnteredVR){if(this.onExitingVRObservable)try{this.onExitingVRObservable.notifyObservers(this)}catch(e){B.Warn("Error in your custom logic onExitingVR: "+e)}this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone()),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._deviceOrientationCamera?(this._deviceOrientationCamera.position=this._position,this._scene.activeCamera=this._deviceOrientationCamera,this._cachedAngularSensibility.angularSensibilityX&&(this._deviceOrientationCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._deviceOrientationCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._deviceOrientationCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)):this._existingCamera&&(this._existingCamera.position=this._position,this._scene.activeCamera=this._existingCamera,this._inputElement&&this._scene.activeCamera.attachControl(),this._cachedAngularSensibility.angularSensibilityX&&(this._existingCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._existingCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._existingCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)),this._updateButtonVisibility(),this._interactionsEnabled&&(this._scene.unregisterBeforeRender(this._beforeRender),this._cameraGazer._gazeTracker.isVisible=!1),this._scene.getEngine().resize(),this._hasEnteredVR=!1}}get position(){return this._position}set position(e){this._position=e,this._scene.activeCamera&&(this._scene.activeCamera.position=e)}enableInteractions(){if(!this._interactionsEnabled){if(this.xr){this.xr.baseExperience.state===2&&this.xr.pointerSelection.attach();return}this.raySelectionPredicate=e=>e.isVisible&&(e.isPickable||e.name===this._floorMeshName),this.meshSelectionPredicate=()=>!0,this._raySelectionPredicate=e=>this._isTeleportationFloor(e)||e.name.indexOf("gazeTracker")===-1&&e.name.indexOf("teleportationTarget")===-1&&e.name.indexOf("torusTeleportation")===-1?this.raySelectionPredicate(e):!1,this._interactionsEnabled=!0}}_isTeleportationFloor(e){for(let t=0;t<this._floorMeshesCollection.length;t++)if(this._floorMeshesCollection[t].id===e.id)return!0;return!!(this._floorMeshName&&e.name===this._floorMeshName)}addFloorMesh(e){this._floorMeshesCollection&&(this._floorMeshesCollection.indexOf(e)>-1||this._floorMeshesCollection.push(e))}removeFloorMesh(e){if(!this._floorMeshesCollection)return;const t=this._floorMeshesCollection.indexOf(e);t!==-1&&this._floorMeshesCollection.splice(t,1)}enableTeleportation(e={}){if(!this._teleportationInitialized){if(this.enableInteractions(),this.webVROptions.useXR&&(e.floorMeshes||e.floorMeshName)){const i=e.floorMeshes||[];if(!i.length){const r=this._scene.getMeshByName(e.floorMeshName);r&&i.push(r)}if(this.xr){i.forEach(r=>{this.xr.teleportation.addFloorMesh(r)}),this.xr.teleportation.attached||this.xr.teleportation.attach();return}else if(!this.xrTestDone){const r=()=>{this.xrTestDone&&(this._scene.unregisterBeforeRender(r),this.xr?this.xr.teleportation.attached||this.xr.teleportation.attach():this.enableTeleportation(e))};this._scene.registerBeforeRender(r);return}}e.floorMeshName&&(this._floorMeshName=e.floorMeshName),e.floorMeshes&&(this._floorMeshesCollection=e.floorMeshes),e.teleportationMode&&(this._teleportationMode=e.teleportationMode),e.teleportationTime&&e.teleportationTime>0&&(this._teleportationTime=e.teleportationTime),e.teleportationSpeed&&e.teleportationSpeed>0&&(this._teleportationSpeed=e.teleportationSpeed),e.easingFunction!==void 0&&(this._teleportationEasing=e.easingFunction);const t=new ze;t.vignetteColor=new Ne(0,0,0,0),t.vignetteEnabled=!0,this._teleportationInitialized=!0,this._isDefaultTeleportationTarget&&this._createTeleportationCircles()}}_checkTeleportWithRay(e,t){this._teleportationRequestInitiated&&!t._teleportationRequestInitiated||(t._teleportationRequestInitiated?Math.sqrt(e.y*e.y+e.x*e.x)<this._padSensibilityDown&&(this._teleportActive&&this.teleportCamera(this._haloCenter),t._teleportationRequestInitiated=!1):e.y<-this._padSensibilityUp&&t._dpadPressed&&(t._activatePointer(),t._teleportationRequestInitiated=!0))}_checkRotate(e,t){t._teleportationRequestInitiated||(t._rotationLeftAsked?e.x>-this._padSensibilityDown&&(t._rotationLeftAsked=!1):e.x<-this._padSensibilityUp&&t._dpadPressed&&(t._rotationLeftAsked=!0,this._rotationAllowed&&this._rotateCamera(!1)),t._rotationRightAsked?e.x<this._padSensibilityDown&&(t._rotationRightAsked=!1):e.x>this._padSensibilityUp&&t._dpadPressed&&(t._rotationRightAsked=!0,this._rotationAllowed&&this._rotateCamera(!0)))}_checkTeleportBackwards(e,t){if(!t._teleportationRequestInitiated)if(e.y>this._padSensibilityUp&&t._dpadPressed){if(!t._teleportationBackRequestInitiated){if(!this.currentVRCamera)return;const i=z.FromRotationMatrix(this.currentVRCamera.getWorldMatrix().getRotationMatrix()),r=this.currentVRCamera.position;i.toEulerAnglesToRef(this._workingVector),this._workingVector.z=0,this._workingVector.x=0,z.RotationYawPitchRollToRef(this._workingVector.y,this._workingVector.x,this._workingVector.z,this._workingQuaternion),this._workingQuaternion.toRotationMatrix(this._workingMatrix),m.TransformCoordinatesToRef(this._teleportBackwardsVector,this._workingMatrix,this._workingVector);const s=new He(r,this._workingVector),n=this._scene.pickWithRay(s,this._raySelectionPredicate);n&&n.pickedPoint&&n.pickedMesh&&this._isTeleportationFloor(n.pickedMesh)&&n.distance<5&&this.teleportCamera(n.pickedPoint),t._teleportationBackRequestInitiated=!0}}else t._teleportationBackRequestInitiated=!1}_createTeleportationCircles(){this._teleportationTarget=za("teleportationTarget",{width:2,height:2,subdivisions:2},this._scene),this._teleportationTarget.isPickable=!1;const e=512,t=new Mn("DynamicTexture",e,this._scene,!0);t.hasAlpha=!0;const i=t.getContext(),r=e/2,s=e/2,n=200;i.beginPath(),i.arc(r,s,n,0,2*Math.PI,!1),i.fillStyle=this._teleportationFillColor,i.fill(),i.lineWidth=10,i.strokeStyle=this._teleportationBorderColor,i.stroke(),i.closePath(),t.update();const o=new se("TextPlaneMaterial",this._scene);o.diffuseTexture=t,this._teleportationTarget.material=o;const l=Rs("torusTeleportation",{diameter:.75,thickness:.1,tessellation:25,updatable:!1},this._scene);l.isPickable=!1,l.parent=this._teleportationTarget;const c=new W("animationInnerCircle","position.y",30,W.ANIMATIONTYPE_FLOAT,W.ANIMATIONLOOPMODE_CYCLE),h=[];h.push({frame:0,value:0}),h.push({frame:30,value:.4}),h.push({frame:60,value:0}),c.setKeys(h);const f=new $m;f.setEasingMode(kt.EASINGMODE_EASEINOUT),c.setEasingFunction(f),l.animations=[],l.animations.push(c),this._scene.beginAnimation(l,0,60,!0),this._hideTeleportationTarget()}_hideTeleportationTarget(){this._teleportActive=!1,this._teleportationInitialized&&(this._teleportationTarget.isVisible=!1,this._isDefaultTeleportationTarget&&(this._teleportationTarget.getChildren()[0].isVisible=!1))}_rotateCamera(e){if(!(this.currentVRCamera instanceof sr))return;e?this._rotationAngle++:this._rotationAngle--,this.currentVRCamera.animations=[];const t=z.FromRotationMatrix(P.RotationY(Math.PI/4*this._rotationAngle)),i=new W("animationRotation","rotationQuaternion",90,W.ANIMATIONTYPE_QUATERNION,W.ANIMATIONLOOPMODE_CONSTANT),r=[];r.push({frame:0,value:this.currentVRCamera.rotationQuaternion}),r.push({frame:6,value:t}),i.setKeys(r),i.setEasingFunction(this._circleEase),this.currentVRCamera.animations.push(i),this._postProcessMove.animations=[];const s=new W("animationPP","vignetteWeight",90,W.ANIMATIONTYPE_FLOAT,W.ANIMATIONLOOPMODE_CONSTANT),n=[];n.push({frame:0,value:0}),n.push({frame:3,value:4}),n.push({frame:6,value:0}),s.setKeys(n),s.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(s);const o=new W("animationPP2","vignetteStretch",90,W.ANIMATIONTYPE_FLOAT,W.ANIMATIONLOOPMODE_CONSTANT),l=[];l.push({frame:0,value:0}),l.push({frame:3,value:10}),l.push({frame:6,value:0}),o.setKeys(l),o.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(o),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._postProcessMove.samples=4,this._scene.beginAnimation(this.currentVRCamera,0,6,!1,1)}teleportCamera(e){if(!(this.currentVRCamera instanceof sr))return;this._workingVector.copyFrom(e),this.isInVRMode||(this._workingVector.y+=this._defaultHeight),this.onBeforeCameraTeleport.notifyObservers(this._workingVector);const t=90;let i,r;if(this._teleportationMode==tn.TELEPORTATIONMODE_CONSTANTSPEED){r=t;const u=m.Distance(this.currentVRCamera.position,this._workingVector);i=this._teleportationSpeed/u}else r=Math.round(this._teleportationTime*t/1e3),i=1;this.currentVRCamera.animations=[];const s=new W("animationCameraTeleportation","position",t,W.ANIMATIONTYPE_VECTOR3,W.ANIMATIONLOOPMODE_CONSTANT),n=[{frame:0,value:this.currentVRCamera.position},{frame:r,value:this._workingVector}];s.setKeys(n),s.setEasingFunction(this._teleportationEasing),this.currentVRCamera.animations.push(s),this._postProcessMove.animations=[];const o=Math.round(r/2),l=new W("animationPP","vignetteWeight",t,W.ANIMATIONTYPE_FLOAT,W.ANIMATIONLOOPMODE_CONSTANT),c=[];c.push({frame:0,value:0}),c.push({frame:o,value:8}),c.push({frame:r,value:0}),l.setKeys(c),this._postProcessMove.animations.push(l);const h=new W("animationPP2","vignetteStretch",t,W.ANIMATIONTYPE_FLOAT,W.ANIMATIONLOOPMODE_CONSTANT),f=[];f.push({frame:0,value:0}),f.push({frame:o,value:10}),f.push({frame:r,value:0}),h.setKeys(f),this._postProcessMove.animations.push(h),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._scene.beginAnimation(this.currentVRCamera,0,r,!1,i,()=>{this.onAfterCameraTeleport.notifyObservers(this._workingVector)}),this._hideTeleportationTarget()}setLaserColor(e,t=this._pickedLaserColor){this._pickedLaserColor=t}setLaserLightingState(e=!0){}setGazeColor(e,t=this._pickedGazeColor){this._pickedGazeColor=t}changeLaserColor(e){this.updateControllerLaserColor}changeGazeColor(e){this.updateGazeTrackerColor&&this._cameraGazer._gazeTracker.material&&(this._cameraGazer._gazeTracker.material.emissiveColor=e)}dispose(){this.isInVRMode&&this.exitVR(),this._postProcessMove&&this._postProcessMove.dispose(),this._vrDeviceOrientationCamera&&this._vrDeviceOrientationCamera.dispose(),!this._useCustomVRButton&&this._btnVR&&this._btnVR.parentNode&&document.body.removeChild(this._btnVR),this._deviceOrientationCamera&&this._scene.activeCamera!=this._deviceOrientationCamera&&this._deviceOrientationCamera.dispose(),this._cameraGazer&&this._cameraGazer.dispose(),this._teleportationTarget&&this._teleportationTarget.dispose(),this.xr&&this.xr.dispose(),this._floorMeshesCollection.length=0,document.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChangeBind),window.removeEventListener("resize",this._onResize),document.removeEventListener("fullscreenchange",this._onFullscreenChange),this._scene.gamepadManager.onGamepadConnectedObservable.removeCallback(this._onNewGamepadConnected),this._scene.unregisterBeforeRender(this._beforeRender)}getClassName(){return"VRExperienceHelper"}}tn.TELEPORTATIONMODE_CONSTANTTIME=0;tn.TELEPORTATIONMODE_CONSTANTSPEED=1;const eI=542327876,uf=131072,df=512,_f=4,pf=64,mf=131072;function so(a){return a.charCodeAt(0)+(a.charCodeAt(1)<<8)+(a.charCodeAt(2)<<16)+(a.charCodeAt(3)<<24)}function tI(a){return String.fromCharCode(a&255,a>>8&255,a>>16&255,a>>24&255)}const gf=so("DXT1"),Ef=so("DXT3"),vf=so("DXT5"),Go=so("DX10"),Tf=113,Sf=116,Af=2,Rf=10,iI=88,ko=31,rI=0,sI=1,Cf=2,If=3,Wo=4,bf=7,Xo=20,xf=21,nI=22,aI=23,oI=24,lI=25,cI=26,hI=28,fI=32;class st{static GetDDSInfo(e){const t=new Int32Array(e.buffer,e.byteOffset,ko),i=new Int32Array(e.buffer,e.byteOffset,ko+4);let r=1;t[Cf]&uf&&(r=Math.max(1,t[bf]));const s=t[xf],n=s===Go?i[fI]:0;let o=0;switch(s){case Tf:o=2;break;case Sf:o=1;break;case Go:if(n===Rf){o=2;break}if(n===Af){o=1;break}}return{width:t[Wo],height:t[If],mipmapCount:r,isFourCC:(t[Xo]&_f)===_f,isRGB:(t[Xo]&pf)===pf,isLuminance:(t[Xo]&mf)===mf,isCube:(t[hI]&df)===df,isCompressed:s===gf||s===Ef||s===vf,dxgiFormat:n,textureType:o}}static _GetHalfFloatAsFloatRGBAArrayBuffer(e,t,i,r,s,n){const o=new Float32Array(r),l=new Uint16Array(s,i);let c=0;for(let h=0;h<t;h++)for(let f=0;f<e;f++){const u=(f+h*e)*4;o[c]=Xr(l[u]),o[c+1]=Xr(l[u+1]),o[c+2]=Xr(l[u+2]),st.StoreLODInAlphaChannel?o[c+3]=n:o[c+3]=Xr(l[u+3]),c+=4}return o}static _GetHalfFloatRGBAArrayBuffer(e,t,i,r,s,n){if(st.StoreLODInAlphaChannel){const o=new Uint16Array(r),l=new Uint16Array(s,i);let c=0;for(let h=0;h<t;h++)for(let f=0;f<e;f++){const u=(f+h*e)*4;o[c]=l[u],o[c+1]=l[u+1],o[c+2]=l[u+2],o[c+3]=Ds(n),c+=4}return o}return new Uint16Array(s,i,r)}static _GetFloatRGBAArrayBuffer(e,t,i,r,s,n){if(st.StoreLODInAlphaChannel){const o=new Float32Array(r),l=new Float32Array(s,i);let c=0;for(let h=0;h<t;h++)for(let f=0;f<e;f++){const u=(f+h*e)*4;o[c]=l[u],o[c+1]=l[u+1],o[c+2]=l[u+2],o[c+3]=n,c+=4}return o}return new Float32Array(s,i,r)}static _GetFloatAsHalfFloatRGBAArrayBuffer(e,t,i,r,s,n){const o=new Uint16Array(r),l=new Float32Array(s,i);let c=0;for(let h=0;h<t;h++)for(let f=0;f<e;f++)o[c]=Ds(l[c]),o[c+1]=Ds(l[c+1]),o[c+2]=Ds(l[c+2]),st.StoreLODInAlphaChannel?o[c+3]=Ds(n):o[c+3]=Ds(l[c+3]),c+=4;return o}static _GetFloatAsUIntRGBAArrayBuffer(e,t,i,r,s,n){const o=new Uint8Array(r),l=new Float32Array(s,i);let c=0;for(let h=0;h<t;h++)for(let f=0;f<e;f++){const u=(f+h*e)*4;o[c]=je(l[u])*255,o[c+1]=je(l[u+1])*255,o[c+2]=je(l[u+2])*255,st.StoreLODInAlphaChannel?o[c+3]=n:o[c+3]=je(l[u+3])*255,c+=4}return o}static _GetHalfFloatAsUIntRGBAArrayBuffer(e,t,i,r,s,n){const o=new Uint8Array(r),l=new Uint16Array(s,i);let c=0;for(let h=0;h<t;h++)for(let f=0;f<e;f++){const u=(f+h*e)*4;o[c]=je(Xr(l[u]))*255,o[c+1]=je(Xr(l[u+1]))*255,o[c+2]=je(Xr(l[u+2]))*255,st.StoreLODInAlphaChannel?o[c+3]=n:o[c+3]=je(Xr(l[u+3]))*255,c+=4}return o}static _GetRGBAArrayBuffer(e,t,i,r,s,n,o,l,c){const h=new Uint8Array(r),f=new Uint8Array(s,i);let u=0;for(let d=0;d<t;d++)for(let _=0;_<e;_++){const p=(_+d*e)*4;h[u]=f[p+n],h[u+1]=f[p+o],h[u+2]=f[p+l],h[u+3]=f[p+c],u+=4}return h}static _ExtractLongWordOrder(e){return e===0||e===255||e===-16777216?0:1+st._ExtractLongWordOrder(e>>8)}static _GetRGBArrayBuffer(e,t,i,r,s,n,o,l){const c=new Uint8Array(r),h=new Uint8Array(s,i);let f=0;for(let u=0;u<t;u++)for(let d=0;d<e;d++){const _=(d+u*e)*3;c[f]=h[_+n],c[f+1]=h[_+o],c[f+2]=h[_+l],f+=3}return c}static _GetLuminanceArrayBuffer(e,t,i,r,s){const n=new Uint8Array(r),o=new Uint8Array(s,i);let l=0;for(let c=0;c<t;c++)for(let h=0;h<e;h++){const f=h+c*e;n[l]=o[f],l++}return n}static UploadDDSLevels(e,t,i,r,s,n,o=-1,l,c=!0){let h=null;r.sphericalPolynomial&&(h=[]);const f=!!e.getCaps().s3tc;t.generateMipMaps=s;const u=new Int32Array(i.buffer,i.byteOffset,ko);let d,_,p,g=0,E,v,b,R,S=0,T=1;if(u[rI]!==eI){B.Error("Invalid magic number in DDS header");return}if(!r.isFourCC&&!r.isRGB&&!r.isLuminance){B.Error("Unsupported format, must contain a FourCC, RGB or LUMINANCE code");return}if(r.isCompressed&&!f){B.Error("Compressed textures are not supported on this platform.");return}let I=u[nI];E=u[sI]+4;let O=!1;if(r.isFourCC)switch(d=u[xf],d){case gf:T=8,S=33777;break;case Ef:T=16,S=33778;break;case vf:T=16,S=33779;break;case Tf:O=!0,I=64;break;case Sf:O=!0,I=128;break;case Go:{E+=5*4;let oe=!1;switch(r.dxgiFormat){case Rf:O=!0,I=64,oe=!0;break;case Af:O=!0,I=128,oe=!0;break;case iI:r.isRGB=!0,r.isFourCC=!1,I=32,oe=!0;break}if(oe)break}default:B.Error(["Unsupported FourCC code:",tI(d)]);return}const L=st._ExtractLongWordOrder(u[aI]),w=st._ExtractLongWordOrder(u[oI]),$=st._ExtractLongWordOrder(u[lI]),J=st._ExtractLongWordOrder(u[cI]);O&&(S=e._getRGBABufferInternalSizedFormat(r.textureType)),b=1,u[Cf]&uf&&s!==!1&&(b=Math.max(1,u[bf]));const ce=l||0,le=e.getCaps();for(let oe=ce;oe<n;oe++){for(_=u[Wo],p=u[If],R=0;R<b;++R){if(o===-1||o===R){const ue=o===-1?R:0;if(!r.isCompressed&&r.isFourCC){t.format=5,g=_*p*4;let Pe=null;if(e._badOS||e._badDesktopOS||!le.textureHalfFloat&&!le.textureFloat)I===128?(Pe=st._GetFloatAsUIntRGBAArrayBuffer(_,p,i.byteOffset+E,g,i.buffer,ue),h&&ue==0&&h.push(st._GetFloatRGBAArrayBuffer(_,p,i.byteOffset+E,g,i.buffer,ue))):I===64&&(Pe=st._GetHalfFloatAsUIntRGBAArrayBuffer(_,p,i.byteOffset+E,g,i.buffer,ue),h&&ue==0&&h.push(st._GetHalfFloatAsFloatRGBAArrayBuffer(_,p,i.byteOffset+E,g,i.buffer,ue))),t.type=0;else{const Se=le.textureFloat&&(c&&le.textureFloatLinearFiltering||!c),ie=le.textureHalfFloat&&(c&&le.textureHalfFloatLinearFiltering||!c),K=(I===128||I===64&&!ie)&&Se?1:(I===64||I===128&&!Se)&&ie?2:0;let M,V=null;switch(I){case 128:{switch(K){case 1:M=st._GetFloatRGBAArrayBuffer,V=null;break;case 2:M=st._GetFloatAsHalfFloatRGBAArrayBuffer,V=st._GetFloatRGBAArrayBuffer;break;case 0:M=st._GetFloatAsUIntRGBAArrayBuffer,V=st._GetFloatRGBAArrayBuffer;break}break}default:{switch(K){case 1:M=st._GetHalfFloatAsFloatRGBAArrayBuffer,V=null;break;case 2:M=st._GetHalfFloatRGBAArrayBuffer,V=st._GetHalfFloatAsFloatRGBAArrayBuffer;break;case 0:M=st._GetHalfFloatAsUIntRGBAArrayBuffer,V=st._GetHalfFloatAsFloatRGBAArrayBuffer;break}break}}t.type=K,Pe=M(_,p,i.byteOffset+E,g,i.buffer,ue),h&&ue==0&&h.push(V?V(_,p,i.byteOffset+E,g,i.buffer,ue):Pe)}Pe&&e._uploadDataToTextureDirectly(t,Pe,oe,ue)}else if(r.isRGB)t.type=0,I===24?(t.format=4,g=_*p*3,v=st._GetRGBArrayBuffer(_,p,i.byteOffset+E,g,i.buffer,L,w,$),e._uploadDataToTextureDirectly(t,v,oe,ue)):(t.format=5,g=_*p*4,v=st._GetRGBAArrayBuffer(_,p,i.byteOffset+E,g,i.buffer,L,w,$,J),e._uploadDataToTextureDirectly(t,v,oe,ue));else if(r.isLuminance){const Pe=e._getUnpackAlignement(),Se=_;g=Math.floor((_+Pe-1)/Pe)*Pe*(p-1)+Se,v=st._GetLuminanceArrayBuffer(_,p,i.byteOffset+E,g,i.buffer),t.format=1,t.type=0,e._uploadDataToTextureDirectly(t,v,oe,ue)}else g=Math.max(4,_)/4*Math.max(4,p)/4*T,v=new Uint8Array(i.buffer,i.byteOffset+E,g),t.type=0,e._uploadCompressedDataToTextureDirectly(t,S,_,p,v,oe,ue)}E+=I?_*p*(I/8):g,_*=.5,p*=.5,_=Math.max(1,_),p=Math.max(1,p)}if(l!==void 0)break}h&&h.length>0?r.sphericalPolynomial=Gn.ConvertCubeMapToSphericalPolynomial({size:u[Wo],right:h[0],left:h[1],up:h[2],down:h[3],front:h[4],back:h[5],format:5,type:1,gammaSpace:!1}):r.sphericalPolynomial=void 0}}st.StoreLODInAlphaChannel=!1;const uI=Object.freeze(Object.defineProperty({__proto__:null,DDSTools:st},Symbol.toStringTag,{value:"Module"}));class dI{constructor(){this.supportCascades=!0}loadCubeData(e,t,i,r){const s=t.getEngine();let n,o=!1,l=1e3;if(Array.isArray(e))for(let c=0;c<e.length;c++){const h=e[c];n=st.GetDDSInfo(h),t.width=n.width,t.height=n.height,o=(n.isRGB||n.isLuminance||n.mipmapCount>1)&&t.generateMipMaps,s._unpackFlipY(n.isCompressed),st.UploadDDSLevels(s,t,h,n,o,6,-1,c),!n.isFourCC&&n.mipmapCount===1?s.generateMipMapsForCubemap(t):l=n.mipmapCount-1}else{const c=e;n=st.GetDDSInfo(c),t.width=n.width,t.height=n.height,i&&(n.sphericalPolynomial=new Ss),o=(n.isRGB||n.isLuminance||n.mipmapCount>1)&&t.generateMipMaps,s._unpackFlipY(n.isCompressed),st.UploadDDSLevels(s,t,c,n,o,6),!n.isFourCC&&n.mipmapCount===1?s.generateMipMapsForCubemap(t,!1):l=n.mipmapCount-1}s._setCubeMapTextureParams(t,o,l),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),r&&r({isDDS:!0,width:t.width,info:n,data:e,texture:t})}loadData(e,t,i){const r=st.GetDDSInfo(e),s=(r.isRGB||r.isLuminance||r.mipmapCount>1)&&t.generateMipMaps&&Math.max(r.width,r.height)>>r.mipmapCount-1===1;i(r.width,r.height,s,r.isFourCC,()=>{st.UploadDDSLevels(t.getEngine(),t,e,r,s,1)})}}const _I=Object.freeze(Object.defineProperty({__proto__:null,_DDSTextureLoader:dI},Symbol.toStringTag,{value:"Module"}));let ds,_s=null;async function pI(){return _s||(_s=new Promise((a,e)=>{let t,i=null;const r={preserveDrawingBuffer:!0,depth:!1,stencil:!1,alpha:!0,premultipliedAlpha:!1,antialias:!1,failIfMajorPerformanceCaveat:!1};X(async()=>{const{ThinEngine:s}=await Promise.resolve().then(()=>DR);return{ThinEngine:s}},void 0,import.meta.url).then(({ThinEngine:s})=>{var l;const n=Re.Instances.length;try{t=new OffscreenCanvas(100,100),i=new s(t,!1,r)}catch{n<Re.Instances.length&&((l=Re.Instances.pop())==null||l.dispose()),t=document.createElement("canvas"),i=new s(t,!1,r)}Re.Instances.pop(),Re.OnEnginesDisposedObservable.add(c=>{i&&c!==i&&!i.isDisposed&&Re.Instances.length===0&&zc()}),i.getCaps().parallelShaderCompile=void 0;const o=new bR(i);X(async()=>{const{passPixelShader:c}=await Promise.resolve().then(()=>wE);return{passPixelShader:c}},void 0,import.meta.url).then(({passPixelShader:c})=>{if(!i){e("Engine is not defined");return}const h=new ni({engine:i,name:c.name,fragmentShader:c.shader,samplerNames:["textureSampler"]});ds={canvas:t,engine:i,renderer:o,wrapper:h},a(ds)})}).catch(e)})),await _s}async function Xc(a,e,t,i,r="image/png",s,n){const o=await t.readPixels(0,0,a,e),l=new Uint8Array(o.buffer);Xn(a,e,l,i,r,s,!0,void 0,n)}function Hc(a,e,t,i="image/png",r,s=!1,n=!1,o){return new Promise(l=>{Xn(a,e,t,c=>l(c),i,r,s,n,o)})}function Xn(a,e,t,i,r="image/png",s,n=!1,o=!1,l){pI().then(c=>{if(c.engine.setSize(a,e,!0),t instanceof Float32Array){const f=new Uint8Array(t.length);let u=t.length;for(;u--;){const d=t[u];f[u]=Math.round(je(d)*255)}t=f}const h=c.engine.createRawTexture(t,a,e,5,!1,!n,1);c.renderer.setViewport(),c.renderer.applyEffectWrapper(c.wrapper),c.wrapper.effect._bindTexture("textureSampler",h),c.renderer.draw(),o?k.ToBlob(c.canvas,f=>{const u=new FileReader;u.onload=d=>{const _=d.target.result;i&&i(_)},u.readAsArrayBuffer(f)},r,l):k.EncodeScreenshotCanvasData(c.canvas,i,r,s,l),h.dispose()})}function zc(){ds?(ds.wrapper.dispose(),ds.renderer.dispose(),ds.engine.dispose()):_s==null||_s.then(a=>{a.wrapper.dispose(),a.renderer.dispose(),a.engine.dispose()}),_s=null,ds=null}const mI={DumpData:Xn,DumpDataAsync:Hc,DumpFramebuffer:Xc,Dispose:zc},gI=()=>{k.DumpData=Xn,k.DumpDataAsync=Hc,k.DumpFramebuffer=Xc};gI();const EI=Object.freeze(Object.defineProperty({__proto__:null,Dispose:zc,DumpData:Xn,DumpDataAsync:Hc,DumpFramebuffer:Xc,DumpTools:mI},Symbol.toStringTag,{value:"Module"})),no="image/png",yf=2,Mf=[134,22,135,150,246,214,150,54];function vI(a){const e=new DataView(a.buffer,a.byteOffset,a.byteLength);let t=0;for(let n=0;n<Mf.length;n++)if(e.getUint8(t++)!==Mf[n])return B.Error("Not a babylon environment map"),null;let i="",r=0;for(;r=e.getUint8(t++);)i+=String.fromCharCode(r);let s=JSON.parse(i);return s=Hn(s),s.binaryDataPosition=t,s.specular&&(s.specular.lodGenerationScale=s.specular.lodGenerationScale||.8),s}function Hn(a){if(a.version>yf)throw new Error(`Unsupported babylon environment map version "${a.version}". Latest supported version is "${yf}".`);return a.version===2||(a={...a,version:2,imageType:no}),a}function TI(a,e){e=Hn(e);const t=e.specular;let i=Math.log2(e.width);if(i=Math.round(i)+1,t.mipmaps.length!==6*i)throw new Error(`Unsupported specular mipmaps number "${t.mipmaps.length}"`);const r=new Array(i);for(let s=0;s<i;s++){r[s]=new Array(6);for(let n=0;n<6;n++){const o=t.mipmaps[s*6+n];r[s][n]=new Uint8Array(a.buffer,a.byteOffset+e.binaryDataPosition+o.position,o.length)}}return r}function SI(a,e){var r;e=Hn(e);const t=new Array(6),i=(r=e.irradiance)==null?void 0:r.irradianceTexture;if(i){if(i.faces.length!==6)throw new Error(`Incorrect irradiance texture faces number "${i.faces.length}"`);for(let s=0;s<6;s++){const n=i.faces[s];t[s]=new Uint8Array(a.buffer,a.byteOffset+e.binaryDataPosition+n.position,n.length)}}return t}function AI(a,e,t){var o;t=Hn(t);const i=t.specular;if(!i)return Promise.resolve([]);a._lodGenerationScale=i.lodGenerationScale;const r=[],s=TI(e,t);r.push(ul(a,s,t.imageType));const n=(o=t.irradiance)==null?void 0:o.irradianceTexture;if(n){const l=SI(e,t);r.push(RI(a,l,n.size,t.imageType))}return Promise.all(r)}function Pf(a,e,t,i,r,s,n,o,l,c,h){return new Promise((f,u)=>{if(t){const d=e.createTexture(null,!0,!0,null,1,null,_=>{u(_)},a);i==null||i.onEffectCreatedObservable.addOnce(_=>{_.executeWhenCompiled(()=>{i.externalTextureSamplerBinding=!0,i.onApply=p=>{p._bindTexture("textureSampler",d),p.setFloat2("scale",1,e._features.needsInvertingBitmap&&a instanceof ImageBitmap?-1:1)},e.scenes.length&&(e.scenes[0].postProcessManager.directRender([i],c,!0,s,n),e.restoreDefaultFramebuffer(),d.dispose(),URL.revokeObjectURL(r),f())})})}else{if(e._uploadImageToTexture(h,a,s,n),o){const d=l[n];d&&e._uploadImageToTexture(d._texture,a,s,0)}f()}})}async function ul(a,e,t=no){const i=a.getEngine();a.format=5,a.type=0,a.generateMipMaps=!0,a._cachedAnisotropicFilteringLevel=null,i.updateTextureSamplingMode(3,a),await bg(a,e,!0,t),a.isReady=!0}async function RI(a,e,t,i=no){const r=a.getEngine(),s=new Yt(r,5),n=new rt(r,s);a._irradianceTexture=n,s.isCube=!0,s.format=5,s.type=0,s.generateMipMaps=!0,s._cachedAnisotropicFilteringLevel=null,s.generateMipMaps=!0,s.width=t,s.height=t,r.updateTextureSamplingMode(3,s),await bg(s,[e],!1,i),r.generateMipMapsForCubemap(s),s.isReady=!0}async function bg(a,e,t,i=no){if(!k.IsExponentOfTwo(a.width))throw new Error("Texture size must be a power of two");const r=Im(a.width)+1,s=a.getEngine();let n=!1,o=!1,l=null,c=null,h=null;const f=s.getCaps();f.textureLOD?s._features.supportRenderAndCopyToLodForFloatTextures?f.textureHalfFloatRender&&f.textureHalfFloatLinearFiltering?(n=!0,a.type=2):f.textureFloatRender&&f.textureFloatLinearFiltering&&(n=!0,a.type=1):n=!1:(n=!1,o=t);let u=0;if(n)s.isWebGPU?(u=1,await X(()=>Promise.resolve().then(()=>GE),void 0,import.meta.url)):await X(()=>Promise.resolve().then(()=>WE),void 0,import.meta.url),l=new At("rgbdDecode","rgbdDecode",null,null,1,null,3,s,!1,void 0,a.type,void 0,null,!1,void 0,u),a._isRGBD=!1,a.invertY=!1,c=s.createRenderTargetCubeTexture(a.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:a.type,format:5});else if(a._isRGBD=!0,a.invertY=!0,o){h={};const p=a._lodGenerationScale,g=a._lodGenerationOffset;for(let E=0;E<3;E++){const b=1-E/2,R=g,S=(r-1)*p+g,T=R+(S-R)*b,I=Math.round(Math.min(Math.max(T,0),S)),O=new Yt(s,2);O.isCube=!0,O.invertY=!0,O.generateMipMaps=!1,s.updateTextureSamplingMode(2,O);const L=new rt(null);switch(L._isCube=!0,L._texture=O,h[I]=L,E){case 0:a._lodTextureLow=L;break;case 1:a._lodTextureMid=L;break;case 2:a._lodTextureHigh=L;break}}}const d=[];for(let _=0;_<e.length;_++)for(let p=0;p<6;p++){const g=e[_][p],E=new Blob([g],{type:i}),v=URL.createObjectURL(E);let b;if(s._features.forceBitmapOverHTMLImageElement)b=s.createImageBitmap(E,{premultiplyAlpha:"none"}).then(R=>Pf(R,s,n,l,v,p,_,o,h,c,a));else{const R=new Image;R.src=v,b=new Promise((S,T)=>{R.onload=()=>{Pf(R,s,n,l,v,p,_,o,h,c,a).then(()=>S()).catch(I=>{T(I)})},R.onerror=I=>{T(I)}})}d.push(b)}if(await Promise.all(d),e.length<r){let _;const p=Math.pow(2,r-1-e.length),g=p*p*4;switch(a.type){case 0:{_=new Uint8Array(g);break}case 2:{_=new Uint16Array(g);break}case 1:{_=new Float32Array(g);break}}for(let E=e.length;E<r;E++)for(let v=0;v<6;v++)s._uploadArrayBufferViewToTexture((c==null?void 0:c.texture)||a,_,v,E)}if(c){const _=a._irradianceTexture;a._irradianceTexture=null,s._releaseTexture(a),c._swapAndDie(a),a._irradianceTexture=_}l&&l.dispose(),o&&(a._lodTextureHigh&&a._lodTextureHigh._texture&&(a._lodTextureHigh._texture.isReady=!0),a._lodTextureMid&&a._lodTextureMid._texture&&(a._lodTextureMid._texture.isReady=!0),a._lodTextureLow&&a._lodTextureLow._texture&&(a._lodTextureLow._texture.isReady=!0))}function CI(a,e){e=Hn(e);const t=e.irradiance;if(!t)return;const i=new Ss;m.FromArrayToRef(t.x,0,i.x),m.FromArrayToRef(t.y,0,i.y),m.FromArrayToRef(t.z,0,i.z),m.FromArrayToRef(t.xx,0,i.xx),m.FromArrayToRef(t.yy,0,i.yy),m.FromArrayToRef(t.zz,0,i.zz),m.FromArrayToRef(t.yz,0,i.yz),m.FromArrayToRef(t.zx,0,i.zx),m.FromArrayToRef(t.xy,0,i.xy),a._sphericalPolynomial=i}function II(a,e,t,i,r){const s=a.getEngine().createRawCubeTexture(null,a.width,a.format,a.type,a.generateMipMaps,a.invertY,a.samplingMode,a._compression),n=ul(s,e).then(()=>a);return a.onRebuildCallback=o=>({proxy:n,isReady:!0,isAsync:!0}),a._source=13,a._bufferViewArrayArray=e,a._lodGenerationScale=i,a._lodGenerationOffset=r,a._sphericalPolynomial=t,ul(a,e).then(()=>(a.isReady=!0,a))}class bI{constructor(){this.supportCascades=!1}loadCubeData(e,t,i,r,s){if(Array.isArray(e))return;const n=vI(e);if(n){t.width=n.width,t.height=n.width;try{CI(t,n),AI(t,e,n).then(()=>{t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),r&&r()},o=>{s==null||s("Can not upload environment levels",o)})}catch(o){s==null||s("Can not upload environment file",o)}}else s&&s("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}}const xI=Object.freeze(Object.defineProperty({__proto__:null,_ENVTextureLoader:bI},Symbol.toStringTag,{value:"Module"}));class wi{constructor(e,t){if(this.data=e,this.isInvalid=!1,!wi.IsValid(e)){this.isInvalid=!0,B.Error("texture missing KTX identifier");return}const i=Uint32Array.BYTES_PER_ELEMENT,r=new DataView(this.data.buffer,this.data.byteOffset+12,13*i),n=r.getUint32(0,!0)===67305985;if(this.glType=r.getUint32(1*i,n),this.glTypeSize=r.getUint32(2*i,n),this.glFormat=r.getUint32(3*i,n),this.glInternalFormat=r.getUint32(4*i,n),this.glBaseInternalFormat=r.getUint32(5*i,n),this.pixelWidth=r.getUint32(6*i,n),this.pixelHeight=r.getUint32(7*i,n),this.pixelDepth=r.getUint32(8*i,n),this.numberOfArrayElements=r.getUint32(9*i,n),this.numberOfFaces=r.getUint32(10*i,n),this.numberOfMipmapLevels=r.getUint32(11*i,n),this.bytesOfKeyValueData=r.getUint32(12*i,n),this.glType!==0){B.Error("only compressed formats currently supported"),this.isInvalid=!0;return}else this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels);if(this.pixelHeight===0||this.pixelDepth!==0){B.Error("only 2D textures currently supported"),this.isInvalid=!0;return}if(this.numberOfArrayElements!==0){B.Error("texture arrays not currently supported"),this.isInvalid=!0;return}if(this.numberOfFaces!==t){B.Error("number of faces expected"+t+", but found "+this.numberOfFaces),this.isInvalid=!0;return}this.loadType=wi.COMPRESSED_2D}uploadLevels(e,t){switch(this.loadType){case wi.COMPRESSED_2D:this._upload2DCompressedLevels(e,t);break}}_upload2DCompressedLevels(e,t){let i=wi.HEADER_LEN+this.bytesOfKeyValueData,r=this.pixelWidth,s=this.pixelHeight;const n=t?this.numberOfMipmapLevels:1;for(let o=0;o<n;o++){const l=new Int32Array(this.data.buffer,this.data.byteOffset+i,1)[0];i+=4;for(let c=0;c<this.numberOfFaces;c++){const h=new Uint8Array(this.data.buffer,this.data.byteOffset+i,l);e.getEngine()._uploadCompressedDataToTextureDirectly(e,e.format,r,s,h,c,o),i+=l,i+=3-(l+3)%4}r=Math.max(1,r*.5),s=Math.max(1,s*.5)}}static IsValid(e){if(e.byteLength>=12){const t=new Uint8Array(e.buffer,e.byteOffset,12);if(t[0]===171&&t[1]===75&&t[2]===84&&t[3]===88&&t[4]===32&&t[5]===49&&t[6]===49&&t[7]===187&&t[8]===13&&t[9]===10&&t[10]===26&&t[11]===10)return!0}return!1}}wi.HEADER_LEN=12+13*4;wi.COMPRESSED_2D=0;wi.COMPRESSED_3D=1;wi.TEX_2D=2;wi.TEX_3D=3;class yI{constructor(e){this._pendingActions=new Array,this._workerInfos=e.map(t=>({workerPromise:Promise.resolve(t),idle:!0}))}dispose(){for(const e of this._workerInfos)e.workerPromise.then(t=>{t.terminate()});this._workerInfos.length=0,this._pendingActions.length=0}push(e){this._executeOnIdleWorker(e)||this._pendingActions.push(e)}_executeOnIdleWorker(e){for(const t of this._workerInfos)if(t.idle)return this._execute(t,e),!0;return!1}_execute(e,t){e.idle=!1,e.workerPromise.then(i=>{t(i,()=>{const r=this._pendingActions.shift();r?this._execute(e,r):e.idle=!0})})}}class zn extends yI{constructor(e,t,i=zn.DefaultOptions){super([]),this._maxWorkers=e,this._createWorkerAsync=t,this._options=i}push(e){if(!this._executeOnIdleWorker(e))if(this._workerInfos.length<this._maxWorkers){const t={workerPromise:this._createWorkerAsync(),idle:!1};this._workerInfos.push(t),this._execute(t,e)}else this._pendingActions.push(e)}_execute(e,t){e.timeoutId&&(clearTimeout(e.timeoutId),delete e.timeoutId),super._execute(e,(i,r)=>{t(i,()=>{r(),e.idle&&(e.timeoutId=setTimeout(()=>{e.workerPromise.then(n=>{n.terminate()});const s=this._workerInfos.indexOf(e);s!==-1&&this._workerInfos.splice(s,1)},this._options.idleTimeElapsedBeforeRelease))})})}}zn.DefaultOptions={idleTimeElapsedBeforeRelease:1e3};var Of;(function(a){a[a.ETC1S=0]="ETC1S",a[a.UASTC4x4=1]="UASTC4x4"})(Of||(Of={}));var En;(function(a){a[a.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",a[a.BC7_RGBA=1]="BC7_RGBA",a[a.BC3_RGBA=2]="BC3_RGBA",a[a.BC1_RGB=3]="BC1_RGB",a[a.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",a[a.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",a[a.ETC2_RGBA=6]="ETC2_RGBA",a[a.ETC1_RGB=7]="ETC1_RGB",a[a.RGBA32=8]="RGBA32",a[a.R8=9]="R8",a[a.RG8=10]="RG8"})(En||(En={}));var Df;(function(a){a[a.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",a[a.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",a[a.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",a[a.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",a[a.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",a[a.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",a[a.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",a[a.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",a[a.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",a[a.RGBA8Format=32856]="RGBA8Format",a[a.R8Format=33321]="R8Format",a[a.RG8Format=33323]="RG8Format"})(Df||(Df={}));function ba(a,e){const t=(e==null?void 0:e.jsDecoderModule)||KTX2DECODER;a&&(a.wasmUASTCToASTC&&(t.LiteTranscoder_UASTC_ASTC.WasmModuleURL=a.wasmUASTCToASTC),a.wasmUASTCToBC7&&(t.LiteTranscoder_UASTC_BC7.WasmModuleURL=a.wasmUASTCToBC7),a.wasmUASTCToRGBA_UNORM&&(t.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=a.wasmUASTCToRGBA_UNORM),a.wasmUASTCToRGBA_SRGB&&(t.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=a.wasmUASTCToRGBA_SRGB),a.wasmUASTCToR8_UNORM&&(t.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=a.wasmUASTCToR8_UNORM),a.wasmUASTCToRG8_UNORM&&(t.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=a.wasmUASTCToRG8_UNORM),a.jsMSCTranscoder&&(t.MSCTranscoder.JSModuleURL=a.jsMSCTranscoder),a.wasmMSCTranscoder&&(t.MSCTranscoder.WasmModuleURL=a.wasmMSCTranscoder),a.wasmZSTDDecoder&&(t.ZSTDDecoder.WasmModuleURL=a.wasmZSTDDecoder)),e&&(e.wasmUASTCToASTC&&(t.LiteTranscoder_UASTC_ASTC.WasmBinary=e.wasmUASTCToASTC),e.wasmUASTCToBC7&&(t.LiteTranscoder_UASTC_BC7.WasmBinary=e.wasmUASTCToBC7),e.wasmUASTCToRGBA_UNORM&&(t.LiteTranscoder_UASTC_RGBA_UNORM.WasmBinary=e.wasmUASTCToRGBA_UNORM),e.wasmUASTCToRGBA_SRGB&&(t.LiteTranscoder_UASTC_RGBA_SRGB.WasmBinary=e.wasmUASTCToRGBA_SRGB),e.wasmUASTCToR8_UNORM&&(t.LiteTranscoder_UASTC_R8_UNORM.WasmBinary=e.wasmUASTCToR8_UNORM),e.wasmUASTCToRG8_UNORM&&(t.LiteTranscoder_UASTC_RG8_UNORM.WasmBinary=e.wasmUASTCToRG8_UNORM),e.jsMSCTranscoder&&(t.MSCTranscoder.JSModule=e.jsMSCTranscoder),e.wasmMSCTranscoder&&(t.MSCTranscoder.WasmBinary=e.wasmMSCTranscoder),e.wasmZSTDDecoder&&(t.ZSTDDecoder.WasmBinary=e.wasmZSTDDecoder))}function MI(a){typeof a>"u"&&typeof KTX2DECODER<"u"&&(a=KTX2DECODER);let e;onmessage=t=>{if(t.data)switch(t.data.action){case"init":{const i=t.data.urls;i&&(i.jsDecoderModule&&typeof a>"u"&&(importScripts(i.jsDecoderModule),a=KTX2DECODER),ba(i)),t.data.wasmBinaries&&ba(void 0,{...t.data.wasmBinaries,jsDecoderModule:a}),e=new a.KTX2Decoder,postMessage({action:"init"});break}case"setDefaultDecoderOptions":{a.KTX2Decoder.DefaultDecoderOptions=t.data.options;break}case"decode":e.decode(t.data.data,t.data.caps,t.data.options).then(i=>{const r=[];for(let s=0;s<i.mipmaps.length;++s){const n=i.mipmaps[s];n&&n.data&&r.push(n.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:i},r)}).catch(i=>{postMessage({action:"decoded",success:!1,msg:i})});break}}}function PI(a,e,t){return new Promise((i,r)=>{const s=o=>{a.removeEventListener("error",s),a.removeEventListener("message",n),r(o)},n=o=>{o.data.action==="init"&&(a.removeEventListener("error",s),a.removeEventListener("message",n),i(a))};a.addEventListener("error",s),a.addEventListener("message",n),a.postMessage({action:"init",urls:t,wasmBinaries:e})})}class OI{constructor(){this._isDirty=!0,this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=!0,this._ktx2DecoderOptions={}}get isDirty(){return this._isDirty}get useRGBAIfASTCBC7NotAvailableWhenUASTC(){return this._useRGBAIfASTCBC7NotAvailableWhenUASTC}set useRGBAIfASTCBC7NotAvailableWhenUASTC(e){this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==e&&(this._useRGBAIfASTCBC7NotAvailableWhenUASTC=e,this._isDirty=!0)}get useRGBAIfOnlyBC1BC3AvailableWhenUASTC(){return this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC}set useRGBAIfOnlyBC1BC3AvailableWhenUASTC(e){this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC!==e&&(this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=e,this._isDirty=!0)}get forceRGBA(){return this._forceRGBA}set forceRGBA(e){this._forceRGBA!==e&&(this._forceRGBA=e,this._isDirty=!0)}get forceR8(){return this._forceR8}set forceR8(e){this._forceR8!==e&&(this._forceR8=e,this._isDirty=!0)}get forceRG8(){return this._forceRG8}set forceRG8(e){this._forceRG8!==e&&(this._forceRG8=e,this._isDirty=!0)}get bypassTranscoders(){return this._bypassTranscoders}set bypassTranscoders(e){this._bypassTranscoders!==e&&(this._bypassTranscoders=e,this._isDirty=!0)}_getKTX2DecoderOptions(){if(!this._isDirty)return this._ktx2DecoderOptions;this._isDirty=!1;const e={useRGBAIfASTCBC7NotAvailableWhenUASTC:this._useRGBAIfASTCBC7NotAvailableWhenUASTC,forceRGBA:this._forceRGBA,forceR8:this._forceR8,forceRG8:this._forceRG8,bypassTranscoders:this._bypassTranscoders};return this.useRGBAIfOnlyBC1BC3AvailableWhenUASTC&&(e.transcodeFormatDecisionTree={UASTC:{transcodeFormat:[En.BC1_RGB,En.BC3_RGBA],yes:{transcodeFormat:En.RGBA32,engineFormat:32856,roundToMultiple4:!1}}}),this._ktx2DecoderOptions=e,e}}class at{static GetDefaultNumWorkers(){return typeof navigator!="object"||!navigator.hardwareConcurrency?1:Math.min(Math.floor(navigator.hardwareConcurrency*.5),4)}static _Initialize(e){if(at._WorkerPoolPromise||at._DecoderModulePromise)return;const t={jsDecoderModule:k.GetBabylonScriptURL(this.URLConfig.jsDecoderModule,!0),wasmUASTCToASTC:k.GetBabylonScriptURL(this.URLConfig.wasmUASTCToASTC,!0),wasmUASTCToBC7:k.GetBabylonScriptURL(this.URLConfig.wasmUASTCToBC7,!0),wasmUASTCToRGBA_UNORM:k.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_UNORM,!0),wasmUASTCToRGBA_SRGB:k.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_SRGB,!0),wasmUASTCToR8_UNORM:k.GetBabylonScriptURL(this.URLConfig.wasmUASTCToR8_UNORM,!0),wasmUASTCToRG8_UNORM:k.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRG8_UNORM,!0),jsMSCTranscoder:k.GetBabylonScriptURL(this.URLConfig.jsMSCTranscoder,!0),wasmMSCTranscoder:k.GetBabylonScriptURL(this.URLConfig.wasmMSCTranscoder,!0),wasmZSTDDecoder:k.GetBabylonScriptURL(this.URLConfig.wasmZSTDDecoder,!0)};e&&typeof Worker=="function"&&typeof URL<"u"?at._WorkerPoolPromise=new Promise(i=>{const r=`${ba}(${MI})()`,s=URL.createObjectURL(new Blob([r],{type:"application/javascript"}));i(new zn(e,()=>PI(new Worker(s),void 0,t)))}):typeof at._KTX2DecoderModule>"u"?at._DecoderModulePromise=k.LoadBabylonScriptAsync(t.jsDecoderModule).then(()=>(at._KTX2DecoderModule=KTX2DECODER,at._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,at._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,ba(t,at._KTX2DecoderModule),new at._KTX2DecoderModule.KTX2Decoder)):(at._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,at._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,at._DecoderModulePromise=Promise.resolve(new at._KTX2DecoderModule.KTX2Decoder))}constructor(e,t=at.DefaultNumWorkers){var r;this._engine=e;const i=typeof t=="object"&&t.workerPool||at.WorkerPool;if(i)at._WorkerPoolPromise=Promise.resolve(i);else{typeof t=="object"?at._KTX2DecoderModule=(r=t==null?void 0:t.binariesAndModulesContainer)==null?void 0:r.jsDecoderModule:typeof KTX2DECODER<"u"&&(at._KTX2DecoderModule=KTX2DECODER);const s=typeof t=="number"?t:t.numWorkers??at.DefaultNumWorkers;at._Initialize(s)}}_uploadAsync(e,t,i){const r=this._engine.getCaps(),s={astc:!!r.astc,bptc:!!r.bptc,s3tc:!!r.s3tc,pvrtc:!!r.pvrtc,etc2:!!r.etc2,etc1:!!r.etc1};if(at._WorkerPoolPromise)return at._WorkerPoolPromise.then(n=>new Promise((o,l)=>{n.push((c,h)=>{const f=_=>{c.removeEventListener("error",f),c.removeEventListener("message",u),l(_),h()},u=_=>{if(_.data.action==="decoded"){if(c.removeEventListener("error",f),c.removeEventListener("message",u),!_.data.success)l({message:_.data.msg});else try{this._createTexture(_.data.decodedData,t,i),o()}catch(p){l({message:p})}h()}};c.addEventListener("error",f),c.addEventListener("message",u),c.postMessage({action:"setDefaultDecoderOptions",options:at.DefaultDecoderOptions._getKTX2DecoderOptions()});const d=new Uint8Array(e.byteLength);d.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),c.postMessage({action:"decode",data:d,caps:s,options:i},[d.buffer])})}));if(at._DecoderModulePromise)return at._DecoderModulePromise.then(n=>(at.DefaultDecoderOptions.isDirty&&(at._KTX2DecoderModule.KTX2Decoder.DefaultDecoderOptions=at.DefaultDecoderOptions._getKTX2DecoderOptions()),new Promise((o,l)=>{n.decode(e,r).then(c=>{this._createTexture(c,t),o()}).catch(c=>{l({message:c})})})));throw new Error("KTX2 decoder module is not available")}_createTexture(e,t,i){this._engine._bindTextureDirectly(3553,t),i&&(i.transcodedFormat=e.transcodedFormat,i.isInGammaSpace=e.isInGammaSpace,i.hasAlpha=e.hasAlpha,i.transcoderName=e.transcoderName);let s=!0;switch(e.transcodedFormat){case 32856:t.type=0,t.format=5;break;case 33321:t.type=0,t.format=6;break;case 33323:t.type=0,t.format=7;break;default:t.format=e.transcodedFormat,s=!1;break}if(t._gammaSpace=e.isInGammaSpace,t.generateMipMaps=e.mipmaps.length>1,e.errors)throw new Error("KTX2 container - could not transcode the data. "+e.errors);for(let n=0;n<e.mipmaps.length;++n){const o=e.mipmaps[n];if(!o||!o.data)throw new Error("KTX2 container - could not transcode one of the image");s?(t.width=o.width,t.height=o.height,this._engine._uploadDataToTextureDirectly(t,o.data,0,n,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(t,e.transcodedFormat,o.width,o.height,o.data,0,n)}t._extension=".ktx2",t.width=e.mipmaps[0].width,t.height=e.mipmaps[0].height,t.isReady=!0,this._engine._bindTextureDirectly(3553,null)}static IsValid(e){if(e.byteLength>=12){const t=new Uint8Array(e.buffer,e.byteOffset,12);if(t[0]===171&&t[1]===75&&t[2]===84&&t[3]===88&&t[4]===32&&t[5]===50&&t[6]===48&&t[7]===187&&t[8]===13&&t[9]===10&&t[10]===26&&t[11]===10)return!0}return!1}}at.URLConfig={jsDecoderModule:"https://cdn.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,wasmUASTCToR8_UNORM:null,wasmUASTCToRG8_UNORM:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null};at.DefaultNumWorkers=at.GetDefaultNumWorkers();at.DefaultDecoderOptions=new OI;function DI(a){switch(a){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}class LI{constructor(){this.supportCascades=!1}loadCubeData(e,t,i,r){if(Array.isArray(e))return;t._invertVScale=!t.invertY;const s=t.getEngine(),n=new wi(e,6),o=n.numberOfMipmapLevels>1&&t.generateMipMaps;s._unpackFlipY(!0),n.uploadLevels(t,t.generateMipMaps),t.width=n.pixelWidth,t.height=n.pixelHeight,s._setCubeMapTextureParams(t,o,n.numberOfMipmapLevels-1),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),r&&r()}loadData(e,t,i,r){if(wi.IsValid(e)){t._invertVScale=!t.invertY;const s=new wi(e,1),n=DI(s.glInternalFormat);n?(t.format=n,t._useSRGBBuffer=t.getEngine()._getUseSRGBBuffer(!0,t.generateMipMaps),t._gammaSpace=!0):t.format=s.glInternalFormat,i(s.pixelWidth,s.pixelHeight,t.generateMipMaps,!0,()=>{s.uploadLevels(t,t.generateMipMaps)},s.isInvalid)}else at.IsValid(e)?new at(t.getEngine())._uploadAsync(e,t,r).then(()=>{i(t.width,t.height,t.generateMipMaps,!0,()=>{},!1)},n=>{B.Warn(`Failed to load KTX2 texture data: ${n.message}`),i(0,0,!1,!1,()=>{},!0)}):(B.Error("texture missing KTX identifier"),i(0,0,!1,!1,()=>{},!0))}}const Lf=Object.freeze(Object.defineProperty({__proto__:null,_KTXTextureLoader:LI},Symbol.toStringTag,{value:"Module"}));class Pn extends sr{constructor(e,t,i){super(e,m.Zero(),t),this._xrSessionManager=i,this._firstFrame=!1,this._referenceQuaternion=z.Identity(),this._referencedPosition=new m,this._trackingState=0,this.onXRCameraInitializedObservable=new U,this.onBeforeCameraTeleport=new U,this.onAfterCameraTeleport=new U,this.onTrackingStateChanged=new U,this.compensateOnFirstFrame=!0,this._rotate180=new z(0,1,0,0),this.minZ=.1,this.rotationQuaternion=new z,this.cameraRigMode=Ce.RIG_MODE_CUSTOM,this.updateUpVectorFromRotation=!0,this._updateNumberOfRigCameras(1),this.freezeProjectionMatrix(),this._deferOnly=!0,this._xrSessionManager.onXRSessionInit.add(()=>{this._referencedPosition.copyFromFloats(0,0,0),this._referenceQuaternion.copyFromFloats(0,0,0,1),this._firstFrame=this.compensateOnFirstFrame,this._xrSessionManager.onWorldScaleFactorChangedObservable.add(()=>{this._xrSessionManager.currentFrame&&this._updateDepthNearFar()})}),this._xrSessionManager.onXRFrameObservable.add(()=>{this._firstFrame&&this._updateFromXRSession(),this.onXRCameraInitializedObservable.hasObservers()&&(this.onXRCameraInitializedObservable.notifyObservers(this),this.onXRCameraInitializedObservable.clear()),this._deferredUpdated&&(this.position.copyFrom(this._deferredPositionUpdate),this.rotationQuaternion.copyFrom(this._deferredRotationQuaternionUpdate)),this._updateReferenceSpace(),this._updateFromXRSession()},void 0,!0)}get trackingState(){return this._trackingState}_setTrackingState(e){this._trackingState!==e&&(this._trackingState=e,this.onTrackingStateChanged.notifyObservers(e))}get realWorldHeight(){const e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.baseReferenceSpace);return e&&e.transform?e.transform.position.y*this._xrSessionManager.worldScalingFactor:0}_updateForDualEyeDebugging(){this._updateNumberOfRigCameras(2),this.rigCameras[0].viewport=new Er(0,0,.5,1),this.rigCameras[0].outputRenderTarget=null,this.rigCameras[1].viewport=new Er(.5,0,.5,1),this.rigCameras[1].outputRenderTarget=null}setTransformationFromNonVRCamera(e=this.getScene().activeCamera,t=!0){if(!e||e===this)return;e.computeWorldMatrix().decompose(void 0,this.rotationQuaternion,this.position),this.position.y=0,z.FromEulerAnglesToRef(0,this.rotationQuaternion.toEulerAngles().y,0,this.rotationQuaternion),this._firstFrame=!0,t&&this._xrSessionManager.resetReferenceSpace()}getClassName(){return"WebXRCamera"}setTarget(e){const t=F.Vector3[1];e.subtractToRef(this.position,t),t.y=0,t.normalize();const i=Math.atan2(t.x,t.z);this.rotationQuaternion.toEulerAnglesToRef(t),z.FromEulerAnglesToRef(t.x,i,t.z,this.rotationQuaternion)}dispose(){super.dispose(),this._lastXRViewerPose=void 0,this.onTrackingStateChanged.clear()}_updateDepthNearFar(){const e=(this.maxZ||1e4)*this._xrSessionManager.worldScalingFactor,t={depthFar:e,depthNear:this.minZ};this._xrSessionManager.updateRenderState(t),this._cache.minZ=this.minZ,this._cache.maxZ=e}_updateFromXRSession(){const e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.referenceSpace);if(this._lastXRViewerPose=e||void 0,!e){this._setTrackingState(0);return}const t=e.emulatedPosition?1:2;if(this._setTrackingState(t),(this.minZ!==this._cache.minZ||this.maxZ!==this._cache.maxZ)&&this._updateDepthNearFar(),e.transform){const i=e.transform.orientation;if(e.transform.orientation.x===void 0)return;const r=e.transform.position;this._referencedPosition.set(r.x,r.y,r.z).scaleInPlace(this._xrSessionManager.worldScalingFactor),this._referenceQuaternion.set(i.x,i.y,i.z,i.w),this._scene.useRightHandedSystem?this._referenceQuaternion.multiplyInPlace(this._rotate180):(this._referencedPosition.z*=-1,this._referenceQuaternion.z*=-1,this._referenceQuaternion.w*=-1),this._firstFrame?(this._firstFrame=!1,this.position.y+=this._referencedPosition.y,this._referenceQuaternion.copyFromFloats(0,0,0,1)):(this.rotationQuaternion.copyFrom(this._referenceQuaternion),this.position.copyFrom(this._referencedPosition))}this.rigCameras.length!==e.views.length&&this._updateNumberOfRigCameras(e.views.length),e.views.forEach((i,r)=>{var f;const s=this.rigCameras[r];!s.isLeftCamera&&!s.isRightCamera&&(i.eye==="right"?s._isRightCamera=!0:i.eye==="left"&&(s._isLeftCamera=!0));const n=this.getScene().customRenderTargets;for(let u=0;u<n.length;u++){const d=n[u];s.customRenderTargets.indexOf(d)===-1&&s.customRenderTargets.push(d)}const o=i.transform.position,l=i.transform.orientation;s.parent=this.parent,s.position.set(o.x,o.y,o.z).scaleInPlace(this._xrSessionManager.worldScalingFactor),s.rotationQuaternion.set(l.x,l.y,l.z,l.w),this._scene.useRightHandedSystem?s.rotationQuaternion.multiplyInPlace(this._rotate180):(s.position.z*=-1,s.rotationQuaternion.z*=-1,s.rotationQuaternion.w*=-1),P.FromFloat32ArrayToRefScaled(i.projectionMatrix,0,1,s._projectionMatrix),this._scene.useRightHandedSystem||s._projectionMatrix.toggleProjectionMatrixHandInPlace();const c=Math.atan2(1,i.projectionMatrix[5])*2;s.fov=c,r===0&&(this.fov=c,this._projectionMatrix.copyFrom(s._projectionMatrix));const h=this._xrSessionManager.getRenderTargetTextureForView(i);this._renderingMultiview=((f=h==null?void 0:h._texture)==null?void 0:f.isMultiview)||!1,this._renderingMultiview?r==0&&(this._xrSessionManager.trySetViewportForView(this.viewport,i),this.outputRenderTarget=h):(this._xrSessionManager.trySetViewportForView(s.viewport,i),s.outputRenderTarget=h||this._xrSessionManager.getRenderTargetTextureForView(i)),s.layerMask=this.layerMask})}_updateNumberOfRigCameras(e=1){for(;this.rigCameras.length<e;){const t=new Dt("XR-RigCamera: "+this.rigCameras.length,m.Zero(),this.getScene());t.minZ=.1,t.rotationQuaternion=new z,t.updateUpVectorFromRotation=!0,t.isRigCamera=!0,t.rigParent=this,t.freezeProjectionMatrix(),this.rigCameras.push(t)}for(;this.rigCameras.length>e;){const t=this.rigCameras.pop();t&&t.dispose()}}_updateReferenceSpace(){if(!this.position.equals(this._referencedPosition)||!this.rotationQuaternion.equals(this._referenceQuaternion)){const e=F.Matrix[0],t=F.Matrix[1],i=F.Matrix[2];P.ComposeToRef(Pn._ScaleReadOnly,this._referenceQuaternion,this._referencedPosition,e),P.ComposeToRef(Pn._ScaleReadOnly,this.rotationQuaternion,this.position,t),e.invert().multiplyToRef(t,i),i.invert(),this._scene.useRightHandedSystem||i.toggleModelMatrixHandInPlace(),i.decompose(void 0,this._referenceQuaternion,this._referencedPosition);const r=new XRRigidTransform({x:this._referencedPosition.x/this._xrSessionManager.worldScalingFactor,y:this._referencedPosition.y/this._xrSessionManager.worldScalingFactor,z:this._referencedPosition.z/this._xrSessionManager.worldScalingFactor},{x:this._referenceQuaternion.x,y:this._referenceQuaternion.y,z:this._referenceQuaternion.z,w:this._referenceQuaternion.w});this._xrSessionManager.referenceSpace=this._xrSessionManager.referenceSpace.getOffsetReferenceSpace(r)}}}Pn._ScaleReadOnly=m.One();class St{}St.ANCHOR_SYSTEM="xr-anchor-system";St.BACKGROUND_REMOVER="xr-background-remover";St.HIT_TEST="xr-hit-test";St.MESH_DETECTION="xr-mesh-detection";St.PHYSICS_CONTROLLERS="xr-physics-controller";St.PLANE_DETECTION="xr-plane-detection";St.POINTER_SELECTION="xr-controller-pointer-selection";St.TELEPORTATION="xr-controller-teleportation";St.FEATURE_POINTS="xr-feature-points";St.HAND_TRACKING="xr-hand-tracking";St.IMAGE_TRACKING="xr-image-tracking";St.NEAR_INTERACTION="xr-near-interaction";St.DOM_OVERLAY="xr-dom-overlay";St.MOVEMENT="xr-controller-movement";St.LIGHT_ESTIMATION="xr-light-estimation";St.EYE_TRACKING="xr-eye-tracking";St.WALKING_LOCOMOTION="xr-walking-locomotion";St.LAYERS="xr-layers";St.DEPTH_SENSING="xr-depth-sensing";St.SPACE_WARP="xr-space-warp";St.RAW_CAMERA_ACCESS="xr-raw-camera-access";class Yi{constructor(e){this._xrSessionManager=e,this._features={},this._xrSessionManager.onXRSessionInit.add(()=>{this.getEnabledFeatures().forEach(t=>{const i=this._features[t];i.enabled&&!i.featureImplementation.attached&&!i.featureImplementation.disableAutoAttach&&this.attachFeature(t)})}),this._xrSessionManager.onXRSessionEnded.add(()=>{this.getEnabledFeatures().forEach(t=>{const i=this._features[t];i.enabled&&i.featureImplementation.attached&&this.detachFeature(t)})})}static AddWebXRFeature(e,t,i=1,r=!1){this._AvailableFeatures[e]=this._AvailableFeatures[e]||{latest:i},i>this._AvailableFeatures[e].latest&&(this._AvailableFeatures[e].latest=i),r&&(this._AvailableFeatures[e].stable=i),this._AvailableFeatures[e][i]=t}static ConstructFeature(e,t=1,i,r){const s=this._AvailableFeatures[e][t];if(!s)throw new Error("feature not found");return s(i,r)}static GetAvailableFeatures(){return Object.keys(this._AvailableFeatures)}static GetAvailableVersions(e){return Object.keys(this._AvailableFeatures[e])}static GetLatestVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].latest||-1}static GetStableVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].stable||-1}attachFeature(e){const t=this._features[e];t&&t.enabled&&!t.featureImplementation.attached&&(t.featureImplementation.attach()||k.Warn(`Feature ${e} failed to attach`))}detachFeature(e){const t=this._features[e];t&&t.featureImplementation.attached&&(t.featureImplementation.detach()||k.Warn(`Feature ${e} failed to detach`))}disableFeature(e){const t=typeof e=="string"?e:e.Name,i=this._features[t];return i&&i.enabled?(i.enabled=!1,this.detachFeature(t),i.featureImplementation.dispose(),delete this._features[t],!0):!1}dispose(){this.getEnabledFeatures().forEach(e=>{this.disableFeature(e)})}enableFeature(e,t="latest",i={},r=!0,s=!0){const n=typeof e=="string"?e:e.Name;let o=0;if(typeof t=="string"){if(!t)throw new Error(`Error in provided version - ${n} (${t})`);if(t==="stable"?o=Yi.GetStableVersionOfFeature(n):t==="latest"?o=Yi.GetLatestVersionOfFeature(n):o=+t,o===-1||isNaN(o))throw new Error(`feature not found - ${n} (${t})`)}else o=t;const l=Yi._ConflictingFeatures[n];if(l!==void 0&&this.getEnabledFeatures().indexOf(l)!==-1)throw new Error(`Feature ${n} cannot be enabled while ${l} is enabled.`);const c=this._features[n],h=Yi.ConstructFeature(n,o,this._xrSessionManager,i);if(!h)throw new Error(`feature not found - ${n}`);c&&this.disableFeature(n);const f=h();if(f.dependsOn&&!f.dependsOn.every(d=>!!this._features[d]))throw new Error(`Dependant features missing. Make sure the following features are enabled - ${f.dependsOn.join(", ")}`);if(f.isCompatible())return this._features[n]={featureImplementation:f,enabled:!0,version:o,required:s},r?this._xrSessionManager.session&&!this._features[n].featureImplementation.attached&&this.attachFeature(n):this._features[n].featureImplementation.disableAutoAttach=!0,this._features[n].featureImplementation;if(s)throw new Error("required feature not compatible");return k.Warn(`Feature ${n} not compatible with the current environment/browser and was not enabled.`),f}getEnabledFeature(e){return this._features[e]&&this._features[e].featureImplementation}getEnabledFeatures(){return Object.keys(this._features)}async _extendXRSessionInitObject(e){const t=this.getEnabledFeatures();for(const i of t){const r=this._features[i],s=r.featureImplementation.xrNativeFeatureName;if(s&&(r.required?(e.requiredFeatures=e.requiredFeatures||[],e.requiredFeatures.indexOf(s)===-1&&e.requiredFeatures.push(s)):(e.optionalFeatures=e.optionalFeatures||[],e.optionalFeatures.indexOf(s)===-1&&e.optionalFeatures.push(s))),r.featureImplementation.getXRSessionInitExtension){const n=await r.featureImplementation.getXRSessionInitExtension();e={...e,...n}}}return e}}Yi._AvailableFeatures={};Yi._ConflictingFeatures={[St.TELEPORTATION]:St.MOVEMENT,[St.MOVEMENT]:St.TELEPORTATION};gt.AddNodeConstructor("TouchCamera",(a,e)=>()=>new xg(a,m.Zero(),e));class xg extends sr{get touchAngularSensibility(){const e=this.inputs.attached.touch;return e?e.touchAngularSensibility:0}set touchAngularSensibility(e){const t=this.inputs.attached.touch;t&&(t.touchAngularSensibility=e)}get touchMoveSensibility(){const e=this.inputs.attached.touch;return e?e.touchMoveSensibility:0}set touchMoveSensibility(e){const t=this.inputs.attached.touch;t&&(t.touchMoveSensibility=e)}constructor(e,t,i){super(e,t,i),this.inputs.addTouch(),this._setupInputs()}getClassName(){return"TouchCamera"}_setupInputs(){const e=this.inputs.attached.touch,t=this.inputs.attached.mouse;t?t.touchEnabled=!e:e.allowMouse=!t}}gt.AddNodeConstructor("FreeCamera",(a,e)=>()=>new Yc(a,m.Zero(),e));class Yc extends xg{get gamepadAngularSensibility(){const e=this.inputs.attached.gamepad;return e?e.gamepadAngularSensibility:0}set gamepadAngularSensibility(e){const t=this.inputs.attached.gamepad;t&&(t.gamepadAngularSensibility=e)}get gamepadMoveSensibility(){const e=this.inputs.attached.gamepad;return e?e.gamepadMoveSensibility:0}set gamepadMoveSensibility(e){const t=this.inputs.attached.gamepad;t&&(t.gamepadMoveSensibility=e)}constructor(e,t,i){super(e,t,i),this.inputs.addGamepad()}getClassName(){return"UniversalCamera"}}Ce._CreateDefaultParsedCamera=(a,e)=>new Yc(a,m.Zero(),e);class Kc{constructor(e){this._scene=e,this._nonVRCamera=null,this._attachedToElement=!1,this._spectatorCamera=null,this._originalSceneAutoClear=!0,this._supported=!1,this._spectatorMode=!1,this._lastTimestamp=0,this.onInitialXRPoseSetObservable=new U,this.onStateChangedObservable=new U,this.state=3,this.sessionManager=new io(e),this.camera=new Pn("webxr",e,this.sessionManager),this.featuresManager=new Yi(this.sessionManager),e.onDisposeObservable.addOnce(()=>{this.dispose()})}static CreateAsync(e){const t=new Kc(e);return t.sessionManager.initializeAsync().then(()=>(t._supported=!0,t)).catch(i=>{throw t._setState(3),t.dispose(),i})}dispose(){var e;this.exitXRAsync(),this.camera.dispose(),this.onStateChangedObservable.clear(),this.onInitialXRPoseSetObservable.clear(),this.sessionManager.dispose(),(e=this._spectatorCamera)==null||e.dispose(),this._nonVRCamera&&(this._scene.activeCamera=this._nonVRCamera)}async enterXRAsync(e,t,i=this.sessionManager.getWebXRRenderTarget(),r={}){var s,n,o,l;if(!this._supported)throw"WebXR not supported in this browser or environment";this._setState(0),t!=="viewer"&&t!=="local"&&(r.optionalFeatures=r.optionalFeatures||[],r.optionalFeatures.push(t)),r=await this.featuresManager._extendXRSessionInitObject(r),e==="immersive-ar"&&t!=="unbounded"&&B.Warn("We recommend using 'unbounded' reference space type when using 'immersive-ar' session mode");try{await this.sessionManager.initializeSessionAsync(e,r),await this.sessionManager.setReferenceSpaceTypeAsync(t);const c={depthFar:this.camera.maxZ||1e4,depthNear:this.camera.minZ};if(!this.featuresManager.getEnabledFeature(St.LAYERS)){const h=await i.initializeXRLayerAsync(this.sessionManager.session);c.baseLayer=h}return this.sessionManager.updateRenderState(c),this.sessionManager.runXRRenderLoop(),this._originalSceneAutoClear=this._scene.autoClear,this._nonVRCamera=this._scene.activeCamera,this._attachedToElement=!!((n=(s=this._nonVRCamera)==null?void 0:s.inputs)!=null&&n.attachedToElement),(o=this._nonVRCamera)==null||o.detachControl(),this._scene.activeCamera=this.camera,e!=="immersive-ar"?this._nonXRToXRCamera():(this._scene.autoClear=!1,this.camera.compensateOnFirstFrame=!1,this.camera.position.set(0,0,0),this.camera.rotationQuaternion.set(0,0,0,1),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)),(l=H.audioEngine)==null||l._resumeAudioContextOnStateChange(),this.sessionManager.onXRSessionEnded.addOnce(()=>{this.state!==1&&this._setState(1),this.camera.rigCameras.forEach(h=>{h.outputRenderTarget=null}),this._scene.autoClear=this._originalSceneAutoClear,this._scene.activeCamera=this._nonVRCamera,this._attachedToElement&&this._nonVRCamera&&this._nonVRCamera.attachControl(!!this._nonVRCamera.inputs.noPreventDefault),e!=="immersive-ar"&&this.camera.compensateOnFirstFrame&&(this._nonVRCamera.setPosition?this._nonVRCamera.setPosition(this.camera.position):this._nonVRCamera.position.copyFrom(this.camera.position)),this._setState(3)}),this.sessionManager.onXRFrameObservable.addOnce(()=>{this._setState(2)}),this.sessionManager}catch(c){throw B.Log(c),B.Log(c.message),this._setState(3),c}}exitXRAsync(){return this.state!==2?Promise.resolve():(this._setState(1),this.sessionManager.exitXRAsync())}enableSpectatorMode(e){this._spectatorMode||(this._spectatorMode=!0,this._switchSpectatorMode(e))}disableSpecatatorMode(){this._spectatorMode&&(this._spectatorMode=!1,this._switchSpectatorMode())}_switchSpectatorMode(e){const i=1/(e!=null&&e.fps?e.fps:1e3)*1e3,r=e!=null&&e.preferredCameraIndex?e==null?void 0:e.preferredCameraIndex:0,s=()=>{this._spectatorCamera&&this.sessionManager.currentTimestamp-this._lastTimestamp>=i&&(this._lastTimestamp=this.sessionManager.currentTimestamp,this._spectatorCamera.position.copyFrom(this.camera.rigCameras[r].globalPosition),this._spectatorCamera.rotationQuaternion.copyFrom(this.camera.rigCameras[r].absoluteRotation))};if(this._spectatorMode){if(r>=this.camera.rigCameras.length)throw new Error("the preferred camera index is beyond the length of rig camera array.");const n=()=>{this.state===2?(this._spectatorCamera=new Yc("webxr-spectator",m.Zero(),this._scene),this._spectatorCamera.rotationQuaternion=new z,this._scene.activeCameras=[this.camera,this._spectatorCamera],this.sessionManager.onXRFrameObservable.add(s),this._scene.onAfterRenderCameraObservable.add(o=>{o===this.camera&&(this._scene.getEngine().framebufferDimensionsObject=null)})):this.state===1&&(this.sessionManager.onXRFrameObservable.removeCallback(s),this._scene.activeCameras=null)};this.onStateChangedObservable.add(n),n()}else this.sessionManager.onXRFrameObservable.removeCallback(s),this._scene.activeCameras=[this.camera]}_nonXRToXRCamera(){this.camera.setTransformationFromNonVRCamera(this._nonVRCamera),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)}_setState(e){this.state!==e&&(this.state=e,this.onStateChangedObservable.notifyObservers(this.state))}}class vr{constructor(e,t,i=-1,r=[]){this.id=e,this.type=t,this._buttonIndex=i,this._axesIndices=r,this._axes={x:0,y:0},this._changes={},this._currentValue=0,this._hasChanges=!1,this._pressed=!1,this._touched=!1,this.onAxisValueChangedObservable=new U,this.onButtonStateChangedObservable=new U}get axes(){return this._axes}get changes(){return this._changes}get hasChanges(){return this._hasChanges}get pressed(){return this._pressed}get touched(){return this._touched}get value(){return this._currentValue}dispose(){this.onAxisValueChangedObservable.clear(),this.onButtonStateChangedObservable.clear()}isAxes(){return this._axesIndices.length!==0}isButton(){return this._buttonIndex!==-1}update(e){let t=!1,i=!1;if(this._hasChanges=!1,this._changes={},this.isButton()){const r=e.buttons[this._buttonIndex];if(!r)return;this._currentValue!==r.value&&(this.changes.value={current:r.value,previous:this._currentValue},t=!0,this._currentValue=r.value),this._touched!==r.touched&&(this.changes.touched={current:r.touched,previous:this._touched},t=!0,this._touched=r.touched),this._pressed!==r.pressed&&(this.changes.pressed={current:r.pressed,previous:this._pressed},t=!0,this._pressed=r.pressed)}this.isAxes()&&(this._axes.x!==e.axes[this._axesIndices[0]]&&(this.changes.axes={current:{x:e.axes[this._axesIndices[0]],y:this._axes.y},previous:{x:this._axes.x,y:this._axes.y}},this._axes.x=e.axes[this._axesIndices[0]],i=!0),this._axes.y!==e.axes[this._axesIndices[1]]&&(this.changes.axes?this.changes.axes.current.y=e.axes[this._axesIndices[1]]:this.changes.axes={current:{x:this._axes.x,y:e.axes[this._axesIndices[1]]},previous:{x:this._axes.x,y:this._axes.y}},this._axes.y=e.axes[this._axesIndices[1]],i=!0)),t&&(this._hasChanges=!0,this.onButtonStateChangedObservable.notifyObservers(this)),i&&(this._hasChanges=!0,this.onAxisValueChangedObservable.notifyObservers(this._axes))}}vr.BUTTON_TYPE="button";vr.SQUEEZE_TYPE="squeeze";vr.THUMBSTICK_TYPE="thumbstick";vr.TOUCHPAD_TYPE="touchpad";vr.TRIGGER_TYPE="trigger";function NI(a,e){const t=e.method||"GET";return new Promise((i,r)=>{const s=new Gt;s.addEventListener("readystatechange",()=>{if(s.readyState==4)if(s.status==200){const n={};if(e.responseHeaders)for(const o of e.responseHeaders)n[o]=s.getResponseHeader(o)||"";i({response:s.response,headerValues:n})}else r(`Unable to fetch data from ${a}. Error code: ${s.status}`)}),s.open(t,a),s.send()})}var Nf;(function(a){a[a.Clean=0]="Clean",a[a.Stop=1]="Stop",a[a.Sync=2]="Sync",a[a.NoSync=3]="NoSync"})(Nf||(Nf={}));function FI(a){return!!a.createPlugin}function wI(a){return!!a.name}const yg=new U,pr={};let Ho=!1;function ao(){return pr[".babylon"]}function BI(a){for(const e in pr){const t=pr[e];if(t.mimeType===a)return t}}function dl(a,e){const t=pr[a];return t||(B.Warn("Unable to find a plugin to load "+a+" files. Trying to use .babylon default plugin. To load from a specific filetype (eg. gltf) see: https://doc.babylonjs.com/features/featuresDeepDive/importers/loadingFileTypes"),e?ao():void 0)}function UI(a){return!!pr[a]}function VI(a){for(const e in pr){const t=pr[e].plugin;if(t.canDirectLoad&&t.canDirectLoad(a))return pr[e]}return ao()}function GI(a){const e=a.indexOf("?");e!==-1&&(a=a.substring(0,e));const t=a.lastIndexOf(".");return a.substring(t,a.length).toLowerCase()}function kI(a){return a.substring(0,5)==="data:"?a.substring(5):null}function qc(a,e,t){let r="Unable to load from "+(a.rawData?"binary data":a.url);return e?r+=`: ${e}`:t&&(r+=`: ${t}`),r}async function jc(a,e,t,i,r,s,n,o,l){var d;const c=kI(a.url);if(a.rawData&&!n)throw"When using ArrayBufferView to load data the file extension must be provided.";const h=!c&&!n?GI(a.url):"";let f=n?dl(n,!0):c?VI(a.url):dl(h,!1);if(!f&&h){if(a.url&&!a.url.startsWith("blob:")){const _=await NI(a.url,{method:"HEAD",responseHeaders:["Content-Type"]}),p=_.headerValues?_.headerValues["Content-Type"]:"";p&&(f=BI(p))}f||(f=ao())}if(!f)throw new Error(`No plugin or fallback for ${n??a.url}`);if(((d=l==null?void 0:l[f.plugin.name])==null?void 0:d.enabled)===!1)throw new Error(`The '${f.plugin.name}' plugin is disabled via the loader options passed to the loading operation.`);if(a.rawData&&!f.isBinary)throw"Loading from ArrayBufferView can not be used with plugins that don't support binary loading.";return(_=>{if(FI(f.plugin)){const g=f.plugin.createPlugin(l??{});return g instanceof Promise?(g.then(_).catch(E=>{r("Error instantiating plugin.",E)}),null):(_(g),g)}else return _(f.plugin),f.plugin})(_=>{var T;if(!_)throw`The loader plugin corresponding to the '${n}' file type has not been found. If using es6, please import the plugin you wish to use before.`;if(yg.notifyObservers(_),c&&(_.canDirectLoad&&_.canDirectLoad(a.url)||!pc(a.url))){if(_.directLoad){const I=_.directLoad(e,c);I instanceof Promise?I.then(O=>{t(_,O)}).catch(O=>{r("Error in directLoad of _loadData: "+O,O)}):t(_,I)}else t(_,c);return}const p=f.isBinary,g=(I,O)=>{if(e.isDisposed){r("Scene has been disposed");return}t(_,I,O)};let E=null,v=!1;(T=_.onDisposeObservable)==null||T.add(()=>{v=!0,E&&(E.abort(),E=null),s()});const b=()=>{if(v)return;const I=(O,L)=>{r(O==null?void 0:O.statusText,L)};if(!_.loadFile&&a.rawData)throw"Plugin does not support loading ArrayBufferView.";E=_.loadFile?_.loadFile(e,a.rawData||a.file||a.url,a.rootUrl,g,i,p,I,o):e._loadFile(a.file||a.url,g,i,!0,p,I)},R=e.getEngine();let S=R.enableOfflineSupport;if(S){let I=!1;for(const O of e.disableOfflineSupportExceptionRules)if(O.test(a.url)){I=!0;break}S=!I}S&&H.OfflineProviderFactory?e.offlineProvider=H.OfflineProviderFactory(a.url,b,R.disableManifestCheck):b()})}function Zc(a,e){let t,i,r=null,s=null;if(!e)t=a,i=k.GetFilename(a),a=k.GetFolderPath(a);else if(wI(e))t=`file:${e.name}`,i=e.name,r=e;else if(ArrayBuffer.isView(e))t="",i=xs(),s=e;else if(e.startsWith("data:"))t=e,i="";else if(a){const n=e;if(n.substring(0,1)==="/")return k.Error("Wrong sceneFilename parameter"),null;t=a+n,i=n}else t=e,i=k.GetFilename(e),a=k.GetFolderPath(e);return{url:t,rootUrl:a,name:i,file:r,rawData:s}}function WI(a){if(typeof a.extensions=="string"){const e=a.extensions;pr[e.toLowerCase()]={plugin:a,isBinary:!1}}else{const e=a.extensions;Object.keys(e).forEach(t=>{pr[t.toLowerCase()]={plugin:a,isBinary:e[t].isBinary,mimeType:e[t].mimeType}})}}async function Mg(a,e,t="",i=Re.LastCreatedScene,r=null,s=null,n=null,o=null,l="",c={}){if(!i)return B.Error("No scene available to import mesh to"),null;const h=Zc(e,t);if(!h)return null;const f={};i.addPendingData(f);const u=()=>{i.removePendingData(f)},d=(g,E)=>{const v=qc(h,g,E);n?n(i,v,new Ur(v,bs.SceneLoaderError,E)):B.Error(v),u()},_=s?g=>{try{s(g)}catch(E){d("Error in onProgress callback: "+E,E)}}:void 0,p=(g,E,v,b,R,S,T,I)=>{if(i.importedMeshesFiles.push(h.url),r)try{r(g,E,v,b,R,S,T,I)}catch(O){d("Error in onSuccess callback: "+O,O)}i.removePendingData(f)};return await jc(h,i,(g,E,v)=>{if(g.rewriteRootURL&&(h.rootUrl=g.rewriteRootURL(h.rootUrl,v)),g.importMesh){const b=g,R=[],S=[],T=[];if(!b.importMesh(a,i,E,h.rootUrl,R,S,T,d))return;i.loadingPluginName=g.name,p(R,S,T,[],[],[],[],[])}else g.importMeshAsync(a,i,E,h.rootUrl,_,h.name).then(R=>{i.loadingPluginName=g.name,p(R.meshes,R.particleSystems,R.skeletons,R.animationGroups,R.transformNodes,R.geometries,R.lights,R.spriteManagers)}).catch(R=>{d(R.message,R)})},_,d,u,o,l,c)}function XI(a,e,t,i,r,s,n,o){return new Promise((l,c)=>{try{Mg(a,e,t,i,(h,f,u,d,_,p,g,E)=>{l({meshes:h,particleSystems:f,skeletons:u,animationGroups:d,transformNodes:_,geometries:p,lights:g,spriteManagers:E})},r,(h,f,u)=>{c(u||new Error(f))},s,n,o).catch(c)}catch(h){c(h)}})}async function Pg(a,e="",t=Re.LastCreatedEngine,i=null,r=null,s=null,n=null,o="",l={}){if(!t){k.Error("No engine available");return}await Qc(a,e,new Ge(t),i,r,s,n,o,l)}function HI(a,e,t,i,r,s,n){return new Promise((o,l)=>{Pg(a,e,t,c=>{o(c)},i,(c,h,f)=>{l(f||new Error(h))},r,s,n)})}async function Qc(a,e="",t=Re.LastCreatedScene,i=null,r=null,s=null,n=null,o="",l={}){if(!t)return B.Error("No scene available to append to"),null;const c=Zc(a,e);if(!c)return null;const h={};t.addPendingData(h);const f=()=>{t.removePendingData(h)};Bt.ShowLoadingScreen&&!Ho&&(Ho=!0,t.getEngine().displayLoadingUI(),t.executeWhenReady(()=>{t.getEngine().hideLoadingUI(),Ho=!1}));const u=(p,g)=>{const E=qc(c,p,g);s?s(t,E,new Ur(E,bs.SceneLoaderError,g)):B.Error(E),f()},d=r?p=>{try{r(p)}catch(g){u("Error in onProgress callback",g)}}:void 0,_=()=>{if(i)try{i(t)}catch(p){u("Error in onSuccess callback",p)}t.removePendingData(h)};return await jc(c,t,(p,g)=>{if(p.load){if(!p.load(t,g,c.rootUrl,u))return;t.loadingPluginName=p.name,_()}else p.loadAsync(t,g,c.rootUrl,d,c.name).then(()=>{t.loadingPluginName=p.name,_()}).catch(v=>{u(v.message,v)})},d,u,f,n,o,l)}function zI(a,e,t,i,r,s,n){return new Promise((o,l)=>{try{Qc(a,e,t,c=>{o(c)},i,(c,h,f)=>{l(f||new Error(h))},r,s,n).catch(l)}catch(c){l(c)}})}async function $c(a,e="",t=Re.LastCreatedScene,i=null,r=null,s=null,n=null,o="",l={}){if(!t)return B.Error("No scene available to load asset container to"),null;const c=Zc(a,e);if(!c)return null;const h={};t.addPendingData(h);const f=()=>{t.removePendingData(h)},u=(p,g)=>{const E=qc(c,p,g);s?s(t,E,new Ur(E,bs.SceneLoaderError,g)):B.Error(E),f()},d=r?p=>{try{r(p)}catch(g){u("Error in onProgress callback",g)}}:void 0,_=p=>{if(i)try{i(p)}catch(g){u("Error in onSuccess callback",g)}t.removePendingData(h)};return await jc(c,t,(p,g)=>{if(p.loadAssetContainer){const v=p.loadAssetContainer(t,g,c.rootUrl,u);if(!v)return;v.populateRootNodes(),t.loadingPluginName=p.name,_(v)}else p.loadAssetContainerAsync?p.loadAssetContainerAsync(t,g,c.rootUrl,d,c.name).then(v=>{v.populateRootNodes(),t.loadingPluginName=p.name,_(v)}).catch(v=>{u(v.message,v)}):u("LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.")},d,u,f,n,o,l)}function YI(a,e,t,i,r,s,n){return new Promise((o,l)=>{try{$c(a,e,t,c=>{o(c)},i,(c,h,f)=>{l(f||new Error(h))},r,s,n).catch(l)}catch(c){l(c)}})}async function Og(a,e="",t=Re.LastCreatedScene,i=!0,r=0,s=null,n=null,o=null,l=null,c=null,h="",f={}){if(!t){B.Error("No scene available to load animations to");return}if(i){for(const p of t.animatables)p.reset();t.stopAllAnimations(),t.animationGroups.slice().forEach(p=>{p.dispose()}),t.getNodes().forEach(p=>{p.animations&&(p.animations=[])})}else switch(r){case 0:t.animationGroups.slice().forEach(_=>{_.dispose()});break;case 1:t.animationGroups.forEach(_=>{_.stop()});break;case 2:t.animationGroups.forEach(_=>{_.reset(),_.restart()});break;case 3:break;default:B.Error("Unknown animation group loading mode value '"+r+"'");return}const u=t.animatables.length;await $c(a,e,t,_=>{_.mergeAnimationsTo(t,t.animatables.slice(u),s),_.dispose(),t.onAnimationFileImportedObservable.notifyObservers(t),n&&n(t)},o,l,c,h,f)}function KI(a,e,t,i,r,s,n,o,l,c){return new Promise((h,f)=>{try{Og(a,e,t,i,r,s,u=>{h(u)},n,(u,d,_)=>{f(_||new Error(d))},o,l,c).catch(f)}catch(u){f(u)}})}class wr{static get ForceFullSceneLoadingForIncremental(){return Bt.ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){Bt.ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return Bt.ShowLoadingScreen}static set ShowLoadingScreen(e){Bt.ShowLoadingScreen=e}static get loggingLevel(){return Bt.loggingLevel}static set loggingLevel(e){Bt.loggingLevel=e}static get CleanBoneMatrixWeights(){return Bt.CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){Bt.CleanBoneMatrixWeights=e}static GetDefaultPlugin(){return ao()}static GetPluginForExtension(e){var t;return(t=dl(e,!0))==null?void 0:t.plugin}static IsPluginForExtensionAvailable(e){return UI(e)}static RegisterPlugin(e){WI(e)}static ImportMesh(e,t,i,r,s,n,o,l,c){Mg(e,t,i,r,s,n,o,l,c).catch(h=>o==null?void 0:o(Re.LastCreatedScene,h==null?void 0:h.message,h))}static ImportMeshAsync(e,t,i,r,s,n,o){return XI(e,t,i,r,s,n,o)}static Load(e,t,i,r,s,n,o,l){Pg(e,t,i,r,s,n,o,l).catch(c=>n==null?void 0:n(Re.LastCreatedScene,c==null?void 0:c.message,c))}static LoadAsync(e,t,i,r,s,n){return HI(e,t,i,r,s,n)}static Append(e,t,i,r,s,n,o,l){Qc(e,t,i,r,s,n,o,l).catch(c=>n==null?void 0:n(i??Re.LastCreatedScene,c==null?void 0:c.message,c))}static AppendAsync(e,t,i,r,s,n){return zI(e,t,i,r,s,n)}static LoadAssetContainer(e,t,i,r,s,n,o,l){$c(e,t,i,r,s,n,o,l).catch(c=>n==null?void 0:n(i??Re.LastCreatedScene,c==null?void 0:c.message,c))}static LoadAssetContainerAsync(e,t,i,r,s,n){return YI(e,t,i,r,s,n)}static ImportAnimations(e,t,i,r,s,n,o,l,c,h,f){Og(e,t,i,r,s,n,o,l,c,h,f).catch(u=>c==null?void 0:c(i??Re.LastCreatedScene,u==null?void 0:u.message,u))}static ImportAnimationsAsync(e,t,i,r,s,n,o,l,c,h,f){return KI(e,t,i,r,s,n,l,h,f)}}wr.NO_LOGGING=0;wr.MINIMAL_LOGGING=1;wr.SUMMARY_LOGGING=2;wr.DETAILED_LOGGING=3;wr.OnPluginActivatedObservable=yg;class Dg{constructor(e,t,i,r,s=!1,n){this.scene=e,this.layout=t,this.gamepadObject=i,this.handedness=r,this._doNotLoadControllerMesh=s,this._controllerCache=n,this._initComponent=o=>{if(!o)return;const l=this.layout.components[o],c=l.type,h=l.gamepadIndices.button,f=[];l.gamepadIndices.xAxis!==void 0&&l.gamepadIndices.yAxis!==void 0&&f.push(l.gamepadIndices.xAxis,l.gamepadIndices.yAxis),this.components[o]=new vr(o,c,h,f)},this._modelReady=!1,this.components={},this.disableAnimation=!1,this.onModelLoadedObservable=new U,t.components&&Object.keys(t.components).forEach(this._initComponent)}dispose(){this.getComponentIds().forEach(e=>this.getComponent(e).dispose()),this.rootMesh&&(this.rootMesh.getChildren(void 0,!0).forEach(e=>{e.setEnabled(!1)}),this.rootMesh.dispose(!!this._controllerCache,!this._controllerCache)),this.onModelLoadedObservable.clear()}getAllComponentsOfType(e){return this.getComponentIds().map(t=>this.components[t]).filter(t=>t.type===e)}getComponent(e){return this.components[e]}getComponentIds(){return Object.keys(this.components)}getComponentOfType(e){return this.getAllComponentsOfType(e)[0]||null}getMainComponent(){return this.getComponent(this.layout.selectComponentId)}async loadModel(){const e=!this._getModelLoadingConstraints();let t=this._getGenericFilenameAndPath();return e?B.Warn("Falling back to generic models"):t=this._getFilenameAndPath(),new Promise((i,r)=>{const s=n=>{e?this._getGenericParentMesh(n):this._setRootMesh(n),this._processLoadedModel(n),this._modelReady=!0,this.onModelLoadedObservable.notifyObservers(this),i(!0)};if(this._controllerCache){const n=this._controllerCache.filter(o=>o.filename===t.filename&&o.path===t.path);if(n[0]){n[0].meshes.forEach(o=>o.setEnabled(!0)),s(n[0].meshes);return}}wr.ImportMesh("",t.path,t.filename,this.scene,n=>{this._controllerCache&&this._controllerCache.push({...t,meshes:n}),s(n)},null,(n,o)=>{B.Log(o),B.Warn(`Failed to retrieve controller model of type ${this.profileId} from the remote server: ${t.path}${t.filename}`),r(o)})})}updateFromXRFrame(e){this.getComponentIds().forEach(t=>this.getComponent(t).update(this.gamepadObject)),this.updateModel(e)}get handness(){return this.handedness}pulse(e,t,i=0){return this.gamepadObject.hapticActuators&&this.gamepadObject.hapticActuators[i]?this.gamepadObject.hapticActuators[i].pulse(e,t):Promise.resolve(!1)}_getChildByName(e,t){return e.getChildren(i=>i.name===t,!1)[0]}_getImmediateChildByName(e,t){return e.getChildren(i=>i.name==t,!0)[0]}_lerpTransform(e,t,i){if(!e.minMesh||!e.maxMesh||!e.valueMesh||!e.minMesh.rotationQuaternion||!e.maxMesh.rotationQuaternion||!e.valueMesh.rotationQuaternion)return;const r=i?t*.5+.5:t;z.SlerpToRef(e.minMesh.rotationQuaternion,e.maxMesh.rotationQuaternion,r,e.valueMesh.rotationQuaternion),m.LerpToRef(e.minMesh.position,e.maxMesh.position,r,e.valueMesh.position)}updateModel(e){this._modelReady&&this._updateModel(e)}_getGenericFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getGenericParentMesh(e){this.rootMesh=new N(this.profileId+" "+this.handedness,this.scene),e.forEach(t=>{t.parent||(t.isPickable=!1,t.setParent(this.rootMesh))}),this.rootMesh.rotationQuaternion=z.FromEulerAngles(0,Math.PI,0)}}class On extends Dg{constructor(e,t,i){super(e,qI[i],t,i),this.profileId=On.ProfileId}_getFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){}_setRootMesh(e){this.rootMesh=new N(this.profileId+" "+this.handedness,this.scene),e.forEach(t=>{t.isPickable=!1,t.parent||t.setParent(this.rootMesh)}),this.rootMesh.rotationQuaternion=z.FromEulerAngles(0,Math.PI,0)}_updateModel(){}}On.ProfileId="generic-trigger";const qI={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-none",assetPath:"none.glb"}};function Lg(a){const e=(a.segments||32)|0,t=a.diameterX||a.diameter||1,i=a.diameterY||a.diameter||1,r=a.diameterZ||a.diameter||1,s=a.arc&&(a.arc<=0||a.arc>1)?1:a.arc||1,n=a.slice&&a.slice<=0?1:a.slice||1,o=a.sideOrientation===0?0:a.sideOrientation||ee.DEFAULTSIDE,l=!!a.dedupTopBottomIndices,c=new m(t/2,i/2,r/2),h=2+e,f=2*h,u=[],d=[],_=[],p=[];for(let E=0;E<=h;E++){const v=E/h,b=v*Math.PI*n;for(let R=0;R<=f;R++){const S=R/f,T=S*Math.PI*2*s,I=P.RotationZ(-b),O=P.RotationY(T),L=m.TransformCoordinates(m.Up(),I),w=m.TransformCoordinates(L,O),$=w.multiply(c),J=w.divide(c).normalize();d.push($.x,$.y,$.z),_.push(J.x,J.y,J.z),p.push(S,v)}if(E>0){const R=d.length/3;for(let S=R-2*(f+1);S+f+2<R;S++)l?(E>1&&(u.push(S),u.push(S+1),u.push(S+f+1)),(E<h||n<1)&&(u.push(S+f+1),u.push(S+1),u.push(S+f+2))):(u.push(S),u.push(S+1),u.push(S+f+1),u.push(S+f+1),u.push(S+1),u.push(S+f+2))}}ee._ComputeSides(o,d,u,_,p,a.frontUVs,a.backUVs);const g=new ee;return g.indices=u,g.positions=d,g.normals=_,g.uvs=p,g}function Dn(a,e={},t=null){const i=new N(a,t);return e.sideOrientation=N._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,Lg(e).applyToMesh(i,e.updatable),i}ee.CreateSphere=Lg;N.CreateSphere=(a,e,t,i,r,s)=>Dn(a,{segments:e,diameterX:t,diameterY:t,diameterZ:t,sideOrientation:s,updatable:r},i);class jI extends Dg{constructor(e,t,i,r,s){super(e,i.layouts[t.handedness||"none"],t.gamepad,t.handedness,void 0,s),this._repositoryUrl=r,this.controllerCache=s,this._buttonMeshMapping={},this._touchDots={},this.profileId=i.profileId}dispose(){super.dispose(),this.controllerCache||Object.keys(this._touchDots).forEach(e=>{this._touchDots[e].dispose()})}_getFilenameAndPath(){return{filename:this.layout.assetPath,path:`${this._repositoryUrl}/profiles/${this.profileId}/`}}_getModelLoadingConstraints(){const e=wr.IsPluginForExtensionAvailable(".glb");return e||B.Warn("glTF / glb loader was not registered, using generic controller instead"),e}_processLoadedModel(e){this.getComponentIds().forEach(t=>{const i=this.layout.components[t];this._buttonMeshMapping[t]={mainMesh:this._getChildByName(this.rootMesh,i.rootNodeName),states:{}},Object.keys(i.visualResponses).forEach(r=>{const s=i.visualResponses[r];if(s.valueNodeProperty==="transform")this._buttonMeshMapping[t].states[r]={valueMesh:this._getChildByName(this.rootMesh,s.valueNodeName),minMesh:this._getChildByName(this.rootMesh,s.minNodeName),maxMesh:this._getChildByName(this.rootMesh,s.maxNodeName)};else{const n=i.type===vr.TOUCHPAD_TYPE&&i.touchPointNodeName?i.touchPointNodeName:s.valueNodeName;if(this._buttonMeshMapping[t].states[r]={valueMesh:this._getChildByName(this.rootMesh,n)},i.type===vr.TOUCHPAD_TYPE&&!this._touchDots[r]){const o=Dn(r+"dot",{diameter:.0015,segments:8},this.scene);o.material=new se(r+"mat",this.scene),o.material.diffuseColor=ae.Red(),o.parent=this._buttonMeshMapping[t].states[r].valueMesh||null,o.isVisible=!1,this._touchDots[r]=o}}})})}_setRootMesh(e){this.rootMesh=new N(this.profileId+"-"+this.handedness,this.scene),this.rootMesh.isPickable=!1;let t;for(let i=0;i<e.length;i++){const r=e[i];r.isPickable=!1,r.parent||(t=r)}t&&t.setParent(this.rootMesh),this.scene.useRightHandedSystem||this.rootMesh.rotate(Vi.Y,Math.PI,1)}_updateModel(e){this.disableAnimation||this.getComponentIds().forEach(t=>{const i=this.getComponent(t);if(!i.hasChanges)return;const r=this._buttonMeshMapping[t],s=this.layout.components[t];Object.keys(s.visualResponses).forEach(n=>{const o=s.visualResponses[n];let l=i.value;if(o.componentProperty==="xAxis"?l=i.axes.x:o.componentProperty==="yAxis"&&(l=i.axes.y),o.valueNodeProperty==="transform")this._lerpTransform(r.states[n],l,o.componentProperty!=="button");else{const c=r.states[n].valueMesh;c&&(c.isVisible=i.touched||i.pressed),this._touchDots[n]&&(this._touchDots[n].isVisible=i.touched||i.pressed)}})})}}const zo=[];class ai{static ClearProfilesCache(){this._ProfilesList=null,this._ProfileLoadingPromises={}}static DefaultFallbacks(){this.RegisterFallbacksForProfileId("google-daydream",["generic-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive-focus",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("magicleap-one",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("windows-mixed-reality",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("microsoft-mixed-reality",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-go",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("oculus-touch-v2",["oculus-touch","generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-touch",["generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-gearvr",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-odyssey",["generic-touchpad"]),this.RegisterFallbacksForProfileId("valve-index",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("generic-hand-select",["generic-trigger"])}static FindFallbackWithProfileId(e){const t=this._Fallbacks[e]||[];return t.unshift(e),t}static GetMotionControllerWithXRInput(e,t,i){const r=[];if(i&&r.push(i),r.push(...e.profiles||[]),r.length&&!r[0]&&r.pop(),e.gamepad&&e.gamepad.id)switch(e.gamepad.id){case(e.gamepad.id.match(/oculus touch/gi)?e.gamepad.id:void 0):r.push("oculus-touch-v2");break}const s=r.indexOf("windows-mixed-reality");if(s!==-1&&r.splice(s,0,"microsoft-mixed-reality"),r.length||r.push("generic-trigger"),this.UseOnlineRepository){const n=this.PrioritizeOnlineRepository?this._LoadProfileFromRepository:this._LoadProfilesFromAvailableControllers,o=this.PrioritizeOnlineRepository?this._LoadProfilesFromAvailableControllers:this._LoadProfileFromRepository;return n.call(this,r,e,t).catch(()=>o.call(this,r,e,t))}else return this._LoadProfilesFromAvailableControllers(r,e,t)}static RegisterController(e,t){this._AvailableControllers[e]=t}static RegisterFallbacksForProfileId(e,t){this._Fallbacks[e]?this._Fallbacks[e].push(...t):this._Fallbacks[e]=t}static UpdateProfilesList(){return this._ProfilesList=k.LoadFileAsync(this.BaseRepositoryUrl+"/profiles/profilesList.json",!1).then(e=>JSON.parse(e)),this._ProfilesList}static ClearControllerCache(){zo.forEach(e=>{e.meshes.forEach(t=>{t.dispose(!1,!0)})}),zo.length=0}static _LoadProfileFromRepository(e,t,i){return Promise.resolve().then(()=>this._ProfilesList?this._ProfilesList:this.UpdateProfilesList()).then(r=>{for(let s=0;s<e.length;++s)if(e[s]&&r[e[s]])return e[s];throw new Error(`neither controller ${e[0]} nor all fallbacks were found in the repository,`)}).then(r=>(this._ProfileLoadingPromises[r]||(this._ProfileLoadingPromises[r]=k.LoadFileAsync(`${this.BaseRepositoryUrl}/profiles/${r}/profile.json`,!1).then(s=>JSON.parse(s))),this._ProfileLoadingPromises[r])).then(r=>new jI(i,t,r,this.BaseRepositoryUrl,this.DisableControllerCache?void 0:zo))}static _LoadProfilesFromAvailableControllers(e,t,i){for(let r=0;r<e.length;++r){if(!e[r])continue;const s=this.FindFallbackWithProfileId(e[r]);for(let n=0;n<s.length;++n){const o=this._AvailableControllers[s[n]];if(o)return Promise.resolve(o(t,i))}}throw new Error("no controller requested was found in the available controllers list")}}ai._AvailableControllers={};ai._Fallbacks={};ai._ProfileLoadingPromises={};ai.BaseRepositoryUrl="https://immersive-web.github.io/webxr-input-profiles/packages/viewer/dist";ai.PrioritizeOnlineRepository=!0;ai.UseOnlineRepository=!0;ai.DisableControllerCache=!0;ai.RegisterController(On.ProfileId,(a,e)=>new On(e,a.gamepad,a.handedness));ai.DefaultFallbacks();let ZI=0;class QI{constructor(e,t,i={}){this._scene=e,this.inputSource=t,this._options=i,this._tmpVector=new m,this._disposed=!1,this.onDisposeObservable=new U,this.onMeshLoadedObservable=new U,this.onMotionControllerInitObservable=new U,this._uniqueId=`controller-${ZI++}-${t.targetRayMode}-${t.handedness}`,this.pointer=new N(`${this._uniqueId}-pointer`,e),this.pointer.rotationQuaternion=new z,this.inputSource.gripSpace&&(this.grip=new N(`${this._uniqueId}-grip`,this._scene),this.grip.rotationQuaternion=new z),this._tmpVector.set(0,0,this._scene.useRightHandedSystem?-1:1),this.inputSource.gamepad&&this.inputSource.targetRayMode==="tracked-pointer"&&ai.GetMotionControllerWithXRInput(t,e,this._options.forceControllerProfile).then(r=>{this.motionController=r,this.onMotionControllerInitObservable.notifyObservers(r),!this._options.doNotLoadControllerMesh&&!this.motionController._doNotLoadControllerMesh&&this.motionController.loadModel().then(s=>{var n;s&&this.motionController&&this.motionController.rootMesh&&(this._options.renderingGroupId&&(this.motionController.rootMesh.renderingGroupId=this._options.renderingGroupId,this.motionController.rootMesh.getChildMeshes(!1).forEach(o=>o.renderingGroupId=this._options.renderingGroupId)),this.onMeshLoadedObservable.notifyObservers(this.motionController.rootMesh),this.motionController.rootMesh.parent=this.grip||this.pointer,this.motionController.disableAnimation=!!this._options.disableMotionControllerAnimation),this._disposed&&((n=this.motionController)==null||n.dispose())})},()=>{k.Warn("Could not find a matching motion controller for the registered input source")})}get uniqueId(){return this._uniqueId}dispose(){this.grip&&this.grip.dispose(!0),this.motionController&&this.motionController.dispose(),this.pointer.dispose(!0),this.onMotionControllerInitObservable.clear(),this.onMeshLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._disposed=!0}getWorldPointerRayToRef(e,t=!1){const i=t&&this.grip?this.grip:this.pointer;m.TransformNormalToRef(this._tmpVector,i.getWorldMatrix(),e.direction),e.direction.normalize(),e.origin.copyFrom(i.absolutePosition),e.length=1e3}updateFromXRFrame(e,t,i,r){const s=e.getPose(this.inputSource.targetRaySpace,t);if(this._lastXRPose=s,s){const n=s.transform.position;this.pointer.position.set(n.x,n.y,n.z).scaleInPlace(r.worldScalingFactor);const o=s.transform.orientation;this.pointer.rotationQuaternion.set(o.x,o.y,o.z,o.w),this._scene.useRightHandedSystem||(this.pointer.position.z*=-1,this.pointer.rotationQuaternion.z*=-1,this.pointer.rotationQuaternion.w*=-1),this.pointer.parent=i.parent,this.pointer.scaling.setAll(r.worldScalingFactor)}if(this.inputSource.gripSpace&&this.grip){const n=e.getPose(this.inputSource.gripSpace,t);if(n){const o=n.transform.position,l=n.transform.orientation;this.grip.position.set(o.x,o.y,o.z).scaleInPlace(r.worldScalingFactor),this.grip.rotationQuaternion.set(l.x,l.y,l.z,l.w),this._scene.useRightHandedSystem||(this.grip.position.z*=-1,this.grip.rotationQuaternion.z*=-1,this.grip.rotationQuaternion.w*=-1)}this.grip.parent=i.parent,this.grip.scaling.setAll(r.worldScalingFactor)}this.motionController&&this.motionController.updateFromXRFrame(e)}}class $I{constructor(e,t,i={}){if(this.xrSessionManager=e,this.xrCamera=t,this._options=i,this.controllers=[],this.onControllerAddedObservable=new U,this.onControllerRemovedObservable=new U,this._onInputSourcesChange=r=>{this._addAndRemoveControllers(r.added,r.removed)},this._sessionEndedObserver=this.xrSessionManager.onXRSessionEnded.add(()=>{this._addAndRemoveControllers([],this.controllers.map(r=>r.inputSource))}),this._sessionInitObserver=this.xrSessionManager.onXRSessionInit.add(r=>{r.addEventListener("inputsourceschange",this._onInputSourcesChange)}),this._frameObserver=this.xrSessionManager.onXRFrameObservable.add(r=>{this.controllers.forEach(s=>{s.updateFromXRFrame(r,this.xrSessionManager.referenceSpace,this.xrCamera,this.xrSessionManager)})}),this._options.customControllersRepositoryURL&&(ai.BaseRepositoryUrl=this._options.customControllersRepositoryURL),ai.UseOnlineRepository=!this._options.disableOnlineControllerRepository,ai.UseOnlineRepository)try{ai.UpdateProfilesList().catch(()=>{ai.UseOnlineRepository=!1})}catch{ai.UseOnlineRepository=!1}}_addAndRemoveControllers(e,t){const i=this.controllers.map(n=>n.inputSource);for(const n of e)if(i.indexOf(n)===-1){const o=new QI(this.xrSessionManager.scene,n,{...this._options.controllerOptions||{},forceControllerProfile:this._options.forceInputProfile,doNotLoadControllerMesh:this._options.doNotLoadControllerMeshes,disableMotionControllerAnimation:this._options.disableControllerAnimation});this.controllers.push(o),this.onControllerAddedObservable.notifyObservers(o)}const r=[],s=[];this.controllers.forEach(n=>{t.indexOf(n.inputSource)===-1?r.push(n):s.push(n)}),this.controllers=r,s.forEach(n=>{this.onControllerRemovedObservable.notifyObservers(n),n.dispose()})}dispose(){this.controllers.forEach(e=>{e.dispose()}),this.xrSessionManager.onXRFrameObservable.remove(this._frameObserver),this.xrSessionManager.onXRSessionInit.remove(this._sessionInitObserver),this.xrSessionManager.onXRSessionEnded.remove(this._sessionEndedObserver),this.onControllerAddedObservable.clear(),this.onControllerRemovedObservable.clear(),ai.ClearControllerCache()}}function Ng(a){const e=a.height||2;let t=a.diameterTop===0?0:a.diameterTop||a.diameter||1,i=a.diameterBottom===0?0:a.diameterBottom||a.diameter||1;t=t||1e-5,i=i||1e-5;const r=(a.tessellation||24)|0,s=(a.subdivisions||1)|0,n=!!a.hasRings,o=!!a.enclose,l=a.cap===0?0:a.cap||N.CAP_ALL,c=a.arc&&(a.arc<=0||a.arc>1)?1:a.arc||1,h=a.sideOrientation===0?0:a.sideOrientation||ee.DEFAULTSIDE,f=a.faceUV||new Array(3),u=a.faceColors,d=c!==1&&o?2:0,_=n?s:1,p=2+(1+d)*_;let g;for(g=0;g<p;g++)u&&u[g]===void 0&&(u[g]=new Ne(1,1,1,1));for(g=0;g<p;g++)f&&f[g]===void 0&&(f[g]=new Fe(0,0,1,1));const E=[],v=[],b=[],R=[],S=[],T=Math.PI*2*c/r;let I,O,L;const w=(i-t)/2/e,$=m.Zero(),J=m.Zero(),ce=m.Zero(),le=m.Zero(),oe=m.Zero(),ue=Vi.Y;let Pe,Se,ie,K=1,M=1,V=0,re=0;for(Pe=0;Pe<=s;Pe++)for(O=Pe/s,L=(O*(t-i)+i)/2,K=n&&Pe!==0&&Pe!==s?2:1,ie=0;ie<K;ie++){for(n&&(M+=ie),o&&(M+=2*ie),Se=0;Se<=r;Se++)I=Se*T,$.x=Math.cos(-I)*L,$.y=-e/2+O*e,$.z=Math.sin(-I)*L,t===0&&Pe===s?(J.x=b[b.length-(r+1)*3],J.y=b[b.length-(r+1)*3+1],J.z=b[b.length-(r+1)*3+2]):(J.x=$.x,J.z=$.z,J.y=Math.sqrt(J.x*J.x+J.z*J.z)*w,J.normalize()),Se===0&&(ce.copyFrom($),le.copyFrom(J)),v.push($.x,$.y,$.z),b.push(J.x,J.y,J.z),n?re=V!==M?f[M].y:f[M].w:re=f[M].y+(f[M].w-f[M].y)*O,R.push(f[M].x+(f[M].z-f[M].x)*Se/r,re),u&&S.push(u[M].r,u[M].g,u[M].b,u[M].a);c!==1&&o&&(v.push($.x,$.y,$.z),v.push(0,$.y,0),v.push(0,$.y,0),v.push(ce.x,ce.y,ce.z),m.CrossToRef(ue,J,oe),oe.normalize(),b.push(oe.x,oe.y,oe.z,oe.x,oe.y,oe.z),m.CrossToRef(le,ue,oe),oe.normalize(),b.push(oe.x,oe.y,oe.z,oe.x,oe.y,oe.z),n?re=V!==M?f[M+1].y:f[M+1].w:re=f[M+1].y+(f[M+1].w-f[M+1].y)*O,R.push(f[M+1].x,re),R.push(f[M+1].z,re),n?re=V!==M?f[M+2].y:f[M+2].w:re=f[M+2].y+(f[M+2].w-f[M+2].y)*O,R.push(f[M+2].x,re),R.push(f[M+2].z,re),u&&(S.push(u[M+1].r,u[M+1].g,u[M+1].b,u[M+1].a),S.push(u[M+1].r,u[M+1].g,u[M+1].b,u[M+1].a),S.push(u[M+2].r,u[M+2].g,u[M+2].b,u[M+2].a),S.push(u[M+2].r,u[M+2].g,u[M+2].b,u[M+2].a))),V!==M&&(V=M)}const ve=c!==1&&o?r+4:r;for(Pe=0,M=0;M<s;M++){let me=0,Oe=0,Ee=0,Ue=0;for(Se=0;Se<r;Se++)me=Pe*(ve+1)+Se,Oe=(Pe+1)*(ve+1)+Se,Ee=Pe*(ve+1)+(Se+1),Ue=(Pe+1)*(ve+1)+(Se+1),E.push(me,Oe,Ee),E.push(Ue,Ee,Oe);c!==1&&o&&(E.push(me+2,Oe+2,Ee+2),E.push(Ue+2,Ee+2,Oe+2),E.push(me+4,Oe+4,Ee+4),E.push(Ue+4,Ee+4,Oe+4)),Pe=n?Pe+2:Pe+1}const Be=me=>{const Oe=me?t/2:i/2;if(Oe===0)return;let Ee,Ue,vt;const xe=me?f[p-1]:f[0];let Ye=null;u&&(Ye=me?u[p-1]:u[0]);const Me=v.length/3,Tt=me?e/2:-e/2,Lt=new m(0,Tt,0);v.push(Lt.x,Lt.y,Lt.z),b.push(0,me?1:-1,0);const Kt=xe.y+(xe.w-xe.y)*.5;R.push(xe.x+(xe.z-xe.x)*.5,Kt),Ye&&S.push(Ye.r,Ye.g,Ye.b,Ye.a);const Ci=new ne(.5,.5);for(vt=0;vt<=r;vt++){Ee=Math.PI*2*vt*c/r;const as=Math.cos(-Ee),Wr=Math.sin(-Ee);Ue=new m(as*Oe,Tt,Wr*Oe);const ea=new ne(as*Ci.x+.5,Wr*Ci.y+.5);v.push(Ue.x,Ue.y,Ue.z),b.push(0,me?1:-1,0);const Ro=xe.y+(xe.w-xe.y)*ea.y;R.push(xe.x+(xe.z-xe.x)*ea.x,Ro),Ye&&S.push(Ye.r,Ye.g,Ye.b,Ye.a)}for(vt=0;vt<r;vt++)me?(E.push(Me),E.push(Me+(vt+2)),E.push(Me+(vt+1))):(E.push(Me),E.push(Me+(vt+1)),E.push(Me+(vt+2)))};(l===N.CAP_START||l===N.CAP_ALL)&&Be(!1),(l===N.CAP_END||l===N.CAP_ALL)&&Be(!0),ee._ComputeSides(h,v,E,b,R,a.frontUVs,a.backUVs);const fe=new ee;return fe.indices=E,fe.positions=v,fe.normals=b,fe.uvs=R,u&&(fe.colors=S),fe}function oo(a,e={},t){const i=new N(a,t);return e.sideOrientation=N._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,Ng(e).applyToMesh(i,e.updatable),i}ee.CreateCylinder=Ng;N.CreateCylinder=(a,e,t,i,r,s,n,o,l)=>((n===void 0||!(n instanceof Ge))&&(n!==void 0&&(l=o||N.DEFAULTSIDE,o=n),n=s,s=1),oo(a,{height:e,diameterTop:t,diameterBottom:i,tessellation:r,subdivisions:s,sideOrientation:l,updatable:o},n));class lo{get xrNativeFeatureName(){return this._xrNativeFeatureName}set xrNativeFeatureName(e){var t;!this._xrSessionManager.isNative&&e&&this._xrSessionManager.inXRSession&&((t=this._xrSessionManager.enabledFeatures)==null?void 0:t.indexOf(e))===-1&&B.Warn(`The feature ${e} needs to be enabled before starting the XR session. Note - It is still possible it is not supported.`),this._xrNativeFeatureName=e}constructor(e){this._xrSessionManager=e,this._attached=!1,this._removeOnDetach=[],this.isDisposed=!1,this.disableAutoAttach=!1,this._xrNativeFeatureName="",this.onFeatureAttachObservable=new U,this.onFeatureDetachObservable=new U}get attached(){return this._attached}attach(e){if(this.isDisposed)return!1;if(e)this.attached&&this.detach();else if(this.attached)return!1;if(!this._xrSessionManager.enabledFeatures)B.Warn("session.enabledFeatures is not available on this device. It is possible that this feature is not supported.");else if(!this._xrSessionManager.isNative&&this.xrNativeFeatureName&&this._xrSessionManager.enabledFeatures.indexOf(this.xrNativeFeatureName)===-1)return!1;return this._attached=!0,this._addNewAttachObserver(this._xrSessionManager.onXRFrameObservable,t=>this._onXRFrame(t)),this.onFeatureAttachObservable.notifyObservers(this),!0}detach(){return this._attached?(this._attached=!1,this._removeOnDetach.forEach(e=>{e.observable.remove(e.observer)}),this.onFeatureDetachObservable.notifyObservers(this),!0):(this.disableAutoAttach=!0,!1)}dispose(){this.detach(),this.isDisposed=!0,this.onFeatureAttachObservable.clear(),this.onFeatureDetachObservable.clear()}isCompatible(){return!0}_addNewAttachObserver(e,t,i){this._removeOnDetach.push({observable:e,observer:e.add(t,void 0,i)})}}class Nt{getRenderCamera(e){if(this._renderCamera)return this._renderCamera;{let t;return this.originalScene.activeCameras&&this.originalScene.activeCameras.length>1?t=this.originalScene.activeCameras[this.originalScene.activeCameras.length-1]:t=this.originalScene.activeCamera,e&&t&&t.isRigCamera?t.rigParent:t}}setRenderCamera(e){this._renderCamera=e}_getSharedGizmoLight(){return this._sharedGizmoLight||(this._sharedGizmoLight=new an("shared gizmo light",new m(0,1,0),this.utilityLayerScene),this._sharedGizmoLight.intensity=2,this._sharedGizmoLight.groundColor=ae.Gray()),this._sharedGizmoLight}static get DefaultUtilityLayer(){return Nt._DefaultUtilityLayer==null?Nt._CreateDefaultUtilityLayerFromScene(Re.LastCreatedScene):Nt._DefaultUtilityLayer}static _CreateDefaultUtilityLayerFromScene(e){return Nt._DefaultUtilityLayer=new Nt(e),Nt._DefaultUtilityLayer.originalScene.onDisposeObservable.addOnce(()=>{Nt._DefaultUtilityLayer=null}),Nt._DefaultUtilityLayer}static get DefaultKeepDepthUtilityLayer(){return Nt._DefaultKeepDepthUtilityLayer==null&&(Nt._DefaultKeepDepthUtilityLayer=new Nt(Re.LastCreatedScene),Nt._DefaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,Nt._DefaultKeepDepthUtilityLayer.originalScene.onDisposeObservable.addOnce(()=>{Nt._DefaultKeepDepthUtilityLayer=null})),Nt._DefaultKeepDepthUtilityLayer}constructor(e,t=!0,i=!1){this.originalScene=e,this.handleEvents=t,this._pointerCaptures={},this._lastPointerEvents={},this._sharedGizmoLight=null,this._renderCamera=null,this.pickUtilitySceneFirst=!0,this.shouldRender=!0,this.onlyCheckPointerDownEvents=!0,this.processAllEvents=!1,this.pickingEnabled=!0,this.onPointerOutObservable=new U,this.utilityLayerScene=new Ge(e.getEngine(),{virtual:!0}),this.utilityLayerScene.useRightHandedSystem=e.useRightHandedSystem,this.utilityLayerScene._allowPostProcessClearColor=!1,this.utilityLayerScene.postProcessesEnabled=!1,this.utilityLayerScene.detachControl(),t&&(this._originalPointerObserver=e.onPrePointerObservable.add(r=>{var l;if(!this.utilityLayerScene.activeCamera||!this.pickingEnabled||!this.processAllEvents&&r.type!==ge.POINTERMOVE&&r.type!==ge.POINTERUP&&r.type!==ge.POINTERDOWN&&r.type!==ge.POINTERDOUBLETAP)return;this.utilityLayerScene.pointerX=e.pointerX,this.utilityLayerScene.pointerY=e.pointerY;const s=r.event;if(e.isPointerCaptured(s.pointerId)){this._pointerCaptures[s.pointerId]=!1;return}const n=c=>{let h=null;if(r.nearInteractionPickingInfo)r.nearInteractionPickingInfo.pickedMesh.getScene()==c?h=r.nearInteractionPickingInfo:h=new oi;else if(c!==this.utilityLayerScene&&r.originalPickingInfo)h=r.originalPickingInfo;else{let f=null;this._renderCamera&&(f=c._activeCamera,c._activeCamera=this._renderCamera,r.ray=null),h=r.ray?c.pickWithRay(r.ray):c.pick(e.pointerX,e.pointerY),f&&(c._activeCamera=f)}return h},o=n(this.utilityLayerScene);if(!r.ray&&o&&(r.ray=o.ray),(l=r.originalPickingInfo)!=null&&l.aimTransform&&o&&(o.aimTransform=r.originalPickingInfo.aimTransform,o.gripTransform=r.originalPickingInfo.gripTransform),this.utilityLayerScene.onPrePointerObservable.notifyObservers(r),this.onlyCheckPointerDownEvents&&r.type!=ge.POINTERDOWN){r.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new Xi(r.type,r.event,o),r.type),r.type===ge.POINTERUP&&this._pointerCaptures[s.pointerId]&&(this._pointerCaptures[s.pointerId]=!1);return}if(this.utilityLayerScene.autoClearDepthAndStencil||this.pickUtilitySceneFirst)o&&o.hit&&(r.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new Xi(r.type,r.event,o),r.type),r.skipOnPointerObservable=!0);else{const c=n(e),h=r.event;c&&o&&(o.distance===0&&c.pickedMesh?this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(c.pickedMesh)?(this._notifyObservers(r,c,h),r.skipOnPointerObservable=!0):r.type===ge.POINTERDOWN?(this._pointerCaptures[h.pointerId]=!0,this._notifyObservers(r,c,h)):(r.type===ge.POINTERMOVE||r.type===ge.POINTERUP)&&(this._lastPointerEvents[h.pointerId]&&(this.onPointerOutObservable.notifyObservers(h.pointerId),delete this._lastPointerEvents[h.pointerId]),this._notifyObservers(r,c,h)):!this._pointerCaptures[h.pointerId]&&(o.distance<c.distance||c.distance===0)?(this._notifyObservers(r,o,h),r.skipOnPointerObservable||(r.skipOnPointerObservable=o.distance>0)):!this._pointerCaptures[h.pointerId]&&o.distance>=c.distance&&(this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(c.pickedMesh)?(this._notifyObservers(r,c,h),r.skipOnPointerObservable=!0):((r.type===ge.POINTERMOVE||r.type===ge.POINTERUP)&&this._lastPointerEvents[h.pointerId]&&(this.onPointerOutObservable.notifyObservers(h.pointerId),delete this._lastPointerEvents[h.pointerId]),this._notifyObservers(r,o,h))),r.type===ge.POINTERUP&&this._pointerCaptures[h.pointerId]&&(this._pointerCaptures[h.pointerId]=!1))}}),this._originalPointerObserver&&e.onPrePointerObservable.makeObserverTopPriority(this._originalPointerObserver)),this.utilityLayerScene.autoClear=!1,i||(this._afterRenderObserver=this.originalScene.onAfterRenderCameraObservable.add(r=>{this.shouldRender&&r==this.getRenderCamera()&&this.render()})),this._sceneDisposeObserver=this.originalScene.onDisposeObservable.add(()=>{this.dispose()}),this._updateCamera()}_notifyObservers(e,t,i){e.skipOnPointerObservable||(this.utilityLayerScene.onPointerObservable.notifyObservers(new Xi(e.type,e.event,t),e.type),this._lastPointerEvents[i.pointerId]=!0)}render(){if(this._updateCamera(),this.utilityLayerScene.activeCamera){const e=this.utilityLayerScene.activeCamera.getScene(),t=this.utilityLayerScene.activeCamera;t._scene=this.utilityLayerScene,t.leftCamera&&(t.leftCamera._scene=this.utilityLayerScene),t.rightCamera&&(t.rightCamera._scene=this.utilityLayerScene),this.utilityLayerScene.render(!1),t._scene=e,t.leftCamera&&(t.leftCamera._scene=e),t.rightCamera&&(t.rightCamera._scene=e)}}dispose(){this.onPointerOutObservable.clear(),this._afterRenderObserver&&this.originalScene.onAfterCameraRenderObservable.remove(this._afterRenderObserver),this._sceneDisposeObserver&&this.originalScene.onDisposeObservable.remove(this._sceneDisposeObserver),this._originalPointerObserver&&this.originalScene.onPrePointerObservable.remove(this._originalPointerObserver),this.utilityLayerScene.dispose()}_updateCamera(){this.utilityLayerScene.cameraToUseForPointers=this.getRenderCamera(),this.utilityLayerScene.activeCamera=this.getRenderCamera()}}Nt._DefaultUtilityLayer=null;Nt._DefaultKeepDepthUtilityLayer=null;class mr extends lo{constructor(e,t){super(e),this._options=t,this._attachController=i=>{if(this._controllers[i.uniqueId])return;const{laserPointer:r,selectionMesh:s}=this._generateNewMeshPair(this._options.forceGripIfAvailable&&i.grip?i.grip:i.pointer);switch(this._controllers[i.uniqueId]={xrController:i,laserPointer:r,selectionMesh:s,meshUnderPointer:null,pick:null,tmpRay:new He(new m,new m),disabledByNearInteraction:!1,id:mr._IdCounter++},this._attachedController?!this._options.enablePointerSelectionOnAllControllers&&this._options.preferredHandedness&&i.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=i.uniqueId):this._options.enablePointerSelectionOnAllControllers||(this._attachedController=i.uniqueId),i.inputSource.targetRayMode){case"tracked-pointer":return this._attachTrackedPointerRayMode(i);case"gaze":return this._attachGazeMode(i);case"screen":case"transient-pointer":return this._attachScreenRayMode(i)}},this._controllers={},this._tmpVectorForPickCompare=new m,this.disablePointerLighting=!0,this.disableSelectionMeshLighting=!0,this.displayLaserPointer=!0,this.displaySelectionMesh=!0,this.laserPointerPickedColor=new ae(.9,.9,.9),this.laserPointerDefaultColor=new ae(.7,.7,.7),this.selectionMeshDefaultColor=new ae(.8,.8,.8),this.selectionMeshPickedColor=new ae(.3,.3,1),this._identityMatrix=P.Identity(),this._screenCoordinatesRef=m.Zero(),this._viewportRef=new Er(0,0,0,0),this._scene=this._xrSessionManager.scene,this._options.lookAndPickMode===void 0&&(this._scene.getEngine()._badDesktopOS||this._scene.getEngine()._badOS)&&(this._options.lookAndPickMode=!0),this._options.lookAndPickMode&&(this._options.enablePointerSelectionOnAllControllers=!0,this.displayLaserPointer=!1)}attach(){if(!super.attach())return!1;if(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController,!0),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)},!0),this._scene.constantlyUpdateMeshUnderPointer=!0,this._options.gazeCamera){const e=this._options.gazeCamera,{laserPointer:t,selectionMesh:i}=this._generateNewMeshPair(e);this._controllers.camera={webXRCamera:e,laserPointer:t,selectionMesh:i,meshUnderPointer:null,pick:null,tmpRay:new He(new m,new m),disabledByNearInteraction:!1,id:mr._IdCounter++},this._attachGazeMode()}return!0}detach(){return super.detach()?(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),!0):!1}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].xrController||null;return null}_getPointerSelectionDisabledByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].disabledByNearInteraction;return!0}_setPointerSelectionDisabledByPointerId(e,t){const i=Object.keys(this._controllers);for(let r=0;r<i.length;++r)if(this._controllers[i[r]].id===e){this._controllers[i[r]].disabledByNearInteraction=t;return}}_onXRFrame(e){Object.keys(this._controllers).forEach(t=>{var l;const i=this._controllers[t];if(this._options.lookAndPickMode&&((l=i.xrController)==null?void 0:l.inputSource.targetRayMode)!=="transient-pointer")return;if(!this._options.enablePointerSelectionOnAllControllers&&t!==this._attachedController||i.disabledByNearInteraction){i.selectionMesh.isVisible=!1,i.laserPointer.isVisible=!1,i.pick=null;return}i.laserPointer.isVisible=this.displayLaserPointer;let r;if(i.xrController)r=this._options.forceGripIfAvailable&&i.xrController.grip?i.xrController.grip.position:i.xrController.pointer.position,i.xrController.getWorldPointerRayToRef(i.tmpRay,this._options.forceGripIfAvailable);else if(i.webXRCamera)r=i.webXRCamera.position,i.webXRCamera.getForwardRayToRef(i.tmpRay);else return;if(this._options.maxPointerDistance&&(i.tmpRay.length=this._options.maxPointerDistance),!this._options.disableScenePointerVectorUpdate&&r){const c=this._xrSessionManager.scene,h=this._options.xrInput.xrCamera;h&&(h.viewport.toGlobalToRef(c.getEngine().getRenderWidth()/h.rigCameras.length,c.getEngine().getRenderHeight(),this._viewportRef),m.ProjectToRef(r,this._identityMatrix,h.getTransformationMatrix(),this._viewportRef,this._screenCoordinatesRef),typeof this._screenCoordinatesRef.x=="number"&&typeof this._screenCoordinatesRef.y=="number"&&!isNaN(this._screenCoordinatesRef.x)&&!isNaN(this._screenCoordinatesRef.y)&&this._screenCoordinatesRef.x!==1/0&&this._screenCoordinatesRef.y!==1/0&&(c.pointerX=this._screenCoordinatesRef.x,c.pointerY=this._screenCoordinatesRef.y,i.screenCoordinates={x:this._screenCoordinatesRef.x,y:this._screenCoordinatesRef.y}))}let s=null;this._utilityLayerScene&&(s=this._utilityLayerScene.pickWithRay(i.tmpRay,this._utilityLayerScene.pointerMovePredicate||this.raySelectionPredicate));const n=this._scene.pickWithRay(i.tmpRay,this._scene.pointerMovePredicate||this.raySelectionPredicate);!s||!s.hit?i.pick=n:!n||!n.hit||s.distance<n.distance?i.pick=s:i.pick=n,i.pick&&i.xrController&&(i.pick.aimTransform=i.xrController.pointer,i.pick.gripTransform=i.xrController.grip||null,i.pick.originMesh=i.xrController.pointer,i.tmpRay.length=i.pick.distance);const o=i.pick;if(o&&o.pickedPoint&&o.hit){this._updatePointerDistance(i.laserPointer,o.distance),i.selectionMesh.position.copyFrom(o.pickedPoint),i.selectionMesh.scaling.x=Math.sqrt(o.distance),i.selectionMesh.scaling.y=Math.sqrt(o.distance),i.selectionMesh.scaling.z=Math.sqrt(o.distance);const c=this._convertNormalToDirectionOfRay(o.getNormal(!0),i.tmpRay),h=.001;if(i.selectionMesh.position.copyFrom(o.pickedPoint),c){const f=m.Cross(Vi.Y,c),u=m.Cross(c,f);m.RotationFromAxisToRef(u,c,f,i.selectionMesh.rotation),i.selectionMesh.position.addInPlace(c.scale(h))}i.selectionMesh.isVisible=this.displaySelectionMesh,i.meshUnderPointer=o.pickedMesh}else i.selectionMesh.isVisible=!1,this._updatePointerDistance(i.laserPointer,1),i.meshUnderPointer=null})}get _utilityLayerScene(){return this._options.customUtilityLayerScene||Nt.DefaultUtilityLayer.utilityLayerScene}_attachGazeMode(e){const t=this._controllers[e&&e.uniqueId||"camera"],i=this._options.timeToSelect||3e3,r=this._options.useUtilityLayer?this._utilityLayerScene:this._scene;let s=new oi;const n=Rs("selection",{diameter:.0035*15,thickness:.0025*6,tessellation:20},r);n.isVisible=!1,n.isPickable=!1,n.parent=t.selectionMesh;let o=0,l=!1;const c={pointerId:t.id,pointerType:"xr"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{if(t.pick){if(this._augmentPointerInit(c,t.id,t.screenCoordinates),t.laserPointer.material.alpha=0,n.isVisible=!1,t.pick.hit)if(this._pickingMoved(s,t.pick))l&&(this._options.disablePointerUpOnTouchOut||this._scene.simulatePointerUp(t.pick,c)),l=!1,o=0;else if(o>i/10&&(n.isVisible=!0),o+=this._scene.getEngine().getDeltaTime(),o>=i)this._scene.simulatePointerDown(t.pick,c),l=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(t.pick,c),n.isVisible=!1;else{const h=1-o/i;n.scaling.set(h,h,h)}else l=!1,o=0;this._scene.simulatePointerMove(t.pick,c),s=t.pick}}),this._options.renderingGroupId!==void 0&&(n.renderingGroupId=this._options.renderingGroupId),e&&e.onDisposeObservable.addOnce(()=>{t.pick&&!this._options.disablePointerUpOnTouchOut&&l&&(this._scene.simulatePointerUp(t.pick,c),t.finalPointerUpTriggered=!0),n.dispose()})}_attachScreenRayMode(e){const t=this._controllers[e.uniqueId];let i=!1;const r={pointerId:t.id,pointerType:"xr"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{this._augmentPointerInit(r,t.id,t.screenCoordinates),!(!t.pick||this._options.disablePointerUpOnTouchOut&&i)&&(i?this._scene.simulatePointerMove(t.pick,r):(this._scene.simulatePointerDown(t.pick,r),t.pointerDownTriggered=!0,i=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(t.pick,r)))}),e.onDisposeObservable.addOnce(()=>{this._augmentPointerInit(r,t.id,t.screenCoordinates),this._xrSessionManager.runInXRFrame(()=>{t.pick&&!t.finalPointerUpTriggered&&i&&!this._options.disablePointerUpOnTouchOut&&(this._scene.simulatePointerUp(t.pick,r),t.finalPointerUpTriggered=!0)})})}_attachTrackedPointerRayMode(e){const t=this._controllers[e.uniqueId];if(this._options.forceGazeMode)return this._attachGazeMode(e);const i={pointerId:t.id,pointerType:"xr"};if(t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{t.laserPointer.material.disableLighting=this.disablePointerLighting,t.selectionMesh.material.disableLighting=this.disableSelectionMeshLighting,t.pick&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),this._scene.simulatePointerMove(t.pick,i))}),e.inputSource.gamepad){const r=s=>{this._options.overrideButtonId&&(t.selectionComponent=s.getComponent(this._options.overrideButtonId)),t.selectionComponent||(t.selectionComponent=s.getMainComponent()),t.onButtonChangedObserver=t.selectionComponent.onButtonStateChangedObservable.add(n=>{if(n.changes.pressed){const o=n.changes.pressed.current;if(t.pick)(this._options.enablePointerSelectionOnAllControllers||e.uniqueId===this._attachedController)&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),o?(this._scene.simulatePointerDown(t.pick,i),t.pointerDownTriggered=!0,t.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,t.laserPointer.material.emissiveColor=this.laserPointerPickedColor):(this._scene.simulatePointerUp(t.pick,i),t.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,t.laserPointer.material.emissiveColor=this.laserPointerDefaultColor));else if(o&&!this._options.enablePointerSelectionOnAllControllers&&!this._options.disableSwitchOnClick){const l=this._controllers[this._attachedController];l&&l.pointerDownTriggered&&!l.finalPointerUpTriggered&&(this._augmentPointerInit(i,l.id,l.screenCoordinates),this._scene.simulatePointerUp(new oi,{pointerId:l.id,pointerType:"xr"}),l.finalPointerUpTriggered=!0),this._attachedController=e.uniqueId}}})};e.motionController?r(e.motionController):e.onMotionControllerInitObservable.add(r)}else{const r=n=>{this._xrSessionManager.onXRFrameObservable.addOnce(()=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),t.xrController&&n.inputSource===t.xrController.inputSource&&t.pick&&(this._scene.simulatePointerDown(t.pick,i),t.pointerDownTriggered=!0,t.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,t.laserPointer.material.emissiveColor=this.laserPointerPickedColor)})},s=n=>{this._xrSessionManager.onXRFrameObservable.addOnce(()=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),t.xrController&&n.inputSource===t.xrController.inputSource&&t.pick&&(this._scene.simulatePointerUp(t.pick,i),t.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,t.laserPointer.material.emissiveColor=this.laserPointerDefaultColor)})};t.eventListeners={selectend:s,selectstart:r},this._xrSessionManager.session.addEventListener("selectstart",r),this._xrSessionManager.session.addEventListener("selectend",s)}}_convertNormalToDirectionOfRay(e,t){return e&&Math.acos(m.Dot(e,t.direction))<Math.PI/2&&e.scaleInPlace(-1),e}_detachController(e){const t=this._controllers[e];if(t){if(t.selectionComponent&&t.onButtonChangedObserver&&t.selectionComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver),t.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(t.onFrameObserver),t.eventListeners&&Object.keys(t.eventListeners).forEach(i=>{const r=t.eventListeners&&t.eventListeners[i];r&&this._xrSessionManager.session.removeEventListener(i,r)}),!t.finalPointerUpTriggered&&t.pointerDownTriggered){const i={pointerId:t.id,pointerType:"xr"};this._xrSessionManager.runInXRFrame(()=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),this._scene.simulatePointerUp(t.pick||new oi,i),t.finalPointerUpTriggered=!0})}this._xrSessionManager.scene.onBeforeRenderObservable.addOnce(()=>{try{if(t.selectionMesh.dispose(),t.laserPointer.dispose(),delete this._controllers[e],this._attachedController===e){const i=Object.keys(this._controllers);i.length?this._attachedController=i[0]:this._attachedController=""}}catch{k.Warn("controller already detached.")}})}}_generateNewMeshPair(e){const t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Nt.DefaultUtilityLayer.utilityLayerScene:this._scene,i=this._options.customLasterPointerMeshGenerator?this._options.customLasterPointerMeshGenerator():oo("laserPointer",{height:1,diameterTop:2e-4,diameterBottom:.004,tessellation:20,subdivisions:1},t);i.parent=e;const r=new se("laserPointerMat",t);r.emissiveColor=this.laserPointerDefaultColor,r.alpha=.7,i.material=r,i.rotation.x=Math.PI/2,this._updatePointerDistance(i,1),i.isPickable=!1,i.isVisible=!1;const s=this._options.customSelectionMeshGenerator?this._options.customSelectionMeshGenerator():Rs("gazeTracker",{diameter:.0035*3,thickness:.0025*3,tessellation:20},t);s.bakeCurrentTransformIntoVertices(),s.isPickable=!1,s.isVisible=!1;const n=new se("targetMat",t);return n.specularColor=ae.Black(),n.emissiveColor=this.selectionMeshDefaultColor,n.backFaceCulling=!1,s.material=n,this._options.renderingGroupId!==void 0&&(i.renderingGroupId=this._options.renderingGroupId,s.renderingGroupId=this._options.renderingGroupId),{laserPointer:i,selectionMesh:s}}_pickingMoved(e,t){var s;if(!e.hit||!t.hit||!e.pickedMesh||!e.pickedPoint||!t.pickedMesh||!t.pickedPoint||e.pickedMesh!==t.pickedMesh)return!0;(s=e.pickedPoint)==null||s.subtractToRef(t.pickedPoint,this._tmpVectorForPickCompare),this._tmpVectorForPickCompare.set(Math.abs(this._tmpVectorForPickCompare.x),Math.abs(this._tmpVectorForPickCompare.y),Math.abs(this._tmpVectorForPickCompare.z));const i=(this._options.gazeModePointerMovedFactor||1)*.01*t.distance;return this._tmpVectorForPickCompare.length()>i}_updatePointerDistance(e,t=100){e.scaling.y=t,this._scene.useRightHandedSystem&&(t*=-1),e.position.z=t/2+.05}_augmentPointerInit(e,t,i){e.pointerId=t,e.pointerType="xr",i&&(e.screenX=i.x,e.screenY=i.y)}get lasterPointerDefaultColor(){return this.laserPointerDefaultColor}}mr._IdCounter=200;mr.Name=St.POINTER_SELECTION;mr.Version=1;Yi.AddWebXRFeature(mr.Name,(a,e)=>()=>new mr(a,e),mr.Version,!0);var G;(function(a){a[a.Float=1]="Float",a[a.Int=2]="Int",a[a.Vector2=4]="Vector2",a[a.Vector3=8]="Vector3",a[a.Vector4=16]="Vector4",a[a.Color3=32]="Color3",a[a.Color4=64]="Color4",a[a.Matrix=128]="Matrix",a[a.Object=256]="Object",a[a.AutoDetect=1024]="AutoDetect",a[a.BasedOnInput=2048]="BasedOnInput",a[a.All=4095]="All"})(G||(G={}));var pe;(function(a){a[a.Vertex=1]="Vertex",a[a.Fragment=2]="Fragment",a[a.Neutral=4]="Neutral",a[a.VertexAndFragment=3]="VertexAndFragment"})(pe||(pe={}));class Ff{constructor(){this.supportUniformBuffers=!1,this.attributes=[],this.uniforms=[],this.constants=[],this.samplers=[],this.functions={},this.extensions={},this.prePassOutput={},this.counters={},this._terminalBlocks=new Set,this._attributeDeclaration="",this._uniformDeclaration="",this._constantDeclaration="",this._samplerDeclaration="",this._varyingTransfer="",this._injectAtEnd="",this._repeatableContentAnchorIndex=0,this._builtCompilationString="",this.compilationString=""}get shaderLanguage(){return this.sharedData.nodeMaterial.shaderLanguage}get fSuffix(){return this.shaderLanguage===1?"f":""}finalize(e){const t=e.sharedData.emitComments,i=this.target===pe.Fragment;this.shaderLanguage===1?i?this.compilationString=`
${t?`//Entry point
`:""}@fragment
fn main(input: FragmentInputs) -> FragmentOutputs {
${this.sharedData.varyingInitializationsFragment}${this.compilationString}`:this.compilationString=`
${t?`//Entry point
`:""}@vertex
fn main(input: VertexInputs) -> FragmentInputs{
${this.compilationString}`:this.compilationString=`
${t?`//Entry point
`:""}void main(void) {
${this.compilationString}`,this._constantDeclaration&&(this.compilationString=`
${t?`//Constants
`:""}${this._constantDeclaration}
${this.compilationString}`);let r="";for(const s in this.functions)r+=this.functions[s]+`
`;if(this.compilationString=`
${r}
${this.compilationString}`,!i&&this._varyingTransfer&&(this.compilationString=`${this.compilationString}
${this._varyingTransfer}`),this._injectAtEnd&&(this.compilationString=`${this.compilationString}
${this._injectAtEnd}`),this.compilationString=`${this.compilationString}
}`,this.sharedData.varyingDeclaration&&(this.compilationString=`
${t?`//Varyings
`:""}${i?this.sharedData.varyingDeclarationFragment:this.sharedData.varyingDeclaration}
${this.compilationString}`),this._samplerDeclaration&&(this.compilationString=`
${t?`//Samplers
`:""}${this._samplerDeclaration}
${this.compilationString}`),this._uniformDeclaration&&(this.compilationString=`
${t?`//Uniforms
`:""}${this._uniformDeclaration}
${this.compilationString}`),this._attributeDeclaration&&!i&&(this.compilationString=`
${t?`//Attributes
`:""}${this._attributeDeclaration}
${this.compilationString}`),this.shaderLanguage!==1){this.compilationString=`precision highp float;
`+this.compilationString,this.compilationString=`#if defined(WEBGL2) || defined(WEBGPU)
precision highp sampler2DArray;
#endif
`+this.compilationString,i&&(this.compilationString=`#if defined(PREPASS)\r
#extension GL_EXT_draw_buffers : require\r
layout(location = 0) out highp vec4 glFragData[SCENE_MRT_COUNT];\r
highp vec4 gl_FragColor;\r
#endif\r
`+this.compilationString);for(const s in this.extensions){const n=this.extensions[s];this.compilationString=`
${n}
${this.compilationString}`}}this._builtCompilationString=this.compilationString}get _repeatableContentAnchor(){return`###___ANCHOR${this._repeatableContentAnchorIndex++}___###`}_getFreeVariableName(e){return e=e.replace(/[^a-zA-Z_]+/g,""),this.sharedData.variableNames[e]===void 0?(this.sharedData.variableNames[e]=0,e==="output"||e==="texture"?e+this.sharedData.variableNames[e]:e):(this.sharedData.variableNames[e]++,e+this.sharedData.variableNames[e])}_getFreeDefineName(e){return this.sharedData.defineNames[e]===void 0?this.sharedData.defineNames[e]=0:this.sharedData.defineNames[e]++,e+this.sharedData.defineNames[e]}_excludeVariableName(e){this.sharedData.variableNames[e]=0}_emit2DSampler(e,t="",i=!1){(this.samplers.indexOf(e)<0||i)&&(t&&(this._samplerDeclaration+=`#if ${t}
`),this.shaderLanguage===1?(this._samplerDeclaration+=`var ${e+"Sampler"}: sampler;
`,this._samplerDeclaration+=`var ${e}: texture_2d<f32>;
`):this._samplerDeclaration+=`uniform sampler2D ${e};
`,t&&(this._samplerDeclaration+=`#endif
`),i||this.samplers.push(e))}_emitCubeSampler(e,t="",i=!1){(this.samplers.indexOf(e)<0||i)&&(t&&(this._samplerDeclaration+=`#if ${t}
`),this.shaderLanguage===1?(this._samplerDeclaration+=`var ${e+"Sampler"}: sampler;
`,this._samplerDeclaration+=`var ${e}: texture_cube<f32>;
`):this._samplerDeclaration+=`uniform samplerCube ${e};
`,t&&(this._samplerDeclaration+=`#endif
`),i||this.samplers.push(e))}_emit2DArraySampler(e){this.samplers.indexOf(e)<0&&(this._samplerDeclaration+=`uniform sampler2DArray ${e};
`,this.samplers.push(e))}_getGLType(e){switch(e){case G.Float:return"float";case G.Int:return"int";case G.Vector2:return"vec2";case G.Color3:case G.Vector3:return"vec3";case G.Color4:case G.Vector4:return"vec4";case G.Matrix:return"mat4"}return""}_getShaderType(e){const t=this.shaderLanguage===1;switch(e){case G.Float:return t?"f32":"float";case G.Int:return t?"i32":"int";case G.Vector2:return t?"vec2f":"vec2";case G.Color3:case G.Vector3:return t?"vec3f":"vec3";case G.Color4:case G.Vector4:return t?"vec4f":"vec4";case G.Matrix:return t?"mat4x4f":"mat4"}return""}_emitExtension(e,t,i=""){this.extensions[e]||(i&&(t=`#if ${i}
${t}
#endif`),this.extensions[e]=t)}_emitFunction(e,t,i){this.functions[e]||(this.sharedData.emitComments&&(t=i+`
`+t),this.functions[e]=t)}_emitCodeFromInclude(e,t,i){const r=C.GetIncludesShadersStore(this.shaderLanguage);if(i&&i.repeatKey)return`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]
`;let s=r[e]+`
`;if(this.sharedData.emitComments&&(s=t+`
`+s),!i)return s;if(i.replaceStrings)for(let n=0;n<i.replaceStrings.length;n++){const o=i.replaceStrings[n];s=s.replace(o.search,o.replace)}return s}_emitFunctionFromInclude(e,t,i,r=""){const s=e+r;if(this.functions[s])return;const n=C.GetIncludesShadersStore(this.shaderLanguage);if(!i||!i.removeAttributes&&!i.removeUniforms&&!i.removeVaryings&&!i.removeIfDef&&!i.replaceStrings){i&&i.repeatKey?this.functions[s]=`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]
`:this.functions[s]=`#include<${e}>${i!=null&&i.substitutionVars?"("+(i==null?void 0:i.substitutionVars)+")":""}
`,this.sharedData.emitComments&&(this.functions[s]=t+`
`+this.functions[s]);return}if(this.functions[s]=n[e],this.sharedData.emitComments&&(this.functions[s]=t+`
`+this.functions[s]),i.removeIfDef&&(this.functions[s]=this.functions[s].replace(/^\s*?#ifdef.+$/gm,""),this.functions[s]=this.functions[s].replace(/^\s*?#endif.*$/gm,""),this.functions[s]=this.functions[s].replace(/^\s*?#else.*$/gm,""),this.functions[s]=this.functions[s].replace(/^\s*?#elif.*$/gm,"")),i.removeAttributes&&(this.functions[s]=this.functions[s].replace(/\s*?attribute .+?;/g,`
`)),i.removeUniforms&&(this.functions[s]=this.functions[s].replace(/\s*?uniform .*?;/g,`
`)),i.removeVaryings&&(this.functions[s]=this.functions[s].replace(/\s*?(varying|in) .+?;/g,`
`)),i.replaceStrings)for(let o=0;o<i.replaceStrings.length;o++){const l=i.replaceStrings[o];this.functions[s]=this.functions[s].replace(l.search,l.replace)}}_registerTempVariable(e){return this.sharedData.temps.indexOf(e)!==-1?!1:(this.sharedData.temps.push(e),!0)}_emitVaryingFromString(e,t,i="",r=!1){if(this.sharedData.varyings.indexOf(e)!==-1)return!1;this.sharedData.varyings.push(e);const s=this._getShaderType(t),n=(o=!1)=>{let l="";if(i&&(i.startsWith("defined(")?l+=`#if ${i}
`:l+=`${r?"#ifndef":"#ifdef"} ${i}
`),this.shaderLanguage===1)switch(s){case"mat4x4f":l+=`varying ${e}_r0: vec4f;
`,l+=`varying ${e}_r1: vec4f;
`,l+=`varying ${e}_r2: vec4f;
`,l+=`varying ${e}_r3: vec4f;
`,o&&(l+=`var<private> ${e}: mat4x4f;
`,this.sharedData.varyingInitializationsFragment+=`${e} = mat4x4f(fragmentInputs.${e}_r0, fragmentInputs.${e}_r1, fragmentInputs.${e}_r2, fragmentInputs.${e}_r3);
`);break;default:l+=`varying ${e}: ${s};
`;break}else l+=`varying ${s} ${e};
`;return i&&(l+=`#endif
`),l};if(this.shaderLanguage===1)this.sharedData.varyingDeclaration+=n(!1),this.sharedData.varyingDeclarationFragment+=n(!0);else{const o=n();this.sharedData.varyingDeclaration+=o,this.sharedData.varyingDeclarationFragment+=o}return!0}_getVaryingName(e){return this.shaderLanguage===1?(this.target!==pe.Fragment?"vertexOutputs.":"fragmentInputs.")+e:e}_emitUniformFromString(e,t,i="",r=!1){if(this.uniforms.indexOf(e)!==-1)return;this.uniforms.push(e),i&&(i.startsWith("defined(")?this._uniformDeclaration+=`#if ${i}
`:this._uniformDeclaration+=`${r?"#ifndef":"#ifdef"} ${i}
`);const s=this._getShaderType(t);this.shaderLanguage===1?this._uniformDeclaration+=`uniform ${e}: ${s};
`:this._uniformDeclaration+=`uniform ${s} ${e};
`,i&&(this._uniformDeclaration+=`#endif
`)}_generateTernary(e,t,i){return this.shaderLanguage===1?`select(${t}, ${e}, ${i})`:`(${i}) ? ${e} : ${t}`}_emitFloat(e){return e.toString()===e.toFixed(0)?`${e}.0`:e.toString()}_declareOutput(e,t){return this._declareLocalVar(e.associatedVariableName,e.type,t)}_declareLocalVar(e,t,i){return this.shaderLanguage===1?`${i?"const":"var"} ${e}: ${this._getShaderType(t)}`:`${this._getShaderType(t)} ${e}`}_samplerCubeFunc(){return this.shaderLanguage===1?"textureSample":"textureCube"}_samplerFunc(){return this.shaderLanguage===1?"textureSample":"texture2D"}_samplerLODFunc(){return this.shaderLanguage===1?"textureSampleLevel":"texture2DLodEXT"}_toLinearSpace(e){return this.shaderLanguage===1?e.type===G.Color3||e.type===G.Vector3?`toLinearSpaceVec3(${e.associatedVariableName})`:`toLinearSpace(${e.associatedVariableName})`:`toLinearSpace(${e.associatedVariableName})`}_generateTextureSample(e,t){return this.shaderLanguage===1?`${this._samplerFunc()}(${t},${t+"Sampler"}, ${e})`:`${this._samplerFunc()}(${t}, ${e})`}_generateTextureSampleLOD(e,t,i){return this.shaderLanguage===1?`${this._samplerLODFunc()}(${t},${t+"Sampler"}, ${e}, ${i})`:`${this._samplerLODFunc()}(${t}, ${e}, ${i})`}_generateTextureSampleCube(e,t){return this.shaderLanguage===1?`${this._samplerCubeFunc()}(${t},${t+"Sampler"}, ${e})`:`${this._samplerCubeFunc()}(${t}, ${e})`}_generateTextureSampleCubeLOD(e,t,i){return this.shaderLanguage===1?`${this._samplerCubeFunc()}(${t},${t+"Sampler"}, ${e}, ${i})`:`${this._samplerCubeFunc()}(${t}, ${e}, ${i})`}_convertVariableDeclarationToWGSL(e,t,i){return i.replace(new RegExp(`(${e})\\s+(\\w+)`,"g"),`var $2: ${t}`)}_convertVariableConstructorsToWGSL(e,t,i){return i.replace(new RegExp(`(${e})\\(`,"g"),` ${t}(`)}_convertOutParametersToWGSL(e){return e.replace(new RegExp("out\\s+var\\s+(\\w+)\\s*:\\s*(\\w+)","g"),"$1: ptr<function, $2>")}_convertTernaryOperandsToWGSL(e){return e.replace(new RegExp("\\[(.*?)\\?(.*?):(.*)\\]","g"),(t,i,r,s)=>`select(${s}, ${r}, ${i})`)}_convertModOperatorsToWGSL(e){return e.replace(new RegExp("mod\\((.+?),\\s*(.+?)\\)","g"),(t,i,r)=>`((${i})%(${r}))`)}_convertConstToWGSL(e){return e.replace(new RegExp("const var","g"),"const")}_convertInnerFunctionsToWGSL(e){return e.replace(new RegExp("inversesqrt","g"),"inverseSqrt")}_convertFunctionsToWGSL(e){const t=/var\s+(\w+)\s*:\s*(\w+)\((.*)\)/g;let i;for(;(i=t.exec(e))!==null;){const r=i[1],s=i[2],o=i[3].replace(/var\s/g,"");e=e.replace(i[0],`fn ${r}(${o}) -> ${s}`)}return e}_babylonSLtoWGSL(e){return e=this._convertVariableDeclarationToWGSL("void","voidnull",e),e=this._convertVariableDeclarationToWGSL("bool","bool",e),e=this._convertVariableDeclarationToWGSL("int","i32",e),e=this._convertVariableDeclarationToWGSL("uint","u32",e),e=this._convertVariableDeclarationToWGSL("float","f32",e),e=this._convertVariableDeclarationToWGSL("vec2","vec2f",e),e=this._convertVariableDeclarationToWGSL("vec3","vec3f",e),e=this._convertVariableDeclarationToWGSL("vec4","vec4f",e),e=this._convertVariableDeclarationToWGSL("mat2","mat2x2f",e),e=this._convertVariableDeclarationToWGSL("mat3","mat3x3f",e),e=this._convertVariableDeclarationToWGSL("mat4","mat4x4f",e),e=this._convertVariableConstructorsToWGSL("float","f32",e),e=this._convertVariableConstructorsToWGSL("vec2","vec2f",e),e=this._convertVariableConstructorsToWGSL("vec3","vec3f",e),e=this._convertVariableConstructorsToWGSL("vec4","vec4f",e),e=this._convertVariableConstructorsToWGSL("mat2","mat2x2f",e),e=this._convertVariableConstructorsToWGSL("mat3","mat3x3f",e),e=this._convertVariableConstructorsToWGSL("mat4","mat4x4f",e),e=this._convertTernaryOperandsToWGSL(e),e=this._convertModOperatorsToWGSL(e),e=this._convertConstToWGSL(e),e=this._convertInnerFunctionsToWGSL(e),e=this._convertOutParametersToWGSL(e),e=e.replace(/\[\*\]/g,"*"),e=this._convertFunctionsToWGSL(e),e=e.replace(/\s->\svoidnull/g,""),e=e.replace(/dFdx/g,"dpdx"),e=e.replace(/dFdy/g,"dpdy"),e}_convertTernaryOperandsToGLSL(e){return e.replace(new RegExp("\\[(.+?)\\?(.+?):(.+)\\]","g"),(t,i,r,s)=>`${i} ? ${r} : ${s}`)}_babylonSLtoGLSL(e){return e=e.replace(/\[\*\]/g,""),e=this._convertTernaryOperandsToGLSL(e),e}}class JI{constructor(){this.temps=[],this.varyings=[],this.varyingDeclaration="",this.varyingDeclarationFragment="",this.varyingInitializationsFragment="",this.inputBlocks=[],this.textureBlocks=[],this.bindableBlocks=[],this.forcedBindableBlocks=[],this.blocksWithFallbacks=[],this.blocksWithDefines=[],this.repeatableContentBlocks=[],this.dynamicUniformBlocks=[],this.blockingBlocks=[],this.animatedInputs=[],this.variableNames={},this.defineNames={},this.hints={needWorldViewMatrix:!1,needWorldViewProjectionMatrix:!1,needAlphaBlending:!1,needAlphaTesting:!1},this.checks={emitVertex:!1,emitFragment:!1,notConnectedNonOptionalInputs:new Array},this.allowEmptyVertexProgram=!1,this.variableNames.position=0,this.variableNames.normal=0,this.variableNames.tangent=0,this.variableNames.uv=0,this.variableNames.uv2=0,this.variableNames.uv3=0,this.variableNames.uv4=0,this.variableNames.uv5=0,this.variableNames.uv6=0,this.variableNames.color=0,this.variableNames.matricesIndices=0,this.variableNames.matricesWeights=0,this.variableNames.matricesIndicesExtra=0,this.variableNames.matricesWeightsExtra=0,this.variableNames.diffuseBase=0,this.variableNames.specularBase=0,this.variableNames.worldPos=0,this.variableNames.shadow=0,this.variableNames.view=0,this.variableNames.vTBN=0,this.defineNames.MAINUV0=0,this.defineNames.MAINUV1=0,this.defineNames.MAINUV2=0,this.defineNames.MAINUV3=0,this.defineNames.MAINUV4=0,this.defineNames.MAINUV5=0,this.defineNames.MAINUV6=0,this.defineNames.MAINUV7=0}emitErrors(e=null){let t="";!this.checks.emitVertex&&!this.allowEmptyVertexProgram&&(t+=`NodeMaterial does not have a vertex output. You need to at least add a block that generates a position value.
`),this.checks.emitFragment||(t+=`NodeMaterial does not have a fragment output. You need to at least add a block that generates a color value.
`);for(const i of this.checks.notConnectedNonOptionalInputs)t+=`input ${i.name} from block ${i.ownerBlock.name}[${i.ownerBlock.getClassName()}] is not connected and is not optional.
`;return t?(e&&e.notifyObservers(t),B.Error(`Build of NodeMaterial failed:
`+t),!1):!0}}var wf;(function(a){a[a.Compatible=0]="Compatible",a[a.TypeIncompatible=1]="TypeIncompatible",a[a.TargetIncompatible=2]="TargetIncompatible",a[a.HierarchyIssue=3]="HierarchyIssue"})(wf||(wf={}));var Bf;(function(a){a[a.Input=0]="Input",a[a.Output=1]="Output"})(Bf||(Bf={}));class Ln{static AreEquivalentTypes(e,t){switch(e){case G.Vector3:{if(t===G.Color3)return!0;break}case G.Vector4:{if(t===G.Color4)return!0;break}case G.Color3:{if(t===G.Vector3)return!0;break}case G.Color4:{if(t===G.Vector4)return!0;break}}return!1}get _connectedPoint(){return this._connectedPointBackingField}set _connectedPoint(e){var t;this._connectedPointBackingField!==e&&((t=this._connectedPointTypeChangedObserver)==null||t.remove(),this._updateTypeDependentState(()=>this._connectedPointBackingField=e),this._connectedPointBackingField&&(this._connectedPointTypeChangedObserver=this._connectedPointBackingField.onTypeChangedObservable.add(()=>{this._notifyTypeChanged()})))}get _typeConnectionSource(){return this._typeConnectionSourceBackingField}set _typeConnectionSource(e){var t;this._typeConnectionSourceBackingField!==e&&((t=this._typeConnectionSourceTypeChangedObserver)==null||t.remove(),this._updateTypeDependentState(()=>this._typeConnectionSourceBackingField=e),this._typeConnectionSourceBackingField&&(this._typeConnectionSourceTypeChangedObserver=this._typeConnectionSourceBackingField.onTypeChangedObservable.add(()=>{this._notifyTypeChanged()})))}get _defaultConnectionPointType(){return this._defaultConnectionPointTypeBackingField}set _defaultConnectionPointType(e){this._updateTypeDependentState(()=>this._defaultConnectionPointTypeBackingField=e)}get _linkedConnectionSource(){return this._linkedConnectionSourceBackingField}set _linkedConnectionSource(e){var t;this._linkedConnectionSourceBackingField!==e&&((t=this._linkedConnectionSourceTypeChangedObserver)==null||t.remove(),this._updateTypeDependentState(()=>this._linkedConnectionSourceBackingField=e),this._isMainLinkSource=!1,this._linkedConnectionSourceBackingField&&(this._linkedConnectionSourceTypeChangedObserver=this._linkedConnectionSourceBackingField.onTypeChangedObservable.add(()=>{this._notifyTypeChanged()})))}get direction(){return this._direction}get declarationVariableName(){return this._ownerBlock.isInput?this._ownerBlock.declarationVariableName:(!this._enforceAssociatedVariableName||!this._associatedVariableName)&&this._connectedPoint?this._connectedPoint.declarationVariableName:this._associatedVariableName}get associatedVariableName(){return this._ownerBlock.isInput?this._ownerBlock.associatedVariableName:(!this._enforceAssociatedVariableName||!this._associatedVariableName)&&this._connectedPoint?this._connectedPoint.associatedVariableName:this._associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get innerType(){return this._linkedConnectionSource&&!this._isMainLinkSource&&this._linkedConnectionSource.isConnected?this.type:this._type}get type(){if(this._type===G.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource){if(this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.connectedPoint._redirectedSource&&this._linkedConnectionSource.connectedPoint._redirectedSource.isConnected?this._linkedConnectionSource.connectedPoint._redirectedSource.type:this._linkedConnectionSource.type;if(this._linkedConnectionSource._defaultConnectionPointType)return this._linkedConnectionSource._defaultConnectionPointType}if(this._defaultConnectionPointType)return this._defaultConnectionPointType}if(this._type===G.BasedOnInput){if(this._typeConnectionSource)return!this._typeConnectionSource.isConnected&&this._defaultConnectionPointType?this._defaultConnectionPointType:this._typeConnectionSource.type;if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._updateTypeDependentState(()=>this._type=e)}get target(){return!this._prioritizeVertex||!this._ownerBlock?this._target:this._target!==pe.VertexAndFragment?this._target:this._ownerBlock.target===pe.Fragment?pe.Fragment:pe.Vertex}set target(e){this._target=e}get isConnected(){return this.connectedPoint!==null||this.hasEndpoints}get isConnectedToInputBlock(){return this.connectedPoint!==null&&this.connectedPoint.ownerBlock.isInput}get connectInputBlock(){return this.isConnectedToInputBlock?this.connectedPoint.ownerBlock:null}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return this._endpoints.length===0?[]:this._endpoints.map(e=>e.ownerBlock)}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get isDirectlyConnectedToVertexOutput(){if(!this.hasEndpoints)return!1;for(const e of this._endpoints)if(e.ownerBlock.target===pe.Vertex||(e.ownerBlock.target===pe.Neutral||e.ownerBlock.target===pe.VertexAndFragment)&&e.ownerBlock.outputs.some(t=>t.isDirectlyConnectedToVertexOutput))return!0;return!1}get isConnectedInVertexShader(){if(this.target===pe.Vertex)return!0;if(!this.hasEndpoints)return!1;for(const e of this._endpoints)if(e.ownerBlock.target===pe.Vertex||e.target===pe.Vertex||(e.ownerBlock.target===pe.Neutral||e.ownerBlock.target===pe.VertexAndFragment)&&e.ownerBlock.outputs.some(t=>t.isConnectedInVertexShader))return!0;return!1}get isConnectedInFragmentShader(){if(this.target===pe.Fragment)return!0;if(!this.hasEndpoints)return!1;for(const e of this._endpoints)if(e.ownerBlock.target===pe.Fragment||(e.ownerBlock.target===pe.Neutral||e.ownerBlock.target===pe.VertexAndFragment)&&e.ownerBlock.isConnectedInFragmentShader())return!0;return!1}createCustomInputBlock(){return null}constructor(e,t,i){this._preventBubbleUp=!1,this._connectedPointBackingField=null,this._endpoints=new Array,this._redirectedSource=null,this._typeConnectionSourceBackingField=null,this._defaultConnectionPointTypeBackingField=null,this._isMainLinkSource=!1,this._linkedConnectionSourceBackingField=null,this._acceptedConnectionPointType=null,this._type=G.Float,this._enforceAssociatedVariableName=!1,this._forPostBuild=!1,this.needDualDirectionValidation=!1,this.acceptedConnectionPointTypes=[],this.excludedConnectionPointTypes=[],this.onConnectionObservable=new U,this.onDisconnectionObservable=new U,this.onTypeChangedObservable=new U,this._isTypeChangeObservableNotifying=!1,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this._prioritizeVertex=!1,this._target=pe.VertexAndFragment,this._ownerBlock=t,this.name=e,this._direction=i}getClassName(){return"NodeMaterialConnectionPoint"}canConnectTo(e){return this.checkCompatibilityState(e)===0}checkCompatibilityState(e){const t=this._ownerBlock,i=e.ownerBlock;if(t.target===pe.Fragment){if(i.target===pe.Vertex)return 2;for(const n of i.outputs)if(n.ownerBlock.target!=pe.Neutral&&n.isConnectedInVertexShader)return 2}if(this.type!==e.type&&e.innerType!==G.AutoDetect)return Ln.AreEquivalentTypes(this.type,e.type)||e.acceptedConnectionPointTypes&&e.acceptedConnectionPointTypes.indexOf(this.type)!==-1||e._acceptedConnectionPointType&&Ln.AreEquivalentTypes(e._acceptedConnectionPointType.type,this.type)?0:1;if(e.excludedConnectionPointTypes&&e.excludedConnectionPointTypes.indexOf(this.type)!==-1)return 1;let r=i,s=t;return this.direction===0&&(r=t,s=i),r.isAnAncestorOf(s)?3:0}connectTo(e,t=!1){if(!t&&!this.canConnectTo(e))throw"Cannot connect these two connectors.";return this._endpoints.push(e),e._connectedPoint=this,this._enforceAssociatedVariableName=!1,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){const t=this._endpoints.indexOf(e);return t===-1?this:(this._endpoints.splice(t,1),e._connectedPoint=null,this._enforceAssociatedVariableName=!1,e._enforceAssociatedVariableName=!1,this.onDisconnectionObservable.notifyObservers(e),e.onDisconnectionObservable.notifyObservers(this),this)}addExcludedConnectionPointFromAllowedTypes(e){let t=1;for(;t<G.All;)e&t||this.excludedConnectionPointTypes.push(t),t=t<<1}serialize(e=!0){const t={};return t.name=this.name,this.displayName&&(t.displayName=this.displayName),e&&this.connectedPoint&&(t.inputName=this.name,t.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,t.targetConnectionName=this.connectedPoint.name,t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),t}dispose(){this.onConnectionObservable.clear(),this.onDisconnectionObservable.clear(),this.onTypeChangedObservable.clear(),this._connectedPoint=null,this._typeConnectionSource=null,this._linkedConnectionSource=null}_updateTypeDependentState(e){const t=this.type;e(),this.type!==t&&this._notifyTypeChanged()}_notifyTypeChanged(){this._isTypeChangeObservableNotifying||(this._isTypeChangeObservableNotifying=!0,this.onTypeChangedObservable.notifyObservers(this.type),this._isTypeChangeObservableNotifying=!1)}}class Wi{get _isFinalOutputAndActive(){return this._isFinalOutput}get _hasPrecedence(){return!1}get name(){return this._name}get codeIsReady(){return this._codeIsReady}set name(e){this.validateBlockName(e)&&(this._name=e)}get isUnique(){return this._isUnique}get isFinalMerger(){return this._isFinalMerger}get isInput(){return this._isInput}get isTeleportOut(){return this._isTeleportOut}get isTeleportIn(){return this._isTeleportIn}get isLoop(){return this._isLoop}get buildId(){return this._buildId}set buildId(e){this._buildId=e}get target(){return this._target}set target(e){this._target&e||(this._target=e)}get inputs(){return this._inputs}get outputs(){return this._outputs}getInputByName(e){const t=this._inputs.filter(i=>i.name===e);return t.length?t[0]:null}getOutputByName(e){const t=this._outputs.filter(i=>i.name===e);return t.length?t[0]:null}constructor(e,t=pe.Vertex,i=!1,r=!1){switch(this._isFinalMerger=!1,this._isInput=!1,this._isLoop=!1,this._isTeleportOut=!1,this._isTeleportIn=!1,this._name="",this._isUnique=!1,this._codeIsReady=!0,this._isFinalOutput=!1,this.onCodeIsReadyObservable=new U,this.inputsAreExclusive=!1,this._codeVariableName="",this._inputs=new Array,this._outputs=new Array,this.comments="",this.visibleInInspector=!1,this.visibleOnFrame=!1,this._target=t,this._originalTargetIsNeutral=t===pe.Neutral,this._isFinalMerger=i,this._isFinalOutput=r,this.getClassName()){case"InputBlock":this._isInput=!0;break;case"NodeMaterialTeleportOutBlock":this._isTeleportOut=!0;break;case"NodeMaterialTeleportInBlock":this._isTeleportIn=!0;break;case"LoopBlock":this._isLoop=!0;break}this._name=e,this.uniqueId=Tc.UniqueId}_setInitialTarget(e){this._target=e,this._originalTargetIsNeutral=e===pe.Neutral}initialize(e){}bind(e,t,i,r){}_writeVariable(e){return e.connectedPoint?`${e.associatedVariableName}`:"0."}_writeFloat(e){let t=e.toString();return t.indexOf(".")===-1&&(t+=".0"),`${t}`}getClassName(){return"NodeMaterialBlock"}isConnectedInFragmentShader(){return this.outputs.some(e=>e.isConnectedInFragmentShader)}registerInput(e,t,i=!1,r,s){return s=s??new Ln(e,this,0),s.type=t,s.isOptional=i,r&&(s.target=r),this._inputs.push(s),this}registerOutput(e,t,i,r){return r=r??new Ln(e,this,1),r.type=t,i&&(r.target=i),this._outputs.push(r),this}getFirstAvailableInput(e=null){for(const t of this._inputs)if(!t.connectedPoint&&(!e||e.type===t.type||t.type===G.AutoDetect||t.acceptedConnectionPointTypes.indexOf(e.type)!==-1))return t;return null}getFirstAvailableOutput(e=null){for(const t of this._outputs)if(!e||!e.target||e.target===pe.Neutral||e.target&t.target)return t;return null}getSiblingOutput(e){const t=this._outputs.indexOf(e);return t===-1||t>=this._outputs.length?null:this._outputs[t+1]}isAnAncestorOf(e){for(const t of this._outputs)if(t.hasEndpoints){for(const i of t.endpoints)if(i.ownerBlock===e||i.ownerBlock.isAnAncestorOf(e))return!0}return!1}connectTo(e,t){if(this._outputs.length===0)return;let i=t&&t.output?this.getOutputByName(t.output):this.getFirstAvailableOutput(e),r=!0;for(;r;){const s=t&&t.input?e.getInputByName(t.input):e.getFirstAvailableInput(i);if(i&&s&&i.canConnectTo(s))i.connectTo(s),r=!1;else if(i)i=this.getSiblingOutput(i);else throw"Unable to find a compatible match"}return this}_buildBlock(e){}_postBuildBlock(e){}updateUniformsAndSamples(e,t,i,r){}provideFallbacks(e,t){}initializeDefines(e,t,i,r=!1){}prepareDefines(e,t,i,r=!1,s){}autoConfigure(e,t=()=>!0){}replaceRepeatableContent(e,t,i,r){}get willBeGeneratedIntoVertexShaderFromFragmentShader(){return this.isInput||this.isFinalMerger||this._outputs.some(e=>e.isDirectlyConnectedToVertexOutput)||this.target===pe.Vertex?!1:!!((this.target===pe.VertexAndFragment||this.target===pe.Neutral)&&this._outputs.some(e=>e.isConnectedInVertexShader))}isReady(e,t,i,r=!1){return!0}_linkConnectionTypes(e,t,i=!1){i?this._inputs[t]._acceptedConnectionPointType=this._inputs[e]:(this._inputs[e]._linkedConnectionSource=this._inputs[t],this._inputs[e]._isMainLinkSource=!0),this._inputs[t]._linkedConnectionSource=this._inputs[e]}_processBuild(e,t,i,r){e.build(t,r);const s=t._vertexState!=null,n=e._buildTarget===pe.Vertex&&e.target!==pe.VertexAndFragment;if(s&&(!(e.target&e._buildTarget)||!(e.target&i.target)||this.target!==pe.VertexAndFragment&&n)&&(!e.isInput&&t.target!==e._buildTarget||e.isInput&&e.isAttribute&&!e._noContextSwitch)){const o=i.connectedPoint;if(t._vertexState._emitVaryingFromString("v_"+o.declarationVariableName,o.type)){const c=t.shaderLanguage===1?"vertexOutputs.":"";t.shaderLanguage===1&&o.type===G.Matrix?(t._vertexState.compilationString+=`${c}${"v_"+o.declarationVariableName}_r0 = ${o.associatedVariableName}[0];
`,t._vertexState.compilationString+=`${c}${"v_"+o.declarationVariableName}_r1 = ${o.associatedVariableName}[1];
`,t._vertexState.compilationString+=`${c}${"v_"+o.declarationVariableName}_r2 = ${o.associatedVariableName}[2];
`,t._vertexState.compilationString+=`${c}${"v_"+o.declarationVariableName}_r3 = ${o.associatedVariableName}[3];
`):t._vertexState.compilationString+=`${c}${"v_"+o.declarationVariableName} = ${o.associatedVariableName};
`}const l=t.shaderLanguage===1&&o.type!==G.Matrix?"fragmentInputs.":"";i.associatedVariableName=l+"v_"+o.declarationVariableName,i._enforceAssociatedVariableName=!0}}validateBlockName(e){const t=["position","normal","tangent","particle_positionw","uv","uv2","uv3","uv4","uv5","uv6","position2d","particle_uv","matricesIndices","matricesWeights","world0","world1","world2","world3","particle_color","particle_texturemask"];for(const i of t)if(e===i)return!1;return!0}_customBuildStep(e,t){}build(e,t){if(this._buildId===e.sharedData.buildId)return!0;if(!this.isInput)for(const i of this._outputs)i.associatedVariableName||(i.associatedVariableName=e._getFreeVariableName(i.name));for(const i of this._inputs){if(!i.connectedPoint){i.isOptional||e.sharedData.checks.notConnectedNonOptionalInputs.push(i);continue}if(this.target!==pe.Neutral&&(!(i.target&this.target)||!(i.target&e.target)))continue;const r=i.connectedPoint.ownerBlock;r&&r!==this&&this._processBuild(r,e,i,t)}if(this._customBuildStep(e,t),this._buildId===e.sharedData.buildId)return!0;if(e.sharedData.verbose&&B.Log(`${e.target===pe.Vertex?"Vertex shader":"Fragment shader"}: Building ${this.name} [${this.getClassName()}]`),this.isFinalMerger)switch(e.target){case pe.Vertex:e.sharedData.checks.emitVertex=!0;break;case pe.Fragment:e.sharedData.checks.emitFragment=!0;break}!this.isInput&&e.sharedData.emitComments&&(e.compilationString+=`
//${this.name}
`),this._buildBlock(e),this._buildId=e.sharedData.buildId,this._buildTarget=e.target;for(const i of this._outputs)if(!i._forPostBuild&&i.target&e.target)for(const r of i.endpoints){const s=r.ownerBlock;s&&(s.target&e.target&&t.indexOf(s)!==-1||e._terminalBlocks.has(s))&&this._processBuild(s,e,r,t)}this._postBuildBlock(e);for(const i of this._outputs)if(i._forPostBuild&&i.target&e.target)for(const r of i.endpoints){const s=r.ownerBlock;s&&s.target&e.target&&t.indexOf(s)!==-1&&this._processBuild(s,e,r,t)}return!1}_inputRename(e){return e}_outputRename(e){return e}_dumpPropertiesCode(){const e=this._codeVariableName;return`${e}.visibleInInspector = ${this.visibleInInspector};
${e}.visibleOnFrame = ${this.visibleOnFrame};
${e}.target = ${this.target};
`}_dumpCode(e,t){t.push(this);const i=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=i||`${this.getClassName()}_${this.uniqueId}`,e.indexOf(this._codeVariableName)!==-1){let s=0;do s++,this._codeVariableName=i+s;while(e.indexOf(this._codeVariableName)!==-1)}e.push(this._codeVariableName);let r=`
// ${this.getClassName()}
`;this.comments&&(r+=`// ${this.comments}
`),r+=`var ${this._codeVariableName} = new BABYLON.${this.getClassName()}("${this.name}");
`,r+=this._dumpPropertiesCode();for(const s of this.inputs){if(!s.isConnected)continue;const o=s.connectedPoint.ownerBlock;t.indexOf(o)===-1&&(r+=o._dumpCode(e,t))}for(const s of this.outputs)if(s.hasEndpoints)for(const n of s.endpoints){const o=n.ownerBlock;o&&t.indexOf(o)===-1&&(r+=o._dumpCode(e,t))}return r}_dumpCodeForOutputConnections(e){let t="";if(e.indexOf(this)!==-1)return t;e.push(this);for(const i of this.inputs){if(!i.isConnected)continue;const r=i.connectedPoint,s=r.ownerBlock;t+=s._dumpCodeForOutputConnections(e),t+=`${s._codeVariableName}.${s._outputRename(r.name)}.connectTo(${this._codeVariableName}.${this._inputRename(i.name)});
`}return t}clone(e,t=""){const i=this.serialize(),r=Ui(i.customType);if(r){const s=new r;return s._deserialize(i,e,t),s}return null}serialize(){const e={};e.customType="BABYLON."+this.getClassName(),e.id=this.uniqueId,e.name=this.name,e.comments=this.comments,e.visibleInInspector=this.visibleInInspector,e.visibleOnFrame=this.visibleOnFrame,e.target=this.target,e.inputs=[],e.outputs=[];for(const t of this.inputs)e.inputs.push(t.serialize());for(const t of this.outputs)e.outputs.push(t.serialize(!1));return e}_deserialize(e,t,i,r){this.name=e.name,this.comments=e.comments,this.visibleInInspector=!!e.visibleInInspector,this.visibleOnFrame=!!e.visibleOnFrame,this._target=e.target??this.target,this._deserializePortDisplayNamesAndExposedOnFrame(e)}_deserializePortDisplayNamesAndExposedOnFrame(e){const t=e.inputs,i=e.outputs;t&&t.forEach((r,s)=>{r.displayName&&(this.inputs[s].displayName=r.displayName),r.isExposedOnFrame&&(this.inputs[s].isExposedOnFrame=r.isExposedOnFrame,this.inputs[s].exposedPortPosition=r.exposedPortPosition)}),i&&i.forEach((r,s)=>{r.displayName&&(this.outputs[s].displayName=r.displayName),r.isExposedOnFrame&&(this.outputs[s].isExposedOnFrame=r.isExposedOnFrame,this.outputs[s].exposedPortPosition=r.exposedPortPosition)})}dispose(){this.onCodeIsReadyObservable.clear();for(const e of this.inputs)e.dispose();for(const e of this.outputs)e.dispose()}}var Uf;(function(a){a[a.Boolean=0]="Boolean",a[a.Float=1]="Float",a[a.Int=2]="Int",a[a.Vector2=3]="Vector2",a[a.List=4]="List",a[a.Color4=5]="Color4",a[a.SamplingMode=6]="SamplingMode",a[a.TextureFormat=7]="TextureFormat",a[a.TextureType=8]="TextureType"})(Uf||(Uf={}));function on(a,e=0,t="PROPERTIES",i){return(r,s)=>{let n=r._propStore;n||(n=[],r._propStore=n),n.push({propertyName:s,displayName:a,type:e,groupName:t,options:i??{},className:r.getClassName()})}}class xa extends Wi{get transformAsDirection(){return this.complementW===0}set transformAsDirection(e){this.complementW=e?0:1}constructor(e){super(e,pe.Neutral),this.complementW=1,this.complementZ=0,this.target=pe.Vertex,this.registerInput("vector",G.AutoDetect),this.registerInput("transform",G.Matrix),this.registerOutput("output",G.Vector4),this.registerOutput("xyz",G.Vector3),this._inputs[0].onConnectionObservable.add(t=>{if(t.ownerBlock.isInput){const i=t.ownerBlock;(i.name==="normal"||i.name==="tangent")&&(this.complementW=0)}})}getClassName(){return"TransformBlock"}get vector(){return this._inputs[0]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}get transform(){return this._inputs[1]}_buildBlock(e){super._buildBlock(e);const t=this.vector,i=this.transform,r=e._getShaderType(G.Vector4),s=e._getShaderType(G.Vector3);if(t.connectedPoint){if(this.complementW===0||this.transformAsDirection){const n=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",n),e.sharedData.blocksWithDefines.push(this);const o=e._getFreeVariableName(`${i.associatedVariableName}_NUS`);switch(e.shaderLanguage===1?e.compilationString+=`var ${o}: mat3x3f = mat3x3f(${i.associatedVariableName}[0].xyz, ${i.associatedVariableName}[1].xyz, ${i.associatedVariableName}[2].xyz);
`:e.compilationString+=`mat3 ${o} = mat3(${i.associatedVariableName});
`,e.compilationString+=`#ifdef NONUNIFORMSCALING
`,e.compilationString+=`${o} = transposeMat3(inverseMat3(${o}));
`,e.compilationString+=`#endif
`,t.connectedPoint.type){case G.Vector2:e.compilationString+=e._declareOutput(this.output)+` = ${r}(${o} * ${s}(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}), ${this._writeFloat(this.complementW)});
`;break;case G.Vector3:case G.Color3:e.compilationString+=e._declareOutput(this.output)+` = ${r}(${o} * ${t.associatedVariableName}, ${this._writeFloat(this.complementW)});
`;break;default:e.compilationString+=e._declareOutput(this.output)+` = ${r}(${o} * ${t.associatedVariableName}.xyz, ${this._writeFloat(this.complementW)});
`;break}}else{const n=i.associatedVariableName;switch(t.connectedPoint.type){case G.Vector2:e.compilationString+=e._declareOutput(this.output)+` = ${n} * ${r}(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}, ${this._writeFloat(this.complementW)});
`;break;case G.Vector3:case G.Color3:e.compilationString+=e._declareOutput(this.output)+` = ${n} * ${r}(${t.associatedVariableName}, ${this._writeFloat(this.complementW)});
`;break;default:e.compilationString+=e._declareOutput(this.output)+` = ${n} * ${t.associatedVariableName};
`;break}}this.xyz.hasEndpoints&&(e.compilationString+=e._declareOutput(this.xyz)+` = ${this.output.associatedVariableName}.xyz;
`)}return this}prepareDefines(e,t,i){e.nonUniformScaling&&i.setValue("NONUNIFORMSCALING",!0)}serialize(){const e=super.serialize();return e.complementZ=this.complementZ,e.complementW=this.complementW,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.complementZ=e.complementZ!==void 0?e.complementZ:0,this.complementW=e.complementW!==void 0?e.complementW:1}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.complementZ = ${this.complementZ};
`;return e+=`${this._codeVariableName}.complementW = ${this.complementW};
`,e}}A([on("Transform as direction",0,void 0,{embedded:!0})],xa.prototype,"transformAsDirection",null);Y("BABYLON.TransformBlock",xa);class _a extends Wi{constructor(e){super(e,pe.Vertex,!0),this.registerInput("vector",G.Vector4)}getClassName(){return"VertexOutputBlock"}get vector(){return this._inputs[0]}_isLogarithmicDepthEnabled(e,t){if(t)return!0;for(const i of e)if(i.useLogarithmicDepth)return!0;return!1}_buildBlock(e){super._buildBlock(e);const t=this.vector,i=e.shaderLanguage===1;if(e.shaderLanguage===1?e.compilationString+=`vertexOutputs.position = ${t.associatedVariableName};
`:e.compilationString+=`gl_Position = ${t.associatedVariableName};
`,this._isLogarithmicDepthEnabled(e.sharedData.fragmentOutputNodes,e.sharedData.nodeMaterial.useLogarithmicDepth)){e._emitUniformFromString("logarithmicDepthConstant",G.Float),e._emitVaryingFromString("vFragmentDepth",G.Float);const r=i?"vertexOutputs.vFragmentDepth":"vFragmentDepth",s=i?"uniforms.":"",n=i?"vertexOutputs.position":"gl_Position";e.compilationString+=`${r} = 1.0 + ${n}.w;
`,e.compilationString+=`${n}.z = log2(max(0.000001, ${r})) * ${s}logarithmicDepthConstant;
`}return this}}Y("BABYLON.VertexOutputBlock",_a);var fr;(function(a){a[a.NoColorSpace=0]="NoColorSpace",a[a.Gamma=1]="Gamma",a[a.Linear=2]="Linear"})(fr||(fr={}));class ps extends Wi{constructor(e){super(e,pe.Fragment,!0,!0),this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this.useLogarithmicDepth=!1,this.registerInput("rgba",G.Color4,!0),this.registerInput("rgb",G.Color3,!0),this.registerInput("a",G.Float,!0),this.registerInput("glow",G.Color3,!0),this.rgb.acceptedConnectionPointTypes.push(G.Vector3),this.rgb.acceptedConnectionPointTypes.push(G.Float),this.additionalColor.acceptedConnectionPointTypes.push(G.Vector3),this.additionalColor.acceptedConnectionPointTypes.push(G.Float)}get colorSpace(){return this.convertToGammaSpace?fr.Gamma:this.convertToLinearSpace?fr.Linear:fr.NoColorSpace}set colorSpace(e){this.convertToGammaSpace=e===fr.Gamma,this.convertToLinearSpace=e===fr.Linear}getClassName(){return"FragmentOutputBlock"}initialize(e){e._excludeVariableName("logarithmicDepthConstant"),e._excludeVariableName("vFragmentDepth")}get rgba(){return this._inputs[0]}get rgb(){return this._inputs[1]}get a(){return this._inputs[2]}get additionalColor(){return this._inputs[3]}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToLinearSpace,!0),i.setValue(this._gammaDefineName,this.convertToGammaSpace,!0),i.setValue(this._additionalColorDefineName,this.additionalColor.connectedPoint&&t._useAdditionalColor,!0)}bind(e,t,i){(this.useLogarithmicDepth||t.useLogarithmicDepth)&&i&&Bn(void 0,e,i.getScene())}_buildBlock(e){super._buildBlock(e);const t=this.rgba,i=this.rgb,r=this.a,s=this.additionalColor,n=e.shaderLanguage===1;e.sharedData.hints.needAlphaBlending=t.isConnected||r.isConnected,e.sharedData.blocksWithDefines.push(this),(this.useLogarithmicDepth||e.sharedData.nodeMaterial.useLogarithmicDepth)&&(e._emitUniformFromString("logarithmicDepthConstant",G.Float),e._emitVaryingFromString("vFragmentDepth",G.Float),e.sharedData.bindableBlocks.push(this)),s.connectedPoint&&(e._excludeVariableName("useAdditionalColor"),e._emitUniformFromString("useAdditionalColor",G.Float),this._additionalColorDefineName=e._getFreeDefineName("USEADDITIONALCOLOR")),this._linearDefineName=e._getFreeDefineName("CONVERTTOLINEAR"),this._gammaDefineName=e._getFreeDefineName("CONVERTTOGAMMA");const o=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",o);let l="gl_FragColor";e.shaderLanguage===1&&(e.compilationString+=`var fragmentOutputsColor : vec4<f32>;\r
`,l="fragmentOutputsColor");const c=e._getShaderType(G.Vector4);if(s.connectedPoint){let h="1.0";r.connectedPoint&&(h=r.associatedVariableName),e.compilationString+=`#ifdef ${this._additionalColorDefineName}
`,s.connectedPoint.type===G.Float?e.compilationString+=`${l}  = ${c}(${s.associatedVariableName}, ${s.associatedVariableName}, ${s.associatedVariableName}, ${h});
`:e.compilationString+=`${l}  = ${c}(${s.associatedVariableName}, ${h});
`,e.compilationString+=`#else
`}if(t.connectedPoint)r.isConnected?e.compilationString+=`${l} = ${c}(${t.associatedVariableName}.rgb, ${r.associatedVariableName});
`:e.compilationString+=`${l}  = ${t.associatedVariableName};
`;else if(i.connectedPoint){let h="1.0";r.connectedPoint&&(h=r.associatedVariableName),i.connectedPoint.type===G.Float?e.compilationString+=`${l}  = ${c}(${i.associatedVariableName}, ${i.associatedVariableName}, ${i.associatedVariableName}, ${h});
`:e.compilationString+=`${l}  = ${c}(${i.associatedVariableName}, ${h});
`}else e.sharedData.checks.notConnectedNonOptionalInputs.push(t);if(s.connectedPoint&&(e.compilationString+=`#endif
`),e.compilationString+=`#ifdef ${this._linearDefineName}
`,e.compilationString+=`${l}  = toLinearSpace(${l});
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef ${this._gammaDefineName}
`,e.compilationString+=`${l}  = toGammaSpace(${l});
`,e.compilationString+=`#endif
`,e.shaderLanguage===1&&(e.compilationString+=`#if !defined(PREPASS)\r
`,e.compilationString+=`fragmentOutputs.color = fragmentOutputsColor;\r
`,e.compilationString+=`#endif\r
`),this.useLogarithmicDepth||e.sharedData.nodeMaterial.useLogarithmicDepth){const h=n?"input.vFragmentDepth":"vFragmentDepth",f=n?"uniforms.":"",u=n?"fragmentOutputs.fragDepth":"gl_FragDepthEXT";e.compilationString+=`${u} = log2(${h}) * ${f}logarithmicDepthConstant * 0.5;
`}return e.compilationString+=`#if defined(PREPASS)\r
`,e.compilationString+=`${n?"fragmentOutputs.fragData0":"gl_FragData[0]"} = ${l};\r
`,e.compilationString+=`#endif\r
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};
`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};
`,e+=`${this._codeVariableName}.useLogarithmicDepth = ${this.useLogarithmicDepth};
`,e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.useLogarithmicDepth=this.useLogarithmicDepth,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this.useLogarithmicDepth=e.useLogarithmicDepth??!1}}A([on("Use logarithmic depth",0,"PROPERTIES",{embedded:!0})],ps.prototype,"useLogarithmicDepth",void 0);A([on("Color space",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"No color space",value:fr.NoColorSpace},{label:"Gamma",value:fr.Gamma},{label:"Linear",value:fr.Linear}]})],ps.prototype,"colorSpace",null);Y("BABYLON.FragmentOutputBlock",ps);var pt;(function(a){a[a.World=1]="World",a[a.View=2]="View",a[a.Projection=3]="Projection",a[a.ViewProjection=4]="ViewProjection",a[a.WorldView=5]="WorldView",a[a.WorldViewProjection=6]="WorldViewProjection",a[a.CameraPosition=7]="CameraPosition",a[a.FogColor=8]="FogColor",a[a.DeltaTime=9]="DeltaTime",a[a.CameraParameters=10]="CameraParameters",a[a.MaterialAlpha=11]="MaterialAlpha"})(pt||(pt={}));var yr;(function(a){a[a.None=0]="None",a[a.Time=1]="Time",a[a.RealTime=2]="RealTime",a[a.MouseInfo=3]="MouseInfo"})(yr||(yr={}));const eb={position2d:"position",particle_uv:"vUV",particle_color:"vColor",particle_texturemask:"textureMask",particle_positionw:"vPositionW"},Yo={particle_uv:!0,particle_color:!0,particle_texturemask:!0,particle_positionw:!0},Vf={particle_texturemask:!0},Gf={normal:"NORMAL",tangent:"TANGENT",uv:"UV1",uv2:"UV2",uv3:"UV3",uv4:"UV4",uv5:"UV5",uv6:"UV6",uv7:"UV7",uv8:"UV8"};class pi extends Wi{get type(){if(this._type===G.AutoDetect){if(this.isUniform&&this.value!=null){if(!isNaN(this.value))return this._type=G.Float,this._type;switch(this.value.getClassName()){case"Vector2":return this._type=G.Vector2,this._type;case"Vector3":return this._type=G.Vector3,this._type;case"Vector4":return this._type=G.Vector4,this._type;case"Color3":return this._type=G.Color3,this._type;case"Color4":return this._type=G.Color4,this._type;case"Matrix":return this._type=G.Matrix,this._type}}if(this.isAttribute)switch(this.name){case"splatIndex":return this._type=G.Float,this._type;case"position":case"normal":case"particle_positionw":case"splatPosition":return this._type=G.Vector3,this._type;case"uv":case"uv2":case"uv3":case"uv4":case"uv5":case"uv6":case"position2d":case"particle_uv":case"splatScale":return this._type=G.Vector2,this._type;case"matricesIndices":case"matricesWeights":case"matricesIndicesExtra":case"matricesWeightsExtra":case"world0":case"world1":case"world2":case"world3":case"tangent":return this._type=G.Vector4,this._type;case"color":case"instanceColor":case"particle_color":case"particle_texturemask":case"splatColor":return this._type=G.Color4,this._type}if(this.isSystemValue)switch(this._systemValue){case pt.World:case pt.WorldView:case pt.WorldViewProjection:case pt.View:case pt.ViewProjection:case pt.Projection:return this._type=G.Matrix,this._type;case pt.CameraPosition:return this._type=G.Vector3,this._type;case pt.FogColor:return this._type=G.Color3,this._type;case pt.DeltaTime:case pt.MaterialAlpha:return this._type=G.Float,this._type;case pt.CameraParameters:return this._type=G.Vector4,this._type}}return this._type}constructor(e,t=pe.Vertex,i=G.AutoDetect){super(e,t,!1),this._mode=3,this._animationType=yr.None,this._prefix="",this.min=0,this.max=0,this.isBoolean=!1,this.matrixMode=0,this._systemValue=null,this.isConstant=!1,this.groupInInspector="",this.onValueChangedObservable=new U,this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._type=i,this.setDefaultValue(),this.registerOutput("output",i)}validateBlockName(e){return this.isAttribute?!0:super.validateBlockName(e)}get output(){return this._outputs[0]}setAsAttribute(e){return this._mode=1,e&&(this.name=e),this}setAsSystemValue(e){return this.systemValue=e,this}get value(){return this._storedValue}set value(e){this.type===G.Float&&(this.isBoolean?e=e?1:0:this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e))),this._storedValue=e,this._mode=0,this.onValueChangedObservable.notifyObservers(this)}get valueCallback(){return this._valueCallback}set valueCallback(e){this._valueCallback=e,this._mode=0}get declarationVariableName(){return this._associatedVariableName}get associatedVariableName(){return this._prefix+this._associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get animationType(){return this._animationType}set animationType(e){this._animationType=e}get isUndefined(){return this._mode===3}get isUniform(){return this._mode===0}set isUniform(e){this._mode=e?0:3,this.associatedVariableName=""}get isAttribute(){return this._mode===1}set isAttribute(e){this._mode=e?1:3,this.associatedVariableName=""}get isVarying(){return this._mode===2}set isVarying(e){this._mode=e?2:3,this.associatedVariableName=""}get isSystemValue(){return this._systemValue!=null}get systemValue(){return this._systemValue}set systemValue(e){this._mode=0,this.associatedVariableName="",this._systemValue=e}getClassName(){return"InputBlock"}animate(e){switch(this._animationType){case yr.Time:{this.type===G.Float&&(this.value+=e.getAnimationRatio()*.01);break}case yr.RealTime:{this.type===G.Float&&(this.value=(Ti.Now-e.getEngine().startTime)/1e3);break}case yr.MouseInfo:{if(this.type===G.Vector4){const t=e._inputManager._originMouseEvent;if(t){const i=t.offsetX,r=t.offsetY,s=t.buttons&1?1:0,n=t.buttons&2?1:0;this.value=new Fe(i,r,s,n)}else this.value=new Fe(0,0,0,0)}break}}}_emitDefine(e){return e[0]==="!"?`#ifndef ${e.substring(1)}
`:`#ifdef ${e}
`}initialize(){this.associatedVariableName=""}setDefaultValue(){switch(this.type){case G.Float:this.value=0;break;case G.Vector2:this.value=ne.Zero();break;case G.Vector3:this.value=m.Zero();break;case G.Vector4:this.value=Fe.Zero();break;case G.Color3:this.value=ae.White();break;case G.Color4:this.value=new Ne(1,1,1,1);break;case G.Matrix:this.value=P.Identity();break}}_emitConstant(e){switch(this.type){case G.Float:return`${e._emitFloat(this.value)}`;case G.Vector2:return`vec2(${this.value.x}, ${this.value.y})`;case G.Vector3:return`vec3(${this.value.x}, ${this.value.y}, ${this.value.z})`;case G.Vector4:return`vec4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;case G.Color3:return tt.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&tt.Color3[0].toGammaSpaceToRef(tt.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&tt.Color3[0].toLinearSpaceToRef(tt.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec3(${tt.Color3[0].r}, ${tt.Color3[0].g}, ${tt.Color3[0].b})`;case G.Color4:return tt.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&tt.Color4[0].toGammaSpaceToRef(tt.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&tt.Color4[0].toLinearSpaceToRef(tt.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec4(${tt.Color4[0].r}, ${tt.Color4[0].g}, ${tt.Color4[0].b}, ${tt.Color4[0].a})`}return""}get _noContextSwitch(){return Yo[this.name]}_emit(e,t){if(this.isUniform){if(this._associatedVariableName||(this._associatedVariableName=e._getFreeVariableName("u_"+this.name)),this.isConstant){if(e.constants.indexOf(this.associatedVariableName)!==-1)return;e.constants.push(this.associatedVariableName),e._constantDeclaration+=e._declareOutput(this.output,!0)+` = ${this._emitConstant(e)};
`;return}if(e.uniforms.indexOf(this.associatedVariableName)!==-1)return;e.uniforms.push(this.associatedVariableName),t&&(e._uniformDeclaration+=this._emitDefine(t));const i=e._getShaderType(this.type);e.shaderLanguage===1?(e._uniformDeclaration+=`uniform ${this._associatedVariableName}: ${i};
`,this._prefix="uniforms."):e._uniformDeclaration+=`uniform ${i} ${this.associatedVariableName};
`,t&&(e._uniformDeclaration+=`#endif
`);const r=e.sharedData.hints;if(this._systemValue!==null&&this._systemValue!==void 0)switch(this._systemValue){case pt.WorldView:r.needWorldViewMatrix=!0;break;case pt.WorldViewProjection:r.needWorldViewProjectionMatrix=!0;break}else this._animationType!==yr.None&&e.sharedData.animatedInputs.push(this);return}if(this.isAttribute){if(this.associatedVariableName=eb[this.name]??this.name,this.target===pe.Vertex&&e._vertexState){Yo[this.name]?Vf[this.name]?(e._emitUniformFromString(this.declarationVariableName,this.type,t),e.shaderLanguage===1&&(this._prefix="vertexInputs.")):e._emitVaryingFromString(this.declarationVariableName,this.type,t):this._emit(e._vertexState,t);return}const i=e.attributes.indexOf(this.declarationVariableName)!==-1;if(i||e.attributes.push(this.declarationVariableName),Yo[this.name])Vf[this.name]?(i||e._emitUniformFromString(this.declarationVariableName,this.type,t),e.shaderLanguage===1&&(this._prefix="uniforms.")):(i||e._emitVaryingFromString(this.declarationVariableName,this.type,t),e.shaderLanguage===1&&(this._prefix="fragmentInputs."));else{if(t&&!i&&(e._attributeDeclaration+=this._emitDefine(t)),e.shaderLanguage===1){if(!i){const r=Gf[this.name];r?(e._attributeDeclaration+=`#ifdef ${r}
`,e._attributeDeclaration+=`attribute ${this.declarationVariableName}: ${e._getShaderType(this.type)};
`,e._attributeDeclaration+=`#else
`,e._attributeDeclaration+=`var<private> ${this.declarationVariableName}: ${e._getShaderType(this.type)} = ${e._getShaderType(this.type)}(0.);
`,e._attributeDeclaration+=`#endif
`):e._attributeDeclaration+=`attribute ${this.declarationVariableName}: ${e._getShaderType(this.type)};
`}this._prefix="vertexInputs."}else if(!i){const r=Gf[this.name];r?(e._attributeDeclaration+=`#ifdef ${r}
`,e._attributeDeclaration+=`attribute ${e._getShaderType(this.type)} ${this.declarationVariableName};
`,e._attributeDeclaration+=`#else
`,e._attributeDeclaration+=`${e._getShaderType(this.type)} ${this.declarationVariableName} = ${e._getShaderType(this.type)}(0.);
`,e._attributeDeclaration+=`#endif
`):e._attributeDeclaration+=`attribute ${e._getShaderType(this.type)} ${this.declarationVariableName};
`}t&&!i&&(e._attributeDeclaration+=`#endif
`)}}}_transmitWorld(e,t,i,r){if(!this._systemValue)return;const s=this._associatedVariableName;switch(this._systemValue){case pt.World:e.setMatrix(s,t);break;case pt.WorldView:e.setMatrix(s,i);break;case pt.WorldViewProjection:e.setMatrix(s,r);break}}_transmit(e,t,i){if(this.isAttribute)return;const r=this._associatedVariableName;if(this._systemValue){switch(this._systemValue){case pt.World:case pt.WorldView:case pt.WorldViewProjection:return;case pt.View:e.setMatrix(r,t.getViewMatrix());break;case pt.Projection:e.setMatrix(r,t.getProjectionMatrix());break;case pt.ViewProjection:e.setMatrix(r,t.getTransformMatrix());break;case pt.CameraPosition:t.bindEyePosition(e,r,!0);break;case pt.FogColor:e.setColor3(r,t.fogColor);break;case pt.DeltaTime:e.setFloat(r,t.deltaTime/1e3);break;case pt.CameraParameters:t.activeCamera&&e.setFloat4(r,t.getEngine().hasOriginBottomLeft?-1:1,t.activeCamera.minZ,t.activeCamera.maxZ,1/t.activeCamera.maxZ);break;case pt.MaterialAlpha:e.setFloat(r,i.alpha);break}return}const s=this._valueCallback?this._valueCallback():this._storedValue;if(s!==null)switch(this.type){case G.Float:e.setFloat(r,s);break;case G.Int:e.setInt(r,s);break;case G.Color3:tt.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&tt.Color3[0].toGammaSpaceToRef(tt.Color3[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&tt.Color3[0].toLinearSpaceToRef(tt.Color3[0],t.getEngine().useExactSrgbConversions),e.setColor3(r,tt.Color3[0]);break;case G.Color4:tt.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&tt.Color4[0].toGammaSpaceToRef(tt.Color4[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&tt.Color4[0].toLinearSpaceToRef(tt.Color4[0],t.getEngine().useExactSrgbConversions),e.setDirectColor4(r,tt.Color4[0]);break;case G.Vector2:e.setVector2(r,s);break;case G.Vector3:e.setVector3(r,s);break;case G.Vector4:e.setVector4(r,s);break;case G.Matrix:e.setMatrix(r,s);break}}_buildBlock(e){super._buildBlock(e),(this.isUniform||this.isSystemValue)&&e.sharedData.inputBlocks.push(this),this._emit(e)}_dumpPropertiesCode(){const e=this._codeVariableName;if(this.isAttribute)return super._dumpPropertiesCode()+`${e}.setAsAttribute("${this.name}");
`;if(this.isSystemValue)return super._dumpPropertiesCode()+`${e}.setAsSystemValue(BABYLON.NodeMaterialSystemValues.${pt[this._systemValue]});
`;if(this.isUniform){const t=[];let i="";switch(this.type){case G.Float:i=`${this.value}`;break;case G.Vector2:i=`new BABYLON.Vector2(${this.value.x}, ${this.value.y})`;break;case G.Vector3:i=`new BABYLON.Vector3(${this.value.x}, ${this.value.y}, ${this.value.z})`;break;case G.Vector4:i=`new BABYLON.Vector4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;break;case G.Color3:i=`new BABYLON.Color3(${this.value.r}, ${this.value.g}, ${this.value.b})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case G.Color4:i=`new BABYLON.Color4(${this.value.r}, ${this.value.g}, ${this.value.b}, ${this.value.a})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case G.Matrix:i=`BABYLON.Matrix.FromArray([${this.value.m}])`;break}return t.push(`${e}.value = ${i}`),this.type===G.Float&&t.push(`${e}.min = ${this.min}`,`${e}.max = ${this.max}`,`${e}.isBoolean = ${this.isBoolean}`,`${e}.matrixMode = ${this.matrixMode}`,`${e}.animationType = BABYLON.AnimatedInputBlockTypes.${yr[this.animationType]}`),t.push(`${e}.isConstant = ${this.isConstant}`),t.push(""),super._dumpPropertiesCode()+t.join(`;
`)}return super._dumpPropertiesCode()}dispose(){this.onValueChangedObservable.clear(),super.dispose()}serialize(){const e=super.serialize();return e.type=this.type,e.mode=this._mode,e.systemValue=this._systemValue,e.animationType=this._animationType,e.min=this.min,e.max=this.max,e.isBoolean=this.isBoolean,e.matrixMode=this.matrixMode,e.isConstant=this.isConstant,e.groupInInspector=this.groupInInspector,e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this._storedValue!=null&&this._mode===0&&(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e}_deserialize(e,t,i){if(this._mode=e.mode,super._deserialize(e,t,i),this._type=e.type,this._systemValue=e.systemValue||e.wellKnownValue,this._animationType=e.animationType,this.min=e.min||0,this.max=e.max||0,this.isBoolean=!!e.isBoolean,this.matrixMode=e.matrixMode||0,this.isConstant=!!e.isConstant,this.groupInInspector=e.groupInInspector||"",this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.name==="tangent"&&e.mode===1&&e.type===G.Vector3&&(this._type=G.Vector4),!!e.valueType)if(e.valueType==="number")this._storedValue=e.value;else{const r=Ui(e.valueType);r&&(this._storedValue=r.FromArray(e.value))}}}Y("BABYLON.InputBlock",pi);class Fg extends Wi{constructor(e){super(e,pe.VertexAndFragment),this._samplerName="textureSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",G.AutoDetect,!1,pe.VertexAndFragment),this.registerOutput("rgba",G.Color4,pe.Neutral),this.registerOutput("rgb",G.Color3,pe.Neutral),this.registerOutput("r",G.Float,pe.Neutral),this.registerOutput("g",G.Float,pe.Neutral),this.registerOutput("b",G.Float,pe.Neutral),this.registerOutput("a",G.Float,pe.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(G.Vector2|G.Vector3|G.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"CurrentScreenBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName(this._samplerName)}get target(){return!this.uv.isConnected||this.uv.sourceBlock.isInput?pe.VertexAndFragment:pe.Fragment}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_injectVertexCode(e){const t=this.uv;if(t.connectedPoint.ownerBlock.isInput&&(t.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(t.associatedVariableName,G.Vector2)),this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,G.Vector2),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;
`,!!this._outputs.some(i=>i.isConnectedInVertexShader)){this._writeTextureRead(e,!0);for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name,!0)}}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===pe.Fragment)return;const s=e.shaderLanguage===0?`texture2D(${this._samplerName},`:`textureSampleLevel(${this._samplerName}, ${this._samplerName+"Sampler"},`,n=e.shaderLanguage===0?"":", 0";e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,G.Vector4)} = ${s} ${i.associatedVariableName}${n});
`;return}const r=e.shaderLanguage===0?`texture2D(${this._samplerName},`:`textureSample(${this._samplerName}, ${this._samplerName+"Sampler"},`;if(this.uv.ownerBlock.target===pe.Fragment){e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,G.Vector4)} = ${r} ${i.associatedVariableName});
`;return}e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,G.Vector4)} = ${r} ${this._mainUVName});
`}_writeOutput(e,t,i,r=!1){if(r){if(e.target===pe.Fragment)return;e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`;return}if(this.uv.ownerBlock.target===pe.Fragment){e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`;return}e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`,e.compilationString+=`#ifdef ${this._linearDefineName}
`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef ${this._gammaDefineName}
`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});
`,e.compilationString+=`#endif
`}_buildBlock(e){if(super._buildBlock(e),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.blockingBlocks.indexOf(this)<0&&e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.indexOf(this)<0&&e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.indexOf(this)<0&&e.sharedData.blocksWithDefines.push(this),e.target!==pe.Fragment){e._emit2DSampler(this._samplerName),this._injectVertexCode(e);return}if(!this._outputs.some(i=>i.isConnectedInFragmentShader))return;e._emit2DSampler(this._samplerName),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),this._writeTextureRead(e);for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name);return this}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=Z.Parse(e.texture,t,i))}}Y("BABYLON.CurrentScreenBlock",Fg);class wg extends Wi{constructor(e){super(e,pe.Fragment),this._samplerName="diffuseSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",G.AutoDetect,!1,pe.VertexAndFragment),this.registerOutput("rgba",G.Color4,pe.Neutral),this.registerOutput("rgb",G.Color3,pe.Neutral),this.registerOutput("r",G.Float,pe.Neutral),this.registerOutput("g",G.Float,pe.Neutral),this.registerOutput("b",G.Float,pe.Neutral),this.registerOutput("a",G.Float,pe.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(G.Vector2|G.Vector3|G.Vector4)}getClassName(){return"ParticleTextureBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName("diffuseSampler")}autoConfigure(e,t=()=>!0){if(!this.uv.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="particle_uv"&&t(r));i||(i=new pi("uv"),i.setAsAttribute("particle_uv")),i.output.connectTo(this.uv)}}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_writeOutput(e,t,i){e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`,e.compilationString+=`#ifdef ${this._linearDefineName}
`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef ${this._gammaDefineName}
`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});
`,e.compilationString+=`#endif
`}_buildBlock(e){if(super._buildBlock(e),e.target===pe.Vertex)return;this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e._emit2DSampler(this._samplerName),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,G.Vector4)} = ${e._generateTextureSample(this.uv.associatedVariableName,this._samplerName)};
`;for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name);return this}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=Z.Parse(e.texture,t,i))}}Y("BABYLON.ParticleTextureBlock",wg);class Bg extends Wi{constructor(e){super(e,pe.Fragment),this._isUnique=!0,this.registerInput("color",G.Color4,!1,pe.Fragment),this.registerOutput("rampColor",G.Color4,pe.Fragment)}getClassName(){return"ParticleRampGradientBlock"}get color(){return this._inputs[0]}get rampColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("remapRanges"),e._excludeVariableName("rampSampler"),e._excludeVariableName("baseColor"),e._excludeVariableName("alpha"),e._excludeVariableName("remappedColorIndex"),e._excludeVariableName("rampColor")}_buildBlock(e){if(super._buildBlock(e),e.target===pe.Vertex)return;e._emit2DSampler("rampSampler","RAMPGRADIENT"),e._emitVaryingFromString("remapRanges",G.Vector4,"RAMPGRADIENT");const t=e.shaderLanguage===0?"":"fragmentInputs.";return e.compilationString+=`
            #ifdef RAMPGRADIENT
                ${e._declareLocalVar("baseColor",G.Vector4)} = ${this.color.associatedVariableName};
                ${e._declareLocalVar("alpha",G.Float)} = ${this.color.associatedVariableName}.a;

                ${e._declareLocalVar("remappedColorIndex",G.Float)} = clamp((alpha - ${t}remapRanges.x) / ${t}remapRanges.y, 0.0, 1.0);

                ${e._declareLocalVar("rampColor",G.Vector4)} = ${e._generateTextureSample("vec2(1.0 - remappedColorIndex, 0.)","rampSampler")};

                // Remapped alpha
                ${e._declareOutput(this.rampColor)} = vec4${e.fSuffix}(baseColor.rgb * rampColor.rgb, clamp((alpha * rampColor.a - ${t}remapRanges.z) / ${t}remapRanges.w, 0.0, 1.0));
            #else
                ${e._declareOutput(this.rampColor)} = ${this.color.associatedVariableName};
            #endif
        `,this}}Y("BABYLON.ParticleRampGradientBlock",Bg);class Ug extends Wi{constructor(e){super(e,pe.Fragment),this._isUnique=!0,this.registerInput("color",G.Color4,!1,pe.Fragment),this.registerInput("alphaTexture",G.Float,!1,pe.Fragment),this.registerInput("alphaColor",G.Float,!1,pe.Fragment),this.registerOutput("blendColor",G.Color4,pe.Fragment)}getClassName(){return"ParticleBlendMultiplyBlock"}get color(){return this._inputs[0]}get alphaTexture(){return this._inputs[1]}get alphaColor(){return this._inputs[2]}get blendColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("sourceAlpha")}_buildBlock(e){if(super._buildBlock(e),e.target!==pe.Vertex)return e.compilationString+=`
            #ifdef BLENDMULTIPLYMODE
                ${e._declareOutput(this.blendColor)};
                ${e._declareLocalVar("sourceAlpha",G.Float)}  = ${this.alphaColor.associatedVariableName} * ${this.alphaTexture.associatedVariableName};
                ${this.blendColor.associatedVariableName} = vec4${e.fSuffix}(${this.color.associatedVariableName}.rgb * sourceAlpha + vec3(1.0) * (1.0 - sourceAlpha), ${this.color.associatedVariableName}.a);
            #else
                ${e._declareOutput(this.blendColor)} = ${this.color.associatedVariableName};
            #endif
        `,this}}Y("BABYLON.ParticleBlendMultiplyBlock",Ug);class pa extends Wi{constructor(e){super(e,pe.Neutral),this.xSwizzle="x",this.ySwizzle="y",this.zSwizzle="z",this.wSwizzle="w",this.registerInput("xyzw ",G.Vector4,!0),this.registerInput("xyz ",G.Vector3,!0),this.registerInput("xy ",G.Vector2,!0),this.registerInput("zw ",G.Vector2,!0),this.registerInput("x",G.Float,!0),this.registerInput("y",G.Float,!0),this.registerInput("z",G.Float,!0),this.registerInput("w",G.Float,!0),this.registerOutput("xyzw",G.Vector4),this.registerOutput("xyz",G.Vector3),this.registerOutput("xy",G.Vector2),this.registerOutput("zw",G.Vector2)}getClassName(){return"VectorMergerBlock"}get xyzwIn(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get zwIn(){return this._inputs[3]}get x(){return this._inputs[4]}get y(){return this._inputs[5]}get z(){return this._inputs[6]}get w(){return this._inputs[7]}get xyzw(){return this._outputs[0]}get xyzOut(){return this._outputs[1]}get xyOut(){return this._outputs[2]}get zwOut(){return this._outputs[3]}get xy(){return this.xyOut}get xyz(){return this.xyzOut}_inputRename(e){return e==="xyzw "?"xyzwIn":e==="xyz "?"xyzIn":e==="xy "?"xyIn":e==="zw "?"zwIn":e}_buildSwizzle(e){return"."+(this.xSwizzle+this.ySwizzle+this.zSwizzle+this.wSwizzle).substring(0,e)}_buildBlock(e){super._buildBlock(e);const t=this.x,i=this.y,r=this.z,s=this.w,n=this.xyIn,o=this.zwIn,l=this.xyzIn,c=this.xyzwIn,h=this._outputs[0],f=this._outputs[1],u=this._outputs[2],d=this._outputs[3],_=e._getShaderType(G.Vector4),p=e._getShaderType(G.Vector3),g=e._getShaderType(G.Vector2);return c.isConnected?(h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${c.associatedVariableName}${this._buildSwizzle(4)};
`),f.hasEndpoints&&(e.compilationString+=e._declareOutput(f)+` = ${c.associatedVariableName}${this._buildSwizzle(3)};
`),u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${c.associatedVariableName}${this._buildSwizzle(2)};
`)):l.isConnected?(h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${_}(${l.associatedVariableName}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};
`),f.hasEndpoints&&(e.compilationString+=e._declareOutput(f)+` = ${l.associatedVariableName}${this._buildSwizzle(3)};
`),u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${l.associatedVariableName}${this._buildSwizzle(2)};
`)):n.isConnected?(h.hasEndpoints&&(o.isConnected?e.compilationString+=e._declareOutput(h)+` = ${_}(${n.associatedVariableName}, ${o.associatedVariableName})${this._buildSwizzle(4)};
`:e.compilationString+=e._declareOutput(h)+` = ${_}(${n.associatedVariableName}, ${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};
`),f.hasEndpoints&&(e.compilationString+=e._declareOutput(f)+` = ${p}(${n.associatedVariableName}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(3)};
`),u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${n.associatedVariableName}${this._buildSwizzle(2)};
`),d.hasEndpoints&&(o.isConnected?e.compilationString+=e._declareOutput(d)+` = ${o.associatedVariableName}${this._buildSwizzle(2)};
`:e.compilationString+=e._declareOutput(d)+` = ${g}(${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(2)};
`)):(h.hasEndpoints&&(o.isConnected?e.compilationString+=e._declareOutput(h)+` = ${_}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${o.associatedVariableName})${this._buildSwizzle(4)};
`:e.compilationString+=e._declareOutput(h)+` = ${_}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};
`),f.hasEndpoints&&(e.compilationString+=e._declareOutput(f)+` = ${p}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(3)};
`),u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${g}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"})${this._buildSwizzle(2)};
`),d.hasEndpoints&&(o.isConnected?e.compilationString+=e._declareOutput(d)+` = ${o.associatedVariableName}${this._buildSwizzle(2)};
`:e.compilationString+=e._declareOutput(d)+` = ${g}(${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(2)};
`)),this}serialize(){const e=super.serialize();return e.xSwizzle=this.xSwizzle,e.ySwizzle=this.ySwizzle,e.zSwizzle=this.zSwizzle,e.wSwizzle=this.wSwizzle,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.xSwizzle=e.xSwizzle??"x",this.ySwizzle=e.ySwizzle??"y",this.zSwizzle=e.zSwizzle??"z",this.wSwizzle=e.wSwizzle??"w"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.xSwizzle = "${this.xSwizzle}";
`,e+=`${this._codeVariableName}.ySwizzle = "${this.ySwizzle}";
`,e+=`${this._codeVariableName}.zSwizzle = "${this.zSwizzle}";
`,e+=`${this._codeVariableName}.wSwizzle = "${this.wSwizzle}";
`,e}}Y("BABYLON.VectorMergerBlock",pa);class co extends Wi{constructor(e){super(e,pe.Neutral),this.sourceRange=new ne(-1,1),this.targetRange=new ne(0,1),this.registerInput("input",G.AutoDetect),this.registerInput("sourceMin",G.Float,!0),this.registerInput("sourceMax",G.Float,!0),this.registerInput("targetMin",G.Float,!0),this.registerInput("targetMax",G.Float,!0),this.registerOutput("output",G.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"RemapBlock"}get input(){return this._inputs[0]}get sourceMin(){return this._inputs[1]}get sourceMax(){return this._inputs[2]}get targetMin(){return this._inputs[3]}get targetMax(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.sourceMin.isConnected?this.sourceMin.associatedVariableName:this._writeFloat(this.sourceRange.x),r=this.sourceMax.isConnected?this.sourceMax.associatedVariableName:this._writeFloat(this.sourceRange.y),s=this.targetMin.isConnected?this.targetMin.associatedVariableName:this._writeFloat(this.targetRange.x),n=this.targetMax.isConnected?this.targetMax.associatedVariableName:this._writeFloat(this.targetRange.y);return e.compilationString+=e._declareOutput(t)+` = ${s} + (${this._inputs[0].associatedVariableName} - ${i}) * (${n} - ${s}) / (${r} - ${i});
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.sourceRange = new BABYLON.Vector2(${this.sourceRange.x}, ${this.sourceRange.y});
`;return e+=`${this._codeVariableName}.targetRange = new BABYLON.Vector2(${this.targetRange.x}, ${this.targetRange.y});
`,e}serialize(){const e=super.serialize();return e.sourceRange=this.sourceRange.asArray(),e.targetRange=this.targetRange.asArray(),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.sourceRange=ne.FromArray(e.sourceRange),this.targetRange=ne.FromArray(e.targetRange)}}A([on("From",3)],co.prototype,"sourceRange",void 0);A([on("To",3)],co.prototype,"targetRange",void 0);Y("BABYLON.RemapBlock",co);class tb extends Wi{constructor(e){super(e,pe.Neutral),this.registerInput("left",G.AutoDetect),this.registerInput("right",G.AutoDetect),this.registerOutput("output",G.BasedOnInput),this.output._typeConnectionSource=this.left,this._linkConnectionTypes(0,1,!0),this.left.acceptedConnectionPointTypes.push(G.Float),this.right.acceptedConnectionPointTypes.push(G.Float),this._connectionObservers=[this.left.onTypeChangedObservable.add(()=>this._updateInputOutputTypes()),this.right.onTypeChangedObservable.add(()=>this._updateInputOutputTypes())]}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_updateInputOutputTypes(){if(this.output._typeConnectionSource=this.left,this.left.isConnected&&this.right.isConnected?(this.left.type===G.Int||this.left.type===G.Float&&this.right.type!==G.Int)&&(this.output._typeConnectionSource=this.right):this.left.isConnected!==this.right.isConnected&&(this.output._typeConnectionSource=this.left.isConnected?this.left:this.right),this.left.isConnected||this.right.isConnected)for(const[e,t]of[[this.left,this.right],[this.right,this.left]])e.acceptedConnectionPointTypes=[G.Int,G.Float],t.isConnected&&(e.acceptedConnectionPointTypes.push(t.type),(t.type===G.Int||t.type===G.Float)&&e.acceptedConnectionPointTypes.push(G.Vector2,G.Vector3,G.Vector4,G.Color3,G.Color4,G.Matrix))}dispose(){super.dispose(),this._connectionObservers.forEach(e=>e.remove()),this._connectionObservers.length=0}}class _l extends tb{constructor(e){super(e)}getClassName(){return"MultiplyBlock"}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} * ${this.right.associatedVariableName};
`,this}}Y("BABYLON.MultiplyBlock",_l);var Ii;(function(a){a[a.Material=0]="Material",a[a.PostProcess=1]="PostProcess",a[a.Particle=2]="Particle",a[a.ProceduralTexture=3]="ProceduralTexture",a[a.GaussianSplatting=4]="GaussianSplatting"})(Ii||(Ii={}));class ib extends ji{constructor(){super(),this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.EXPOSURE=!1,this.SKIPFINALCOLORCLAMP=!1,this.rebuild()}}class Tr{get noiseTexture(){return this._noiseTexture}set noiseTexture(e){this._noiseTexture!==e&&(this._noiseTexture=e,this._reset())}get isAnimationSheetEnabled(){return this._isAnimationSheetEnabled}set isAnimationSheetEnabled(e){this._isAnimationSheetEnabled!=e&&(this._isAnimationSheetEnabled=e,this._reset())}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported}getScene(){return this._scene}_hasTargetStopDurationDependantGradient(){return this._startSizeGradients&&this._startSizeGradients.length>0||this._emitRateGradients&&this._emitRateGradients.length>0||this._lifeTimeGradients&&this._lifeTimeGradients.length>0}getDragGradients(){return this._dragGradients}getLimitVelocityGradients(){return this._limitVelocityGradients}getColorGradients(){return this._colorGradients}getSizeGradients(){return this._sizeGradients}getColorRemapGradients(){return this._colorRemapGradients}getAlphaRemapGradients(){return this._alphaRemapGradients}getLifeTimeGradients(){return this._lifeTimeGradients}getAngularSpeedGradients(){return this._angularSpeedGradients}getVelocityGradients(){return this._velocityGradients}getStartSizeGradients(){return this._startSizeGradients}getEmitRateGradients(){return this._emitRateGradients}get direction1(){return this.particleEmitterType.direction1?this.particleEmitterType.direction1:m.Zero()}set direction1(e){this.particleEmitterType.direction1&&(this.particleEmitterType.direction1=e)}get direction2(){return this.particleEmitterType.direction2?this.particleEmitterType.direction2:m.Zero()}set direction2(e){this.particleEmitterType.direction2&&(this.particleEmitterType.direction2=e)}get minEmitBox(){return this.particleEmitterType.minEmitBox?this.particleEmitterType.minEmitBox:m.Zero()}set minEmitBox(e){this.particleEmitterType.minEmitBox&&(this.particleEmitterType.minEmitBox=e)}get maxEmitBox(){return this.particleEmitterType.maxEmitBox?this.particleEmitterType.maxEmitBox:m.Zero()}set maxEmitBox(e){this.particleEmitterType.maxEmitBox&&(this.particleEmitterType.maxEmitBox=e)}get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._reset())}get isBillboardBased(){return this._isBillboardBased}set isBillboardBased(e){this._isBillboardBased!==e&&(this._isBillboardBased=e,this._reset())}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e)}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(!e&&this._scene?this._imageProcessingConfiguration=this._scene.imageProcessingConfiguration:this._imageProcessingConfiguration=e)}_reset(){}_removeGradientAndTexture(e,t,i){if(!t)return this;let r=0;for(const s of t){if(s.gradient===e){t.splice(r,1);break}r++}return i&&i.dispose(),this}constructor(e){this.animations=[],this.renderingGroupId=0,this.emitter=m.Zero(),this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this.targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minScaleX=1,this.maxScaleX=1,this.minScaleY=1,this.maxScaleY=1,this.minInitialRotation=0,this.maxInitialRotation=0,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.layerMask=268435455,this.customShader=null,this.preventAutoStart=!1,this.applyFog=!1,this._wasDispatched=!1,this._rootUrl="",this.noiseStrength=new m(10,10,10),this.onAnimationEnd=null,this.blendMode=Tr.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.preWarmCycles=0,this.preWarmStepOffset=1,this.spriteCellChangeSpeed=1,this.startSpriteCellID=0,this.endSpriteCellID=0,this.spriteCellWidth=0,this.spriteCellHeight=0,this.spriteCellLoop=!0,this.spriteRandomStartCell=!1,this.translationPivot=new ne(0,0),this.beginAnimationOnStart=!1,this.beginAnimationFrom=0,this.beginAnimationTo=60,this.beginAnimationLoop=!1,this.worldOffset=new m(0,0,0),this._useLogarithmicDepth=!1,this.gravity=m.Zero(),this._colorGradients=null,this._sizeGradients=null,this._lifeTimeGradients=null,this._angularSpeedGradients=null,this._velocityGradients=null,this._limitVelocityGradients=null,this._dragGradients=null,this._emitRateGradients=null,this._startSizeGradients=null,this._rampGradients=null,this._colorRemapGradients=null,this._alphaRemapGradients=null,this.startDelay=0,this.limitVelocityDamping=.4,this.color1=new Ne(1,1,1,1),this.color2=new Ne(1,1,1,1),this.colorDead=new Ne(0,0,0,1),this.textureMask=new Ne(1,1,1,1),this._isSubEmitter=!1,this._billboardMode=7,this._isBillboardBased=!0,this._imageProcessingConfigurationDefines=new ib,this.id=e,this.name=e}createPointEmitter(e,t){throw new Error("Method not implemented.")}createHemisphericEmitter(e=1,t=1){throw new Error("Method not implemented.")}createSphereEmitter(e=1,t=1){throw new Error("Method not implemented.")}createDirectedSphereEmitter(e=1,t=new m(0,1,0),i=new m(0,1,0)){throw new Error("Method not implemented.")}createCylinderEmitter(e=1,t=1,i=1,r=0){throw new Error("Method not implemented.")}createDirectedCylinderEmitter(e=1,t=1,i=1,r=new m(0,1,0),s=new m(0,1,0)){throw new Error("Method not implemented.")}createConeEmitter(e=1,t=Math.PI/4){throw new Error("Method not implemented.")}createDirectedConeEmitter(e=1,t=Math.PI/4,i=new m(0,1,0),r=new m(0,1,0)){throw new Error("Method not implemented.")}createBoxEmitter(e,t,i,r){throw new Error("Method not implemented.")}}Tr.BLENDMODE_ONEONE=0;Tr.BLENDMODE_STANDARD=1;Tr.BLENDMODE_ADD=2;Tr.BLENDMODE_MULTIPLY=3;Tr.BLENDMODE_MULTIPLYADD=4;Y("BABYLON.BaseParticleSystem",Tr);class Vg extends Wi{constructor(e){super(e,pe.Neutral),this.registerInput("rgba",G.Color4,!0),this.registerInput("rgb ",G.Color3,!0),this.registerOutput("rgb",G.Color3),this.registerOutput("r",G.Float),this.registerOutput("g",G.Float),this.registerOutput("b",G.Float),this.registerOutput("a",G.Float),this.inputsAreExclusive=!0}getClassName(){return"ColorSplitterBlock"}get rgba(){return this._inputs[0]}get rgbIn(){return this._inputs[1]}get rgbOut(){return this._outputs[0]}get r(){return this._outputs[1]}get g(){return this._outputs[2]}get b(){return this._outputs[3]}get a(){return this._outputs[4]}_inputRename(e){return e==="rgb "?"rgbIn":e}_outputRename(e){return e==="rgb"?"rgbOut":e}_buildBlock(e){super._buildBlock(e);const t=this.rgba.isConnected?this.rgba:this.rgbIn;if(!t.isConnected)return;const i=this._outputs[0],r=this._outputs[1],s=this._outputs[2],n=this._outputs[3],o=this._outputs[4];return i.hasEndpoints&&(e.compilationString+=e._declareOutput(i)+` = ${t.associatedVariableName}.rgb;
`),r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = ${t.associatedVariableName}.r;
`),s.hasEndpoints&&(e.compilationString+=e._declareOutput(s)+` = ${t.associatedVariableName}.g;
`),n.hasEndpoints&&(e.compilationString+=e._declareOutput(n)+` = ${t.associatedVariableName}.b;
`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${t.associatedVariableName}.a;
`),this}}Y("BABYLON.ColorSplitterBlock",Vg);class rb{constructor(e){this.name=Ae.NAME_PROCEDURALTEXTURE,this.scene=e}register(){this.scene._beforeClearStage.registerStep(Ae.STEP_BEFORECLEAR_PROCEDURALTEXTURE,this,this._beforeClear)}rebuild(){}dispose(){}_beforeClear(){if(this.scene.proceduralTexturesEnabled){k.StartPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0);for(let e=0;e<this.scene.proceduralTextures.length;e++){const t=this.scene.proceduralTextures[e];t._shouldRender()&&t.render()}k.EndPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0)}}}class Gr extends Z{get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i,r,s=null,n=!0,o=!1,l=0){super(null,r,!n),this.isEnabled=!0,this.autoClear=!0,this.onGeneratedObservable=new U,this.onBeforeGenerationObservable=new U,this.nodeMaterialSource=null,this.defines="",this._textures={},this._currentRefreshId=-1,this._frameId=-1,this._refreshRate=1,this._vertexBuffers={},this._uniforms=new Array,this._samplers=new Array,this._floats={},this._ints={},this._floatsArrays={},this._colors3={},this._colors4={},this._vectors2={},this._vectors3={},this._vectors4={},this._matrices={},this._fallbackTextureUsed=!1,this._cachedDefines=null,this._contentUpdateId=-1,this._rtWrapper=null,s!==null&&!(s instanceof Z)?(this._options=s,this._fallbackTexture=s.fallbackTexture??null):(this._options={},this._fallbackTexture=s),this._shaderLanguage=this._options.shaderLanguage??0,r=this.getScene()||Re.LastCreatedScene;let c=r._getComponent(Ae.NAME_PROCEDURALTEXTURE);c||(c=new rb(r),r._addComponent(c)),r.proceduralTextures.push(this),this._fullEngine=r.getEngine(),this.name=e,this.isRenderTarget=!0,this._size=t,this._textureType=l,this._generateMipMaps=n,this._drawWrapper=new wa(this._fullEngine),this.setFragment(i);const h=this._createRtWrapper(o,t,n,l);this._texture=h.texture;const f=[];f.push(1,1),f.push(-1,1),f.push(-1,-1),f.push(1,-1),this._vertexBuffers[x.PositionKind]=new x(this._fullEngine,f,x.PositionKind,!1,!1,2),this._createIndexBuffer()}_createRtWrapper(e,t,i,r){return e?(this._rtWrapper=this._fullEngine.createRenderTargetCubeTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:r,...this._options}),this.setFloat("face",0)):(this._rtWrapper=this._fullEngine.createRenderTargetTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:r,...this._options}),this._rtWrapper.is3D&&(this.setFloat("layer",0),this.setInt("layerNum",0))),this._rtWrapper}getEffect(){return this._drawWrapper.effect}_setEffect(e){this._drawWrapper.effect=e}getContent(){return this._contentData&&this._frameId===this._contentUpdateId?this._contentData:(this._contentData?this._contentData.then(e=>{this._contentData=this.readPixels(0,0,e),this._contentUpdateId=this._frameId}):(this._contentData=this.readPixels(0,0),this._contentUpdateId=this._frameId),this._contentData)}_createIndexBuffer(){const e=this._fullEngine,t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=e.createIndexBuffer(t)}_rebuild(){const e=this._vertexBuffers[x.PositionKind];e&&e._rebuild(),this._createIndexBuffer(),this.refreshRate===rr.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=rr.REFRESHRATE_RENDER_ONCE)}reset(){var e;(e=this._drawWrapper.effect)==null||e.dispose(),this._drawWrapper.effect=null,this._cachedDefines=null}_getDefines(){return this.defines}executeWhenReady(e){if(this.isReady()){e(this);return}const t=this.getEffect();t&&t.executeWhenCompiled(()=>{e(this)})}isReady(){const e=this._fullEngine;if(this.nodeMaterialSource)return this._drawWrapper.effect.isReady();if(!this._fragment)return!1;if(this._fallbackTextureUsed)return!0;if(!this._texture)return!1;const t=this._getDefines();if(this._drawWrapper.effect&&t===this._cachedDefines&&this._drawWrapper.effect.isReady())return!0;const i={vertex:"procedural",fragmentElement:this._fragment.fragmentElement,fragmentSource:this._fragment.fragmentSource,fragment:typeof this._fragment=="string"?this._fragment:void 0};return this._cachedDefines!==t&&(this._cachedDefines=t,this._drawWrapper.effect=e.createEffect(i,[x.PositionKind],this._uniforms,this._samplers,t,void 0,void 0,()=>{var r;(r=this._rtWrapper)==null||r.dispose(),this._rtWrapper=this._texture=null,this._fallbackTexture&&(this._texture=this._fallbackTexture._texture,this._texture&&this._texture.incrementReferences()),this._fallbackTextureUsed=!0},void 0,this._shaderLanguage,async()=>{this._options.extraInitializationsAsync?this.shaderLanguage===1?await Promise.all([X(()=>Promise.resolve().then(()=>$p),void 0,import.meta.url),this._options.extraInitializationsAsync()]):await Promise.all([X(()=>Promise.resolve().then(()=>Jp),void 0,import.meta.url),this._options.extraInitializationsAsync()]):this.shaderLanguage===1?await X(()=>Promise.resolve().then(()=>$p),void 0,import.meta.url):await X(()=>Promise.resolve().then(()=>Jp),void 0,import.meta.url)})),this._drawWrapper.effect.isReady()}resetRefreshCounter(){this._currentRefreshId=-1}setFragment(e){this._fragment=e}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}_shouldRender(){return!this.isEnabled||!this.isReady()||!this._texture?(this._texture&&(this._texture.isReady=!1),!1):this._fallbackTextureUsed?!1:this._currentRefreshId===-1?(this._currentRefreshId=1,this._frameId++,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,this._frameId++,!0):(this._currentRefreshId++,!1)}getRenderSize(){return this._size}resize(e,t){if(this._fallbackTextureUsed||!this._rtWrapper||!this._texture)return;const i=this._texture.isCube;this._rtWrapper.dispose();const r=this._createRtWrapper(i,e,t,this._textureType);this._texture=r.texture,this._size=e,this._generateMipMaps=t}_checkUniform(e){this._uniforms.indexOf(e)===-1&&this._uniforms.push(e)}setTexture(e,t){return this._samplers.indexOf(e)===-1&&this._samplers.push(e),this._textures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setVector4(e,t){return this._checkUniform(e),this._vectors4[e]=t,this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}render(e){var s,n,o,l;const t=this.getScene();if(!t)return;const i=this._fullEngine;if(i.enableEffect(this._drawWrapper),this.onBeforeGenerationObservable.notifyObservers(this),i.setState(!1),!this.nodeMaterialSource){for(const c in this._textures)this._drawWrapper.effect.setTexture(c,this._textures[c]);for(const c in this._ints)this._drawWrapper.effect.setInt(c,this._ints[c]);for(const c in this._floats)this._drawWrapper.effect.setFloat(c,this._floats[c]);for(const c in this._floatsArrays)this._drawWrapper.effect.setArray(c,this._floatsArrays[c]);for(const c in this._colors3)this._drawWrapper.effect.setColor3(c,this._colors3[c]);for(const c in this._colors4){const h=this._colors4[c];this._drawWrapper.effect.setFloat4(c,h.r,h.g,h.b,h.a)}for(const c in this._vectors2)this._drawWrapper.effect.setVector2(c,this._vectors2[c]);for(const c in this._vectors3)this._drawWrapper.effect.setVector3(c,this._vectors3[c]);for(const c in this._vectors4)this._drawWrapper.effect.setVector4(c,this._vectors4[c]);for(const c in this._matrices)this._drawWrapper.effect.setMatrix(c,this._matrices[c])}if(!this._texture||!this._rtWrapper)return;(s=i._debugPushGroup)==null||s.call(i,`procedural texture generation for ${this.name}`,1);const r=i.currentViewport;if(this.isCube)for(let c=0;c<6;c++)i.bindFramebuffer(this._rtWrapper,c,void 0,void 0,!0),i.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this._drawWrapper.effect.setFloat("face",c),this.autoClear&&i.clear(t.clearColor,!0,!1,!1),i.drawElementsType(q.TriangleFillMode,0,6),i.unBindFramebuffer(this._rtWrapper,!0);else{let c=1;this._rtWrapper.is3D?c=this._rtWrapper.depth:this._rtWrapper.is2DArray&&(c=this._rtWrapper.layers);for(let h=0;h<c;h++){if(i.bindFramebuffer(this._rtWrapper,0,void 0,void 0,!0,0,h),i.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this._rtWrapper.is3D||this._rtWrapper.is2DArray){(n=this._drawWrapper.effect)==null||n.setFloat("layer",c!==1?h/(c-1):0),(o=this._drawWrapper.effect)==null||o.setInt("layerNum",h);for(const f in this._textures)this._drawWrapper.effect.setTexture(f,this._textures[f])}this.autoClear&&i.clear(t.clearColor,!0,!1,!1),i.drawElementsType(q.TriangleFillMode,0,6),i.unBindFramebuffer(this._rtWrapper,!this._generateMipMaps)}}r&&i.setViewport(r),this.isCube&&i.generateMipMapsForCubemap(this._texture,!0),(l=i._debugPopGroup)==null||l.call(i,1),this.onGenerated&&this.onGenerated(),this.onGeneratedObservable.notifyObservers(this)}clone(){const e=this.getSize(),t=new Gr(this.name,e.width,this._fragment,this.getScene(),this._fallbackTexture,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t}dispose(){const e=this.getScene();if(!e)return;const t=e.proceduralTextures.indexOf(this);t>=0&&e.proceduralTextures.splice(t,1);const i=this._vertexBuffers[x.PositionKind];i&&(i.dispose(),this._vertexBuffers[x.PositionKind]=null),this._indexBuffer&&this._fullEngine._releaseBuffer(this._indexBuffer)&&(this._indexBuffer=null),this.onGeneratedObservable.clear(),this.onBeforeGenerationObservable.clear(),super.dispose()}}A([y()],Gr.prototype,"isEnabled",void 0);A([y()],Gr.prototype,"autoClear",void 0);A([y()],Gr.prototype,"_generateMipMaps",void 0);A([y()],Gr.prototype,"_size",void 0);A([y()],Gr.prototype,"refreshRate",null);Y("BABYLON.ProceduralTexture",Gr);var $e;(function(a){a[a.Cos=0]="Cos",a[a.Sin=1]="Sin",a[a.Abs=2]="Abs",a[a.Exp=3]="Exp",a[a.Exp2=4]="Exp2",a[a.Round=5]="Round",a[a.Floor=6]="Floor",a[a.Ceiling=7]="Ceiling",a[a.Sqrt=8]="Sqrt",a[a.Log=9]="Log",a[a.Tan=10]="Tan",a[a.ArcTan=11]="ArcTan",a[a.ArcCos=12]="ArcCos",a[a.ArcSin=13]="ArcSin",a[a.Fract=14]="Fract",a[a.Sign=15]="Sign",a[a.Radians=16]="Radians",a[a.Degrees=17]="Degrees",a[a.Set=18]="Set"})($e||($e={}));class Jc extends Wi{constructor(e){super(e,pe.Neutral),this.operation=$e.Cos,this.registerInput("input",G.AutoDetect),this.registerOutput("output",G.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"TrigonometryBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];let i="";switch(this.operation){case $e.Cos:{i="cos";break}case $e.Sin:{i="sin";break}case $e.Abs:{i="abs";break}case $e.Exp:{i="exp";break}case $e.Exp2:{i="exp2";break}case $e.Round:{i="round";break}case $e.Floor:{i="floor";break}case $e.Ceiling:{i="ceil";break}case $e.Sqrt:{i="sqrt";break}case $e.Log:{i="log";break}case $e.Tan:{i="tan";break}case $e.ArcTan:{i="atan";break}case $e.ArcCos:{i="acos";break}case $e.ArcSin:{i="asin";break}case $e.Fract:{i="fract";break}case $e.Sign:{i="sign";break}case $e.Radians:{i="radians";break}case $e.Degrees:{i="degrees";break}case $e.Set:{i="";break}}return e.compilationString+=e._declareOutput(t)+` = ${i}(${this.input.associatedVariableName});
`,this}serialize(){const e=super.serialize();return e.operation=this.operation,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.operation=e.operation}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.TrigonometryBlockOperations.${$e[this.operation]};
`}}A([on("Operation",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Cos",value:$e.Cos},{label:"Sin",value:$e.Sin},{label:"Abs",value:$e.Abs},{label:"Exp",value:$e.Exp},{label:"Exp2",value:$e.Exp2},{label:"Round",value:$e.Round},{label:"Floor",value:$e.Floor},{label:"Ceiling",value:$e.Ceiling},{label:"Sqrt",value:$e.Sqrt},{label:"Log",value:$e.Log},{label:"Tan",value:$e.Tan},{label:"ArcTan",value:$e.ArcTan},{label:"ArcCos",value:$e.ArcCos},{label:"ArcSin",value:$e.ArcSin},{label:"Fract",value:$e.Fract},{label:"Sign",value:$e.Sign},{label:"Radians",value:$e.Radians},{label:"Degrees",value:$e.Degrees},{label:"Set",value:$e.Set}]})],Jc.prototype,"operation",void 0);Y("BABYLON.TrigonometryBlock",Jc);const Ko={effect:null,subMesh:null};class aa extends ji{constructor(){super(),this.NORMAL=!1,this.TANGENT=!1,this.VERTEXCOLOR_NME=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.PREPASS=!1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_WORLD_NORMAL=!1,this.PREPASS_WORLD_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_LOCAL_POSITION=!1,this.PREPASS_LOCAL_POSITION_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_SCREENSPACE_DEPTH=!1,this.PREPASS_SCREENSPACE_DEPTH_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_POSITION=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.MORPHTARGETS_UV2=!1,this.MORPHTARGETS_COLOR=!1,this.MORPHTARGETTEXTURE_HASPOSITIONS=!1,this.MORPHTARGETTEXTURE_HASNORMALS=!1,this.MORPHTARGETTEXTURE_HASTANGENTS=!1,this.MORPHTARGETTEXTURE_HASUVS=!1,this.MORPHTARGETTEXTURE_HASUV2S=!1,this.MORPHTARGETTEXTURE_HASCOLORS=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.EXPOSURE=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.BUMPDIRECTUV=0,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.AREALIGHTSUPPORTED=!0,this.AREALIGHTNOROUGHTNESS=!0,this.rebuild()}setValue(e,t,i=!1){this[e]===void 0&&this._keys.push(e),i&&this[e]!==t&&this.markAsUnprocessed(),this[e]=t}}class Et extends Un{static _BlockIsTextureBlock(e){return e.getClassName()==="TextureBlock"||e.getClassName()==="ReflectionTextureBaseBlock"||e.getClassName()==="ReflectionTextureBlock"||e.getClassName()==="ReflectionBlock"||e.getClassName()==="RefractionBlock"||e.getClassName()==="CurrentScreenBlock"||e.getClassName()==="ParticleTextureBlock"||e.getClassName()==="ImageSourceBlock"||e.getClassName()==="TriPlanarBlock"||e.getClassName()==="BiPlanarBlock"||e.getClassName()==="PrePassTextureBlock"}set _glowModeEnabled(e){this._useAdditionalColor=e}_getGlobalNodeMaterialEditor(){if(typeof NODEEDITOR<"u")return NODEEDITOR;if(typeof BABYLON<"u"&&typeof BABYLON.NodeEditor<"u")return BABYLON}get shaderLanguage(){var e;return((e=this._options)==null?void 0:e.shaderLanguage)||Et.DefaultShaderLanguage}set shaderLanguage(e){this._options.shaderLanguage=e}get options(){return this._options}set options(e){this._options=e}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get mode(){return this._mode}set mode(e){this._mode=e}get buildId(){return this._buildId}set buildId(e){this._buildId=e}constructor(e,t,i={}){if(super(e,t||Re.LastCreatedScene),this._buildId=Et._BuildIdGenerator++,this._buildWasSuccessful=!1,this._cachedWorldViewMatrix=new P,this._cachedWorldViewProjectionMatrix=new P,this._optimizers=new Array,this._animationFrame=-1,this._buildIsInProgress=!1,this.BJSNODEMATERIALEDITOR=this._getGlobalNodeMaterialEditor(),this._useAdditionalColor=!1,this.editorData=null,this.ignoreAlpha=!1,this.maxSimultaneousLights=4,this.onBuildObservable=new U,this.onBuildErrorObservable=new U,this._vertexOutputNodes=new Array,this._fragmentOutputNodes=new Array,this.attachedBlocks=[],this._mode=Ii.Material,this.forceAlphaBlending=!1,!Et.UseNativeShaderLanguageOfEngine&&i&&i.shaderLanguage===1&&!this.getScene().getEngine().isWebGPU)throw new Error("WebGPU shader language is only supported with WebGPU engine");this._options={emitComments:!1,shaderLanguage:Et.DefaultShaderLanguage,...i},Et.UseNativeShaderLanguageOfEngine&&(this._options.shaderLanguage=this.getScene().getEngine().isWebGPU?1:0),this._attachImageProcessingConfiguration(null)}getClassName(){return"NodeMaterial"}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}getBlockByName(e){let t=null;for(const i of this.attachedBlocks)if(i.name===e)if(!t)t=i;else return k.Warn("More than one block was found with the name `"+e+"`"),t;return t}getBlockByPredicate(e){for(const t of this.attachedBlocks)if(e(t))return t;return null}getInputBlockByPredicate(e){for(const t of this.attachedBlocks)if(t.isInput&&e(t))return t;return null}getInputBlocks(){const e=[];for(const t of this.attachedBlocks)t.isInput&&e.push(t);return e}registerOptimizer(e){if(!(this._optimizers.indexOf(e)>-1))return this._optimizers.push(e),this}unregisterOptimizer(e){const t=this._optimizers.indexOf(e);if(t!==-1)return this._optimizers.splice(t,1),this}addOutputNode(e){if(e.target===null)throw"This node is not meant to be an output node. You may want to explicitly set its target value.";return e.target&pe.Vertex&&this._addVertexOutputNode(e),e.target&pe.Fragment&&this._addFragmentOutputNode(e),this}removeOutputNode(e){return e.target===null?this:(e.target&pe.Vertex&&this._removeVertexOutputNode(e),e.target&pe.Fragment&&this._removeFragmentOutputNode(e),this)}_addVertexOutputNode(e){if(this._vertexOutputNodes.indexOf(e)===-1)return e.target=pe.Vertex,this._vertexOutputNodes.push(e),this}_removeVertexOutputNode(e){const t=this._vertexOutputNodes.indexOf(e);if(t!==-1)return this._vertexOutputNodes.splice(t,1),this}_addFragmentOutputNode(e){if(this._fragmentOutputNodes.indexOf(e)===-1)return e.target=pe.Fragment,this._fragmentOutputNodes.push(e),this}_removeFragmentOutputNode(e){const t=this._fragmentOutputNodes.indexOf(e);if(t!==-1)return this._fragmentOutputNodes.splice(t,1),this}get _supportGlowLayer(){return this._fragmentOutputNodes.length===0?!1:!!this._fragmentOutputNodes.some(e=>e.additionalColor&&e.additionalColor.isConnected)}needAlphaBlending(){return this.ignoreAlpha?!1:this.forceAlphaBlending||this.alpha<1||this._sharedData&&this._sharedData.hints.needAlphaBlending}needAlphaTesting(){return this._sharedData&&this._sharedData.hints.needAlphaTesting}_processInitializeOnLink(e,t,i,r=!0){(e.target===pe.VertexAndFragment||t.target===pe.Fragment&&e.target===pe.Vertex&&e._preparationId!==this._buildId)&&i.push(e),this._initializeBlock(e,t,i,r)}_attachBlock(e){if(this.attachedBlocks.indexOf(e)===-1){if(e.isUnique){const t=e.getClassName();for(const i of this.attachedBlocks)if(i.getClassName()===t)throw`Cannot have multiple blocks of type ${t} in the same NodeMaterial`}this.attachedBlocks.push(e)}}_initializeBlock(e,t,i,r=!0){e.initialize(t),r&&e.autoConfigure(this),e._preparationId=this._buildId,this._attachBlock(e);for(const s of e.inputs){s.associatedVariableName="";const n=s.connectedPoint;if(n&&!n._preventBubbleUp){const o=n.ownerBlock;o!==e&&this._processInitializeOnLink(o,t,i,r)}}if(e.isLoop){const s=e;if(s.loopID.hasEndpoints)for(const n of s.loopID.endpoints){const o=n.ownerBlock;o.outputs.length===0&&(t._terminalBlocks.add(o),this._processInitializeOnLink(o,t,i,r))}}else if(e.isTeleportOut){const s=e;s.entryPoint&&this._processInitializeOnLink(s.entryPoint,t,i,r)}for(const s of e.outputs)s.associatedVariableName=""}_resetDualBlocks(e,t){e.target===pe.VertexAndFragment&&(e.buildId=t);for(const i of e.inputs){const r=i.connectedPoint;if(r&&!r._preventBubbleUp){const s=r.ownerBlock;s!==e&&this._resetDualBlocks(s,t)}}if(e.isTeleportOut){const i=e;i.entryPoint&&this._resetDualBlocks(i.entryPoint,t)}else if(e.isLoop){const i=e;if(i.loopID.hasEndpoints)for(const r of i.loopID.endpoints){const s=r.ownerBlock;s.outputs.length===0&&this._resetDualBlocks(s,t)}}}removeBlock(e){const t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e.isFinalMerger&&this.removeOutputNode(e)}build(e=!1,t=!0,i=!1){if(this._buildIsInProgress){B.Warn("Build is already in progress, You can use NodeMaterial.onBuildObservable to determine when the build is completed.");return}this._buildIsInProgress=!0,!this._vertexCompilationState&&!i&&(i=!0),this._buildWasSuccessful=!1;const r=this.getScene().getEngine(),s=this._mode===Ii.Particle;if(this._vertexOutputNodes.length===0&&!s)throw"You must define at least one vertexOutputNode";if(this._fragmentOutputNodes.length===0)throw"You must define at least one fragmentOutputNode";this._vertexCompilationState=new Ff,this._vertexCompilationState.supportUniformBuffers=r.supportsUniformBuffers,this._vertexCompilationState.target=pe.Vertex,this._fragmentCompilationState=new Ff,this._fragmentCompilationState.supportUniformBuffers=r.supportsUniformBuffers,this._fragmentCompilationState.target=pe.Fragment;const n=this._fragmentOutputNodes.filter(f=>f._isFinalOutputAndActive).length>1;let o=this._fragmentOutputNodes;n&&(o=this._fragmentOutputNodes.filter(f=>!f._isFinalOutputAndActive),o.push(this._fragmentOutputNodes.filter(f=>f._isFinalOutputAndActive&&f._hasPrecedence)[0])),this._sharedData=new JI,this._sharedData.nodeMaterial=this,this._sharedData.fragmentOutputNodes=o,this._vertexCompilationState.sharedData=this._sharedData,this._fragmentCompilationState.sharedData=this._sharedData,this._sharedData.buildId=this._buildId,this._sharedData.emitComments=this._options.emitComments,this._sharedData.verbose=e,this._sharedData.scene=this.getScene(),this._sharedData.allowEmptyVertexProgram=s;const l=[],c=[];for(const f of this._vertexOutputNodes)l.push(f),this._initializeBlock(f,this._vertexCompilationState,c,i);for(const f of o)c.push(f),this._initializeBlock(f,this._fragmentCompilationState,l,i);let h=0;for(const f of this.attachedBlocks)f.codeIsReady||(h++,f.onCodeIsReadyObservable.addOnce(()=>{h--,h===0&&this._finishBuildProcess(e,t,l,c)}));h===0&&this._finishBuildProcess(e,t,l,c)}_finishBuildProcess(e=!1,t=!0,i,r){this.optimize();for(const l of i)l.build(this._vertexCompilationState,i);this._fragmentCompilationState.uniforms=this._vertexCompilationState.uniforms.slice(0),this._fragmentCompilationState._uniformDeclaration=this._vertexCompilationState._uniformDeclaration,this._fragmentCompilationState._constantDeclaration=this._vertexCompilationState._constantDeclaration,this._fragmentCompilationState._vertexState=this._vertexCompilationState;for(const l of r)this._resetDualBlocks(l,this._buildId-1);for(const l of r)l.build(this._fragmentCompilationState,r);this._vertexCompilationState.finalize(this._vertexCompilationState),this._fragmentCompilationState.finalize(this._fragmentCompilationState),t&&(this._buildId=Et._BuildIdGenerator++);const s=this._sharedData.emitErrors(this.onBuildErrorObservable);e&&(B.Log("Vertex shader:"),B.Log(this._vertexCompilationState.compilationString),B.Log("Fragment shader:"),B.Log(this._fragmentCompilationState.compilationString)),this._buildIsInProgress=!1,this._buildWasSuccessful=!0,s&&this.onBuildObservable.notifyObservers(this);const n=this.getScene().meshes;for(const l of n)if(l.subMeshes)for(const c of l.subMeshes){if(c.getMaterial()!==this||!c.materialDefines)continue;const h=c.materialDefines;h.markAllAsDirty(),h.reset()}this.prePassTextureInputs.length&&this.getScene().enablePrePassRenderer();const o=this.getScene().prePassRenderer;o&&o.markAsDirty()}optimize(){for(const e of this._optimizers)e.optimize(this._vertexOutputNodes,this._fragmentOutputNodes)}_prepareDefinesForAttributes(e,t){const i=t.NORMAL,r=t.TANGENT,s=t.VERTEXCOLOR_NME;t.NORMAL=e.isVerticesDataPresent(x.NormalKind),t.TANGENT=e.isVerticesDataPresent(x.TangentKind);const n=e.useVertexColors&&e.isVerticesDataPresent(x.ColorKind);t.VERTEXCOLOR_NME=n;let o=!1;for(let c=1;c<=6;++c){const h=t["UV"+c];t["UV"+c]=e.isVerticesDataPresent(`uv${c===1?"":c}`),o=o||t["UV"+c]!==h}const l=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;Nc(this.getScene(),t,!l),si.PrepareDefines(this.getScene().getEngine().currentRenderPassId,e,t),(i!==t.NORMAL||r!==t.TANGENT||s!==t.VERTEXCOLOR_NME||o)&&t.markAsAttributesDirty()}get isPrePassCapable(){return!0}get prePassTextureOutputs(){const e=this.getBlockByPredicate(i=>i.getClassName()==="PrePassOutputBlock"),t=[4];return!e||this.prePassTextureInputs.length||(e.viewDepth.isConnected&&t.push(5),e.screenDepth.isConnected&&t.push(10),e.viewNormal.isConnected&&t.push(6),e.worldNormal.isConnected&&t.push(8),e.worldPosition.isConnected&&t.push(1),e.localPosition.isConnected&&t.push(9),e.reflectivity.isConnected&&t.push(3),e.velocity.isConnected&&t.push(2),e.velocityLinear.isConnected&&t.push(11)),t}get prePassTextureInputs(){const e=this.getAllTextureBlocks().filter(i=>i.getClassName()==="PrePassTextureBlock"),t=[];for(const i of e)i.position.isConnected&&!t.includes(1)&&t.push(1),i.localPosition.isConnected&&!t.includes(9)&&t.push(9),i.depth.isConnected&&!t.includes(5)&&t.push(5),i.screenDepth.isConnected&&!t.includes(10)&&t.push(10),i.normal.isConnected&&!t.includes(6)&&t.push(6),i.worldNormal.isConnected&&!t.includes(8)&&t.push(8);return t}setPrePassRenderer(e){const t=this.prePassTextureInputs.concat(this.prePassTextureOutputs);if(e&&t.length>1){let i=e.getEffectConfiguration("nodeMaterial");i||(i=e.addEffectConfiguration({enabled:!0,needsImageProcessing:!1,name:"nodeMaterial",texturesRequired:[]}));for(const r of t)i.texturesRequired.includes(r)||i.texturesRequired.push(r);i.enabled=!0}return t.length>1}createPostProcess(e,t=1,i=1,r,s,n=0,o=5){return this.mode!==Ii.PostProcess?(B.Log("Incompatible material mode"),null):this._createEffectForPostProcess(null,e,t,i,r,s,n,o)}createEffectForPostProcess(e){this._createEffectForPostProcess(e)}_createEffectForPostProcess(e,t,i=1,r=1,s,n,o=0,l=5){let c=this.name+this._buildId;const h=new aa,f=new N(c+"PostProcess",this.getScene());let u=this._buildId;return this._processDefines(f,h),lt.RegisterShader(c,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString,this.shaderLanguage),e?e.updateEffect(h.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,c,c):e=new At(this.name+"PostProcess",c,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,i,t,r,s,n,h.toString(),o,c,{maxSimultaneousLights:this.maxSimultaneousLights},!1,l,this.shaderLanguage),e.nodeMaterialSource=this,e.onDisposeObservable.add(()=>{f.dispose()}),e.onApplyObservable.add(d=>{u!==this._buildId&&(delete lt.ShadersStore[c+"VertexShader"],delete lt.ShadersStore[c+"PixelShader"],c=this.name+this._buildId,h.markAllAsDirty(),u=this._buildId),this._processDefines(f,h)&&(lt.RegisterShader(c,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),vs.SetImmediate(()=>e.updateEffect(h.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,c,c))),this._checkInternals(d)}),e}createProceduralTexture(e,t){if(this.mode!==Ii.ProceduralTexture)return B.Log("Incompatible material mode"),null;let i=this.name+this._buildId;const r=new Gr(i,e,null,t),s=new N(i+"Procedural",this.getScene());s.reservedDataStore={hidden:!0};const n=new aa,o=this._processDefines(s,n);lt.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString,this.shaderLanguage);let l=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[x.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString(),o==null?void 0:o.fallbacks,void 0,void 0,void 0,this.shaderLanguage);r.nodeMaterialSource=this,r._setEffect(l);let c=this._buildId;const h=()=>{c!==this._buildId&&(delete lt.ShadersStore[i+"VertexShader"],delete lt.ShadersStore[i+"PixelShader"],i=this.name+this._buildId,n.markAllAsDirty(),c=this._buildId);const f=this._processDefines(s,n);f&&(lt.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString,this.shaderLanguage),vs.SetImmediate(()=>{l=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[x.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString(),f==null?void 0:f.fallbacks,void 0),r._setEffect(l)})),this._checkInternals(l)};return r.onBeforeGenerationObservable.add(()=>{h()}),this.onBuildObservable.add(()=>{h()}),r}_createEffectForParticles(e,t,i,r,s,n,o,l=""){let c=this.name+this._buildId+"_"+t;n||(n=new aa),o||(o=this.getScene().getMeshByName(this.name+"Particle"),o||(o=new N(this.name+"Particle",this.getScene()),o.reservedDataStore={hidden:!0}));let h=this._buildId;const f=[];let u=l;if(!s){const d=this._processDefines(o,n);lt.RegisterShader(c,this._fragmentCompilationState._builtCompilationString,void 0,this.shaderLanguage),e.fillDefines(f,t,!1),u=f.join(`
`),s=this.getScene().getEngine().createEffectForParticles(c,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString()+`
`+u,d==null?void 0:d.fallbacks,i,r,e,this.shaderLanguage),e.setCustomEffect(s,t)}s.onBindObservable.add(d=>{h!==this._buildId&&(delete lt.ShadersStore[c+"PixelShader"],c=this.name+this._buildId+"_"+t,n.markAllAsDirty(),h=this._buildId),f.length=0,e.fillDefines(f,t,!1);const _=f.join(`
`);_!==u&&(n.markAllAsDirty(),u=_);const p=this._processDefines(o,n);if(p){lt.RegisterShader(c,this._fragmentCompilationState._builtCompilationString,void 0,this.shaderLanguage),d=this.getScene().getEngine().createEffectForParticles(c,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString()+`
`+u,p==null?void 0:p.fallbacks,i,r,e),e.setCustomEffect(d,t),this._createEffectForParticles(e,t,i,r,d,n,o,l);return}this._checkInternals(d)})}_checkInternals(e){if(this._sharedData.animatedInputs){const t=this.getScene(),i=t.getFrameId();if(this._animationFrame!==i){for(const r of this._sharedData.animatedInputs)r.animate(t);this._animationFrame=i}}for(const t of this._sharedData.bindableBlocks)t.bind(e,this);for(const t of this._sharedData.inputBlocks)t._transmit(e,this.getScene(),this)}createEffectForParticles(e,t,i){if(this.mode!==Ii.Particle){B.Log("Incompatible material mode");return}this._createEffectForParticles(e,Tr.BLENDMODE_ONEONE,t,i),this._createEffectForParticles(e,Tr.BLENDMODE_MULTIPLY,t,i)}createAsShadowDepthWrapper(e){if(this.mode!==Ii.Material){B.Log("Incompatible material mode");return}e.shadowDepthWrapper=new BABYLON.ShadowDepthWrapper(this,this.getScene())}_processDefines(e,t,i=!1,r){let s=null;const n=this.getScene();if(Vm(n,t)&&t.markAsMiscDirty(),this._sharedData.blocksWithDefines.forEach(o=>{o.initializeDefines(e,this,t,i)}),this._sharedData.blocksWithDefines.forEach(o=>{o.prepareDefines(e,this,t,i,r)}),t.isDirty){const o=t._areLightsDisposed;t.markAsProcessed(),this._vertexCompilationState.compilationString=this._vertexCompilationState._builtCompilationString,this._fragmentCompilationState.compilationString=this._fragmentCompilationState._builtCompilationString,this._sharedData.repeatableContentBlocks.forEach(u=>{u.replaceRepeatableContent(this._vertexCompilationState,this._fragmentCompilationState,e,t)});const l=[];this._sharedData.dynamicUniformBlocks.forEach(u=>{u.updateUniformsAndSamples(this._vertexCompilationState,this,t,l)});const c=this._vertexCompilationState.uniforms;this._fragmentCompilationState.uniforms.forEach(u=>{c.indexOf(u)===-1&&c.push(u)});const h=this._vertexCompilationState.samplers;this._fragmentCompilationState.samplers.forEach(u=>{h.indexOf(u)===-1&&h.push(u)});const f=new Vn;this._sharedData.blocksWithFallbacks.forEach(u=>{u.provideFallbacks(e,f)}),s={lightDisposed:o,uniformBuffers:l,mergedUniforms:c,mergedSamplers:h,fallbacks:f}}return s}isReadyForSubMesh(e,t,i=!1){if(!this._buildWasSuccessful)return!1;const r=this.getScene();if(this._sharedData.animatedInputs){const c=r.getFrameId();if(this._animationFrame!==c){for(const h of this._sharedData.animatedInputs)h.animate(r);this._animationFrame=c}}const s=t._drawWrapper;if(s.effect&&this.isFrozen&&s._wasPreviouslyReady&&s._wasPreviouslyUsingInstances===i)return!0;(!t.materialDefines||typeof t.materialDefines=="string")&&(t.materialDefines=new aa);const n=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const o=r.getEngine();if(this._prepareDefinesForAttributes(e,n),this._sharedData.blockingBlocks.some(c=>!c.isReady(e,this,n,i)))return!1;const l=this._processDefines(e,n,i,t);if(l){const c=t.effect,h=n.toString();let f=o.createEffect({vertex:"nodeMaterial"+this._buildId,fragment:"nodeMaterial"+this._buildId,vertexSource:this._vertexCompilationState.compilationString,fragmentSource:this._fragmentCompilationState.compilationString},{attributes:this._vertexCompilationState.attributes,uniformsNames:l.mergedUniforms,uniformBuffersNames:l.uniformBuffers,samplers:l.mergedSamplers,defines:h,fallbacks:l.fallbacks,onCompiled:this.onCompiled,onError:this.onError,multiTarget:n.PREPASS,indexParameters:{maxSimultaneousLights:this.maxSimultaneousLights,maxSimultaneousMorphTargets:n.NUM_MORPH_INFLUENCERS},shaderLanguage:this.shaderLanguage},o);if(f)if(this._onEffectCreatedObservable&&(Ko.effect=f,Ko.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Ko)),this.allowShaderHotSwapping&&c&&!f.isReady()){if(f=c,n.markAsUnprocessed(),l.lightDisposed)return n._areLightsDisposed=!0,!1}else r.resetCachedMaterial(),t.setEffect(f,n,this._materialContext)}if(n.AREALIGHTUSED){for(let c=0;c<e.lightSources.length;c++)if(!e.lightSources[c]._isReady())return!1}return!t.effect||!t.effect.isReady()?!1:(n._renderId=r.getRenderId(),s._wasPreviouslyReady=!0,s._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),!0)}get compiledShaders(){return this._buildWasSuccessful||this.build(),`// Vertex shader
${this._vertexCompilationState.compilationString}

// Fragment shader
${this._fragmentCompilationState.compilationString}`}bindOnlyWorldMatrix(e){const t=this.getScene();if(!this._activeEffect)return;const i=this._sharedData.hints;i.needWorldViewMatrix&&e.multiplyToRef(t.getViewMatrix(),this._cachedWorldViewMatrix),i.needWorldViewProjectionMatrix&&e.multiplyToRef(t.getTransformMatrix(),this._cachedWorldViewProjectionMatrix);for(const r of this._sharedData.inputBlocks)r._transmitWorld(this._activeEffect,e,this._cachedWorldViewMatrix,this._cachedWorldViewProjectionMatrix)}bindForSubMesh(e,t,i){const r=this.getScene(),s=i.effect;if(!s)return;this._activeEffect=s,this.bindOnlyWorldMatrix(e);const n=this._mustRebind(r,s,i,t.visibility),o=this._sharedData;if(n){for(const l of o.bindableBlocks)l.bind(s,this,t,i);for(const l of o.forcedBindableBlocks)l.bind(s,this,t,i);for(const l of o.inputBlocks)l._transmit(s,r,this)}else if(!this.isFrozen)for(const l of o.forcedBindableBlocks)l.bind(s,this,t,i);this._afterBind(t,this._activeEffect,i)}getActiveTextures(){const e=super.getActiveTextures();return this._sharedData&&e.push(...this._sharedData.textureBlocks.filter(t=>t.texture).map(t=>t.texture)),e}getTextureBlocks(){return this._sharedData?this._sharedData.textureBlocks:[]}getAllTextureBlocks(){const e=[];for(const t of this.attachedBlocks)Et._BlockIsTextureBlock(t)&&e.push(t);return e}hasTexture(e){if(super.hasTexture(e))return!0;if(!this._sharedData)return!1;for(const t of this._sharedData.textureBlocks)if(t.texture===e)return!0;return!1}dispose(e,t,i){if(t)for(const r of this.getTextureBlocks().filter(s=>s.texture).map(s=>s.texture))r.dispose();for(const r of this.attachedBlocks)r.dispose();this.attachedBlocks.length=0,this._sharedData=null,this._vertexCompilationState=null,this._fragmentCompilationState=null,this.onBuildObservable.clear(),this.onBuildErrorObservable.clear(),this._imageProcessingObserver&&(this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingObserver=null),super.dispose(e,t,i)}_createNodeEditor(e){const t={nodeMaterial:this,...e};this.BJSNODEMATERIALEDITOR.NodeEditor.Show(t)}edit(e){return new Promise(t=>{if(this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),typeof this.BJSNODEMATERIALEDITOR>"u"){const i=e&&e.editorURL?e.editorURL:Et.EditorURL;k.LoadBabylonScript(i,()=>{this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),this._createNodeEditor(e==null?void 0:e.nodeEditorConfig),t()})}else this._createNodeEditor(e==null?void 0:e.nodeEditorConfig),t()})}clear(){this._vertexOutputNodes.length=0,this._fragmentOutputNodes.length=0,this.attachedBlocks.length=0,this._buildIsInProgress=!1}setToDefault(){this.clear(),this.editorData=null;const e=new pi("Position");e.setAsAttribute("position");const t=new pi("World");t.setAsSystemValue(pt.World);const i=new xa("WorldPos");e.connectTo(i),t.connectTo(i);const r=new pi("ViewProjection");r.setAsSystemValue(pt.ViewProjection);const s=new xa("WorldPos * ViewProjectionTransform");i.connectTo(s),r.connectTo(s);const n=new _a("VertexOutput");s.connectTo(n);const o=new pi("color");o.value=new Ne(.8,.8,.8,1);const l=new ps("FragmentOutput");o.connectTo(l),this.addOutputNode(n),this.addOutputNode(l),this._mode=Ii.Material}setToDefaultPostProcess(){this.clear(),this.editorData=null;const e=new pi("Position");e.setAsAttribute("position2d");const t=new pi("Constant1");t.isConstant=!0,t.value=1;const i=new pa("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});const r=new _a("VertexOutput");i.connectTo(r);const s=new pi("Scale");s.visibleInInspector=!0,s.value=new ne(1,1);const n=new co("uv0");e.connectTo(n);const o=new _l("UV scale");n.connectTo(o),s.connectTo(o);const l=new Fg("CurrentScreen");o.connectTo(l);const c=k.GetAssetUrl("https://assets.babylonjs.com/core/nme/currentScreenPostProcess.png");l.texture=new Z(c,this.getScene());const h=new ps("FragmentOutput");l.connectTo(h,{output:"rgba"}),this.addOutputNode(r),this.addOutputNode(h),this._mode=Ii.PostProcess}setToDefaultProceduralTexture(){this.clear(),this.editorData=null;const e=new pi("Position");e.setAsAttribute("position2d");const t=new pi("Constant1");t.isConstant=!0,t.value=1;const i=new pa("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});const r=new _a("VertexOutput");i.connectTo(r);const s=new pi("Time");s.value=0,s.min=0,s.max=0,s.isBoolean=!1,s.matrixMode=0,s.animationType=yr.Time,s.isConstant=!1;const n=new pi("Color3");n.value=new ae(1,1,1),n.isConstant=!1;const o=new ps("FragmentOutput"),l=new pa("VectorMerger");l.visibleInInspector=!1;const c=new Jc("Cos");c.operation=$e.Cos,e.connectTo(l),s.output.connectTo(c.input),c.output.connectTo(l.z),l.xyzOut.connectTo(o.rgb),this.addOutputNode(r),this.addOutputNode(o),this._mode=Ii.ProceduralTexture}setToDefaultParticle(){this.clear(),this.editorData=null;const e=new pi("uv");e.setAsAttribute("particle_uv");const t=new wg("ParticleTexture");e.connectTo(t);const i=new pi("Color");i.setAsAttribute("particle_color");const r=new _l("Texture * Color");t.connectTo(r),i.connectTo(r);const s=new Bg("ParticleRampGradient");r.connectTo(s);const n=new Vg("ColorSplitter");i.connectTo(n);const o=new Ug("ParticleBlendMultiply");s.connectTo(o),t.connectTo(o,{output:"a"}),n.connectTo(o,{output:"a"});const l=new ps("FragmentOutput");o.connectTo(l),this.addOutputNode(l),this._mode=Ii.Particle}async loadAsync(e,t=""){return Et.ParseFromFileAsync("",e,this.getScene(),t,!0,this)}_gatherBlocks(e,t){if(t.indexOf(e)===-1){t.push(e);for(const i of e.inputs){const r=i.connectedPoint;if(r){const s=r.ownerBlock;s!==e&&this._gatherBlocks(s,t)}}if(e.isTeleportOut){const i=e;i.entryPoint&&this._gatherBlocks(i.entryPoint,t)}}}generateCode(){let e=[];const t=[],i=["const","var","let"];for(const n of this._vertexOutputNodes)this._gatherBlocks(n,t);const r=[];for(const n of this._fragmentOutputNodes)this._gatherBlocks(n,r);let s=`var nodeMaterial = new BABYLON.NodeMaterial("${this.name||"node material"}");
`;s+=`nodeMaterial.mode = BABYLON.NodeMaterialModes.${Ii[this.mode]};
`;for(const n of t)n.isInput&&e.indexOf(n)===-1&&(s+=n._dumpCode(i,e));for(const n of r)n.isInput&&e.indexOf(n)===-1&&(s+=n._dumpCode(i,e));e=[],s+=`
// Connections
`;for(const n of this._vertexOutputNodes)s+=n._dumpCodeForOutputConnections(e);for(const n of this._fragmentOutputNodes)s+=n._dumpCodeForOutputConnections(e);s+=`
// Output nodes
`;for(const n of this._vertexOutputNodes)s+=`nodeMaterial.addOutputNode(${n._codeVariableName});
`;for(const n of this._fragmentOutputNodes)s+=`nodeMaterial.addOutputNode(${n._codeVariableName});
`;return s+=`nodeMaterial.build();
`,s}serialize(e){const t=e?{}:ye.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));let i=[];if(e)i=e;else{t.customType="BABYLON.NodeMaterial",t.outputNodes=[];for(const r of this._vertexOutputNodes)this._gatherBlocks(r,i),t.outputNodes.push(r.uniqueId);for(const r of this._fragmentOutputNodes)this._gatherBlocks(r,i),t.outputNodes.indexOf(r.uniqueId)===-1&&t.outputNodes.push(r.uniqueId)}t.blocks=[];for(const r of i)t.blocks.push(r.serialize());if(!e)for(const r of this.attachedBlocks)i.indexOf(r)===-1&&t.blocks.push(r.serialize());return t.uniqueId=this.uniqueId,t}_restoreConnections(e,t,i){for(const r of e.outputs)for(const s of t.blocks){const n=i[s.id];if(n){for(const o of s.inputs)if(i[o.targetBlockId]===e&&o.targetConnectionName===r.name){const l=n.getInputByName(o.inputName);if(!l||l.isConnected)continue;r.connectTo(l,!0),this._restoreConnections(n,t,i);continue}}}}parseSerializedObject(e,t="",i=!1,r){i||this.clear();const s={};for(const n of e.blocks){const o=Ui(n.customType);if(o){const l=new o;l._deserialize(n,this.getScene(),t,r),s[n.id]=l,this.attachedBlocks.push(l)}}for(const n of this.attachedBlocks)if(n.isTeleportOut){const o=n,l=o._tempEntryPointUniqueId;l&&s[l].attachToEndpoint(o)}for(let n=0;n<e.blocks.length;n++){const o=e.blocks[n],l=s[o.id];l&&(l.inputs.length&&!i||this._restoreConnections(l,e,s))}if(e.outputNodes)for(const n of e.outputNodes)this.addOutputNode(s[n]);if(e.locations||e.editorData&&e.editorData.locations){const n=e.locations||e.editorData.locations;for(const l of n)s[l.blockId]&&(l.blockId=s[l.blockId].uniqueId);i&&this.editorData&&this.editorData.locations&&n.concat(this.editorData.locations),e.locations?this.editorData={locations:n}:(this.editorData=e.editorData,this.editorData.locations=n);const o=[];for(const l in s)o[l]=s[l].uniqueId;this.editorData.map=o}this.comment=e.comment,e.forceAlphaBlending!==void 0&&(this.forceAlphaBlending=e.forceAlphaBlending),e.alphaMode!==void 0&&(this.alphaMode=e.alphaMode),i||(this._mode=e.mode??Ii.Material)}loadFromSerialization(e,t="",i=!1){this.parseSerializedObject(e,t,i)}clone(e,t=!1){const i=this.serialize(),r=ye.Clone(()=>new Et(e,this.getScene(),this.options),this);return r.id=e,r.name=e,r.parseSerializedObject(i),r._buildId=this._buildId,r.build(!1,!t),r}whenTexturesReadyAsync(){const e=[];return this.getActiveTextures().forEach(t=>{const i=t.getInternalTexture();i&&!i.isReady&&e.push(new Promise((r,s)=>{i.onLoadedObservable.addOnce(()=>{r()}),i.onErrorObservable.addOnce(n=>{s(n)})}))}),Promise.all(e)}static Parse(e,t,i="",r=0){const s=ye.Parse(()=>new Et(e.name,t,{shaderLanguage:r}),e,t,i);return s.parseSerializedObject(e,i),s.build(),s}static async ParseFromFileAsync(e,t,i,r="",s=!1,n,o,l){const c=n??new Et(e,i,l),h=await i._loadFileAsync(t),f=JSON.parse(h);return c.parseSerializedObject(f,r,void 0,o),s||c.build(),c}static ParseFromSnippetAsync(e,t=Re.LastCreatedScene,i="",r,s=!1,n=!1,o,l){return e==="_BLANK"?Promise.resolve(Et.CreateDefault("blank",t)):new Promise((c,h)=>{const f=new Gt;f.addEventListener("readystatechange",()=>{if(f.readyState==4)if(f.status==200){const u=JSON.parse(JSON.parse(f.responseText).jsonPayload),d=JSON.parse(u.nodeMaterial);r||(r=ye.Parse(()=>new Et(e,t,l),d,t,i),r.uniqueId=t.getUniqueId()),r.parseSerializedObject(d,void 0,void 0,o),r.snippetId=e,r.sideOrientation=null;try{s||r.build()}catch(_){h(_)}n?r.whenTexturesReadyAsync().then(()=>{c(r)}).catch(_=>{h(_)}):c(r)}else h("Unable to load the snippet "+e)}),f.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),f.send()})}static CreateDefault(e,t){const i=new Et(e,t);return i.setToDefault(),i.build(),i}}Et._BuildIdGenerator=0;Et.EditorURL=`${k._DefaultCdnUrl}/v${H.Version}/nodeEditor/babylon.nodeEditor.js`;Et.SnippetUrl="https://snippet.babylonjs.com";Et.IgnoreTexturesAtLoadTime=!1;Et.DefaultShaderLanguage=0;Et.UseNativeShaderLanguageOfEngine=!1;A([y()],Et.prototype,"ignoreAlpha",void 0);A([y()],Et.prototype,"maxSimultaneousLights",void 0);A([y("mode")],Et.prototype,"_mode",void 0);A([y("comment")],Et.prototype,"comment",void 0);A([y()],Et.prototype,"forceAlphaBlending",void 0);Y("BABYLON.NodeMaterial",Et);Ei.prototype._projectOnTrianglesToRef=function(a,e,t,i,r,s){const n=F.Vector3[0],o=F.Vector3[1];let l=1/0;for(let c=this.indexStart;c<this.indexStart+this.indexCount-(3-i);c+=i){const h=t[c],f=t[c+1],u=t[c+2];if(r&&u===4294967295){c+=2;continue}const d=e[h],_=e[f],p=e[u];if(!d||!_||!p)continue;const g=m.ProjectOnTriangleToRef(a,d,_,p,o);g<l&&(n.copyFrom(o),l=g)}return s.copyFrom(n),l};Ei.prototype._projectOnUnIndexedTrianglesToRef=function(a,e,t,i){const r=F.Vector3[0],s=F.Vector3[1];let n=1/0;for(let o=this.verticesStart;o<this.verticesStart+this.verticesCount;o+=3){const l=e[o],c=e[o+1],h=e[o+2],f=m.ProjectOnTriangleToRef(a,l,c,h,s);f<n&&(r.copyFrom(s),n=f)}return i.copyFrom(r),n};Ei.prototype.projectToRef=function(a,e,t,i){const r=this.getMaterial();if(!r)return-1;let s=3,n=!1;switch(r.fillMode){case 3:case 5:case 6:case 8:return-1;case 7:s=1,n=!0;break}return r.fillMode===4?-1:!t.length&&this._mesh._unIndexed?this._projectOnUnIndexedTrianglesToRef(a,e,t,i):this._projectOnTrianglesToRef(a,e,t,s,n,i)};var bi;(function(a){a[a.DEHYDRATED=0]="DEHYDRATED",a[a.HOVER=1]="HOVER",a[a.TOUCH=2]="TOUCH"})(bi||(bi={}));var kf;(function(a){a[a.DISABLED=0]="DISABLED",a[a.CENTERED_ON_CONTROLLER=1]="CENTERED_ON_CONTROLLER",a[a.CENTERED_IN_FRONT=2]="CENTERED_IN_FRONT"})(kf||(kf={}));const Fs=[new m,new m,new m,new m];class gr extends lo{constructor(e,t){super(e),this._options=t,this._tmpRay=new He(new m,new m),this._attachController=i=>{if(this._controllers[i.uniqueId])return;const{touchCollisionMesh:r,touchCollisionMeshFunction:s,hydrateCollisionMeshFunction:n}=this._generateNewTouchPointMesh(),o=this._generateVisualCue();switch(this._controllers[i.uniqueId]={xrController:i,meshUnderPointer:null,nearInteractionTargetMesh:null,pick:null,stalePick:null,touchCollisionMesh:r,touchCollisionMeshFunction:s,hydrateCollisionMeshFunction:n,currentAnimationState:bi.DEHYDRATED,grabRay:new He(new m,new m),hoverInteraction:!1,nearInteraction:!1,grabInteraction:!1,downTriggered:!1,id:gr._IdCounter++,pickedPointVisualCue:o},this._controllers[i.uniqueId]._worldScaleObserver=this._controllers[i.uniqueId]._worldScaleObserver||this._xrSessionManager.onWorldScaleFactorChangedObservable.add(l=>{if(l.newScaleFactor!==l.previousScaleFactor){this._controllers[i.uniqueId].touchCollisionMesh.dispose(),this._controllers[i.uniqueId].pickedPointVisualCue.dispose();const{touchCollisionMesh:c,touchCollisionMeshFunction:h,hydrateCollisionMeshFunction:f}=this._generateNewTouchPointMesh();this._controllers[i.uniqueId].touchCollisionMesh=c,this._controllers[i.uniqueId].touchCollisionMeshFunction=h,this._controllers[i.uniqueId].hydrateCollisionMeshFunction=f,this._controllers[i.uniqueId].pickedPointVisualCue=this._generateVisualCue()}}),this._attachedController?!this._options.enableNearInteractionOnAllControllers&&this._options.preferredHandedness&&i.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=i.uniqueId):this._options.enableNearInteractionOnAllControllers||(this._attachedController=i.uniqueId),i.inputSource.targetRayMode){case"tracked-pointer":return this._attachNearInteractionMode(i);case"gaze":return null;case"screen":return null}},this._controllers={},this._farInteractionFeature=null,this.selectionMeshDefaultColor=new ae(.8,.8,.8),this.selectionMeshPickedColor=new ae(.3,.3,1),this.alwaysHideSelectionMesh=!1,this._hoverRadius=.1,this._pickRadius=.02,this._controllerPickRadius=.03,this._nearGrabLengthScale=5,this._scene=this._xrSessionManager.scene,this._options.nearInteractionControllerMode===void 0&&(this._options.nearInteractionControllerMode=2),this._options.farInteractionFeature&&(this._farInteractionFeature=this._options.farInteractionFeature)}attach(){return super.attach()?(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),this._scene.constantlyUpdateMeshUnderPointer=!0,!0):!1}detach(){return super.detach()?(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),!0):!1}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].xrController||null;return null}setFarInteractionFeature(e){this._farInteractionFeature=e}_nearPickPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearPickable}_nearGrabPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearGrabbable}_nearInteractionPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&(e.isNearPickable||e.isNearGrabbable)}_controllerAvailablePredicate(e,t){let i=e;for(;i;){if(i.reservedDataStore&&i.reservedDataStore.nearInteraction&&i.reservedDataStore.nearInteraction.excludedControllerId===t)return!1;i=i.parent}return!0}_handleTransitionAnimation(e,t){var i;if(!(e.currentAnimationState===t||this._options.nearInteractionControllerMode!==2||(i=e.xrController)!=null&&i.inputSource.hand)){if(t>e.currentAnimationState)switch(e.currentAnimationState){case bi.DEHYDRATED:if(e.hydrateCollisionMeshFunction(!0),t===bi.HOVER)break;case bi.HOVER:if(e.touchCollisionMeshFunction(!0),t===bi.TOUCH)break}else switch(e.currentAnimationState){case bi.TOUCH:if(e.touchCollisionMeshFunction(!1),t===bi.HOVER)break;case bi.HOVER:if(e.hydrateCollisionMeshFunction(!1),t===bi.DEHYDRATED)break}e.currentAnimationState=t}}_processTouchPoint(e,t,i){var s;const r=this._controllers[e];r.grabRay.origin.copyFrom(t),i.toEulerAnglesToRef(F.Vector3[0]),r.grabRay.direction.copyFrom(F.Vector3[0]),this._options.nearInteractionControllerMode===2&&!((s=r.xrController)!=null&&s.inputSource.hand)&&(r.xrController.getWorldPointerRayToRef(this._tmpRay),r.grabRay.origin.addInPlace(this._tmpRay.direction.scale(.05))),r.grabRay.length=this._nearGrabLengthScale*this._hoverRadius*this._xrSessionManager.worldScalingFactor,r.touchCollisionMesh.position.copyFrom(r.grabRay.origin).scaleInPlace(this._xrSessionManager.worldScalingFactor)}_onXRFrame(e){Object.keys(this._controllers).forEach(t=>{var l;const i=this._controllers[t],r=(l=i.xrController)==null?void 0:l.inputSource.hand;if(!this._options.enableNearInteractionOnAllControllers&&t!==this._attachedController||!i.xrController||!r&&(!this._options.nearInteractionControllerMode||!i.xrController.inputSource.gamepad)){i.pick=null;return}if(i.hoverInteraction=!1,i.nearInteraction=!1,i.xrController){if(r){const c=r.get("index-finger-tip");if(c){const h=e.getJointPose(c,this._xrSessionManager.referenceSpace);if(h&&h.transform){const f=this._scene.useRightHandedSystem?1:-1;F.Vector3[0].set(h.transform.position.x,h.transform.position.y,h.transform.position.z*f),F.Quaternion[0].set(h.transform.orientation.x,h.transform.orientation.y,h.transform.orientation.z*f,h.transform.orientation.w*f),this._processTouchPoint(t,F.Vector3[0],F.Quaternion[0])}}}else if(i.xrController.inputSource.gamepad&&this._options.nearInteractionControllerMode!==0){let c=i.xrController.pointer;i.xrController.grip&&this._options.nearInteractionControllerMode===1&&(c=i.xrController.grip),this._processTouchPoint(t,c.position,c.rotationQuaternion)}}else return;const s=(c,h)=>{let f=null;return!h||!h.hit?f=c:!c||!c.hit||h.distance<c.distance?f=h:f=c,f},n=c=>{let h=new oi,f=!1;const u=c&&c.pickedPoint&&c.hit;return c!=null&&c.pickedPoint&&(f=c.pickedPoint.x===0&&c.pickedPoint.y===0&&c.pickedPoint.z===0),u&&!f&&(h=c),h};if(!i.grabInteraction){let c=null,h=null;this._options.useUtilityLayer&&this._utilityLayerScene&&(h=this._pickWithSphere(i,this._hoverRadius*this._xrSessionManager.worldScalingFactor,this._utilityLayerScene,d=>this._nearInteractionPredicate(d)));const f=this._pickWithSphere(i,this._hoverRadius*this._xrSessionManager.worldScalingFactor,this._scene,d=>this._nearInteractionPredicate(d)),u=s(f,h);if(u&&u.hit&&(c=n(u),c.hit&&(i.hoverInteraction=!0)),i.hoverInteraction){let d=null;const _=(r?this._pickRadius:this._controllerPickRadius)*this._xrSessionManager.worldScalingFactor;this._options.useUtilityLayer&&this._utilityLayerScene&&(d=this._pickWithSphere(i,_,this._utilityLayerScene,v=>this._nearPickPredicate(v)));const p=this._pickWithSphere(i,_,this._scene,v=>this._nearPickPredicate(v)),g=s(p,d),E=n(g);E.hit&&(c=E,i.nearInteraction=!0)}i.stalePick=i.pick,i.pick=c,i.pick&&i.pick.pickedPoint&&i.pick.hit?(i.meshUnderPointer=i.pick.pickedMesh,i.pickedPointVisualCue.position.copyFrom(i.pick.pickedPoint),i.pickedPointVisualCue.isVisible=!this.alwaysHideSelectionMesh,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(i.id,!0)):(i.meshUnderPointer=null,i.pickedPointVisualCue.isVisible=!1,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(i.id,!1))}let o=bi.DEHYDRATED;i.grabInteraction||i.nearInteraction?o=bi.TOUCH:i.hoverInteraction&&(o=bi.HOVER),this._handleTransitionAnimation(i,o)})}get _utilityLayerScene(){return this._options.customUtilityLayerScene||Nt.DefaultUtilityLayer.utilityLayerScene}_generateVisualCue(){const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Nt.DefaultUtilityLayer.utilityLayerScene:this._scene,t=Dn("nearInteraction",{diameter:.0035*3*this._xrSessionManager.worldScalingFactor},e);t.bakeCurrentTransformIntoVertices(),t.isPickable=!1,t.isVisible=!1,t.rotationQuaternion=z.Identity();const i=new se("targetMat",e);return i.specularColor=ae.Black(),i.emissiveColor=this.selectionMeshDefaultColor,i.backFaceCulling=!1,t.material=i,t}_isControllerReadyForNearInteraction(e){return this._farInteractionFeature?this._farInteractionFeature._getPointerSelectionDisabledByPointerId(e):!0}_attachNearInteractionMode(e){const t=this._controllers[e.uniqueId],i={pointerId:t.id,pointerType:"xr-near"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{!this._options.enableNearInteractionOnAllControllers&&e.uniqueId!==this._attachedController||!t.xrController||!t.xrController.inputSource.hand&&(!this._options.nearInteractionControllerMode||!t.xrController.inputSource.gamepad)||(t.pick&&(t.pick.ray=t.grabRay),t.pick&&this._isControllerReadyForNearInteraction(t.id)&&this._scene.simulatePointerMove(t.pick,i),t.nearInteraction&&t.pick&&t.pick.hit?t.nearInteractionTargetMesh||(this._scene.simulatePointerDown(t.pick,i),t.nearInteractionTargetMesh=t.meshUnderPointer,t.downTriggered=!0):t.nearInteractionTargetMesh&&t.stalePick&&(this._scene.simulatePointerUp(t.stalePick,i),t.downTriggered=!1,t.nearInteractionTargetMesh=null))});const r=s=>{this._options.enableNearInteractionOnAllControllers||e.uniqueId===this._attachedController&&this._isControllerReadyForNearInteraction(t.id)?(t.pick&&(t.pick.ray=t.grabRay),s&&t.pick&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)?(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,i),t.downTriggered=!0):!s&&t.pick&&t.grabInteraction&&(this._scene.simulatePointerUp(t.pick,i),t.downTriggered=!1,t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!this.alwaysHideSelectionMesh)):s&&!this._options.enableNearInteractionOnAllControllers&&!this._options.disableSwitchOnClick&&(this._attachedController=e.uniqueId)};if(e.inputSource.gamepad){const s=n=>{t.squeezeComponent=n.getComponent("grasp"),t.squeezeComponent?t.onSqueezeButtonChangedObserver=t.squeezeComponent.onButtonStateChangedObservable.add(o=>{if(o.changes.pressed){const l=o.changes.pressed.current;r(l)}}):(t.selectionComponent=n.getMainComponent(),t.onButtonChangedObserver=t.selectionComponent.onButtonStateChangedObservable.add(o=>{if(o.changes.pressed){const l=o.changes.pressed.current;r(l)}}))};e.motionController?s(e.motionController):e.onMotionControllerInitObservable.add(s)}else{const s=o=>{t.xrController&&o.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)&&(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,i),t.downTriggered=!0)},n=o=>{t.xrController&&o.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&(this._scene.simulatePointerUp(t.pick,i),t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!this.alwaysHideSelectionMesh,t.downTriggered=!1)};t.eventListeners={selectend:n,selectstart:s},this._xrSessionManager.session.addEventListener("selectstart",s),this._xrSessionManager.session.addEventListener("selectend",n)}}_detachController(e){const t=this._controllers[e];if(t&&(t.squeezeComponent&&t.onSqueezeButtonChangedObserver&&t.squeezeComponent.onButtonStateChangedObservable.remove(t.onSqueezeButtonChangedObserver),t.selectionComponent&&t.onButtonChangedObserver&&t.selectionComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver),t.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(t.onFrameObserver),t.eventListeners&&Object.keys(t.eventListeners).forEach(i=>{const r=t.eventListeners&&t.eventListeners[i];r&&this._xrSessionManager.session.removeEventListener(i,r)}),t.touchCollisionMesh.dispose(),t.pickedPointVisualCue.dispose(),this._xrSessionManager.runInXRFrame(()=>{if(!t.downTriggered)return;const i={pointerId:t.id,pointerType:"xr-near"};this._scene.simulatePointerUp(new oi,i)}),t._worldScaleObserver&&this._xrSessionManager.onWorldScaleFactorChangedObservable.remove(t._worldScaleObserver),delete this._controllers[e],this._attachedController===e)){const i=Object.keys(this._controllers);i.length?this._attachedController=i[0]:this._attachedController=""}}_generateNewTouchPointMesh(){const e=this._xrSessionManager.worldScalingFactor,t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Nt.DefaultUtilityLayer.utilityLayerScene:this._scene,i=Dn("PickSphere",{diameter:1*e},t);if(i.isVisible=!1,this._options.motionControllerOrbMaterial)i.material=this._options.motionControllerOrbMaterial;else{let O;this._options.motionControllerTouchMaterialSnippetUrl?O=Et.ParseFromFileAsync("motionControllerTouchMaterial",this._options.motionControllerTouchMaterialSnippetUrl,t):O=Et.ParseFromSnippetAsync("8RUNKL#3",t),O.then(L=>{i.material=L}).catch(L=>{B.Warn(`Error creating touch material in WebXRNearInteraction: ${L}`)})}const r=new AC;r.setEasingMode(kt.EASINGMODE_EASEINOUT);const s=new m(this._controllerPickRadius,this._controllerPickRadius,this._controllerPickRadius).scaleInPlace(e),n=this._controllerPickRadius*(4/3),o=new m(n,n,n).scaleInPlace(e),l=this._controllerPickRadius*(7/6),c=new m(l,l,l).scaleInPlace(e),h=this._controllerPickRadius*(4/5),f=new m(h,h,h).scaleInPlace(e),u=this._controllerPickRadius*(3/2),d=new m(u,u,u).scaleInPlace(e),_=[{frame:0,value:s},{frame:10,value:d},{frame:18,value:o}],p=[{frame:0,value:o},{frame:10,value:f},{frame:18,value:s}],g=[{frame:0,value:m.ZeroReadOnly},{frame:12,value:c},{frame:15,value:s}],E=[{frame:0,value:s},{frame:10,value:m.ZeroReadOnly},{frame:15,value:m.ZeroReadOnly}],v=new W("touch","scaling",60,W.ANIMATIONTYPE_VECTOR3,W.ANIMATIONLOOPMODE_CONSTANT),b=new W("release","scaling",60,W.ANIMATIONTYPE_VECTOR3,W.ANIMATIONLOOPMODE_CONSTANT),R=new W("hydrate","scaling",60,W.ANIMATIONTYPE_VECTOR3,W.ANIMATIONLOOPMODE_CONSTANT),S=new W("dehydrate","scaling",60,W.ANIMATIONTYPE_VECTOR3,W.ANIMATIONLOOPMODE_CONSTANT);return v.setEasingFunction(r),b.setEasingFunction(r),R.setEasingFunction(r),S.setEasingFunction(r),v.setKeys(_),b.setKeys(p),R.setKeys(g),S.setKeys(E),{touchCollisionMesh:i,touchCollisionMeshFunction:O=>{const L=O?v:b;t.beginDirectAnimation(i,[L],0,18,!1,1)},hydrateCollisionMeshFunction:O=>{const L=O?R:S;O&&(i.isVisible=!0),t.beginDirectAnimation(i,[L],0,15,!1,1,()=>{O||(i.isVisible=!1)})}}}_pickWithSphere(e,t,i,r){const s=new oi;if(s.distance=1/0,e.touchCollisionMesh&&e.xrController){const n=e.touchCollisionMesh.position,o=Lr.CreateFromCenterAndRadius(n,t);for(let l=0;l<i.meshes.length;l++){const c=i.meshes[l];if(!r(c)||!this._controllerAvailablePredicate(c,e.xrController.uniqueId))continue;const h=gr.PickMeshWithSphere(c,o);h&&h.hit&&h.distance<s.distance&&(s.hit=h.hit,s.pickedMesh=c,s.pickedPoint=h.pickedPoint,s.aimTransform=e.xrController.pointer,s.gripTransform=e.xrController.grip||null,s.originMesh=e.touchCollisionMesh,s.distance=h.distance,s.bu=h.bu,s.bv=h.bv,s.faceId=h.faceId,s.subMeshId=h.subMeshId)}}return s}static PickMeshWithSphere(e,t,i=!1){const r=e.subMeshes,s=new oi,n=e.getBoundingInfo();if(!e._generatePointsArray()||!e.subMeshes||!n||!i&&!Lr.Intersects(n.boundingSphere,t))return s;const o=Fs[0],l=Fs[1];Fs[2].setAll(0),Fs[3].setAll(0);const c=new He(Fs[2],Fs[3],1);let h=1/0,f,u,d,_;const p=F.Vector3[2],g=F.Matrix[0];g.copyFrom(e.getWorldMatrix()),g.invert(),m.TransformCoordinatesToRef(t.center,g,p);for(let E=0;E<r.length;E++)r[E].projectToRef(p,e._positions,e.getIndices(),l),m.TransformCoordinatesToRef(l,e.getWorldMatrix(),l),f=m.Distance(l,t.center),d=m.DistanceSquared(l,e.getAbsolutePosition()),u=m.DistanceSquared(t.center,e.getAbsolutePosition()),u!==-1&&d!==-1&&d>u&&(f=0,l.copyFrom(t.center)),f!==-1&&f<h&&(h=f,He.CreateFromToToRef(t.center,l,c),c.length=h*2,_=c.intersectsMesh(e),o.copyFrom(l));return h<t.radius&&(s.hit=!0,s.distance=h,s.pickedMesh=e,s.pickedPoint=o.clone(),_&&_.bu!==null&&_.bv!==null&&(s.faceId=_.faceId,s.subMeshId=_.subMeshId,s.bu=_.bu,s.bv=_.bv)),s}}gr._IdCounter=200;gr.Name=St.NEAR_INTERACTION;gr.Version=1;Yi.AddWebXRFeature(gr.Name,(a,e)=>()=>new gr(a,e),gr.Version,!0);class sb{constructor(e,t,i){this.element=e,this.sessionMode=t,this.referenceSpaceType=i}update(e){}}class eh{constructor(e,t){if(this._scene=e,this.options=t,this._activeButton=null,this._buttons=[],this.activeButtonChangedObservable=new U,this._onSessionGranted=r=>{this._helper&&this._enterXRWithButtonIndex(0)},this.overlay=document.createElement("div"),this.overlay.classList.add("xr-button-overlay"),!t.ignoreSessionGrantedEvent&&navigator.xr&&navigator.xr.addEventListener("sessiongranted",this._onSessionGranted),typeof window<"u"&&window.location&&window.location.protocol==="http:"&&window.location.hostname!=="localhost")throw k.Warn("WebXR can only be served over HTTPS"),new Error("WebXR can only be served over HTTPS");if(t.customButtons)this._buttons=t.customButtons;else{this.overlay.style.cssText="z-index:11;position: absolute; right: 20px;bottom: 50px;";const r=t.sessionMode||"immersive-vr",s=t.referenceSpaceType||"local-floor";let o=".babylonVRicon { color: #868686; border-color: #868686; border-style: solid; margin-left: 10px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+(typeof SVGSVGElement>"u"?"https://cdn.babylonjs.com/Assets/vrButton.png":"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";o+='.babylonVRicon.vrdisplaypresenting { background-image: none;} .vrdisplaypresenting::after { content: "EXIT"} .xr-error::after { content: "ERROR"}';const l=document.createElement("style");l.appendChild(document.createTextNode(o)),document.getElementsByTagName("head")[0].appendChild(l);const c=document.createElement("button");c.className="babylonVRicon",c.title=`${r} - ${s}`,this._buttons.push(new sb(c,r,s)),this._buttons[this._buttons.length-1].update=function(h){this.element.style.display=h===null||h===this?"":"none",c.className="babylonVRicon"+(h===this?" vrdisplaypresenting":"")},this._updateButtons(null)}const i=e.getEngine().getInputElement();i&&i.parentNode&&(i.parentNode.appendChild(this.overlay),e.onDisposeObservable.addOnce(()=>{this.dispose()}))}async setHelperAsync(e,t){this._helper=e,this._renderTarget=t;const i=this._buttons.map(s=>e.sessionManager.isSessionSupportedAsync(s.sessionMode));e.onStateChangedObservable.add(s=>{s==3&&this._updateButtons(null)}),(await Promise.all(i)).forEach((s,n)=>{s?(this.overlay.appendChild(this._buttons[n].element),this._buttons[n].element.onclick=this._enterXRWithButtonIndex.bind(this,n)):k.Warn(`Session mode "${this._buttons[n].sessionMode}" not supported in browser`)})}static async CreateAsync(e,t,i){const r=new eh(e,i);return await r.setHelperAsync(t,i.renderTarget||void 0),r}async _enterXRWithButtonIndex(e=0){if(this._helper.state==2)await this._helper.exitXRAsync(),this._updateButtons(null);else if(this._helper.state==3)try{await this._helper.enterXRAsync(this._buttons[e].sessionMode,this._buttons[e].referenceSpaceType,this._renderTarget,{optionalFeatures:this.options.optionalFeatures,requiredFeatures:this.options.requiredFeatures}),this._updateButtons(this._buttons[e])}catch(t){this._updateButtons(null);const i=this._buttons[e].element,r=i.title;i.title="Error entering XR session : "+r,i.classList.add("xr-error"),this.options.onError&&this.options.onError(t)}}dispose(){const e=this._scene.getEngine().getInputElement();e&&e.parentNode&&e.parentNode.contains(this.overlay)&&e.parentNode.removeChild(this.overlay),this.activeButtonChangedObservable.clear(),navigator.xr.removeEventListener("sessiongranted",this._onSessionGranted)}_updateButtons(e){this._activeButton=e,this._buttons.forEach(t=>{t.update(this._activeButton)}),this.activeButtonChangedObservable.notifyObservers(this._activeButton)}}class Gi{constructor(e,t){this.type=e,this.jointData=t,t.nativeParams=t.nativeParams||{}}get physicsJoint(){return this._physicsJoint}set physicsJoint(e){this._physicsJoint=e}set physicsPlugin(e){this._physicsPlugin=e}executeNativeFunction(e){e(this._physicsPlugin.world,this._physicsJoint)}}Gi.DistanceJoint=0;Gi.HingeJoint=1;Gi.BallAndSocketJoint=2;Gi.WheelJoint=3;Gi.SliderJoint=4;Gi.PrismaticJoint=5;Gi.UniversalJoint=6;Gi.Hinge2Joint=Gi.WheelJoint;Gi.PointToPointJoint=8;Gi.SpringJoint=9;Gi.LockJoint=10;N._PhysicsImpostorParser=function(a,e,t){return new _t(e,t.physicsImpostor,{mass:t.physicsMass,friction:t.physicsFriction,restitution:t.physicsRestitution},a)};class _t{get isDisposed(){return this._isDisposed}get mass(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyMass(this):0}set mass(e){this.setMass(e)}get friction(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyFriction(this):0}set friction(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyFriction(this,e)}get restitution(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyRestitution(this):0}set restitution(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyRestitution(this,e)}get pressure(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.setBodyPressure?e.getBodyPressure(this):0}set pressure(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyPressure&&t.setBodyPressure(this,e)}get stiffness(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyStiffness?e.getBodyStiffness(this):0}set stiffness(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyStiffness&&t.setBodyStiffness(this,e)}get velocityIterations(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyVelocityIterations?e.getBodyVelocityIterations(this):0}set velocityIterations(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyVelocityIterations&&t.setBodyVelocityIterations(this,e)}get positionIterations(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyPositionIterations?e.getBodyPositionIterations(this):0}set positionIterations(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyPositionIterations&&t.setBodyPositionIterations(this,e)}constructor(e,t,i={mass:0},r){if(this.object=e,this.type=t,this._options=i,this._scene=r,this._pluginData={},this._bodyUpdateRequired=!1,this._onBeforePhysicsStepCallbacks=new Array,this._onAfterPhysicsStepCallbacks=new Array,this._onPhysicsCollideCallbacks=[],this._deltaPosition=m.Zero(),this._isDisposed=!1,this.soft=!1,this.segments=0,this._tmpQuat=new z,this._tmpQuat2=new z,this.beforeStep=()=>{this._physicsEngine&&(this.object.translate(this._deltaPosition,-1),this._deltaRotationConjugated&&this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotationConjugated,this.object.rotationQuaternion),this.object.computeWorldMatrix(!1),this.object.parent&&this.object.rotationQuaternion?(this.getParentsRotation(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this._tmpQuat)):this._tmpQuat.copyFrom(this.object.rotationQuaternion||new z),this._options.disableBidirectionalTransformation||this.object.rotationQuaternion&&this._physicsEngine.getPhysicsPlugin().setPhysicsBodyTransformation(this,this.object.getAbsolutePosition(),this._tmpQuat),this._onBeforePhysicsStepCallbacks.forEach(s=>{s(this)}))},this.afterStep=()=>{this._physicsEngine&&(this._onAfterPhysicsStepCallbacks.forEach(s=>{s(this)}),this._physicsEngine.getPhysicsPlugin().setTransformationFromPhysicsBody(this),this.object.parent&&this.object.rotationQuaternion&&(this.getParentsRotation(),this._tmpQuat.conjugateInPlace(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this.object.rotationQuaternion)),this.object.setAbsolutePosition(this.object.position),this._deltaRotation?(this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotation,this.object.rotationQuaternion),this._deltaPosition.applyRotationQuaternionToRef(this._deltaRotation,_t._TmpVecs[0]),this.object.translate(_t._TmpVecs[0],1)):this.object.translate(this._deltaPosition,1),this.object.computeWorldMatrix(!0))},this.onCollideEvent=null,this.onCollide=s=>{if(!this._onPhysicsCollideCallbacks.length&&!this.onCollideEvent||!this._physicsEngine)return;const n=this._physicsEngine.getImpostorWithPhysicsBody(s.body);n&&(this.onCollideEvent&&this.onCollideEvent(this,n),this._onPhysicsCollideCallbacks.filter(o=>o.otherImpostors.indexOf(n)!==-1).forEach(o=>{o.callback(this,n,s.point,s.distance,s.impulse,s.normal)}))},!this.object){B.Error("No object was provided. A physics object is obligatory");return}this.object.parent&&i.mass!==0&&B.Warn("A physics impostor has been created for an object which has a parent. Babylon physics currently works in local space so unexpected issues may occur."),!this._scene&&e.getScene&&(this._scene=e.getScene()),this._scene&&(this.type>100&&(this.soft=!0),this._physicsEngine=this._scene.getPhysicsEngine(),this._physicsEngine?(this.object.rotationQuaternion||(this.object.rotation?this.object.rotationQuaternion=z.RotationYawPitchRoll(this.object.rotation.y,this.object.rotation.x,this.object.rotation.z):this.object.rotationQuaternion=new z),this._options.mass=i.mass===void 0?0:i.mass,this._options.friction=i.friction===void 0?.2:i.friction,this._options.restitution=i.restitution===void 0?.2:i.restitution,this.soft&&(this._options.mass=this._options.mass>0?this._options.mass:1,this._options.pressure=i.pressure===void 0?200:i.pressure,this._options.stiffness=i.stiffness===void 0?1:i.stiffness,this._options.velocityIterations=i.velocityIterations===void 0?20:i.velocityIterations,this._options.positionIterations=i.positionIterations===void 0?20:i.positionIterations,this._options.fixedPoints=i.fixedPoints===void 0?0:i.fixedPoints,this._options.margin=i.margin===void 0?0:i.margin,this._options.damping=i.damping===void 0?0:i.damping,this._options.path=i.path===void 0?null:i.path,this._options.shape=i.shape===void 0?null:i.shape),this._joints=[],!this.object.parent||this._options.ignoreParent?this._init():this.object.parent.physicsImpostor&&B.Warn("You must affect impostors to children before affecting impostor to parent.")):B.Error("Physics not enabled. Please use scene.enablePhysics(...) before creating impostors."))}_init(){this._physicsEngine&&(this._physicsEngine.removeImpostor(this),this.physicsBody=null,this._parent=this._parent||this._getPhysicsParent(),!this._isDisposed&&(!this.parent||this._options.ignoreParent)&&this._physicsEngine.addImpostor(this))}_getPhysicsParent(){return this.object.parent instanceof ei?this.object.parent.physicsImpostor:null}isBodyInitRequired(){return this._bodyUpdateRequired||!this._physicsBody&&(!this._parent||!!this._options.ignoreParent)}setScalingUpdated(){this.forceUpdate()}forceUpdate(){this._init(),this.parent&&!this._options.ignoreParent&&this.parent.forceUpdate()}get physicsBody(){return this._parent&&!this._options.ignoreParent?this._parent.physicsBody:this._physicsBody}get parent(){return!this._options.ignoreParent&&this._parent?this._parent:null}set parent(e){this._parent=e}set physicsBody(e){this._physicsBody&&this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().removePhysicsBody(this),this._physicsBody=e,this.resetUpdateFlags()}resetUpdateFlags(){this._bodyUpdateRequired=!1}getObjectExtents(){if(this.object.getBoundingInfo){const e=this.object.rotationQuaternion,t=this.object.scaling.clone();this.object.rotationQuaternion=_t.IDENTITY_QUATERNION;const i=this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0);i&&i.decompose(t,void 0,void 0);const s=this.object.getBoundingInfo().boundingBox.extendSize.scale(2).multiplyInPlace(t);return s.x=Math.abs(s.x),s.y=Math.abs(s.y),s.z=Math.abs(s.z),this.object.rotationQuaternion=e,this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0),s}else return _t.DEFAULT_OBJECT_SIZE}getObjectCenter(){return this.object.getBoundingInfo?this.object.getBoundingInfo().boundingBox.centerWorld:this.object.position}getParam(e){return this._options[e]}setParam(e,t){this._options[e]=t,this._bodyUpdateRequired=!0}setMass(e){this.getParam("mass")!==e&&this.setParam("mass",e),this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyMass(this,e)}getLinearVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getLinearVelocity(this):m.Zero()}setLinearVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setLinearVelocity(this,e)}getAngularVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getAngularVelocity(this):m.Zero()}setAngularVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setAngularVelocity(this,e)}executeNativeFunction(e){this._physicsEngine&&e(this._physicsEngine.getPhysicsPlugin().world,this.physicsBody)}registerBeforePhysicsStep(e){this._onBeforePhysicsStepCallbacks.push(e)}unregisterBeforePhysicsStep(e){const t=this._onBeforePhysicsStepCallbacks.indexOf(e);t>-1?this._onBeforePhysicsStepCallbacks.splice(t,1):B.Warn("Function to remove was not found")}registerAfterPhysicsStep(e){this._onAfterPhysicsStepCallbacks.push(e)}unregisterAfterPhysicsStep(e){const t=this._onAfterPhysicsStepCallbacks.indexOf(e);t>-1?this._onAfterPhysicsStepCallbacks.splice(t,1):B.Warn("Function to remove was not found")}registerOnPhysicsCollide(e,t){const i=e instanceof Array?e:[e];this._onPhysicsCollideCallbacks.push({callback:t,otherImpostors:i})}unregisterOnPhysicsCollide(e,t){const i=e instanceof Array?e:[e];let r=-1;this._onPhysicsCollideCallbacks.some((n,o)=>{if(n.callback===t&&n.otherImpostors.length===i.length){const l=n.otherImpostors.every(c=>i.indexOf(c)>-1);return l&&(r=o),l}return!1})?this._onPhysicsCollideCallbacks.splice(r,1):B.Warn("Function to remove was not found")}getParentsRotation(){let e=this.object.parent;for(this._tmpQuat.copyFromFloats(0,0,0,1);e;)e.rotationQuaternion?this._tmpQuat2.copyFrom(e.rotationQuaternion):z.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,e.rotation.z,this._tmpQuat2),this._tmpQuat.multiplyToRef(this._tmpQuat2,this._tmpQuat),e=e.parent;return this._tmpQuat}applyForce(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyForce(this,e,t),this}applyImpulse(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyImpulse(this,e,t),this}createJoint(e,t,i){const r=new Gi(t,i);return this.addJoint(e,r),this}addJoint(e,t){return this._joints.push({otherImpostor:e,joint:t}),this._physicsEngine&&this._physicsEngine.addJoint(this,e,t),this}addAnchor(e,t,i,r,s){if(!this._physicsEngine)return this;const n=this._physicsEngine.getPhysicsPlugin();return n.appendAnchor?(this._physicsEngine&&n.appendAnchor(this,e,t,i,r,s),this):this}addHook(e,t,i,r){if(!this._physicsEngine)return this;const s=this._physicsEngine.getPhysicsPlugin();return s.appendAnchor?(this._physicsEngine&&s.appendHook(this,e,t,i,r),this):this}sleep(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().sleepBody(this),this}wakeUp(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().wakeUpBody(this),this}clone(e){return e?new _t(e,this.type,this._options,this._scene):null}dispose(){this._physicsEngine&&(this._joints.forEach(e=>{this._physicsEngine&&this._physicsEngine.removeJoint(this,e.otherImpostor,e.joint)}),this._physicsEngine.removeImpostor(this),this.parent&&this.parent.forceUpdate(),this._isDisposed=!0)}setDeltaPosition(e){this._deltaPosition.copyFrom(e)}setDeltaRotation(e){this._deltaRotation||(this._deltaRotation=new z),this._deltaRotation.copyFrom(e),this._deltaRotationConjugated=this._deltaRotation.conjugate()}getBoxSizeToRef(e){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().getBoxSizeToRef(this,e),this}getRadius(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getRadius(this):0}syncBoneWithImpostor(e,t,i,r,s){const n=_t._TmpVecs[0],o=this.object;if(o.rotationQuaternion)if(s){const l=_t._TmpQuat;o.rotationQuaternion.multiplyToRef(s,l),e.setRotationQuaternion(l,1,t)}else e.setRotationQuaternion(o.rotationQuaternion,1,t);n.x=0,n.y=0,n.z=0,i&&(n.x=i.x,n.y=i.y,n.z=i.z,e.getDirectionToRef(n,t,n),r==null&&(r=i.length()),n.x*=r,n.y*=r,n.z*=r),e.getParent()?(n.addInPlace(o.getAbsolutePosition()),e.setAbsolutePosition(n,t)):(t.setAbsolutePosition(o.getAbsolutePosition()),t.position.x-=n.x,t.position.y-=n.y,t.position.z-=n.z)}syncImpostorWithBone(e,t,i,r,s,n){const o=this.object;if(o.rotationQuaternion)if(s){const h=_t._TmpQuat;e.getRotationQuaternionToRef(1,t,h),h.multiplyToRef(s,o.rotationQuaternion)}else e.getRotationQuaternionToRef(1,t,o.rotationQuaternion);const l=_t._TmpVecs[0],c=_t._TmpVecs[1];n||(n=_t._TmpVecs[2],n.x=0,n.y=1,n.z=0),e.getDirectionToRef(n,t,c),e.getAbsolutePositionToRef(t,l),r==null&&i&&(r=i.length()),r!=null&&(l.x+=c.x*r,l.y+=c.y*r,l.z+=c.z*r),o.setAbsolutePosition(l)}}_t.DEFAULT_OBJECT_SIZE=new m(1,1,1);_t.IDENTITY_QUATERNION=z.Identity();_t._TmpVecs=Bi(3,m.Zero);_t._TmpQuat=z.Identity();_t.NoImpostor=0;_t.SphereImpostor=1;_t.BoxImpostor=2;_t.PlaneImpostor=3;_t.MeshImpostor=4;_t.CapsuleImpostor=6;_t.CylinderImpostor=7;_t.ParticleImpostor=8;_t.HeightmapImpostor=9;_t.ConvexHullImpostor=10;_t.CustomImpostor=100;_t.RopeImpostor=101;_t.ClothImpostor=102;_t.SoftbodyImpostor=103;function Gg(a){const e=a.sideOrientation||ee.DEFAULTSIDE,t=a.radius||1,i=a.flat===void 0?!0:a.flat,r=(a.subdivisions||4)|0,s=a.radiusX||t,n=a.radiusY||t,o=a.radiusZ||t,l=(1+Math.sqrt(5))/2,c=[-1,l,-0,1,l,0,-1,-l,0,1,-l,0,0,-1,-l,0,1,-l,0,-1,l,0,1,l,l,0,1,l,0,-1,-l,0,1,-l,0,-1],h=[0,11,5,0,5,1,0,1,7,0,7,10,12,22,23,1,5,20,5,11,4,23,22,13,22,18,6,7,1,8,14,21,4,14,4,2,16,13,6,15,6,19,3,8,9,4,21,5,13,17,23,6,13,22,19,6,18,9,8,1],f=[0,1,2,3,4,5,6,7,8,9,10,11,0,2,3,3,3,4,7,8,9,9,10,11],u=[5,1,3,1,6,4,0,0,5,3,4,2,2,2,4,0,2,0,1,1,6,0,6,2,0,4,3,3,4,4,3,1,4,2,4,4,0,2,1,1,2,2,3,3,1,3,2,4],d=138/1024,_=239/1024,p=60/1024,g=26/1024,E=-40/1024,v=20/1024,b=[0,0,0,0,1,0,0,1,1,0,0,0,1,1,0,0,1,1,1,0],R=[],S=[],T=[],I=[];let O=0;const L=new Array(3),w=new Array(3);let $;for($=0;$<3;$++)L[$]=m.Zero(),w[$]=ne.Zero();for(let ce=0;ce<20;ce++){for($=0;$<3;$++){const oe=h[3*ce+$];L[$].copyFromFloats(c[3*f[oe]],c[3*f[oe]+1],c[3*f[oe]+2]),L[$].normalize(),w[$].copyFromFloats(u[2*oe]*d+p+b[ce]*E,u[2*oe+1]*_+g+b[ce]*v)}const le=(oe,ue,Pe,Se)=>{const ie=m.Lerp(L[0],L[2],ue/r),K=m.Lerp(L[1],L[2],ue/r),M=r===ue?L[2]:m.Lerp(ie,K,oe/(r-ue));M.normalize();let V;if(i){const fe=m.Lerp(L[0],L[2],Se/r),me=m.Lerp(L[1],L[2],Se/r);V=m.Lerp(fe,me,Pe/(r-Se))}else V=new m(M.x,M.y,M.z);V.x/=s,V.y/=n,V.z/=o,V.normalize();const re=ne.Lerp(w[0],w[2],ue/r),ve=ne.Lerp(w[1],w[2],ue/r),Be=r===ue?w[2]:ne.Lerp(re,ve,oe/(r-ue));S.push(M.x*s,M.y*n,M.z*o),T.push(V.x,V.y,V.z),I.push(Be.x,Be.y),R.push(O),O++};for(let oe=0;oe<r;oe++)for(let ue=0;ue+oe<r;ue++)le(ue,oe,ue+1/3,oe+1/3),le(ue+1,oe,ue+1/3,oe+1/3),le(ue,oe+1,ue+1/3,oe+1/3),ue+oe+1<r&&(le(ue+1,oe,ue+2/3,oe+2/3),le(ue+1,oe+1,ue+2/3,oe+2/3),le(ue,oe+1,ue+2/3,oe+2/3))}ee._ComputeSides(e,S,R,T,I,a.frontUVs,a.backUVs);const J=new ee;return J.indices=R,J.positions=S,J.normals=T,J.uvs=I,J}function ya(a,e={},t=null){const i=new N(a,t);return e.sideOrientation=N._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,Gg(e).applyToMesh(i,e.updatable),i}ee.CreateIcoSphere=Gg;N.CreateIcoSphere=(a,e,t)=>ya(a,e,t);var Wf;(function(a){a.WRIST="wrist",a.THUMB="thumb",a.INDEX="index",a.MIDDLE="middle",a.RING="ring",a.LITTLE="little"})(Wf||(Wf={}));var Xf;(function(a){a.WRIST="wrist",a.THUMB_METACARPAL="thumb-metacarpal",a.THUMB_PHALANX_PROXIMAL="thumb-phalanx-proximal",a.THUMB_PHALANX_DISTAL="thumb-phalanx-distal",a.THUMB_TIP="thumb-tip",a.INDEX_FINGER_METACARPAL="index-finger-metacarpal",a.INDEX_FINGER_PHALANX_PROXIMAL="index-finger-phalanx-proximal",a.INDEX_FINGER_PHALANX_INTERMEDIATE="index-finger-phalanx-intermediate",a.INDEX_FINGER_PHALANX_DISTAL="index-finger-phalanx-distal",a.INDEX_FINGER_TIP="index-finger-tip",a.MIDDLE_FINGER_METACARPAL="middle-finger-metacarpal",a.MIDDLE_FINGER_PHALANX_PROXIMAL="middle-finger-phalanx-proximal",a.MIDDLE_FINGER_PHALANX_INTERMEDIATE="middle-finger-phalanx-intermediate",a.MIDDLE_FINGER_PHALANX_DISTAL="middle-finger-phalanx-distal",a.MIDDLE_FINGER_TIP="middle-finger-tip",a.RING_FINGER_METACARPAL="ring-finger-metacarpal",a.RING_FINGER_PHALANX_PROXIMAL="ring-finger-phalanx-proximal",a.RING_FINGER_PHALANX_INTERMEDIATE="ring-finger-phalanx-intermediate",a.RING_FINGER_PHALANX_DISTAL="ring-finger-phalanx-distal",a.RING_FINGER_TIP="ring-finger-tip",a.PINKY_FINGER_METACARPAL="pinky-finger-metacarpal",a.PINKY_FINGER_PHALANX_PROXIMAL="pinky-finger-phalanx-proximal",a.PINKY_FINGER_PHALANX_INTERMEDIATE="pinky-finger-phalanx-intermediate",a.PINKY_FINGER_PHALANX_DISTAL="pinky-finger-phalanx-distal",a.PINKY_FINGER_TIP="pinky-finger-tip"})(Xf||(Xf={}));const Ji=["wrist","thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip","index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip","middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip","ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip","pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"],nb={wrist:["wrist"],thumb:["thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip"],index:["index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip"],middle:["middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip"],ring:["ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip"],little:["pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]};class ab{get handMesh(){return this._handMesh}getHandPartMeshes(e){return nb[e].map(t=>this._jointMeshes[Ji.indexOf(t)])}getJointMesh(e){return this._jointMeshes[Ji.indexOf(e)]}constructor(e,t,i,r,s=!1,n=!1,o=1){var l;this.xrController=e,this._jointMeshes=t,this._handMesh=i,this.rigMapping=r,this._leftHandedMeshes=s,this._jointsInvisible=n,this._jointScaleFactor=o,this.onHandMeshSetObservable=new U,this._jointTransforms=new Array(Ji.length),this._jointTransformMatrices=new Float32Array(Ji.length*16),this._tempJointMatrix=new P,this._jointRadii=new Float32Array(Ji.length),this._scene=t[0].getScene();for(let c=0;c<this._jointTransforms.length;c++)this._jointTransforms[c]=new we(Ji[c],this._scene),this._jointTransforms[c].rotationQuaternion=new z,t[c].rotationQuaternion?t[c].rotationQuaternion=new z:(l=t[c].rotationQuaternion)==null||l.set(0,0,0,1);i&&this.setHandMesh(i,r),this.xrController.motionController&&this.xrController.motionController.rootMesh&&this.xrController.motionController.rootMesh.dispose(!1,!0),this.xrController.onMotionControllerInitObservable.add(c=>{c._doNotLoadControllerMesh=!0})}setHandMesh(e,t,i){if(this._handMesh=e,e.alwaysSelectAsActiveMesh=!0,e.getChildMeshes().forEach(r=>{r.alwaysSelectAsActiveMesh=!0}),this._handMesh.skeleton){const r=this._handMesh.skeleton;Ji.forEach((s,n)=>{const o=r.getBoneIndexByName(t?t[s]:s);o!==-1&&r.bones[o].linkTransformNode(this._jointTransforms[n])})}this.onHandMeshSetObservable.notifyObservers(this)}updateFromXRFrame(e,t){const i=this.xrController.inputSource.hand;if(!i)return;const r=i,s=Ji.map(o=>r[o]||i.get(o));let n=!1;if(e.fillPoses&&e.fillJointRadii)n=e.fillPoses(s,t,this._jointTransformMatrices)&&e.fillJointRadii(s,this._jointRadii);else if(e.getJointPose){n=!0;for(let o=0;o<s.length;o++){const l=e.getJointPose(s[o],t);if(l)this._jointTransformMatrices.set(l.transform.matrix,o*16),this._jointRadii[o]=l.radius||.008;else{n=!1;break}}}n&&(Ji.forEach((o,l)=>{const c=this._jointTransforms[l];P.FromArrayToRef(this._jointTransformMatrices,l*16,this._tempJointMatrix),this._tempJointMatrix.decompose(void 0,c.rotationQuaternion,c.position);const h=this._jointRadii[l]*this._jointScaleFactor,f=this._jointMeshes[l];f.isVisible=!this._handMesh&&!this._jointsInvisible,f.position.copyFrom(c.position),f.rotationQuaternion.copyFrom(c.rotationQuaternion),f.scaling.setAll(h),this._scene.useRightHandedSystem||(f.position.z*=-1,f.rotationQuaternion.z*=-1,f.rotationQuaternion.w*=-1,this._leftHandedMeshes&&this._handMesh&&(c.position.z*=-1,c.rotationQuaternion.z*=-1,c.rotationQuaternion.w*=-1))}),this._handMesh&&(this._handMesh.isVisible=!0))}dispose(e=!1){var t;this._handMesh&&(e?((t=this._handMesh.skeleton)==null||t.dispose(),this._handMesh.dispose(!1,!0)):this._handMesh.isVisible=!1),this._jointTransforms.forEach(i=>i.dispose()),this._jointTransforms.length=0,this.onHandMeshSetObservable.clear()}}class Qe extends lo{static _GenerateTrackedJointMeshes(e,t=ya("jointParent",Qe._ICOSPHERE_PARAMS)){const i={};return["left","right"].map(r=>{var n,o,l,c;const s=[];t.isVisible=!!((n=e.jointMeshes)!=null&&n.keepOriginalVisible);for(let h=0;h<Ji.length;++h){let f=t.createInstance(`${r}-handJoint-${h}`);if((o=e.jointMeshes)!=null&&o.onHandJointMeshGenerated){const u=e.jointMeshes.onHandJointMeshGenerated(f,h,r);u&&u!==f&&(f.dispose(),f=u)}if(f.isPickable=!1,(l=e.jointMeshes)!=null&&l.enablePhysics){const u=((c=e.jointMeshes)==null?void 0:c.physicsProps)||{};f.scaling.setAll(.02);const d=u.impostorType!==void 0?u.impostorType:_t.SphereImpostor;f.physicsImpostor=new _t(f,d,{mass:0,...u})}f.rotationQuaternion=new z,f.isVisible=!1,s.push(f)}i[r]=s}),{left:i.left,right:i.right}}static _GenerateDefaultHandMeshesAsync(e,t,i){return new Promise(async r=>{var _,p,g,E,v,b;const s={};(p=(_=Qe._RightHandGLB)==null?void 0:_.meshes[1])!=null&&p.isDisposed()&&(Qe._RightHandGLB=null),(E=(g=Qe._LeftHandGLB)==null?void 0:g.meshes[1])!=null&&E.isDisposed()&&(Qe._LeftHandGLB=null);const n=!!(Qe._RightHandGLB&&Qe._LeftHandGLB),o=k.GetAssetUrl(Qe.DEFAULT_HAND_MODEL_BASE_URL),l=await Promise.all([Qe._RightHandGLB||wr.ImportMeshAsync("",o,Qe.DEFAULT_HAND_MODEL_RIGHT_FILENAME,e),Qe._LeftHandGLB||wr.ImportMeshAsync("",o,Qe.DEFAULT_HAND_MODEL_LEFT_FILENAME,e)]);Qe._RightHandGLB=l[0],Qe._LeftHandGLB=l[1];const c=k.GetAssetUrl(Qe.DEFAULT_HAND_MODEL_SHADER_URL),h=await Et.ParseFromFileAsync("handShader",c,e,void 0,!0);h.needDepthPrePass=!0,h.transparencyMode=q.MATERIAL_ALPHABLEND,h.alphaMode=2,h.build(!1);const f={base:ae.FromInts(116,63,203),fresnel:ae.FromInts(149,102,229),fingerColor:ae.FromInts(177,130,255),tipFresnel:ae.FromInts(220,200,255),...(v=i==null?void 0:i.handMeshes)==null?void 0:v.customColors},u={base:h.getBlockByName("baseColor"),fresnel:h.getBlockByName("fresnelColor"),fingerColor:h.getBlockByName("fingerColor"),tipFresnel:h.getBlockByName("tipFresnelColor")};u.base.value=f.base,u.fresnel.value=f.fresnel,u.fingerColor.value=f.fingerColor,u.tipFresnel.value=f.tipFresnel;const d=(b=t._getBaseLayerWrapper())==null?void 0:b.isMultiview;["left","right"].forEach(R=>{var I;const S=R=="left"?Qe._LeftHandGLB:Qe._RightHandGLB;if(!S)throw new Error("Could not load hand model");const T=S.meshes[1];T._internalAbstractMeshDataInfo._computeBonesUsingShaders=!0,!d&&!((I=i==null?void 0:i.handMeshes)!=null&&I.disableHandShader)&&(T.material=h.clone(`${R}HandShaderClone`,!0)),T.isVisible=!1,s[R]=T,!n&&!e.useRightHandedSystem&&S.meshes[1].rotate(Vi.Y,Math.PI)}),h.dispose(),r({left:s.left,right:s.right})})}static _GenerateDefaultHandMeshRigMapping(e){const t=e=="right"?"R":"L";return{wrist:`wrist_${t}`,"thumb-metacarpal":`thumb_metacarpal_${t}`,"thumb-phalanx-proximal":`thumb_proxPhalanx_${t}`,"thumb-phalanx-distal":`thumb_distPhalanx_${t}`,"thumb-tip":`thumb_tip_${t}`,"index-finger-metacarpal":`index_metacarpal_${t}`,"index-finger-phalanx-proximal":`index_proxPhalanx_${t}`,"index-finger-phalanx-intermediate":`index_intPhalanx_${t}`,"index-finger-phalanx-distal":`index_distPhalanx_${t}`,"index-finger-tip":`index_tip_${t}`,"middle-finger-metacarpal":`middle_metacarpal_${t}`,"middle-finger-phalanx-proximal":`middle_proxPhalanx_${t}`,"middle-finger-phalanx-intermediate":`middle_intPhalanx_${t}`,"middle-finger-phalanx-distal":`middle_distPhalanx_${t}`,"middle-finger-tip":`middle_tip_${t}`,"ring-finger-metacarpal":`ring_metacarpal_${t}`,"ring-finger-phalanx-proximal":`ring_proxPhalanx_${t}`,"ring-finger-phalanx-intermediate":`ring_intPhalanx_${t}`,"ring-finger-phalanx-distal":`ring_distPhalanx_${t}`,"ring-finger-tip":`ring_tip_${t}`,"pinky-finger-metacarpal":`little_metacarpal_${t}`,"pinky-finger-phalanx-proximal":`little_proxPhalanx_${t}`,"pinky-finger-phalanx-intermediate":`little_intPhalanx_${t}`,"pinky-finger-phalanx-distal":`little_distPhalanx_${t}`,"pinky-finger-tip":`little_tip_${t}`}}isCompatible(){return typeof XRHand<"u"}getHandByControllerId(e){return this._attachedHands[e]}getHandByHandedness(e){return e=="none"?null:this._trackingHands[e]}constructor(e,t){super(e),this.options=t,this._attachedHands={},this._trackingHands={left:null,right:null},this._handResources={jointMeshes:null,handMeshes:null,rigMappings:null},this._worldScaleObserver=null,this.onHandAddedObservable=new U,this.onHandRemovedObservable=new U,this._attachHand=s=>{var l,c,h;if(!s.inputSource.hand||s.inputSource.handedness=="none"||!this._handResources.jointMeshes)return;const n=s.inputSource.handedness,o=new ab(s,this._handResources.jointMeshes[n],this._handResources.handMeshes&&this._handResources.handMeshes[n],this._handResources.rigMappings&&this._handResources.rigMappings[n],(l=this.options.handMeshes)==null?void 0:l.meshesUseLeftHandedCoordinates,(c=this.options.jointMeshes)==null?void 0:c.invisible,(h=this.options.jointMeshes)==null?void 0:h.scaleFactor);this._attachedHands[s.uniqueId]=o,this._trackingHands[n]=o,this.onHandAddedObservable.notifyObservers(o)},this._detachHand=s=>{this._detachHandById(s.uniqueId)},this.xrNativeFeatureName="hand-tracking";const r=t.jointMeshes;if(r&&(typeof r.disableDefaultHandMesh<"u"&&(t.handMeshes=t.handMeshes||{},t.handMeshes.disableDefaultMeshes=r.disableDefaultHandMesh),typeof r.handMeshes<"u"&&(t.handMeshes=t.handMeshes||{},t.handMeshes.customMeshes=r.handMeshes),typeof r.leftHandedSystemMeshes<"u"&&(t.handMeshes=t.handMeshes||{},t.handMeshes.meshesUseLeftHandedCoordinates=r.leftHandedSystemMeshes),typeof r.rigMapping<"u")){t.handMeshes=t.handMeshes||{};const s={},n={};[[r.rigMapping.left,s],[r.rigMapping.right,n]].forEach(o=>{const l=o[0],c=o[1];l.forEach((h,f)=>{c[Ji[f]]=h})}),t.handMeshes.customRigMappings={left:s,right:n}}}attach(){var e,t,i,r,s;return super.attach()?(this._handResources.jointMeshes||(this._originalMesh=this._originalMesh||((e=this.options.jointMeshes)==null?void 0:e.sourceMesh)||ya("jointParent",Qe._ICOSPHERE_PARAMS),this._originalMesh.isVisible=!1,this._handResources.jointMeshes=Qe._GenerateTrackedJointMeshes(this.options,this._originalMesh)),this._handResources.handMeshes=((t=this.options.handMeshes)==null?void 0:t.customMeshes)||null,this._handResources.rigMappings=((i=this.options.handMeshes)==null?void 0:i.customRigMappings)||null,!((r=this.options.handMeshes)!=null&&r.customMeshes)&&!((s=this.options.handMeshes)!=null&&s.disableDefaultMeshes)&&(Qe._GenerateDefaultHandMeshesAsync(Re.LastCreatedScene,this._xrSessionManager,this.options).then(n=>{var o,l;this._handResources.handMeshes=n,this._handResources.rigMappings={left:Qe._GenerateDefaultHandMeshRigMapping("left"),right:Qe._GenerateDefaultHandMeshRigMapping("right")},(o=this._trackingHands.left)==null||o.setHandMesh(this._handResources.handMeshes.left,this._handResources.rigMappings.left,this._xrSessionManager),(l=this._trackingHands.right)==null||l.setHandMesh(this._handResources.handMeshes.right,this._handResources.rigMappings.right,this._xrSessionManager),this._handResources.handMeshes.left.scaling.setAll(this._xrSessionManager.worldScalingFactor),this._handResources.handMeshes.right.scaling.setAll(this._xrSessionManager.worldScalingFactor)}),this._worldScaleObserver=this._xrSessionManager.onWorldScaleFactorChangedObservable.add(n=>{this._handResources.handMeshes&&(this._handResources.handMeshes.left.scaling.scaleInPlace(n.newScaleFactor/n.previousScaleFactor),this._handResources.handMeshes.right.scaling.scaleInPlace(n.newScaleFactor/n.previousScaleFactor))})),this.options.xrInput.controllers.forEach(this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerAddedObservable,this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerRemovedObservable,this._detachHand),!0):!1}_onXRFrame(e){var t,i;(t=this._trackingHands.left)==null||t.updateFromXRFrame(e,this._xrSessionManager.referenceSpace),(i=this._trackingHands.right)==null||i.updateFromXRFrame(e,this._xrSessionManager.referenceSpace)}_detachHandById(e,t){var r;const i=this.getHandByControllerId(e);if(i){const s=i.xrController.inputSource.handedness=="left"?"left":"right";((r=this._trackingHands[s])==null?void 0:r.xrController.uniqueId)===e&&(this._trackingHands[s]=null),this.onHandRemovedObservable.notifyObservers(i),i.dispose(t),delete this._attachedHands[e]}}detach(){var e,t,i,r;return super.detach()?(Object.keys(this._attachedHands).forEach(s=>{var n;return this._detachHandById(s,(n=this.options.handMeshes)==null?void 0:n.disposeOnSessionEnd)}),(e=this.options.handMeshes)!=null&&e.disposeOnSessionEnd&&(this._handResources.jointMeshes&&(this._handResources.jointMeshes.left.forEach(s=>s.dispose()),this._handResources.jointMeshes.right.forEach(s=>s.dispose()),this._handResources.jointMeshes=null),this._handResources.handMeshes&&(this._handResources.handMeshes.left.dispose(),this._handResources.handMeshes.right.dispose(),this._handResources.handMeshes=null),(t=Qe._RightHandGLB)==null||t.meshes.forEach(s=>s.dispose()),(i=Qe._LeftHandGLB)==null||i.meshes.forEach(s=>s.dispose()),Qe._RightHandGLB=null,Qe._LeftHandGLB=null,(r=this._originalMesh)==null||r.dispose(),this._originalMesh=void 0),this._worldScaleObserver&&this._xrSessionManager.onWorldScaleFactorChangedObservable.remove(this._worldScaleObserver),!0):!1}dispose(){var e,t,i;super.dispose(),this.onHandAddedObservable.clear(),this.onHandRemovedObservable.clear(),this._handResources.handMeshes&&!((e=this.options.handMeshes)!=null&&e.customMeshes)&&(this._handResources.handMeshes.left.dispose(),this._handResources.handMeshes.right.dispose(),(t=Qe._RightHandGLB)==null||t.meshes.forEach(r=>r.dispose()),(i=Qe._LeftHandGLB)==null||i.meshes.forEach(r=>r.dispose()),Qe._RightHandGLB=null,Qe._LeftHandGLB=null),this._handResources.jointMeshes&&(this._handResources.jointMeshes.left.forEach(r=>r.dispose()),this._handResources.jointMeshes.right.forEach(r=>r.dispose()))}}Qe.Name=St.HAND_TRACKING;Qe.Version=1;Qe.DEFAULT_HAND_MODEL_BASE_URL="https://assets.babylonjs.com/core/HandMeshes/";Qe.DEFAULT_HAND_MODEL_RIGHT_FILENAME="r_hand_rhs.glb";Qe.DEFAULT_HAND_MODEL_LEFT_FILENAME="l_hand_rhs.glb";Qe.DEFAULT_HAND_MODEL_SHADER_URL="https://assets.babylonjs.com/core/HandMeshes/handsShader.json";Qe._ICOSPHERE_PARAMS={radius:.5,flat:!1,subdivisions:2};Qe._RightHandGLB=null;Qe._LeftHandGLB=null;Yi.AddWebXRFeature(Qe.Name,(a,e)=>()=>new Qe(a,e),Qe.Version,!1);N._instancedMeshFactory=(a,e)=>{const t=new ho(a,e);if(e.instancedBuffers){t.instancedBuffers={};for(const i in e.instancedBuffers)t.instancedBuffers[i]=e.instancedBuffers[i]}return t};class ho extends ei{constructor(e,t){super(e,t.getScene()),this._indexInSourceMeshInstanceArray=-1,this._distanceToCamera=0,t.addInstance(this),this._sourceMesh=t,this._unIndexed=t._unIndexed,this.position.copyFrom(t.position),this.rotation.copyFrom(t.rotation),this.scaling.copyFrom(t.scaling),t.rotationQuaternion&&(this.rotationQuaternion=t.rotationQuaternion.clone()),this.animations=t.animations.slice();for(const i of t.getAnimationRanges())i!=null&&this.createAnimationRange(i.name,i.from,i.to);this.infiniteDistance=t.infiniteDistance,this.setPivotMatrix(t.getPivotMatrix()),this.refreshBoundingInfo(!0,!0),this._syncSubMeshes()}getClassName(){return"InstancedMesh"}get lightSources(){return this._sourceMesh._lightSources}_resyncLightSources(){}_resyncLightSource(){}_removeLightSource(){}get receiveShadows(){return this._sourceMesh.receiveShadows}set receiveShadows(e){var t;((t=this._sourceMesh)==null?void 0:t.receiveShadows)!==e&&k.Warn("Setting receiveShadows on an instanced mesh has no effect")}get material(){return this._sourceMesh.material}set material(e){var t;((t=this._sourceMesh)==null?void 0:t.material)!==e&&k.Warn("Setting material on an instanced mesh has no effect")}get visibility(){return this._sourceMesh.visibility}set visibility(e){var t;((t=this._sourceMesh)==null?void 0:t.visibility)!==e&&k.Warn("Setting visibility on an instanced mesh has no effect")}get skeleton(){return this._sourceMesh.skeleton}set skeleton(e){var t;((t=this._sourceMesh)==null?void 0:t.skeleton)!==e&&k.Warn("Setting skeleton on an instanced mesh has no effect")}get renderingGroupId(){return this._sourceMesh.renderingGroupId}set renderingGroupId(e){!this._sourceMesh||e===this._sourceMesh.renderingGroupId||B.Warn("Note - setting renderingGroupId of an instanced mesh has no effect on the scene")}getTotalVertices(){return this._sourceMesh?this._sourceMesh.getTotalVertices():0}getTotalIndices(){return this._sourceMesh.getTotalIndices()}get sourceMesh(){return this._sourceMesh}get geometry(){return this._sourceMesh._geometry}createInstance(e){return this._sourceMesh.createInstance(e)}isReady(e=!1){return this._sourceMesh.isReady(e,!0)}getVerticesData(e,t,i){return this._sourceMesh.getVerticesData(e,t,i)}copyVerticesData(e,t){this._sourceMesh.copyVerticesData(e,t)}setVerticesData(e,t,i,r){return this.sourceMesh&&this.sourceMesh.setVerticesData(e,t,i,r),this.sourceMesh}updateVerticesData(e,t,i,r){return this.sourceMesh&&this.sourceMesh.updateVerticesData(e,t,i,r),this.sourceMesh}setIndices(e,t=null){return this.sourceMesh&&this.sourceMesh.setIndices(e,t),this.sourceMesh}isVerticesDataPresent(e){return this._sourceMesh.isVerticesDataPresent(e)}getIndices(){return this._sourceMesh.getIndices()}get _positions(){return this._sourceMesh._positions}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;let i;typeof e=="object"?i=e:i={applySkeleton:e,applyMorph:t};const r=this._sourceMesh.geometry?this._sourceMesh.geometry.boundingBias:null;return this._refreshBoundingInfo(this._sourceMesh._getData(i,null,x.PositionKind),r),this}_preActivate(){return this._currentLOD&&this._currentLOD._preActivate(),this}_activate(e,t){if(super._activate(e,t),this._sourceMesh.subMeshes||B.Warn("Instances should only be created for meshes with geometry."),this._currentLOD){if(this._currentLOD._getWorldMatrixDeterminant()>=0!=this._getWorldMatrixDeterminant()>=0)return this._internalAbstractMeshDataInfo._actAsRegularMesh=!0,!0;if(this._internalAbstractMeshDataInfo._actAsRegularMesh=!1,this._currentLOD._registerInstanceForRenderId(this,e),t){if(!this._currentLOD._internalAbstractMeshDataInfo._isActiveIntermediate)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!0,!0}else if(!this._currentLOD._internalAbstractMeshDataInfo._isActive)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstances=!0,!0}return!1}_postActivate(){this._sourceMesh.edgesShareWithInstances&&this._sourceMesh._edgesRenderer&&this._sourceMesh._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup?(this._sourceMesh._renderingGroup._edgesRenderers.pushNoDuplicate(this._sourceMesh._edgesRenderer),this._sourceMesh._edgesRenderer.customInstances.push(this.getWorldMatrix())):this._edgesRenderer&&this._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup&&this._sourceMesh._renderingGroup._edgesRenderers.push(this._edgesRenderer)}getWorldMatrix(){if(this._currentLOD&&this._currentLOD.billboardMode!==we.BILLBOARDMODE_NONE&&this._currentLOD._masterMesh!==this){this._billboardWorldMatrix||(this._billboardWorldMatrix=new P);const e=this._currentLOD._masterMesh;return this._currentLOD._masterMesh=this,F.Vector3[7].copyFrom(this._currentLOD.position),this._currentLOD.position.set(0,0,0),this._billboardWorldMatrix.copyFrom(this._currentLOD.computeWorldMatrix(!0)),this._currentLOD.position.copyFrom(F.Vector3[7]),this._currentLOD._masterMesh=e,this._billboardWorldMatrix}return super.getWorldMatrix()}get isAnInstance(){return!0}getLOD(e){if(!e)return this;const t=this.sourceMesh.getLODLevels();if(!t||t.length===0)this._currentLOD=this.sourceMesh;else{const i=this.getBoundingInfo();this._currentLOD=this.sourceMesh.getLOD(e,i.boundingSphere)}return this._currentLOD}_preActivateForIntermediateRendering(e){return this.sourceMesh._preActivateForIntermediateRendering(e)}_syncSubMeshes(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(let e=0;e<this._sourceMesh.subMeshes.length;e++)this._sourceMesh.subMeshes[e].clone(this,this._sourceMesh);return this}_generatePointsArray(){return this._sourceMesh._generatePointsArray()}_updateBoundingInfo(){return this.hasBoundingInfo?this.getBoundingInfo().update(this.worldMatrixFromCache):this.buildBoundingInfo(this.absolutePosition,this.absolutePosition,this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}clone(e,t=null,i,r){const s=(r||this._sourceMesh).createInstance(e);if(Da.DeepCopy(this,s,["name","subMeshes","uniqueId","parent","lightSources","receiveShadows","material","visibility","skeleton","sourceMesh","isAnInstance","facetNb","isFacetDataEnabled","isBlocked","useBones","hasInstances","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","hasBoundingInfo"],[]),this.refreshBoundingInfo(),t&&(s.parent=t),!i)for(let n=0;n<this.getScene().meshes.length;n++){const o=this.getScene().meshes[n];o.parent===this&&o.clone(o.name,s)}return s.computeWorldMatrix(!0),this.onClonedObservable.notifyObservers(s),s}dispose(e,t=!1){this._sourceMesh.removeInstance(this),super.dispose(e,t)}_serializeAsParent(e){super._serializeAsParent(e),e.parentId=this._sourceMesh.uniqueId,e.parentInstanceIndex=this._indexInSourceMeshInstanceArray}instantiateHierarchy(e=null,t,i){const r=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0,t&&t.newSourcedMesh);r&&i&&i(this,r);for(const s of this.getChildTransformNodes(!0))s.instantiateHierarchy(r,t,i);return r}}N.prototype.registerInstancedBuffer=function(a,e){var t,i;if((i=(t=this._userInstancedBuffersStorage)==null?void 0:t.vertexBuffers[a])==null||i.dispose(),!this.instancedBuffers){this.instancedBuffers={};for(const r of this.instances)r.instancedBuffers={}}this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this.instancedBuffers[a]=null,this._userInstancedBuffersStorage.strides[a]=e,this._userInstancedBuffersStorage.sizes[a]=e*32,this._userInstancedBuffersStorage.data[a]=new Float32Array(this._userInstancedBuffersStorage.sizes[a]),this._userInstancedBuffersStorage.vertexBuffers[a]=new x(this.getEngine(),this._userInstancedBuffersStorage.data[a],a,!0,!1,e,!0);for(const r of this.instances)r.instancedBuffers[a]=null;this._invalidateInstanceVertexArrayObject(),this._markSubMeshesAsAttributesDirty()};N.prototype._processInstancedBuffers=function(a,e){const t=a?a.length:0;for(const i in this.instancedBuffers){let r=this._userInstancedBuffersStorage.sizes[i];const s=this._userInstancedBuffersStorage.strides[i],n=(t+1)*s;for(;r<n;)r*=2;this._userInstancedBuffersStorage.data[i].length!=r&&(this._userInstancedBuffersStorage.data[i]=new Float32Array(r),this._userInstancedBuffersStorage.sizes[i]=r,this._userInstancedBuffersStorage.vertexBuffers[i]&&(this._userInstancedBuffersStorage.vertexBuffers[i].dispose(),this._userInstancedBuffersStorage.vertexBuffers[i]=null));const o=this._userInstancedBuffersStorage.data[i];let l=0;if(e){const c=this.instancedBuffers[i];c.toArray?c.toArray(o,l):c.copyToArray?c.copyToArray(o,l):o[l]=c,l+=s}for(let c=0;c<t;c++){const f=a[c].instancedBuffers[i];f.toArray?f.toArray(o,l):f.copyToArray?f.copyToArray(o,l):o[l]=f,l+=s}this._userInstancedBuffersStorage.vertexBuffers[i]?this._userInstancedBuffersStorage.vertexBuffers[i].updateDirectly(o,0):(this._userInstancedBuffersStorage.vertexBuffers[i]=new x(this.getEngine(),this._userInstancedBuffersStorage.data[i],i,!0,!1,s,!0),this._invalidateInstanceVertexArrayObject())}};N.prototype._invalidateInstanceVertexArrayObject=function(){if(!(!this._userInstancedBuffersStorage||this._userInstancedBuffersStorage.vertexArrayObjects===void 0)){for(const a in this._userInstancedBuffersStorage.vertexArrayObjects)this.getEngine().releaseVertexArrayObject(this._userInstancedBuffersStorage.vertexArrayObjects[a]);this._userInstancedBuffersStorage.vertexArrayObjects={}}};N.prototype._disposeInstanceSpecificData=function(){for(this._instanceDataStorage.instancesBuffer&&(this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null);this.instances.length;)this.instances[0].dispose();for(const a in this.instancedBuffers)this._userInstancedBuffersStorage.vertexBuffers[a]&&this._userInstancedBuffersStorage.vertexBuffers[a].dispose();this._invalidateInstanceVertexArrayObject(),this.instancedBuffers={}};Y("BABYLON.InstancedMesh",ho);const qo={effect:null,subMesh:null};class ts extends Un{constructor(e,t,i,r={},s=!0){super(e,t,s),this._textures={},this._textureArrays={},this._externalTextures={},this._floats={},this._ints={},this._uints={},this._floatsArrays={},this._colors3={},this._colors3Arrays={},this._colors4={},this._colors4Arrays={},this._vectors2={},this._vectors3={},this._vectors4={},this._quaternions={},this._quaternionsArrays={},this._matrices={},this._matrixArrays={},this._matrices3x3={},this._matrices2x2={},this._vectors2Arrays={},this._vectors3Arrays={},this._vectors4Arrays={},this._uniformBuffers={},this._textureSamplers={},this._storageBuffers={},this._cachedWorldViewMatrix=new P,this._cachedWorldViewProjectionMatrix=new P,this._multiview=!1,this._materialHelperNeedsPreviousMatrices=!1,this._shaderPath=i,this._options={needAlphaBlending:!1,needAlphaTesting:!1,attributes:["position","normal","uv"],uniforms:["worldViewProjection"],uniformBuffers:[],samplers:[],externalTextures:[],samplerObjects:[],storageBuffers:[],defines:[],useClipPlane:!1,...r}}get shaderPath(){return this._shaderPath}set shaderPath(e){this._shaderPath=e}get options(){return this._options}get isMultiview(){return this._multiview}getClassName(){return"ShaderMaterial"}needAlphaBlending(){return this.alpha<1||this._options.needAlphaBlending}needAlphaTesting(){return this._options.needAlphaTesting}_checkUniform(e){this._options.uniforms.indexOf(e)===-1&&this._options.uniforms.push(e)}setTexture(e,t){return this._options.samplers.indexOf(e)===-1&&this._options.samplers.push(e),this._textures[e]=t,this}removeTexture(e){delete this._textures[e]}setTextureArray(e,t){return this._options.samplers.indexOf(e)===-1&&this._options.samplers.push(e),this._checkUniform(e),this._textureArrays[e]=t,this}setExternalTexture(e,t){return this._options.externalTextures.indexOf(e)===-1&&this._options.externalTextures.push(e),this._externalTextures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setUInt(e,t){return this._checkUniform(e),this._uints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor3Array(e,t){return this._checkUniform(e),this._colors3Arrays[e]=t.reduce((i,r)=>(r.toArray(i,i.length),i),[]),this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setColor4Array(e,t){return this._checkUniform(e),this._colors4Arrays[e]=t.reduce((i,r)=>(r.toArray(i,i.length),i),[]),this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setVector4(e,t){return this._checkUniform(e),this._vectors4[e]=t,this}setQuaternion(e,t){return this._checkUniform(e),this._quaternions[e]=t,this}setQuaternionArray(e,t){return this._checkUniform(e),this._quaternionsArrays[e]=t.reduce((i,r)=>(r.toArray(i,i.length),i),[]),this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}setMatrices(e,t){this._checkUniform(e);const i=new Float32Array(t.length*16);for(let r=0;r<t.length;r++)t[r].copyToArray(i,r*16);return this._matrixArrays[e]=i,this}setMatrix3x3(e,t){return this._checkUniform(e),this._matrices3x3[e]=t,this}setMatrix2x2(e,t){return this._checkUniform(e),this._matrices2x2[e]=t,this}setArray2(e,t){return this._checkUniform(e),this._vectors2Arrays[e]=t,this}setArray3(e,t){return this._checkUniform(e),this._vectors3Arrays[e]=t,this}setArray4(e,t){return this._checkUniform(e),this._vectors4Arrays[e]=t,this}setUniformBuffer(e,t){return this._options.uniformBuffers.indexOf(e)===-1&&this._options.uniformBuffers.push(e),this._uniformBuffers[e]=t,this}setTextureSampler(e,t){return this._options.samplerObjects.indexOf(e)===-1&&this._options.samplerObjects.push(e),this._textureSamplers[e]=t,this}setStorageBuffer(e,t){return this._options.storageBuffers.indexOf(e)===-1&&this._options.storageBuffers.push(e),this._storageBuffers[e]=t,this}setDefine(e,t){const i=e.trimEnd()+" ",r=this.options.defines.findIndex(s=>s===e||s.startsWith(i));return r>=0&&this.options.defines.splice(r,1),(typeof t!="boolean"||t)&&this.options.defines.push(i+t),this}isReadyForSubMesh(e,t,i){return this.isReady(e,i,t)}isReady(e,t,i){const r=i&&this._storeEffectOnSubMeshes;if(this.isFrozen){const S=r?i._drawWrapper:this._drawWrapper;if(S.effect&&S._wasPreviouslyReady&&S._wasPreviouslyUsingInstances===t)return!0}const s=this.getScene(),n=s.getEngine(),o=[],l=[];let c=null,h=this._shaderPath,f=this._options.uniforms,u=this._options.uniformBuffers,d=this._options.samplers;n.getCaps().multiview&&s.activeCamera&&s.activeCamera.outputRenderTarget&&s.activeCamera.outputRenderTarget.getViewCount()>1&&(this._multiview=!0,o.push("#define MULTIVIEW"),f.indexOf("viewProjection")!==-1&&f.indexOf("viewProjectionR")===-1&&f.push("viewProjectionR"));for(let S=0;S<this._options.defines.length;S++){const T=this._options.defines[S].indexOf("#define")===0?this._options.defines[S]:`#define ${this._options.defines[S]}`;o.push(T)}for(let S=0;S<this._options.attributes.length;S++)l.push(this._options.attributes[S]);if(e&&e.isVerticesDataPresent(x.ColorKind)&&(l.indexOf(x.ColorKind)===-1&&l.push(x.ColorKind),o.push("#define VERTEXCOLOR")),t&&(o.push("#define INSTANCES"),wm(l,this._materialHelperNeedsPreviousMatrices),e!=null&&e.hasThinInstances&&(o.push("#define THIN_INSTANCES"),e&&e.isVerticesDataPresent(x.ColorInstanceKind)&&(l.push(x.ColorInstanceKind),o.push("#define INSTANCESCOLOR")))),e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton){l.push(x.MatricesIndicesKind),l.push(x.MatricesWeightsKind),e.numBoneInfluencers>4&&(l.push(x.MatricesIndicesExtraKind),l.push(x.MatricesWeightsExtraKind));const S=e.skeleton;o.push("#define NUM_BONE_INFLUENCERS "+e.numBoneInfluencers),c=new Vn,c.addCPUSkinningFallback(0,e),S.isUsingTextureForMatrices?(o.push("#define BONETEXTURE"),f.indexOf("boneTextureWidth")===-1&&f.push("boneTextureWidth"),this._options.samplers.indexOf("boneSampler")===-1&&this._options.samplers.push("boneSampler")):(o.push("#define BonesPerMesh "+(S.bones.length+1)),f.indexOf("mBones")===-1&&f.push("mBones"))}else o.push("#define NUM_BONE_INFLUENCERS 0");let _=0;const p=e?e.morphTargetManager:null;if(p){const S=o.indexOf("#define UV1")!==-1,T=o.indexOf("#define UV2")!==-1,I=o.indexOf("#define TANGENT")!==-1,O=o.indexOf("#define NORMAL")!==-1,L=o.indexOf("#define VERTEXCOLOR")!==-1;_=fR(p,o,l,e,!0,O,I,S,T,L),p.isUsingTextureForTargets&&(f.indexOf("morphTargetTextureIndices")===-1&&f.push("morphTargetTextureIndices"),this._options.samplers.indexOf("morphTargets")===-1&&this._options.samplers.push("morphTargets")),_>0&&(f=f.slice(),f.push("morphTargetInfluences"),f.push("morphTargetCount"),f.push("morphTargetTextureInfo"),f.push("morphTargetTextureIndices"))}else o.push("#define NUM_MORPH_INFLUENCERS 0");if(e){const S=e.bakedVertexAnimationManager;S&&S.isEnabled&&(o.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),f.indexOf("bakedVertexAnimationSettings")===-1&&f.push("bakedVertexAnimationSettings"),f.indexOf("bakedVertexAnimationTextureSizeInverted")===-1&&f.push("bakedVertexAnimationTextureSizeInverted"),f.indexOf("bakedVertexAnimationTime")===-1&&f.push("bakedVertexAnimationTime"),this._options.samplers.indexOf("bakedVertexAnimationTexture")===-1&&this._options.samplers.push("bakedVertexAnimationTexture")),Cc(l,e,o)}for(const S in this._textures)if(!this._textures[S].isReady())return!1;e&&this.needAlphaTestingForMesh(e)&&o.push("#define ALPHATEST"),this._options.useClipPlane!==!1&&(Ba(f),cR(this,s,o)),s.fogEnabled&&(e!=null&&e.applyFog)&&s.fogMode!==Ge.FOGMODE_NONE&&(o.push("#define FOG"),f.indexOf("view")===-1&&f.push("view"),f.indexOf("vFogInfos")===-1&&f.push("vFogInfos"),f.indexOf("vFogColor")===-1&&f.push("vFogColor")),this._useLogarithmicDepth&&(o.push("#define LOGARITHMICDEPTH"),f.indexOf("logarithmicDepthConstant")===-1&&f.push("logarithmicDepthConstant")),this.customShaderNameResolve&&(f=f.slice(),u=u.slice(),d=d.slice(),h=this.customShaderNameResolve(this.name,f,u,d,o,l));const g=r?i._getDrawWrapper(void 0,!0):this._drawWrapper,E=(g==null?void 0:g.effect)??null,v=(g==null?void 0:g.defines)??null,b=o.join(`
`);let R=E;return v!==b&&(R=n.createEffect(h,{attributes:l,uniformsNames:f,uniformBuffersNames:u,samplers:d,defines:b,fallbacks:c,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousMorphTargets:_},shaderLanguage:this._options.shaderLanguage,extraInitializationsAsync:this._options.extraInitializationsAsync},n),r?i.setEffect(R,b,this._materialContext):g&&g.setEffect(R,b),this._onEffectCreatedObservable&&(qo.effect=R,qo.subMesh=i??(e==null?void 0:e.subMeshes[0])??null,this._onEffectCreatedObservable.notifyObservers(qo))),g._wasPreviouslyUsingInstances=!!t,R!=null&&R.isReady()?(E!==R&&s.resetCachedMaterial(),g._wasPreviouslyReady=!0,!0):!1}bindOnlyWorldMatrix(e,t){const i=t??this.getEffect();if(!i)return;const r=this._options.uniforms;r.indexOf("world")!==-1&&i.setMatrix("world",e);const s=this.getScene();r.indexOf("worldView")!==-1&&(e.multiplyToRef(s.getViewMatrix(),this._cachedWorldViewMatrix),i.setMatrix("worldView",this._cachedWorldViewMatrix)),r.indexOf("worldViewProjection")!==-1&&(e.multiplyToRef(s.getTransformMatrix(),this._cachedWorldViewProjectionMatrix),i.setMatrix("worldViewProjection",this._cachedWorldViewProjectionMatrix)),r.indexOf("view")!==-1&&i.setMatrix("view",s.getViewMatrix())}bindForSubMesh(e,t,i){var r;this.bind(e,t,(r=i._drawWrapperOverride)==null?void 0:r.effect,i)}bind(e,t,i,r){var f;const s=r&&this._storeEffectOnSubMeshes,n=i??(s?r.effect:this.getEffect());if(!n)return;const o=this.getScene();this._activeEffect=n,this.bindOnlyWorldMatrix(e,i);const l=this._options.uniformBuffers;let c=!1;if(n&&l&&l.length>0&&o.getEngine().supportsUniformBuffers)for(let u=0;u<l.length;++u)switch(l[u]){case"Mesh":t&&(t.getMeshUniformBuffer().bindToEffect(n,"Mesh"),t.transferToEffect(e));break;case"Scene":Bm(n,o.getSceneUniformBuffer()),o.finalizeSceneUbo(),c=!0;break}const h=t&&s?this._mustRebind(o,n,r,t.visibility):o.getCachedMaterial()!==this;if(n&&h){!c&&this._options.uniforms.indexOf("view")!==-1&&n.setMatrix("view",o.getViewMatrix()),!c&&this._options.uniforms.indexOf("projection")!==-1&&n.setMatrix("projection",o.getProjectionMatrix()),!c&&this._options.uniforms.indexOf("viewProjection")!==-1&&(n.setMatrix("viewProjection",o.getTransformMatrix()),this._multiview&&n.setMatrix("viewProjectionR",o._transformMatrixR)),o.activeCamera&&this._options.uniforms.indexOf("cameraPosition")!==-1&&n.setVector3("cameraPosition",o.activeCamera.globalPosition),Ga(t,n),Ua(n,this,o),this._useLogarithmicDepth&&Bn(s?r.materialDefines:n.defines,n,o),t&&Va(o,t,n);let u;for(u in this._textures)n.setTexture(u,this._textures[u]);for(u in this._textureArrays)n.setTextureArray(u,this._textureArrays[u]);for(u in this._ints)n.setInt(u,this._ints[u]);for(u in this._uints)n.setUInt(u,this._uints[u]);for(u in this._floats)n.setFloat(u,this._floats[u]);for(u in this._floatsArrays)n.setArray(u,this._floatsArrays[u]);for(u in this._colors3)n.setColor3(u,this._colors3[u]);for(u in this._colors3Arrays)n.setArray3(u,this._colors3Arrays[u]);for(u in this._colors4){const E=this._colors4[u];n.setFloat4(u,E.r,E.g,E.b,E.a)}for(u in this._colors4Arrays)n.setArray4(u,this._colors4Arrays[u]);for(u in this._vectors2)n.setVector2(u,this._vectors2[u]);for(u in this._vectors3)n.setVector3(u,this._vectors3[u]);for(u in this._vectors4)n.setVector4(u,this._vectors4[u]);for(u in this._quaternions)n.setQuaternion(u,this._quaternions[u]);for(u in this._matrices)n.setMatrix(u,this._matrices[u]);for(u in this._matrixArrays)n.setMatrices(u,this._matrixArrays[u]);for(u in this._matrices3x3)n.setMatrix3x3(u,this._matrices3x3[u]);for(u in this._matrices2x2)n.setMatrix2x2(u,this._matrices2x2[u]);for(u in this._vectors2Arrays)n.setArray2(u,this._vectors2Arrays[u]);for(u in this._vectors3Arrays)n.setArray3(u,this._vectors3Arrays[u]);for(u in this._vectors4Arrays)n.setArray4(u,this._vectors4Arrays[u]);for(u in this._quaternionsArrays)n.setArray4(u,this._quaternionsArrays[u]);for(u in this._uniformBuffers){const E=this._uniformBuffers[u].getBuffer();E&&n.bindUniformBuffer(E,u)}const d=o.getEngine(),_=d.setExternalTexture;if(_)for(u in this._externalTextures)_.call(d,u,this._externalTextures[u]);const p=d.setTextureSampler;if(p)for(u in this._textureSamplers)p.call(d,u,this._textureSamplers[u]);const g=d.setStorageBuffer;if(g)for(u in this._storageBuffers)g.call(d,u,this._storageBuffers[u])}if(n&&t&&(h||!this.isFrozen)){Rc(t,n),t.morphTargetManager&&t.morphTargetManager.isUsingTextureForTargets&&t.morphTargetManager._bind(n);const u=t.bakedVertexAnimationManager;if(u&&u.isEnabled){const d=s?r._drawWrapper:this._drawWrapper;(f=t.bakedVertexAnimationManager)==null||f.bind(n,!!d._wasPreviouslyUsingInstances)}}this._afterBind(t,n,r)}getActiveTextures(){const e=super.getActiveTextures();for(const t in this._textures)e.push(this._textures[t]);for(const t in this._textureArrays){const i=this._textureArrays[t];for(let r=0;r<i.length;r++)e.push(i[r])}return e}hasTexture(e){if(super.hasTexture(e))return!0;for(const t in this._textures)if(this._textures[t]===e)return!0;for(const t in this._textureArrays){const i=this._textureArrays[t];for(let r=0;r<i.length;r++)if(i[r]===e)return!0}return!1}clone(e){const t=ye.Clone(()=>new ts(e,this.getScene(),this._shaderPath,this._options,this._storeEffectOnSubMeshes),this);t.name=e,t.id=e,typeof t._shaderPath=="object"&&(t._shaderPath={...t._shaderPath}),this._options={...this._options},Object.keys(this._options).forEach(i=>{const r=this._options[i];Array.isArray(r)&&(this._options[i]=r.slice(0))}),this.stencil.copyTo(t.stencil);for(const i in this._textures)t.setTexture(i,this._textures[i]);for(const i in this._textureArrays)t.setTextureArray(i,this._textureArrays[i]);for(const i in this._externalTextures)t.setExternalTexture(i,this._externalTextures[i]);for(const i in this._ints)t.setInt(i,this._ints[i]);for(const i in this._uints)t.setUInt(i,this._uints[i]);for(const i in this._floats)t.setFloat(i,this._floats[i]);for(const i in this._floatsArrays)t.setFloats(i,this._floatsArrays[i]);for(const i in this._colors3)t.setColor3(i,this._colors3[i]);for(const i in this._colors3Arrays)t._colors3Arrays[i]=this._colors3Arrays[i];for(const i in this._colors4)t.setColor4(i,this._colors4[i]);for(const i in this._colors4Arrays)t._colors4Arrays[i]=this._colors4Arrays[i];for(const i in this._vectors2)t.setVector2(i,this._vectors2[i]);for(const i in this._vectors3)t.setVector3(i,this._vectors3[i]);for(const i in this._vectors4)t.setVector4(i,this._vectors4[i]);for(const i in this._quaternions)t.setQuaternion(i,this._quaternions[i]);for(const i in this._quaternionsArrays)t._quaternionsArrays[i]=this._quaternionsArrays[i];for(const i in this._matrices)t.setMatrix(i,this._matrices[i]);for(const i in this._matrixArrays)t._matrixArrays[i]=this._matrixArrays[i].slice();for(const i in this._matrices3x3)t.setMatrix3x3(i,this._matrices3x3[i]);for(const i in this._matrices2x2)t.setMatrix2x2(i,this._matrices2x2[i]);for(const i in this._vectors2Arrays)t.setArray2(i,this._vectors2Arrays[i]);for(const i in this._vectors3Arrays)t.setArray3(i,this._vectors3Arrays[i]);for(const i in this._vectors4Arrays)t.setArray4(i,this._vectors4Arrays[i]);for(const i in this._uniformBuffers)t.setUniformBuffer(i,this._uniformBuffers[i]);for(const i in this._textureSamplers)t.setTextureSampler(i,this._textureSamplers[i]);for(const i in this._storageBuffers)t.setStorageBuffer(i,this._storageBuffers[i]);return t}dispose(e,t,i){if(t){let r;for(r in this._textures)this._textures[r].dispose();for(r in this._textureArrays){const s=this._textureArrays[r];for(let n=0;n<s.length;n++)s[n].dispose()}}this._textures={},super.dispose(e,t,i)}serialize(){const e=ye.Serialize(this);e.customType="BABYLON.ShaderMaterial",e.uniqueId=this.uniqueId,e.options=this._options,e.shaderPath=this._shaderPath,e.storeEffectOnSubMeshes=this._storeEffectOnSubMeshes;let t;e.stencil=this.stencil.serialize(),e.textures={};for(t in this._textures)e.textures[t]=this._textures[t].serialize();e.textureArrays={};for(t in this._textureArrays){e.textureArrays[t]=[];const i=this._textureArrays[t];for(let r=0;r<i.length;r++)e.textureArrays[t].push(i[r].serialize())}e.ints={};for(t in this._ints)e.ints[t]=this._ints[t];e.uints={};for(t in this._uints)e.uints[t]=this._uints[t];e.floats={};for(t in this._floats)e.floats[t]=this._floats[t];e.floatsArrays={};for(t in this._floatsArrays)e.floatsArrays[t]=this._floatsArrays[t];e.colors3={};for(t in this._colors3)e.colors3[t]=this._colors3[t].asArray();e.colors3Arrays={};for(t in this._colors3Arrays)e.colors3Arrays[t]=this._colors3Arrays[t];e.colors4={};for(t in this._colors4)e.colors4[t]=this._colors4[t].asArray();e.colors4Arrays={};for(t in this._colors4Arrays)e.colors4Arrays[t]=this._colors4Arrays[t];e.vectors2={};for(t in this._vectors2){const i=this._vectors2[t];e.vectors2[t]=[i.x,i.y]}e.vectors3={};for(t in this._vectors3){const i=this._vectors3[t];e.vectors3[t]=[i.x,i.y,i.z]}e.vectors4={};for(t in this._vectors4){const i=this._vectors4[t];e.vectors4[t]=[i.x,i.y,i.z,i.w]}e.quaternions={};for(t in this._quaternions)e.quaternions[t]=this._quaternions[t].asArray();e.matrices={};for(t in this._matrices)e.matrices[t]=this._matrices[t].asArray();e.matrixArray={};for(t in this._matrixArrays)e.matrixArray[t]=this._matrixArrays[t];e.matrices3x3={};for(t in this._matrices3x3)e.matrices3x3[t]=this._matrices3x3[t];e.matrices2x2={};for(t in this._matrices2x2)e.matrices2x2[t]=this._matrices2x2[t];e.vectors2Arrays={};for(t in this._vectors2Arrays)e.vectors2Arrays[t]=this._vectors2Arrays[t];e.vectors3Arrays={};for(t in this._vectors3Arrays)e.vectors3Arrays[t]=this._vectors3Arrays[t];e.vectors4Arrays={};for(t in this._vectors4Arrays)e.vectors4Arrays[t]=this._vectors4Arrays[t];e.quaternionsArrays={};for(t in this._quaternionsArrays)e.quaternionsArrays[t]=this._quaternionsArrays[t];return e}static Parse(e,t,i){const r=ye.Parse(()=>new ts(e.name,t,e.shaderPath,e.options,e.storeEffectOnSubMeshes),e,t,i);let s;e.stencil&&r.stencil.parse(e.stencil,t,i);for(s in e.textures)r.setTexture(s,Z.Parse(e.textures[s],t,i));for(s in e.textureArrays){const n=e.textureArrays[s],o=[];for(let l=0;l<n.length;l++)o.push(Z.Parse(n[l],t,i));r.setTextureArray(s,o)}for(s in e.ints)r.setInt(s,e.ints[s]);for(s in e.uints)r.setUInt(s,e.uints[s]);for(s in e.floats)r.setFloat(s,e.floats[s]);for(s in e.floatsArrays)r.setFloats(s,e.floatsArrays[s]);for(s in e.colors3)r.setColor3(s,ae.FromArray(e.colors3[s]));for(s in e.colors3Arrays){const n=e.colors3Arrays[s].reduce((o,l,c)=>(c%3===0?o.push([l]):o[o.length-1].push(l),o),[]).map(o=>ae.FromArray(o));r.setColor3Array(s,n)}for(s in e.colors4)r.setColor4(s,Ne.FromArray(e.colors4[s]));for(s in e.colors4Arrays){const n=e.colors4Arrays[s].reduce((o,l,c)=>(c%4===0?o.push([l]):o[o.length-1].push(l),o),[]).map(o=>Ne.FromArray(o));r.setColor4Array(s,n)}for(s in e.vectors2)r.setVector2(s,ne.FromArray(e.vectors2[s]));for(s in e.vectors3)r.setVector3(s,m.FromArray(e.vectors3[s]));for(s in e.vectors4)r.setVector4(s,Fe.FromArray(e.vectors4[s]));for(s in e.quaternions)r.setQuaternion(s,z.FromArray(e.quaternions[s]));for(s in e.matrices)r.setMatrix(s,P.FromArray(e.matrices[s]));for(s in e.matrixArray)r._matrixArrays[s]=new Float32Array(e.matrixArray[s]);for(s in e.matrices3x3)r.setMatrix3x3(s,e.matrices3x3[s]);for(s in e.matrices2x2)r.setMatrix2x2(s,e.matrices2x2[s]);for(s in e.vectors2Arrays)r.setArray2(s,e.vectors2Arrays[s]);for(s in e.vectors3Arrays)r.setArray3(s,e.vectors3Arrays[s]);for(s in e.vectors4Arrays)r.setArray4(s,e.vectors4Arrays[s]);for(s in e.quaternionsArrays)r.setArray4(s,e.quaternionsArrays[s]);return r}static ParseFromFileAsync(e,t,i,r=""){return new Promise((s,n)=>{const o=new Gt;o.addEventListener("readystatechange",()=>{if(o.readyState==4)if(o.status==200){const l=JSON.parse(o.responseText),c=this.Parse(l,i||Re.LastCreatedScene,r);e&&(c.name=e),s(c)}else n("Unable to load the ShaderMaterial")}),o.open("GET",t),o.send()})}static ParseFromSnippetAsync(e,t,i=""){return new Promise((r,s)=>{const n=new Gt;n.addEventListener("readystatechange",()=>{if(n.readyState==4)if(n.status==200){const o=JSON.parse(JSON.parse(n.responseText).jsonPayload),l=JSON.parse(o.shaderMaterial),c=this.Parse(l,t||Re.LastCreatedScene,i);c.snippetId=e,r(c)}else s("Unable to load the snippet "+e)}),n.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),n.send()})}}ts.SnippetUrl="https://snippet.babylonjs.com";ts.CreateFromSnippetAsync=ts.ParseFromSnippetAsync;Y("BABYLON.ShaderMaterial",ts);N._LinesMeshParser=(a,e)=>$r.Parse(a,e);class $r extends N{_isShaderMaterial(e){return e.getClassName()==="ShaderMaterial"}constructor(e,t=null,i=null,r=null,s,n,o,l){super(e,t,i,r,s),this.useVertexColor=n,this.useVertexAlpha=o,this.color=new ae(1,1,1),this.alpha=1,this._shaderLanguage=0,r&&(this.color=r.color.clone(),this.alpha=r.alpha,this.useVertexColor=r.useVertexColor,this.useVertexAlpha=r.useVertexAlpha),this.intersectionThreshold=.1;const c=[],h={attributes:[x.PositionKind],uniforms:["world","viewProjection"],needAlphaBlending:!0,defines:c,useClipPlane:null,shaderLanguage:0};this.useVertexAlpha?h.defines.push("#define VERTEXALPHA"):h.needAlphaBlending=!1,this.useVertexColor?(h.defines.push("#define VERTEXCOLOR"),h.attributes.push(x.ColorKind)):(h.uniforms.push("color"),this._color4=new Ne),l?this.material=l:(this.getScene().getEngine().isWebGPU&&!$r.ForceGLSL&&(this._shaderLanguage=1),h.shaderLanguage=this._shaderLanguage,h.extraInitializationsAsync=async()=>{this._shaderLanguage===1?await Promise.all([X(()=>Promise.resolve().then(()=>RD),void 0,import.meta.url),X(()=>Promise.resolve().then(()=>ID),void 0,import.meta.url)]):await Promise.all([X(()=>Promise.resolve().then(()=>xD),void 0,import.meta.url),X(()=>Promise.resolve().then(()=>MD),void 0,import.meta.url)])},this.material=new ts("colorShader",this.getScene(),"color",h,!1),this.material.doNotSerialize=!0)}isReady(){return this._lineMaterial.isReady(this,!!this._userInstancedBuffersStorage||this.hasThinInstances)?super.isReady():!1}getClassName(){return"LinesMesh"}get material(){return this._lineMaterial}set material(e){this._lineMaterial=e,this._lineMaterial.fillMode=q.LineListDrawMode}get checkCollisions(){return!1}set checkCollisions(e){}_bind(e,t){if(!this._geometry)return this;const i=this.isUnIndexed?null:this._geometry.getIndexBuffer();if(!this._userInstancedBuffersStorage||this.hasThinInstances?this._geometry._bind(t,i):this._geometry._bind(t,i,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects),!this.useVertexColor&&this._isShaderMaterial(this._lineMaterial)){const{r,g:s,b:n}=this.color;this._color4.set(r,s,n,this.alpha),this._lineMaterial.setColor4("color",this._color4)}return this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;const r=this.getScene().getEngine();return this._unIndexed?r.drawArraysType(q.LineListDrawMode,e.verticesStart,e.verticesCount,i):r.drawElementsType(q.LineListDrawMode,e.indexStart,e.indexCount,i),this}dispose(e,t=!1,i){i||this._lineMaterial.dispose(!1,!1,!0),super.dispose(e)}clone(e,t=null,i){return new $r(e,this.getScene(),t,this,i)}createInstance(e){const t=new ob(e,this);if(this.instancedBuffers){t.instancedBuffers={};for(const i in this.instancedBuffers)t.instancedBuffers[i]=this.instancedBuffers[i]}return t}serialize(e){super.serialize(e),e.color=this.color.asArray(),e.alpha=this.alpha}static Parse(e,t){const i=new $r(e.name,t);return i.color=ae.FromArray(e.color),i.alpha=e.alpha,i}}$r.ForceGLSL=!1;class ob extends ho{constructor(e,t){super(e,t),this.intersectionThreshold=t.intersectionThreshold}getClassName(){return"InstancedLinesMesh"}}function kg(a){const e=[],t=[],i=a.lines,r=a.colors,s=[];let n=0;for(let l=0;l<i.length;l++){const c=i[l];for(let h=0;h<c.length;h++){const{x:f,y:u,z:d}=c[h];if(t.push(f,u,d),r){const _=r[l],{r:p,g,b:E,a:v}=_[h];s.push(p,g,E,v)}h>0&&(e.push(n-1),e.push(n)),n++}}const o=new ee;return o.indices=e,o.positions=t,r&&(o.colors=s),o}function Wg(a){const e=a.dashSize||3,t=a.gapSize||1,i=a.dashNb||200,r=a.points,s=[],n=[],o=m.Zero();let l=0,c=0,h=0,f=0,u=0,d=0,_=0;for(_=0;_<r.length-1;_++)r[_+1].subtractToRef(r[_],o),l+=o.length();for(h=l/i,f=e*h/(e+t),_=0;_<r.length-1;_++){r[_+1].subtractToRef(r[_],o),c=Math.floor(o.length()/h),o.normalize();for(let g=0;g<c;g++)u=h*g,s.push(r[_].x+u*o.x,r[_].y+u*o.y,r[_].z+u*o.z),s.push(r[_].x+(u+f)*o.x,r[_].y+(u+f)*o.y,r[_].z+(u+f)*o.z),n.push(d,d+1),d+=2}const p=new ee;return p.positions=s,p.indices=n,p}function Xg(a,e,t=null){const i=e.instance,r=e.lines,s=e.colors;if(i){const c=i.getVerticesData(x.PositionKind);let h,f;s&&(h=i.getVerticesData(x.ColorKind));let u=0,d=0;for(let _=0;_<r.length;_++){const p=r[_];for(let g=0;g<p.length;g++)c[u]=p[g].x,c[u+1]=p[g].y,c[u+2]=p[g].z,s&&h&&(f=s[_],h[d]=f[g].r,h[d+1]=f[g].g,h[d+2]=f[g].b,h[d+3]=f[g].a,d+=4),u+=3}return i.updateVerticesData(x.PositionKind,c,!1,!1),s&&h&&i.updateVerticesData(x.ColorKind,h,!1,!1),i.refreshBoundingInfo(),i}const n=!!s,o=new $r(a,t,null,void 0,void 0,n,e.useVertexAlpha,e.material);return kg(e).applyToMesh(o,e.updatable),o}function th(a,e,t=null){const i=e.colors?[e.colors]:null;return Xg(a,{lines:[e.points],updatable:e.updatable,instance:e.instance,colors:i,useVertexAlpha:e.useVertexAlpha,material:e.material},t)}function Hg(a,e,t=null){const i=e.points,r=e.instance,s=e.gapSize||1,n=e.dashSize||3;if(r){const c=h=>{const f=m.Zero(),u=h.length/6;let d=0,_=0,p=0,g=0,E=0,v=0,b=0,R=0;for(b=0;b<i.length-1;b++)i[b+1].subtractToRef(i[b],f),d+=f.length();p=d/u;const S=r._creationDataStorage.dashSize,T=r._creationDataStorage.gapSize;for(g=S*p/(S+T),b=0;b<i.length-1;b++)for(i[b+1].subtractToRef(i[b],f),_=Math.floor(f.length()/p),f.normalize(),R=0;R<_&&v<h.length;)E=p*R,h[v]=i[b].x+E*f.x,h[v+1]=i[b].y+E*f.y,h[v+2]=i[b].z+E*f.z,h[v+3]=i[b].x+(E+g)*f.x,h[v+4]=i[b].y+(E+g)*f.y,h[v+5]=i[b].z+(E+g)*f.z,v+=6,R++;for(;v<h.length;)h[v]=i[b].x,h[v+1]=i[b].y,h[v+2]=i[b].z,v+=3};return(e.dashNb||e.dashSize||e.gapSize||e.useVertexAlpha||e.material)&&B.Warn("You have used an option other than points with the instance option. Please be aware that these other options will be ignored."),r.updateMeshPositions(c,!1),r}const o=new $r(a,t,null,void 0,void 0,void 0,e.useVertexAlpha,e.material);return Wg(e).applyToMesh(o,e.updatable),o._creationDataStorage=new qm,o._creationDataStorage.dashSize=n,o._creationDataStorage.gapSize=s,o}ee.CreateLineSystem=kg;ee.CreateDashedLines=Wg;N.CreateLines=(a,e,t=null,i=!1,r=null)=>th(a,{points:e,updatable:i,instance:r},t);N.CreateDashedLines=(a,e,t,i,r,s=null,n,o)=>Hg(a,{points:e,dashSize:t,gapSize:i,dashNb:r,updatable:n,instance:o},s);var Hf;(function(a){a[a.INIT=0]="INIT",a[a.STARTED=1]="STARTED",a[a.ENDED=2]="ENDED"})(Hf||(Hf={}));function oa(a){let e=0;const t=Date.now();a.observableParameters=a.observableParameters??{};const i=a.contextObservable.add(r=>{const s=Date.now();e=s-t;const n={startTime:t,currentTime:s,deltaTime:e,completeRate:e/a.timeout,payload:r};a.onTick&&a.onTick(n),a.breakCondition&&a.breakCondition()&&(a.contextObservable.remove(i),a.onAborted&&a.onAborted(n)),e>=a.timeout&&(a.contextObservable.remove(i),a.onEnded&&a.onEnded(n))},a.observableParameters.mask,a.observableParameters.insertFirst,a.observableParameters.scope);return i}class lb{constructor(e){this.onEachCountObservable=new U,this.onTimerAbortedObservable=new U,this.onTimerEndedObservable=new U,this.onStateChangedObservable=new U,this._observer=null,this._breakOnNextTick=!1,this._tick=t=>{const i=Date.now();this._timer=i-this._startTime;const r={startTime:this._startTime,currentTime:i,deltaTime:this._timer,completeRate:this._timer/this._timeToEnd,payload:t},s=this._breakOnNextTick||this._breakCondition(r);s||this._timer>=this._timeToEnd?this._stop(r,s):this.onEachCountObservable.notifyObservers(r)},this._setState(0),this._contextObservable=e.contextObservable,this._observableParameters=e.observableParameters??{},this._breakCondition=e.breakCondition??(()=>!1),this._timeToEnd=e.timeout,e.onEnded&&this.onTimerEndedObservable.add(e.onEnded),e.onTick&&this.onEachCountObservable.add(e.onTick),e.onAborted&&this.onTimerAbortedObservable.add(e.onAborted)}set breakCondition(e){this._breakCondition=e}clearObservables(){this.onEachCountObservable.clear(),this.onTimerAbortedObservable.clear(),this.onTimerEndedObservable.clear(),this.onStateChangedObservable.clear()}start(e=this._timeToEnd){if(this._state===1)throw new Error("Timer already started. Please stop it before starting again");this._timeToEnd=e,this._startTime=Date.now(),this._timer=0,this._observer=this._contextObservable.add(this._tick,this._observableParameters.mask,this._observableParameters.insertFirst,this._observableParameters.scope),this._setState(1)}stop(){this._state===1&&(this._breakOnNextTick=!0)}dispose(){this._observer&&this._contextObservable.remove(this._observer),this.clearObservables()}_setState(e){this._state=e,this.onStateChangedObservable.notifyObservers(this._state)}_stop(e,t=!1){this._contextObservable.remove(this._observer),this._setState(2),t?this.onTimerAbortedObservable.notifyObservers(e):this.onTimerEndedObservable.notifyObservers(e)}}class Ys extends lo{get rotationEnabled(){return this._rotationEnabled}set rotationEnabled(e){if(this._rotationEnabled=e,this._options.teleportationTargetMesh){const t=this._options.teleportationTargetMesh.getChildMeshes(!1,i=>i.name==="rotationCone");t[0]&&t[0].setEnabled(e)}}get teleportationTargetMesh(){return this._options.teleportationTargetMesh||null}constructor(e,t){super(e),this._options=t,this._controllers={},this._snappedToPoint=!1,this._cachedColor4White=new Ne(1,1,1,1),this._tmpRay=new He(new m,new m),this._tmpVector=new m,this._tmpQuaternion=new z,this._worldScaleObserver=null,this.skipNextTeleportation=!1,this.backwardsMovementEnabled=!0,this.backwardsTeleportationDistance=.7,this.parabolicCheckRadius=5,this.parabolicRayEnabled=!0,this.straightRayEnabled=!0,this.rotationAngle=Math.PI/8,this.onTargetMeshPositionUpdatedObservable=new U,this.teleportationEnabled=!0,this._rotationEnabled=!0,this.onBeforeCameraTeleportRotation=new U,this.onAfterCameraTeleportRotation=new U,this._attachController=i=>{if(this._controllers[i.uniqueId]||this._options.forceHandedness&&i.inputSource.handedness!==this._options.forceHandedness)return;this._controllers[i.uniqueId]={xrController:i,teleportationState:{forward:!1,backwards:!1,rotating:!1,currentRotation:0,baseRotation:0,blocked:!1,initialHit:!1,mainComponentUsed:!1}};const r=this._controllers[i.uniqueId];if(r.xrController.inputSource.targetRayMode==="tracked-pointer"&&r.xrController.inputSource.gamepad){const s=()=>{if(i.motionController){const n=i.motionController.getComponentOfType(vr.THUMBSTICK_TYPE)||i.motionController.getComponentOfType(vr.TOUCHPAD_TYPE);if(!n||this._options.useMainComponentOnly){const o=i.motionController.getMainComponent();if(!o)return;r.teleportationState.mainComponentUsed=!0,r.teleportationComponent=o,r.onButtonChangedObserver=o.onButtonStateChangedObservable.add(()=>{if(!this.teleportationEnabled)return;const l=()=>{r.teleportationState.forward=!0,r.teleportationState.initialHit=!1,this._currentTeleportationControllerId=r.xrController.uniqueId,r.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,r.teleportationState.currentRotation=0;const c=this._options.timeToTeleport||3e3;oa({timeout:c,contextObservable:this._xrSessionManager.onXRFrameObservable,breakCondition:()=>!o.pressed,onEnded:()=>{this._currentTeleportationControllerId===r.xrController.uniqueId&&r.teleportationState.forward&&this._teleportForward(i.uniqueId)}})};o.changes.pressed&&(o.changes.pressed.current?this._options.timeToTeleportStart?oa({timeout:this._options.timeToTeleportStart,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{o.pressed&&l()}}):l():(r.teleportationState.forward=!1,this._currentTeleportationControllerId=""))})}else r.teleportationComponent=n,r.onAxisChangedObserver=n.onAxisValueChangedObservable.add(o=>{if(o.y<=.7&&r.teleportationState.backwards&&(r.teleportationState.backwards=!1),o.y>.7&&!r.teleportationState.forward&&this.backwardsMovementEnabled&&!this.snapPointsOnly&&!r.teleportationState.backwards){r.teleportationState.backwards=!0,this._tmpQuaternion.copyFrom(this._options.xrInput.xrCamera.rotationQuaternion),this._tmpQuaternion.toEulerAnglesToRef(this._tmpVector),this._tmpVector.x=0,this._tmpVector.z=0,z.FromEulerVectorToRef(this._tmpVector,this._tmpQuaternion),this._tmpVector.set(0,0,this.backwardsTeleportationDistance*(this._xrSessionManager.scene.useRightHandedSystem?1:-1)),this._tmpVector.rotateByQuaternionToRef(this._tmpQuaternion,this._tmpVector),this._tmpVector.addInPlace(this._options.xrInput.xrCamera.position),this._tmpRay.origin.copyFrom(this._tmpVector),this._tmpRay.length=this._options.xrInput.xrCamera.realWorldHeight+.1,this._tmpRay.direction.set(0,-1,0);const l=this._xrSessionManager.scene.pickWithRay(this._tmpRay,c=>this._floorMeshes.indexOf(c)!==-1);l&&l.pickedPoint&&(this._options.xrInput.xrCamera.position.x=l.pickedPoint.x,this._options.xrInput.xrCamera.position.z=l.pickedPoint.z)}if(o.y<-.7&&!this._currentTeleportationControllerId&&!r.teleportationState.rotating&&this.teleportationEnabled&&(r.teleportationState.forward=!0,this._currentTeleportationControllerId=r.xrController.uniqueId,r.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y),o.x){if(r.teleportationState.forward)this._currentTeleportationControllerId===r.xrController.uniqueId&&(this.rotationEnabled?setTimeout(()=>{r.teleportationState.currentRotation=Math.atan2(o.x,o.y*(this._xrSessionManager.scene.useRightHandedSystem?1:-1))}):r.teleportationState.currentRotation=0);else if(!r.teleportationState.rotating&&Math.abs(o.x)>.7){r.teleportationState.rotating=!0;const l=this.rotationAngle*(o.x>0?1:-1)*(this._xrSessionManager.scene.useRightHandedSystem?-1:1);this.onBeforeCameraTeleportRotation.notifyObservers(l),z.FromEulerAngles(0,l,0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion),this.onAfterCameraTeleportRotation.notifyObservers(this._options.xrInput.xrCamera.rotationQuaternion)}}else r.teleportationState.rotating=!1;o.x===0&&o.y===0&&(r.teleportationState.blocked&&(r.teleportationState.blocked=!1,this._setTargetMeshVisibility(!1)),r.teleportationState.forward&&this._teleportForward(i.uniqueId))})}};i.motionController?s():i.onMotionControllerInitObservable.addOnce(()=>{s()})}else{r.teleportationState.mainComponentUsed=!0;let s=!1;const n=()=>{this._currentTeleportationControllerId=r.xrController.uniqueId,r.teleportationState.forward=!0,r.teleportationState.initialHit=!1,r.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,r.teleportationState.currentRotation=0;const o=this._options.timeToTeleport||3e3;oa({timeout:o,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{this._currentTeleportationControllerId===r.xrController.uniqueId&&r.teleportationState.forward&&this._teleportForward(i.uniqueId)}})};this._xrSessionManager.scene.onPointerObservable.add(o=>{o.type===ge.POINTERDOWN?(s=!1,this._options.timeToTeleportStart?oa({timeout:this._options.timeToTeleportStart,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{this._currentTeleportationControllerId===r.xrController.uniqueId&&n()},breakCondition:()=>s?(s=!1,!0):!1}):n()):o.type===ge.POINTERUP&&(s=!0,r.teleportationState.forward=!1,this._currentTeleportationControllerId="")})}},this._colorArray=Array(24).fill(this._cachedColor4White),this._options.teleportationTargetMesh||this._createDefaultTargetMesh(),this._floorMeshes=this._options.floorMeshes||[],this._snapToPositions=this._options.snapPositions||[],this._blockedRayColor=this._options.blockedRayColor||new Ne(1,0,0,.75),this._setTargetMeshVisibility(!1),this.onBeforeCameraTeleport=t.xrInput.xrCamera.onBeforeCameraTeleport,this.onAfterCameraTeleport=t.xrInput.xrCamera.onAfterCameraTeleport,this.parabolicCheckRadius*=this._xrSessionManager.worldScalingFactor,this._worldScaleObserver=e.onWorldScaleFactorChangedObservable.add(i=>{var r;this.parabolicCheckRadius=this.parabolicCheckRadius/i.previousScaleFactor*i.newScaleFactor,(r=this._options.teleportationTargetMesh)==null||r.scaling.scaleInPlace(i.newScaleFactor/i.previousScaleFactor)})}get snapPointsOnly(){return!!this._options.snapPointsOnly}set snapPointsOnly(e){this._options.snapPointsOnly=e}addFloorMesh(e){this._floorMeshes.push(e)}addBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[],this._options.pickBlockerMeshes.push(e)}addSnapPoint(e){this._snapToPositions.push(e)}attach(){return super.attach()?(this._currentTeleportationControllerId="",this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),!0):!1}detach(){return super.detach()?(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),this._setTargetMeshVisibility(!1),this._currentTeleportationControllerId="",this._controllers={},!0):!1}dispose(){super.dispose(),this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.dispose(!1,!0),this._worldScaleObserver&&this._xrSessionManager.onWorldScaleFactorChangedObservable.remove(this._worldScaleObserver),this.onTargetMeshPositionUpdatedObservable.clear(),this.onTargetMeshPositionUpdatedObservable.clear(),this.onBeforeCameraTeleportRotation.clear(),this.onAfterCameraTeleportRotation.clear(),this.onBeforeCameraTeleport.clear(),this.onAfterCameraTeleport.clear()}removeFloorMesh(e){const t=this._floorMeshes.indexOf(e);t!==-1&&this._floorMeshes.splice(t,1)}removeBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[];const t=this._options.pickBlockerMeshes.indexOf(e);t!==-1&&this._options.pickBlockerMeshes.splice(t,1)}removeFloorMeshByName(e){const t=this._xrSessionManager.scene.getMeshByName(e);t&&this.removeFloorMesh(t)}removeSnapPoint(e){let t=this._snapToPositions.indexOf(e);if(t===-1){for(let i=0;i<this._snapToPositions.length;++i)if(this._snapToPositions[i].equals(e)){t=i;break}}return t!==-1?(this._snapToPositions.splice(t,1),!0):!1}setSelectionFeature(e){this._selectionFeature=e}_onXRFrame(e){const t=this._xrSessionManager.currentFrame,i=this._xrSessionManager.scene;if(!this.attach||!t)return;const r=this._options.teleportationTargetMesh;if(this._currentTeleportationControllerId){if(!r)return;r.rotationQuaternion=r.rotationQuaternion||new z;const s=this._controllers[this._currentTeleportationControllerId];if(s&&s.teleportationState.forward){z.RotationYawPitchRollToRef(s.teleportationState.currentRotation+s.teleportationState.baseRotation,0,0,r.rotationQuaternion);let n=!1;const o=s.xrController.inputSource.targetRayMode!=="transient-pointer";if(s.xrController.getWorldPointerRayToRef(this._tmpRay),this.straightRayEnabled){const l=i.pickWithRay(this._tmpRay,h=>{if(this._options.blockerMeshesPredicate&&this._options.blockerMeshesPredicate(h)||this._options.blockAllPickableMeshes&&h.isPickable||this._options.pickBlockerMeshes&&this._options.pickBlockerMeshes.indexOf(h)!==-1)return!0;const f=this._floorMeshes.indexOf(h);return f===-1?!1:this._floorMeshes[f].absolutePosition.y<this._options.xrInput.xrCamera.globalPosition.y}),c=l&&l.pickedMesh&&this._floorMeshes.indexOf(l.pickedMesh)!==-1;if(l&&l.pickedMesh&&!c){if(s.teleportationState.mainComponentUsed&&!s.teleportationState.initialHit){s.teleportationState.forward=!1;return}s.teleportationState.blocked=!0,this._setTargetMeshVisibility(!1,!1,o),this._showParabolicPath(l);return}else l&&l.pickedPoint&&(s.teleportationState.initialHit=!0,s.teleportationState.blocked=!1,n=!0,this._setTargetMeshPosition(l),this._setTargetMeshVisibility(!0,!1,o),this._showParabolicPath(l))}if(this.parabolicRayEnabled&&!n){const l=s.xrController.pointer.rotationQuaternion.toEulerAngles().x,c=1+(Math.PI/2-Math.abs(l)),h=this.parabolicCheckRadius*c;this._tmpRay.origin.addToRef(this._tmpRay.direction.scale(h*2),this._tmpVector),this._tmpVector.y=this._tmpRay.origin.y,this._tmpRay.origin.addInPlace(this._tmpRay.direction.scale(h)),this._tmpVector.subtractToRef(this._tmpRay.origin,this._tmpRay.direction),this._tmpRay.direction.normalize();const f=i.pickWithRay(this._tmpRay,d=>this._options.blockerMeshesPredicate&&this._options.blockerMeshesPredicate(d)||this._options.blockAllPickableMeshes&&d.isPickable||this._options.pickBlockerMeshes&&this._options.pickBlockerMeshes.indexOf(d)!==-1?!0:this._floorMeshes.indexOf(d)!==-1),u=f&&f.pickedMesh&&this._floorMeshes.indexOf(f.pickedMesh)!==-1;if(f&&f.pickedMesh&&!u){if(s.teleportationState.mainComponentUsed&&!s.teleportationState.initialHit){s.teleportationState.forward=!1;return}s.teleportationState.blocked=!0,this._setTargetMeshVisibility(!1,!1,o),this._showParabolicPath(f);return}else f&&f.pickedPoint&&(s.teleportationState.initialHit=!0,s.teleportationState.blocked=!1,n=!0,this._setTargetMeshPosition(f),this._setTargetMeshVisibility(!0,!1,o),this._showParabolicPath(f))}this._setTargetMeshVisibility(n,!1,o)}else this._setTargetMeshVisibility(!1,!1,!0)}else this._disposeBezierCurve(),this._setTargetMeshVisibility(!1,!1,!0)}_createDefaultTargetMesh(){this._options.defaultTargetMeshOptions=this._options.defaultTargetMeshOptions||{};const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Nt.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,t=za("teleportationTarget",{width:2,height:2,subdivisions:2},e);if(t.isPickable=!1,this._options.defaultTargetMeshOptions.teleportationCircleMaterial)t.material=this._options.defaultTargetMeshOptions.teleportationCircleMaterial;else{const n=new Mn("teleportationPlaneDynamicTexture",512,e,!0);n.hasAlpha=!0;const o=n.getContext(),l=512/2,c=512/2,h=200;o.beginPath(),o.arc(l,c,h,0,2*Math.PI,!1),o.fillStyle=this._options.defaultTargetMeshOptions.teleportationFillColor||"#444444",o.fill(),o.lineWidth=10,o.strokeStyle=this._options.defaultTargetMeshOptions.teleportationBorderColor||"#FFFFFF",o.stroke(),o.closePath(),n.update();const f=new se("teleportationPlaneMaterial",e);f.diffuseTexture=n,t.material=f}const i=Rs("torusTeleportation",{diameter:.75,thickness:.1,tessellation:20},e);if(i.isPickable=!1,i.parent=t,!this._options.defaultTargetMeshOptions.disableAnimation){const s=new W("animationInnerCircle","position.y",30,W.ANIMATIONTYPE_FLOAT,W.ANIMATIONLOOPMODE_CYCLE),n=[];n.push({frame:0,value:0}),n.push({frame:30,value:.4}),n.push({frame:60,value:0}),s.setKeys(n);const o=new $m;o.setEasingMode(kt.EASINGMODE_EASEINOUT),s.setEasingFunction(o),i.animations=[],i.animations.push(s),e.beginAnimation(i,0,60,!0)}const r=oo("rotationCone",{diameterTop:0,tessellation:4},e);if(r.isPickable=!1,r.scaling.set(.5,.12,.2),r.rotate(Vi.X,Math.PI/2),r.position.z=.6,r.parent=i,this._options.defaultTargetMeshOptions.torusArrowMaterial)i.material=this._options.defaultTargetMeshOptions.torusArrowMaterial,r.material=this._options.defaultTargetMeshOptions.torusArrowMaterial;else{const s=new se("torusConsMat",e);s.disableLighting=!!this._options.defaultTargetMeshOptions.disableLighting,s.disableLighting?s.emissiveColor=new ae(.3,.3,1):s.diffuseColor=new ae(.3,.3,1),s.alpha=.9,i.material=s,r.material=s,this._teleportationRingMaterial=s}this._options.renderingGroupId!==void 0&&(t.renderingGroupId=this._options.renderingGroupId,i.renderingGroupId=this._options.renderingGroupId,r.renderingGroupId=this._options.renderingGroupId),this._options.teleportationTargetMesh=t,this._options.teleportationTargetMesh.scaling.setAll(this._xrSessionManager.worldScalingFactor),this._setTargetMeshVisibility(!1)}_detachController(e){const t=this._controllers[e];t&&(t.teleportationComponent&&(t.onAxisChangedObserver&&t.teleportationComponent.onAxisValueChangedObservable.remove(t.onAxisChangedObserver),t.onButtonChangedObserver&&t.teleportationComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver)),delete this._controllers[e])}_findClosestSnapPointWithRadius(e,t=this._options.snapToPositionRadius||.8){let i=null,r=Number.MAX_VALUE;if(this._snapToPositions.length){const s=t*t;this._snapToPositions.forEach(n=>{const o=m.DistanceSquared(n,e);o<=s&&o<r&&(r=o,i=n)})}return i}_setTargetMeshPosition(e){const t=e.pickedPoint;if(!this._options.teleportationTargetMesh||!t)return;const i=this._findClosestSnapPointWithRadius(t);this._snappedToPoint=!!i,this.snapPointsOnly&&!this._snappedToPoint&&this._teleportationRingMaterial?this._teleportationRingMaterial.diffuseColor.set(1,.3,.3):this.snapPointsOnly&&this._snappedToPoint&&this._teleportationRingMaterial&&this._teleportationRingMaterial.diffuseColor.set(.3,.3,1),this._options.teleportationTargetMesh.position.copyFrom(i||t),this._options.teleportationTargetMesh.position.y+=.01,this.onTargetMeshPositionUpdatedObservable.notifyObservers(e)}_setTargetMeshVisibility(e,t,i){this._options.teleportationTargetMesh&&(this._options.teleportationTargetMesh.isVisible===e&&!t||(this._options.teleportationTargetMesh.isVisible=e,this._options.teleportationTargetMesh.getChildren(void 0,!1).forEach(r=>{r.isVisible=e}),e?this._selectionFeature&&i&&this._selectionFeature.detach():(this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null),this._selectionFeature&&i&&this._selectionFeature.attach())))}_disposeBezierCurve(){this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null)}_showParabolicPath(e){if(!e.pickedPoint||!this._currentTeleportationControllerId)return;const t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Nt.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,i=this._controllers[this._currentTeleportationControllerId],r=br.CreateQuadraticBezier(i.xrController.pointer.absolutePosition,e.ray.origin,e.pickedPoint,25),s=i.teleportationState.blocked?this._blockedRayColor:void 0,n=this._colorArray.fill(s||this._cachedColor4White),o=r.getPoints();o.shift(),o.shift(),this._options.generateRayPathMesh?this._quadraticBezierCurve=this._options.generateRayPathMesh(r.getPoints(),e):this._quadraticBezierCurve=th("teleportation path line",{points:o,instance:this._quadraticBezierCurve,updatable:!0,colors:n},t),this._quadraticBezierCurve.isPickable=!1,this._options.renderingGroupId!==void 0&&(this._quadraticBezierCurve.renderingGroupId=this._options.renderingGroupId)}_teleportForward(e){const t=this._controllers[e];if(!(!t||!t.teleportationState.forward||!this.teleportationEnabled)&&(t.teleportationState.forward=!1,this._currentTeleportationControllerId="",!(this.snapPointsOnly&&!this._snappedToPoint))){if(this.skipNextTeleportation){this.skipNextTeleportation=!1;return}if(this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.isVisible){const i=this._options.xrInput.xrCamera.realWorldHeight;this.onBeforeCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position),this._options.xrInput.xrCamera.position.copyFrom(this._options.teleportationTargetMesh.position),this._options.xrInput.xrCamera.position.y+=i,z.FromEulerAngles(0,t.teleportationState.currentRotation-(this._xrSessionManager.scene.useRightHandedSystem?Math.PI:0),0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion),this.onAfterCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position)}}}}Ys.Name=St.TELEPORTATION;Ys.Version=1;Yi.AddWebXRFeature(Ys.Name,(a,e)=>()=>new Ys(a,e),Ys.Version,!0);class ih{constructor(){}static CreateAsync(e,t={}){const i=new ih;if(e.onDisposeObservable.addOnce(()=>{i.dispose()}),!t.disableDefaultUI){const r={renderTarget:i.renderTarget,...t.uiOptions||{}};t.optionalFeatures&&(typeof t.optionalFeatures=="boolean"?r.optionalFeatures=["hit-test","anchors","plane-detection","hand-tracking"]:r.optionalFeatures=t.optionalFeatures),i.enterExitUI=new eh(e,r)}return Kc.CreateAsync(e).then(r=>{if(i.baseExperience=r,t.ignoreNativeCameraTransformation&&(i.baseExperience.camera.compensateOnFirstFrame=!1),i.input=new $I(r.sessionManager,r.camera,{controllerOptions:{renderingGroupId:t.renderingGroupId},...t.inputOptions||{}}),!t.disablePointerSelection){const s={...t.pointerSelectionOptions,xrInput:i.input,renderingGroupId:t.renderingGroupId};i.pointerSelection=i.baseExperience.featuresManager.enableFeature(mr.Name,t.useStablePlugins?"stable":"latest",s),t.disableTeleportation||(i.teleportation=i.baseExperience.featuresManager.enableFeature(Ys.Name,t.useStablePlugins?"stable":"latest",{floorMeshes:t.floorMeshes,xrInput:i.input,renderingGroupId:t.renderingGroupId,...t.teleportationOptions}),i.teleportation.setSelectionFeature(i.pointerSelection))}if(t.disableNearInteraction||(i.nearInteraction=i.baseExperience.featuresManager.enableFeature(gr.Name,t.useStablePlugins?"stable":"latest",{xrInput:i.input,farInteractionFeature:i.pointerSelection,renderingGroupId:t.renderingGroupId,useUtilityLayer:!0,enableNearInteractionOnAllControllers:!0,...t.nearInteractionOptions})),t.disableHandTracking||i.baseExperience.featuresManager.enableFeature(Qe.Name,t.useStablePlugins?"stable":"latest",{xrInput:i.input,...t.handSupportOptions},void 0,!1),i.renderTarget=i.baseExperience.sessionManager.getWebXRRenderTarget(t.outputCanvasOptions),!t.disableDefaultUI)return i.enterExitUI.setHelperAsync(i.baseExperience,i.renderTarget)}).then(()=>i).catch(r=>(B.Error("Error initializing XR"),B.Error(r),i))}dispose(){this.baseExperience&&this.baseExperience.dispose(),this.input&&this.input.dispose(),this.enterExitUI&&this.enterExitUI.dispose(),this.renderTarget&&this.renderTarget.dispose()}}Ge.prototype.createDefaultLight=function(a=!1){if(a&&this.lights)for(let e=0;e<this.lights.length;e++)this.lights[e].dispose();this.lights.length===0&&new an("default light",m.Up(),this)};Ge.prototype.createDefaultCamera=function(a=!1,e=!1,t=!1){if(e&&this.activeCamera&&(this.activeCamera.dispose(),this.activeCamera=null),!this.activeCamera){const i=this.getWorldExtends(l=>l.isVisible&&l.isEnabled()),r=i.max.subtract(i.min),s=i.min.add(r.scale(.5));let n,o=r.length()*1.5;if(isFinite(o)||(o=1,s.copyFromFloats(0,0,0)),a){const l=new dt("default camera",-(Math.PI/2),Math.PI/2,o,s,this);l.lowerRadiusLimit=o*.01,l.wheelPrecision=100/o,n=l}else{const l=new sr("default camera",new m(s.x,s.y,-o),this);l.setTarget(s),n=l}n.minZ=o*.01,n.maxZ=o*1e3,n.speed=o*.2,this.activeCamera=n,t&&n.attachControl()}};Ge.prototype.createDefaultCameraOrLight=function(a=!1,e=!1,t=!1){this.createDefaultLight(e),this.createDefaultCamera(a,e,t)};Ge.prototype.createDefaultSkybox=function(a,e=!1,t=1e3,i=0,r=!0){if(!a)return B.Warn("Can not create default skybox without environment texture."),null;r&&a&&(this.environmentTexture=a);const s=Ya("hdrSkyBox",{size:t},this);if(e){const n=new be("skyBox",this);n.backFaceCulling=!1,n.reflectionTexture=a.clone(),n.reflectionTexture&&(n.reflectionTexture.coordinatesMode=Z.SKYBOX_MODE),n.microSurface=1-i,n.disableLighting=!0,n.twoSidedLighting=!0,s.material=n}else{const n=new se("skyBox",this);n.backFaceCulling=!1,n.reflectionTexture=a.clone(),n.reflectionTexture&&(n.reflectionTexture.coordinatesMode=Z.SKYBOX_MODE),n.disableLighting=!0,s.material=n}return s.isPickable=!1,s.infiniteDistance=!0,s.ignoreCameraMaxZ=!0,s};Ge.prototype.createDefaultEnvironment=function(a){return As?new As(a,this):null};Ge.prototype.createDefaultVRExperience=function(a={}){return new tn(this,a)};Ge.prototype.createDefaultXRExperienceAsync=function(a={}){return ih.CreateAsync(this,a).then(e=>e)};const cb=(a,e,t,i)=>!(a.x>t.x+i||t.x-i>e.x||a.y>t.y+i||t.y-i>e.y||a.z>t.z+i||t.z-i>e.z),ws=function(){const a={root:0,found:!1};return function(e,t,i,r){a.root=0,a.found=!1;const s=t*t-4*e*i;if(s<0)return a;const n=Math.sqrt(s);let o=(-t-n)/(2*e),l=(-t+n)/(2*e);if(o>l){const c=l;l=o,o=c}return o>0&&o<r?(a.root=o,a.found=!0,a):(l>0&&l<r&&(a.root=l,a.found=!0),a)}}();class fo{constructor(){this._collisionPoint=m.Zero(),this._planeIntersectionPoint=m.Zero(),this._tempVector=m.Zero(),this._tempVector2=m.Zero(),this._tempVector3=m.Zero(),this._tempVector4=m.Zero(),this._edge=m.Zero(),this._baseToVertex=m.Zero(),this._destinationPoint=m.Zero(),this._slidePlaneNormal=m.Zero(),this._displacementVector=m.Zero(),this._radius=m.One(),this._retry=0,this._basePointWorld=m.Zero(),this._velocityWorld=m.Zero(),this._normalizedVelocity=m.Zero(),this._collisionMask=-1}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}get slidePlaneNormal(){return this._slidePlaneNormal}_initialize(e,t,i){this._velocity=t,this._velocitySquaredLength=this._velocity.lengthSquared();const r=Math.sqrt(this._velocitySquaredLength);r===0||r===1?this._normalizedVelocity.copyFromFloats(t._x,t._y,t._z):t.scaleToRef(1/r,this._normalizedVelocity),this._basePoint=e,e.multiplyToRef(this._radius,this._basePointWorld),t.multiplyToRef(this._radius,this._velocityWorld),this._velocityWorldLength=this._velocityWorld.length(),this._epsilon=i,this.collisionFound=!1}_checkPointInTriangle(e,t,i,r,s){t.subtractToRef(e,this._tempVector),i.subtractToRef(e,this._tempVector2),m.CrossToRef(this._tempVector,this._tempVector2,this._tempVector4);let n=m.Dot(this._tempVector4,s);return n<0||(r.subtractToRef(e,this._tempVector3),m.CrossToRef(this._tempVector2,this._tempVector3,this._tempVector4),n=m.Dot(this._tempVector4,s),n<0)?!1:(m.CrossToRef(this._tempVector3,this._tempVector,this._tempVector4),n=m.Dot(this._tempVector4,s),n>=0)}_canDoCollision(e,t,i,r){const s=m.Distance(this._basePointWorld,e),n=Math.max(this._radius.x,this._radius.y,this._radius.z);return!(s>this._velocityWorldLength+n+t||!cb(i,r,this._basePointWorld,this._velocityWorldLength+n))}_testTriangle(e,t,i,r,s,n,o){let l,c=!1;t||(t=[]),t[e]||(t[e]=new hi(0,0,0,0),t[e].copyFromPoints(i,r,s));const h=t[e];if(!n&&!h.isFrontFacingTo(this._normalizedVelocity,0))return;const f=h.signedDistanceTo(this._basePoint),u=m.Dot(h.normal,this._velocity);if(fo.DoubleSidedCheck&&u>1e-4)return;if(u==0){if(Math.abs(f)>=1)return;c=!0,l=0}else{l=(-1-f)/u;let p=(1-f)/u;if(l>p){const g=p;p=l,l=g}if(l>1||p<0)return;l<0&&(l=0),l>1&&(l=1)}this._collisionPoint.copyFromFloats(0,0,0);let d=!1,_=1;if(c||(this._basePoint.subtractToRef(h.normal,this._planeIntersectionPoint),this._velocity.scaleToRef(l,this._tempVector),this._planeIntersectionPoint.addInPlace(this._tempVector),this._checkPointInTriangle(this._planeIntersectionPoint,i,r,s,h.normal)&&(d=!0,_=l,this._collisionPoint.copyFrom(this._planeIntersectionPoint))),!d){let p=this._velocitySquaredLength;this._basePoint.subtractToRef(i,this._tempVector);let g=2*m.Dot(this._velocity,this._tempVector),E=this._tempVector.lengthSquared()-1,v=ws(p,g,E,_);v.found&&(_=v.root,d=!0,this._collisionPoint.copyFrom(i)),this._basePoint.subtractToRef(r,this._tempVector),g=2*m.Dot(this._velocity,this._tempVector),E=this._tempVector.lengthSquared()-1,v=ws(p,g,E,_),v.found&&(_=v.root,d=!0,this._collisionPoint.copyFrom(r)),this._basePoint.subtractToRef(s,this._tempVector),g=2*m.Dot(this._velocity,this._tempVector),E=this._tempVector.lengthSquared()-1,v=ws(p,g,E,_),v.found&&(_=v.root,d=!0,this._collisionPoint.copyFrom(s)),r.subtractToRef(i,this._edge),i.subtractToRef(this._basePoint,this._baseToVertex);let b=this._edge.lengthSquared(),R=m.Dot(this._edge,this._velocity),S=m.Dot(this._edge,this._baseToVertex);if(p=b*-this._velocitySquaredLength+R*R,g=2*(b*m.Dot(this._velocity,this._baseToVertex)-R*S),E=b*(1-this._baseToVertex.lengthSquared())+S*S,v=ws(p,g,E,_),v.found){const T=(R*v.root-S)/b;T>=0&&T<=1&&(_=v.root,d=!0,this._edge.scaleInPlace(T),i.addToRef(this._edge,this._collisionPoint))}if(s.subtractToRef(r,this._edge),r.subtractToRef(this._basePoint,this._baseToVertex),b=this._edge.lengthSquared(),R=m.Dot(this._edge,this._velocity),S=m.Dot(this._edge,this._baseToVertex),p=b*-this._velocitySquaredLength+R*R,g=2*(b*m.Dot(this._velocity,this._baseToVertex)-R*S),E=b*(1-this._baseToVertex.lengthSquared())+S*S,v=ws(p,g,E,_),v.found){const T=(R*v.root-S)/b;T>=0&&T<=1&&(_=v.root,d=!0,this._edge.scaleInPlace(T),r.addToRef(this._edge,this._collisionPoint))}if(i.subtractToRef(s,this._edge),s.subtractToRef(this._basePoint,this._baseToVertex),b=this._edge.lengthSquared(),R=m.Dot(this._edge,this._velocity),S=m.Dot(this._edge,this._baseToVertex),p=b*-this._velocitySquaredLength+R*R,g=2*(b*m.Dot(this._velocity,this._baseToVertex)-R*S),E=b*(1-this._baseToVertex.lengthSquared())+S*S,v=ws(p,g,E,_),v.found){const T=(R*v.root-S)/b;T>=0&&T<=1&&(_=v.root,d=!0,this._edge.scaleInPlace(T),s.addToRef(this._edge,this._collisionPoint))}}if(d){const p=_*_*this._velocitySquaredLength;(!this.collisionFound||p<this._nearestDistanceSquared)&&(o.collisionResponse&&(this.intersectionPoint?this.intersectionPoint.copyFrom(this._collisionPoint):this.intersectionPoint=this._collisionPoint.clone(),this._nearestDistanceSquared=p,this._nearestDistance=Math.sqrt(p),this.collisionFound=!0),this.collidedMesh=o)}}_collide(e,t,i,r,s,n,o,l,c,h=!1){if(h)if(!i||i.length===0)for(let f=0;f<t.length-2;f+=1){const u=t[f],d=t[f+1],_=t[f+2];!u||!d||!_||((c?1:0)^f%2?this._testTriangle(f,e,u,d,_,o,l):this._testTriangle(f,e,d,u,_,o,l))}else for(let f=r;f<s-2;f+=1){const u=i[f],d=i[f+1],_=i[f+2];if(_===4294967295){f+=2;continue}const p=t[u],g=t[d],E=t[_];!p||!g||!E||((c?1:0)^f%2?this._testTriangle(f,e,p,g,E,o,l):this._testTriangle(f,e,g,p,E,o,l))}else if(!i||i.length===0)for(let f=0;f<t.length;f+=3){const u=t[f],d=t[f+1],_=t[f+2];c?this._testTriangle(f,e,u,d,_,o,l):this._testTriangle(f,e,_,d,u,o,l)}else for(let f=r;f<s;f+=3){const u=t[i[f]-n],d=t[i[f+1]-n],_=t[i[f+2]-n];c?this._testTriangle(f,e,u,d,_,o,l):this._testTriangle(f,e,_,d,u,o,l)}}_getResponse(e,t){e.addToRef(t,this._destinationPoint),t.scaleInPlace(this._nearestDistance/t.length()),this._basePoint.addToRef(t,e),e.subtractToRef(this.intersectionPoint,this._slidePlaneNormal),this._slidePlaneNormal.normalize(),this._slidePlaneNormal.scaleToRef(this._epsilon,this._displacementVector),e.addInPlace(this._displacementVector),this.intersectionPoint.addInPlace(this._displacementVector),this._slidePlaneNormal.scaleInPlace(hi.SignedDistanceToPlaneFromPositionAndNormal(this.intersectionPoint,this._slidePlaneNormal,this._destinationPoint)),this._destinationPoint.subtractInPlace(this._slidePlaneNormal),this._destinationPoint.subtractToRef(this.intersectionPoint,t)}}fo.DoubleSidedCheck=!1;class hb{constructor(){this._scaledPosition=m.Zero(),this._scaledVelocity=m.Zero(),this._finalPosition=m.Zero()}getNewPosition(e,t,i,r,s,n,o){e.divideToRef(i._radius,this._scaledPosition),t.divideToRef(i._radius,this._scaledVelocity),i.collidedMesh=null,i._retry=0,i._initialVelocity=this._scaledVelocity,i._initialPosition=this._scaledPosition,this._collideWithWorld(this._scaledPosition,this._scaledVelocity,i,r,this._finalPosition,s),this._finalPosition.multiplyInPlace(i._radius),n(o,this._finalPosition,i.collidedMesh)}createCollider(){return new fo}init(e){this._scene=e}_collideWithWorld(e,t,i,r,s,n=null){const o=H.CollisionsEpsilon*10;if(i._retry>=r){s.copyFrom(e);return}const l=n?n.collisionMask:i.collisionMask;i._initialize(e,t,o);const c=n&&n.surroundingMeshes||this._scene.meshes;for(let h=0;h<c.length;h++){const f=c[h];f.isEnabled()&&f.checkCollisions&&f.subMeshes&&f!==n&&l&f.collisionGroup&&f._checkCollision(i)}if(!i.collisionFound){e.addToRef(t,s);return}if((t.x!==0||t.y!==0||t.z!==0)&&i._getResponse(e,t),t.length()<=o){s.copyFrom(e);return}i._retry++,this._collideWithWorld(e,t,i,r,s,n)}}Ge.CollisionCoordinatorFactory=()=>new hb;class ys extends ke{constructor(){super(...arguments),this._needProjectionMatrixCompute=!0,this._viewMatrix=P.Identity(),this._projectionMatrix=P.Identity()}_setPosition(e){this._position=e}get position(){return this._position}set position(e){this._setPosition(e)}_setDirection(e){this._direction=e}get direction(){return this._direction}set direction(e){this._setDirection(e)}get shadowMinZ(){return this._shadowMinZ}set shadowMinZ(e){this._shadowMinZ=e,this.forceProjectionMatrixCompute()}get shadowMaxZ(){return this._shadowMaxZ}set shadowMaxZ(e){this._shadowMaxZ=e,this.forceProjectionMatrixCompute()}computeTransformedInformation(){return this.parent&&this.parent.getWorldMatrix?(this.transformedPosition||(this.transformedPosition=m.Zero()),m.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=m.Zero()),m.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),!0):!1}getDepthScale(){return 50}getShadowDirection(e){return this.transformedDirection?this.transformedDirection:this.direction}getAbsolutePosition(){return this.transformedPosition?this.transformedPosition:this.position}setDirectionToTarget(e){return this.direction=m.Normalize(e.subtract(this.position)),this.direction}getRotation(){this.direction.normalize();const e=m.Cross(this.direction,Vi.Y),t=m.Cross(e,this.direction);return m.RotationFromAxis(e,t,this.direction)}needCube(){return!1}needProjectionMatrixCompute(){return this._needProjectionMatrixCompute}forceProjectionMatrixCompute(){this._needProjectionMatrixCompute=!0}_initCache(){super._initCache(),this._cache.position=m.Zero()}_isSynchronized(){return!!this._cache.position.equals(this.position)}computeWorldMatrix(e){return!e&&this.isSynchronized()?(this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix):(this._updateCache(),this._cache.position.copyFrom(this.position),this._worldMatrix||(this._worldMatrix=P.Identity()),P.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this.parent&&this.parent.getWorldMatrix&&(this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix),this._markSyncedWithParent()),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix)}getDepthMinZ(e){return this.shadowMinZ!==void 0?this.shadowMinZ:(e==null?void 0:e.minZ)||0}getDepthMaxZ(e){return this.shadowMaxZ!==void 0?this.shadowMaxZ:(e==null?void 0:e.maxZ)||1e4}setShadowProjectionMatrix(e,t,i){return this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(t,i,e):this._setDefaultShadowProjectionMatrix(e,t,i),this}_syncParentEnabledState(){super._syncParentEnabledState(),(!this.parent||!this.parent.getWorldMatrix)&&(this.transformedPosition=null,this.transformedDirection=null)}getViewMatrix(e){const t=F.Vector3[0];let i=this.position;this.computeTransformedInformation()&&(i=this.transformedPosition),m.NormalizeToRef(this.getShadowDirection(e),t),Math.abs(m.Dot(t,m.Up()))===1&&(t.z=1e-13);const r=F.Vector3[1];return i.addToRef(t,r),P.LookAtLHToRef(i,r,m.Up(),this._viewMatrix),this._viewMatrix}getProjectionMatrix(e,t){return this.setShadowProjectionMatrix(this._projectionMatrix,e??this._viewMatrix,t??[]),this._projectionMatrix}}A([di()],ys.prototype,"position",null);A([di()],ys.prototype,"direction",null);A([y()],ys.prototype,"shadowMinZ",null);A([y()],ys.prototype,"shadowMaxZ",null);gt.AddNodeConstructor("Light_Type_1",(a,e)=>()=>new Ar(a,m.Zero(),e));class Ar extends ys{get shadowFrustumSize(){return this._shadowFrustumSize}set shadowFrustumSize(e){this._shadowFrustumSize=e,this.forceProjectionMatrixCompute()}get shadowOrthoScale(){return this._shadowOrthoScale}set shadowOrthoScale(e){this._shadowOrthoScale=e,this.forceProjectionMatrixCompute()}get orthoLeft(){return this._orthoLeft}set orthoLeft(e){this._orthoLeft=e}get orthoRight(){return this._orthoRight}set orthoRight(e){this._orthoRight=e}get orthoTop(){return this._orthoTop}set orthoTop(e){this._orthoTop=e}get orthoBottom(){return this._orthoBottom}set orthoBottom(e){this._orthoBottom=e}constructor(e,t,i){super(e,i),this._shadowFrustumSize=0,this._shadowOrthoScale=.1,this.autoUpdateExtends=!0,this.autoCalcShadowZBounds=!1,this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE,this.position=t.scale(-1),this.direction=t}getClassName(){return"DirectionalLight"}getTypeID(){return ke.LIGHTTYPEID_DIRECTIONALLIGHT}_setDefaultShadowProjectionMatrix(e,t,i){this.shadowFrustumSize>0?this._setDefaultFixedFrustumShadowProjectionMatrix(e):this._setDefaultAutoExtendShadowProjectionMatrix(e,t,i)}_setDefaultFixedFrustumShadowProjectionMatrix(e){const t=this.getScene().activeCamera;t&&P.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,this.shadowMinZ!==void 0?this.shadowMinZ:t.minZ,this.shadowMaxZ!==void 0?this.shadowMaxZ:t.maxZ,e,this.getScene().getEngine().isNDCHalfZRange)}_setDefaultAutoExtendShadowProjectionMatrix(e,t,i){const r=this.getScene().activeCamera;if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){const h=m.Zero();this._orthoLeft=Number.MAX_VALUE,this._orthoRight=-Number.MAX_VALUE,this._orthoTop=-Number.MAX_VALUE,this._orthoBottom=Number.MAX_VALUE;let f=Number.MAX_VALUE,u=-Number.MAX_VALUE;for(let d=0;d<i.length;d++){const _=i[d];if(!_)continue;const g=_.getBoundingInfo().boundingBox;for(let E=0;E<g.vectorsWorld.length;E++)m.TransformCoordinatesToRef(g.vectorsWorld[E],t,h),h.x<this._orthoLeft&&(this._orthoLeft=h.x),h.y<this._orthoBottom&&(this._orthoBottom=h.y),h.x>this._orthoRight&&(this._orthoRight=h.x),h.y>this._orthoTop&&(this._orthoTop=h.y),this.autoCalcShadowZBounds&&(h.z<f&&(f=h.z),h.z>u&&(u=h.z))}this.autoCalcShadowZBounds&&(this._shadowMinZ=f,this._shadowMaxZ=u)}const s=this._orthoRight-this._orthoLeft,n=this._orthoTop-this._orthoBottom,o=this.shadowMinZ!==void 0?this.shadowMinZ:(r==null?void 0:r.minZ)||0,l=this.shadowMaxZ!==void 0?this.shadowMaxZ:(r==null?void 0:r.maxZ)||1e4,c=this.getScene().getEngine().useReverseDepthBuffer;P.OrthoOffCenterLHToRef(this._orthoLeft-s*this.shadowOrthoScale,this._orthoRight+s*this.shadowOrthoScale,this._orthoBottom-n*this.shadowOrthoScale,this._orthoTop+n*this.shadowOrthoScale,c?l:o,c?o:l,e,this.getScene().getEngine().isNDCHalfZRange)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,t),this):(this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,t),this)}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?(e.setFloat3(t,this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z),this):(e.setFloat3(t,this.direction.x,this.direction.y,this.direction.z),this)}getDepthMinZ(e){const t=this._scene.getEngine();return!t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}getDepthMaxZ(e){const t=this._scene.getEngine();return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}prepareLightSpecificDefines(e,t){e["DIRLIGHT"+t]=!0}}A([y()],Ar.prototype,"shadowFrustumSize",null);A([y()],Ar.prototype,"shadowOrthoScale",null);A([y()],Ar.prototype,"autoUpdateExtends",void 0);A([y()],Ar.prototype,"autoCalcShadowZBounds",void 0);A([y("orthoLeft")],Ar.prototype,"_orthoLeft",void 0);A([y("orthoRight")],Ar.prototype,"_orthoRight",void 0);A([y("orthoTop")],Ar.prototype,"_orthoTop",void 0);A([y("orthoBottom")],Ar.prototype,"_orthoBottom",void 0);Y("BABYLON.DirectionalLight",Ar);class zg{constructor(){this.rootNodes=[],this.cameras=[],this.lights=[],this.meshes=[],this.skeletons=[],this.particleSystems=[],this.animations=[],this.animationGroups=[],this.multiMaterials=[],this.materials=[],this.morphTargetManagers=[],this.geometries=[],this.transformNodes=[],this.actionManagers=[],this.textures=[],this._environmentTexture=null,this.postProcesses=[],this.sounds=null,this.effectLayers=[],this.layers=[],this.reflectionProbes=[]}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e}getNodes(){let e=[];return e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes),this.skeletons.forEach(t=>e=e.concat(t.bones)),e}}class fb extends zg{}class ub{constructor(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[]}dispose(){this.rootNodes.slice(0).forEach(e=>{e.dispose()}),this.rootNodes.length=0,this.skeletons.slice(0).forEach(e=>{e.dispose()}),this.skeletons.length=0,this.animationGroups.slice(0).forEach(e=>{e.dispose()}),this.animationGroups.length=0}}class OL extends zg{constructor(e){super(),this._wasAddedToScene=!1,e=e||Re.LastCreatedScene,e&&(this.scene=e,this.proceduralTextures=[],e.onDisposeObservable.add(()=>{this._wasAddedToScene||this.dispose()}),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(()=>{for(const t of this.geometries)t._rebuild();for(const t of this.meshes)t._rebuild();for(const t of this.particleSystems)t.rebuild();for(const t of this.textures)t._rebuild()}))}_topologicalSort(e){const t=new Map;for(const o of e)t.set(o.uniqueId,o);const i={dependsOn:new Map,dependedBy:new Map};for(const o of e){const l=o.uniqueId;i.dependsOn.set(l,new Set),i.dependedBy.set(l,new Set)}for(const o of e){const l=o.uniqueId,c=i.dependsOn.get(l);if(o instanceof ho){const f=o.sourceMesh;t.has(f.uniqueId)&&(c.add(f.uniqueId),i.dependedBy.get(f.uniqueId).add(l))}const h=i.dependedBy.get(l);for(const f of o.getDescendants()){const u=f.uniqueId;t.has(u)&&(h.add(u),i.dependsOn.get(u).add(l))}}const r=[],s=[];for(const o of e){const l=o.uniqueId;i.dependsOn.get(l).size===0&&(s.push(o),t.delete(l))}const n=s;for(;n.length>0;){const o=n.shift();r.push(o);const l=i.dependedBy.get(o.uniqueId);for(const c of Array.from(l.values())){const h=i.dependsOn.get(c);h.delete(o.uniqueId),h.size===0&&t.get(c)&&(n.push(t.get(c)),t.delete(c))}}return t.size>0&&(B.Error("SceneSerializer._topologicalSort: There were unvisited nodes:"),t.forEach(o=>B.Error(o.name))),r}_addNodeAndDescendantsToList(e,t,i,r){if(!(!i||r&&!r(i)||t.has(i.uniqueId))){e.push(i),t.add(i.uniqueId);for(const s of i.getDescendants(!0))this._addNodeAndDescendantsToList(e,t,s,r)}}_isNodeInContainer(e){return e instanceof ei&&this.meshes.indexOf(e)!==-1||e instanceof we&&this.transformNodes.indexOf(e)!==-1||e instanceof ke&&this.lights.indexOf(e)!==-1||e instanceof Ce&&this.cameras.indexOf(e)!==-1}_isValidHierarchy(){for(const e of this.meshes)if(e.parent&&!this._isNodeInContainer(e.parent))return B.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.transformNodes)if(e.parent&&!this._isNodeInContainer(e.parent))return B.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.lights)if(e.parent&&!this._isNodeInContainer(e.parent))return B.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.cameras)if(e.parent&&!this._isNodeInContainer(e.parent))return B.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;return!0}instantiateModelsToScene(e,t=!1,i){this._isValidHierarchy()||k.Warn("SceneSerializer.InstantiateModelsToScene: The Asset Container hierarchy is not valid.");const r={},s={},n=new ub,o=[],l=[],c={doNotInstantiate:!0,...i},h=(p,g)=>{if(r[p.uniqueId]=g.uniqueId,s[g.uniqueId]=g,e&&(g.name=e(p.name)),g instanceof N){const E=g;if(E.morphTargetManager){const v=p.morphTargetManager;E.morphTargetManager=v.clone();for(let b=0;b<v.numTargets;b++){const R=v.getTarget(b),S=E.morphTargetManager.getTarget(b);r[R.uniqueId]=S.uniqueId,s[S.uniqueId]=S}}}},f=[],u=new Set;for(const p of this.transformNodes)p.parent===null&&this._addNodeAndDescendantsToList(f,u,p,c.predicate);for(const p of this.meshes)p.parent===null&&this._addNodeAndDescendantsToList(f,u,p,c.predicate);const d=this._topologicalSort(f),_=(p,g)=>{if(h(p,g),p.parent){const E=r[p.parent.uniqueId],v=s[E];v?g.parent=v:g.parent=p.parent}if(g.position&&p.position&&g.position.copyFrom(p.position),g.rotationQuaternion&&p.rotationQuaternion&&g.rotationQuaternion.copyFrom(p.rotationQuaternion),g.rotation&&p.rotation&&g.rotation.copyFrom(p.rotation),g.scaling&&p.scaling&&g.scaling.copyFrom(p.scaling),g.material){const E=g;if(E.material)if(t){const v=p.material;if(l.indexOf(v)===-1){let b=v.clone(e?e(v.name):"Clone of "+v.name);if(l.push(v),r[v.uniqueId]=b.uniqueId,s[b.uniqueId]=b,v.getClassName()==="MultiMaterial"){const R=v;for(const S of R.subMaterials)S&&(b=S.clone(e?e(S.name):"Clone of "+S.name),l.push(S),r[S.uniqueId]=b.uniqueId,s[b.uniqueId]=b);R.subMaterials=R.subMaterials.map(S=>S&&s[r[S.uniqueId]])}}E.getClassName()!=="InstancedMesh"&&(E.material=s[r[v.uniqueId]])}else E.material.getClassName()==="MultiMaterial"?this.scene.multiMaterials.indexOf(E.material)===-1&&this.scene.addMultiMaterial(E.material):this.scene.materials.indexOf(E.material)===-1&&this.scene.addMaterial(E.material)}g.parent===null&&n.rootNodes.push(g)};return d.forEach(p=>{if(p.getClassName()==="InstancedMesh"){const g=p,E=g.sourceMesh,v=r[E.uniqueId],R=(typeof v=="number"?s[v]:E).createInstance(g.name);_(g,R)}else{let g=!0;p.getClassName()==="TransformNode"||p.getClassName()==="Node"||p.skeleton||!p.getTotalVertices||p.getTotalVertices()===0?g=!1:c.doNotInstantiate&&(typeof c.doNotInstantiate=="function"?g=!c.doNotInstantiate(p):g=!c.doNotInstantiate);const E=g?p.createInstance(`instance of ${p.name}`):p.clone(`Clone of ${p.name}`,null,!0);if(!E)throw new Error(`Could not clone or instantiate node on Asset Container ${p.name}`);_(p,E)}}),this.skeletons.forEach(p=>{if(c.predicate&&!c.predicate(p))return;const g=p.clone(e?e(p.name):"Clone of "+p.name);for(const E of this.meshes)if(E.skeleton===p&&!E.isAnInstance){const v=s[r[E.uniqueId]];if(!v||v.isAnInstance||(v.skeleton=g,o.indexOf(g)!==-1))continue;o.push(g);for(const b of g.bones)b._linkedTransformNode&&(b._linkedTransformNode=s[r[b._linkedTransformNode.uniqueId]])}n.skeletons.push(g)}),this.animationGroups.forEach(p=>{if(c.predicate&&!c.predicate(p))return;const g=p.clone(e?e(p.name):"Clone of "+p.name,E=>s[r[E.uniqueId]]||E);n.animationGroups.push(g)}),n}addAllToScene(){if(!this._wasAddedToScene){this._isValidHierarchy()||k.Warn("SceneSerializer.addAllToScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!0,this.addToScene(null),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture);for(const e of this.scene._serializableComponents)e.addFromContainer(this);this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null}}addToScene(e=null){const t=[];this.cameras.forEach(i=>{e&&!e(i)||(this.scene.addCamera(i),t.push(i))}),this.lights.forEach(i=>{e&&!e(i)||(this.scene.addLight(i),t.push(i))}),this.meshes.forEach(i=>{e&&!e(i)||(this.scene.addMesh(i),t.push(i))}),this.skeletons.forEach(i=>{e&&!e(i)||this.scene.addSkeleton(i)}),this.animations.forEach(i=>{e&&!e(i)||this.scene.addAnimation(i)}),this.animationGroups.forEach(i=>{e&&!e(i)||this.scene.addAnimationGroup(i)}),this.multiMaterials.forEach(i=>{e&&!e(i)||this.scene.addMultiMaterial(i)}),this.materials.forEach(i=>{e&&!e(i)||this.scene.addMaterial(i)}),this.morphTargetManagers.forEach(i=>{e&&!e(i)||this.scene.addMorphTargetManager(i)}),this.geometries.forEach(i=>{e&&!e(i)||this.scene.addGeometry(i)}),this.transformNodes.forEach(i=>{e&&!e(i)||(this.scene.addTransformNode(i),t.push(i))}),this.actionManagers.forEach(i=>{e&&!e(i)||this.scene.addActionManager(i)}),this.textures.forEach(i=>{e&&!e(i)||this.scene.addTexture(i)}),this.reflectionProbes.forEach(i=>{e&&!e(i)||this.scene.addReflectionProbe(i)});for(const i of t)i.parent&&this.scene.getNodes().indexOf(i.parent)===-1&&(i.setParent?i.setParent(null):i.parent=null)}removeAllFromScene(){this._isValidHierarchy()||k.Warn("SceneSerializer.removeAllFromScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!1,this.removeFromScene(null),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this)}removeFromScene(e=null){this.cameras.forEach(t=>{e&&!e(t)||this.scene.removeCamera(t)}),this.lights.forEach(t=>{e&&!e(t)||this.scene.removeLight(t)}),this.meshes.forEach(t=>{e&&!e(t)||this.scene.removeMesh(t,!0)}),this.skeletons.forEach(t=>{e&&!e(t)||this.scene.removeSkeleton(t)}),this.animations.forEach(t=>{e&&!e(t)||this.scene.removeAnimation(t)}),this.animationGroups.forEach(t=>{e&&!e(t)||this.scene.removeAnimationGroup(t)}),this.multiMaterials.forEach(t=>{e&&!e(t)||this.scene.removeMultiMaterial(t)}),this.materials.forEach(t=>{e&&!e(t)||this.scene.removeMaterial(t)}),this.morphTargetManagers.forEach(t=>{e&&!e(t)||this.scene.removeMorphTargetManager(t)}),this.geometries.forEach(t=>{e&&!e(t)||this.scene.removeGeometry(t)}),this.transformNodes.forEach(t=>{e&&!e(t)||this.scene.removeTransformNode(t)}),this.actionManagers.forEach(t=>{e&&!e(t)||this.scene.removeActionManager(t)}),this.textures.forEach(t=>{e&&!e(t)||this.scene.removeTexture(t)}),this.reflectionProbes.forEach(t=>{e&&!e(t)||this.scene.removeReflectionProbe(t)})}dispose(){this.cameras.slice(0).forEach(e=>{e.dispose()}),this.cameras.length=0,this.lights.slice(0).forEach(e=>{e.dispose()}),this.lights.length=0,this.meshes.slice(0).forEach(e=>{e.dispose()}),this.meshes.length=0,this.skeletons.slice(0).forEach(e=>{e.dispose()}),this.skeletons.length=0,this.animationGroups.slice(0).forEach(e=>{e.dispose()}),this.animationGroups.length=0,this.multiMaterials.slice(0).forEach(e=>{e.dispose()}),this.multiMaterials.length=0,this.materials.slice(0).forEach(e=>{e.dispose()}),this.materials.length=0,this.geometries.slice(0).forEach(e=>{e.dispose()}),this.geometries.length=0,this.transformNodes.slice(0).forEach(e=>{e.dispose()}),this.transformNodes.length=0,this.actionManagers.slice(0).forEach(e=>{e.dispose()}),this.actionManagers.length=0,this.textures.slice(0).forEach(e=>{e.dispose()}),this.textures.length=0,this.reflectionProbes.slice(0).forEach(e=>{e.dispose()}),this.reflectionProbes.length=0,this.morphTargetManagers.slice(0).forEach(e=>{e.dispose()}),this.morphTargetManagers.length=0,this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this,!0);this._onContextRestoredObserver&&(this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}_moveAssets(e,t,i){if(!(!e||!t))for(const r of e){let s=!0;if(i){for(const n of i)if(r===n){s=!1;break}}s&&(t.push(r),r._parentContainer=this)}}moveAllFromScene(e){this._wasAddedToScene=!1,e===void 0&&(e=new fb);for(const t in this)Object.prototype.hasOwnProperty.call(this,t)&&(this[t]=this[t]||(t==="_environmentTexture"?null:[]),this._moveAssets(this.scene[t],this[t],e[t]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene()}createRootMesh(){const e=new N("assetContainerRootMesh",this.scene);return this.meshes.forEach(t=>{t.parent||e.addChild(t)}),this.meshes.unshift(e),e}mergeAnimationsTo(e=Re.LastCreatedScene,t,i=null){if(!e)return B.Error("No scene available to merge animations to"),[];const r=i||(o=>{let l=null;const c=o.animations.length?o.animations[0].targetProperty:"",h=o.name.split(".").join("").split("_primitive")[0];switch(c){case"position":case"rotationQuaternion":l=e.getTransformNodeByName(o.name)||e.getTransformNodeByName(h);break;case"influence":l=e.getMorphTargetByName(o.name)||e.getMorphTargetByName(h);break;default:l=e.getNodeByName(o.name)||e.getNodeByName(h)}return l});this.getNodes().forEach(o=>{const l=r(o);if(l!==null){for(const c of o.animations){const h=l.animations.filter(f=>f.targetProperty===c.targetProperty);for(const f of h){const u=l.animations.indexOf(f,0);u>-1&&l.animations.splice(u,1)}}l.animations=l.animations.concat(o.animations)}});const n=[];return this.animationGroups.slice().forEach(o=>{n.push(o.clone(o.name,r)),o.animatables.forEach(l=>{l.stop()})}),t.forEach(o=>{const l=r(o.target);l&&(e.beginAnimation(l,o.fromFrame,o.toFrame,o.loopAnimation,o.speedRatio,o.onAnimationEnd?o.onAnimationEnd:void 0,void 0,!0,void 0,o.onAnimationLoop?o.onAnimationLoop:void 0),e.stopAnimation(o.target))}),n}populateRootNodes(){this.rootNodes.length=0,this.meshes.forEach(e=>{!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e)}),this.transformNodes.forEach(e=>{!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e)}),this.lights.forEach(e=>{!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e)}),this.cameras.forEach(e=>{!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e)})}addAllAssetsToContainer(e){if(!e)return;const t=[],i=new Set;for(t.push(e);t.length>0;){const r=t.pop();if(r instanceof N?(r.geometry&&this.geometries.indexOf(r.geometry)===-1&&this.geometries.push(r.geometry),this.meshes.push(r)):r instanceof we?this.transformNodes.push(r):r instanceof ke?this.lights.push(r):r instanceof Ce&&this.cameras.push(r),r instanceof ei){if(r.material&&this.materials.indexOf(r.material)===-1){this.materials.push(r.material);for(const s of r.material.getActiveTextures())this.textures.indexOf(s)===-1&&this.textures.push(s)}r.skeleton&&this.skeletons.indexOf(r.skeleton)===-1&&this.skeletons.push(r.skeleton),r.morphTargetManager&&this.morphTargetManagers.indexOf(r.morphTargetManager)===-1&&this.morphTargetManagers.push(r.morphTargetManager)}for(const s of r.getChildren())i.has(s)||t.push(s);i.add(r)}this.populateRootNodes()}_getByTags(e,t,i){if(t===void 0)return e;const r=[];for(const s in e){const n=e[s];qe&&qe.MatchesQuery(n,t)&&(!i||i(n))&&r.push(n)}return r}getMeshesByTags(e,t){return this._getByTags(this.meshes,e,t)}getCamerasByTags(e,t){return this._getByTags(this.cameras,e,t)}getLightsByTags(e,t){return this._getByTags(this.lights,e,t)}getMaterialsByTags(e,t){return this._getByTags(this.materials,e,t).concat(this._getByTags(this.multiMaterials,e,t))}getTransformNodesByTags(e,t){return this._getByTags(this.transformNodes,e,t)}}class DL{constructor(e){this.byteOffset=0,this.buffer=e}loadAsync(e){return this.buffer.readAsync(this.byteOffset,e).then(t=>{this._dataView=new DataView(t.buffer,t.byteOffset,t.byteLength),this._dataByteOffset=0})}readUint32(){const e=this._dataView.getUint32(this._dataByteOffset,!0);return this._dataByteOffset+=4,this.byteOffset+=4,e}readUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._dataByteOffset,e);return this._dataByteOffset+=e,this.byteOffset+=e,t}readString(e){return kS(this.readUint8Array(e))}skipBytes(e){this._dataByteOffset+=e,this.byteOffset+=e}}class Hi extends Z{constructor(e,t,i,r,s,n=!0,o=!1,l=3,c=0,h,f,u){super(null,s,!n,o,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,h),this.format=r,this._engine&&(!this._engine._caps.textureFloatLinearFiltering&&c===1&&(l=1),!this._engine._caps.textureHalfFloatLinearFiltering&&c===2&&(l=1),this._texture=this._engine.createRawTexture(e,t,i,r,n,o,l,null,c,h??0,f??!1),this.wrapU=Z.CLAMP_ADDRESSMODE,this.wrapV=Z.CLAMP_ADDRESSMODE,this._waitingForData=!!u&&!e)}update(e){this._getEngine().updateRawTexture(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type,this._texture._useSRGBBuffer),this._waitingForData=!1}clone(){if(!this._texture)return super.clone();const e=new Hi(null,this.getSize().width,this.getSize().height,this.format,this.getScene(),this._texture.generateMipMaps,this._invertY,this.samplingMode,this._texture.type,this._texture._creationFlags,this._useSRGBBuffer);return e._texture=this._texture,this._texture.incrementReferences(),e}isReady(){return super.isReady()&&!this._waitingForData}static CreateLuminanceTexture(e,t,i,r,s=!0,n=!1,o=3){return new Hi(e,t,i,1,r,s,n,o)}static CreateLuminanceAlphaTexture(e,t,i,r,s=!0,n=!1,o=3){return new Hi(e,t,i,2,r,s,n,o)}static CreateAlphaTexture(e,t,i,r,s=!0,n=!1,o=3){return new Hi(e,t,i,0,r,s,n,o)}static CreateRGBTexture(e,t,i,r,s=!0,n=!1,o=3,l=0,c=0,h=!1){return new Hi(e,t,i,4,r,s,n,o,l,c,h)}static CreateRGBATexture(e,t,i,r,s=!0,n=!1,o=3,l=0,c=0,h=!1,f=!1){return new Hi(e,t,i,5,r,s,n,o,l,c,h,f)}static CreateRGBAStorageTexture(e,t,i,r,s=!0,n=!1,o=3,l=0,c=!1){return new Hi(e,t,i,5,r,s,n,o,l,1,c)}static CreateRTexture(e,t,i,r,s=!0,n=!1,o=Z.TRILINEAR_SAMPLINGMODE,l=1){return new Hi(e,t,i,6,r,s,n,o,l)}static CreateRStorageTexture(e,t,i,r,s=!0,n=!1,o=Z.TRILINEAR_SAMPLINGMODE,l=1){return new Hi(e,t,i,6,r,s,n,o,l,1)}}class pl{get useTextureToStoreBoneMatrices(){return this._useTextureToStoreBoneMatrices}set useTextureToStoreBoneMatrices(e){this._useTextureToStoreBoneMatrices=e,this._markAsDirty()}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}get isUsingTextureForMatrices(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones}get uniqueId(){return this._uniqueId}constructor(e,t,i){this.name=e,this.id=t,this.bones=[],this.needInitialSkinMatrix=!1,this._isDirty=!0,this._meshesWithPoseMatrix=new Array,this._identity=P.Identity(),this._currentRenderId=-1,this._ranges={},this._absoluteTransformIsDirty=!0,this._canUseTextureForBones=!1,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._parentContainer=null,this.doNotSerialize=!1,this._useTextureToStoreBoneMatrices=!0,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new U,this.bones=[],this._scene=i||Re.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=!0;const r=this._scene.getEngine().getCaps();this._canUseTextureForBones=r.textureFloat&&r.maxVertexTextureImageUnits>0}getClassName(){return"Skeleton"}getChildren(){return this.bones.filter(e=>!e.getParent())}getTransformMatrices(e){if(this.needInitialSkinMatrix){if(!e)throw new Error("getTransformMatrices: When using the needInitialSkinMatrix flag, a mesh must be provided");return e._bonesTransformMatrices||this.prepare(!0),e._bonesTransformMatrices}return(!this._transformMatrices||this._isDirty)&&this.prepare(!this._transformMatrices),this._transformMatrices}getTransformMatrixTexture(e){return this.needInitialSkinMatrix&&e._transformMatrixTexture?e._transformMatrixTexture:this._transformMatrixTexture}getScene(){return this._scene}toString(e){let t=`Name: ${this.name}, nBones: ${this.bones.length}`;if(t+=`, nAnimationRanges: ${this._ranges?Object.keys(this._ranges).length:"none"}`,e){t+=", Ranges: {";let i=!0;for(const r in this._ranges)i&&(t+=", ",i=!1),t+=r;t+="}"}return t}getBoneIndexByName(e){for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].name===e)return t;return-1}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=new en(e,t,i);for(let r=0,s=this.bones.length;r<s;r++)this.bones[r].animations[0]&&this.bones[r].animations[0].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,r=this.bones.length;i<r;i++)this.bones[i].animations[0]&&this.bones[i].animations[0].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}copyAnimationRange(e,t,i=!1){if(this._ranges[t]||!e.getAnimationRange(t))return!1;let r=!0;const s=this._getHighestAnimationFrame()+1,n={},o=e.bones;let l,c;for(c=0,l=o.length;c<l;c++)n[o[c].name]=o[c];this.bones.length!==o.length&&(B.Warn(`copyAnimationRange: this rig has ${this.bones.length} bones, while source as ${o.length}`),r=!1);const h=i&&this.dimensionsAtRest&&e.dimensionsAtRest?this.dimensionsAtRest.divide(e.dimensionsAtRest):null;for(c=0,l=this.bones.length;c<l;c++){const u=this.bones[c].name,d=n[u];d?r=r&&this.bones[c].copyAnimationRange(d,t,s,i,h):(B.Warn("copyAnimationRange: not same rig, missing source bone "+u),r=!1)}const f=e.getAnimationRange(t);return f&&(this._ranges[t]=new en(t,f.from+s,f.to+s)),r}returnToRest(){for(const e of this.bones)e._index!==-1&&e.returnToRest()}_getHighestAnimationFrame(){let e=0;for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].animations[0]){const r=this.bones[t].animations[0].getHighestFrame();e<r&&(e=r)}return e}beginAnimation(e,t,i,r){const s=this.getAnimationRange(e);return s?this._scene.beginAnimation(this,s.from,s.to,t,i,r):null}static MakeAnimationAdditive(e,t=0,i){const r=e.getAnimationRange(i);if(!r)return null;const s=e._scene.getAllAnimatablesByTarget(e);let n=null;for(let l=0;l<s.length;l++){const c=s[l];if(c.fromFrame===(r==null?void 0:r.from)&&c.toFrame===(r==null?void 0:r.to)){n=c;break}}const o=e.getAnimatables();for(let l=0;l<o.length;l++){const h=o[l].animations;if(h)for(let f=0;f<h.length;f++)W.MakeAnimationAdditive(h[f],t,i)}return n&&(n.isAdditive=!0),e}_markAsDirty(){this._isDirty=!0,this._absoluteTransformIsDirty=!0}_registerMeshWithPoseMatrix(e){this._meshesWithPoseMatrix.push(e)}_unregisterMeshWithPoseMatrix(e){const t=this._meshesWithPoseMatrix.indexOf(e);t>-1&&this._meshesWithPoseMatrix.splice(t,1)}_computeTransformMatrices(e,t){this.onBeforeComputeObservable.notifyObservers(this);for(let i=0;i<this.bones.length;i++){const r=this.bones[i];r._childUpdateId++;const s=r.getParent();if(s?r.getLocalMatrix().multiplyToRef(s.getFinalMatrix(),r.getFinalMatrix()):t?r.getLocalMatrix().multiplyToRef(t,r.getFinalMatrix()):r.getFinalMatrix().copyFrom(r.getLocalMatrix()),r._index!==-1){const n=r._index===null?i:r._index;r.getAbsoluteInverseBindMatrix().multiplyToArray(r.getFinalMatrix(),e,n*16)}}this._identity.copyToArray(e,this.bones.length*16)}prepare(e=!1){if(!e){const t=this.getScene().getRenderId();if(this._currentRenderId===t)return;this._currentRenderId=t}if(this._numBonesWithLinkedTransformNode>0){for(const t of this.bones)if(t._linkedTransformNode){const i=t._linkedTransformNode;t.position=i.position,i.rotationQuaternion?t.rotationQuaternion=i.rotationQuaternion:t.rotation=i.rotation,t.scaling=i.scaling}}if(this.needInitialSkinMatrix)for(const t of this._meshesWithPoseMatrix){const i=t.getPoseMatrix();let r=this._isDirty;if((!t._bonesTransformMatrices||t._bonesTransformMatrices.length!==16*(this.bones.length+1))&&(t._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1)),r=!0),!!r){if(this._synchronizedWithMesh!==t){this._synchronizedWithMesh=t;for(const s of this.bones)s.getParent()||(s.getBindMatrix().multiplyToRef(i,F.Matrix[1]),s._updateAbsoluteBindMatrices(F.Matrix[1]));if(this.isUsingTextureForMatrices){const s=(this.bones.length+1)*4;(!t._transformMatrixTexture||t._transformMatrixTexture.getSize().width!==s)&&(t._transformMatrixTexture&&t._transformMatrixTexture.dispose(),t._transformMatrixTexture=Hi.CreateRGBATexture(t._bonesTransformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))}}this._computeTransformMatrices(t._bonesTransformMatrices,i),this.isUsingTextureForMatrices&&t._transformMatrixTexture&&t._transformMatrixTexture.update(t._bonesTransformMatrices)}}else{if(!this._isDirty)return;(!this._transformMatrices||this._transformMatrices.length!==16*(this.bones.length+1))&&(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=Hi.CreateRGBATexture(this._transformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices)}this._isDirty=!1}getAnimatables(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(let e=0;e<this.bones.length;e++)this._animatables.push(this.bones[e])}return this._animatables}clone(e,t){const i=new pl(e,t||e,this._scene);i.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let r=0;r<this.bones.length;r++){const s=this.bones[r];let n=null;const o=s.getParent();if(o){const c=this.bones.indexOf(o);n=i.bones[c]}const l=new mt(s.name,i,n,s.getBindMatrix().clone(),s.getRestMatrix().clone());l._index=s._index,s._linkedTransformNode&&l.linkTransformNode(s._linkedTransformNode),Da.DeepCopy(s.animations,l.animations)}if(this._ranges){i._ranges={};for(const r in this._ranges){const s=this._ranges[r];s&&(i._ranges[r]=s.clone())}}return this._isDirty=!0,i.prepare(!0),i}enableBlending(e=.01){this.bones.forEach(t=>{t.animations.forEach(i=>{i.enableBlending=!0,i.blendingSpeed=e})})}dispose(){if(this._meshesWithPoseMatrix.length=0,this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._parentContainer){const e=this._parentContainer.skeletons.indexOf(this);e>-1&&this._parentContainer.skeletons.splice(e,1),this._parentContainer=null}this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null)}serialize(){var t;const e={};e.name=this.name,e.id=this.id,this.dimensionsAtRest&&(e.dimensionsAtRest=this.dimensionsAtRest.asArray()),e.bones=[],e.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let i=0;i<this.bones.length;i++){const r=this.bones[i],s=r.getParent(),n={parentBoneIndex:s?this.bones.indexOf(s):-1,index:r.getIndex(),name:r.name,id:r.id,matrix:r.getBindMatrix().asArray(),rest:r.getRestMatrix().asArray(),linkedTransformNodeId:(t=r.getTransformNode())==null?void 0:t.id};e.bones.push(n),r.length&&(n.length=r.length),r.metadata&&(n.metadata=r.metadata),r.animations&&r.animations.length>0&&(n.animation=r.animations[0].serialize()),e.ranges=[];for(const o in this._ranges){const l=this._ranges[o];if(!l)continue;const c={};c.name=o,c.from=l.from,c.to=l.to,e.ranges.push(c)}}return e}static Parse(e,t){const i=new pl(e.name,e.id,t);e.dimensionsAtRest&&(i.dimensionsAtRest=m.FromArray(e.dimensionsAtRest)),i.needInitialSkinMatrix=e.needInitialSkinMatrix;let r;for(r=0;r<e.bones.length;r++){const s=e.bones[r],n=e.bones[r].index;let o=null;s.parentBoneIndex>-1&&(o=i.bones[s.parentBoneIndex]);const l=s.rest?P.FromArray(s.rest):null,c=new mt(s.name,i,o,P.FromArray(s.matrix),l,null,n);s.id!==void 0&&s.id!==null&&(c.id=s.id),s.length&&(c.length=s.length),s.metadata&&(c.metadata=s.metadata),s.animation&&c.animations.push(W.Parse(s.animation)),s.linkedTransformNodeId!==void 0&&s.linkedTransformNodeId!==null&&(i._hasWaitingData=!0,c._waitingTransformNodeId=s.linkedTransformNodeId)}if(e.ranges)for(r=0;r<e.ranges.length;r++){const s=e.ranges[r];i.createAnimationRange(s.name,s.from,s.to)}return i}computeAbsoluteMatrices(e=!1){(this._absoluteTransformIsDirty||e)&&(this.bones[0].computeAbsoluteMatrices(),this._absoluteTransformIsDirty=!1)}computeAbsoluteTransforms(e=!1){this.computeAbsoluteMatrices(e)}getPoseMatrix(){let e=null;return this._meshesWithPoseMatrix.length>0&&(e=this._meshesWithPoseMatrix[0].getPoseMatrix()),e}sortBones(){const e=[],t=new Array(this.bones.length);for(let i=0;i<this.bones.length;i++)this._sortBones(i,e,t);this.bones=e}_sortBones(e,t,i){if(i[e])return;i[e]=!0;const r=this.bones[e];if(!r)return;r._index===void 0&&(r._index=e);const s=r.getParent();s&&this._sortBones(this.bones.indexOf(s),t,i),t.push(r)}setCurrentPoseAsRest(){this.bones.forEach(e=>{e.setCurrentPoseAsRest()})}}gt.AddNodeConstructor("Light_Type_0",(a,e)=>()=>new rh(a,m.Zero(),e));class rh extends ys{get shadowAngle(){return this._shadowAngle}set shadowAngle(e){this._shadowAngle=e,this.forceProjectionMatrixCompute()}get direction(){return this._direction}set direction(e){const t=this.needCube();if(this._direction=e,this.needCube()!==t&&this._shadowGenerators){const i=this._shadowGenerators.values();for(let r=i.next();r.done!==!0;r=i.next())r.value.recreateShadowMap()}}constructor(e,t,i){super(e,i),this._shadowAngle=Math.PI/2,this.position=t}getClassName(){return"PointLight"}getTypeID(){return ke.LIGHTTYPEID_POINTLIGHT}needCube(){return!this.direction}getShadowDirection(e){if(this.direction)return super.getShadowDirection(e);switch(e){case 0:return new m(1,0,0);case 1:return new m(-1,0,0);case 2:return new m(0,-1,0);case 3:return new m(0,1,0);case 4:return new m(0,0,1);case 5:return new m(0,0,-1)}return m.Zero()}_setDefaultShadowProjectionMatrix(e,t,i){const r=this.getScene().activeCamera;if(!r)return;const s=this.shadowMinZ!==void 0?this.shadowMinZ:r.minZ,n=this.shadowMaxZ!==void 0?this.shadowMaxZ:r.maxZ,o=this.getScene().getEngine().useReverseDepthBuffer;P.PerspectiveFovLHToRef(this.shadowAngle,1,o?n:s,o?s:n,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,o)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0,t):this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,0,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,0,0,t),this}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?e.setFloat3(t,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z):e.setFloat3(t,this.position.x,this.position.y,this.position.z),this}prepareLightSpecificDefines(e,t){e["POINTLIGHT"+t]=!0}}A([y()],rh.prototype,"shadowAngle",null);Y("BABYLON.PointLight",rh);gt.AddNodeConstructor("Light_Type_2",(a,e)=>()=>new Pi(a,m.Zero(),m.Zero(),0,0,e));class Pi extends ys{get iesProfileTexture(){return this._iesProfileTexture}set iesProfileTexture(e){this._iesProfileTexture!==e&&(this._iesProfileTexture=e,this._iesProfileTexture&&Pi._IsTexture(this._iesProfileTexture)&&this._iesProfileTexture.onLoadObservable.addOnce(()=>{this._markMeshesAsLightDirty()}))}get angle(){return this._angle}set angle(e){this._angle=e,this._cosHalfAngle=Math.cos(e*.5),this._projectionTextureProjectionLightDirty=!0,this.forceProjectionMatrixCompute(),this._computeAngleValues()}get innerAngle(){return this._innerAngle}set innerAngle(e){this._innerAngle=e,this._computeAngleValues()}get shadowAngleScale(){return this._shadowAngleScale}set shadowAngleScale(e){this._shadowAngleScale=e,this.forceProjectionMatrixCompute()}get projectionTextureMatrix(){return this._projectionTextureMatrix}get projectionTextureLightNear(){return this._projectionTextureLightNear}set projectionTextureLightNear(e){this._projectionTextureLightNear=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureLightFar(){return this._projectionTextureLightFar}set projectionTextureLightFar(e){this._projectionTextureLightFar=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureUpDirection(){return this._projectionTextureUpDirection}set projectionTextureUpDirection(e){this._projectionTextureUpDirection=e,this._projectionTextureProjectionLightDirty=!0}get projectionTexture(){return this._projectionTexture}set projectionTexture(e){this._projectionTexture!==e&&(this._projectionTexture=e,this._projectionTextureDirty=!0,this._projectionTexture&&!this._projectionTexture.isReady()&&(Pi._IsProceduralTexture(this._projectionTexture)?this._projectionTexture.getEffect().executeWhenCompiled(()=>{this._markMeshesAsLightDirty()}):Pi._IsTexture(this._projectionTexture)&&this._projectionTexture.onLoadObservable.addOnce(()=>{this._markMeshesAsLightDirty()})))}static _IsProceduralTexture(e){return e.onGeneratedObservable!==void 0}static _IsTexture(e){return e.onLoadObservable!==void 0}get projectionTextureProjectionLightMatrix(){return this._projectionTextureProjectionLightMatrix}set projectionTextureProjectionLightMatrix(e){this._projectionTextureProjectionLightMatrix=e,this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0}constructor(e,t,i,r,s,n){super(e,n),this._innerAngle=0,this._iesProfileTexture=null,this._projectionTextureMatrix=P.Zero(),this._projectionTextureLightNear=1e-6,this._projectionTextureLightFar=1e3,this._projectionTextureUpDirection=m.Up(),this._projectionTextureViewLightDirty=!0,this._projectionTextureProjectionLightDirty=!0,this._projectionTextureDirty=!0,this._projectionTextureViewTargetVector=m.Zero(),this._projectionTextureViewLightMatrix=P.Zero(),this._projectionTextureProjectionLightMatrix=P.Zero(),this._projectionTextureScalingMatrix=P.FromValues(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1),this.position=t,this.direction=i,this.angle=r,this.exponent=s}getClassName(){return"SpotLight"}getTypeID(){return ke.LIGHTTYPEID_SPOTLIGHT}_setDirection(e){super._setDirection(e),this._projectionTextureViewLightDirty=!0}_setPosition(e){super._setPosition(e),this._projectionTextureViewLightDirty=!0}_setDefaultShadowProjectionMatrix(e,t,i){const r=this.getScene().activeCamera;if(!r)return;this._shadowAngleScale=this._shadowAngleScale||1;const s=this._shadowAngleScale*this._angle,n=this.shadowMinZ!==void 0?this.shadowMinZ:r.minZ,o=this.shadowMaxZ!==void 0?this.shadowMaxZ:r.maxZ,l=this.getScene().getEngine().useReverseDepthBuffer;P.PerspectiveFovLHToRef(s,1,l?o:n,l?n:o,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,l)}_computeProjectionTextureViewLightMatrix(){this._projectionTextureViewLightDirty=!1,this._projectionTextureDirty=!0,this.getAbsolutePosition().addToRef(this.getShadowDirection(),this._projectionTextureViewTargetVector),P.LookAtLHToRef(this.getAbsolutePosition(),this._projectionTextureViewTargetVector,this._projectionTextureUpDirection,this._projectionTextureViewLightMatrix)}_computeProjectionTextureProjectionLightMatrix(){this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0;const e=this.projectionTextureLightFar,t=this.projectionTextureLightNear,i=e/(e-t),r=-i*t,s=1/Math.tan(this._angle/2);P.FromValuesToRef(s/1,0,0,0,0,s,0,0,0,0,i,1,0,0,r,0,this._projectionTextureProjectionLightMatrix)}_computeProjectionTextureMatrix(){if(this._projectionTextureDirty=!1,this._projectionTextureViewLightMatrix.multiplyToRef(this._projectionTextureProjectionLightMatrix,this._projectionTextureMatrix),this._projectionTexture instanceof Z){const e=this._projectionTexture.uScale/2,t=this._projectionTexture.vScale/2;P.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,.5,0,.5,.5,.5,1,this._projectionTextureScalingMatrix)}this._projectionTextureMatrix.multiplyToRef(this._projectionTextureScalingMatrix,this._projectionTextureMatrix)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightDirection",3),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}_computeAngleValues(){this._lightAngleScale=1/Math.max(.001,Math.cos(this._innerAngle*.5)-this._cosHalfAngle),this._lightAngleOffset=-this._cosHalfAngle*this._lightAngleScale}transferTexturesToEffect(e,t){return this.projectionTexture&&this.projectionTexture.isReady()&&(this._projectionTextureViewLightDirty&&this._computeProjectionTextureViewLightMatrix(),this._projectionTextureProjectionLightDirty&&this._computeProjectionTextureProjectionLightMatrix(),this._projectionTextureDirty&&this._computeProjectionTextureMatrix(),e.setMatrix("textureProjectionMatrix"+t,this._projectionTextureMatrix),e.setTexture("projectionLightTexture"+t,this.projectionTexture)),this._iesProfileTexture&&this._iesProfileTexture.isReady()&&e.setTexture("iesLightTexture"+t,this._iesProfileTexture),this}transferToEffect(e,t){let i;return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,this.exponent,t),i=m.Normalize(this.transformedDirection)):(this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,this.exponent,t),i=m.Normalize(this.direction)),this._uniformBuffer.updateFloat4("vLightDirection",i.x,i.y,i.z,this._cosHalfAngle,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,this._lightAngleScale,this._lightAngleOffset,t),this}transferToNodeMaterialEffect(e,t){let i;return this.computeTransformedInformation()?i=m.Normalize(this.transformedDirection):i=m.Normalize(this.direction),this.getScene().useRightHandedSystem?e.setFloat3(t,-i.x,-i.y,-i.z):e.setFloat3(t,i.x,i.y,i.z),this}dispose(){super.dispose(),this._projectionTexture&&this._projectionTexture.dispose(),this._iesProfileTexture&&(this._iesProfileTexture.dispose(),this._iesProfileTexture=null)}getDepthMinZ(e){const t=this._scene.getEngine(),i=this.shadowMinZ!==void 0?this.shadowMinZ:(e==null?void 0:e.minZ)??0;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?i:this._scene.getEngine().isNDCHalfZRange?0:i}getDepthMaxZ(e){const t=this._scene.getEngine(),i=this.shadowMaxZ!==void 0?this.shadowMaxZ:(e==null?void 0:e.maxZ)??1e4;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:i}prepareLightSpecificDefines(e,t){e["SPOTLIGHT"+t]=!0,e["PROJECTEDLIGHTTEXTURE"+t]=!!(this.projectionTexture&&this.projectionTexture.isReady()),e["IESLIGHTTEXTURE"+t]=!!(this._iesProfileTexture&&this._iesProfileTexture.isReady())}}A([y()],Pi.prototype,"angle",null);A([y()],Pi.prototype,"innerAngle",null);A([y()],Pi.prototype,"shadowAngleScale",null);A([y()],Pi.prototype,"exponent",void 0);A([y()],Pi.prototype,"projectionTextureLightNear",null);A([y()],Pi.prototype,"projectionTextureLightFar",null);A([y()],Pi.prototype,"projectionTextureUpDirection",null);A([Je("projectedLightTexture")],Pi.prototype,"_projectionTexture",void 0);Y("BABYLON.SpotLight",Pi);class D{}D.AUTOSAMPLERSUFFIX="Sampler";D.DISABLEUA="#define DISABLE_UNIFORMITY_ANALYSIS";D.ALPHA_DISABLE=0;D.ALPHA_ADD=1;D.ALPHA_COMBINE=2;D.ALPHA_SUBTRACT=3;D.ALPHA_MULTIPLY=4;D.ALPHA_MAXIMIZED=5;D.ALPHA_ONEONE=6;D.ALPHA_PREMULTIPLIED=7;D.ALPHA_PREMULTIPLIED_PORTERDUFF=8;D.ALPHA_INTERPOLATE=9;D.ALPHA_SCREENMODE=10;D.ALPHA_ONEONE_ONEONE=11;D.ALPHA_ALPHATOCOLOR=12;D.ALPHA_REVERSEONEMINUS=13;D.ALPHA_SRC_DSTONEMINUSSRCALPHA=14;D.ALPHA_ONEONE_ONEZERO=15;D.ALPHA_EXCLUSION=16;D.ALPHA_LAYER_ACCUMULATE=17;D.ALPHA_EQUATION_ADD=0;D.ALPHA_EQUATION_SUBSTRACT=1;D.ALPHA_EQUATION_REVERSE_SUBTRACT=2;D.ALPHA_EQUATION_MAX=3;D.ALPHA_EQUATION_MIN=4;D.ALPHA_EQUATION_DARKEN=5;D.DELAYLOADSTATE_NONE=0;D.DELAYLOADSTATE_LOADED=1;D.DELAYLOADSTATE_LOADING=2;D.DELAYLOADSTATE_NOTLOADED=4;D.NEVER=512;D.ALWAYS=519;D.LESS=513;D.EQUAL=514;D.LEQUAL=515;D.GREATER=516;D.GEQUAL=518;D.NOTEQUAL=517;D.KEEP=7680;D.ZERO=0;D.REPLACE=7681;D.INCR=7682;D.DECR=7683;D.INVERT=5386;D.INCR_WRAP=34055;D.DECR_WRAP=34056;D.TEXTURE_CLAMP_ADDRESSMODE=0;D.TEXTURE_WRAP_ADDRESSMODE=1;D.TEXTURE_MIRROR_ADDRESSMODE=2;D.TEXTURE_CREATIONFLAG_STORAGE=1;D.TEXTUREFORMAT_ALPHA=0;D.TEXTUREFORMAT_LUMINANCE=1;D.TEXTUREFORMAT_LUMINANCE_ALPHA=2;D.TEXTUREFORMAT_RGB=4;D.TEXTUREFORMAT_RGBA=5;D.TEXTUREFORMAT_RED=6;D.TEXTUREFORMAT_R=6;D.TEXTUREFORMAT_R16_UNORM=33322;D.TEXTUREFORMAT_RG16_UNORM=33324;D.TEXTUREFORMAT_RGB16_UNORM=32852;D.TEXTUREFORMAT_RGBA16_UNORM=32859;D.TEXTUREFORMAT_R16_SNORM=36760;D.TEXTUREFORMAT_RG16_SNORM=36761;D.TEXTUREFORMAT_RGB16_SNORM=36762;D.TEXTUREFORMAT_RGBA16_SNORM=36763;D.TEXTUREFORMAT_RG=7;D.TEXTUREFORMAT_RED_INTEGER=8;D.TEXTUREFORMAT_R_INTEGER=8;D.TEXTUREFORMAT_RG_INTEGER=9;D.TEXTUREFORMAT_RGB_INTEGER=10;D.TEXTUREFORMAT_RGBA_INTEGER=11;D.TEXTUREFORMAT_BGRA=12;D.TEXTUREFORMAT_DEPTH24_STENCIL8=13;D.TEXTUREFORMAT_DEPTH32_FLOAT=14;D.TEXTUREFORMAT_DEPTH16=15;D.TEXTUREFORMAT_DEPTH24=16;D.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8=17;D.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8=18;D.TEXTUREFORMAT_STENCIL8=19;D.TEXTUREFORMAT_UNDEFINED=4294967295;D.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM=36492;D.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_BPTC_UNORM=36493;D.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT=36495;D.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_SIGNED_FLOAT=36494;D.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5=33779;D.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919;D.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT3=33778;D.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918;D.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1=33777;D.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1=33776;D.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917;D.TEXTUREFORMAT_COMPRESSED_SRGB_S3TC_DXT1_EXT=35916;D.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4=37808;D.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840;D.TEXTUREFORMAT_COMPRESSED_RGB_ETC1_WEBGL=36196;D.TEXTUREFORMAT_COMPRESSED_RGB8_ETC2=37492;D.TEXTUREFORMAT_COMPRESSED_SRGB8_ETC2=37493;D.TEXTUREFORMAT_COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494;D.TEXTUREFORMAT_COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495;D.TEXTUREFORMAT_COMPRESSED_RGBA8_ETC2_EAC=37496;D.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497;D.TEXTURETYPE_UNSIGNED_BYTE=0;D.TEXTURETYPE_UNSIGNED_INT=0;D.TEXTURETYPE_FLOAT=1;D.TEXTURETYPE_HALF_FLOAT=2;D.TEXTURETYPE_BYTE=3;D.TEXTURETYPE_SHORT=4;D.TEXTURETYPE_UNSIGNED_SHORT=5;D.TEXTURETYPE_INT=6;D.TEXTURETYPE_UNSIGNED_INTEGER=7;D.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8;D.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9;D.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10;D.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11;D.TEXTURETYPE_UNSIGNED_INT_24_8=12;D.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13;D.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14;D.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15;D.TEXTURETYPE_UNDEFINED=16;D.TEXTURE_2D=3553;D.TEXTURE_2D_ARRAY=35866;D.TEXTURE_CUBE_MAP=34067;D.TEXTURE_CUBE_MAP_ARRAY=3735928559;D.TEXTURE_3D=32879;D.TEXTURE_NEAREST_SAMPLINGMODE=1;D.TEXTURE_NEAREST_NEAREST=1;D.TEXTURE_BILINEAR_SAMPLINGMODE=2;D.TEXTURE_LINEAR_LINEAR=2;D.TEXTURE_TRILINEAR_SAMPLINGMODE=3;D.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3;D.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4;D.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5;D.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6;D.TEXTURE_NEAREST_LINEAR=7;D.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8;D.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9;D.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10;D.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11;D.TEXTURE_LINEAR_NEAREST=12;D.TEXTURE_EXPLICIT_MODE=0;D.TEXTURE_SPHERICAL_MODE=1;D.TEXTURE_PLANAR_MODE=2;D.TEXTURE_CUBIC_MODE=3;D.TEXTURE_PROJECTION_MODE=4;D.TEXTURE_SKYBOX_MODE=5;D.TEXTURE_INVCUBIC_MODE=6;D.TEXTURE_EQUIRECTANGULAR_MODE=7;D.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8;D.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;D.TEXTURE_FILTERING_QUALITY_OFFLINE=4096;D.TEXTURE_FILTERING_QUALITY_HIGH=64;D.TEXTURE_FILTERING_QUALITY_MEDIUM=16;D.TEXTURE_FILTERING_QUALITY_LOW=8;D.SCALEMODE_FLOOR=1;D.SCALEMODE_NEAREST=2;D.SCALEMODE_CEILING=3;D.MATERIAL_TextureDirtyFlag=1;D.MATERIAL_LightDirtyFlag=2;D.MATERIAL_FresnelDirtyFlag=4;D.MATERIAL_AttributesDirtyFlag=8;D.MATERIAL_MiscDirtyFlag=16;D.MATERIAL_PrePassDirtyFlag=32;D.MATERIAL_ImageProcessingDirtyFlag=64;D.MATERIAL_AllDirtyFlag=127;D.MATERIAL_TriangleFillMode=0;D.MATERIAL_WireFrameFillMode=1;D.MATERIAL_PointFillMode=2;D.MATERIAL_PointListDrawMode=3;D.MATERIAL_LineListDrawMode=4;D.MATERIAL_LineLoopDrawMode=5;D.MATERIAL_LineStripDrawMode=6;D.MATERIAL_TriangleStripDrawMode=7;D.MATERIAL_TriangleFanDrawMode=8;D.MATERIAL_ClockWiseSideOrientation=0;D.MATERIAL_CounterClockWiseSideOrientation=1;D.ACTION_NothingTrigger=0;D.ACTION_OnPickTrigger=1;D.ACTION_OnLeftPickTrigger=2;D.ACTION_OnRightPickTrigger=3;D.ACTION_OnCenterPickTrigger=4;D.ACTION_OnPickDownTrigger=5;D.ACTION_OnDoublePickTrigger=6;D.ACTION_OnPickUpTrigger=7;D.ACTION_OnPickOutTrigger=16;D.ACTION_OnLongPressTrigger=8;D.ACTION_OnPointerOverTrigger=9;D.ACTION_OnPointerOutTrigger=10;D.ACTION_OnEveryFrameTrigger=11;D.ACTION_OnIntersectionEnterTrigger=12;D.ACTION_OnIntersectionExitTrigger=13;D.ACTION_OnKeyDownTrigger=14;D.ACTION_OnKeyUpTrigger=15;D.PARTICLES_BILLBOARDMODE_Y=2;D.PARTICLES_BILLBOARDMODE_ALL=7;D.PARTICLES_BILLBOARDMODE_STRETCHED=8;D.PARTICLES_BILLBOARDMODE_STRETCHED_LOCAL=9;D.MESHES_CULLINGSTRATEGY_STANDARD=0;D.MESHES_CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1;D.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2;D.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3;D.SCENELOADER_NO_LOGGING=0;D.SCENELOADER_MINIMAL_LOGGING=1;D.SCENELOADER_SUMMARY_LOGGING=2;D.SCENELOADER_DETAILED_LOGGING=3;D.PREPASS_IRRADIANCE_TEXTURE_TYPE=0;D.PREPASS_POSITION_TEXTURE_TYPE=1;D.PREPASS_VELOCITY_TEXTURE_TYPE=2;D.PREPASS_REFLECTIVITY_TEXTURE_TYPE=3;D.PREPASS_COLOR_TEXTURE_TYPE=4;D.PREPASS_DEPTH_TEXTURE_TYPE=5;D.PREPASS_NORMAL_TEXTURE_TYPE=6;D.PREPASS_ALBEDO_SQRT_TEXTURE_TYPE=7;D.PREPASS_WORLD_NORMAL_TEXTURE_TYPE=8;D.PREPASS_LOCAL_POSITION_TEXTURE_TYPE=9;D.PREPASS_SCREENSPACE_DEPTH_TEXTURE_TYPE=10;D.PREPASS_VELOCITY_LINEAR_TEXTURE_TYPE=11;D.PREPASS_ALBEDO_TEXTURE_TYPE=12;D.BUFFER_CREATIONFLAG_READ=1;D.BUFFER_CREATIONFLAG_WRITE=2;D.BUFFER_CREATIONFLAG_READWRITE=3;D.BUFFER_CREATIONFLAG_UNIFORM=4;D.BUFFER_CREATIONFLAG_VERTEX=8;D.BUFFER_CREATIONFLAG_INDEX=16;D.BUFFER_CREATIONFLAG_STORAGE=32;D.BUFFER_CREATIONFLAG_INDIRECT=64;D.RENDERPASS_MAIN=0;D.INPUT_ALT_KEY=18;D.INPUT_CTRL_KEY=17;D.INPUT_META_KEY1=91;D.INPUT_META_KEY2=92;D.INPUT_META_KEY3=93;D.INPUT_SHIFT_KEY=16;D.SNAPSHOTRENDERING_STANDARD=0;D.SNAPSHOTRENDERING_FAST=1;D.PERSPECTIVE_CAMERA=0;D.ORTHOGRAPHIC_CAMERA=1;D.FOVMODE_VERTICAL_FIXED=0;D.FOVMODE_HORIZONTAL_FIXED=1;D.RIG_MODE_NONE=0;D.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10;D.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11;D.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12;D.RIG_MODE_STEREOSCOPIC_OVERUNDER=13;D.RIG_MODE_STEREOSCOPIC_INTERLACED=14;D.RIG_MODE_VR=20;D.RIG_MODE_CUSTOM=22;D.MAX_SUPPORTED_UV_SETS=6;D.GL_ALPHA_EQUATION_ADD=32774;D.GL_ALPHA_EQUATION_MIN=32775;D.GL_ALPHA_EQUATION_MAX=32776;D.GL_ALPHA_EQUATION_SUBTRACT=32778;D.GL_ALPHA_EQUATION_REVERSE_SUBTRACT=32779;D.GL_ALPHA_FUNCTION_SRC=768;D.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_COLOR=769;D.GL_ALPHA_FUNCTION_SRC_ALPHA=770;D.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA=771;D.GL_ALPHA_FUNCTION_DST_ALPHA=772;D.GL_ALPHA_FUNCTION_ONE_MINUS_DST_ALPHA=773;D.GL_ALPHA_FUNCTION_DST_COLOR=774;D.GL_ALPHA_FUNCTION_ONE_MINUS_DST_COLOR=775;D.GL_ALPHA_FUNCTION_SRC_ALPHA_SATURATED=776;D.GL_ALPHA_FUNCTION_CONSTANT_COLOR=32769;D.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_COLOR=32770;D.GL_ALPHA_FUNCTION_CONSTANT_ALPHA=32771;D.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_ALPHA=32772;D.GL_ALPHA_FUNCTION_SRC1_COLOR=35065;D.GL_ALPHA_FUNCTION_ONE_MINUS_SRC1_COLOR=35066;D.GL_ALPHA_FUNCTION_SRC1_ALPHA=34185;D.GL_ALPHA_FUNCTION_ONE_MINUS_SRC1_ALPHA=35067;D.SnippetUrl="https://snippet.babylonjs.com";D.FOGMODE_NONE=0;D.FOGMODE_EXP=1;D.FOGMODE_EXP2=2;D.FOGMODE_LINEAR=3;D.BYTE=5120;D.UNSIGNED_BYTE=5121;D.SHORT=5122;D.UNSIGNED_SHORT=5123;D.INT=5124;D.UNSIGNED_INT=5125;D.FLOAT=5126;D.PositionKind="position";D.NormalKind="normal";D.TangentKind="tangent";D.UVKind="uv";D.UV2Kind="uv2";D.UV3Kind="uv3";D.UV4Kind="uv4";D.UV5Kind="uv5";D.UV6Kind="uv6";D.ColorKind="color";D.ColorInstanceKind="instanceColor";D.MatricesIndicesKind="matricesIndices";D.MatricesWeightsKind="matricesWeights";D.MatricesIndicesExtraKind="matricesIndicesExtra";D.MatricesWeightsExtraKind="matricesWeightsExtra";D.ANIMATIONTYPE_FLOAT=0;D.ANIMATIONTYPE_VECTOR3=1;D.ANIMATIONTYPE_QUATERNION=2;D.ANIMATIONTYPE_MATRIX=3;D.ANIMATIONTYPE_COLOR3=4;D.ANIMATIONTYPE_COLOR4=7;D.ANIMATIONTYPE_VECTOR2=5;D.ANIMATIONTYPE_SIZE=6;D.ShadowMinZ=0;D.ShadowMaxZ=1e4;class LL{get resolve(){return this._resolve}get reject(){return this._reject}constructor(){this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}}class Ks{get influence(){return this._influence}set influence(e){if(this._influence===e)return;const t=this._influence;this._influence=e,this.onInfluenceChanged.hasObservers()&&this.onInfluenceChanged.notifyObservers(t===0||e===0)}get animationPropertiesOverride(){return!this._animationPropertiesOverride&&this._scene?this._scene.animationPropertiesOverride:this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}constructor(e,t=0,i=null){this.name=e,this.animations=[],this._positions=null,this._normals=null,this._tangents=null,this._uvs=null,this._uv2s=null,this._colors=null,this._uniqueId=0,this.onInfluenceChanged=new U,this._onDataLayoutChanged=new U,this._animationPropertiesOverride=null,this.id=e,this._scene=i||Re.LastCreatedScene,this.influence=t,this._scene&&(this._uniqueId=this._scene.getUniqueId())}get uniqueId(){return this._uniqueId}get hasPositions(){return!!this._positions}get hasNormals(){return!!this._normals}get hasTangents(){return!!this._tangents}get hasUVs(){return!!this._uvs}get hasUV2s(){return!!this._uv2s}get hasColors(){return!!this._colors}get vertexCount(){return this._positions?this._positions.length/3:this._normals?this._normals.length/3:this._tangents?this._tangents.length/3:this._uvs?this._uvs.length/2:this._uv2s?this._uv2s.length/2:this._colors?this._colors.length/4:0}setPositions(e){const t=this.hasPositions;this._positions=e,t!==this.hasPositions&&this._onDataLayoutChanged.notifyObservers(void 0)}getPositions(){return this._positions}setNormals(e){const t=this.hasNormals;this._normals=e,t!==this.hasNormals&&this._onDataLayoutChanged.notifyObservers(void 0)}getNormals(){return this._normals}setTangents(e){const t=this.hasTangents;this._tangents=e,t!==this.hasTangents&&this._onDataLayoutChanged.notifyObservers(void 0)}getTangents(){return this._tangents}setUVs(e){const t=this.hasUVs;this._uvs=e,t!==this.hasUVs&&this._onDataLayoutChanged.notifyObservers(void 0)}getUVs(){return this._uvs}setUV2s(e){const t=this.hasUV2s;this._uv2s=e,t!==this.hasUV2s&&this._onDataLayoutChanged.notifyObservers(void 0)}getUV2s(){return this._uv2s}setColors(e){const t=this.hasColors;this._colors=e,t!==this.hasColors&&this._onDataLayoutChanged.notifyObservers(void 0)}getColors(){return this._colors}clone(){const e=ye.Clone(()=>new Ks(this.name,this.influence,this._scene),this);return e._positions=this._positions,e._normals=this._normals,e._tangents=this._tangents,e._uvs=this._uvs,e._uv2s=this._uv2s,e._colors=this._colors,e}serialize(){const e={};return e.name=this.name,e.influence=this.influence,e.positions=Array.prototype.slice.call(this.getPositions()),this.id!=null&&(e.id=this.id),this.hasNormals&&(e.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(e.tangents=Array.prototype.slice.call(this.getTangents())),this.hasUVs&&(e.uvs=Array.prototype.slice.call(this.getUVs())),this.hasUV2s&&(e.uv2s=Array.prototype.slice.call(this.getUV2s())),this.hasColors&&(e.colors=Array.prototype.slice.call(this.getColors())),ye.AppendSerializedAnimations(this,e),e}getClassName(){return"MorphTarget"}static Parse(e,t){const i=new Ks(e.name,e.influence);if(i.setPositions(e.positions),e.id!=null&&(i.id=e.id),e.normals&&i.setNormals(e.normals),e.tangents&&i.setTangents(e.tangents),e.uvs&&i.setUVs(e.uvs),e.uv2s&&i.setUV2s(e.uv2s),e.colors&&i.setColors(e.colors),e.animations){for(let r=0;r<e.animations.length;r++){const s=e.animations[r],n=Ui("BABYLON.Animation");n&&i.animations.push(n.Parse(s))}e.autoAnimate&&t&&t.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1)}return i}static FromMesh(e,t,i){t||(t=e.name);const r=new Ks(t,i,e.getScene());return r.setPositions(e.getVerticesData(x.PositionKind)),e.isVerticesDataPresent(x.NormalKind)&&r.setNormals(e.getVerticesData(x.NormalKind)),e.isVerticesDataPresent(x.TangentKind)&&r.setTangents(e.getVerticesData(x.TangentKind)),e.isVerticesDataPresent(x.UVKind)&&r.setUVs(e.getVerticesData(x.UVKind)),e.isVerticesDataPresent(x.UV2Kind)&&r.setUV2s(e.getVerticesData(x.UV2Kind)),e.isVerticesDataPresent(x.ColorKind)&&r.setColors(e.getVerticesData(x.ColorKind)),r}}A([y()],Ks.prototype,"id",void 0);class sh extends Z{get depth(){return this._depth}constructor(e,t,i,r,s,n,o=!0,l=!1,c=Z.TRILINEAR_SAMPLINGMODE,h=0,f){super(null,n,!o,l),this.format=s,this._texture=n.getEngine().createRawTexture2DArray(e,t,i,r,s,o,l,c,null,h,f),this._depth=r,this.is2DArray=!0}update(e){this._texture&&this._getEngine().updateRawTexture2DArray(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)}static CreateRGBATexture(e,t,i,r,s,n=!0,o=!1,l=3,c=0){return new sh(e,t,i,r,5,s,n,o,l,c)}}class ms{set areUpdatesFrozen(e){e?this._blockCounter++:(this._blockCounter--,this._blockCounter<=0&&(this._blockCounter=0,this._syncActiveTargets(this._forceUpdateWhenUnfrozen),this._forceUpdateWhenUnfrozen=!1))}get areUpdatesFrozen(){return this._blockCounter>0}constructor(e=null){if(this._targets=new Array,this._targetInfluenceChangedObservers=new Array,this._targetDataLayoutChangedObservers=new Array,this._activeTargets=new jt(16),this._supportsPositions=!1,this._supportsNormals=!1,this._supportsTangents=!1,this._supportsUVs=!1,this._supportsUV2s=!1,this._supportsColors=!1,this._vertexCount=0,this._uniqueId=0,this._tempInfluences=new Array,this._canUseTextureForTargets=!1,this._blockCounter=0,this._mustSynchronize=!0,this._forceUpdateWhenUnfrozen=!1,this._textureVertexStride=0,this._textureWidth=0,this._textureHeight=1,this._parentContainer=null,this.optimizeInfluencers=!0,this.enablePositionMorphing=!0,this.enableNormalMorphing=!0,this.enableTangentMorphing=!0,this.enableUVMorphing=!0,this.enableUV2Morphing=!0,this.enableColorMorphing=!0,this._numMaxInfluencers=0,this._useTextureToStoreTargets=!0,e||(e=Re.LastCreatedScene),this._scene=e,this._scene){this._scene.addMorphTargetManager(this),this._uniqueId=this._scene.getUniqueId();const t=this._scene.getEngine().getCaps();this._canUseTextureForTargets=t.canUseGLVertexID&&t.textureFloat&&t.maxVertexTextureImageUnits>0&&t.texture2DArrayMaxLayerCount>1}}get numMaxInfluencers(){return this._numMaxInfluencers}set numMaxInfluencers(e){this._numMaxInfluencers!==e&&(this._numMaxInfluencers=e,this._mustSynchronize=!0,this._syncActiveTargets())}get uniqueId(){return this._uniqueId}get vertexCount(){return this._vertexCount}get supportsPositions(){return this._supportsPositions&&this.enablePositionMorphing}get supportsNormals(){return this._supportsNormals&&this.enableNormalMorphing}get supportsTangents(){return this._supportsTangents&&this.enableTangentMorphing}get supportsUVs(){return this._supportsUVs&&this.enableUVMorphing}get supportsUV2s(){return this._supportsUV2s&&this.enableUV2Morphing}get supportsColors(){return this._supportsColors&&this.enableColorMorphing}get hasPositions(){return this._supportsPositions}get hasNormals(){return this._supportsNormals}get hasTangents(){return this._supportsTangents}get hasUVs(){return this._supportsUVs}get hasUV2s(){return this._supportsUV2s}get hasColors(){return this._supportsColors}get numTargets(){return this._targets.length}get numInfluencers(){return this._activeTargets.length}get influences(){return this._influences}get useTextureToStoreTargets(){return this._useTextureToStoreTargets}set useTextureToStoreTargets(e){this._useTextureToStoreTargets!==e&&(this._useTextureToStoreTargets=e,this._mustSynchronize=!0,this._syncActiveTargets())}get isUsingTextureForTargets(){var e;return ms.EnableTextureStorage&&this.useTextureToStoreTargets&&this._canUseTextureForTargets&&!((e=this._scene)!=null&&e.getEngine().getCaps().disableMorphTargetTexture)}getActiveTarget(e){return this._activeTargets.data[e]}getTarget(e){return this._targets[e]}getTargetByName(e){for(const t of this._targets)if(t.name===e)return t;return null}addTarget(e){this._targets.push(e),this._targetInfluenceChangedObservers.push(e.onInfluenceChanged.add(t=>{this.areUpdatesFrozen&&t&&(this._forceUpdateWhenUnfrozen=!0),this._syncActiveTargets(t)})),this._targetDataLayoutChangedObservers.push(e._onDataLayoutChanged.add(()=>{this._mustSynchronize=!0,this._syncActiveTargets()})),this._mustSynchronize=!0,this._syncActiveTargets()}removeTarget(e){const t=this._targets.indexOf(e);t>=0&&(this._targets.splice(t,1),e.onInfluenceChanged.remove(this._targetInfluenceChangedObservers.splice(t,1)[0]),e._onDataLayoutChanged.remove(this._targetDataLayoutChangedObservers.splice(t,1)[0]),this._mustSynchronize=!0,this._syncActiveTargets()),this._scene&&this._scene.stopAnimation(e)}_bind(e){e.setFloat3("morphTargetTextureInfo",this._textureVertexStride,this._textureWidth,this._textureHeight),e.setFloatArray("morphTargetTextureIndices",this._morphTargetTextureIndices),e.setTexture("morphTargets",this._targetStoreTexture),e.setInt("morphTargetCount",this.numInfluencers)}clone(){const e=new ms(this._scene);for(const t of this._targets)e.addTarget(t.clone());return e.enablePositionMorphing=this.enablePositionMorphing,e.enableNormalMorphing=this.enableNormalMorphing,e.enableTangentMorphing=this.enableTangentMorphing,e.enableUVMorphing=this.enableUVMorphing,e.enableUV2Morphing=this.enableUV2Morphing,e.enableColorMorphing=this.enableColorMorphing,e}serialize(){const e={};e.id=this.uniqueId,e.targets=[];for(const t of this._targets)e.targets.push(t.serialize());return e}_syncActiveTargets(e=!1){if(this.areUpdatesFrozen)return;const t=!!this._targetStoreTexture,i=this.isUsingTextureForTargets;(this._mustSynchronize||t!==i)&&(this._mustSynchronize=!1,this.synchronize());let r=0;this._activeTargets.reset(),(!this._morphTargetTextureIndices||this._morphTargetTextureIndices.length!==this._targets.length)&&(this._morphTargetTextureIndices=new Float32Array(this._targets.length));let s=-1;for(const n of this._targets)if(s++,!(n.influence===0&&this.optimizeInfluencers)){if(this._activeTargets.length>=ms.MaxActiveMorphTargetsInVertexAttributeMode&&!this.isUsingTextureForTargets)break;this._activeTargets.push(n),this._morphTargetTextureIndices[r]=s,this._tempInfluences[r++]=n.influence}this._morphTargetTextureIndices.length!==r&&(this._morphTargetTextureIndices=this._morphTargetTextureIndices.slice(0,r)),(!this._influences||this._influences.length!==r)&&(this._influences=new Float32Array(r));for(let n=0;n<r;n++)this._influences[n]=this._tempInfluences[n];if(e&&this._scene)for(const n of this._scene.meshes)n.morphTargetManager===this&&(i?n._markSubMeshesAsAttributesDirty():n._syncGeometryWithMorphTargetManager())}synchronize(){var t;if(!this._scene||this.areUpdatesFrozen)return;const e=this._scene.getEngine();this._supportsPositions=!0,this._supportsNormals=!0,this._supportsTangents=!0,this._supportsUVs=!0,this._supportsUV2s=!0,this._supportsColors=!0,this._vertexCount=0,(t=this._targetStoreTexture)==null||t.dispose(),this._targetStoreTexture=null,this.isUsingTextureForTargets&&this._targets.length>e.getCaps().texture2DArrayMaxLayerCount&&(this.useTextureToStoreTargets=!1);for(const i of this._targets){this._supportsPositions=this._supportsPositions&&i.hasPositions,this._supportsNormals=this._supportsNormals&&i.hasNormals,this._supportsTangents=this._supportsTangents&&i.hasTangents,this._supportsUVs=this._supportsUVs&&i.hasUVs,this._supportsUV2s=this._supportsUV2s&&i.hasUV2s,this._supportsColors=this._supportsColors&&i.hasColors;const r=i.vertexCount;if(this._vertexCount===0)this._vertexCount=r;else if(this._vertexCount!==r){B.Error(`Incompatible target. Targets must all have the same vertices count. Current vertex count: ${this._vertexCount}, vertex count for target "${i.name}": ${r}`);return}}if(this.isUsingTextureForTargets){this._textureVertexStride=0,this._supportsPositions&&this._textureVertexStride++,this._supportsNormals&&this._textureVertexStride++,this._supportsTangents&&this._textureVertexStride++,this._supportsUVs&&this._textureVertexStride++,this._supportsUV2s&&this._textureVertexStride++,this._supportsColors&&this._textureVertexStride++,this._textureWidth=this._vertexCount*this._textureVertexStride||1,this._textureHeight=1;const i=e.getCaps().maxTextureSize;this._textureWidth>i&&(this._textureHeight=Math.ceil(this._textureWidth/i),this._textureWidth=i);const r=this._targets.length,s=new Float32Array(r*this._textureWidth*this._textureHeight*4);let n=0;for(let o=0;o<r;o++){const l=this._targets[o],c=l.getPositions(),h=l.getNormals(),f=l.getUVs(),u=l.getTangents(),d=l.getUV2s(),_=l.getColors();n=o*this._textureWidth*this._textureHeight*4;for(let p=0;p<this._vertexCount;p++)this._supportsPositions&&c&&(s[n]=c[p*3],s[n+1]=c[p*3+1],s[n+2]=c[p*3+2],n+=4),this._supportsNormals&&h&&(s[n]=h[p*3],s[n+1]=h[p*3+1],s[n+2]=h[p*3+2],n+=4),this._supportsUVs&&f&&(s[n]=f[p*2],s[n+1]=f[p*2+1],n+=4),this._supportsTangents&&u&&(s[n]=u[p*3],s[n+1]=u[p*3+1],s[n+2]=u[p*3+2],n+=4),this._supportsUV2s&&d&&(s[n]=d[p*2],s[n+1]=d[p*2+1],n+=4),this._supportsColors&&_&&(s[n]=_[p*4],s[n+1]=_[p*4+1],s[n+2]=_[p*4+2],s[n+3]=_[p*4+3],n+=4)}this._targetStoreTexture=sh.CreateRGBATexture(s,this._textureWidth,this._textureHeight,r,this._scene,!1,!1,1,1),this._targetStoreTexture.name=`Morph texture_${this.uniqueId}`}for(const i of this._scene.meshes)i.morphTargetManager===this&&i._syncGeometryWithMorphTargetManager()}dispose(){if(this._targetStoreTexture&&this._targetStoreTexture.dispose(),this._targetStoreTexture=null,this._scene){if(this._scene.removeMorphTargetManager(this),this._parentContainer){const e=this._parentContainer.morphTargetManagers.indexOf(this);e>-1&&this._parentContainer.morphTargetManagers.splice(e,1),this._parentContainer=null}for(const e of this._targets)this._scene.stopAnimation(e)}}static Parse(e,t){const i=new ms(t);for(const r of e.targets)i.addTarget(Ks.Parse(r,t));return i}}ms.EnableTextureStorage=!0;ms.MaxActiveMorphTargetsInVertexAttributeMode=8;function db(...a){const e=t=>!!t&&typeof t=="object";return a.reduce((t,i)=>(Object.keys(i).forEach(r=>{const s=t[r],n=i[r];Array.isArray(s)&&Array.isArray(n)?t[r]=s.concat(...n):e(s)&&e(n)?t[r]=db(s,n):t[r]=n}),t),{})}class Yg extends Jt{constructor(e,t,i,r=5,s=0,n=!1,o=!1,l=3,c=null){super("",e),this._texture=e.getEngine().createRawCubeTexture(t,i,r,s,n,o,l,c)}update(e,t,i,r,s=null){this._texture.getEngine().updateRawCubeTexture(this._texture,e,t,i,r,s)}updateRGBDAsync(e,t=null,i=.8,r=0){return II(this._texture,e,t,i,r).then(()=>{})}clone(){return ye.Clone(()=>{const e=this.getScene(),t=this._texture,i=new Yg(e,t._bufferViewArray,t.width,t.format,t.type,t.generateMipMaps,t.invertY,t.samplingMode,t._compression);return t.source===13&&i.updateRGBDAsync(t._bufferViewArrayArray,t._sphericalPolynomial,t._lodGenerationScale,t._lodGenerationOffset),i},this)}}N.prototype.thinInstanceAdd=function(a,e=!0){if(!this.getScene().getEngine().getCaps().instancedArrays)return B.Error("Thin Instances are not supported on this device as Instanced Array extension not supported"),-1;this._thinInstanceUpdateBufferSize("matrix",Array.isArray(a)?a.length:1);const t=this._thinInstanceDataStorage.instancesCount;if(Array.isArray(a))for(let i=0;i<a.length;++i)this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,a[i],i===a.length-1&&e);else this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,a,e);return t};N.prototype.thinInstanceAddSelf=function(a=!0){return this.thinInstanceAdd(P.IdentityReadOnly,a)};N.prototype.thinInstanceRegisterAttribute=function(a,e){a===x.ColorKind&&(a=x.ColorInstanceKind),this.removeVerticesData(a),this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.strides[a]=e,this._userThinInstanceBuffersStorage.sizes[a]=e*Math.max(32,this._thinInstanceDataStorage.instancesCount),this._userThinInstanceBuffersStorage.data[a]=new Float32Array(this._userThinInstanceBuffersStorage.sizes[a]),this._userThinInstanceBuffersStorage.vertexBuffers[a]=new x(this.getEngine(),this._userThinInstanceBuffersStorage.data[a],a,!0,!1,e,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[a])};N.prototype.thinInstanceSetMatrixAt=function(a,e,t=!0){if(!this._thinInstanceDataStorage.matrixData||a>=this._thinInstanceDataStorage.instancesCount)return!1;const i=this._thinInstanceDataStorage.matrixData;return e.copyToArray(i,a*16),this._thinInstanceDataStorage.worldMatrices&&(this._thinInstanceDataStorage.worldMatrices[a]=e),t&&(this.thinInstanceBufferUpdated("matrix"),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)),!0};N.prototype.thinInstanceSetAttributeAt=function(a,e,t,i=!0){return a===x.ColorKind&&(a=x.ColorInstanceKind),!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.data[a]||e>=this._thinInstanceDataStorage.instancesCount?!1:(this._thinInstanceUpdateBufferSize(a,0),this._userThinInstanceBuffersStorage.data[a].set(t,e*this._userThinInstanceBuffersStorage.strides[a]),i&&this.thinInstanceBufferUpdated(a),!0)};Object.defineProperty(N.prototype,"thinInstanceCount",{get:function(){return this._thinInstanceDataStorage.instancesCount},set:function(a){var i;const e=this._thinInstanceDataStorage.matrixData??((i=this.source)==null?void 0:i._thinInstanceDataStorage.matrixData),t=e?e.length/16:0;a<=t&&(this._thinInstanceDataStorage.instancesCount=a)},enumerable:!0,configurable:!0});N.prototype._thinInstanceCreateMatrixBuffer=function(a,e,t=!0){const i=new Cn(this.getEngine(),e,!t,16,!1,!0);for(let r=0;r<4;r++)this.setVerticesBuffer(i.createVertexBuffer(a+r,r*4,4));return i};N.prototype.thinInstanceSetBuffer=function(a,e,t=0,i=!0){var r,s,n;t=t||16,a==="matrix"?((r=this._thinInstanceDataStorage.matrixBuffer)==null||r.dispose(),this._thinInstanceDataStorage.matrixBuffer=null,this._thinInstanceDataStorage.matrixBufferSize=e?e.length:32*t,this._thinInstanceDataStorage.matrixData=e,this._thinInstanceDataStorage.worldMatrices=null,e!==null?(this._thinInstanceDataStorage.instancesCount=e.length/t,this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",e,i),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)):(this._thinInstanceDataStorage.instancesCount=0,this.doNotSyncBoundingInfo||this.refreshBoundingInfo())):a==="previousMatrix"?((s=this._thinInstanceDataStorage.previousMatrixBuffer)==null||s.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null,this._thinInstanceDataStorage.previousMatrixData=e,e!==null&&(this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",e,i))):(a===x.ColorKind&&(a=x.ColorInstanceKind),e===null?(n=this._userThinInstanceBuffersStorage)!=null&&n.data[a]&&(this.removeVerticesData(a),delete this._userThinInstanceBuffersStorage.data[a],delete this._userThinInstanceBuffersStorage.strides[a],delete this._userThinInstanceBuffersStorage.sizes[a],delete this._userThinInstanceBuffersStorage.vertexBuffers[a]):(this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.data[a]=e,this._userThinInstanceBuffersStorage.strides[a]=t,this._userThinInstanceBuffersStorage.sizes[a]=e.length,this._userThinInstanceBuffersStorage.vertexBuffers[a]=new x(this.getEngine(),e,a,!i,!1,t,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[a])))};N.prototype.thinInstanceBufferUpdated=function(a){var e,t,i;a==="matrix"?(this.thinInstanceAllowAutomaticStaticBufferRecreation&&this._thinInstanceDataStorage.matrixBuffer&&!this._thinInstanceDataStorage.matrixBuffer.isUpdatable()&&this._thinInstanceRecreateBuffer(a),(e=this._thinInstanceDataStorage.matrixBuffer)==null||e.updateDirectly(this._thinInstanceDataStorage.matrixData,0,this._thinInstanceDataStorage.instancesCount)):a==="previousMatrix"?(this.thinInstanceAllowAutomaticStaticBufferRecreation&&this._thinInstanceDataStorage.previousMatrixBuffer&&!this._thinInstanceDataStorage.previousMatrixBuffer.isUpdatable()&&this._thinInstanceRecreateBuffer(a),(t=this._thinInstanceDataStorage.previousMatrixBuffer)==null||t.updateDirectly(this._thinInstanceDataStorage.previousMatrixData,0,this._thinInstanceDataStorage.instancesCount)):(a===x.ColorKind&&(a=x.ColorInstanceKind),(i=this._userThinInstanceBuffersStorage)!=null&&i.vertexBuffers[a]&&(this.thinInstanceAllowAutomaticStaticBufferRecreation&&!this._userThinInstanceBuffersStorage.vertexBuffers[a].isUpdatable()&&this._thinInstanceRecreateBuffer(a),this._userThinInstanceBuffersStorage.vertexBuffers[a].updateDirectly(this._userThinInstanceBuffersStorage.data[a],0)))};N.prototype.thinInstancePartialBufferUpdate=function(a,e,t){var i;a==="matrix"?this._thinInstanceDataStorage.matrixBuffer&&this._thinInstanceDataStorage.matrixBuffer.updateDirectly(e,t):(a===x.ColorKind&&(a=x.ColorInstanceKind),(i=this._userThinInstanceBuffersStorage)!=null&&i.vertexBuffers[a]&&this._userThinInstanceBuffersStorage.vertexBuffers[a].updateDirectly(e,t))};N.prototype.thinInstanceGetWorldMatrices=function(){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return[];const a=this._thinInstanceDataStorage.matrixData;if(!this._thinInstanceDataStorage.worldMatrices){this._thinInstanceDataStorage.worldMatrices=[];for(let e=0;e<this._thinInstanceDataStorage.instancesCount;++e)this._thinInstanceDataStorage.worldMatrices[e]=P.FromArray(a,e*16)}return this._thinInstanceDataStorage.worldMatrices};N.prototype.thinInstanceRefreshBoundingInfo=function(a=!1,e=!1,t=!1){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return;const i=this._thinInstanceDataStorage.boundingVectors;if(a||!this.rawBoundingInfo){i.length=0,this.refreshBoundingInfo(e,t);const n=this.getBoundingInfo();this.rawBoundingInfo=new Mi(n.minimum,n.maximum)}const r=this.getBoundingInfo(),s=this._thinInstanceDataStorage.matrixData;if(i.length===0)for(let n=0;n<r.boundingBox.vectors.length;++n)i.push(r.boundingBox.vectors[n].clone());F.Vector3[0].setAll(Number.POSITIVE_INFINITY),F.Vector3[1].setAll(Number.NEGATIVE_INFINITY);for(let n=0;n<this._thinInstanceDataStorage.instancesCount;++n){P.FromArrayToRef(s,n*16,F.Matrix[0]);for(let o=0;o<i.length;++o)m.TransformCoordinatesToRef(i[o],F.Matrix[0],F.Vector3[2]),F.Vector3[0].minimizeInPlace(F.Vector3[2]),F.Vector3[1].maximizeInPlace(F.Vector3[2])}r.reConstruct(F.Vector3[0],F.Vector3[1]),this._updateBoundingInfo()};N.prototype._thinInstanceRecreateBuffer=function(a,e=!0){var t,i,r;a==="matrix"?((t=this._thinInstanceDataStorage.matrixBuffer)==null||t.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",this._thinInstanceDataStorage.matrixData,e)):a==="previousMatrix"?this._scene.needsPreviousWorldMatrices&&((i=this._thinInstanceDataStorage.previousMatrixBuffer)==null||i.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.previousMatrixData??this._thinInstanceDataStorage.matrixData,e)):(a===x.ColorKind&&(a=x.ColorInstanceKind),(r=this._userThinInstanceBuffersStorage.vertexBuffers[a])==null||r.dispose(),this._userThinInstanceBuffersStorage.vertexBuffers[a]=new x(this.getEngine(),this._userThinInstanceBuffersStorage.data[a],a,!e,!1,this._userThinInstanceBuffersStorage.strides[a],!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[a]))};N.prototype._thinInstanceUpdateBufferSize=function(a,e=1){var l,c,h;a===x.ColorKind&&(a=x.ColorInstanceKind);const t=a==="matrix";if(!t&&(!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.strides[a]))return;const i=t?16:this._userThinInstanceBuffersStorage.strides[a],r=t?this._thinInstanceDataStorage.matrixBufferSize:this._userThinInstanceBuffersStorage.sizes[a];let s=t?this._thinInstanceDataStorage.matrixData:this._userThinInstanceBuffersStorage.data[a];const n=(this._thinInstanceDataStorage.instancesCount+e)*i;let o=r;for(;o<n;)o*=2;if(!s||r!=o){if(!s)s=new Float32Array(o);else{const f=new Float32Array(o);f.set(s,0),s=f}t?((l=this._thinInstanceDataStorage.matrixBuffer)==null||l.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",s,!1),this._thinInstanceDataStorage.matrixData=s,this._thinInstanceDataStorage.matrixBufferSize=o,this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&((c=this._thinInstanceDataStorage.previousMatrixBuffer)==null||c.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",s,!1))):((h=this._userThinInstanceBuffersStorage.vertexBuffers[a])==null||h.dispose(),this._userThinInstanceBuffersStorage.data[a]=s,this._userThinInstanceBuffersStorage.sizes[a]=o,this._userThinInstanceBuffersStorage.vertexBuffers[a]=new x(this.getEngine(),s,a,!0,!1,i,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[a]))}};N.prototype._thinInstanceInitializeUserStorage=function(){this._userThinInstanceBuffersStorage||(this._userThinInstanceBuffersStorage={data:{},sizes:{},vertexBuffers:{},strides:{}})};N.prototype._disposeThinInstanceSpecificData=function(){var a;(a=this._thinInstanceDataStorage)!=null&&a.matrixBuffer&&(this._thinInstanceDataStorage.matrixBuffer.dispose(),this._thinInstanceDataStorage.matrixBuffer=null)};let jo=0,la=null;class Kr{static get Default(){return Kr._Default||(Kr._Default=new Kr),Kr._Default}constructor(){const e=Kr.Configuration.decoder;this._decoderModulePromise=k.LoadBabylonScriptAsync(e.url).then(()=>MeshoptDecoder.ready)}dispose(){delete this._decoderModulePromise}decodeGltfBufferAsync(e,t,i,r,s){return this._decoderModulePromise.then(async()=>{jo===0&&(MeshoptDecoder.useWorkers(1),jo=1);const n=await MeshoptDecoder.decodeGltfBufferAsync(t,i,e,r,s);return la!==null&&clearTimeout(la),la=setTimeout(()=>{MeshoptDecoder.useWorkers(0),jo=0,la=null},1e3),n})}}Kr.Configuration={decoder:{url:`${k._DefaultCdnUrl}/meshopt_decoder.js`}};Kr._Default=null;function ml(a,e,t,i,r){const s=a;let n=null,o=null,l=null;try{n=new s.Decoder,o=new s.DecoderBuffer,o.Init(e,e.byteLength);let c;const h=n.GetEncodedGeometryType(o);switch(h){case s.TRIANGULAR_MESH:{const d=new s.Mesh;if(c=n.DecodeBufferToMesh(o,d),!c.ok()||d.ptr===0)throw new Error(c.error_msg());const p=d.num_faces()*3,g=p*4,E=s._malloc(g);try{n.GetTrianglesUInt32Array(d,g,E);const v=new Uint32Array(p);v.set(new Uint32Array(s.HEAPF32.buffer,E,p)),i(v)}finally{s._free(E)}l=d;break}case s.POINT_CLOUD:{const d=new s.PointCloud;if(c=n.DecodeBufferToPointCloud(o,d),!c.ok()||!d.ptr)throw new Error(c.error_msg());l=d;break}default:throw new Error(`Invalid geometry type ${h}`)}const f=l.num_points(),u=(d,_,p,g)=>{const E=g.data_type(),v=g.num_components(),b=g.normalized(),R=g.byte_stride(),S=g.byte_offset(),I={[s.DT_FLOAT32]:{typedArrayConstructor:Float32Array,heap:s.HEAPF32},[s.DT_INT8]:{typedArrayConstructor:Int8Array,heap:s.HEAP8},[s.DT_INT16]:{typedArrayConstructor:Int16Array,heap:s.HEAP16},[s.DT_INT32]:{typedArrayConstructor:Int32Array,heap:s.HEAP32},[s.DT_UINT8]:{typedArrayConstructor:Uint8Array,heap:s.HEAPU8},[s.DT_UINT16]:{typedArrayConstructor:Uint16Array,heap:s.HEAPU16},[s.DT_UINT32]:{typedArrayConstructor:Uint32Array,heap:s.HEAPU32}}[E];if(!I)throw new Error(`Invalid data type ${E}`);const O=f*v,L=O*I.typedArrayConstructor.BYTES_PER_ELEMENT,w=s._malloc(L);try{d.GetAttributeDataArrayForAllPoints(_,g,E,L,w);const $=new I.typedArrayConstructor(I.heap.buffer,w,O);r(p,$.slice(),v,S,R,b)}finally{s._free(w)}};if(t)for(const d in t){const _=t[d],p=n.GetAttributeByUniqueId(l,_);u(n,l,d,p)}else{const d={position:s.POSITION,normal:s.NORMAL,color:s.COLOR,uv:s.TEX_COORD};for(const _ in d){const p=n.GetAttributeId(l,d[_]);if(p!==-1){const g=n.GetAttribute(l,p);u(n,l,_,g)}}}return f}finally{l&&s.destroy(l),o&&s.destroy(o),n&&s.destroy(n)}}function _b(){let a;onmessage=e=>{const t=e.data;switch(t.id){case"init":{t.url&&importScripts(t.url);const i=t.wasmBinary?{wasmBinary:t.wasmBinary}:{};a=DracoDecoderModule(i),postMessage({id:"initDone"});break}case"decodeMesh":{if(!a)throw new Error("Draco decoder module is not available");a.then(i=>{const r=ml(i,t.dataView,t.attributes,s=>{postMessage({id:"indices",data:s},[s.buffer])},(s,n,o,l,c,h)=>{postMessage({id:"attribute",kind:s,data:n,size:o,byteOffset:l,byteStride:c,normalized:h},[n.buffer])});postMessage({id:"decodeMeshDone",totalVertices:r})});break}}}}function pb(a,e,t){return new Promise((i,r)=>{const s=o=>{a.removeEventListener("error",s),a.removeEventListener("message",n),r(o)},n=o=>{o.data.id==="initDone"&&(a.removeEventListener("error",s),a.removeEventListener("message",n),i(a))};if(a.addEventListener("error",s),a.addEventListener("message",n),!e)a.postMessage({id:"init",url:t});else{const o=e.slice(0);a.postMessage({id:"init",url:t,wasmBinary:o},[o])}})}function mb(){return typeof navigator!="object"||!navigator.hardwareConcurrency?1:Math.min(Math.floor(navigator.hardwareConcurrency*.5),4)}function gb(a){return!!(a.wasmUrl&&(a.wasmBinary||a.wasmBinaryUrl)&&typeof WebAssembly=="object"||a.fallbackUrl)}class Eb{constructor(e){if(e.workerPool){this._workerPoolPromise=Promise.resolve(e.workerPool);return}const t=e.wasmBinary,i=e.numWorkers??mb(),r=i&&typeof Worker=="function"&&typeof URL=="function",s=r||!e.jsModule,n=e.wasmUrl&&e.wasmBinaryUrl&&typeof WebAssembly=="object"?{url:s?k.GetBabylonScriptURL(e.wasmUrl,!0):"",wasmBinaryPromise:t?Promise.resolve(t):k.LoadFileAsync(k.GetBabylonScriptURL(e.wasmBinaryUrl,!0))}:{url:s?k.GetBabylonScriptURL(e.fallbackUrl):"",wasmBinaryPromise:Promise.resolve(void 0)};r?this._workerPoolPromise=n.wasmBinaryPromise.then(o=>{const l=this._getWorkerContent(),c=URL.createObjectURL(new Blob([l],{type:"application/javascript"}));return new zn(i,()=>{const h=new Worker(c);return pb(h,o,n.url)})}):this._modulePromise=n.wasmBinaryPromise.then(async o=>{if(!this._isModuleAvailable()&&!e.jsModule){if(!n.url)throw new Error("Draco codec module is not available");await k.LoadBabylonScriptAsync(n.url)}return this._createModuleAsync(o,e.jsModule)})}async whenReadyAsync(){if(this._workerPoolPromise){await this._workerPoolPromise;return}if(this._modulePromise){await this._modulePromise;return}}dispose(){this._workerPoolPromise&&this._workerPoolPromise.then(e=>{e.dispose()}),delete this._workerPoolPromise,delete this._modulePromise}}class zi extends Eb{static get DefaultAvailable(){return gb(zi.DefaultConfiguration)}static get Default(){return zi._Default??(zi._Default=new zi),zi._Default}static ResetDefault(e){zi._Default&&(e||zi._Default.dispose(),zi._Default=null)}_isModuleAvailable(){return typeof DracoDecoderModule<"u"}async _createModuleAsync(e,t){return{module:await(t||DracoDecoderModule)({wasmBinary:e})}}_getWorkerContent(){return`${ml}(${_b})()`}constructor(e=zi.DefaultConfiguration){super(e)}decodeMeshToMeshDataAsync(e,t,i){const r=e instanceof ArrayBuffer?new Int8Array(e):new Int8Array(e.buffer,e.byteOffset,e.byteLength),s=(n,o)=>i&&i[n]!==void 0?(o!==i[n]&&B.Warn(`Normalized flag from Draco data (${o}) does not match normalized flag from glTF accessor (${i[n]}). Using flag from glTF accessor.`),i[n]):o;if(this._workerPoolPromise)return this._workerPoolPromise.then(n=>new Promise((o,l)=>{n.push((c,h)=>{let f=null;const u=[],d=g=>{c.removeEventListener("error",d),c.removeEventListener("message",_),l(g),h()},_=g=>{const E=g.data;switch(E.id){case"indices":{f=E.data;break}case"attribute":{u.push({kind:E.kind,data:E.data,size:E.size,byteOffset:E.byteOffset,byteStride:E.byteStride,normalized:s(E.kind,E.normalized)});break}case"decodeMeshDone":{c.removeEventListener("error",d),c.removeEventListener("message",_),o({indices:f,attributes:u,totalVertices:E.totalVertices}),h();break}}};c.addEventListener("error",d),c.addEventListener("message",_);const p=r.slice();c.postMessage({id:"decodeMesh",dataView:p,attributes:t},[p.buffer])})}));if(this._modulePromise)return this._modulePromise.then(n=>{let o=null;const l=[],c=ml(n.module,r,t,h=>{o=h},(h,f,u,d,_,p)=>{l.push({kind:h,data:f,size:u,byteOffset:d,byteStride:_,normalized:p})});return{indices:o,attributes:l,totalVertices:c}});throw new Error("Draco decoder module is not available")}async decodeMeshToGeometryAsync(e,t,i,r){const s=await this.decodeMeshToMeshDataAsync(i,r),n=new ri(e,t);s.indices&&n.setIndices(s.indices);for(const o of s.attributes)n.setVerticesBuffer(new x(t.getEngine(),o.data,o.kind,!1,void 0,o.byteStride,void 0,o.byteOffset,o.size,void 0,o.normalized,!0),s.totalVertices);return n}async _decodeMeshToGeometryForGltfAsync(e,t,i,r,s,n){const o=await this.decodeMeshToMeshDataAsync(i,r,s),l=new ri(e,t);n&&(l._boundingInfo=n,l.useBoundingInfoFromGeometry=!0),o.indices&&l.setIndices(o.indices);for(const c of o.attributes)l.setVerticesBuffer(new x(t.getEngine(),c.data,c.kind,!1,void 0,c.byteStride,void 0,c.byteOffset,c.size,void 0,c.normalized,!0),o.totalVertices);return l}}zi.DefaultConfiguration={wasmUrl:`${k._DefaultCdnUrl}/draco_wasm_wrapper_gltf.js`,wasmBinaryUrl:`${k._DefaultCdnUrl}/draco_decoder_gltf.wasm`,fallbackUrl:`${k._DefaultCdnUrl}/draco_decoder_gltf.js`};zi._Default=null;class Kg{constructor(e,t,i){this.frame=e,this.action=t,this.onlyOnce=i,this.isDone=!1}_clone(){return new Kg(this.frame,this.action,this.onlyOnce)}}class jr{get loop(){return this._loop}set loop(e){e!==this._loop&&(this._loop=e,this.updateOptions({loop:e}))}get currentTime(){var e;if(this._htmlAudioElement)return this._htmlAudioElement.currentTime;if((e=H.audioEngine)!=null&&e.audioContext&&(this.isPlaying||this.isPaused)){const t=this.isPaused?0:H.audioEngine.audioContext.currentTime-this._startTime;return this._currentTime+t}return 0}get spatialSound(){return this._spatialSound}set spatialSound(e){if(e==this._spatialSound)return;const t=this.isPlaying;this.pause(),e?(this._spatialSound=e,this._updateSpatialParameters()):this._disableSpatialSound(),t&&this.play()}constructor(e,t,i,r=null,s){var n;if(this.autoplay=!1,this._loop=!1,this.useCustomAttenuation=!1,this.isPlaying=!1,this.isPaused=!1,this.refDistance=1,this.rolloffFactor=1,this.maxDistance=100,this.distanceModel="linear",this.metadata=null,this.onEndedObservable=new U,this._spatialSound=!1,this._panningModel="equalpower",this._playbackRate=1,this._streaming=!1,this._startTime=0,this._currentTime=0,this._position=m.Zero(),this._localDirection=new m(1,0,0),this._volume=1,this._isReadyToPlay=!1,this._isDirectional=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._coneOuterGain=0,this._isOutputConnected=!1,this._urlType="Unknown",this.name=e,i=i||Re.LastCreatedScene,!!i)if(this._scene=i,jr._SceneComponentInitialization(i),this._readyToPlayCallback=r,this._customAttenuationFunction=(o,l,c,h,f)=>l<c?o*(1-l/c):0,s&&(this.autoplay=s.autoplay||!1,this._loop=s.loop||!1,s.volume!==void 0&&(this._volume=s.volume),this._spatialSound=s.spatialSound??!1,this.maxDistance=s.maxDistance??100,this.useCustomAttenuation=s.useCustomAttenuation??!1,this.rolloffFactor=s.rolloffFactor||1,this.refDistance=s.refDistance||1,this.distanceModel=s.distanceModel||"linear",this._playbackRate=s.playbackRate||1,this._streaming=s.streaming??!1,this._length=s.length,this._offset=s.offset),(n=H.audioEngine)!=null&&n.canUseWebAudio&&H.audioEngine.audioContext){this._soundGain=H.audioEngine.audioContext.createGain(),this._soundGain.gain.value=this._volume,this._inputAudioNode=this._soundGain,this._outputAudioNode=this._soundGain,this._spatialSound&&this._createSpatialParameters(),this._scene.mainSoundTrack.addSound(this);let o=!0;if(t)try{typeof t=="string"?(this._urlType="String",this._url=t):t instanceof ArrayBuffer?this._urlType="ArrayBuffer":t instanceof HTMLMediaElement?this._urlType="MediaElement":t instanceof MediaStream?this._urlType="MediaStream":t instanceof AudioBuffer?this._urlType="AudioBuffer":Array.isArray(t)&&(this._urlType="Array");let l=[],c=!1;switch(this._urlType){case"MediaElement":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=H.audioEngine.audioContext.createMediaElementSource(t),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"MediaStream":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=H.audioEngine.audioContext.createMediaStreamSource(t),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"ArrayBuffer":t.byteLength>0&&(c=!0,this._soundLoaded(t));break;case"AudioBuffer":this._audioBufferLoaded(t);break;case"String":l.push(t);case"Array":l.length===0&&(l=t);for(let h=0;h<l.length;h++){const f=l[h];if(c=s&&s.skipCodecCheck||f.indexOf(".mp3",f.length-4)!==-1&&H.audioEngine.isMP3supported||f.indexOf(".ogg",f.length-4)!==-1&&H.audioEngine.isOGGsupported||f.indexOf(".wav",f.length-4)!==-1||f.indexOf(".m4a",f.length-4)!==-1||f.indexOf(".mp4",f.length-4)!==-1||f.indexOf("blob:")!==-1,c){this._streaming?(this._htmlAudioElement=new Audio(f),this._htmlAudioElement.controls=!1,this._htmlAudioElement.loop=this.loop,k.SetCorsBehavior(f,this._htmlAudioElement),this._htmlAudioElement.preload="auto",this._htmlAudioElement.addEventListener("canplaythrough",()=>{this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback()},{once:!0}),document.body.appendChild(this._htmlAudioElement),this._htmlAudioElement.load()):this._scene._loadFile(f,u=>{this._soundLoaded(u)},void 0,!0,!0,u=>{u&&B.Error("XHR "+u.status+" error on: "+f+"."),B.Error("Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)});break}}break;default:o=!1;break}o?c||(this._isReadyToPlay=!0,this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)):B.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}catch{B.Error("Unexpected error. Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)}}else this._scene.mainSoundTrack.addSound(this),H.audioEngine&&!H.audioEngine.WarnedWebAudioUnsupported&&(B.Error("Web Audio is not supported by your browser."),H.audioEngine.WarnedWebAudioUnsupported=!0),this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)}dispose(){var e;(e=H.audioEngine)!=null&&e.canUseWebAudio&&(this.isPlaying&&this.stop(),this._isReadyToPlay=!1,this.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(this):this._scene.soundTracks&&this._scene.soundTracks[this.soundTrackId].removeSound(this),this._soundGain&&(this._soundGain.disconnect(),this._soundGain=null),this._soundPanner&&(this._soundPanner.disconnect(),this._soundPanner=null),this._soundSource&&(this._soundSource.disconnect(),this._soundSource=null),this._audioBuffer=null,this._htmlAudioElement&&(this._htmlAudioElement.pause(),this._htmlAudioElement.src="",document.body.removeChild(this._htmlAudioElement),this._htmlAudioElement=null),this._streamingSource&&(this._streamingSource.disconnect(),this._streamingSource=null),this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedTransformNode=null),this._clearTimeoutsAndObservers())}isReady(){return this._isReadyToPlay}getClassName(){return"Sound"}_audioBufferLoaded(e){var t;(t=H.audioEngine)!=null&&t.audioContext&&(this._audioBuffer=e,this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback())}_soundLoaded(e){var t;(t=H.audioEngine)!=null&&t.audioContext&&H.audioEngine.audioContext.decodeAudioData(e,i=>{this._audioBufferLoaded(i)},i=>{B.Error("Error while decoding audio data for: "+this.name+" / Error: "+i)})}setAudioBuffer(e){var t;(t=H.audioEngine)!=null&&t.canUseWebAudio&&(this._audioBuffer=e,this._isReadyToPlay=!0)}updateOptions(e){e&&(this.loop=e.loop??this.loop,this.maxDistance=e.maxDistance??this.maxDistance,this.useCustomAttenuation=e.useCustomAttenuation??this.useCustomAttenuation,this.rolloffFactor=e.rolloffFactor??this.rolloffFactor,this.refDistance=e.refDistance??this.refDistance,this.distanceModel=e.distanceModel??this.distanceModel,this._playbackRate=e.playbackRate??this._playbackRate,this._length=e.length??void 0,this.spatialSound=e.spatialSound??this._spatialSound,this._setOffset(e.offset??void 0),this.setVolume(e.volume??this._volume),this._updateSpatialParameters(),this.isPlaying&&(this._streaming&&this._htmlAudioElement?(this._htmlAudioElement.playbackRate=this._playbackRate,this._htmlAudioElement.loop!==this.loop&&(this._htmlAudioElement.loop=this.loop)):this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.loop!==this.loop&&(this._soundSource.loop=this.loop),this._offset!==void 0&&this._soundSource.loopStart!==this._offset&&(this._soundSource.loopStart=this._offset),this._length!==void 0&&this._length!==this._soundSource.loopEnd&&(this._soundSource.loopEnd=(this._offset|0)+this._length))))}_createSpatialParameters(){var e;(e=H.audioEngine)!=null&&e.canUseWebAudio&&H.audioEngine.audioContext&&(this._scene.headphone&&(this._panningModel="HRTF"),this._soundPanner=this._soundPanner??H.audioEngine.audioContext.createPanner(),this._soundPanner&&this._outputAudioNode&&(this._updateSpatialParameters(),this._soundPanner.connect(this._outputAudioNode),this._inputAudioNode=this._soundPanner))}_disableSpatialSound(){var e;this._spatialSound&&(this._inputAudioNode=this._soundGain,(e=this._soundPanner)==null||e.disconnect(),this._soundPanner=null,this._spatialSound=!1)}_updateSpatialParameters(){this._spatialSound&&(this._soundPanner?this.useCustomAttenuation?(this._soundPanner.distanceModel="linear",this._soundPanner.maxDistance=Number.MAX_VALUE,this._soundPanner.refDistance=1,this._soundPanner.rolloffFactor=1,this._soundPanner.panningModel=this._panningModel):(this._soundPanner.distanceModel=this.distanceModel,this._soundPanner.maxDistance=this.maxDistance,this._soundPanner.refDistance=this.refDistance,this._soundPanner.rolloffFactor=this.rolloffFactor,this._soundPanner.panningModel=this._panningModel):this._createSpatialParameters())}switchPanningModelToHRTF(){this._panningModel="HRTF",this._switchPanningModel()}switchPanningModelToEqualPower(){this._panningModel="equalpower",this._switchPanningModel()}_switchPanningModel(){var e;(e=H.audioEngine)!=null&&e.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.panningModel=this._panningModel)}connectToSoundTrackAudioNode(e){var t;(t=H.audioEngine)!=null&&t.canUseWebAudio&&this._outputAudioNode&&(this._isOutputConnected&&this._outputAudioNode.disconnect(),this._outputAudioNode.connect(e),this._isOutputConnected=!0)}setDirectionalCone(e,t,i){if(t<e){B.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e,this._coneOuterAngle=t,this._coneOuterGain=i,this._isDirectional=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){var t;if(e!=this._coneInnerAngle){if(this._coneOuterAngle<e){B.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e,(t=H.audioEngine)!=null&&t.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle)}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){var t;if(e!=this._coneOuterAngle){if(e<this._coneInnerAngle){B.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=e,(t=H.audioEngine)!=null&&t.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneOuterAngle=this._coneOuterAngle)}}setPosition(e){var t;e.equals(this._position)||(this._position.copyFrom(e),(t=H.audioEngine)!=null&&t.canUseWebAudio&&this._spatialSound&&this._soundPanner&&!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z))}setLocalDirectionToMesh(e){var t;this._localDirection=e,(t=H.audioEngine)!=null&&t.canUseWebAudio&&this._connectedTransformNode&&this.isPlaying&&this._updateDirection()}_updateDirection(){if(!this._connectedTransformNode||!this._soundPanner)return;const e=this._connectedTransformNode.getWorldMatrix(),t=m.TransformNormal(this._localDirection,e);t.normalize(),this._soundPanner.orientationX.value=t.x,this._soundPanner.orientationY.value=t.y,this._soundPanner.orientationZ.value=t.z}updateDistanceFromListener(){var e;if((e=H.audioEngine)!=null&&e.canUseWebAudio&&this._connectedTransformNode&&this.useCustomAttenuation&&this._soundGain&&this._scene.activeCamera){const t=this._scene.audioListenerPositionProvider?this._connectedTransformNode.position.subtract(this._scene.audioListenerPositionProvider()).length():this._connectedTransformNode.getDistanceToCamera(this._scene.activeCamera);this._soundGain.gain.value=this._customAttenuationFunction(this._volume,t,this.maxDistance,this.refDistance,this.rolloffFactor)}}setAttenuationFunction(e){this._customAttenuationFunction=e}play(e,t,i){var r,s,n,o;if(this._isReadyToPlay&&this._scene.audioEnabled&&((r=H.audioEngine)!=null&&r.audioContext))try{this._clearTimeoutsAndObservers();let l=e?((s=H.audioEngine)==null?void 0:s.audioContext.currentTime)+e:(n=H.audioEngine)==null?void 0:n.audioContext.currentTime;if((!this._soundSource||!this._streamingSource)&&this._spatialSound&&this._soundPanner&&(!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z),this._isDirectional&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle,this._soundPanner.coneOuterAngle=this._coneOuterAngle,this._soundPanner.coneOuterGain=this._coneOuterGain,this._connectedTransformNode?this._updateDirection():this._soundPanner.setOrientation(this._localDirection.x,this._localDirection.y,this._localDirection.z))),this._streaming){if(!this._streamingSource&&this._htmlAudioElement&&(this._streamingSource=H.audioEngine.audioContext.createMediaElementSource(this._htmlAudioElement),this._htmlAudioElement.onended=()=>{this._onended()},this._htmlAudioElement.playbackRate=this._playbackRate),this._streamingSource&&(this._streamingSource.disconnect(),this._inputAudioNode&&this._streamingSource.connect(this._inputAudioNode)),this._htmlAudioElement){const c=()=>{var h,f;if((h=H.audioEngine)!=null&&h.unlocked){if(!this._htmlAudioElement)return;this._htmlAudioElement.currentTime=t??0;const u=this._htmlAudioElement.play();u!==void 0&&u.catch(()=>{var d,_;(d=H.audioEngine)==null||d.lock(),(this.loop||this.autoplay)&&(this._audioUnlockedObserver=(_=H.audioEngine)==null?void 0:_.onAudioUnlockedObservable.addOnce(()=>{c()}))})}else(this.loop||this.autoplay)&&(this._audioUnlockedObserver=(f=H.audioEngine)==null?void 0:f.onAudioUnlockedObservable.addOnce(()=>{c()}))};c()}}else{const c=()=>{var h,f,u;if((h=H.audioEngine)!=null&&h.audioContext){if(i=i||this._length,t!==void 0&&this._setOffset(t),this._soundSource){const d=this._soundSource;d.onended=()=>{d.disconnect()}}if(this._soundSource=(f=H.audioEngine)==null?void 0:f.audioContext.createBufferSource(),this._soundSource&&this._inputAudioNode){this._soundSource.buffer=this._audioBuffer,this._soundSource.connect(this._inputAudioNode),this._soundSource.loop=this.loop,t!==void 0&&(this._soundSource.loopStart=t),i!==void 0&&(this._soundSource.loopEnd=(t|0)+i),this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.onended=()=>{this._onended()},l=e?((u=H.audioEngine)==null?void 0:u.audioContext.currentTime)+e:H.audioEngine.audioContext.currentTime;const d=((this.isPaused?this.currentTime:0)+(this._offset??0))%this._soundSource.buffer.duration;this._soundSource.start(l,d,this.loop?void 0:i)}}};((o=H.audioEngine)==null?void 0:o.audioContext.state)==="suspended"?this._tryToPlayTimeout=setTimeout(()=>{var h;((h=H.audioEngine)==null?void 0:h.audioContext.state)==="suspended"?(H.audioEngine.lock(),(this.loop||this.autoplay)&&(this._audioUnlockedObserver=H.audioEngine.onAudioUnlockedObservable.addOnce(()=>{c()}))):c()},500):c()}this._startTime=l,this.isPlaying=!0,this.isPaused=!1}catch(l){B.Error("Error while trying to play audio: "+this.name+", "+l.message)}}_onended(){this.isPlaying=!1,this._startTime=0,this._currentTime=0,this.onended&&this.onended(),this.onEndedObservable.notifyObservers(this)}stop(e){var t,i;if(this.isPlaying)if(this._clearTimeoutsAndObservers(),this._streaming)this._htmlAudioElement?(this._htmlAudioElement.pause(),this._htmlAudioElement.currentTime>0&&(this._htmlAudioElement.currentTime=0)):(t=this._streamingSource)==null||t.disconnect(),this.isPlaying=!1;else if((i=H.audioEngine)!=null&&i.audioContext&&this._soundSource){const r=e?H.audioEngine.audioContext.currentTime+e:void 0;this._soundSource.onended=()=>{this.isPlaying=!1,this.isPaused=!1,this._startTime=0,this._currentTime=0,this._soundSource&&(this._soundSource.onended=()=>{}),this._onended()},this._soundSource.stop(r)}else this.isPlaying=!1;else this.isPaused&&(this.isPaused=!1,this._startTime=0,this._currentTime=0)}pause(){var e,t;this.isPlaying&&(this._clearTimeoutsAndObservers(),this._streaming?(this._htmlAudioElement?this._htmlAudioElement.pause():(e=this._streamingSource)==null||e.disconnect(),this.isPlaying=!1,this.isPaused=!0):(t=H.audioEngine)!=null&&t.audioContext&&this._soundSource&&(this._soundSource.onended=()=>{},this._soundSource.stop(),this.isPlaying=!1,this.isPaused=!0,this._currentTime+=H.audioEngine.audioContext.currentTime-this._startTime))}setVolume(e,t){var i;(i=H.audioEngine)!=null&&i.canUseWebAudio&&this._soundGain&&(t&&H.audioEngine.audioContext?(this._soundGain.gain.cancelScheduledValues(H.audioEngine.audioContext.currentTime),this._soundGain.gain.setValueAtTime(this._soundGain.gain.value,H.audioEngine.audioContext.currentTime),this._soundGain.gain.linearRampToValueAtTime(e,H.audioEngine.audioContext.currentTime+t)):this._soundGain.gain.value=e),this._volume=e}setPlaybackRate(e){this._playbackRate=e,this.isPlaying&&(this._streaming&&this._htmlAudioElement?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate))}getPlaybackRate(){return this._playbackRate}getVolume(){return this._volume}attachToMesh(e){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null),this._connectedTransformNode=e,this._spatialSound||(this._spatialSound=!0,this._createSpatialParameters(),this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))),this._onRegisterAfterWorldMatrixUpdate(this._connectedTransformNode),this._registerFunc=t=>this._onRegisterAfterWorldMatrixUpdate(t),this._connectedTransformNode.registerAfterWorldMatrixUpdate(this._registerFunc)}detachFromMesh(){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedTransformNode=null)}_onRegisterAfterWorldMatrixUpdate(e){var t;if(!e.getBoundingInfo)this.setPosition(e.absolutePosition);else{const r=e.getBoundingInfo();this.setPosition(r.boundingSphere.centerWorld)}(t=H.audioEngine)!=null&&t.canUseWebAudio&&this._isDirectional&&this.isPlaying&&this._updateDirection()}clone(){if(this._streaming)return null;{const e=()=>{va(()=>this._isReadyToPlay,()=>{i._audioBuffer=this.getAudioBuffer(),i._isReadyToPlay=!0,i.autoplay&&i.play(0,this._offset,this._length)},void 0,300)},t={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},i=new jr(this.name+"_cloned",new ArrayBuffer(0),this._scene,null,t);return this.useCustomAttenuation&&i.setAttenuationFunction(this._customAttenuationFunction),i.setPosition(this._position),i.setPlaybackRate(this._playbackRate),e(),i}}getAudioBuffer(){return this._audioBuffer}getSoundSource(){return this._soundSource}getSoundGain(){return this._soundGain}serialize(){const e={name:this.name,url:this._url,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this._playbackRate,panningModel:this._panningModel,soundTrackId:this.soundTrackId,metadata:this.metadata};return this._spatialSound&&(this._connectedTransformNode&&(e.connectedMeshId=this._connectedTransformNode.id),e.position=this._position.asArray(),e.refDistance=this.refDistance,e.distanceModel=this.distanceModel,e.isDirectional=this._isDirectional,e.localDirectionToMesh=this._localDirection.asArray(),e.coneInnerAngle=this._coneInnerAngle,e.coneOuterAngle=this._coneOuterAngle,e.coneOuterGain=this._coneOuterGain),e}static Parse(e,t,i,r){const s=e.name;let n;e.url?n=i+e.url:n=i+s;const o={autoplay:e.autoplay,loop:e.loop,volume:e.volume,spatialSound:e.spatialSound,maxDistance:e.maxDistance,rolloffFactor:e.rolloffFactor,refDistance:e.refDistance,distanceModel:e.distanceModel,playbackRate:e.playbackRate};let l;if(!r)l=new jr(s,n,t,()=>{t.removePendingData(l)},o),t.addPendingData(l);else{const c=()=>{va(()=>r._isReadyToPlay,()=>{l._audioBuffer=r.getAudioBuffer(),l._isReadyToPlay=!0,l.autoplay&&l.play(0,l._offset,l._length)},void 0,300)};l=new jr(s,new ArrayBuffer(0),t,null,o),c()}if(e.position){const c=m.FromArray(e.position);l.setPosition(c)}if(e.isDirectional&&(l.setDirectionalCone(e.coneInnerAngle||360,e.coneOuterAngle||360,e.coneOuterGain||0),e.localDirectionToMesh)){const c=m.FromArray(e.localDirectionToMesh);l.setLocalDirectionToMesh(c)}if(e.connectedMeshId){const c=t.getMeshById(e.connectedMeshId);c&&l.attachToMesh(c)}return e.metadata&&(l.metadata=e.metadata),l}_setOffset(e){this._offset!==e&&(this.isPaused&&(this.stop(),this.isPaused=!1),this._offset=e)}_clearTimeoutsAndObservers(){var e;this._tryToPlayTimeout&&(clearTimeout(this._tryToPlayTimeout),this._tryToPlayTimeout=null),this._audioUnlockedObserver&&((e=H.audioEngine)==null||e.onAudioUnlockedObservable.remove(this._audioUnlockedObserver),this._audioUnlockedObserver=null)}}jr._SceneComponentInitialization=a=>{throw Le("AudioSceneComponent")};Y("BABYLON.Sound",jr);class NL{constructor(e,t,i){if(this.loop=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._volume=1,this.isPlaying=!1,this.isPaused=!1,this._sounds=[],this._weights=[],t.length!==i.length)throw new Error("Sounds length does not equal weights length");this.loop=e,this._weights=i;let r=0;for(const n of i)r+=n;const s=r>0?1/r:0;for(let n=0;n<this._weights.length;n++)this._weights[n]*=s;this._sounds=t;for(const n of this._sounds)n.onEndedObservable.add(()=>{this._onended()})}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){if(e!==this._coneInnerAngle){if(this._coneOuterAngle<e){B.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e;for(const t of this._sounds)t.directionalConeInnerAngle=e}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){if(e!==this._coneOuterAngle){if(e<this._coneInnerAngle){B.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=e;for(const t of this._sounds)t.directionalConeOuterAngle=e}}get volume(){return this._volume}set volume(e){if(e!==this._volume)for(const t of this._sounds)t.setVolume(e)}_onended(){this._currentIndex!==void 0&&(this._sounds[this._currentIndex].autoplay=!1),this.loop&&this.isPlaying?this.play():this.isPlaying=!1}pause(){this.isPlaying&&(this.isPaused=!0,this._currentIndex!==void 0&&this._sounds[this._currentIndex].pause())}stop(){this.isPlaying=!1,this._currentIndex!==void 0&&this._sounds[this._currentIndex].stop()}play(e){if(!this.isPaused){this.stop();const i=Math.random();let r=0;for(let s=0;s<this._weights.length;s++)if(r+=this._weights[s],i<=r){this._currentIndex=s;break}}const t=this._sounds[this._currentIndex??0];t.isReady()?t.play(0,this.isPaused?void 0:e):t.autoplay=!0,this.isPlaying=!0,this.isPaused=!1}}class vb{constructor(e,t={}){this.id=-1,this._isInitialized=!1,e=e||Re.LastCreatedScene,e&&(this._scene=e,this.soundCollection=[],this._options=t,!this._options.mainTrack&&this._scene.soundTracks&&(this._scene.soundTracks.push(this),this.id=this._scene.soundTracks.length-1))}_initializeSoundTrackAudioGraph(){var e;(e=H.audioEngine)!=null&&e.canUseWebAudio&&H.audioEngine.audioContext&&(this._outputAudioNode=H.audioEngine.audioContext.createGain(),this._outputAudioNode.connect(H.audioEngine.masterGain),this._options&&this._options.volume&&(this._outputAudioNode.gain.value=this._options.volume),this._isInitialized=!0)}dispose(){if(H.audioEngine&&H.audioEngine.canUseWebAudio){for(this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas();this.soundCollection.length;)this.soundCollection[0].dispose();this._outputAudioNode&&this._outputAudioNode.disconnect(),this._outputAudioNode=null}}addSound(e){var t;this._isInitialized||this._initializeSoundTrackAudioGraph(),(t=H.audioEngine)!=null&&t.canUseWebAudio&&this._outputAudioNode&&e.connectToSoundTrackAudioNode(this._outputAudioNode),e.soundTrackId!==void 0&&(e.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(e):this._scene.soundTracks&&this._scene.soundTracks[e.soundTrackId].removeSound(e)),this.soundCollection.push(e),e.soundTrackId=this.id}removeSound(e){const t=this.soundCollection.indexOf(e);t!==-1&&this.soundCollection.splice(t,1)}setVolume(e){var t;(t=H.audioEngine)!=null&&t.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.gain.value=e)}switchPanningModelToHRTF(){var e;if((e=H.audioEngine)!=null&&e.canUseWebAudio)for(let t=0;t<this.soundCollection.length;t++)this.soundCollection[t].switchPanningModelToHRTF()}switchPanningModelToEqualPower(){var e;if((e=H.audioEngine)!=null&&e.canUseWebAudio)for(let t=0;t<this.soundCollection.length;t++)this.soundCollection[t].switchPanningModelToEqualPower()}connectToAnalyser(e){var t;this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=e,(t=H.audioEngine)!=null&&t.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.disconnect(),this._connectedAnalyser.connectAudioNodes(this._outputAudioNode,H.audioEngine.masterGain))}}H.AudioEngineFactory=(a,e,t)=>new Tb(a,e,t);class Tb{get audioContext(){return this._audioContextInitialized||this._initializeAudioContext(),this._audioContext}constructor(e=null,t=null,i=null){if(this._audioContext=null,this._audioContextInitialized=!1,this._muteButton=null,this._audioDestination=null,this.canUseWebAudio=!1,this.WarnedWebAudioUnsupported=!1,this.isMP3supported=!1,this.isOGGsupported=!1,this.unlocked=!1,this.useCustomUnlockedButton=!1,this.onAudioUnlockedObservable=new U,this.onAudioLockedObservable=new U,this._tryToRun=!1,this._onResize=()=>{this._moveButtonToTopLeft()},!Ht())return;typeof window.AudioContext<"u"&&(this.canUseWebAudio=!0);const r=document.createElement("audio");this._hostElement=e,this._audioContext=t,this._audioDestination=i;try{r&&r.canPlayType&&(r.canPlayType('audio/mpeg; codecs="mp3"').replace(/^no$/,"")||r.canPlayType("audio/mp3").replace(/^no$/,""))&&(this.isMP3supported=!0)}catch{}try{r&&r.canPlayType&&r.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,"")&&(this.isOGGsupported=!0)}catch{}}lock(){this._triggerSuspendedState()}unlock(){var e,t;if(((e=this._audioContext)==null?void 0:e.state)==="running"){this._hideMuteButton(),this.unlocked||(this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this));return}this._tryToRun?(t=this._audioContext)==null||t.suspend().then(()=>{this._tryToRun=!1,this._triggerRunningState()}):this._triggerRunningState()}_resumeAudioContextOnStateChange(){var e;(e=this._audioContext)==null||e.addEventListener("statechange",()=>{var t;this.unlocked&&((t=this._audioContext)==null?void 0:t.state)!=="running"&&this._resumeAudioContext()},{once:!0,passive:!0,signal:AbortSignal.timeout(3e3)})}_resumeAudioContext(){var e;return(e=this._audioContext)!=null&&e.resume?this._audioContext.resume():Promise.resolve()}_initializeAudioContext(){try{this.canUseWebAudio&&(this._audioContext||(this._audioContext=new AudioContext),this.masterGain=this._audioContext.createGain(),this.masterGain.gain.value=1,this._audioDestination||(this._audioDestination=this._audioContext.destination),this.masterGain.connect(this._audioDestination),this._audioContextInitialized=!0,this._audioContext.state==="running"&&this._triggerRunningState())}catch(e){this.canUseWebAudio=!1,B.Error("Web Audio: "+e.message)}}_triggerRunningState(){this._tryToRun||(this._tryToRun=!0,this._resumeAudioContext().then(()=>{this._tryToRun=!1,this._muteButton&&this._hideMuteButton(),this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this)}).catch(()=>{this._tryToRun=!1,this.unlocked=!1}))}_triggerSuspendedState(){this.unlocked=!1,this.onAudioLockedObservable.notifyObservers(this),this._displayMuteButton()}_displayMuteButton(){if(this.useCustomUnlockedButton||this._muteButton)return;this._muteButton=document.createElement("BUTTON"),this._muteButton.className="babylonUnmuteIcon",this._muteButton.id="babylonUnmuteIconBtn",this._muteButton.title="Unmute";const t=".babylonUnmuteIcon { position: absolute; left: 20px; top: 20px; height: 40px; width: 60px; background-color: rgba(51,51,51,0.7); background-image: url("+(window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20version%3D%221.1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2239%22%20height%3D%2232%22%20viewBox%3D%220%200%2039%2032%22%3E%3Cpath%20fill%3D%22white%22%20d%3D%22M9.625%2018.938l-0.031%200.016h-4.953q-0.016%200-0.031-0.016v-12.453q0-0.016%200.031-0.016h4.953q0.031%200%200.031%200.016v12.453zM12.125%207.688l8.719-8.703v27.453l-8.719-8.719-0.016-0.047v-9.938zM23.359%207.875l1.406-1.406%204.219%204.203%204.203-4.203%201.422%201.406-4.219%204.219%204.219%204.203-1.484%201.359-4.141-4.156-4.219%204.219-1.406-1.422%204.219-4.203z%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E":"https://cdn.babylonjs.com/Assets/audio.png")+");  background-size: 80%; background-repeat:no-repeat; background-position: center; background-position-y: 4px; border: none; outline: none; transition: transform 0.125s ease-out; cursor: pointer; z-index: 9999; } .babylonUnmuteIcon:hover { transform: scale(1.05) } .babylonUnmuteIcon:active { background-color: rgba(51,51,51,1) }",i=document.createElement("style");i.appendChild(document.createTextNode(t)),document.getElementsByTagName("head")[0].appendChild(i),document.body.appendChild(this._muteButton),this._moveButtonToTopLeft(),this._muteButton.addEventListener("touchend",()=>{this._triggerRunningState()},!0),this._muteButton.addEventListener("click",()=>{this.unlock()},!0),window.addEventListener("resize",this._onResize)}_moveButtonToTopLeft(){this._hostElement&&this._muteButton&&(this._muteButton.style.top=this._hostElement.offsetTop+20+"px",this._muteButton.style.left=this._hostElement.offsetLeft+20+"px")}_hideMuteButton(){this._muteButton&&(document.body.removeChild(this._muteButton),this._muteButton=null)}dispose(){this.canUseWebAudio&&this._audioContextInitialized&&(this._connectedAnalyser&&this._audioContext&&(this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser.dispose(),this.masterGain.disconnect(),this.masterGain.connect(this._audioContext.destination),this._connectedAnalyser=null),this.masterGain.gain.value=1),this.WarnedWebAudioUnsupported=!1,this._hideMuteButton(),window.removeEventListener("resize",this._onResize),this.onAudioUnlockedObservable.clear(),this.onAudioLockedObservable.clear()}getGlobalVolume(){return this.canUseWebAudio&&this._audioContextInitialized?this.masterGain.gain.value:-1}setGlobalVolume(e){this.canUseWebAudio&&this._audioContextInitialized&&(this.masterGain.gain.value=e)}connectToAnalyser(e){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this.canUseWebAudio&&this._audioContextInitialized&&this._audioContext&&(this._connectedAnalyser=e,this.masterGain.disconnect(),this._connectedAnalyser.connectAudioNodes(this.masterGain,this._audioContext.destination))}}Object.defineProperty(Ge.prototype,"mainSoundTrack",{get:function(){let a=this._getComponent(Ae.NAME_AUDIO);return a||(a=new Ai(this),this._addComponent(a)),this._mainSoundTrack||(this._mainSoundTrack=new vb(this,{mainTrack:!0})),this._mainSoundTrack},enumerable:!0,configurable:!0});Ge.prototype.getSoundByName=function(a){let e;for(e=0;e<this.mainSoundTrack.soundCollection.length;e++)if(this.mainSoundTrack.soundCollection[e].name===a)return this.mainSoundTrack.soundCollection[e];if(this.soundTracks){for(let t=0;t<this.soundTracks.length;t++)for(e=0;e<this.soundTracks[t].soundCollection.length;e++)if(this.soundTracks[t].soundCollection[e].name===a)return this.soundTracks[t].soundCollection[e]}return null};Object.defineProperty(Ge.prototype,"audioEnabled",{get:function(){let a=this._getComponent(Ae.NAME_AUDIO);return a||(a=new Ai(this),this._addComponent(a)),a.audioEnabled},set:function(a){let e=this._getComponent(Ae.NAME_AUDIO);e||(e=new Ai(this),this._addComponent(e)),a?e.enableAudio():e.disableAudio()},enumerable:!0,configurable:!0});Object.defineProperty(Ge.prototype,"headphone",{get:function(){let a=this._getComponent(Ae.NAME_AUDIO);return a||(a=new Ai(this),this._addComponent(a)),a.headphone},set:function(a){let e=this._getComponent(Ae.NAME_AUDIO);e||(e=new Ai(this),this._addComponent(e)),a?e.switchAudioModeForHeadphones():e.switchAudioModeForNormalSpeakers()},enumerable:!0,configurable:!0});Object.defineProperty(Ge.prototype,"audioListenerPositionProvider",{get:function(){let a=this._getComponent(Ae.NAME_AUDIO);return a||(a=new Ai(this),this._addComponent(a)),a.audioListenerPositionProvider},set:function(a){let e=this._getComponent(Ae.NAME_AUDIO);if(e||(e=new Ai(this),this._addComponent(e)),a&&typeof a!="function")throw new Error("The value passed to [Scene.audioListenerPositionProvider] must be a function that returns a Vector3");e.audioListenerPositionProvider=a},enumerable:!0,configurable:!0});Object.defineProperty(Ge.prototype,"audioListenerRotationProvider",{get:function(){let a=this._getComponent(Ae.NAME_AUDIO);return a||(a=new Ai(this),this._addComponent(a)),a.audioListenerRotationProvider},set:function(a){let e=this._getComponent(Ae.NAME_AUDIO);if(e||(e=new Ai(this),this._addComponent(e)),a&&typeof a!="function")throw new Error("The value passed to [Scene.audioListenerRotationProvider] must be a function that returns a Vector3");e.audioListenerRotationProvider=a},enumerable:!0,configurable:!0});Object.defineProperty(Ge.prototype,"audioPositioningRefreshRate",{get:function(){let a=this._getComponent(Ae.NAME_AUDIO);return a||(a=new Ai(this),this._addComponent(a)),a.audioPositioningRefreshRate},set:function(a){let e=this._getComponent(Ae.NAME_AUDIO);e||(e=new Ai(this),this._addComponent(e)),e.audioPositioningRefreshRate=a},enumerable:!0,configurable:!0});class Ai{get audioEnabled(){return this._audioEnabled}get headphone(){return this._headphone}constructor(e){this.name=Ae.NAME_AUDIO,this._audioEnabled=!0,this._headphone=!1,this.audioPositioningRefreshRate=500,this.audioListenerPositionProvider=null,this.audioListenerRotationProvider=null,this._cachedCameraDirection=new m,this._cachedCameraPosition=new m,this._lastCheck=0,this._invertMatrixTemp=new P,this._cameraDirectionTemp=new m,e=e||Re.LastCreatedScene,e&&(this.scene=e,e.soundTracks=[],e.sounds=[])}register(){this.scene._afterRenderStage.registerStep(Ae.STEP_AFTERRENDER_AUDIO,this,this._afterRender)}rebuild(){}serialize(e){if(e.sounds=[],this.scene.soundTracks)for(let t=0;t<this.scene.soundTracks.length;t++){const i=this.scene.soundTracks[t];for(let r=0;r<i.soundCollection.length;r++)e.sounds.push(i.soundCollection[r].serialize())}}addFromContainer(e){e.sounds&&e.sounds.forEach(t=>{t.play(),t.autoplay=!0,this.scene.mainSoundTrack.addSound(t)})}removeFromContainer(e,t=!1){e.sounds&&e.sounds.forEach(i=>{i.stop(),i.autoplay=!1,this.scene.mainSoundTrack.removeSound(i),t&&i.dispose()})}dispose(){const e=this.scene;if(e._mainSoundTrack&&e.mainSoundTrack.dispose(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].dispose()}disableAudio(){const e=this.scene;this._audioEnabled=!1,H.audioEngine&&H.audioEngine.audioContext&&H.audioEngine.audioContext.suspend();let t;for(t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].pause();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let i=0;i<e.soundTracks[t].soundCollection.length;i++)e.soundTracks[t].soundCollection[i].pause()}enableAudio(){const e=this.scene;this._audioEnabled=!0,H.audioEngine&&H.audioEngine.audioContext&&H.audioEngine.audioContext.resume();let t;for(t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].isPaused&&e.mainSoundTrack.soundCollection[t].play();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let i=0;i<e.soundTracks[t].soundCollection.length;i++)e.soundTracks[t].soundCollection[i].isPaused&&e.soundTracks[t].soundCollection[i].play()}switchAudioModeForHeadphones(){const e=this.scene;if(this._headphone=!0,e.mainSoundTrack.switchPanningModelToHRTF(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToHRTF()}switchAudioModeForNormalSpeakers(){const e=this.scene;if(this._headphone=!1,e.mainSoundTrack.switchPanningModelToEqualPower(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToEqualPower()}_afterRender(){const e=Ti.Now;if(this._lastCheck&&e-this._lastCheck<this.audioPositioningRefreshRate)return;this._lastCheck=e;const t=this.scene;if(!this._audioEnabled||!t._mainSoundTrack||!t.soundTracks||t._mainSoundTrack.soundCollection.length===0&&t.soundTracks.length===1)return;const i=H.audioEngine;if(i&&i.audioContext){let r=t.activeCamera;if(t.activeCameras&&t.activeCameras.length>0&&(r=t.activeCameras[0]),this.audioListenerPositionProvider){const n=this.audioListenerPositionProvider();i.audioContext.listener.setPosition(n.x||0,n.y||0,n.z||0)}else r?this._cachedCameraPosition.equals(r.globalPosition)||(this._cachedCameraPosition.copyFrom(r.globalPosition),i.audioContext.listener.setPosition(r.globalPosition.x,r.globalPosition.y,r.globalPosition.z)):i.audioContext.listener.setPosition(0,0,0);if(this.audioListenerRotationProvider){const n=this.audioListenerRotationProvider();i.audioContext.listener.setOrientation(n.x||0,n.y||0,n.z||0,0,1,0)}else r?(r.rigCameras&&r.rigCameras.length>0&&(r=r.rigCameras[0]),r.getViewMatrix().invertToRef(this._invertMatrixTemp),m.TransformNormalToRef(Ai._CameraDirection,this._invertMatrixTemp,this._cameraDirectionTemp),this._cameraDirectionTemp.normalize(),!isNaN(this._cameraDirectionTemp.x)&&!isNaN(this._cameraDirectionTemp.y)&&!isNaN(this._cameraDirectionTemp.z)&&(this._cachedCameraDirection.equals(this._cameraDirectionTemp)||(this._cachedCameraDirection.copyFrom(this._cameraDirectionTemp),i.audioContext.listener.setOrientation(this._cameraDirectionTemp.x,this._cameraDirectionTemp.y,this._cameraDirectionTemp.z,0,1,0)))):i.audioContext.listener.setOrientation(0,0,0,0,1,0);let s;for(s=0;s<t.mainSoundTrack.soundCollection.length;s++){const n=t.mainSoundTrack.soundCollection[s];n.useCustomAttenuation&&n.updateDistanceFromListener()}if(t.soundTracks)for(s=0;s<t.soundTracks.length;s++)for(let n=0;n<t.soundTracks[s].soundCollection.length;n++){const o=t.soundTracks[s].soundCollection[n];o.useCustomAttenuation&&o.updateDistanceFromListener()}}}}Ai._CameraDirection=new m(0,0,-1);jr._SceneComponentInitialization=a=>{let e=a._getComponent(Ae.NAME_AUDIO);e||(e=new Ai(a),a._addComponent(e))};class et{constructor(e){this.value=this._toInt(e)}_toInt(e){return e|0}add(e){return new et(this.value+e.value)}subtract(e){return new et(this.value-e.value)}multiply(e){return new et(Math.imul(this.value,e.value))}divide(e){return new et(this.value/e.value)}getClassName(){return et.ClassName}equals(e){return this.value===e.value}static FromValue(e){return new et(e)}toString(){return this.value.toString()}}et.ClassName="FlowGraphInteger";Y("FlowGraphInteger",et);class fi{constructor(e=[1,0,0,1]){this._m=e}get m(){return this._m}transformVector(e){return this.transformVectorToRef(e,new ne)}transformVectorToRef(e,t){return t.x=e.x*this._m[0]+e.y*this._m[1],t.y=e.x*this._m[2]+e.y*this._m[3],t}asArray(){return this.toArray()}toArray(e=[]){for(let t=0;t<4;t++)e[t]=this._m[t];return e}fromArray(e){for(let t=0;t<4;t++)this._m[t]=e[t];return this}multiplyToRef(e,t){const i=e._m,r=this._m,s=t._m;return s[0]=i[0]*r[0]+i[1]*r[2],s[1]=i[0]*r[1]+i[1]*r[3],s[2]=i[2]*r[0]+i[3]*r[2],s[3]=i[2]*r[1]+i[3]*r[3],t}multiply(e){return this.multiplyToRef(e,new fi)}divideToRef(e,t){const i=this._m,r=e._m,s=t._m;return s[0]=i[0]/r[0],s[1]=i[1]/r[1],s[2]=i[2]/r[2],s[3]=i[3]/r[3],t}divide(e){return this.divideToRef(e,new fi)}addToRef(e,t){const i=this._m,r=e.m,s=t.m;return s[0]=i[0]+r[0],s[1]=i[1]+r[1],s[2]=i[2]+r[2],s[3]=i[3]+r[3],t}add(e){return this.addToRef(e,new fi)}subtractToRef(e,t){const i=this._m,r=e.m,s=t.m;return s[0]=i[0]-r[0],s[1]=i[1]-r[1],s[2]=i[2]-r[2],s[3]=i[3]-r[3],t}subtract(e){return this.subtractToRef(e,new fi)}transpose(){const e=this._m;return new fi([e[0],e[2],e[1],e[3]])}determinant(){const e=this._m;return e[0]*e[3]-e[1]*e[2]}inverse(){const e=this.determinant();if(e===0)throw new Error("Matrix is not invertible");const t=this._m,i=1/e;return new fi([t[3]*i,-t[1]*i,-t[2]*i,t[0]*i])}equals(e,t=0){const i=this._m,r=e.m;return t===0?i[0]===r[0]&&i[1]===r[1]&&i[2]===r[2]&&i[3]===r[3]:Math.abs(i[0]-r[0])<t&&Math.abs(i[1]-r[1])<t&&Math.abs(i[2]-r[2])<t&&Math.abs(i[3]-r[3])<t}getClassName(){return"FlowGraphMatrix2D"}toString(){return`FlowGraphMatrix2D(${this._m.join(", ")})`}}class ui{constructor(e=[1,0,0,0,1,0,0,0,1]){this._m=e}get m(){return this._m}transformVector(e){return this.transformVectorToRef(e,new m)}transformVectorToRef(e,t){const i=this._m;return t.x=e.x*i[0]+e.y*i[1]+e.z*i[2],t.y=e.x*i[3]+e.y*i[4]+e.z*i[5],t.z=e.x*i[6]+e.y*i[7]+e.z*i[8],t}multiplyToRef(e,t){const i=e._m,r=this._m,s=t.m;return s[0]=i[0]*r[0]+i[1]*r[3]+i[2]*r[6],s[1]=i[0]*r[1]+i[1]*r[4]+i[2]*r[7],s[2]=i[0]*r[2]+i[1]*r[5]+i[2]*r[8],s[3]=i[3]*r[0]+i[4]*r[3]+i[5]*r[6],s[4]=i[3]*r[1]+i[4]*r[4]+i[5]*r[7],s[5]=i[3]*r[2]+i[4]*r[5]+i[5]*r[8],s[6]=i[6]*r[0]+i[7]*r[3]+i[8]*r[6],s[7]=i[6]*r[1]+i[7]*r[4]+i[8]*r[7],s[8]=i[6]*r[2]+i[7]*r[5]+i[8]*r[8],t}multiply(e){return this.multiplyToRef(e,new ui)}divideToRef(e,t){const i=this._m,r=e.m,s=t.m;return s[0]=i[0]/r[0],s[1]=i[1]/r[1],s[2]=i[2]/r[2],s[3]=i[3]/r[3],s[4]=i[4]/r[4],s[5]=i[5]/r[5],s[6]=i[6]/r[6],s[7]=i[7]/r[7],s[8]=i[8]/r[8],t}divide(e){return this.divideToRef(e,new ui)}addToRef(e,t){const i=this._m,r=e.m,s=t.m;return s[0]=i[0]+r[0],s[1]=i[1]+r[1],s[2]=i[2]+r[2],s[3]=i[3]+r[3],s[4]=i[4]+r[4],s[5]=i[5]+r[5],s[6]=i[6]+r[6],s[7]=i[7]+r[7],s[8]=i[8]+r[8],t}add(e){return this.addToRef(e,new ui)}subtractToRef(e,t){const i=this._m,r=e.m,s=t.m;return s[0]=i[0]-r[0],s[1]=i[1]-r[1],s[2]=i[2]-r[2],s[3]=i[3]-r[3],s[4]=i[4]-r[4],s[5]=i[5]-r[5],s[6]=i[6]-r[6],s[7]=i[7]-r[7],s[8]=i[8]-r[8],t}subtract(e){return this.subtractToRef(e,new ui)}toArray(e=[]){for(let t=0;t<9;t++)e[t]=this._m[t];return e}asArray(){return this.toArray()}fromArray(e){for(let t=0;t<9;t++)this._m[t]=e[t];return this}transpose(){const e=this._m;return new ui([e[0],e[3],e[6],e[1],e[4],e[7],e[2],e[5],e[8]])}determinant(){const e=this._m;return e[0]*(e[4]*e[8]-e[5]*e[7])-e[1]*(e[3]*e[8]-e[5]*e[6])+e[2]*(e[3]*e[7]-e[4]*e[6])}inverse(){const e=this.determinant();if(e===0)throw new Error("Matrix is not invertible");const t=this._m,i=1/e;return new ui([(t[4]*t[8]-t[5]*t[7])*i,(t[2]*t[7]-t[1]*t[8])*i,(t[1]*t[5]-t[2]*t[4])*i,(t[5]*t[6]-t[3]*t[8])*i,(t[0]*t[8]-t[2]*t[6])*i,(t[2]*t[3]-t[0]*t[5])*i,(t[3]*t[7]-t[4]*t[6])*i,(t[1]*t[6]-t[0]*t[7])*i,(t[0]*t[4]-t[1]*t[3])*i])}equals(e,t=0){const i=this._m,r=e.m;return t===0?i[0]===r[0]&&i[1]===r[1]&&i[2]===r[2]&&i[3]===r[3]&&i[4]===r[4]&&i[5]===r[5]&&i[6]===r[6]&&i[7]===r[7]&&i[8]===r[8]:Math.abs(i[0]-r[0])<t&&Math.abs(i[1]-r[1])<t&&Math.abs(i[2]-r[2])<t&&Math.abs(i[3]-r[3])<t&&Math.abs(i[4]-r[4])<t&&Math.abs(i[5]-r[5])<t&&Math.abs(i[6]-r[6])<t&&Math.abs(i[7]-r[7])<t&&Math.abs(i[8]-r[8])<t}getClassName(){return"FlowGraphMatrix3D"}toString(){return`FlowGraphMatrix3D(${this._m.join(", ")})`}}var zf;(function(a){a.Any="any",a.String="string",a.Number="number",a.Boolean="boolean",a.Object="object",a.Integer="FlowGraphInteger",a.Vector2="Vector2",a.Vector3="Vector3",a.Vector4="Vector4",a.Quaternion="Quaternion",a.Matrix="Matrix",a.Matrix2D="Matrix2D",a.Matrix3D="Matrix3D",a.Color3="Color3",a.Color4="Color4"})(zf||(zf={}));class Oi{constructor(e,t,i=-1){this.typeName=e,this.defaultValue=t,this.animationType=i}serialize(e){e.typeName=this.typeName,e.defaultValue=this.defaultValue}}const te=new Oi("any",void 0),nh=new Oi("string",""),Ie=new Oi("number",0,0),$t=new Oi("boolean",!1),Br=new Oi("Vector2",ne.Zero(),5),zt=new Oi("Vector3",m.Zero(),1),uo=new Oi("Vector4",Fe.Zero()),ns=new Oi("Matrix",P.Identity(),3),_o=new Oi("Matrix2D",new fi),po=new Oi("Matrix3D",new ui),ah=new Oi("Color3",ae.Black(),4),oh=new Oi("Color4",new Ne(0,0,0,0),7),ln=new Oi("Quaternion",z.Identity(),2);ln.typeTransformer=a=>a.getClassName&&a.getClassName()==="Vector4"?z.FromArray(a.asArray()):a.getClassName&&a.getClassName()==="Vector3"?z.FromEulerVector(a):a.getClassName&&a.getClassName()==="Matrix"?z.FromRotationMatrix(a):a;const Ut=new Oi("FlowGraphInteger",new et(0),0);function Sb(a){const e=a;switch(typeof a){case"string":return nh;case"number":return Ie;case"boolean":return $t;case"object":if(e.getClassName)switch(e.getClassName()){case"Vector2":return Br;case"Vector3":return zt;case"Vector4":return uo;case"Matrix":return ns;case"Color3":return ah;case"Color4":return oh;case"Quaternion":return ln;case"FlowGraphInteger":return Ut;case"Matrix2D":return _o;case"Matrix3D":return po}return te;default:return te}}function ot(a){switch(a){case"string":return nh;case"number":return Ie;case"boolean":return $t;case"Vector2":return Br;case"Vector3":return zt;case"Vector4":return uo;case"Matrix":return ns;case"Color3":return ah;case"Color4":return oh;case"Quaternion":return ln;case"FlowGraphInteger":return Ut;case"Matrix2D":return _o;case"Matrix3D":return po;default:return te}}function FL(a){switch(a){case"number":return 0;case"Vector2":return 5;case"Vector3":return 1;case"Matrix":return 3;case"Color3":return 4;case"Color4":return 7;case"Quaternion":return 2;default:return 0}}function Ab(a){switch(a){case 0:return Ie;case 5:return Br;case 1:return zt;case 3:return ns;case 4:return ah;case 7:return oh;case 2:return ln;default:return te}}function Rb(a){return a==="Mesh"||a==="AbstractMesh"||a==="GroundMesh"||a==="InstanceMesh"||a==="LinesMesh"||a==="GoldbergMesh"||a==="GreasedLineMesh"||a==="TrailMesh"}function qg(a){return a==="Vector2"||a==="Vector3"||a==="Vector4"||a==="Quaternion"||a==="Color3"||a==="Color4"}function Cb(a){return a==="Matrix"||a==="Matrix2D"||a==="Matrix3D"}function Ib(a){return a==="AnimationGroup"}function bb(a,e,t=!1){if(a==="Vector2")return ne.FromArray(e);if(a==="Vector3")return t&&(e[2]*=-1),m.FromArray(e);if(a==="Vector4")return Fe.FromArray(e);if(a==="Quaternion")return t&&(e[2]*=-1,e[3]*=-1),z.FromArray(e);if(a==="Color3")return new ae(e[0],e[1],e[2]);if(a==="Color4")return new Ne(e[0],e[1],e[2],e[3]);throw new Error(`Unknown vector class name ${a}`)}function mo(a,e,t){var r;const i=((r=e==null?void 0:e.getClassName)==null?void 0:r.call(e))??"";if(qg(i)||Cb(i))t[a]={value:e.asArray(),className:i};else if(i==="FlowGraphInteger")t[a]={value:e.value,className:i};else if(i&&(e.id||e.name))t[a]={id:e.id,name:e.name,className:i};else if(typeof e!="object")t[a]=e;else throw new Error(`Could not serialize value ${e}`)}function go(a,e,t,i){const r=e[a];let s;const n=(r==null?void 0:r.type)??(r==null?void 0:r.className);if(Rb(n)){let o=i.meshes.filter(l=>r.id?l.id===r.id:l.name===r.name);o.length===0&&(o=i.transformNodes.filter(l=>r.id?l.id===r.id:l.name===r.name)),s=r.uniqueId?o.find(l=>l.uniqueId===r.uniqueId):o[0]}else if(qg(n))s=bb(n,r.value);else if(Ib(n)){const o=i.animationGroups.filter(l=>l.name===r.name);s=o.length===1?o[0]:o.find(l=>l.uniqueId===r.uniqueId)}else n==="Matrix"?s=P.FromArray(r.value):n==="Matrix2D"?s=new fi(r.value):n==="Matrix3D"?s=new ui(r.value):n==="FlowGraphInteger"?s=et.FromValue(r.value):n==="number"||n==="string"||n==="boolean"?s=r.value[0]:r&&r.value!==void 0?s=r.value:Array.isArray(r)?s=r.reduce((o,l)=>(l.eventData&&(o[l.id]={type:ot(l.type)},typeof l.value<"u"&&(o[l.id].value=go("value",l,t,i))),o),{}):s=r;return s}function xb(a){return a==="FlowGraphJsonPointerParserBlock"}var Yf;(function(a){a.Animation="Animation",a.AnimationGroup="AnimationGroup",a.Mesh="Mesh",a.Material="Material",a.Camera="Camera",a.Light="Light"})(Yf||(Yf={}));function jg(a,e,t,i){switch(e){case"Animation":return i?a.animations.find(r=>r.uniqueId===t)??null:a.animations[t]??null;case"AnimationGroup":return i?a.animationGroups.find(r=>r.uniqueId===t)??null:a.animationGroups[t]??null;case"Mesh":return i?a.meshes.find(r=>r.uniqueId===t)??null:a.meshes[t]??null;case"Material":return i?a.materials.find(r=>r.uniqueId===t)??null:a.materials[t]??null;case"Camera":return i?a.cameras.find(r=>r.uniqueId===t)??null:a.cameras[t]??null;case"Light":return i?a.lights.find(r=>r.uniqueId===t)??null:a.lights[t]??null;default:return null}}var Kf;(function(a){a.ExecuteBlock="ExecuteBlock",a.ExecuteEvent="ExecuteEvent",a.TriggerConnection="TriggerConnection",a.ContextVariableSet="ContextVariableSet",a.GlobalVariableSet="GlobalVariableSet",a.GlobalVariableDelete="GlobalVariableDelete",a.GlobalVariableGet="GlobalVariableGet",a.AddConnection="AddConnection",a.GetConnectionValue="GetConnectionValue",a.SetConnectionValue="SetConnectionValue",a.ActivateSignal="ActivateSignal",a.ContextVariableGet="ContextVariableGet"})(Kf||(Kf={}));class yb{constructor(){this.logToConsole=!1,this.log=[]}addLogItem(e){var t;if(e.time||(e.time=Date.now()),this.log.push(e),this.logToConsole){const i=(t=e.payload)==null?void 0:t.value;typeof i=="object"&&i.getClassName?B.Log(`[FGLog] ${e.className}:${e.uniqueId.split("-")[0]} ${e.action} - ${JSON.stringify(i.getClassName())}: ${i.toString()}`):B.Log(`[FGLog] ${e.className}:${e.uniqueId.split("-")[0]} ${e.action} - ${JSON.stringify(e.payload)}`)}}getItemsOfType(e){return this.log.filter(t=>t.action===e)}}class Zg{get enableLogging(){return this._enableLogging}set enableLogging(e){this._enableLogging!==e&&(this._enableLogging=e,this._enableLogging?(this.logger=new yb,this.logger.logToConsole=!0):this.logger=null)}constructor(e){this.uniqueId=xs(),this._userVariables={},this._executionVariables={},this._globalContextVariables={},this._connectionValues={},this._pendingBlocks=[],this._executionId=0,this.onNodeExecutedObservable=new U,this.treatDataAsRightHanded=!1,this._enableLogging=!1,this._configuration=e,this.assetsContext=e.assetsContext??e.scene}hasVariable(e){return e in this._userVariables}setVariable(e,t){var i;this._userVariables[e]=t,(i=this.logger)==null||i.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"ContextVariableSet",payload:{name:e,value:t}})}getAsset(e,t){return jg(this.assetsContext,e,t)}getVariable(e){var t;return(t=this.logger)==null||t.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"ContextVariableGet",payload:{name:e,value:this._userVariables[e]}}),this._userVariables[e]}get userVariables(){return this._userVariables}getScene(){return this._configuration.scene}_getUniqueIdPrefixedName(e,t){return`${e.uniqueId}_${t}`}_getGlobalContextVariable(e,t){var i;return(i=this.logger)==null||i.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"GlobalVariableGet",payload:{name:e,defaultValue:t,possibleValue:this._globalContextVariables[e]}}),this._hasGlobalContextVariable(e)?this._globalContextVariables[e]:t}_setGlobalContextVariable(e,t){var i;(i=this.logger)==null||i.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"GlobalVariableSet",payload:{name:e,value:t}}),this._globalContextVariables[e]=t}_deleteGlobalContextVariable(e){var t;(t=this.logger)==null||t.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"GlobalVariableDelete",payload:{name:e}}),delete this._globalContextVariables[e]}_hasGlobalContextVariable(e){return e in this._globalContextVariables}_setExecutionVariable(e,t,i){this._executionVariables[this._getUniqueIdPrefixedName(e,t)]=i}_getExecutionVariable(e,t,i){return this._hasExecutionVariable(e,t)?this._executionVariables[this._getUniqueIdPrefixedName(e,t)]:i}_deleteExecutionVariable(e,t){delete this._executionVariables[this._getUniqueIdPrefixedName(e,t)]}_hasExecutionVariable(e,t){return this._getUniqueIdPrefixedName(e,t)in this._executionVariables}_hasConnectionValue(e){return e.uniqueId in this._connectionValues}_setConnectionValue(e,t){var i;this._connectionValues[e.uniqueId]=t,(i=this.logger)==null||i.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"SetConnectionValue",payload:{connectionPointId:e.uniqueId,value:t}})}_setConnectionValueByKey(e,t){this._connectionValues[e]=t}_getConnectionValue(e){var t;return(t=this.logger)==null||t.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"GetConnectionValue",payload:{connectionPointId:e.uniqueId,value:this._connectionValues[e.uniqueId]}}),this._connectionValues[e.uniqueId]}get configuration(){return this._configuration}get hasPendingBlocks(){return this._pendingBlocks.length>0}_addPendingBlock(e){this._pendingBlocks.includes(e)||(this._pendingBlocks.push(e),this._pendingBlocks.sort((t,i)=>t.priority-i.priority))}_removePendingBlock(e){const t=this._pendingBlocks.indexOf(e);t!==-1&&this._pendingBlocks.splice(t,1)}_clearPendingBlocks(){for(const e of this._pendingBlocks)e._cancelPendingTasks(this);this._pendingBlocks.length=0}_notifyExecuteNode(e){var t;this.onNodeExecutedObservable.notifyObservers(e),(t=this.logger)==null||t.addLogItem({time:Date.now(),className:e.getClassName(),uniqueId:e.uniqueId,action:"ExecuteBlock"})}_notifyOnTick(e){var t;this._setGlobalContextVariable("timeSinceStart",e.timeSinceStart),this._setGlobalContextVariable("deltaTime",e.deltaTime);for(const i of this._pendingBlocks)(t=i._executeOnTick)==null||t.call(i,this)}_increaseExecutionId(){this._executionId++}get executionId(){return this._executionId}serialize(e={},t=mo){var i;e.uniqueId=this.uniqueId,e._userVariables={};for(const r in this._userVariables)t(r,this._userVariables[r],e._userVariables);e._connectionValues={};for(const r in this._connectionValues)t(r,this._connectionValues[r],e._connectionValues);this.assetsContext!==this.getScene()&&(e._assetsContext={meshes:this.assetsContext.meshes.map(r=>r.id),materials:this.assetsContext.materials.map(r=>r.id),textures:this.assetsContext.textures.map(r=>r.name),animations:this.assetsContext.animations.map(r=>r.name),lights:this.assetsContext.lights.map(r=>r.id),cameras:this.assetsContext.cameras.map(r=>r.id),sounds:(i=this.assetsContext.sounds)==null?void 0:i.map(r=>r.name),skeletons:this.assetsContext.skeletons.map(r=>r.id),particleSystems:this.assetsContext.particleSystems.map(r=>r.name),geometries:this.assetsContext.geometries.map(r=>r.id),multiMaterials:this.assetsContext.multiMaterials.map(r=>r.id),transformNodes:this.assetsContext.transformNodes.map(r=>r.id)})}getClassName(){return"FlowGraphContext"}}A([y()],Zg.prototype,"uniqueId",void 0);var qf;(function(a){a[a.Input=0]="Input",a[a.Output=1]="Output"})(qf||(qf={}));class Qg{constructor(e,t,i){this._ownerBlock=i,this._connectedPoint=[],this.uniqueId=xs(),this.connectedPointIds=[],this.name=e,this._connectionType=t}get connectionType(){return this._connectionType}_isSingularConnection(){return!0}isConnected(){return this._connectedPoint.length>0}connectTo(e){if(this._connectionType===e._connectionType)throw new Error(`Cannot connect two points of type ${this.connectionType}`);if(this._isSingularConnection()&&this._connectedPoint.length>0||e._isSingularConnection()&&e._connectedPoint.length>0)throw new Error("Max number of connections for point reached");this._connectedPoint.push(e),e._connectedPoint.push(this)}disconnectFrom(e,t=!0){const i=this._connectedPoint.indexOf(e),r=e._connectedPoint.indexOf(this);i===-1||r===-1||(t&&this._connectedPoint.splice(i,1),e._connectedPoint.splice(r,1))}disconnectFromAll(){for(const e of this._connectedPoint)this.disconnectFrom(e,!1);this._connectedPoint.length=0}dispose(){for(const e of this._connectedPoint)this.disconnectFrom(e)}serialize(e={}){e.uniqueId=this.uniqueId,e.name=this.name,e._connectionType=this._connectionType,e.connectedPointIds=[],e.className=this.getClassName();for(const t of this._connectedPoint)e.connectedPointIds.push(t.uniqueId)}getClassName(){return"FGConnection"}deserialize(e){this.uniqueId=e.uniqueId,this.name=e.name,this._connectionType=e._connectionType,this.connectedPointIds=e.connectedPointIds}}class gl extends Qg{constructor(e,t,i,r,s=r.defaultValue,n=!1){super(e,t,i),this.richType=r,this._defaultValue=s,this._optional=n,this._isDisabled=!1,this._lastValue=null,this.dataTransformer=null,this.onValueChangedObservable=new U}get optional(){return this._optional}get isDisabled(){return this._isDisabled}set isDisabled(e){this._isDisabled!==e&&(this._isDisabled=e,this._isDisabled&&this.disconnectFromAll())}_isSingularConnection(){return this.connectionType===0}setValue(e,t){t._getConnectionValue(this)!==e&&(t._setConnectionValue(this,e),this.onValueChangedObservable.notifyObservers(e))}resetToDefaultValue(e){e._setConnectionValue(this,this._defaultValue)}connectTo(e){this._isDisabled||super.connectTo(e)}_getValueOrDefault(e){const t=e._getConnectionValue(this)??this._defaultValue;return this.dataTransformer?this.dataTransformer(t):t}getValue(e){if(this.connectionType===1){e._notifyExecuteNode(this._ownerBlock),this._ownerBlock._updateOutputs(e);const i=this._getValueOrDefault(e);return this._lastValue=i,this.richType.typeTransformer?this.richType.typeTransformer(i):i}const t=this.isConnected()?this._connectedPoint[0].getValue(e):this._getValueOrDefault(e);return this._lastValue=t,this.richType.typeTransformer?this.richType.typeTransformer(t):t}_getLastValue(){return this._lastValue}getClassName(){return"FlowGraphDataConnection"}serialize(e={}){super.serialize(e),e.richType={},this.richType.serialize(e.richType),e.optional=this._optional,mo("defaultValue",this._defaultValue,e)}}Y("FlowGraphDataConnection",gl);class ti{constructor(e){var t;this.config=e,this.uniqueId=xs(),this.name=((t=this.config)==null?void 0:t.name)??this.getClassName(),this.dataInputs=[],this.dataOutputs=[]}_updateOutputs(e){}registerDataInput(e,t,i){const r=new gl(e,0,this,t,i);return this.dataInputs.push(r),r}registerDataOutput(e,t,i){const r=new gl(e,1,this,t,i);return this.dataOutputs.push(r),r}getDataInput(e){return this.dataInputs.find(t=>t.name===e)}getDataOutput(e){return this.dataOutputs.find(t=>t.name===e)}serialize(e={},t=mo){if(e.uniqueId=this.uniqueId,e.config={},this.config){const i=this.config;Object.keys(this.config).forEach(r=>{t(r,i[r],e.config)})}e.dataInputs=[],e.dataOutputs=[],e.className=this.getClassName();for(const i of this.dataInputs){const r={};i.serialize(r),e.dataInputs.push(r)}for(const i of this.dataOutputs){const r={};i.serialize(r),e.dataOutputs.push(r)}}deserialize(e){}_log(e,t,i){var r;(r=e.logger)==null||r.addLogItem({action:t,payload:i,className:this.getClassName(),uniqueId:this.uniqueId})}getClassName(){return"FlowGraphBlock"}}class El extends Qg{constructor(){super(...arguments),this.priority=0}_isSingularConnection(){return!1}connectTo(e){super.connectTo(e),this._connectedPoint.sort((t,i)=>i.priority-t.priority)}_activateSignal(e){var t;if((t=e.logger)==null||t.addLogItem({action:"ActivateSignal",className:this._ownerBlock.getClassName(),uniqueId:this._ownerBlock.uniqueId,payload:{connectionType:this.connectionType,name:this.name}}),this.connectionType===0)e._notifyExecuteNode(this._ownerBlock),this._ownerBlock._execute(e,this),e._increaseExecutionId();else for(const i of this._connectedPoint)i._activateSignal(e)}}Y("FlowGraphSignalConnection",El);class kr extends ti{constructor(e){super(e),this.priority=0,this.signalInputs=[],this.signalOutputs=[],this.in=this._registerSignalInput("in"),this.error=this._registerSignalOutput("error")}_registerSignalInput(e){const t=new El(e,0,this);return this.signalInputs.push(t),t}_registerSignalOutput(e){const t=new El(e,1,this);return this.signalOutputs.push(t),t}_unregisterSignalInput(e){const t=this.signalInputs.findIndex(i=>i.name===e);t!==-1&&(this.signalInputs[t].dispose(),this.signalInputs.splice(t,1))}_unregisterSignalOutput(e){const t=this.signalOutputs.findIndex(i=>i.name===e);t!==-1&&(this.signalOutputs[t].dispose(),this.signalOutputs.splice(t,1))}_reportError(e,t){this.error.payload=typeof t=="string"?new Error(t):t,this.error._activateSignal(e)}getSignalInput(e){return this.signalInputs.find(t=>t.name===e)}getSignalOutput(e){return this.signalOutputs.find(t=>t.name===e)}serialize(e={}){super.serialize(e),e.signalInputs=[],e.signalOutputs=[];for(const t of this.signalInputs){const i={};t.serialize(i),e.signalInputs.push(i)}for(const t of this.signalOutputs){const i={};t.serialize(i),e.signalOutputs.push(i)}}deserialize(e){for(let t=0;t<e.signalInputs.length;t++){const i=this.getSignalInput(e.signalInputs[t].name);if(i)i.deserialize(e.signalInputs[t]);else throw new Error("Could not find signal input with name "+e.signalInputs[t].name+" in block "+e.className)}for(let t=0;t<e.signalOutputs.length;t++){const i=this.getSignalOutput(e.signalOutputs[t].name);if(i)i.deserialize(e.signalOutputs[t]);else throw new Error("Could not find signal output with name "+e.signalOutputs[t].name+" in block "+e.className)}}getClassName(){return"FlowGraphExecutionBlock"}}class Mb{constructor(e){this.onEventTriggeredObservable=new U,this.sceneReadyTriggered=!1,this._pointerUnderMeshState={},this._startingTime=0,this._scene=e,this._initialize()}_initialize(){this._sceneReadyObserver=this._scene.onReadyObservable.add(()=>{this.sceneReadyTriggered||(this.onEventTriggeredObservable.notifyObservers({type:"SceneReady"}),this.sceneReadyTriggered=!0)}),this._sceneDisposeObserver=this._scene.onDisposeObservable.add(()=>{this.onEventTriggeredObservable.notifyObservers({type:"SceneDispose"})}),this._sceneOnBeforeRenderObserver=this._scene.onBeforeRenderObservable.add(()=>{const e=this._scene.getEngine().getDeltaTime()/1e3;this.onEventTriggeredObservable.notifyObservers({type:"SceneBeforeRender",payload:{timeSinceStart:this._startingTime,deltaTime:e}}),this._startingTime+=e}),this._meshPickedObserver=this._scene.onPointerObservable.add(e=>{this.onEventTriggeredObservable.notifyObservers({type:"MeshPick",payload:e})},ge.POINTERPICK),this._meshUnderPointerObserver=this._scene.onMeshUnderPointerUpdatedObservable.add(e=>{const t=e.pointerId,i=e.mesh,r=this._pointerUnderMeshState[t];!r&&i?this.onEventTriggeredObservable.notifyObservers({type:"PointerOver",payload:{pointerId:t,mesh:i}}):r&&!i?this.onEventTriggeredObservable.notifyObservers({type:"PointerOut",payload:{pointerId:t,mesh:r}}):r&&i&&r!==i&&(this.onEventTriggeredObservable.notifyObservers({type:"PointerOut",payload:{pointerId:t,mesh:r,over:i}}),this.onEventTriggeredObservable.notifyObservers({type:"PointerOver",payload:{pointerId:t,mesh:i,out:r}})),this._pointerUnderMeshState[t]=i},ge.POINTERMOVE)}dispose(){var e,t,i,r,s;(e=this._sceneDisposeObserver)==null||e.remove(),(t=this._sceneReadyObserver)==null||t.remove(),(i=this._sceneOnBeforeRenderObserver)==null||i.remove(),(r=this._meshPickedObserver)==null||r.remove(),(s=this._meshUnderPointerObserver)==null||s.remove(),this.onEventTriggeredObservable.clear()}}function Cs(a,e){return!!(a.parent&&(a.parent===e||Cs(a.parent,e)))}function li(a){if(a.getClassName)return a.getClassName()}function Yn(a,e){return a===e&&(a==="Vector2"||a==="Vector3"||a==="Vector4")}function Kn(a,e){return a===e&&(a==="Matrix"||a==="Matrix2D"||a==="Matrix3D")}function qn(a,e){return a==="FlowGraphInteger"&&e==="FlowGraphInteger"}function rn(a,e){const t=typeof a=="number"||typeof(a==null?void 0:a.value)=="number";return t&&!isNaN(vi(a))}function vi(a){return typeof a=="number"?a:a.value}var jf;(function(a){a[a.Stopped=0]="Stopped",a[a.Started=1]="Started"})(jf||(jf={}));class Pb{get state(){return this._state}set state(e){this._state=e,this.onStateChangedObservable.notifyObservers(e)}constructor(e){this.onStateChangedObservable=new U,this._eventBlocks={SceneReady:[],SceneDispose:[],SceneBeforeRender:[],MeshPick:[],PointerDown:[],PointerUp:[],PointerMove:[],PointerOver:[],PointerOut:[],SceneAfterRender:[],NoTrigger:[]},this._executionContexts=[],this._state=0,this._scene=e.scene,this._sceneEventCoordinator=new Mb(this._scene),this._coordinator=e.coordinator,this._eventObserver=this._sceneEventCoordinator.onEventTriggeredObservable.add(t=>{for(const i of this._executionContexts){const r=this._getContextualOrder(t.type,i);for(const s of r)if(!s._executeEvent(i,t.payload))break}switch(t.type){case"SceneReady":this._sceneEventCoordinator.sceneReadyTriggered=!0;break;case"SceneBeforeRender":for(const i of this._executionContexts)i._notifyOnTick(t.payload);break;case"SceneDispose":this.dispose();break}})}createContext(){const e=new Zg({scene:this._scene,coordinator:this._coordinator});return this._executionContexts.push(e),e}getContext(e){return this._executionContexts[e]}addEventBlock(e){if((e.type==="PointerOver"||e.type==="PointerOut")&&(this._scene.constantlyUpdateMeshUnderPointer=!0),e.type!=="NoTrigger"&&this._eventBlocks[e.type].push(e),this.state===1)for(const t of this._executionContexts)e._startPendingTasks(t);else this.onStateChangedObservable.addOnce(t=>{if(t===1)for(const i of this._executionContexts)e._startPendingTasks(i)})}start(){this.state!==1&&(this._executionContexts.length===0&&this.createContext(),this.onStateChangedObservable.add(e=>{e===1&&(this._startPendingEvents(),this._scene.isReady(!0)&&this._sceneEventCoordinator.onEventTriggeredObservable.notifyObservers({type:"SceneReady"}))}),this.state=1)}_startPendingEvents(){for(const e of this._executionContexts)for(const t in this._eventBlocks){const i=this._getContextualOrder(t,e);for(const r of i)r._startPendingTasks(e)}}_getContextualOrder(e,t){const i=this._eventBlocks[e].sort((r,s)=>s.initPriority-r.initPriority);if(e==="MeshPick"){const r=[];for(const s of i){const n=s.asset.getValue(t);let o=0;for(;o<i.length;o++){const c=i[o].asset.getValue(t);if(n&&c&&Cs(n,c))break}r.splice(o,0,s)}return r}return i}dispose(){var e;if(this.state!==0){this.state=0;for(const t of this._executionContexts)t._clearPendingBlocks();this._executionContexts.length=0;for(const t in this._eventBlocks)this._eventBlocks[t].length=0;(e=this._eventObserver)==null||e.remove(),this._sceneEventCoordinator.dispose()}}visitAllBlocks(e){const t=[],i=new Set;for(const r in this._eventBlocks)for(const s of this._eventBlocks[r])t.push(s),i.add(s.uniqueId);for(;t.length>0;){const r=t.pop();e(r);for(const s of r.dataInputs)for(const n of s._connectedPoint)i.has(n._ownerBlock.uniqueId)||(t.push(n._ownerBlock),i.add(n._ownerBlock.uniqueId));if(r instanceof kr)for(const s of r.signalOutputs)for(const n of s._connectedPoint)i.has(n._ownerBlock.uniqueId)||(t.push(n._ownerBlock),i.add(n._ownerBlock.uniqueId))}}serialize(e={},t){e.allBlocks=[],this.visitAllBlocks(i=>{const r={};i.serialize(r),e.allBlocks.push(r)}),e.executionContexts=[];for(const i of this._executionContexts){const r={};i.serialize(r,t),e.executionContexts.push(r)}}}class dr{constructor(e){this.config=e,this.dispatchEventsSynchronously=!0,this._flowGraphs=[],this._customEventsMap=new Map,this._eventExecutionCounter=new Map,this._executeOnNextFrame=[],this._disposeObserver=this.config.scene.onDisposeObservable.add(()=>{this.dispose()}),this._onBeforeRenderObserver=this.config.scene.onBeforeRenderObservable.add(()=>{this._eventExecutionCounter.clear(),this._executeOnNextFrame.length&&(this._executeOnNextFrame.forEach(i=>{this.notifyCustomEvent(i.id,i.data,!1)}),this._executeOnNextFrame.length=0)}),(dr.SceneCoordinators.get(this.config.scene)??[]).push(this)}createGraph(){const e=new Pb({scene:this.config.scene,coordinator:this});return this._flowGraphs.push(e),e}removeGraph(e){const t=this._flowGraphs.indexOf(e);t!==-1&&(e.dispose(),this._flowGraphs.splice(t,1))}start(){this._flowGraphs.forEach(e=>e.start())}dispose(){var i,r;this._flowGraphs.forEach(s=>s.dispose()),this._flowGraphs.length=0,(i=this._disposeObserver)==null||i.remove(),(r=this._onBeforeRenderObserver)==null||r.remove();const e=dr.SceneCoordinators.get(this.config.scene)??[],t=e.indexOf(this);t!==-1&&e.splice(t,1)}serialize(e,t){e._flowGraphs=[],this._flowGraphs.forEach(i=>{const r={};i.serialize(r,t),e._flowGraphs.push(r)}),e.dispatchEventsSynchronously=this.dispatchEventsSynchronously}get flowGraphs(){return this._flowGraphs}getCustomEventObservable(e){let t=this._customEventsMap.get(e);return t||(t=new U,this._customEventsMap.set(e,t)),t}notifyCustomEvent(e,t,i=!this.dispatchEventsSynchronously){if(i){this._executeOnNextFrame.push({id:e,data:t});return}if(this._eventExecutionCounter.has(e)){const s=this._eventExecutionCounter.get(e);if(this._eventExecutionCounter.set(e,s+1),s>=dr.MaxEventTypeExecutionPerFrame){s===dr.MaxEventTypeExecutionPerFrame&&B.Warn(`FlowGraphCoordinator: Too many executions of event "${e}".`);return}}else this._eventExecutionCounter.set(e,1);const r=this._customEventsMap.get(e);r&&r.notifyObservers(t)}}dr.MaxEventsPerType=30;dr.MaxEventTypeExecutionPerFrame=30;dr.SceneCoordinators=new Map;const vl={};function wL(a,e,t){vl[`${a}/${e}`]=t}function Ob(a){switch(a){case"FlowGraphPlayAnimationBlock":return async()=>(await X(async()=>{const{FlowGraphPlayAnimationBlock:e}=await Promise.resolve().then(()=>PD);return{FlowGraphPlayAnimationBlock:e}},void 0,import.meta.url)).FlowGraphPlayAnimationBlock;case"FlowGraphStopAnimationBlock":return async()=>(await X(async()=>{const{FlowGraphStopAnimationBlock:e}=await Promise.resolve().then(()=>OD);return{FlowGraphStopAnimationBlock:e}},void 0,import.meta.url)).FlowGraphStopAnimationBlock;case"FlowGraphPauseAnimationBlock":return async()=>(await X(async()=>{const{FlowGraphPauseAnimationBlock:e}=await Promise.resolve().then(()=>DD);return{FlowGraphPauseAnimationBlock:e}},void 0,import.meta.url)).FlowGraphPauseAnimationBlock;case"FlowGraphInterpolationBlock":return async()=>(await X(async()=>{const{FlowGraphInterpolationBlock:e}=await Promise.resolve().then(()=>LD);return{FlowGraphInterpolationBlock:e}},void 0,import.meta.url)).FlowGraphInterpolationBlock;case"FlowGraphSceneReadyEventBlock":return async()=>(await X(async()=>{const{FlowGraphSceneReadyEventBlock:e}=await Promise.resolve().then(()=>ND);return{FlowGraphSceneReadyEventBlock:e}},void 0,import.meta.url)).FlowGraphSceneReadyEventBlock;case"FlowGraphSceneTickEventBlock":return async()=>(await X(async()=>{const{FlowGraphSceneTickEventBlock:e}=await Promise.resolve().then(()=>FD);return{FlowGraphSceneTickEventBlock:e}},void 0,import.meta.url)).FlowGraphSceneTickEventBlock;case"FlowGraphSendCustomEventBlock":return async()=>(await X(async()=>{const{FlowGraphSendCustomEventBlock:e}=await Promise.resolve().then(()=>wD);return{FlowGraphSendCustomEventBlock:e}},void 0,import.meta.url)).FlowGraphSendCustomEventBlock;case"FlowGraphReceiveCustomEventBlock":return async()=>(await X(async()=>{const{FlowGraphReceiveCustomEventBlock:e}=await Promise.resolve().then(()=>BD);return{FlowGraphReceiveCustomEventBlock:e}},void 0,import.meta.url)).FlowGraphReceiveCustomEventBlock;case"FlowGraphMeshPickEventBlock":return async()=>(await X(async()=>{const{FlowGraphMeshPickEventBlock:e}=await Promise.resolve().then(()=>UD);return{FlowGraphMeshPickEventBlock:e}},void 0,import.meta.url)).FlowGraphMeshPickEventBlock;case"FlowGraphEBlock":return async()=>(await X(async()=>{const{FlowGraphEBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphEBlock:e}},void 0,import.meta.url)).FlowGraphEBlock;case"FlowGraphPIBlock":return async()=>(await X(async()=>{const{FlowGraphPiBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphPiBlock:e}},void 0,import.meta.url)).FlowGraphPiBlock;case"FlowGraphInfBlock":return async()=>(await X(async()=>{const{FlowGraphInfBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphInfBlock:e}},void 0,import.meta.url)).FlowGraphInfBlock;case"FlowGraphNaNBlock":return async()=>(await X(async()=>{const{FlowGraphNaNBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphNaNBlock:e}},void 0,import.meta.url)).FlowGraphNaNBlock;case"FlowGraphRandomBlock":return async()=>(await X(async()=>{const{FlowGraphRandomBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphRandomBlock:e}},void 0,import.meta.url)).FlowGraphRandomBlock;case"FlowGraphAddBlock":return async()=>(await X(async()=>{const{FlowGraphAddBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphAddBlock:e}},void 0,import.meta.url)).FlowGraphAddBlock;case"FlowGraphSubtractBlock":return async()=>(await X(async()=>{const{FlowGraphSubtractBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphSubtractBlock:e}},void 0,import.meta.url)).FlowGraphSubtractBlock;case"FlowGraphMultiplyBlock":return async()=>(await X(async()=>{const{FlowGraphMultiplyBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphMultiplyBlock:e}},void 0,import.meta.url)).FlowGraphMultiplyBlock;case"FlowGraphDivideBlock":return async()=>(await X(async()=>{const{FlowGraphDivideBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphDivideBlock:e}},void 0,import.meta.url)).FlowGraphDivideBlock;case"FlowGraphAbsBlock":return async()=>(await X(async()=>{const{FlowGraphAbsBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphAbsBlock:e}},void 0,import.meta.url)).FlowGraphAbsBlock;case"FlowGraphSignBlock":return async()=>(await X(async()=>{const{FlowGraphSignBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphSignBlock:e}},void 0,import.meta.url)).FlowGraphSignBlock;case"FlowGraphTruncBlock":return async()=>(await X(async()=>{const{FlowGraphTruncBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphTruncBlock:e}},void 0,import.meta.url)).FlowGraphTruncBlock;case"FlowGraphFloorBlock":return async()=>(await X(async()=>{const{FlowGraphFloorBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphFloorBlock:e}},void 0,import.meta.url)).FlowGraphFloorBlock;case"FlowGraphCeilBlock":return async()=>(await X(async()=>{const{FlowGraphCeilBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphCeilBlock:e}},void 0,import.meta.url)).FlowGraphCeilBlock;case"FlowGraphRoundBlock":return async()=>(await X(async()=>{const{FlowGraphRoundBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphRoundBlock:e}},void 0,import.meta.url)).FlowGraphRoundBlock;case"FlowGraphFractBlock":return async()=>(await X(async()=>{const{FlowGraphFractionBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphFractionBlock:e}},void 0,import.meta.url)).FlowGraphFractionBlock;case"FlowGraphNegationBlock":return async()=>(await X(async()=>{const{FlowGraphNegationBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphNegationBlock:e}},void 0,import.meta.url)).FlowGraphNegationBlock;case"FlowGraphModuloBlock":return async()=>(await X(async()=>{const{FlowGraphModuloBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphModuloBlock:e}},void 0,import.meta.url)).FlowGraphModuloBlock;case"FlowGraphMinBlock":return async()=>(await X(async()=>{const{FlowGraphMinBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphMinBlock:e}},void 0,import.meta.url)).FlowGraphMinBlock;case"FlowGraphMaxBlock":return async()=>(await X(async()=>{const{FlowGraphMaxBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphMaxBlock:e}},void 0,import.meta.url)).FlowGraphMaxBlock;case"FlowGraphClampBlock":return async()=>(await X(async()=>{const{FlowGraphClampBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphClampBlock:e}},void 0,import.meta.url)).FlowGraphClampBlock;case"FlowGraphSaturateBlock":return async()=>(await X(async()=>{const{FlowGraphSaturateBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphSaturateBlock:e}},void 0,import.meta.url)).FlowGraphSaturateBlock;case"FlowGraphMathInterpolationBlock":return async()=>(await X(async()=>{const{FlowGraphMathInterpolationBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphMathInterpolationBlock:e}},void 0,import.meta.url)).FlowGraphMathInterpolationBlock;case"FlowGraphEqualityBlock":return async()=>(await X(async()=>{const{FlowGraphEqualityBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphEqualityBlock:e}},void 0,import.meta.url)).FlowGraphEqualityBlock;case"FlowGraphLessThanBlock":return async()=>(await X(async()=>{const{FlowGraphLessThanBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphLessThanBlock:e}},void 0,import.meta.url)).FlowGraphLessThanBlock;case"FlowGraphLessThanOrEqualBlock":return async()=>(await X(async()=>{const{FlowGraphLessThanOrEqualBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphLessThanOrEqualBlock:e}},void 0,import.meta.url)).FlowGraphLessThanOrEqualBlock;case"FlowGraphGreaterThanBlock":return async()=>(await X(async()=>{const{FlowGraphGreaterThanBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphGreaterThanBlock:e}},void 0,import.meta.url)).FlowGraphGreaterThanBlock;case"FlowGraphGreaterThanOrEqualBlock":return async()=>(await X(async()=>{const{FlowGraphGreaterThanOrEqualBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphGreaterThanOrEqualBlock:e}},void 0,import.meta.url)).FlowGraphGreaterThanOrEqualBlock;case"FlowGraphIsNaNBlock":return async()=>(await X(async()=>{const{FlowGraphIsNanBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphIsNanBlock:e}},void 0,import.meta.url)).FlowGraphIsNanBlock;case"FlowGraphIsInfBlock":return async()=>(await X(async()=>{const{FlowGraphIsInfinityBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphIsInfinityBlock:e}},void 0,import.meta.url)).FlowGraphIsInfinityBlock;case"FlowGraphDegToRadBlock":return async()=>(await X(async()=>{const{FlowGraphDegToRadBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphDegToRadBlock:e}},void 0,import.meta.url)).FlowGraphDegToRadBlock;case"FlowGraphRadToDegBlock":return async()=>(await X(async()=>{const{FlowGraphRadToDegBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphRadToDegBlock:e}},void 0,import.meta.url)).FlowGraphRadToDegBlock;case"FlowGraphSinBlock":return async()=>(await X(async()=>{const{FlowGraphSinBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphSinBlock:e}},void 0,import.meta.url)).FlowGraphSinBlock;case"FlowGraphCosBlock":return async()=>(await X(async()=>{const{FlowGraphCosBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphCosBlock:e}},void 0,import.meta.url)).FlowGraphCosBlock;case"FlowGraphTanBlock":return async()=>(await X(async()=>{const{FlowGraphTanBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphTanBlock:e}},void 0,import.meta.url)).FlowGraphTanBlock;case"FlowGraphASinBlock":return async()=>(await X(async()=>{const{FlowGraphAsinBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphAsinBlock:e}},void 0,import.meta.url)).FlowGraphAsinBlock;case"FlowGraphACosBlock":return async()=>(await X(async()=>{const{FlowGraphAcosBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphAcosBlock:e}},void 0,import.meta.url)).FlowGraphAcosBlock;case"FlowGraphATanBlock":return async()=>(await X(async()=>{const{FlowGraphAtanBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphAtanBlock:e}},void 0,import.meta.url)).FlowGraphAtanBlock;case"FlowGraphATan2Block":return async()=>(await X(async()=>{const{FlowGraphAtan2Block:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphAtan2Block:e}},void 0,import.meta.url)).FlowGraphAtan2Block;case"FlowGraphSinhBlock":return async()=>(await X(async()=>{const{FlowGraphSinhBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphSinhBlock:e}},void 0,import.meta.url)).FlowGraphSinhBlock;case"FlowGraphCoshBlock":return async()=>(await X(async()=>{const{FlowGraphCoshBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphCoshBlock:e}},void 0,import.meta.url)).FlowGraphCoshBlock;case"FlowGraphTanhBlock":return async()=>(await X(async()=>{const{FlowGraphTanhBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphTanhBlock:e}},void 0,import.meta.url)).FlowGraphTanhBlock;case"FlowGraphASinhBlock":return async()=>(await X(async()=>{const{FlowGraphAsinhBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphAsinhBlock:e}},void 0,import.meta.url)).FlowGraphAsinhBlock;case"FlowGraphACoshBlock":return async()=>(await X(async()=>{const{FlowGraphAcoshBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphAcoshBlock:e}},void 0,import.meta.url)).FlowGraphAcoshBlock;case"FlowGraphATanhBlock":return async()=>(await X(async()=>{const{FlowGraphAtanhBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphAtanhBlock:e}},void 0,import.meta.url)).FlowGraphAtanhBlock;case"FlowGraphExponentialBlock":return async()=>(await X(async()=>{const{FlowGraphExpBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphExpBlock:e}},void 0,import.meta.url)).FlowGraphExpBlock;case"FlowGraphLogBlock":return async()=>(await X(async()=>{const{FlowGraphLogBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphLogBlock:e}},void 0,import.meta.url)).FlowGraphLogBlock;case"FlowGraphLog2Block":return async()=>(await X(async()=>{const{FlowGraphLog2Block:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphLog2Block:e}},void 0,import.meta.url)).FlowGraphLog2Block;case"FlowGraphLog10Block":return async()=>(await X(async()=>{const{FlowGraphLog10Block:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphLog10Block:e}},void 0,import.meta.url)).FlowGraphLog10Block;case"FlowGraphSquareRootBlock":return async()=>(await X(async()=>{const{FlowGraphSquareRootBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphSquareRootBlock:e}},void 0,import.meta.url)).FlowGraphSquareRootBlock;case"FlowGraphPowerBlock":return async()=>(await X(async()=>{const{FlowGraphPowerBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphPowerBlock:e}},void 0,import.meta.url)).FlowGraphPowerBlock;case"FlowGraphCubeRootBlock":return async()=>(await X(async()=>{const{FlowGraphCubeRootBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphCubeRootBlock:e}},void 0,import.meta.url)).FlowGraphCubeRootBlock;case"FlowGraphBitwiseAndBlock":return async()=>(await X(async()=>{const{FlowGraphBitwiseAndBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphBitwiseAndBlock:e}},void 0,import.meta.url)).FlowGraphBitwiseAndBlock;case"FlowGraphBitwiseOrBlock":return async()=>(await X(async()=>{const{FlowGraphBitwiseOrBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphBitwiseOrBlock:e}},void 0,import.meta.url)).FlowGraphBitwiseOrBlock;case"FlowGraphBitwiseNotBlock":return async()=>(await X(async()=>{const{FlowGraphBitwiseNotBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphBitwiseNotBlock:e}},void 0,import.meta.url)).FlowGraphBitwiseNotBlock;case"FlowGraphBitwiseXorBlock":return async()=>(await X(async()=>{const{FlowGraphBitwiseXorBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphBitwiseXorBlock:e}},void 0,import.meta.url)).FlowGraphBitwiseXorBlock;case"FlowGraphBitwiseLeftShiftBlock":return async()=>(await X(async()=>{const{FlowGraphBitwiseLeftShiftBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphBitwiseLeftShiftBlock:e}},void 0,import.meta.url)).FlowGraphBitwiseLeftShiftBlock;case"FlowGraphBitwiseRightShiftBlock":return async()=>(await X(async()=>{const{FlowGraphBitwiseRightShiftBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphBitwiseRightShiftBlock:e}},void 0,import.meta.url)).FlowGraphBitwiseRightShiftBlock;case"FlowGraphLengthBlock":return async()=>(await X(async()=>{const{FlowGraphLengthBlock:e}=await Promise.resolve().then(()=>Hr);return{FlowGraphLengthBlock:e}},void 0,import.meta.url)).FlowGraphLengthBlock;case"FlowGraphNormalizeBlock":return async()=>(await X(async()=>{const{FlowGraphNormalizeBlock:e}=await Promise.resolve().then(()=>Hr);return{FlowGraphNormalizeBlock:e}},void 0,import.meta.url)).FlowGraphNormalizeBlock;case"FlowGraphDotBlock":return async()=>(await X(async()=>{const{FlowGraphDotBlock:e}=await Promise.resolve().then(()=>Hr);return{FlowGraphDotBlock:e}},void 0,import.meta.url)).FlowGraphDotBlock;case"FlowGraphCrossBlock":return async()=>(await X(async()=>{const{FlowGraphCrossBlock:e}=await Promise.resolve().then(()=>Hr);return{FlowGraphCrossBlock:e}},void 0,import.meta.url)).FlowGraphCrossBlock;case"FlowGraphRotate2DBlock":return async()=>(await X(async()=>{const{FlowGraphRotate2DBlock:e}=await Promise.resolve().then(()=>Hr);return{FlowGraphRotate2DBlock:e}},void 0,import.meta.url)).FlowGraphRotate2DBlock;case"FlowGraphRotate3DBlock":return async()=>(await X(async()=>{const{FlowGraphRotate3DBlock:e}=await Promise.resolve().then(()=>Hr);return{FlowGraphRotate3DBlock:e}},void 0,import.meta.url)).FlowGraphRotate3DBlock;case"FlowGraphTransposeBlock":return async()=>(await X(async()=>{const{FlowGraphTransposeBlock:e}=await Promise.resolve().then(()=>Vs);return{FlowGraphTransposeBlock:e}},void 0,import.meta.url)).FlowGraphTransposeBlock;case"FlowGraphDeterminantBlock":return async()=>(await X(async()=>{const{FlowGraphDeterminantBlock:e}=await Promise.resolve().then(()=>Vs);return{FlowGraphDeterminantBlock:e}},void 0,import.meta.url)).FlowGraphDeterminantBlock;case"FlowGraphInvertMatrixBlock":return async()=>(await X(async()=>{const{FlowGraphInvertMatrixBlock:e}=await Promise.resolve().then(()=>Vs);return{FlowGraphInvertMatrixBlock:e}},void 0,import.meta.url)).FlowGraphInvertMatrixBlock;case"FlowGraphMatrixMultiplicationBlock":return async()=>(await X(async()=>{const{FlowGraphMatrixMultiplicationBlock:e}=await Promise.resolve().then(()=>Vs);return{FlowGraphMatrixMultiplicationBlock:e}},void 0,import.meta.url)).FlowGraphMatrixMultiplicationBlock;case"FlowGraphBranchBlock":return async()=>(await X(async()=>{const{FlowGraphBranchBlock:e}=await Promise.resolve().then(()=>KD);return{FlowGraphBranchBlock:e}},void 0,import.meta.url)).FlowGraphBranchBlock;case"FlowGraphSetDelayBlock":return async()=>(await X(async()=>{const{FlowGraphSetDelayBlock:e}=await Promise.resolve().then(()=>qD);return{FlowGraphSetDelayBlock:e}},void 0,import.meta.url)).FlowGraphSetDelayBlock;case"FlowGraphCancelDelayBlock":return async()=>(await X(async()=>{const{FlowGraphCancelDelayBlock:e}=await Promise.resolve().then(()=>jD);return{FlowGraphCancelDelayBlock:e}},void 0,import.meta.url)).FlowGraphCancelDelayBlock;case"FlowGraphCallCounterBlock":return async()=>(await X(async()=>{const{FlowGraphCallCounterBlock:e}=await Promise.resolve().then(()=>ZD);return{FlowGraphCallCounterBlock:e}},void 0,import.meta.url)).FlowGraphCallCounterBlock;case"FlowGraphDebounceBlock":return async()=>(await X(async()=>{const{FlowGraphDebounceBlock:e}=await Promise.resolve().then(()=>QD);return{FlowGraphDebounceBlock:e}},void 0,import.meta.url)).FlowGraphDebounceBlock;case"FlowGraphThrottleBlock":return async()=>(await X(async()=>{const{FlowGraphThrottleBlock:e}=await Promise.resolve().then(()=>$D);return{FlowGraphThrottleBlock:e}},void 0,import.meta.url)).FlowGraphThrottleBlock;case"FlowGraphDoNBlock":return async()=>(await X(async()=>{const{FlowGraphDoNBlock:e}=await Promise.resolve().then(()=>JD);return{FlowGraphDoNBlock:e}},void 0,import.meta.url)).FlowGraphDoNBlock;case"FlowGraphFlipFlopBlock":return async()=>(await X(async()=>{const{FlowGraphFlipFlopBlock:e}=await Promise.resolve().then(()=>eL);return{FlowGraphFlipFlopBlock:e}},void 0,import.meta.url)).FlowGraphFlipFlopBlock;case"FlowGraphForLoopBlock":return async()=>(await X(async()=>{const{FlowGraphForLoopBlock:e}=await Promise.resolve().then(()=>tL);return{FlowGraphForLoopBlock:e}},void 0,import.meta.url)).FlowGraphForLoopBlock;case"FlowGraphMultiGateBlock":return async()=>(await X(async()=>{const{FlowGraphMultiGateBlock:e}=await Promise.resolve().then(()=>iL);return{FlowGraphMultiGateBlock:e}},void 0,import.meta.url)).FlowGraphMultiGateBlock;case"FlowGraphSequenceBlock":return async()=>(await X(async()=>{const{FlowGraphSequenceBlock:e}=await Promise.resolve().then(()=>rL);return{FlowGraphSequenceBlock:e}},void 0,import.meta.url)).FlowGraphSequenceBlock;case"FlowGraphSwitchBlock":return async()=>(await X(async()=>{const{FlowGraphSwitchBlock:e}=await Promise.resolve().then(()=>sL);return{FlowGraphSwitchBlock:e}},void 0,import.meta.url)).FlowGraphSwitchBlock;case"FlowGraphWaitAllBlock":return async()=>(await X(async()=>{const{FlowGraphWaitAllBlock:e}=await Promise.resolve().then(()=>nL);return{FlowGraphWaitAllBlock:e}},void 0,import.meta.url)).FlowGraphWaitAllBlock;case"FlowGraphWhileLoopBlock":return async()=>(await X(async()=>{const{FlowGraphWhileLoopBlock:e}=await Promise.resolve().then(()=>aL);return{FlowGraphWhileLoopBlock:e}},void 0,import.meta.url)).FlowGraphWhileLoopBlock;case"FlowGraphConsoleLogBlock":return async()=>(await X(async()=>{const{FlowGraphConsoleLogBlock:e}=await Promise.resolve().then(()=>oL);return{FlowGraphConsoleLogBlock:e}},void 0,import.meta.url)).FlowGraphConsoleLogBlock;case"FlowGraphConditionalBlock":return async()=>(await X(async()=>{const{FlowGraphConditionalDataBlock:e}=await Promise.resolve().then(()=>lL);return{FlowGraphConditionalDataBlock:e}},void 0,import.meta.url)).FlowGraphConditionalDataBlock;case"FlowGraphConstantBlock":return async()=>(await X(async()=>{const{FlowGraphConstantBlock:e}=await Promise.resolve().then(()=>cL);return{FlowGraphConstantBlock:e}},void 0,import.meta.url)).FlowGraphConstantBlock;case"FlowGraphTransformCoordinatesSystemBlock":return async()=>(await X(async()=>{const{FlowGraphTransformCoordinatesSystemBlock:e}=await Promise.resolve().then(()=>hL);return{FlowGraphTransformCoordinatesSystemBlock:e}},void 0,import.meta.url)).FlowGraphTransformCoordinatesSystemBlock;case"FlowGraphGetAssetBlock":return async()=>(await X(async()=>{const{FlowGraphGetAssetBlock:e}=await Promise.resolve().then(()=>fL);return{FlowGraphGetAssetBlock:e}},void 0,import.meta.url)).FlowGraphGetAssetBlock;case"FlowGraphGetPropertyBlock":return async()=>(await X(async()=>{const{FlowGraphGetPropertyBlock:e}=await Promise.resolve().then(()=>uL);return{FlowGraphGetPropertyBlock:e}},void 0,import.meta.url)).FlowGraphGetPropertyBlock;case"FlowGraphSetPropertyBlock":return async()=>(await X(async()=>{const{FlowGraphSetPropertyBlock:e}=await Promise.resolve().then(()=>dL);return{FlowGraphSetPropertyBlock:e}},void 0,import.meta.url)).FlowGraphSetPropertyBlock;case"FlowGraphGetVariableBlock":return async()=>(await X(async()=>{const{FlowGraphGetVariableBlock:e}=await Promise.resolve().then(()=>_L);return{FlowGraphGetVariableBlock:e}},void 0,import.meta.url)).FlowGraphGetVariableBlock;case"FlowGraphSetVariableBlock":return async()=>(await X(async()=>{const{FlowGraphSetVariableBlock:e}=await Promise.resolve().then(()=>pL);return{FlowGraphSetVariableBlock:e}},void 0,import.meta.url)).FlowGraphSetVariableBlock;case"FlowGraphJsonPointerParserBlock":return async()=>(await X(async()=>{const{FlowGraphJsonPointerParserBlock:e}=await Promise.resolve().then(()=>gL);return{FlowGraphJsonPointerParserBlock:e}},void 0,import.meta.url)).FlowGraphJsonPointerParserBlock;case"FlowGraphLeadingZerosBlock":return async()=>(await X(async()=>{const{FlowGraphLeadingZerosBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphLeadingZerosBlock:e}},void 0,import.meta.url)).FlowGraphLeadingZerosBlock;case"FlowGraphTrailingZerosBlock":return async()=>(await X(async()=>{const{FlowGraphTrailingZerosBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphTrailingZerosBlock:e}},void 0,import.meta.url)).FlowGraphTrailingZerosBlock;case"FlowGraphOneBitsCounterBlock":return async()=>(await X(async()=>{const{FlowGraphOneBitsCounterBlock:e}=await Promise.resolve().then(()=>Ve);return{FlowGraphOneBitsCounterBlock:e}},void 0,import.meta.url)).FlowGraphOneBitsCounterBlock;case"FlowGraphCombineVector2Block":return async()=>(await X(async()=>{const{FlowGraphCombineVector2Block:e}=await Promise.resolve().then(()=>zr);return{FlowGraphCombineVector2Block:e}},void 0,import.meta.url)).FlowGraphCombineVector2Block;case"FlowGraphCombineVector3Block":return async()=>(await X(async()=>{const{FlowGraphCombineVector3Block:e}=await Promise.resolve().then(()=>zr);return{FlowGraphCombineVector3Block:e}},void 0,import.meta.url)).FlowGraphCombineVector3Block;case"FlowGraphCombineVector4Block":return async()=>(await X(async()=>{const{FlowGraphCombineVector4Block:e}=await Promise.resolve().then(()=>zr);return{FlowGraphCombineVector4Block:e}},void 0,import.meta.url)).FlowGraphCombineVector4Block;case"FlowGraphCombineMatrixBlock":return async()=>(await X(async()=>{const{FlowGraphCombineMatrixBlock:e}=await Promise.resolve().then(()=>zr);return{FlowGraphCombineMatrixBlock:e}},void 0,import.meta.url)).FlowGraphCombineMatrixBlock;case"FlowGraphExtractVector2Block":return async()=>(await X(async()=>{const{FlowGraphExtractVector2Block:e}=await Promise.resolve().then(()=>zr);return{FlowGraphExtractVector2Block:e}},void 0,import.meta.url)).FlowGraphExtractVector2Block;case"FlowGraphExtractVector3Block":return async()=>(await X(async()=>{const{FlowGraphExtractVector3Block:e}=await Promise.resolve().then(()=>zr);return{FlowGraphExtractVector3Block:e}},void 0,import.meta.url)).FlowGraphExtractVector3Block;case"FlowGraphExtractVector4Block":return async()=>(await X(async()=>{const{FlowGraphExtractVector4Block:e}=await Promise.resolve().then(()=>zr);return{FlowGraphExtractVector4Block:e}},void 0,import.meta.url)).FlowGraphExtractVector4Block;case"FlowGraphExtractMatrixBlock":return async()=>(await X(async()=>{const{FlowGraphExtractMatrixBlock:e}=await Promise.resolve().then(()=>zr);return{FlowGraphExtractMatrixBlock:e}},void 0,import.meta.url)).FlowGraphExtractMatrixBlock;case"FlowGraphTransformVectorBlock":return async()=>(await X(async()=>{const{FlowGraphTransformBlock:e}=await Promise.resolve().then(()=>Hr);return{FlowGraphTransformBlock:e}},void 0,import.meta.url)).FlowGraphTransformBlock;case"FlowGraphTransformCoordinatesBlock":return async()=>(await X(async()=>{const{FlowGraphTransformCoordinatesBlock:e}=await Promise.resolve().then(()=>Hr);return{FlowGraphTransformCoordinatesBlock:e}},void 0,import.meta.url)).FlowGraphTransformCoordinatesBlock;case"FlowGraphMatrixDecompose":return async()=>(await X(async()=>{const{FlowGraphMatrixDecomposeBlock:e}=await Promise.resolve().then(()=>Vs);return{FlowGraphMatrixDecomposeBlock:e}},void 0,import.meta.url)).FlowGraphMatrixDecomposeBlock;case"FlowGraphMatrixCompose":return async()=>(await X(async()=>{const{FlowGraphMatrixComposeBlock:e}=await Promise.resolve().then(()=>Vs);return{FlowGraphMatrixComposeBlock:e}},void 0,import.meta.url)).FlowGraphMatrixComposeBlock;case"FlowGraphBooleanToFloat":return async()=>(await X(async()=>{const{FlowGraphBooleanToFloat:e}=await Promise.resolve().then(()=>Gs);return{FlowGraphBooleanToFloat:e}},void 0,import.meta.url)).FlowGraphBooleanToFloat;case"FlowGraphBooleanToInt":return async()=>(await X(async()=>{const{FlowGraphBooleanToInt:e}=await Promise.resolve().then(()=>Gs);return{FlowGraphBooleanToInt:e}},void 0,import.meta.url)).FlowGraphBooleanToInt;case"FlowGraphFloatToBoolean":return async()=>(await X(async()=>{const{FlowGraphFloatToBoolean:e}=await Promise.resolve().then(()=>Gs);return{FlowGraphFloatToBoolean:e}},void 0,import.meta.url)).FlowGraphFloatToBoolean;case"FlowGraphIntToBoolean":return async()=>(await X(async()=>{const{FlowGraphIntToBoolean:e}=await Promise.resolve().then(()=>Gs);return{FlowGraphIntToBoolean:e}},void 0,import.meta.url)).FlowGraphIntToBoolean;case"FlowGraphIntToFloat":return async()=>(await X(async()=>{const{FlowGraphIntToFloat:e}=await Promise.resolve().then(()=>Gs);return{FlowGraphIntToFloat:e}},void 0,import.meta.url)).FlowGraphIntToFloat;case"FlowGraphFloatToInt":return async()=>(await X(async()=>{const{FlowGraphFloatToInt:e}=await Promise.resolve().then(()=>Gs);return{FlowGraphFloatToInt:e}},void 0,import.meta.url)).FlowGraphFloatToInt;case"FlowGraphEasingBlock":return async()=>(await X(async()=>{const{FlowGraphEasingBlock:e}=await Promise.resolve().then(()=>vL);return{FlowGraphEasingBlock:e}},void 0,import.meta.url)).FlowGraphEasingBlock;case"FlowGraphBezierCurveEasing":return async()=>(await X(async()=>{const{FlowGraphBezierCurveEasingBlock:e}=await Promise.resolve().then(()=>TL);return{FlowGraphBezierCurveEasingBlock:e}},void 0,import.meta.url)).FlowGraphBezierCurveEasingBlock;case"FlowGraphPointerOverEventBlock":return async()=>(await X(async()=>{const{FlowGraphPointerOverEventBlock:e}=await Promise.resolve().then(()=>SL);return{FlowGraphPointerOverEventBlock:e}},void 0,import.meta.url)).FlowGraphPointerOverEventBlock;case"FlowGraphPointerOutEventBlock":return async()=>(await X(async()=>{const{FlowGraphPointerOutEventBlock:e}=await Promise.resolve().then(()=>AL);return{FlowGraphPointerOutEventBlock:e}},void 0,import.meta.url)).FlowGraphPointerOutEventBlock;case"FlowGraphContextBlock":return async()=>(await X(async()=>{const{FlowGraphContextBlock:e}=await Promise.resolve().then(()=>RL);return{FlowGraphContextBlock:e}},void 0,import.meta.url)).FlowGraphContextBlock;case"FlowGraphArrayIndexBlock":return async()=>(await X(async()=>{const{FlowGraphArrayIndexBlock:e}=await Promise.resolve().then(()=>CL);return{FlowGraphArrayIndexBlock:e}},void 0,import.meta.url)).FlowGraphArrayIndexBlock;case"FlowGraphCodeExecutionBlock":return async()=>(await X(async()=>{const{FlowGraphCodeExecutionBlock:e}=await Promise.resolve().then(()=>bL);return{FlowGraphCodeExecutionBlock:e}},void 0,import.meta.url)).FlowGraphCodeExecutionBlock;case"FlowGraphIndexOfBlock":return async()=>(await X(async()=>{const{FlowGraphIndexOfBlock:e}=await Promise.resolve().then(()=>xL);return{FlowGraphIndexOfBlock:e}},void 0,import.meta.url)).FlowGraphIndexOfBlock;case"FlowGraphFunctionReference":return async()=>(await X(async()=>{const{FlowGraphFunctionReferenceBlock:e}=await Promise.resolve().then(()=>yL);return{FlowGraphFunctionReferenceBlock:e}},void 0,import.meta.url)).FlowGraphFunctionReferenceBlock;case"FlowGraphDataSwitchBlock":return async()=>(await X(async()=>{const{FlowGraphDataSwitchBlock:e}=await Promise.resolve().then(()=>ML);return{FlowGraphDataSwitchBlock:e}},void 0,import.meta.url)).FlowGraphDataSwitchBlock;default:if(vl[a])return vl[a];throw new Error(`Unknown block name ${a}`)}}class Di extends kr{constructor(e){super(e),this.out=this._registerSignalOutput("out")}}class Eo extends Di{constructor(e,t){super(e),this._eventsSignalOutputs={},this.done=this._registerSignalOutput("done"),t==null||t.forEach(i=>{this._eventsSignalOutputs[i]=this._registerSignalOutput(i+"Event")})}_executeOnTick(e){}_startPendingTasks(e){e._getExecutionVariable(this,"_initialized",!1)&&(this._cancelPendingTasks(e),this._resetAfterCanceled(e)),this._preparePendingTasks(e),e._addPendingBlock(this),this.out._activateSignal(e),e._setExecutionVariable(this,"_initialized",!0)}_resetAfterCanceled(e){e._deleteExecutionVariable(this,"_initialized"),e._removePendingBlock(this)}}class Ms extends Eo{constructor(){super(...arguments),this.initPriority=0,this.type="NoTrigger"}_execute(e){e._notifyExecuteNode(this),this.done._activateSignal(e)}}function Db(a,e){for(const t of a)for(const i of t.dataOutputs)if(i.uniqueId===e)return i;throw new Error("Could not find data out connection with unique id "+e)}function Lb(a,e){for(const t of a)if(t instanceof kr){for(const i of t.signalInputs)if(i.uniqueId===e)return i}throw new Error("Could not find signal in connection with unique id "+e)}async function BL(a,e){const t=await Promise.all(a.allBlocks.map(async i=>Ob(i.className)()));return Nb(a,e,t)}function Nb(a,e,t){const i=e.coordinator.createGraph(),r=[],s=e.valueParseFunction??go;for(let n=0;n<a.allBlocks.length;n++){const o=a.allBlocks[n],l=wb(o,{scene:e.coordinator.config.scene,pathConverter:e.pathConverter,assetsContainer:e.coordinator.config.scene,valueParseFunction:s},t[n]);r.push(l),l instanceof Ms&&i.addEventBlock(l)}for(const n of r){for(const o of n.dataInputs)for(const l of o.connectedPointIds){const c=Db(r,l);o.connectTo(c)}if(n instanceof kr)for(const o of n.signalOutputs)for(const l of o.connectedPointIds){const c=Lb(r,l);o.connectTo(c)}}for(const n of a.executionContexts)Fb(n,{graph:i,valueParseFunction:s},a.rightHanded);return i}function Fb(a,e,t){var n,o,l,c,h,f,u,d,_,p;const i=e.graph.createContext();a.enableLogging&&(i.enableLogging=!0),i.treatDataAsRightHanded=t||!1;const r=e.valueParseFunction??go;i.uniqueId=a.uniqueId;const s=i.getScene();if(a._assetsContext){const g=a._assetsContext,E={meshes:(n=g.meshes)==null?void 0:n.map(v=>s.getMeshById(v)),lights:(o=g.lights)==null?void 0:o.map(v=>s.getLightByName(v)),cameras:(l=g.cameras)==null?void 0:l.map(v=>s.getCameraByName(v)),materials:(c=g.materials)==null?void 0:c.map(v=>s.getMaterialById(v)),textures:(h=g.textures)==null?void 0:h.map(v=>s.getTextureByName(v)),animations:(f=g.animations)==null?void 0:f.map(v=>s.animations.find(b=>b.name===v)),skeletons:(u=g.skeletons)==null?void 0:u.map(v=>s.getSkeletonByName(v)),particleSystems:(d=g.particleSystems)==null?void 0:d.map(v=>s.getParticleSystemById(v)),animationGroups:(_=g.animationGroups)==null?void 0:_.map(v=>s.getAnimationGroupByName(v)),transformNodes:(p=g.transformNodes)==null?void 0:p.map(v=>s.getTransformNodeById(v)),rootNodes:[],multiMaterials:[],morphTargetManagers:[],geometries:[],actionManagers:[],environmentTexture:null,postProcesses:[],sounds:null,effectLayers:[],layers:[],reflectionProbes:[],lensFlareSystems:[],proceduralTextures:[],getNodes:function(){throw new Error("Function not implemented.")}};i.assetsContext=E}for(const g in a._userVariables){const E=r(g,a._userVariables,i.assetsContext,s);i.userVariables[g]=E}for(const g in a._connectionValues){const E=r(g,a._connectionValues,i.assetsContext,s);i._setConnectionValueByKey(g,E)}return i}function wb(a,e,t){const i={},r=e.valueParseFunction??go;if(a.config)for(const n in a.config)i[n]=r(n,a.config,e.assetsContainer||e.scene,e.scene);if(xb(a.className)){if(!e.pathConverter)throw new Error("Path converter is required for this block");i.pathConverter=e.pathConverter}const s=new t(i);s.uniqueId=a.uniqueId;for(let n=0;n<a.dataInputs.length;n++){const o=s.getDataInput(a.dataInputs[n].name);if(o)o.deserialize(a.dataInputs[n]);else throw new Error("Could not find data input with name "+a.dataInputs[n].name+" in block "+a.className)}for(let n=0;n<a.dataOutputs.length;n++){const o=s.getDataOutput(a.dataOutputs[n].name);if(o)o.deserialize(a.dataOutputs[n]);else throw new Error("Could not find data output with name "+a.dataOutputs[n].name+" in block "+a.className)}return s.metadata=a.metadata,s.deserialize&&s.deserialize(a),s}function $g(a){let e=a.pathArray;const t=a.closeArray||!1,i=a.closePath||!1,r=a.invertUV||!1,s=Math.floor(e[0].length/2);let n=a.offset||s;n=n>s?s:Math.floor(n);const o=a.sideOrientation===0?0:a.sideOrientation||ee.DEFAULTSIDE,l=a.uvs,c=a.colors,h=[],f=[],u=[],d=[],_=[],p=[],g=[],E=[];let v;const b=[],R=[];let S,T,I;if(e.length<2){const xe=[],Ye=[];for(T=0;T<e[0].length-n;T++)xe.push(e[0][T]),Ye.push(e[0][T+n]);e=[xe,Ye]}let O=0;const L=i?1:0,w=t?1:0;let $,J;v=e[0].length;let ce,le;for(S=0;S<e.length+w;S++){for(g[S]=0,_[S]=[0],$=S===e.length?e[0]:e[S],J=$.length,v=v<J?v:J,I=0;I<J;)h.push($[I].x,$[I].y,$[I].z),I>0&&(ce=$[I].subtract($[I-1]).length(),le=ce+g[S],_[S].push(le),g[S]=le),I++;i&&(I--,h.push($[0].x,$[0].y,$[0].z),ce=$[I].subtract($[0]).length(),le=ce+g[S],_[S].push(le),g[S]=le),b[S]=J+L,R[S]=O,O+=J+L}let oe,ue,Pe=null,Se=null;for(T=0;T<v+L;T++)for(E[T]=0,p[T]=[0],S=0;S<e.length-1+w;S++)oe=e[S],ue=S===e.length-1?e[0]:e[S+1],T===v?(Pe=oe[0],Se=ue[0]):(Pe=oe[T],Se=ue[T]),ce=Se.subtract(Pe).length(),le=ce+E[T],p[T].push(le),E[T]=le;let ie,K;if(l)for(S=0;S<l.length;S++)d.push(l[S].x,l[S].y);else for(S=0;S<e.length+w;S++)for(T=0;T<v+L;T++)ie=g[S]!=0?_[S][T]/g[S]:0,K=E[T]!=0?p[T][S]/E[T]:0,r?d.push(K,ie):d.push(ie,K);S=0;let M=0,V=b[S]-1,re=b[S+1]-1,ve=V<re?V:re,Be=R[1]-R[0];const fe=b.length-1;for(;M<=ve&&S<fe;)f.push(M,M+Be,M+1),f.push(M+Be+1,M+1,M+Be),M+=1,M===ve&&(S++,Be=R[S+1]-R[S],V=b[S]-1,re=b[S+1]-1,M=R[S],ve=V<re?V+M:re+M);if(ee.ComputeNormals(h,f,u),i){let xe=0,Ye=0;for(S=0;S<e.length;S++){xe=R[S]*3,S+1<e.length?Ye=(R[S+1]-1)*3:Ye=u.length-3,u[xe]=(u[xe]+u[Ye])*.5,u[xe+1]=(u[xe+1]+u[Ye+1])*.5,u[xe+2]=(u[xe+2]+u[Ye+2])*.5;const Me=Math.sqrt(u[xe]*u[xe]+u[xe+1]*u[xe+1]+u[xe+2]*u[xe+2]);u[xe]/=Me,u[xe+1]/=Me,u[xe+2]/=Me,u[Ye]=u[xe],u[Ye+1]=u[xe+1],u[Ye+2]=u[xe+2]}}if(t){let xe=R[0]*3,Ye=R[e.length]*3;for(T=0;T<v+L;T++){u[xe]=(u[xe]+u[Ye])*.5,u[xe+1]=(u[xe+1]+u[Ye+1])*.5,u[xe+2]=(u[xe+2]+u[Ye+2])*.5;const Me=Math.sqrt(u[xe]*u[xe]+u[xe+1]*u[xe+1]+u[xe+2]*u[xe+2]);u[xe]/=Me,u[xe+1]/=Me,u[xe+2]/=Me,u[Ye]=u[xe],u[Ye+1]=u[xe+1],u[Ye+2]=u[xe+2],xe+=3,Ye+=3}}ee._ComputeSides(o,h,f,u,d,a.frontUVs,a.backUVs);let me=null;if(c){me=new Float32Array(c.length*4);for(let xe=0;xe<c.length;xe++)me[xe*4]=c[xe].r,me[xe*4+1]=c[xe].g,me[xe*4+2]=c[xe].b,me[xe*4+3]=c[xe].a}const Oe=new ee,Ee=new Float32Array(h),Ue=new Float32Array(u),vt=new Float32Array(d);return Oe.indices=f,Oe.positions=Ee,Oe.normals=Ue,Oe.uvs=vt,me&&Oe.set(me,x.ColorKind),i&&(Oe._idx=R),Oe}function Is(a,e,t=null){const i=e.pathArray,r=e.closeArray,s=e.closePath,n=N._GetDefaultSideOrientation(e.sideOrientation),o=e.instance,l=e.updatable;if(o){const c=F.Vector3[0].setAll(Number.MAX_VALUE),h=F.Vector3[1].setAll(-Number.MAX_VALUE),f=d=>{let _=i[0].length;const p=o;let g=0;const E=p._originalBuilderSideOrientation===N.DOUBLESIDE?2:1;for(let v=1;v<=E;++v)for(let b=0;b<i.length;++b){const R=i[b],S=R.length;_=_<S?_:S;for(let T=0;T<_;++T){const I=R[T];d[g]=I.x,d[g+1]=I.y,d[g+2]=I.z,c.minimizeInPlaceFromFloats(I.x,I.y,I.z),h.maximizeInPlaceFromFloats(I.x,I.y,I.z),g+=3}if(p._creationDataStorage&&p._creationDataStorage.closePath){const T=R[0];d[g]=T.x,d[g+1]=T.y,d[g+2]=T.z,g+=3}}},u=o.getVerticesData(x.PositionKind);if(f(u),o.hasBoundingInfo?o.getBoundingInfo().reConstruct(c,h,o._worldMatrix):o.buildBoundingInfo(c,h,o._worldMatrix),o.updateVerticesData(x.PositionKind,u,!1,!1),e.colors){const d=o.getVerticesData(x.ColorKind);for(let _=0,p=0;_<e.colors.length;_++,p+=4){const g=e.colors[_];d[p]=g.r,d[p+1]=g.g,d[p+2]=g.b,d[p+3]=g.a}o.updateVerticesData(x.ColorKind,d,!1,!1)}if(e.uvs){const d=o.getVerticesData(x.UVKind);for(let _=0;_<e.uvs.length;_++)d[_*2]=e.uvs[_].x,d[_*2+1]=e.uvs[_].y;o.updateVerticesData(x.UVKind,d,!1,!1)}if(!o.areNormalsFrozen||o.isFacetDataEnabled){const d=o.getIndices(),_=o.getVerticesData(x.NormalKind),p=o.isFacetDataEnabled?o.getFacetDataParameters():null;if(ee.ComputeNormals(u,d,_,p),o._creationDataStorage&&o._creationDataStorage.closePath){let g=0,E=0;for(let v=0;v<i.length;v++)g=o._creationDataStorage.idx[v]*3,v+1<i.length?E=(o._creationDataStorage.idx[v+1]-1)*3:E=_.length-3,_[g]=(_[g]+_[E])*.5,_[g+1]=(_[g+1]+_[E+1])*.5,_[g+2]=(_[g+2]+_[E+2])*.5,_[E]=_[g],_[E+1]=_[g+1],_[E+2]=_[g+2]}o.areNormalsFrozen||o.updateVerticesData(x.NormalKind,_,!1,!1)}return o}else{const c=new N(a,t);c._originalBuilderSideOrientation=n,c._creationDataStorage=new qm;const h=$g(e);return s&&(c._creationDataStorage.idx=h._idx),c._creationDataStorage.closePath=s,c._creationDataStorage.closeArray=r,h.applyToMesh(c,l),c}}ee.CreateRibbon=$g;N.CreateRibbon=(a,e,t=!1,i,r,s,n=!1,o,l)=>Is(a,{pathArray:e,closeArray:t,closePath:i,offset:r,updatable:n,sideOrientation:o,instance:l},s);function Jg(a){const e=[],t=[],i=[],r=[],s=a.radius||.5,n=a.tessellation||64,o=a.arc&&(a.arc<=0||a.arc>1)?1:a.arc||1,l=a.sideOrientation===0?0:a.sideOrientation||ee.DEFAULTSIDE;e.push(0,0,0),r.push(.5,.5);const c=Math.PI*2*o,h=o===1?c/n:c/(n-1);let f=0;for(let _=0;_<n;_++){const p=Math.cos(f),g=Math.sin(f),E=(p+1)/2,v=(1-g)/2;e.push(s*p,s*g,0),r.push(E,v),f+=h}o===1&&(e.push(e[3],e[4],e[5]),r.push(r[2],r[3]));const u=e.length/3;for(let _=1;_<u-1;_++)t.push(_+1,0,_);ee.ComputeNormals(e,t,i),ee._ComputeSides(l,e,t,i,r,a.frontUVs,a.backUVs);const d=new ee;return d.indices=t,d.positions=e,d.normals=i,d.uvs=r,d}function eE(a,e={},t=null){const i=new N(a,t);return e.sideOrientation=N._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,Jg(e).applyToMesh(i,e.updatable),i}ee.CreateDisc=Jg;N.CreateDisc=(a,e,t,i=null,r,s)=>eE(a,{radius:e,tessellation:t,sideOrientation:s,updatable:r},i);function vn(a){const e=a.pattern||N.NO_FLIP,t=a.tileWidth||a.tileSize||1,i=a.tileHeight||a.tileSize||1,r=a.alignHorizontal||0,s=a.alignVertical||0,n=a.width||a.size||1,o=Math.floor(n/t);let l=n-o*t;const c=a.height||a.size||1,h=Math.floor(c/i);let f=c-h*i;const u=t*o/2,d=i*h/2;let _=0,p=0,g=0,E=0,v=0,b=0;if(l>0||f>0){switch(g=-u,E=-d,v=u,b=d,r){case N.CENTER:l/=2,g-=l,v+=l;break;case N.LEFT:v+=l,_=-l/2;break;case N.RIGHT:g-=l,_=l/2;break}switch(s){case N.CENTER:f/=2,E-=f,b+=f;break;case N.BOTTOM:b+=f,p=-f/2;break;case N.TOP:E-=f,p=f/2;break}}const R=[],S=[],T=[];T[0]=[0,0,1,0,1,1,0,1],T[1]=[0,0,1,0,1,1,0,1],(e===N.ROTATE_TILE||e===N.ROTATE_ROW)&&(T[1]=[1,1,0,1,0,0,1,0]),(e===N.FLIP_TILE||e===N.FLIP_ROW)&&(T[1]=[1,0,0,0,0,1,1,1]),(e===N.FLIP_N_ROTATE_TILE||e===N.FLIP_N_ROTATE_ROW)&&(T[1]=[0,1,1,1,1,0,0,0]);let I=[];const O=[],L=[];let w=0;for(let le=0;le<h;le++)for(let oe=0;oe<o;oe++)R.push(-u+oe*t+_,-d+le*i+p,0),R.push(-u+(oe+1)*t+_,-d+le*i+p,0),R.push(-u+(oe+1)*t+_,-d+(le+1)*i+p,0),R.push(-u+oe*t+_,-d+(le+1)*i+p,0),L.push(w,w+1,w+3,w+1,w+2,w+3),e===N.FLIP_TILE||e===N.ROTATE_TILE||e===N.FLIP_N_ROTATE_TILE?I=I.concat(T[(oe%2+le%2)%2]):e===N.FLIP_ROW||e===N.ROTATE_ROW||e===N.FLIP_N_ROTATE_ROW?I=I.concat(T[le%2]):I=I.concat(T[0]),O.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),S.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1),w+=4;if(l>0||f>0){const le=f>0&&(s===N.CENTER||s===N.TOP),oe=f>0&&(s===N.CENTER||s===N.BOTTOM),ue=l>0&&(r===N.CENTER||r===N.RIGHT),Pe=l>0&&(r===N.CENTER||r===N.LEFT);let Se=[],ie,K,M,V;if(le&&ue&&(R.push(g+_,E+p,0),R.push(-u+_,E+p,0),R.push(-u+_,E+f+p,0),R.push(g+_,E+f+p,0),L.push(w,w+1,w+3,w+1,w+2,w+3),w+=4,ie=1-l/t,K=1-f/i,M=1,V=1,Se=[ie,K,M,K,M,V,ie,V],e===N.ROTATE_ROW&&(Se=[1-ie,1-K,1-M,1-K,1-M,1-V,1-ie,1-V]),e===N.FLIP_ROW&&(Se=[1-ie,K,1-M,K,1-M,V,1-ie,V]),e===N.FLIP_N_ROTATE_ROW&&(Se=[ie,1-K,M,1-K,M,1-V,ie,1-V]),I=I.concat(Se),O.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),S.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),le&&Pe&&(R.push(u+_,E+p,0),R.push(v+_,E+p,0),R.push(v+_,E+f+p,0),R.push(u+_,E+f+p,0),L.push(w,w+1,w+3,w+1,w+2,w+3),w+=4,ie=0,K=1-f/i,M=l/t,V=1,Se=[ie,K,M,K,M,V,ie,V],(e===N.ROTATE_ROW||e===N.ROTATE_TILE&&o%2===0)&&(Se=[1-ie,1-K,1-M,1-K,1-M,1-V,1-ie,1-V]),(e===N.FLIP_ROW||e===N.FLIP_TILE&&o%2===0)&&(Se=[1-ie,K,1-M,K,1-M,V,1-ie,V]),(e===N.FLIP_N_ROTATE_ROW||e===N.FLIP_N_ROTATE_TILE&&o%2===0)&&(Se=[ie,1-K,M,1-K,M,1-V,ie,1-V]),I=I.concat(Se),O.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),S.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),oe&&ue&&(R.push(g+_,d+p,0),R.push(-u+_,d+p,0),R.push(-u+_,b+p,0),R.push(g+_,b+p,0),L.push(w,w+1,w+3,w+1,w+2,w+3),w+=4,ie=1-l/t,K=0,M=1,V=f/i,Se=[ie,K,M,K,M,V,ie,V],(e===N.ROTATE_ROW&&h%2===1||e===N.ROTATE_TILE&&h%1===0)&&(Se=[1-ie,1-K,1-M,1-K,1-M,1-V,1-ie,1-V]),(e===N.FLIP_ROW&&h%2===1||e===N.FLIP_TILE&&h%2===0)&&(Se=[1-ie,K,1-M,K,1-M,V,1-ie,V]),(e===N.FLIP_N_ROTATE_ROW&&h%2===1||e===N.FLIP_N_ROTATE_TILE&&h%2===0)&&(Se=[ie,1-K,M,1-K,M,1-V,ie,1-V]),I=I.concat(Se),O.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),S.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),oe&&Pe&&(R.push(u+_,d+p,0),R.push(v+_,d+p,0),R.push(v+_,b+p,0),R.push(u+_,b+p,0),L.push(w,w+1,w+3,w+1,w+2,w+3),w+=4,ie=0,K=0,M=l/t,V=f/i,Se=[ie,K,M,K,M,V,ie,V],(e===N.ROTATE_ROW&&h%2===1||e===N.ROTATE_TILE&&(h+o)%2===1)&&(Se=[1-ie,1-K,1-M,1-K,1-M,1-V,1-ie,1-V]),(e===N.FLIP_ROW&&h%2===1||e===N.FLIP_TILE&&(h+o)%2===1)&&(Se=[1-ie,K,1-M,K,1-M,V,1-ie,V]),(e===N.FLIP_N_ROTATE_ROW&&h%2===1||e===N.FLIP_N_ROTATE_TILE&&(h+o)%2===1)&&(Se=[ie,1-K,M,1-K,M,1-V,ie,1-V]),I=I.concat(Se),O.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),S.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),le){const re=[];ie=0,K=1-f/i,M=1,V=1,re[0]=[ie,K,M,K,M,V,ie,V],re[1]=[ie,K,M,K,M,V,ie,V],(e===N.ROTATE_TILE||e===N.ROTATE_ROW)&&(re[1]=[1-ie,1-K,1-M,1-K,1-M,1-V,1-ie,1-V]),(e===N.FLIP_TILE||e===N.FLIP_ROW)&&(re[1]=[1-ie,K,1-M,K,1-M,V,1-ie,V]),(e===N.FLIP_N_ROTATE_TILE||e===N.FLIP_N_ROTATE_ROW)&&(re[1]=[ie,1-K,M,1-K,M,1-V,ie,1-V]);for(let ve=0;ve<o;ve++)R.push(-u+ve*t+_,E+p,0),R.push(-u+(ve+1)*t+_,E+p,0),R.push(-u+(ve+1)*t+_,E+f+p,0),R.push(-u+ve*t+_,E+f+p,0),L.push(w,w+1,w+3,w+1,w+2,w+3),w+=4,e===N.FLIP_TILE||e===N.ROTATE_TILE||e===N.FLIP_N_ROTATE_TILE?I=I.concat(re[(ve+1)%2]):e===N.FLIP_ROW||e===N.ROTATE_ROW||e===N.FLIP_N_ROTATE_ROW?I=I.concat(re[1]):I=I.concat(re[0]),O.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),S.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(oe){const re=[];ie=0,K=0,M=1,V=f/i,re[0]=[ie,K,M,K,M,V,ie,V],re[1]=[ie,K,M,K,M,V,ie,V],(e===N.ROTATE_TILE||e===N.ROTATE_ROW)&&(re[1]=[1-ie,1-K,1-M,1-K,1-M,1-V,1-ie,1-V]),(e===N.FLIP_TILE||e===N.FLIP_ROW)&&(re[1]=[1-ie,K,1-M,K,1-M,V,1-ie,V]),(e===N.FLIP_N_ROTATE_TILE||e===N.FLIP_N_ROTATE_ROW)&&(re[1]=[ie,1-K,M,1-K,M,1-V,ie,1-V]);for(let ve=0;ve<o;ve++)R.push(-u+ve*t+_,b-f+p,0),R.push(-u+(ve+1)*t+_,b-f+p,0),R.push(-u+(ve+1)*t+_,b+p,0),R.push(-u+ve*t+_,b+p,0),L.push(w,w+1,w+3,w+1,w+2,w+3),w+=4,e===N.FLIP_TILE||e===N.ROTATE_TILE||e===N.FLIP_N_ROTATE_TILE?I=I.concat(re[(ve+h)%2]):e===N.FLIP_ROW||e===N.ROTATE_ROW||e===N.FLIP_N_ROTATE_ROW?I=I.concat(re[h%2]):I=I.concat(re[0]),O.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),S.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(ue){const re=[];ie=1-l/t,K=0,M=1,V=1,re[0]=[ie,K,M,K,M,V,ie,V],re[1]=[ie,K,M,K,M,V,ie,V],(e===N.ROTATE_TILE||e===N.ROTATE_ROW)&&(re[1]=[1-ie,1-K,1-M,1-K,1-M,1-V,1-ie,1-V]),(e===N.FLIP_TILE||e===N.FLIP_ROW)&&(re[1]=[1-ie,K,1-M,K,1-M,V,1-ie,V]),(e===N.FLIP_N_ROTATE_TILE||e===N.FLIP_N_ROTATE_ROW)&&(re[1]=[ie,1-K,M,1-K,M,1-V,ie,1-V]);for(let ve=0;ve<h;ve++)R.push(g+_,-d+ve*i+p,0),R.push(g+l+_,-d+ve*i+p,0),R.push(g+l+_,-d+(ve+1)*i+p,0),R.push(g+_,-d+(ve+1)*i+p,0),L.push(w,w+1,w+3,w+1,w+2,w+3),w+=4,e===N.FLIP_TILE||e===N.ROTATE_TILE||e===N.FLIP_N_ROTATE_TILE?I=I.concat(re[(ve+1)%2]):e===N.FLIP_ROW||e===N.ROTATE_ROW||e===N.FLIP_N_ROTATE_ROW?I=I.concat(re[ve%2]):I=I.concat(re[0]),O.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),S.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(Pe){const re=[];ie=0,K=0,M=l/i,V=1,re[0]=[ie,K,M,K,M,V,ie,V],re[1]=[ie,K,M,K,M,V,ie,V],(e===N.ROTATE_TILE||e===N.ROTATE_ROW)&&(re[1]=[1-ie,1-K,1-M,1-K,1-M,1-V,1-ie,1-V]),(e===N.FLIP_TILE||e===N.FLIP_ROW)&&(re[1]=[1-ie,K,1-M,K,1-M,V,1-ie,V]),(e===N.FLIP_N_ROTATE_TILE||e===N.FLIP_N_ROTATE_ROW)&&(re[1]=[ie,1-K,M,1-K,M,1-V,ie,1-V]);for(let ve=0;ve<h;ve++)R.push(v-l+_,-d+ve*i+p,0),R.push(v+_,-d+ve*i+p,0),R.push(v+_,-d+(ve+1)*i+p,0),R.push(v-l+_,-d+(ve+1)*i+p,0),L.push(w,w+1,w+3,w+1,w+2,w+3),w+=4,e===N.FLIP_TILE||e===N.ROTATE_TILE||e===N.FLIP_N_ROTATE_TILE?I=I.concat(re[(ve+o)%2]):e===N.FLIP_ROW||e===N.ROTATE_ROW||e===N.FLIP_N_ROTATE_ROW?I=I.concat(re[ve%2]):I=I.concat(re[0]),O.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),S.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}}const $=a.sideOrientation===0?0:a.sideOrientation||ee.DEFAULTSIDE;ee._ComputeSides($,R,L,S,I,a.frontUVs,a.backUVs);const J=new ee;J.indices=L,J.positions=R,J.normals=S,J.uvs=I;const ce=$===ee.DOUBLESIDE?O.concat(O):O;return J.colors=ce,J}function Bb(a,e,t=null){const i=new N(a,t);return e.sideOrientation=N._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,vn(e).applyToMesh(i,e.updatable),i}ee.CreateTiledPlane=vn;function tE(a){const t=a.faceUV||new Array(6),i=a.faceColors,r=a.pattern||N.NO_FLIP,s=a.width||a.size||1,n=a.height||a.size||1,o=a.depth||a.size||1,l=a.tileWidth||a.tileSize||1,c=a.tileHeight||a.tileSize||1,h=a.alignHorizontal||0,f=a.alignVertical||0,u=a.sideOrientation===0?0:a.sideOrientation||ee.DEFAULTSIDE;for(let M=0;M<6;M++)t[M]===void 0&&(t[M]=new Fe(0,0,1,1)),i&&i[M]===void 0&&(i[M]=new Ne(1,1,1,1));const d=s/2,_=n/2,p=o/2,g=[];for(let M=0;M<2;M++)g[M]=vn({pattern:r,tileWidth:l,tileHeight:c,width:s,height:n,alignVertical:f,alignHorizontal:h,sideOrientation:u});for(let M=2;M<4;M++)g[M]=vn({pattern:r,tileWidth:l,tileHeight:c,width:o,height:n,alignVertical:f,alignHorizontal:h,sideOrientation:u});let E=f;f===N.BOTTOM?E=N.TOP:f===N.TOP&&(E=N.BOTTOM);for(let M=4;M<6;M++)g[M]=vn({pattern:r,tileWidth:l,tileHeight:c,width:s,height:o,alignVertical:E,alignHorizontal:h,sideOrientation:u});let v=[],b=[],R=[],S=[];const T=[],I=[],O=[],L=[];let w=0,$=0;for(let M=0;M<6;M++){const V=g[M].positions.length;I[M]=[],O[M]=[];for(let re=0;re<V/3;re++)I[M].push(new m(g[M].positions[3*re],g[M].positions[3*re+1],g[M].positions[3*re+2])),O[M].push(new m(g[M].normals[3*re],g[M].normals[3*re+1],g[M].normals[3*re+2]));w=g[M].uvs.length,L[M]=[];for(let re=0;re<w;re+=2)L[M][re]=t[M].x+(t[M].z-t[M].x)*g[M].uvs[re],L[M][re+1]=t[M].y+(t[M].w-t[M].y)*g[M].uvs[re+1];if(R=R.concat(L[M]),S=S.concat(g[M].indices.map(re=>re+$)),$+=I[M].length,i)for(let re=0;re<4;re++)T.push(i[M].r,i[M].g,i[M].b,i[M].a)}const J=new m(0,0,p),ce=P.RotationY(Math.PI);v=I[0].map(M=>m.TransformNormal(M,ce).add(J)).map(M=>[M.x,M.y,M.z]).reduce((M,V)=>M.concat(V),[]),b=O[0].map(M=>m.TransformNormal(M,ce)).map(M=>[M.x,M.y,M.z]).reduce((M,V)=>M.concat(V),[]),v=v.concat(I[1].map(M=>M.subtract(J)).map(M=>[M.x,M.y,M.z]).reduce((M,V)=>M.concat(V),[])),b=b.concat(O[1].map(M=>[M.x,M.y,M.z]).reduce((M,V)=>M.concat(V),[]));const le=new m(d,0,0),oe=P.RotationY(-Math.PI/2);v=v.concat(I[2].map(M=>m.TransformNormal(M,oe).add(le)).map(M=>[M.x,M.y,M.z]).reduce((M,V)=>M.concat(V),[])),b=b.concat(O[2].map(M=>m.TransformNormal(M,oe)).map(M=>[M.x,M.y,M.z]).reduce((M,V)=>M.concat(V),[]));const ue=P.RotationY(Math.PI/2);v=v.concat(I[3].map(M=>m.TransformNormal(M,ue).subtract(le)).map(M=>[M.x,M.y,M.z]).reduce((M,V)=>M.concat(V),[])),b=b.concat(O[3].map(M=>m.TransformNormal(M,ue)).map(M=>[M.x,M.y,M.z]).reduce((M,V)=>M.concat(V),[]));const Pe=new m(0,_,0),Se=P.RotationX(Math.PI/2);v=v.concat(I[4].map(M=>m.TransformNormal(M,Se).add(Pe)).map(M=>[M.x,M.y,M.z]).reduce((M,V)=>M.concat(V),[])),b=b.concat(O[4].map(M=>m.TransformNormal(M,Se)).map(M=>[M.x,M.y,M.z]).reduce((M,V)=>M.concat(V),[]));const ie=P.RotationX(-Math.PI/2);v=v.concat(I[5].map(M=>m.TransformNormal(M,ie).subtract(Pe)).map(M=>[M.x,M.y,M.z]).reduce((M,V)=>M.concat(V),[])),b=b.concat(O[5].map(M=>m.TransformNormal(M,ie)).map(M=>[M.x,M.y,M.z]).reduce((M,V)=>M.concat(V),[])),ee._ComputeSides(u,v,S,b,R);const K=new ee;if(K.indices=S,K.positions=v,K.normals=b,K.uvs=R,i){const M=u===ee.DOUBLESIDE?T.concat(T):T;K.colors=M}return K}function Ub(a,e,t=null){const i=new N(a,t);return e.sideOrientation=N._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,tE(e).applyToMesh(i,e.updatable),i}ee.CreateTiledBox=tE;function iE(a){const e=[],t=[],i=[],r=[],s=a.radius||2,n=a.tube||.5,o=a.radialSegments||32,l=a.tubularSegments||32,c=a.p||2,h=a.q||3,f=a.sideOrientation===0?0:a.sideOrientation||ee.DEFAULTSIDE,u=g=>{const E=Math.cos(g),v=Math.sin(g),b=h/c*g,R=Math.cos(b),S=s*(2+R)*.5*E,T=s*(2+R)*v*.5,I=s*Math.sin(b)*.5;return new m(S,T,I)};let d,_;for(d=0;d<=o;d++){const E=d%o/o*2*c*Math.PI,v=u(E),b=u(E+.01),R=b.subtract(v);let S=b.add(v);const T=m.Cross(R,S);for(S=m.Cross(T,R),T.normalize(),S.normalize(),_=0;_<l;_++){const O=_%l/l*2*Math.PI,L=-n*Math.cos(O),w=n*Math.sin(O);t.push(v.x+L*S.x+w*T.x),t.push(v.y+L*S.y+w*T.y),t.push(v.z+L*S.z+w*T.z),r.push(d/o),r.push(_/l)}}for(d=0;d<o;d++)for(_=0;_<l;_++){const g=(_+1)%l,E=d*l+_,v=(d+1)*l+_,b=(d+1)*l+g,R=d*l+g;e.push(R),e.push(v),e.push(E),e.push(R),e.push(b),e.push(v)}ee.ComputeNormals(t,e,i),ee._ComputeSides(f,t,e,i,r,a.frontUVs,a.backUVs);const p=new ee;return p.indices=e,p.positions=t,p.normals=i,p.uvs=r,p}function rE(a,e={},t){const i=new N(a,t);return e.sideOrientation=N._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,iE(e).applyToMesh(i,e.updatable),i}ee.CreateTorusKnot=iE;N.CreateTorusKnot=(a,e,t,i,r,s,n,o,l,c)=>rE(a,{radius:e,tube:t,radialSegments:i,tubularSegments:r,p:s,q:n,sideOrientation:c,updatable:l},o);class Vb extends ne{constructor(e,t){super(e.x,e.y),this.index=t}}class Zo{constructor(){this.elements=[]}add(e){const t=[];return e.forEach(i=>{const r=new Vb(i,this.elements.length);t.push(r),this.elements.push(r)}),t}computeBounds(){const e=new ne(this.elements[0].x,this.elements[0].y),t=new ne(this.elements[0].x,this.elements[0].y);return this.elements.forEach(i=>{i.x<e.x?e.x=i.x:i.x>t.x&&(t.x=i.x),i.y<e.y?e.y=i.y:i.y>t.y&&(t.y=i.y)}),{min:e,max:t,width:t.x-e.x,height:t.y-e.y}}}class Gb{_addToepoint(e){for(const t of e)this._epoints.push(t.x,t.y)}constructor(e,t,i,r=earcut){this._points=new Zo,this._outlinepoints=new Zo,this._holes=new Array,this._epoints=new Array,this._eholes=new Array,this.bjsEarcut=r,this._name=e,this._scene=i||Re.LastCreatedScene;let s;t instanceof ka?s=t.getPoints():s=t,this._addToepoint(s),this._points.add(s),this._outlinepoints.add(s),typeof this.bjsEarcut>"u"&&B.Warn("Earcut was not found, the polygon will not be built.")}addHole(e){this._points.add(e);const t=new Zo;return t.add(e),this._holes.push(t),this._eholes.push(this._epoints.length/2),this._addToepoint(e),this}build(e=!1,t=0,i=2){const r=new N(this._name,this._scene),s=this.buildVertexData(t,i);return r.setVerticesData(x.PositionKind,s.positions,e),r.setVerticesData(x.NormalKind,s.normals,e),r.setVerticesData(x.UVKind,s.uvs,e),r.setIndices(s.indices),r}buildVertexData(e=0,t=2){const i=new ee,r=[],s=[],n=[],o=this._points.computeBounds();this._points.elements.forEach(h=>{r.push(0,1,0),s.push(h.x,0,h.y),n.push((h.x-o.min.x)/o.width,(h.y-o.min.y)/o.height)});const l=[],c=this.bjsEarcut(this._epoints,this._eholes,2);for(let h=0;h<c.length;h++)l.push(c[h]);if(e>0){const h=s.length/3;this._points.elements.forEach(u=>{r.push(0,-1,0),s.push(u.x,-e,u.y),n.push(1-(u.x-o.min.x)/o.width,1-(u.y-o.min.y)/o.height)});const f=l.length;for(let u=0;u<f;u+=3){const d=l[u+0],_=l[u+1],p=l[u+2];l.push(p+h),l.push(_+h),l.push(d+h)}this._addSide(s,r,n,l,o,this._outlinepoints,e,!1,t),this._holes.forEach(u=>{this._addSide(s,r,n,l,o,u,e,!0,t)})}return i.indices=l,i.positions=s,i.normals=r,i.uvs=n,i}_addSide(e,t,i,r,s,n,o,l,c){let h=e.length/3,f=0;for(let u=0;u<n.elements.length;u++){const d=n.elements[u],_=n.elements[(u+1)%n.elements.length];e.push(d.x,0,d.y),e.push(d.x,-o,d.y),e.push(_.x,0,_.y),e.push(_.x,-o,_.y);const p=n.elements[(u+n.elements.length-1)%n.elements.length],g=n.elements[(u+2)%n.elements.length];let E=new m(-(_.y-d.y),0,_.x-d.x),v=new m(-(d.y-p.y),0,d.x-p.x),b=new m(-(g.y-_.y),0,g.x-_.x);l||(E=E.scale(-1),v=v.scale(-1),b=b.scale(-1));const R=E.normalizeToNew();let S=v.normalizeToNew(),T=b.normalizeToNew();const I=m.Dot(S,R);I>c?I<Ke-1?S=new m(d.x,0,d.y).subtract(new m(_.x,0,_.y)).normalize():S=v.add(E).normalize():S=R;const O=m.Dot(b,E);O>c?O<Ke-1?T=new m(_.x,0,_.y).subtract(new m(d.x,0,d.y)).normalize():T=b.add(E).normalize():T=R,i.push(f/s.width,0),i.push(f/s.width,1),f+=E.length(),i.push(f/s.width,0),i.push(f/s.width,1),t.push(S.x,S.y,S.z),t.push(S.x,S.y,S.z),t.push(T.x,T.y,T.z),t.push(T.x,T.y,T.z),l?(r.push(h),r.push(h+2),r.push(h+1),r.push(h+1),r.push(h+2),r.push(h+3)):(r.push(h),r.push(h+1),r.push(h+2),r.push(h+1),r.push(h+3),r.push(h+2)),h+=4}}}function sE(a,e,t,i,r,s,n){const o=t||new Array(3),l=i,c=[],h=n||!1;for(let L=0;L<3;L++)o[L]===void 0&&(o[L]=new Fe(0,0,1,1)),l&&l[L]===void 0&&(l[L]=new Ne(1,1,1,1));const f=a.getVerticesData(x.PositionKind),u=a.getVerticesData(x.NormalKind),d=a.getVerticesData(x.UVKind),_=a.getIndices(),p=f.length/9;let g=0,E=0,v=0,b=0,R=0;const S=[0];if(h)for(let L=p;L<f.length/3;L+=4)E=f[3*(L+2)]-f[3*L],v=f[3*(L+2)+2]-f[3*L+2],b=Math.sqrt(E*E+v*v),R+=b,S.push(R);let T=0,I=0;for(let L=0;L<u.length;L+=3)Math.abs(u[L+1])<.001&&(I=1),Math.abs(u[L+1]-1)<.001&&(I=0),Math.abs(u[L+1]+1)<.001&&(I=2),T=L/3,I===1?(g=T-p,g%4<1.5?h?d[2*T]=o[I].x+(o[I].z-o[I].x)*S[Math.floor(g/4)]/R:d[2*T]=o[I].x:h?d[2*T]=o[I].x+(o[I].z-o[I].x)*S[Math.floor(g/4)+1]/R:d[2*T]=o[I].z,g%2===0?d[2*T+1]=o[I].w:d[2*T+1]=o[I].y):(d[2*T]=(1-d[2*T])*o[I].x+d[2*T]*o[I].z,d[2*T+1]=(1-d[2*T+1])*o[I].y+d[2*T+1]*o[I].w),l&&c.push(l[I].r,l[I].g,l[I].b,l[I].a);ee._ComputeSides(e,f,_,u,d,r,s);const O=new ee;if(O.indices=_,O.positions=f,O.normals=u,O.uvs=d,l){const L=e===ee.DOUBLESIDE?c.concat(c):c;O.colors=L}return O}function lh(a,e,t=null,i=earcut){e.sideOrientation=N._GetDefaultSideOrientation(e.sideOrientation);const r=e.shape,s=e.holes||[],n=e.depth||0,o=e.smoothingThreshold||2,l=[];let c=[];for(let _=0;_<r.length;_++)l[_]=new ne(r[_].x,r[_].z);l[0].equalsWithEpsilon(l[l.length-1],1e-8)&&l.pop();const f=new Gb(a,l,t||Re.LastCreatedScene,i);for(let _=0;_<s.length;_++){c=[];for(let p=0;p<s[_].length;p++)c.push(new ne(s[_][p].x,s[_][p].z));f.addHole(c)}const u=f.build(!1,n,o);return u._originalBuilderSideOrientation=e.sideOrientation,sE(u,e.sideOrientation,e.faceUV,e.faceColors,e.frontUVs,e.backUVs,e.wrap).applyToMesh(u,e.updatable),u}function ch(a,e,t=null,i=earcut){return lh(a,e,t,i)}ee.CreatePolygon=sE;N.CreatePolygon=(a,e,t,i,r,s,n=earcut)=>lh(a,{shape:e,holes:i,updatable:r,sideOrientation:s},t,n);N.ExtrudePolygon=(a,e,t,i,r,s,n,o=earcut)=>ch(a,{shape:e,holes:r,depth:t,updatable:s,sideOrientation:n},i,o);function nE(a,e,t=null){const i=e.path,r=e.shape,s=e.scale||1,n=e.rotation||0,o=e.cap===0?0:e.cap||N.NO_CAP,l=e.updatable,c=N._GetDefaultSideOrientation(e.sideOrientation),h=e.instance||null,f=e.invertUV||!1,u=e.closeShape||!1,d=e.closePath||!1,_=e.capFunction||null;return oE(a,r,i,s,n,null,null,d,u,o,!1,t,!!l,c,h,f,e.frontUVs||null,e.backUVs||null,e.firstNormal||null,!!e.adjustFrame,_)}function aE(a,e,t=null){const i=e.path,r=e.shape,s=e.scaleFunction||(()=>1),n=e.rotationFunction||(()=>0),o=e.closePath||e.ribbonCloseArray||!1,l=e.closeShape||e.ribbonClosePath||!1,c=e.cap===0?0:e.cap||N.NO_CAP,h=e.updatable,f=e.firstNormal||null,u=e.adjustFrame||!1,d=N._GetDefaultSideOrientation(e.sideOrientation),_=e.instance,p=e.invertUV||!1,g=e.capFunction||null;return oE(a,r,i,null,null,s,n,o,l,c,!0,t,!!h,d,_||null,p,e.frontUVs||null,e.backUVs||null,f,u,g||null)}function oE(a,e,t,i,r,s,n,o,l,c,h,f,u,d,_,p,g,E,v,b,R){const S=(w,$,J,ce,le,oe,ue,Pe,Se,ie,K)=>{const M=J.getTangents(),V=J.getNormals(),re=J.getBinormals(),ve=J.getDistances();if(K){for(let Me=0;Me<M.length;Me++)if(M[Me].x==0&&M[Me].y==0&&M[Me].z==0&&M[Me].copyFrom(M[Me-1]),V[Me].x==0&&V[Me].y==0&&V[Me].z==0&&V[Me].copyFrom(V[Me-1]),re[Me].x==0&&re[Me].y==0&&re[Me].z==0&&re[Me].copyFrom(re[Me-1]),Me>0){let Tt=M[Me-1];m.Dot(Tt,M[Me])<0&&M[Me].scaleInPlace(-1),Tt=V[Me-1],m.Dot(Tt,V[Me])<0&&V[Me].scaleInPlace(-1),Tt=re[Me-1],m.Dot(Tt,re[Me])<0&&re[Me].scaleInPlace(-1)}}let Be=0;const fe=()=>le!==null?le:1,Oe=ie&&Pe?Pe:()=>oe!==null?oe:0,Ee=ie&&ue?ue:fe;let Ue=Se===N.NO_CAP||Se===N.CAP_END?0:2;const vt=F.Matrix[0];for(let Me=0;Me<$.length;Me++){const Tt=[],Lt=Oe(Me,ve[Me]),Kt=Ee(Me,ve[Me]);P.RotationAxisToRef(M[Me],Be,vt);for(let Ci=0;Ci<w.length;Ci++){const as=M[Me].scale(w[Ci].z).add(V[Me].scale(w[Ci].x)).add(re[Me].scale(w[Ci].y)),Wr=m.Zero();m.TransformCoordinatesToRef(as,vt,Wr),Wr.scaleInPlace(Kt).addInPlace($[Me]),Tt[Ci]=Wr}ce[Ue]=Tt,Be+=Lt,Ue++}const Ye=R||(Me=>{const Tt=Array(),Lt=m.Zero();let Kt;for(Kt=0;Kt<Me.length;Kt++)Lt.addInPlace(Me[Kt]);for(Lt.scaleInPlace(1/Me.length),Kt=0;Kt<Me.length;Kt++)Tt.push(Lt);return Tt});switch(Se){case N.NO_CAP:break;case N.CAP_START:ce[0]=Ye(ce[2]),ce[1]=ce[2];break;case N.CAP_END:ce[Ue]=ce[Ue-1],ce[Ue+1]=Ye(ce[Ue-1]);break;case N.CAP_ALL:ce[0]=Ye(ce[2]),ce[1]=ce[2],ce[Ue]=ce[Ue-1],ce[Ue+1]=Ye(ce[Ue-1]);break}return ce};let T,I;if(_){const w=_._creationDataStorage;return T=v?w.path3D.update(t,v):w.path3D.update(t),I=S(e,t,w.path3D,w.pathArray,i,r,s,n,w.cap,h,b),_=Is("",{pathArray:I,closeArray:!1,closePath:!1,offset:0,updatable:!1,sideOrientation:0,instance:_},f||void 0),_}T=v?new xn(t,v):new xn(t);const O=new Array;c=c<0||c>3?0:c,I=S(e,t,T,O,i,r,s,n,c,h,b);const L=Is(a,{pathArray:I,closeArray:o,closePath:l,updatable:u,sideOrientation:d,invertUV:p,frontUVs:g||void 0,backUVs:E||void 0},f);return L._creationDataStorage.pathArray=I,L._creationDataStorage.path3D=T,L._creationDataStorage.cap=c,L}N.ExtrudeShape=(a,e,t,i,r,s,n=null,o,l,c)=>{const h={shape:e,path:t,scale:i,rotation:r,cap:s===0?0:s||N.NO_CAP,sideOrientation:l,instance:c,updatable:o};return nE(a,h,n)};N.ExtrudeShapeCustom=(a,e,t,i,r,s,n,o,l,c,h,f)=>{const u={shape:e,path:t,scaleFunction:i,rotationFunction:r,ribbonCloseArray:s,ribbonClosePath:n,cap:o===0?0:o||N.NO_CAP,sideOrientation:h,instance:f,updatable:c};return aE(a,u,l)};function lE(a,e,t=null){const i=e.arc?e.arc<=0||e.arc>1?1:e.arc:1,r=e.closed===void 0?!0:e.closed,s=e.shape,n=e.radius||1,o=e.tessellation||64,l=e.clip||0,c=e.updatable,h=N._GetDefaultSideOrientation(e.sideOrientation),f=e.cap||N.NO_CAP,u=Math.PI*2,d=[],_=e.invertUV||!1;let p=0,g=0;const E=u/o*i;let v,b;for(p=0;p<=o-l;p++){for(b=[],(f==N.CAP_START||f==N.CAP_ALL)&&(b.push(new m(0,s[0].y,0)),b.push(new m(Math.cos(p*E)*s[0].x*n,s[0].y,Math.sin(p*E)*s[0].x*n))),g=0;g<s.length;g++)v=new m(Math.cos(p*E)*s[g].x*n,s[g].y,Math.sin(p*E)*s[g].x*n),b.push(v);(f==N.CAP_END||f==N.CAP_ALL)&&(b.push(new m(Math.cos(p*E)*s[s.length-1].x*n,s[s.length-1].y,Math.sin(p*E)*s[s.length-1].x*n)),b.push(new m(0,s[s.length-1].y,0))),d.push(b)}return Is(a,{pathArray:d,closeArray:r,sideOrientation:h,updatable:c,invertUV:_,frontUVs:e.frontUVs,backUVs:e.backUVs},t)}N.CreateLathe=(a,e,t,i,r,s,n)=>lE(a,{shape:e,radius:t,tessellation:i,sideOrientation:n,updatable:s},r);function cE(a,e,t=null){const i=e.path;let r=e.instance,s=1;e.radius!==void 0?s=e.radius:r&&(s=r._creationDataStorage.radius);const n=e.tessellation||64,o=e.radiusFunction||null;let l=e.cap||N.NO_CAP;const c=e.invertUV||!1,h=e.updatable,f=N._GetDefaultSideOrientation(e.sideOrientation);e.arc=e.arc&&(e.arc<=0||e.arc>1)?1:e.arc||1;const u=(E,v,b,R,S,T,I,O)=>{const L=v.getTangents(),w=v.getNormals(),$=v.getDistances(),ce=Math.PI*2/S*O,oe=T||(()=>R);let ue,Pe,Se,ie;const K=F.Matrix[0];let M=I===N.NO_CAP||I===N.CAP_END?0:2;for(let re=0;re<E.length;re++){Pe=oe(re,$[re]),ue=Array(),Se=w[re];for(let ve=0;ve<S;ve++)P.RotationAxisToRef(L[re],ce*ve,K),ie=ue[ve]?ue[ve]:m.Zero(),m.TransformCoordinatesToRef(Se,K,ie),ie.scaleInPlace(Pe).addInPlace(E[re]),ue[ve]=ie;b[M]=ue,M++}const V=(re,ve)=>{const Be=Array();for(let fe=0;fe<re;fe++)Be.push(E[ve]);return Be};switch(I){case N.NO_CAP:break;case N.CAP_START:b[0]=V(S,0),b[1]=b[2].slice(0);break;case N.CAP_END:b[M]=b[M-1].slice(0),b[M+1]=V(S,E.length-1);break;case N.CAP_ALL:b[0]=V(S,0),b[1]=b[2].slice(0),b[M]=b[M-1].slice(0),b[M+1]=V(S,E.length-1);break}return b};let d,_;if(r){const E=r._creationDataStorage,v=e.arc||E.arc;return d=E.path3D.update(i),_=u(i,d,E.pathArray,s,E.tessellation,o,E.cap,v),r=Is("",{pathArray:_,instance:r}),E.path3D=d,E.pathArray=_,E.arc=v,E.radius=s,r}d=new xn(i);const p=new Array;l=l<0||l>3?0:l,_=u(i,d,p,s,n,o,l,e.arc);const g=Is(a,{pathArray:_,closePath:!0,closeArray:!1,updatable:h,sideOrientation:f,invertUV:c,frontUVs:e.frontUVs,backUVs:e.backUVs},t);return g._creationDataStorage.pathArray=_,g._creationDataStorage.path3D=d,g._creationDataStorage.tessellation=n,g._creationDataStorage.cap=l,g._creationDataStorage.arc=e.arc,g._creationDataStorage.radius=s,g}N.CreateTube=(a,e,t,i,r,s,n,o,l,c)=>cE(a,{path:e,radius:t,tessellation:i,radiusFunction:r,arc:1,cap:s,updatable:o,sideOrientation:l,instance:c},n);function hE(a){const e=[];e[0]={vertex:[[0,0,1.732051],[1.632993,0,-.5773503],[-.8164966,1.414214,-.5773503],[-.8164966,-1.414214,-.5773503]],face:[[0,1,2],[0,2,3],[0,3,1],[1,3,2]]},e[1]={vertex:[[0,0,1.414214],[1.414214,0,0],[0,1.414214,0],[-1.414214,0,0],[0,-1.414214,0],[0,0,-1.414214]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,1],[1,4,5],[1,5,2],[2,5,3],[3,5,4]]},e[2]={vertex:[[0,0,1.070466],[.7136442,0,.7978784],[-.3568221,.618034,.7978784],[-.3568221,-.618034,.7978784],[.7978784,.618034,.3568221],[.7978784,-.618034,.3568221],[-.9341724,.381966,.3568221],[.1362939,1,.3568221],[.1362939,-1,.3568221],[-.9341724,-.381966,.3568221],[.9341724,.381966,-.3568221],[.9341724,-.381966,-.3568221],[-.7978784,.618034,-.3568221],[-.1362939,1,-.3568221],[-.1362939,-1,-.3568221],[-.7978784,-.618034,-.3568221],[.3568221,.618034,-.7978784],[.3568221,-.618034,-.7978784],[-.7136442,0,-.7978784],[0,0,-1.070466]],face:[[0,1,4,7,2],[0,2,6,9,3],[0,3,8,5,1],[1,5,11,10,4],[2,7,13,12,6],[3,9,15,14,8],[4,10,16,13,7],[5,8,14,17,11],[6,12,18,15,9],[10,11,17,19,16],[12,13,16,19,18],[14,15,18,19,17]]},e[3]={vertex:[[0,0,1.175571],[1.051462,0,.5257311],[.3249197,1,.5257311],[-.8506508,.618034,.5257311],[-.8506508,-.618034,.5257311],[.3249197,-1,.5257311],[.8506508,.618034,-.5257311],[.8506508,-.618034,-.5257311],[-.3249197,1,-.5257311],[-1.051462,0,-.5257311],[-.3249197,-1,-.5257311],[0,0,-1.175571]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,5],[0,5,1],[1,5,7],[1,7,6],[1,6,2],[2,6,8],[2,8,3],[3,8,9],[3,9,4],[4,9,10],[4,10,5],[5,10,7],[6,7,11],[6,11,8],[7,10,11],[8,11,9],[9,11,10]]},e[4]={vertex:[[0,0,1.070722],[.7148135,0,.7971752],[-.104682,.7071068,.7971752],[-.6841528,.2071068,.7971752],[-.104682,-.7071068,.7971752],[.6101315,.7071068,.5236279],[1.04156,.2071068,.1367736],[.6101315,-.7071068,.5236279],[-.3574067,1,.1367736],[-.7888348,-.5,.5236279],[-.9368776,.5,.1367736],[-.3574067,-1,.1367736],[.3574067,1,-.1367736],[.9368776,-.5,-.1367736],[.7888348,.5,-.5236279],[.3574067,-1,-.1367736],[-.6101315,.7071068,-.5236279],[-1.04156,-.2071068,-.1367736],[-.6101315,-.7071068,-.5236279],[.104682,.7071068,-.7971752],[.6841528,-.2071068,-.7971752],[.104682,-.7071068,-.7971752],[-.7148135,0,-.7971752],[0,0,-1.070722]],face:[[0,2,3],[1,6,5],[4,9,11],[7,15,13],[8,16,10],[12,14,19],[17,22,18],[20,21,23],[0,1,5,2],[0,3,9,4],[0,4,7,1],[1,7,13,6],[2,5,12,8],[2,8,10,3],[3,10,17,9],[4,11,15,7],[5,6,14,12],[6,13,20,14],[8,12,19,16],[9,17,18,11],[10,16,22,17],[11,18,21,15],[13,15,21,20],[14,20,23,19],[16,19,23,22],[18,22,23,21]]},e[5]={vertex:[[0,0,1.322876],[1.309307,0,.1889822],[-.9819805,.8660254,.1889822],[.1636634,-1.299038,.1889822],[.3273268,.8660254,-.9449112],[-.8183171,-.4330127,-.9449112]],face:[[0,3,1],[2,4,5],[0,1,4,2],[0,2,5,3],[1,3,5,4]]},e[6]={vertex:[[0,0,1.159953],[1.013464,0,.5642542],[-.3501431,.9510565,.5642542],[-.7715208,-.6571639,.5642542],[.6633206,.9510565,-.03144481],[.8682979,-.6571639,-.3996071],[-1.121664,.2938926,-.03144481],[-.2348831,-1.063314,-.3996071],[.5181548,.2938926,-.9953061],[-.5850262,-.112257,-.9953061]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,9,7],[5,7,9,8],[0,3,7,5,1],[2,4,8,9,6]]},e[7]={vertex:[[0,0,1.118034],[.8944272,0,.6708204],[-.2236068,.8660254,.6708204],[-.7826238,-.4330127,.6708204],[.6708204,.8660254,.2236068],[1.006231,-.4330127,-.2236068],[-1.006231,.4330127,.2236068],[-.6708204,-.8660254,-.2236068],[.7826238,.4330127,-.6708204],[.2236068,-.8660254,-.6708204],[-.8944272,0,-.6708204],[0,0,-1.118034]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,10,7],[5,9,11,8],[7,10,11,9],[0,3,7,9,5,1],[2,4,8,11,10,6]]},e[8]={vertex:[[-.729665,.670121,.319155],[-.655235,-.29213,-.754096],[-.093922,-.607123,.537818],[.702196,.595691,.485187],[.776626,-.36656,-.588064]],face:[[1,4,2],[0,1,2],[3,0,2],[4,3,2],[4,1,0,3]]},e[9]={vertex:[[-.868849,-.100041,.61257],[-.329458,.976099,.28078],[-.26629,-.013796,-.477654],[-.13392,-1.034115,.229829],[.738834,.707117,-.307018],[.859683,-.535264,-.338508]],face:[[3,0,2],[5,3,2],[4,5,2],[1,4,2],[0,1,2],[0,3,5,4,1]]},e[10]={vertex:[[-.610389,.243975,.531213],[-.187812,-.48795,-.664016],[-.187812,.9759,-.664016],[.187812,-.9759,.664016],[.798201,.243975,.132803]],face:[[1,3,0],[3,4,0],[3,1,4],[0,2,1],[0,4,2],[2,4,1]]},e[11]={vertex:[[-1.028778,.392027,-.048786],[-.640503,-.646161,.621837],[-.125162,-.395663,-.540059],[.004683,.888447,-.651988],[.125161,.395663,.540059],[.632925,-.791376,.433102],[1.031672,.157063,-.354165]],face:[[3,2,0],[2,1,0],[2,5,1],[0,4,3],[0,1,4],[4,1,5],[2,3,6],[3,4,6],[5,2,6],[4,5,6]]},e[12]={vertex:[[-.669867,.334933,-.529576],[-.669867,.334933,.529577],[-.4043,1.212901,0],[-.334933,-.669867,-.529576],[-.334933,-.669867,.529577],[.334933,.669867,-.529576],[.334933,.669867,.529577],[.4043,-1.212901,0],[.669867,-.334933,-.529576],[.669867,-.334933,.529577]],face:[[8,9,7],[6,5,2],[3,8,7],[5,0,2],[4,3,7],[0,1,2],[9,4,7],[1,6,2],[9,8,5,6],[8,3,0,5],[3,4,1,0],[4,9,6,1]]},e[13]={vertex:[[-.931836,.219976,-.264632],[-.636706,.318353,.692816],[-.613483,-.735083,-.264632],[-.326545,.979634,0],[-.318353,-.636706,.692816],[-.159176,.477529,-.856368],[.159176,-.477529,-.856368],[.318353,.636706,.692816],[.326545,-.979634,0],[.613482,.735082,-.264632],[.636706,-.318353,.692816],[.931835,-.219977,-.264632]],face:[[11,10,8],[7,9,3],[6,11,8],[9,5,3],[2,6,8],[5,0,3],[4,2,8],[0,1,3],[10,4,8],[1,7,3],[10,11,9,7],[11,6,5,9],[6,2,0,5],[2,4,1,0],[4,10,7,1]]},e[14]={vertex:[[-.93465,.300459,-.271185],[-.838689,-.260219,-.516017],[-.711319,.717591,.128359],[-.710334,-.156922,.080946],[-.599799,.556003,-.725148],[-.503838,-.004675,-.969981],[-.487004,.26021,.48049],[-.460089,-.750282,-.512622],[-.376468,.973135,-.325605],[-.331735,-.646985,.084342],[-.254001,.831847,.530001],[-.125239,-.494738,-.966586],[.029622,.027949,.730817],[.056536,-.982543,-.262295],[.08085,1.087391,.076037],[.125583,-.532729,.485984],[.262625,.599586,.780328],[.391387,-.726999,-.716259],[.513854,-.868287,.139347],[.597475,.85513,.326364],[.641224,.109523,.783723],[.737185,-.451155,.538891],[.848705,-.612742,-.314616],[.976075,.365067,.32976],[1.072036,-.19561,.084927]],face:[[15,18,21],[12,20,16],[6,10,2],[3,0,1],[9,7,13],[2,8,4,0],[0,4,5,1],[1,5,11,7],[7,11,17,13],[13,17,22,18],[18,22,24,21],[21,24,23,20],[20,23,19,16],[16,19,14,10],[10,14,8,2],[15,9,13,18],[12,15,21,20],[6,12,16,10],[3,6,2,0],[9,3,1,7],[9,15,12,6,3],[22,17,11,5,4,8,14,19,23,24]]};const t=a.type&&(a.type<0||a.type>=e.length)?0:a.type||0,i=a.size,r=a.sizeX||i||1,s=a.sizeY||i||1,n=a.sizeZ||i||1,o=a.custom||e[t],l=o.face.length,c=a.faceUV||new Array(l),h=a.faceColors,f=a.flat===void 0?!0:a.flat,u=a.sideOrientation===0?0:a.sideOrientation||ee.DEFAULTSIDE,d=[],_=[],p=[],g=[],E=[];let v=0,b=0;const R=[];let S=0,T=0,I,O,L,w,$,J;if(f)for(T=0;T<l;T++)h&&h[T]===void 0&&(h[T]=new Ne(1,1,1,1)),c&&c[T]===void 0&&(c[T]=new Fe(0,0,1,1));if(f)for(T=0;T<l;T++){const le=o.face[T].length;for(L=2*Math.PI/le,w=.5*Math.tan(L/2),$=.5,S=0;S<le;S++)d.push(o.vertex[o.face[T][S]][0]*r,o.vertex[o.face[T][S]][1]*s,o.vertex[o.face[T][S]][2]*n),R.push(v),v++,I=c[T].x+(c[T].z-c[T].x)*(.5+w),O=c[T].y+(c[T].w-c[T].y)*($-.5),g.push(I,O),J=w*Math.cos(L)-$*Math.sin(L),$=w*Math.sin(L)+$*Math.cos(L),w=J,h&&E.push(h[T].r,h[T].g,h[T].b,h[T].a);for(S=0;S<le-2;S++)_.push(R[0+b],R[S+2+b],R[S+1+b]);b+=le}else{for(S=0;S<o.vertex.length;S++)d.push(o.vertex[S][0]*r,o.vertex[S][1]*s,o.vertex[S][2]*n),g.push(0,0);for(T=0;T<l;T++)for(S=0;S<o.face[T].length-2;S++)_.push(o.face[T][0],o.face[T][S+2],o.face[T][S+1])}ee.ComputeNormals(d,_,p),ee._ComputeSides(u,d,_,p,g,a.frontUVs,a.backUVs);const ce=new ee;return ce.positions=d,ce.indices=_,ce.normals=p,ce.uvs=g,h&&f&&(ce.colors=E),ce}function hh(a,e={},t=null){const i=new N(a,t);return e.sideOrientation=N._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,hE(e).applyToMesh(i,e.updatable),i}ee.CreatePolyhedron=hE;N.CreatePolyhedron=(a,e,t)=>hh(a,e,t);const kb=new m(1,0,0),Wb=new m(-1,0,0),Xb=new m(0,1,0),Hb=new m(0,-1,0),zb=new m(0,0,1),Yb=new m(0,0,-1);class Ma{constructor(e=m.Zero(),t=m.Up(),i=ne.Zero(),r=0,s=0,n=null,o=null,l=null,c=null){this.position=e,this.normal=t,this.uv=i,this.vertexIdx=r,this.vertexIdxForBones=s,this.localPositionOverride=n,this.localNormalOverride=o,this.matrixIndicesOverride=l,this.matrixWeightsOverride=c}clone(){var e,t,i,r;return new Ma(this.position.clone(),this.normal.clone(),this.uv.clone(),this.vertexIdx,this.vertexIdxForBones,(e=this.localPositionOverride)==null?void 0:e.slice(),(t=this.localNormalOverride)==null?void 0:t.slice(),(i=this.matrixIndicesOverride)==null?void 0:i.slice(),(r=this.matrixWeightsOverride)==null?void 0:r.slice())}}function fE(a,e,t){var ue,Pe,Se,ie;const i=!!e.skeleton,r=t.localMode||i,s=e.getIndices(),n=i?e.getPositionData(!0,!0):e.getVerticesData(x.PositionKind),o=i?e.getNormalsData(!0,!0):e.getVerticesData(x.NormalKind),l=r?i?e.getVerticesData(x.PositionKind):n:null,c=r?i?e.getVerticesData(x.NormalKind):o:null,h=e.getVerticesData(x.UVKind),f=i?e.getVerticesData(x.MatricesIndicesKind):null,u=i?e.getVerticesData(x.MatricesWeightsKind):null,d=i?e.getVerticesData(x.MatricesIndicesExtraKind):null,_=i?e.getVerticesData(x.MatricesWeightsExtraKind):null,p=t.position||m.Zero();let g=t.normal||m.Up();const E=t.size||m.One(),v=t.angle||0;if(!g){const K=new m(0,0,1),M=e.getScene().activeCamera,V=m.TransformCoordinates(K,M.getWorldMatrix());g=M.globalPosition.subtract(V)}const b=-Math.atan2(g.z,g.x)-Math.PI/2,R=Math.sqrt(g.x*g.x+g.z*g.z),S=Math.atan2(g.y,R),T=new ee;T.indices=[],T.positions=[],T.normals=[],T.uvs=[],T.matricesIndices=i?[]:null,T.matricesWeights=i?[]:null,T.matricesIndicesExtra=d?[]:null,T.matricesWeightsExtra=_?[]:null;let I=0;const O=(K,M)=>{const V=new Ma;if(!s||!n||!o)return V;const re=s[K];if(V.vertexIdx=re*3,V.vertexIdxForBones=re*4,V.position=new m(n[re*3],n[re*3+1],n[re*3+2]),m.TransformCoordinatesToRef(V.position,M,V.position),V.normal=new m(o[re*3],o[re*3+1],o[re*3+2]),m.TransformNormalToRef(V.normal,M,V.normal),t.captureUVS&&h){const ve=h[re*2+1];V.uv=new ne(h[re*2],ve)}return V},L=[0,0,0,0],w=(K,M)=>{if(K.length===0)return K;const V=.5*Math.abs(m.Dot(E,M)),re=(fe,me,Oe,Ee)=>{for(let Ue=0;Ue<Ee;++Ue)if(fe[Oe+Ue]===me)return Oe+Ue;return-1},ve=(fe,me)=>{const Oe=m.GetClipFactor(fe.position,me.position,M,V);let Ee=L,Ue=L;if(f&&u){const fn=fe.matrixIndicesOverride?0:fe.vertexIdxForBones,yo=fe.matrixIndicesOverride??f,ph=fe.matrixWeightsOverride??u,Mo=me.matrixIndicesOverride?0:me.vertexIdxForBones,mh=me.matrixIndicesOverride??f,gh=me.matrixWeightsOverride??u;Ee=[0,0,0,0],Ue=[0,0,0,0];let os=0;for(let Qi=0;Qi<4;++Qi)if(ph[fn+Qi]>0){const un=re(mh,yo[fn+Qi],Mo,4);Ee[os]=yo[fn+Qi],Ue[os]=Qr(ph[fn+Qi],un>=0?gh[un]:0,Oe),os++}for(let Qi=0;Qi<4&&os<4;++Qi){const un=mh[Mo+Qi];re(yo,un,fn,4)===-1&&(Ee[os]=un,Ue[os]=Qr(0,gh[Mo+Qi],Oe),os++)}const ta=Ue[0]+Ue[1]+Ue[2]+Ue[3];Ue[0]/=ta,Ue[1]/=ta,Ue[2]/=ta,Ue[3]/=ta}const vt=fe.localPositionOverride?fe.localPositionOverride[0]:(l==null?void 0:l[fe.vertexIdx])??0,xe=fe.localPositionOverride?fe.localPositionOverride[1]:(l==null?void 0:l[fe.vertexIdx+1])??0,Ye=fe.localPositionOverride?fe.localPositionOverride[2]:(l==null?void 0:l[fe.vertexIdx+2])??0,Me=me.localPositionOverride?me.localPositionOverride[0]:(l==null?void 0:l[me.vertexIdx])??0,Tt=me.localPositionOverride?me.localPositionOverride[1]:(l==null?void 0:l[me.vertexIdx+1])??0,Lt=me.localPositionOverride?me.localPositionOverride[2]:(l==null?void 0:l[me.vertexIdx+2])??0,Kt=fe.localNormalOverride?fe.localNormalOverride[0]:(c==null?void 0:c[fe.vertexIdx])??0,Ci=fe.localNormalOverride?fe.localNormalOverride[1]:(c==null?void 0:c[fe.vertexIdx+1])??0,as=fe.localNormalOverride?fe.localNormalOverride[2]:(c==null?void 0:c[fe.vertexIdx+2])??0,Wr=me.localNormalOverride?me.localNormalOverride[0]:(c==null?void 0:c[me.vertexIdx])??0,ea=me.localNormalOverride?me.localNormalOverride[1]:(c==null?void 0:c[me.vertexIdx+1])??0,Ro=me.localNormalOverride?me.localNormalOverride[2]:(c==null?void 0:c[me.vertexIdx+2])??0,Co=Kt+(Wr-Kt)*Oe,Io=Ci+(ea-Ci)*Oe,bo=as+(Ro-as)*Oe,xo=Math.sqrt(Co*Co+Io*Io+bo*bo);return new Ma(m.Lerp(fe.position,me.position,Oe),m.Lerp(fe.normal,me.normal,Oe).normalize(),ne.Lerp(fe.uv,me.uv,Oe),-1,-1,l?[vt+(Me-vt)*Oe,xe+(Tt-xe)*Oe,Ye+(Lt-Ye)*Oe]:null,c?[Co/xo,Io/xo,bo/xo]:null,Ee,Ue)};let Be=null;K.length>3&&(Be=[]);for(let fe=0;fe<K.length;fe+=3){let me=0,Oe=null,Ee=null,Ue=null,vt=null;const xe=m.Dot(K[fe].position,M)-V,Ye=m.Dot(K[fe+1].position,M)-V,Me=m.Dot(K[fe+2].position,M)-V,Tt=xe>0,Lt=Ye>0,Kt=Me>0;switch(me=(Tt?1:0)+(Lt?1:0)+(Kt?1:0),me){case 0:K.length>3?(Be.push(K[fe]),Be.push(K[fe+1]),Be.push(K[fe+2])):Be=K;break;case 1:if(Be=Be??new Array,Tt&&(Oe=K[fe+1],Ee=K[fe+2],Ue=ve(K[fe],Oe),vt=ve(K[fe],Ee)),Lt){Oe=K[fe],Ee=K[fe+2],Ue=ve(K[fe+1],Oe),vt=ve(K[fe+1],Ee),Be.push(Ue),Be.push(Ee.clone()),Be.push(Oe.clone()),Be.push(Ee.clone()),Be.push(Ue.clone()),Be.push(vt);break}Kt&&(Oe=K[fe],Ee=K[fe+1],Ue=ve(K[fe+2],Oe),vt=ve(K[fe+2],Ee)),Oe&&Ee&&Ue&&vt&&(Be.push(Oe.clone()),Be.push(Ee.clone()),Be.push(Ue),Be.push(vt),Be.push(Ue.clone()),Be.push(Ee.clone()));break;case 2:Be=Be??new Array,Tt||(Oe=K[fe].clone(),Ee=ve(Oe,K[fe+1]),Ue=ve(Oe,K[fe+2]),Be.push(Oe),Be.push(Ee),Be.push(Ue)),Lt||(Oe=K[fe+1].clone(),Ee=ve(Oe,K[fe+2]),Ue=ve(Oe,K[fe]),Be.push(Oe),Be.push(Ee),Be.push(Ue)),Kt||(Oe=K[fe+2].clone(),Ee=ve(Oe,K[fe]),Ue=ve(Oe,K[fe+1]),Be.push(Oe),Be.push(Ee),Be.push(Ue));break}}return Be},$=e instanceof N?e:null,J=$==null?void 0:$._thinInstanceDataStorage.matrixData,ce=($==null?void 0:$.thinInstanceCount)||1,le=F.Matrix[0];le.copyFrom(P.IdentityReadOnly);for(let K=0;K<ce;++K){if($!=null&&$.hasThinInstances&&J){const fe=K*16;le.setRowFromFloats(0,J[fe+0],J[fe+1],J[fe+2],J[fe+3]),le.setRowFromFloats(1,J[fe+4],J[fe+5],J[fe+6],J[fe+7]),le.setRowFromFloats(2,J[fe+8],J[fe+9],J[fe+10],J[fe+11]),le.setRowFromFloats(3,J[fe+12],J[fe+13],J[fe+14],J[fe+15])}const M=P.RotationYawPitchRoll(b,S,v).multiply(P.Translation(p.x,p.y,p.z)),V=P.Invert(M),re=e.getWorldMatrix(),ve=le.multiply(re).multiply(V),Be=new Array(3);for(let fe=0;fe<s.length;fe+=3){let me=Be;if(me[0]=O(fe,ve),me[1]=O(fe+1,ve),me[2]=O(fe+2,ve),!(t.cullBackFaces&&-me[0].normal.z<=0&&-me[1].normal.z<=0&&-me[2].normal.z<=0)&&(me=w(me,kb),!!me&&(me=w(me,Wb),!!me&&(me=w(me,Xb),!!me&&(me=w(me,Hb),!!me&&(me=w(me,zb),!!me&&(me=w(me,Yb),!!me)))))))for(let Oe=0;Oe<me.length;Oe++){const Ee=me[Oe];if(T.indices.push(I),r?(Ee.localPositionOverride?(T.positions[I*3]=Ee.localPositionOverride[0],T.positions[I*3+1]=Ee.localPositionOverride[1],T.positions[I*3+2]=Ee.localPositionOverride[2]):l&&(T.positions[I*3]=l[Ee.vertexIdx],T.positions[I*3+1]=l[Ee.vertexIdx+1],T.positions[I*3+2]=l[Ee.vertexIdx+2]),Ee.localNormalOverride?(T.normals[I*3]=Ee.localNormalOverride[0],T.normals[I*3+1]=Ee.localNormalOverride[1],T.normals[I*3+2]=Ee.localNormalOverride[2]):c&&(T.normals[I*3]=c[Ee.vertexIdx],T.normals[I*3+1]=c[Ee.vertexIdx+1],T.normals[I*3+2]=c[Ee.vertexIdx+2])):(Ee.position.toArray(T.positions,I*3),Ee.normal.toArray(T.normals,I*3)),T.matricesIndices&&T.matricesWeights&&(Ee.matrixIndicesOverride?(T.matricesIndices[I*4]=Ee.matrixIndicesOverride[0],T.matricesIndices[I*4+1]=Ee.matrixIndicesOverride[1],T.matricesIndices[I*4+2]=Ee.matrixIndicesOverride[2],T.matricesIndices[I*4+3]=Ee.matrixIndicesOverride[3]):(f&&(T.matricesIndices[I*4]=f[Ee.vertexIdxForBones],T.matricesIndices[I*4+1]=f[Ee.vertexIdxForBones+1],T.matricesIndices[I*4+2]=f[Ee.vertexIdxForBones+2],T.matricesIndices[I*4+3]=f[Ee.vertexIdxForBones+3]),d&&T.matricesIndicesExtra&&(T.matricesIndicesExtra[I*4]=d[Ee.vertexIdxForBones],T.matricesIndicesExtra[I*4+1]=d[Ee.vertexIdxForBones+1],T.matricesIndicesExtra[I*4+2]=d[Ee.vertexIdxForBones+2],T.matricesIndicesExtra[I*4+3]=d[Ee.vertexIdxForBones+3])),Ee.matrixWeightsOverride?(T.matricesWeights[I*4]=Ee.matrixWeightsOverride[0],T.matricesWeights[I*4+1]=Ee.matrixWeightsOverride[1],T.matricesWeights[I*4+2]=Ee.matrixWeightsOverride[2],T.matricesWeights[I*4+3]=Ee.matrixWeightsOverride[3]):(u&&(T.matricesWeights[I*4]=u[Ee.vertexIdxForBones],T.matricesWeights[I*4+1]=u[Ee.vertexIdxForBones+1],T.matricesWeights[I*4+2]=u[Ee.vertexIdxForBones+2],T.matricesWeights[I*4+3]=u[Ee.vertexIdxForBones+3]),_&&T.matricesWeightsExtra&&(T.matricesWeightsExtra[I*4]=_[Ee.vertexIdxForBones],T.matricesWeightsExtra[I*4+1]=_[Ee.vertexIdxForBones+1],T.matricesWeightsExtra[I*4+2]=_[Ee.vertexIdxForBones+2],T.matricesWeightsExtra[I*4+3]=_[Ee.vertexIdxForBones+3]))),t.captureUVS)Ee.uv.toArray(T.uvs,I*2);else{T.uvs.push(.5+Ee.position.x/E.x);const Ue=.5+Ee.position.y/E.y;T.uvs.push(Ue)}I++}}}T.indices.length===0&&(T.indices=null),T.positions.length===0&&(T.positions=null),T.normals.length===0&&(T.normals=null),T.uvs.length===0&&(T.uvs=null),((ue=T.matricesIndices)==null?void 0:ue.length)===0&&(T.matricesIndices=null),((Pe=T.matricesWeights)==null?void 0:Pe.length)===0&&(T.matricesWeights=null),((Se=T.matricesIndicesExtra)==null?void 0:Se.length)===0&&(T.matricesIndicesExtra=null),((ie=T.matricesWeightsExtra)==null?void 0:ie.length)===0&&(T.matricesWeightsExtra=null);const oe=new N(a,e.getScene());return T.applyToMesh(oe),r?(oe.skeleton=e.skeleton,oe.parent=e):(oe.position=p.clone(),oe.rotation=new m(S,b,v)),oe.computeWorldMatrix(!0),oe.refreshBoundingInfo(!0,!0),oe}N.CreateDecal=(a,e,t,i,r,s)=>fE(a,e,{position:t,normal:i,size:r,angle:s});function uE(a={subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){const e=Math.max(a.subdivisions?a.subdivisions:2,1)|0,t=Math.max(a.tessellation?a.tessellation:16,3)|0,i=Math.max(a.height?a.height:1,0),r=Math.max(a.radius?a.radius:.25,0),s=Math.max(a.capSubdivisions?a.capSubdivisions:6,1)|0,n=t,o=e,l=Math.max(a.radiusTop?a.radiusTop:r,0),c=Math.max(a.radiusBottom?a.radiusBottom:r,0),h=i-(l+c),f=0,u=2*Math.PI,d=Math.max(a.topCapSubdivisions?a.topCapSubdivisions:s,1),_=Math.max(a.bottomCapSubdivisions?a.bottomCapSubdivisions:s,1),p=Math.acos((c-l)/i);let g=[];const E=[],v=[],b=[];let R=0;const S=[],T=h*.5,I=Math.PI*.5;let O,L;const w=m.Zero(),$=m.Zero(),J=Math.cos(p),ce=Math.sin(p),le=new ne(l*ce,T+l*J).subtract(new ne(c*ce,-T+c*J)).length(),oe=l*p+le+c*(I-p);let ue=0;for(L=0;L<=d;L++){const K=[],M=I-p*(L/d);ue+=l*p/d;const V=Math.cos(M),re=Math.sin(M),ve=V*l;for(O=0;O<=n;O++){const Be=O/n,fe=Be*u+f,me=Math.sin(fe),Oe=Math.cos(fe);$.x=ve*me,$.y=T+re*l,$.z=ve*Oe,E.push($.x,$.y,$.z),w.set(V*me,re,V*Oe),v.push(w.x,w.y,w.z),b.push(Be,1-ue/oe),K.push(R),R++}S.push(K)}const Pe=i-l-c+J*l-J*c,Se=ce*(c-l)/Pe;for(L=1;L<=o;L++){const K=[];ue+=le/o;const M=ce*(L*(c-l)/o+l);for(O=0;O<=n;O++){const V=O/n,re=V*u+f,ve=Math.sin(re),Be=Math.cos(re);$.x=M*ve,$.y=T+J*l-L*Pe/o,$.z=M*Be,E.push($.x,$.y,$.z),w.set(ve,Se,Be).normalize(),v.push(w.x,w.y,w.z),b.push(V,1-ue/oe),K.push(R),R++}S.push(K)}for(L=1;L<=_;L++){const K=[],M=I-p-(Math.PI-p)*(L/_);ue+=c*p/_;const V=Math.cos(M),re=Math.sin(M),ve=V*c;for(O=0;O<=n;O++){const Be=O/n,fe=Be*u+f,me=Math.sin(fe),Oe=Math.cos(fe);$.x=ve*me,$.y=-T+re*c,$.z=ve*Oe,E.push($.x,$.y,$.z),w.set(V*me,re,V*Oe),v.push(w.x,w.y,w.z),b.push(Be,1-ue/oe),K.push(R),R++}S.push(K)}for(O=0;O<n;O++)for(L=0;L<d+o+_;L++){const K=S[L][O],M=S[L+1][O],V=S[L+1][O+1],re=S[L][O+1];g.push(K),g.push(M),g.push(re),g.push(M),g.push(V),g.push(re)}if(g=g.reverse(),a.orientation&&!a.orientation.equals(m.Up())){const K=new P;a.orientation.clone().scale(Math.PI*.5).cross(m.Up()).toQuaternion().toRotationMatrix(K);const M=m.Zero();for(let V=0;V<E.length;V+=3)M.set(E[V],E[V+1],E[V+2]),m.TransformCoordinatesToRef(M.clone(),K,M),E[V]=M.x,E[V+1]=M.y,E[V+2]=M.z}const ie=new ee;return ie.positions=E,ie.normals=v,ie.uvs=b,ie.indices=g,ie}function dE(a,e={orientation:m.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6,updatable:!1},t=null){const i=new N(a,t);return uE(e).applyToMesh(i,e.updatable),i}N.CreateCapsule=(a,e,t)=>dE(a,e,t);ee.CreateCapsule=uE;class Ct{constructor(e=0,t=0){this.x=e,this.y=t,e!==Math.floor(e)&&(e=Math.floor(e),B.Warn("x is not an integer, floor(x) used")),t!==Math.floor(t)&&(t=Math.floor(t),B.Warn("y is not an integer, floor(y) used"))}clone(){return new Ct(this.x,this.y)}rotate60About(e){const t=this.x;return this.x=e.x+e.y-this.y,this.y=t+this.y-e.x,this}rotateNeg60About(e){const t=this.x;return this.x=t+this.y-e.y,this.y=e.x+e.y-t,this}rotate120(e,t){e!==Math.floor(e)&&(e=Math.floor(e),B.Warn("m not an integer only floor(m) used")),t!==Math.floor(t)&&(t=Math.floor(t),B.Warn("n not an integer only floor(n) used"));const i=this.x;return this.x=e-i-this.y,this.y=t+i,this}rotateNeg120(e,t){e!==Math.floor(e)&&(e=Math.floor(e),B.Warn("m is not an integer, floor(m) used")),t!==Math.floor(t)&&(t=Math.floor(t),B.Warn("n is not an integer,   floor(n) used"));const i=this.x;return this.x=this.y-t,this.y=e+t-i-this.y,this}toCartesianOrigin(e,t){const i=m.Zero();return i.x=e.x+2*this.x*t+this.y*t,i.y=e.y+Math.sqrt(3)*this.y*t,i}static Zero(){return new Ct(0,0)}}class _E{constructor(){this.cartesian=[],this.vertices=[],this.max=[],this.min=[],this.closestTo=[],this.innerFacets=[],this.isoVecsABOB=[],this.isoVecsOBOA=[],this.isoVecsBAOA=[],this.vertexTypes=[],this.IDATA=new Tl("icosahedron","Regular",[[0,wt,-1],[-wt,1,0],[-1,0,-wt],[1,0,-wt],[wt,1,0],[0,wt,1],[-1,0,wt],[-wt,-1,0],[0,-wt,-1],[wt,-1,0],[1,0,wt],[0,-wt,1]],[[0,2,1],[0,3,2],[0,4,3],[0,5,4],[0,1,5],[7,6,1],[8,7,2],[9,8,3],[10,9,4],[6,10,5],[2,7,1],[3,8,2],[4,9,3],[5,10,4],[1,6,5],[11,6,7],[11,7,8],[11,8,9],[11,9,10],[11,10,6]])}setIndices(){let e=12;const t={},i=this.m,r=this.n;let s=i,n=1,o=0;r!==0&&(s=Rn(i,r)),n=i/s,o=r/s;let l,c,h,f,u;const d=Ct.Zero(),_=new Ct(i,r),p=new Ct(-r,i+r),g=Ct.Zero(),E=Ct.Zero(),v=Ct.Zero();let b=[],R,S,T,I;const O=[],L=this.vertByDist,w=($,J,ce,le)=>{R=$+"|"+ce,S=J+"|"+le,R in t||S in t?R in t&&!(S in t)?t[S]=t[R]:S in t&&!(R in t)&&(t[R]=t[S]):(t[R]=e,t[S]=e,e++),L[ce][0]>2?O[t[R]]=[-L[ce][0],L[ce][1],t[R]]:O[t[R]]=[b[L[ce][0]],L[ce][1],t[R]]};this.IDATA.edgematch=[[1,"B"],[2,"B"],[3,"B"],[4,"B"],[0,"B"],[10,"O",14,"A"],[11,"O",10,"A"],[12,"O",11,"A"],[13,"O",12,"A"],[14,"O",13,"A"],[0,"O"],[1,"O"],[2,"O"],[3,"O"],[4,"O"],[19,"B",5,"A"],[15,"B",6,"A"],[16,"B",7,"A"],[17,"B",8,"A"],[18,"B",9,"A"]];for(let $=0;$<20;$++){if(b=this.IDATA.face[$],h=b[2],f=b[1],u=b[0],T=d.x+"|"+d.y,R=$+"|"+T,R in t||(t[R]=h,O[h]=[b[L[T][0]],L[T][1]]),T=_.x+"|"+_.y,R=$+"|"+T,R in t||(t[R]=f,O[f]=[b[L[T][0]],L[T][1]]),T=p.x+"|"+p.y,R=$+"|"+T,R in t||(t[R]=u,O[u]=[b[L[T][0]],L[T][1]]),l=this.IDATA.edgematch[$][0],c=this.IDATA.edgematch[$][1],c==="B")for(let J=1;J<s;J++)E.x=i-J*(n+o),E.y=r+J*n,v.x=-J*o,v.y=J*(n+o),T=E.x+"|"+E.y,I=v.x+"|"+v.y,w($,l,T,I);if(c==="O")for(let J=1;J<s;J++)v.x=-J*o,v.y=J*(n+o),g.x=J*n,g.y=J*o,T=v.x+"|"+v.y,I=g.x+"|"+g.y,w($,l,T,I);if(l=this.IDATA.edgematch[$][2],c=this.IDATA.edgematch[$][3],c&&c==="A")for(let J=1;J<s;J++)g.x=J*n,g.y=J*o,E.x=i-(s-J)*(n+o),E.y=r+(s-J)*n,T=g.x+"|"+g.y,I=E.x+"|"+E.y,w($,l,T,I);for(let J=0;J<this.vertices.length;J++)T=this.vertices[J].x+"|"+this.vertices[J].y,R=$+"|"+T,R in t||(t[R]=e++,L[T][0]>2?O[t[R]]=[-L[T][0],L[T][1],t[R]]:O[t[R]]=[b[L[T][0]],L[T][1],t[R]])}this.closestTo=O,this.vecToidx=t}calcCoeffs(){const e=this.m,t=this.n,i=Math.sqrt(3)/3,r=e*e+t*t+e*t;this.coau=(e+t)/r,this.cobu=-t/r,this.coav=-i*(e-t)/r,this.cobv=i*(2*e+t)/r}createInnerFacets(){const e=this.m,t=this.n;for(let i=0;i<t+e+1;i++)for(let r=this.min[i];r<this.max[i]+1;r++)r<this.max[i]&&r<this.max[i+1]+1&&this.innerFacets.push(["|"+r+"|"+i,"|"+r+"|"+(i+1),"|"+(r+1)+"|"+i]),i>0&&r<this.max[i-1]&&r+1<this.max[i]+1&&this.innerFacets.push(["|"+r+"|"+i,"|"+(r+1)+"|"+i,"|"+(r+1)+"|"+(i-1)])}edgeVecsABOB(){const e=this.m,t=this.n,i=new Ct(-t,e+t);for(let r=1;r<e+t;r++){const s=new Ct(this.min[r],r),n=new Ct(this.min[r-1],r-1),o=new Ct(this.min[r+1],r+1),l=s.clone(),c=n.clone(),h=o.clone();l.rotate60About(i),c.rotate60About(i),h.rotate60About(i);const f=new Ct(this.max[l.y],l.y),u=new Ct(this.max[l.y-1],l.y-1),d=new Ct(this.max[l.y-1]-1,l.y-1);(l.x!==f.x||l.y!==f.y)&&(l.x!==u.x?(this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([s,u,d]),this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([s,d,f])):l.y===h.y?(this.vertexTypes.push([1,1,0]),this.isoVecsABOB.push([s,n,u]),this.vertexTypes.push([1,0,1]),this.isoVecsABOB.push([s,u,o])):(this.vertexTypes.push([1,1,0]),this.isoVecsABOB.push([s,n,u]),this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([s,u,f])))}}mapABOBtoOBOA(){const e=new Ct(0,0);for(let t=0;t<this.isoVecsABOB.length;t++){const i=[];for(let r=0;r<3;r++)e.x=this.isoVecsABOB[t][r].x,e.y=this.isoVecsABOB[t][r].y,this.vertexTypes[t][r]===0&&e.rotateNeg120(this.m,this.n),i.push(e.clone());this.isoVecsOBOA.push(i)}}mapABOBtoBAOA(){const e=new Ct(0,0);for(let t=0;t<this.isoVecsABOB.length;t++){const i=[];for(let r=0;r<3;r++)e.x=this.isoVecsABOB[t][r].x,e.y=this.isoVecsABOB[t][r].y,this.vertexTypes[t][r]===1&&e.rotate120(this.m,this.n),i.push(e.clone());this.isoVecsBAOA.push(i)}}MapToFace(e,t){const i=this.IDATA.face[e],r=i[2],s=i[1],n=i[0],o=m.FromArray(this.IDATA.vertex[r]),l=m.FromArray(this.IDATA.vertex[s]),c=m.FromArray(this.IDATA.vertex[n]),h=l.subtract(o),f=c.subtract(o),u=h.scale(this.coau).add(f.scale(this.cobu)),d=h.scale(this.coav).add(f.scale(this.cobv));let _,p=F.Vector3[0];for(let g=0;g<this.cartesian.length;g++)p=u.scale(this.cartesian[g].x).add(d.scale(this.cartesian[g].y)).add(o),p.x,p.y,p.z,_=e+"|"+this.vertices[g].x+"|"+this.vertices[g].y,t.vertex[this.vecToidx[_]]=[p.x,p.y,p.z]}build(e,t){const i=[],r=Ct.Zero(),s=new Ct(e,t),n=new Ct(-t,e+t);i.push(r,s,n);for(let S=t;S<e+1;S++)for(let T=0;T<e+1-S;T++)i.push(new Ct(T,S));if(t>0){const S=Rn(e,t),T=e/S,I=t/S;for(let L=1;L<S;L++)i.push(new Ct(L*T,L*I)),i.push(new Ct(-L*I,L*(T+I))),i.push(new Ct(e-L*(T+I),t+L*T));const O=e/t;for(let L=1;L<t;L++)for(let w=0;w<L*O;w++)i.push(new Ct(w,L)),i.push(new Ct(w,L).rotate120(e,t)),i.push(new Ct(w,L).rotateNeg120(e,t))}i.sort((S,T)=>S.x-T.x),i.sort((S,T)=>S.y-T.y);const o=new Array(e+t+1),l=new Array(e+t+1);for(let S=0;S<o.length;S++)o[S]=1/0,l[S]=-1/0;let c=0,h=0;const f=i.length;for(let S=0;S<f;S++)h=i[S].x,c=i[S].y,o[c]=Math.min(h,o[c]),l[c]=Math.max(h,l[c]);const u=(S,T)=>{const I=S.clone();return T==="A"&&I.rotateNeg120(e,t),T==="B"&&I.rotate120(e,t),I.x<0?I.y:I.x+I.y},d=[],_=[],p=[],g=[],E={},v=[];let b=-1,R=-1;for(let S=0;S<f;S++)d[S]=i[S].toCartesianOrigin(new Ct(0,0),.5),_[S]=u(i[S],"O"),p[S]=u(i[S],"A"),g[S]=u(i[S],"B"),_[S]===p[S]&&p[S]===g[S]?(b=3,R=_[S]):_[S]===p[S]?(b=4,R=_[S]):p[S]===g[S]?(b=5,R=p[S]):g[S]===_[S]&&(b=6,R=_[S]),_[S]<p[S]&&_[S]<g[S]&&(b=2,R=_[S]),p[S]<_[S]&&p[S]<g[S]&&(b=1,R=p[S]),g[S]<p[S]&&g[S]<_[S]&&(b=0,R=g[S]),v.push([b,R,i[S].x,i[S].y]);v.sort((S,T)=>S[2]-T[2]),v.sort((S,T)=>S[3]-T[3]),v.sort((S,T)=>S[1]-T[1]),v.sort((S,T)=>S[0]-T[0]);for(let S=0;S<v.length;S++)E[v[S][2]+"|"+v[S][3]]=[v[S][0],v[S][1],S];return this.m=e,this.n=t,this.vertices=i,this.vertByDist=E,this.cartesian=d,this.min=o,this.max=l,this}}class Tl{constructor(e,t,i,r){this.name=e,this.category=t,this.vertex=i,this.face=r}}class vo extends Tl{innerToData(e,t){for(let i=0;i<t.innerFacets.length;i++)this.face.push(t.innerFacets[i].map(r=>t.vecToidx[e+r]))}mapABOBtoDATA(e,t){const i=t.IDATA.edgematch[e][0];for(let r=0;r<t.isoVecsABOB.length;r++){const s=[];for(let n=0;n<3;n++)t.vertexTypes[r][n]===0?s.push(e+"|"+t.isoVecsABOB[r][n].x+"|"+t.isoVecsABOB[r][n].y):s.push(i+"|"+t.isoVecsABOB[r][n].x+"|"+t.isoVecsABOB[r][n].y);this.face.push([t.vecToidx[s[0]],t.vecToidx[s[1]],t.vecToidx[s[2]]])}}mapOBOAtoDATA(e,t){const i=t.IDATA.edgematch[e][0];for(let r=0;r<t.isoVecsOBOA.length;r++){const s=[];for(let n=0;n<3;n++)t.vertexTypes[r][n]===1?s.push(e+"|"+t.isoVecsOBOA[r][n].x+"|"+t.isoVecsOBOA[r][n].y):s.push(i+"|"+t.isoVecsOBOA[r][n].x+"|"+t.isoVecsOBOA[r][n].y);this.face.push([t.vecToidx[s[0]],t.vecToidx[s[1]],t.vecToidx[s[2]]])}}mapBAOAtoDATA(e,t){const i=t.IDATA.edgematch[e][2];for(let r=0;r<t.isoVecsBAOA.length;r++){const s=[];for(let n=0;n<3;n++)t.vertexTypes[r][n]===1?s.push(e+"|"+t.isoVecsBAOA[r][n].x+"|"+t.isoVecsBAOA[r][n].y):s.push(i+"|"+t.isoVecsBAOA[r][n].x+"|"+t.isoVecsBAOA[r][n].y);this.face.push([t.vecToidx[s[0]],t.vecToidx[s[1]],t.vecToidx[s[2]]])}}orderData(e){const t=[];for(let n=0;n<13;n++)t[n]=[];const i=e.closestTo;for(let n=0;n<i.length;n++)i[n][0]>-1?i[n][1]>0&&t[i[n][0]].push([n,i[n][1]]):t[12].push([n,i[n][0]]);const r=[];for(let n=0;n<12;n++)r[n]=n;let s=12;for(let n=0;n<12;n++){t[n].sort((o,l)=>o[1]-l[1]);for(let o=0;o<t[n].length;o++)r[t[n][o][0]]=s++}for(let n=0;n<t[12].length;n++)r[t[12][n][0]]=s++;for(let n=0;n<this.vertex.length;n++)this.vertex[n].push(r[n]);this.vertex.sort((n,o)=>n[3]-o[3]);for(let n=0;n<this.vertex.length;n++)this.vertex[n].pop();for(let n=0;n<this.face.length;n++)for(let o=0;o<this.face[n].length;o++)this.face[n][o]=r[this.face[n][o]];this.sharedNodes=t[12].length,this.poleNodes=this.vertex.length-this.sharedNodes}setOrder(e,t){const i=[],r=[];let s=t.pop();r.push(s);let n=this.face[s].indexOf(e);n=(n+2)%3;let o=this.face[s][n];i.push(o);let l=0;for(;t.length>0;)s=t[l],this.face[s].indexOf(o)>-1?(n=(this.face[s].indexOf(o)+1)%3,o=this.face[s][n],i.push(o),r.push(s),t.splice(l,1),l=0):l++;return this.adjacentFaces.push(i),r}toGoldbergPolyhedronData(){const e=new Tl("GeoDual","Goldberg",[],[]);e.name="GD dual";const t=this.vertex.length,i=new Array(t);for(let c=0;c<t;c++)i[c]=[];for(let c=0;c<this.face.length;c++)for(let h=0;h<3;h++)i[this.face[c][h]].push(c);let r=0,s=0,n=0,o=[],l=[];this.adjacentFaces=[];for(let c=0;c<i.length;c++)e.face[c]=this.setOrder(c,i[c].concat([])),i[c].forEach(h=>{r=0,s=0,n=0,o=this.face[h];for(let f=0;f<3;f++)l=this.vertex[o[f]],r+=l[0],s+=l[1],n+=l[2];e.vertex[h]=[r/3,s/3,n/3]});return e}static BuildGeodesicData(e){const t=new vo("Geodesic-m-n","Geodesic",[[0,wt,-1],[-wt,1,0],[-1,0,-wt],[1,0,-wt],[wt,1,0],[0,wt,1],[-1,0,wt],[-wt,-1,0],[0,-wt,-1],[wt,-1,0],[1,0,wt],[0,-wt,1]],[]);e.setIndices(),e.calcCoeffs(),e.createInnerFacets(),e.edgeVecsABOB(),e.mapABOBtoOBOA(),e.mapABOBtoBAOA();for(let r=0;r<e.IDATA.face.length;r++)e.MapToFace(r,t),t.innerToData(r,e),e.IDATA.edgematch[r][1]==="B"&&t.mapABOBtoDATA(r,e),e.IDATA.edgematch[r][1]==="O"&&t.mapOBOAtoDATA(r,e),e.IDATA.edgematch[r][3]==="A"&&t.mapBAOAtoDATA(r,e);t.orderData(e);const i=1;return t.vertex=t.vertex.map(function(r){const s=r[0],n=r[1],o=r[2],l=Math.sqrt(s*s+n*n+o*o);return r[0]*=i/l,r[1]*=i/l,r[2]*=i/l,r}),t}}function Kb(a,e,t=null){let i=e.m||1;i!==Math.floor(i)&&(i=Math.floor(i),B.Warn("m not an integer only floor(m) used"));let r=e.n||0;if(r!==Math.floor(r)&&(r=Math.floor(r),B.Warn("n not an integer only floor(n) used")),r>i){const c=r;r=i,i=c,B.Warn("n > m therefore m and n swapped")}const s=new _E;s.build(i,r);const o={custom:vo.BuildGeodesicData(s),size:e.size,sizeX:e.sizeX,sizeY:e.sizeY,sizeZ:e.sizeZ,faceUV:e.faceUV,faceColors:e.faceColors,flat:e.flat,updatable:e.updatable,sideOrientation:e.sideOrientation,frontUVs:e.frontUVs,backUVs:e.backUVs};return hh(a,o,t)}N._GoldbergMeshParser=(a,e)=>To.Parse(a,e);class To extends N{constructor(){super(...arguments),this.goldbergData={faceColors:[],faceCenters:[],faceZaxis:[],faceXaxis:[],faceYaxis:[],nbSharedFaces:0,nbUnsharedFaces:0,nbFaces:0,nbFacesAtPole:0,adjacentFaces:[]}}relatedGoldbergFace(e,t){return t===void 0?(e>this.goldbergData.nbUnsharedFaces-1&&(B.Warn("Maximum number of unshared faces used"),e=this.goldbergData.nbUnsharedFaces-1),this.goldbergData.nbUnsharedFaces+e):(e>11&&(B.Warn("Last pole used"),e=11),t>this.goldbergData.nbFacesAtPole-1&&(B.Warn("Maximum number of faces at a pole used"),t=this.goldbergData.nbFacesAtPole-1),12+e*this.goldbergData.nbFacesAtPole+t)}_changeGoldbergFaceColors(e){for(let i=0;i<e.length;i++){const r=e[i][0],s=e[i][1],n=e[i][2];for(let o=r;o<s+1;o++)this.goldbergData.faceColors[o]=n}const t=[];for(let i=0;i<12;i++)for(let r=0;r<5;r++)t.push(this.goldbergData.faceColors[i].r,this.goldbergData.faceColors[i].g,this.goldbergData.faceColors[i].b,this.goldbergData.faceColors[i].a);for(let i=12;i<this.goldbergData.faceColors.length;i++)for(let r=0;r<6;r++)t.push(this.goldbergData.faceColors[i].r,this.goldbergData.faceColors[i].g,this.goldbergData.faceColors[i].b,this.goldbergData.faceColors[i].a);return t}setGoldbergFaceColors(e){const t=this._changeGoldbergFaceColors(e);this.setVerticesData(x.ColorKind,t)}updateGoldbergFaceColors(e){const t=this._changeGoldbergFaceColors(e);this.updateVerticesData(x.ColorKind,t)}_changeGoldbergFaceUVs(e){const t=this.getVerticesData(x.UVKind);for(let i=0;i<e.length;i++){const r=e[i][0],s=e[i][1],n=e[i][2],o=e[i][3],l=e[i][4],c=[],h=[];let f,u;for(let d=0;d<5;d++)f=n.x+o*Math.cos(l+d*Math.PI/2.5),u=n.y+o*Math.sin(l+d*Math.PI/2.5),f<0&&(f=0),f>1&&(f=1),c.push(f,u);for(let d=0;d<6;d++)f=n.x+o*Math.cos(l+d*Math.PI/3),u=n.y+o*Math.sin(l+d*Math.PI/3),f<0&&(f=0),f>1&&(f=1),h.push(f,u);for(let d=r;d<Math.min(12,s+1);d++)for(let _=0;_<5;_++)t[10*d+2*_]=c[2*_],t[10*d+2*_+1]=c[2*_+1];for(let d=Math.max(12,r);d<s+1;d++)for(let _=0;_<6;_++)t[12*d-24+2*_]=h[2*_],t[12*d-23+2*_]=h[2*_+1]}return t}setGoldbergFaceUVs(e){const t=this._changeGoldbergFaceUVs(e);this.setVerticesData(x.UVKind,t)}updateGoldbergFaceUVs(e){const t=this._changeGoldbergFaceUVs(e);this.updateVerticesData(x.UVKind,t)}placeOnGoldbergFaceAt(e,t,i){const r=m.RotationFromAxis(this.goldbergData.faceXaxis[t],this.goldbergData.faceYaxis[t],this.goldbergData.faceZaxis[t]);e.rotation=r,e.position=this.goldbergData.faceCenters[t].add(this.goldbergData.faceXaxis[t].scale(i.x)).add(this.goldbergData.faceYaxis[t].scale(i.y)).add(this.goldbergData.faceZaxis[t].scale(i.z))}serialize(e){super.serialize(e),e.type="GoldbergMesh";const t={};if(t.adjacentFaces=this.goldbergData.adjacentFaces,t.nbSharedFaces=this.goldbergData.nbSharedFaces,t.nbUnsharedFaces=this.goldbergData.nbUnsharedFaces,t.nbFaces=this.goldbergData.nbFaces,t.nbFacesAtPole=this.goldbergData.nbFacesAtPole,this.goldbergData.faceColors){t.faceColors=[];for(const i of this.goldbergData.faceColors)t.faceColors.push(i.asArray())}if(this.goldbergData.faceCenters){t.faceCenters=[];for(const i of this.goldbergData.faceCenters)t.faceCenters.push(i.asArray())}if(this.goldbergData.faceZaxis){t.faceZaxis=[];for(const i of this.goldbergData.faceZaxis)t.faceZaxis.push(i.asArray())}if(this.goldbergData.faceYaxis){t.faceYaxis=[];for(const i of this.goldbergData.faceYaxis)t.faceYaxis.push(i.asArray())}if(this.goldbergData.faceXaxis){t.faceXaxis=[];for(const i of this.goldbergData.faceXaxis)t.faceXaxis.push(i.asArray())}e.goldbergData=t}static Parse(e,t){const i=e.goldbergData;i.faceColors=i.faceColors.map(s=>Ne.FromArray(s)),i.faceCenters=i.faceCenters.map(s=>m.FromArray(s)),i.faceZaxis=i.faceZaxis.map(s=>m.FromArray(s)),i.faceXaxis=i.faceXaxis.map(s=>m.FromArray(s)),i.faceYaxis=i.faceYaxis.map(s=>m.FromArray(s));const r=new To(e.name,t);return r.goldbergData=i,r}}function qb(a,e){const t=a.size,i=a.sizeX||t||1,r=a.sizeY||t||1,s=a.sizeZ||t||1,n=a.sideOrientation===0?0:a.sideOrientation||ee.DEFAULTSIDE,o=[],l=[],c=[],h=[];let f=1/0,u=-1/0,d=1/0,_=-1/0;for(let E=0;E<e.vertex.length;E++)f=Math.min(f,e.vertex[E][0]*i),u=Math.max(u,e.vertex[E][0]*i),d=Math.min(d,e.vertex[E][1]*r),_=Math.max(_,e.vertex[E][1]*r);let p=0;for(let E=0;E<e.face.length;E++){const v=e.face[E],b=m.FromArray(e.vertex[v[0]]),R=m.FromArray(e.vertex[v[2]]),S=m.FromArray(e.vertex[v[1]]),T=R.subtract(b),I=S.subtract(b),O=m.Cross(I,T).normalize();for(let L=0;L<v.length;L++){c.push(O.x,O.y,O.z);const w=e.vertex[v[L]];o.push(w[0]*i,w[1]*r,w[2]*s);const $=(w[1]*r-d)/(_-d);h.push((w[0]*i-f)/(u-f),$)}for(let L=0;L<v.length-2;L++)l.push(p,p+L+2,p+L+1);p+=v.length}ee._ComputeSides(n,o,l,c,h);const g=new ee;return g.positions=o,g.indices=l,g.normals=c,g.uvs=h,g}function jb(a,e,t=null){const i=e.size,r=e.sizeX||i||1,s=e.sizeY||i||1,n=e.sizeZ||i||1;let o=e.m||1;o!==Math.floor(o)&&(o=Math.floor(o),B.Warn("m not an integer only floor(m) used"));let l=e.n||0;if(l!==Math.floor(l)&&(l=Math.floor(l),B.Warn("n not an integer only floor(n) used")),l>o){const _=l;l=o,o=_,B.Warn("n > m therefore m and n swapped")}const c=new _E;c.build(o,l);const h=vo.BuildGeodesicData(c),f=h.toGoldbergPolyhedronData(),u=new To(a,t);e.sideOrientation=N._GetDefaultSideOrientation(e.sideOrientation),u._originalBuilderSideOrientation=e.sideOrientation,qb(e,f).applyToMesh(u,e.updatable),u.goldbergData.nbSharedFaces=h.sharedNodes,u.goldbergData.nbUnsharedFaces=h.poleNodes,u.goldbergData.adjacentFaces=h.adjacentFaces,u.goldbergData.nbFaces=u.goldbergData.nbSharedFaces+u.goldbergData.nbUnsharedFaces,u.goldbergData.nbFacesAtPole=(u.goldbergData.nbUnsharedFaces-12)/12;for(let _=0;_<h.vertex.length;_++)u.goldbergData.faceCenters.push(m.FromArray(h.vertex[_])),u.goldbergData.faceCenters[_].x*=r,u.goldbergData.faceCenters[_].y*=s,u.goldbergData.faceCenters[_].z*=n,u.goldbergData.faceColors.push(new Ne(1,1,1,1));for(let _=0;_<f.face.length;_++){const p=f.face[_],g=m.FromArray(f.vertex[p[0]]),E=m.FromArray(f.vertex[p[2]]),v=m.FromArray(f.vertex[p[1]]),b=E.subtract(g),R=v.subtract(g),S=m.Cross(R,b).normalize(),T=m.Cross(R,S).normalize();u.goldbergData.faceXaxis.push(R.normalize()),u.goldbergData.faceYaxis.push(S),u.goldbergData.faceZaxis.push(T)}return u}class Zb{constructor(e){this._paths=[],this._tempPaths=[],this._holes=[],this._resolution=e}moveTo(e,t){this._currentPath=new ka(e,t),this._tempPaths.push(this._currentPath)}lineTo(e,t){this._currentPath.addLineTo(e,t)}quadraticCurveTo(e,t,i,r){this._currentPath.addQuadraticCurveTo(e,t,i,r,this._resolution)}bezierCurveTo(e,t,i,r,s,n){this._currentPath.addBezierCurveTo(e,t,i,r,s,n,this._resolution)}extractHoles(){for(const e of this._tempPaths)e.area()>0?this._holes.push(e):this._paths.push(e);if(!this._paths.length&&this._holes.length){const e=this._holes;this._holes=this._paths,this._paths=e}this._tempPaths.length=0}get paths(){return this._paths}get holes(){return this._holes}}function Qb(a,e,t,i,r,s){const n=s.glyphs[a]||s.glyphs["?"];if(!n)return null;const o=new Zb(r);if(n.o){const l=n.o.split(" ");for(let c=0,h=l.length;c<h;)switch(l[c++]){case"m":{const u=parseInt(l[c++])*e+t,d=parseInt(l[c++])*e+i;o.moveTo(u,d);break}case"l":{const u=parseInt(l[c++])*e+t,d=parseInt(l[c++])*e+i;o.lineTo(u,d);break}case"q":{const u=parseInt(l[c++])*e+t,d=parseInt(l[c++])*e+i,_=parseInt(l[c++])*e+t,p=parseInt(l[c++])*e+i;o.quadraticCurveTo(_,p,u,d);break}case"b":{const u=parseInt(l[c++])*e+t,d=parseInt(l[c++])*e+i,_=parseInt(l[c++])*e+t,p=parseInt(l[c++])*e+i,g=parseInt(l[c++])*e+t,E=parseInt(l[c++])*e+i;o.bezierCurveTo(_,p,g,E,u,d);break}}}return o.extractHoles(),{offsetX:n.ha*e,shapePath:o}}function $b(a,e,t,i){const r=Array.from(a),s=e/i.resolution,n=(i.boundingBox.yMax-i.boundingBox.yMin+i.underlineThickness)*s,o=[];let l=0,c=0;for(let h=0;h<r.length;h++){const f=r[h];if(f===`
`)l=0,c-=n;else{const u=Qb(f,s,l,c,t,i);u&&(l+=u.offsetX,o.push(u.shapePath))}}return o}function Jb(a,e,t,i={size:50,resolution:8,depth:1},r=null,s=earcut){var h,f;const n=$b(e,i.size||50,i.resolution||8,t),o=[];let l=0;for(const u of n){if(!u.paths.length)continue;const d=u.holes.slice();for(const _ of u.paths){const p=[],g=[],E=_.getPoints();for(const R of E)g.push(new m(R.x,0,R.y));const v=d.slice();for(const R of v){const S=R.getPoints();let T=!1;for(const O of S)if(_.isPointInside(O)){T=!0;break}if(!T)continue;const I=[];for(const O of S)I.push(new m(O.x,0,O.y));p.push(I),d.splice(d.indexOf(R),1)}if(!p.length&&d.length)for(const R of d){const S=R.getPoints(),T=[];for(const I of S)T.push(new m(I.x,0,I.y));p.push(T)}const b=ch(a,{shape:g,holes:p.length?p:void 0,depth:i.depth||1,faceUV:i.faceUV||((h=i.perLetterFaceUV)==null?void 0:h.call(i,l)),faceColors:i.faceColors||((f=i.perLetterFaceColors)==null?void 0:f.call(i,l)),sideOrientation:N._GetDefaultSideOrientation(i.sideOrientation||N.DOUBLESIDE)},r,s);o.push(b),l++}}const c=N.MergeMeshes(o,!0,!0);if(c){const u=c.getBoundingInfo().boundingBox;c.position.x+=-(u.minimumWorld.x+u.maximumWorld.x)/2,c.position.y+=-(u.minimumWorld.y+u.maximumWorld.y)/2,c.position.z+=-(u.minimumWorld.z+u.maximumWorld.z)/2+u.extendSize.z,c.name=a;const d=new we("pivot",r);d.rotation.x=-Math.PI/2,c.parent=d,c.bakeCurrentTransformIntoVertices(),c.parent=null,d.dispose()}return c}const UL={CreateBox:Ya,CreateTiledBox:Ub,CreateSphere:Dn,CreateDisc:eE,CreateIcoSphere:ya,CreateRibbon:Is,CreateCylinder:oo,CreateTorus:Rs,CreateTorusKnot:rE,CreateLineSystem:Xg,CreateLines:th,CreateDashedLines:Hg,ExtrudeShape:nE,ExtrudeShapeCustom:aE,CreateLathe:lE,CreateTiledPlane:Bb,CreatePlane:Vc,CreateGround:za,CreateTiledGround:dg,CreateGroundFromHeightMap:_g,CreatePolygon:lh,ExtrudePolygon:ch,CreateTube:cE,CreatePolyhedron:hh,CreateGeodesic:Kb,CreateGoldberg:jb,CreateDecal:fE,CreateCapsule:dE,CreateText:Jb};class pE{getClassName(){return"TargetedAnimation"}serialize(){const e={};return e.animation=this.animation.serialize(),e.targetId=this.target.id,e}}class cr{get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this.syncWithMask(!0))}syncWithMask(e=!1){if(!this.mask&&!e){this._numActiveAnimatables=this._targetedAnimations.length;return}this._numActiveAnimatables=0;for(let t=0;t<this._animatables.length;++t){const i=this._animatables[t];!this.mask||this.mask.disabled||this.mask.retainsTarget(i.target.name)?(this._numActiveAnimatables++,i.paused&&i.restart()):i.paused||i.pause()}}removeUnmaskedAnimations(){if(!(!this.mask||this.mask.disabled)){for(let e=0;e<this._animatables.length;++e){const t=this._animatables[e];this.mask.retainsTarget(t.target.name)||(t.stop(),this._animatables.splice(e,1),--e)}for(let e=0;e<this._targetedAnimations.length;e++){const t=this._targetedAnimations[e];this.mask.retainsTarget(t.target.name)||(this._targetedAnimations.splice(e,1),--e)}}}get from(){return this._from}set from(e){if(this._from!==e){this._from=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.fromFrame=this._from}}}get to(){return this._to}set to(e){if(this._to!==e){this._to=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.toFrame=this._to}}}get isStarted(){return this._isStarted}get isPlaying(){return this._isStarted&&!this._isPaused}get speedRatio(){return this._speedRatio}set speedRatio(e){if(this._speedRatio!==e){this._speedRatio=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.speedRatio=this._speedRatio}}}get loopAnimation(){return this._loopAnimation}set loopAnimation(e){if(this._loopAnimation!==e){this._loopAnimation=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.loopAnimation=this._loopAnimation}}}get isAdditive(){return this._isAdditive}set isAdditive(e){if(this._isAdditive!==e){this._isAdditive=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.isAdditive=this._isAdditive}}}get weight(){return this._weight}set weight(e){this._weight!==e&&(this._weight=e,this.setWeightForAllAnimatables(this._weight))}get targetedAnimations(){return this._targetedAnimations}get animatables(){return this._animatables}get children(){return this._targetedAnimations}get playOrder(){return this._playOrder}set playOrder(e){if(this._playOrder!==e&&(this._playOrder=e,this._animatables.length>0)){for(let t=0;t<this._animatables.length;t++)this._animatables[t].playOrder=this._playOrder;this._scene.sortActiveAnimatables()}}get enableBlending(){return this._enableBlending}set enableBlending(e){if(this._enableBlending!==e&&(this._enableBlending=e,e!==null))for(let t=0;t<this._targetedAnimations.length;++t)this._targetedAnimations[t].animation.enableBlending=e}get blendingSpeed(){return this._blendingSpeed}set blendingSpeed(e){if(this._blendingSpeed!==e&&(this._blendingSpeed=e,e!==null))for(let t=0;t<this._targetedAnimations.length;++t)this._targetedAnimations[t].animation.blendingSpeed=e}getLength(e,t){e=e??this._from,t=t??this._to;const i=this.targetedAnimations[0].animation.framePerSecond*this._speedRatio;return(t-e)/i}static MergeAnimationGroups(e,t=!0,i=!1,r){if(e.length===0)return null;r=r??e[0].weight;let s=Number.MAX_VALUE,n=-Number.MAX_VALUE;if(i)for(const l of e)l.from<s&&(s=l.from),l.to>n&&(n=l.to);const o=new cr(e[0].name+"_merged",e[0]._scene,r);for(const l of e){i&&l.normalize(s,n);for(const c of l.targetedAnimations)o.addTargetedAnimation(c.animation,c.target);t&&l.dispose()}return o}constructor(e,t=null,i=-1,r=0){this.name=e,this._targetedAnimations=new Array,this._animatables=new Array,this._from=Number.MAX_VALUE,this._to=-Number.MAX_VALUE,this._speedRatio=1,this._loopAnimation=!1,this._isAdditive=!1,this._weight=-1,this._playOrder=0,this._enableBlending=null,this._blendingSpeed=null,this._numActiveAnimatables=0,this._shouldStart=!0,this._parentContainer=null,this.onAnimationEndObservable=new U,this.onAnimationLoopObservable=new U,this.onAnimationGroupLoopObservable=new U,this.onAnimationGroupEndObservable=new U,this.onAnimationGroupPauseObservable=new U,this.onAnimationGroupPlayObservable=new U,this.metadata=null,this._mask=null,this._animationLoopFlags=[],this._scene=t||Re.LastCreatedScene,this._weight=i,this._playOrder=r,this.uniqueId=this._scene.getUniqueId(),this._scene.addAnimationGroup(this)}addTargetedAnimation(e,t){const i=new pE;i.animation=e,i.target=t;const r=e.getKeys();return this._from>r[0].frame&&(this._from=r[0].frame),this._to<r[r.length-1].frame&&(this._to=r[r.length-1].frame),this._enableBlending!==null&&(e.enableBlending=this._enableBlending),this._blendingSpeed!==null&&(e.blendingSpeed=this._blendingSpeed),this._targetedAnimations.push(i),this._shouldStart=!0,i}removeTargetedAnimation(e){for(let t=this._targetedAnimations.length-1;t>-1;t--)this._targetedAnimations[t].animation===e&&this._targetedAnimations.splice(t,1)}normalize(e=null,t=null){e==null&&(e=this._from),t==null&&(t=this._to);for(let i=0;i<this._targetedAnimations.length;i++){const s=this._targetedAnimations[i].animation.getKeys(),n=s[0],o=s[s.length-1];if(n.frame>e){const l={frame:e,value:n.value,inTangent:n.inTangent,outTangent:n.outTangent,interpolation:n.interpolation};s.splice(0,0,l)}if(o.frame<t){const l={frame:t,value:o.value,inTangent:o.inTangent,outTangent:o.outTangent,interpolation:o.interpolation};s.push(l)}}return this._from=e,this._to=t,this}_processLoop(e,t,i){e.onAnimationLoop=()=>{this.onAnimationLoopObservable.notifyObservers(t),!this._animationLoopFlags[i]&&(this._animationLoopFlags[i]=!0,this._animationLoopCount++,this._animationLoopCount===this._numActiveAnimatables&&(this.onAnimationGroupLoopObservable.notifyObservers(this),this._animationLoopCount=0,this._animationLoopFlags.length=0))}}start(e=!1,t=1,i,r,s){if(this._isStarted||this._targetedAnimations.length===0)return this;this._loopAnimation=e,this._shouldStart=!1,this._animationLoopCount=0,this._animationLoopFlags.length=0;for(let n=0;n<this._targetedAnimations.length;n++){const o=this._targetedAnimations[n],l=this._scene.beginDirectAnimation(o.target,[o.animation],i!==void 0?i:this._from,r!==void 0?r:this._to,e,t,void 0,void 0,s!==void 0?s:this._isAdditive);l.weight=this._weight,l.playOrder=this._playOrder,l.onAnimationEnd=()=>{this.onAnimationEndObservable.notifyObservers(o),this._checkAnimationGroupEnded(l)},this._processLoop(l,o,n),this._animatables.push(l)}return this.syncWithMask(),this._scene.sortActiveAnimatables(),this._speedRatio=t,this._isStarted=!0,this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}pause(){if(!this._isStarted)return this;this._isPaused=!0;for(let e=0;e<this._animatables.length;e++)this._animatables[e].pause();return this.onAnimationGroupPauseObservable.notifyObservers(this),this}play(e){return this.isStarted&&this._animatables.length&&!this._shouldStart?(e!==void 0&&(this.loopAnimation=e),this.restart()):(this.stop(),this.start(e,this._speedRatio)),this}reset(){if(!this._isStarted)return this.play(),this.goToFrame(0),this.stop(!0),this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].reset();return this}restart(){if(!this._isStarted)return this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].restart();return this.syncWithMask(),this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}stop(e=!1){if(!this._isStarted)return this;const t=this._animatables.slice();for(let r=0;r<t.length;r++)t[r].stop(void 0,void 0,!0,e);let i=0;for(let r=0;r<this._scene._activeAnimatables.length;r++){const s=this._scene._activeAnimatables[r];s._runtimeAnimations.length>0?this._scene._activeAnimatables[i++]=s:e&&this._checkAnimationGroupEnded(s,e)}return this._scene._activeAnimatables.length=i,this._isStarted=!1,this}setWeightForAllAnimatables(e){for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.weight=e}return this}syncAllAnimationsWith(e){for(let t=0;t<this._animatables.length;t++)this._animatables[t].syncWith(e);return this}goToFrame(e,t=!1){if(!this._isStarted)return this;for(let i=0;i<this._animatables.length;i++)this._animatables[i].goToFrame(e,t);return this}getCurrentFrame(){var e;return((e=this.animatables[0])==null?void 0:e.masterFrame)||0}dispose(){this.isStarted&&this.stop(),this._targetedAnimations.length=0,this._animatables.length=0;const e=this._scene.animationGroups.indexOf(this);if(e>-1&&this._scene.animationGroups.splice(e,1),this._parentContainer){const t=this._parentContainer.animationGroups.indexOf(this);t>-1&&this._parentContainer.animationGroups.splice(t,1),this._parentContainer=null}this.onAnimationEndObservable.clear(),this.onAnimationGroupEndObservable.clear(),this.onAnimationGroupPauseObservable.clear(),this.onAnimationGroupPlayObservable.clear(),this.onAnimationLoopObservable.clear(),this.onAnimationGroupLoopObservable.clear()}_checkAnimationGroupEnded(e,t=!1){const i=this._animatables.indexOf(e);i>-1&&this._animatables.splice(i,1),this._animatables.length===this._targetedAnimations.length-this._numActiveAnimatables&&(this._isStarted=!1,t||this.onAnimationGroupEndObservable.notifyObservers(this),this._animatables.length=0)}clone(e,t,i=!1){const r=new cr(e||this.name,this._scene,this._weight,this._playOrder);r._from=this.from,r._to=this.to,r._speedRatio=this.speedRatio,r._loopAnimation=this.loopAnimation,r._isAdditive=this.isAdditive,r._enableBlending=this.enableBlending,r._blendingSpeed=this.blendingSpeed,r.metadata=this.metadata,r.mask=this.mask;for(const s of this._targetedAnimations)r.addTargetedAnimation(i?s.animation.clone():s.animation,t?t(s.target):s.target);return r}serialize(){const e={};e.name=this.name,e.from=this.from,e.to=this.to,e.speedRatio=this.speedRatio,e.loopAnimation=this.loopAnimation,e.isAdditive=this.isAdditive,e.weight=this.weight,e.playOrder=this.playOrder,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,e.targetedAnimations=[];for(let t=0;t<this.targetedAnimations.length;t++){const i=this.targetedAnimations[t];e.targetedAnimations[t]=i.serialize()}return qe&&qe.HasTags(this)&&(e.tags=qe.GetTags(this)),this.metadata&&(e.metadata=this.metadata),e}static Parse(e,t){const i=new cr(e.name,t,e.weight,e.playOrder);for(let r=0;r<e.targetedAnimations.length;r++){const s=e.targetedAnimations[r],n=W.Parse(s.animation),o=s.targetId;if(s.animation.property==="influence"){const l=t.getMorphTargetById(o);l&&i.addTargetedAnimation(n,l)}else{const l=t.getNodeById(o);l!=null&&i.addTargetedAnimation(n,l)}}return qe&&qe.AddTagsTo(i,e.tags),e.from!==null&&e.to!==null&&i.normalize(e.from,e.to),e.speedRatio!==void 0&&(i._speedRatio=e.speedRatio),e.loopAnimation!==void 0&&(i._loopAnimation=e.loopAnimation),e.isAdditive!==void 0&&(i._isAdditive=e.isAdditive),e.weight!==void 0&&(i._weight=e.weight),e.playOrder!==void 0&&(i._playOrder=e.playOrder),e.enableBlending!==void 0&&(i._enableBlending=e.enableBlending),e.blendingSpeed!==void 0&&(i._blendingSpeed=e.blendingSpeed),e.metadata!==void 0&&(i.metadata=e.metadata),i}static MakeAnimationAdditive(e,t,i,r=!1,s){let n;typeof t=="object"?n=t:n={referenceFrame:t,range:i,cloneOriginalAnimationGroup:r,clonedAnimationName:s};let o=e;n.cloneOriginalAnimationGroup&&(o=e.clone(n.clonedAnimationGroupName||o.name));const l=o.targetedAnimations;for(let c=0;c<l.length;c++){const h=l[c];h.animation=W.MakeAnimationAdditive(h.animation,n)}if(o.isAdditive=!0,n.clipKeys){let c=Number.MAX_VALUE,h=-Number.MAX_VALUE;const f=o.targetedAnimations;for(let u=0;u<f.length;u++){const p=f[u].animation.getKeys();c>p[0].frame&&(c=p[0].frame),h<p[p.length-1].frame&&(h=p[p.length-1].frame)}o._from=c,o._to=h}return o}static ClipKeys(e,t,i,r,s){const n=e.clone(r||e.name);return cr.ClipKeysInPlace(n,t,i,s)}static ClipKeysInPlace(e,t,i,r){return cr.ClipInPlace(e,t,i,r,!1)}static ClipFrames(e,t,i,r,s){const n=e.clone(r||e.name);return cr.ClipFramesInPlace(n,t,i,s)}static ClipFramesInPlace(e,t,i,r){return cr.ClipInPlace(e,t,i,r,!0)}static ClipInPlace(e,t,i,r,s=!1){let n=Number.MAX_VALUE,o=-Number.MAX_VALUE;const l=e.targetedAnimations;for(let c=0;c<l.length;c++){const h=l[c],f=r?h.animation:h.animation.clone();s&&(f.createKeyForFrame(t),f.createKeyForFrame(i));const u=f.getKeys(),d=[];let _=Number.MAX_VALUE;for(let p=0;p<u.length;p++){const g=u[p];if(!s&&p>=t&&p<=i||s&&g.frame>=t&&g.frame<=i){const E={frame:g.frame,value:g.value.clone?g.value.clone():g.value,inTangent:g.inTangent,outTangent:g.outTangent,interpolation:g.interpolation,lockedTangent:g.lockedTangent};_===Number.MAX_VALUE&&(_=E.frame),E.frame-=_,d.push(E)}}if(d.length===0){l.splice(c,1),c--;continue}n>d[0].frame&&(n=d[0].frame),o<d[d.length-1].frame&&(o=d[d.length-1].frame),f.setKeys(d,!0),h.animation=f}return e._from=n,e._to=o,e}getClassName(){return"AnimationGroup"}toString(e){let t="Name: "+this.name;return t+=", type: "+this.getClassName(),e&&(t+=", from: "+this._from,t+=", to: "+this._to,t+=", isStarted: "+this._isStarted,t+=", speedRatio: "+this._speedRatio,t+=", targetedAnimations length: "+this._targetedAnimations.length,t+=", animatables length: "+this._animatables),t}}const VL=Object.freeze(Object.defineProperty({__proto__:null,AnimationGroup:cr,TargetedAnimation:pE},Symbol.toStringTag,{value:"Module"})),ex=Rn,GL={...XA,TwoPi:Math.PI*2,Sign:Math.sign,Log2:Math.log2,HCF:ex};function Sl(a){return a.split(" ").filter(e=>e!=="").map(e=>parseFloat(e))}function Qo(a,e,t){for(;t.length!==e;){const i=Sl(a.lines[a.index++]);t.push(...i)}}function tx(a,e,t){let i=0,r=0,s=0,n=0,o=0,l=0;for(let E=0;E<a.numberOfHorizontalAngles-1;E++)if(t<a.horizontalAngles[E+1]||E===a.numberOfHorizontalAngles-2){r=E,s=a.horizontalAngles[E],n=a.horizontalAngles[E+1];break}for(let E=0;E<a.numberOfVerticalAngles-1;E++)if(e<a.verticalAngles[E+1]||E===a.numberOfVerticalAngles-2){i=E,o=a.verticalAngles[E],l=a.verticalAngles[E+1];break}const c=n-s,h=l-o;if(h===0)return 0;const f=c===0?0:(t-s)/c,u=(e-o)/h,d=c===0?r:r+1,_=Qr(a.candelaValues[r][i],a.candelaValues[d][i],f),p=Qr(a.candelaValues[r][i+1],a.candelaValues[d][i+1],f);return Qr(_,p,u)}function ix(a){const i={lines:new TextDecoder("utf-8").decode(a).split(`
`),index:0},r={version:i.lines[0],candelaValues:[],horizontalAngles:[],verticalAngles:[],numberOfHorizontalAngles:0,numberOfVerticalAngles:0};for(i.index=1;i.lines.length>0&&!i.lines[i.index].includes("TILT=");)i.index++;i.lines[i.index].includes("INCLUDE"),i.index++;const s=Sl(i.lines[i.index++]);r.numberOfLights=s[0],r.lumensPerLamp=s[1],r.candelaMultiplier=s[2],r.numberOfVerticalAngles=s[3],r.numberOfHorizontalAngles=s[4],r.photometricType=s[5],r.unitsType=s[6],r.width=s[7],r.length=s[8],r.height=s[9];const n=Sl(i.lines[i.index++]);r.ballastFactor=n[0],r.fileGenerationType=n[1],r.inputWatts=n[2];for(let _=0;_<r.numberOfHorizontalAngles;_++)r.candelaValues[_]=[];Qo(i,r.numberOfVerticalAngles,r.verticalAngles),Qo(i,r.numberOfHorizontalAngles,r.horizontalAngles);for(let _=0;_<r.numberOfHorizontalAngles;_++)Qo(i,r.numberOfVerticalAngles,r.candelaValues[_]);let o=-1;for(let _=0;_<r.numberOfHorizontalAngles;_++)for(let p=0;p<r.numberOfVerticalAngles;p++)r.candelaValues[_][p]*=r.candelaValues[_][p]*r.candelaMultiplier*r.ballastFactor*r.fileGenerationType,o=Math.max(o,r.candelaValues[_][p]);if(o>0)for(let _=0;_<r.numberOfHorizontalAngles;_++)for(let p=0;p<r.numberOfVerticalAngles;p++)r.candelaValues[_][p]/=o;const l=180,c=l*2,h=c*l,f=new Float32Array(c*l),u=r.horizontalAngles[0],d=r.horizontalAngles[r.numberOfHorizontalAngles-1];for(let _=0;_<h;_++){let p=_%c;const g=Math.floor(_/c);d-u!==0&&(p<u||p>=d)&&(p%=d*2,p>d&&(p=d*2-p)),f[g+p*l]=tx(r,g,p)}return{width:c/2,height:1,data:f}}class rx{constructor(){this.supportCascades=!1}loadCubeData(){throw".ies not supported in Cube."}loadData(e,t,i){const r=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),s=ix(r);i(s.width,s.height,!1,!1,()=>{const n=t.getEngine();t.type=1,t.format=6,t._gammaSpace=!1,n._uploadDataToTextureDirectly(t,s.data)})}}const sx=Object.freeze(Object.defineProperty({__proto__:null,_IESTextureLoader:rx},Symbol.toStringTag,{value:"Module"}));function nx(){const a={cTFETC1:0,cTFETC2:1,cTFBC1:2,cTFBC3:3,cTFBC7:6,cTFPVRTC1_4_RGB:8,cTFPVRTC1_4_RGBA:9,cTFASTC_4x4:10,cTFRGB565:14};let e=null;onmessage=n=>{if(n.data.action==="init"){if(n.data.url)try{importScripts(n.data.url)}catch(o){postMessage({action:"error",error:o})}e||(e=BASIS({wasmBinary:n.data.wasmBinary})),e!==null&&e.then(o=>{BASIS=o,o.initializeBasis(),postMessage({action:"init"})})}else if(n.data.action==="transcode"){const o=n.data.config,l=n.data.imageData,c=new BASIS.BasisFile(l),h=i(c);let f=n.data.ignoreSupportedFormats?null:t(n.data.config,h),u=!1;f===null&&(u=!0,f=h.hasAlpha?a.cTFBC3:a.cTFBC1);let d=!0;c.startTranscoding()||(d=!1);const _=[];for(let p=0;p<h.images.length&&d;p++){const g=h.images[p];if(o.loadSingleImage===void 0||o.loadSingleImage===p){let E=g.levels.length;o.loadMipmapLevels===!1&&(E=1);for(let v=0;v<E;v++){const b=g.levels[v],R=r(c,p,v,f,u);if(!R){d=!1;break}b.transcodedPixels=R,_.push(b.transcodedPixels.buffer)}}}c.close(),c.delete(),u&&(f=-1),d?postMessage({action:"transcode",success:d,id:n.data.id,fileInfo:h,format:f},_):postMessage({action:"transcode",success:d,id:n.data.id})}};function t(n,o){let l=null;return n.supportedCompressionFormats&&(n.supportedCompressionFormats.astc?l=a.cTFASTC_4x4:n.supportedCompressionFormats.bc7?l=a.cTFBC7:n.supportedCompressionFormats.s3tc?l=o.hasAlpha?a.cTFBC3:a.cTFBC1:n.supportedCompressionFormats.pvrtc?l=o.hasAlpha?a.cTFPVRTC1_4_RGBA:a.cTFPVRTC1_4_RGB:n.supportedCompressionFormats.etc2?l=a.cTFETC2:n.supportedCompressionFormats.etc1?l=a.cTFETC1:l=a.cTFRGB565),l}function i(n){const o=n.getHasAlpha(),l=n.getNumImages(),c=[];for(let f=0;f<l;f++){const u={levels:[]},d=n.getNumLevels(f);for(let _=0;_<d;_++){const p={width:n.getImageWidth(f,_),height:n.getImageHeight(f,_)};u.levels.push(p)}c.push(u)}return{hasAlpha:o,images:c}}function r(n,o,l,c,h){const f=n.getImageTranscodedSizeInBytes(o,l,c);let u=new Uint8Array(f);if(!n.transcodeImage(u,o,l,c,1,0))return null;if(h){const d=n.getImageWidth(o,l)+3&-4,_=n.getImageHeight(o,l)+3&-4;u=s(u,0,d,_)}return u}function s(n,o,l,c){const h=new Uint16Array(4),f=new Uint16Array(l*c),u=l/4,d=c/4;for(let _=0;_<d;_++)for(let p=0;p<u;p++){const g=o+8*(_*u+p);h[0]=n[g]|n[g+1]<<8,h[1]=n[g+2]|n[g+3]<<8,h[2]=(2*(h[0]&31)+1*(h[1]&31))/3|(2*(h[0]&2016)+1*(h[1]&2016))/3&2016|(2*(h[0]&63488)+1*(h[1]&63488))/3&63488,h[3]=(2*(h[1]&31)+1*(h[0]&31))/3|(2*(h[1]&2016)+1*(h[0]&2016))/3&2016|(2*(h[1]&63488)+1*(h[0]&63488))/3&63488;for(let E=0;E<4;E++){const v=n[g+4+E];let b=(_*4+E)*l+p*4;f[b++]=h[v&3],f[b++]=h[v>>2&3],f[b++]=h[v>>4&3],f[b++]=h[v>>6&3]}}return f}}function ax(a,e,t){return new Promise((i,r)=>{const s=n=>{n.data.action==="init"?(a.removeEventListener("message",s),i(a)):n.data.action==="error"&&r(n.data.error||"error initializing worker")};a.addEventListener("message",s),a.postMessage({action:"init",url:t?k.GetBabylonScriptURL(t):void 0,wasmBinary:e},[e])})}var Mr;(function(a){a[a.cTFETC1=0]="cTFETC1",a[a.cTFETC2=1]="cTFETC2",a[a.cTFBC1=2]="cTFBC1",a[a.cTFBC3=3]="cTFBC3",a[a.cTFBC4=4]="cTFBC4",a[a.cTFBC5=5]="cTFBC5",a[a.cTFBC7=6]="cTFBC7",a[a.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",a[a.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",a[a.cTFASTC_4x4=10]="cTFASTC_4x4",a[a.cTFATC_RGB=11]="cTFATC_RGB",a[a.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",a[a.cTFRGBA32=13]="cTFRGBA32",a[a.cTFRGB565=14]="cTFRGB565",a[a.cTFBGR565=15]="cTFBGR565",a[a.cTFRGBA4444=16]="cTFRGBA4444",a[a.cTFFXT1_RGB=17]="cTFFXT1_RGB",a[a.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",a[a.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",a[a.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",a[a.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"})(Mr||(Mr={}));const is={JSModuleURL:`${k._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${k._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`},ox=(a,e)=>{let t;switch(a){case Mr.cTFETC1:t=36196;break;case Mr.cTFBC1:t=33776;break;case Mr.cTFBC4:t=33779;break;case Mr.cTFASTC_4x4:t=37808;break;case Mr.cTFETC2:t=37496;break;case Mr.cTFBC7:t=36492;break}if(t===void 0)throw"The chosen Basis transcoder format is not currently supported";return t};let $o=null,gs=null,lx=0;const cx=!1,hx=()=>($o||($o=new Promise((a,e)=>{gs?a(gs):k.LoadFileAsync(k.GetBabylonScriptURL(is.WasmModuleURL)).then(t=>{if(typeof URL!="function")return e("Basis transcoder requires an environment with a URL constructor");const i=URL.createObjectURL(new Blob([`(${nx})()`],{type:"application/javascript"}));gs=new Worker(i),ax(gs,t,is.JSModuleURL).then(a,e)}).catch(e)})),$o),Al=(a,e)=>{const t=a instanceof ArrayBuffer?new Uint8Array(a):a;return new Promise((i,r)=>{hx().then(()=>{const s=lx++,n=l=>{l.data.action==="transcode"&&l.data.id===s&&(gs.removeEventListener("message",n),l.data.success?i(l.data):r("Transcode is not supported on this device"))};gs.addEventListener("message",n);const o=new Uint8Array(t.byteLength);o.set(new Uint8Array(t.buffer,t.byteOffset,t.byteLength)),gs.postMessage({action:"transcode",id:s,imageData:o,config:e,ignoreSupportedFormats:cx},[o.buffer])},s=>{r(s)})})},ca=(a,e)=>{var i,r;let t=(i=e._gl)==null?void 0:i.TEXTURE_2D;a.isCube&&(t=(r=e._gl)==null?void 0:r.TEXTURE_CUBE_MAP),e._bindTextureDirectly(t,a,!0)},Rl=(a,e)=>{const t=a.getEngine();for(let i=0;i<e.fileInfo.images.length;i++){const r=e.fileInfo.images[i].levels[0];if(a._invertVScale=a.invertY,e.format===-1||e.format===Mr.cTFRGB565)if(a.type=10,a.format=4,t._features.basisNeedsPOT&&(Math.log2(r.width)%1!==0||Math.log2(r.height)%1!==0)){const s=new Yt(t,2);a._invertVScale=a.invertY,s.type=10,s.format=4,s.width=r.width+3&-4,s.height=r.height+3&-4,ca(s,t),t._uploadDataToTextureDirectly(s,new Uint16Array(r.transcodedPixels.buffer),i,0,4,!0),t._rescaleTexture(s,a,t.scenes[0],t._getInternalFormat(4),()=>{t._releaseTexture(s),ca(a,t)})}else a._invertVScale=!a.invertY,a.width=r.width+3&-4,a.height=r.height+3&-4,a.samplingMode=2,ca(a,t),t._uploadDataToTextureDirectly(a,new Uint16Array(r.transcodedPixels.buffer),i,0,4,!0);else{a.width=r.width,a.height=r.height,a.generateMipMaps=e.fileInfo.images[i].levels.length>1;const s=fh.GetInternalFormatFromBasisFormat(e.format,t);a.format=s,ca(a,t),e.fileInfo.images[i].levels.forEach((n,o)=>{t._uploadCompressedDataToTextureDirectly(a,s,n.width,n.height,n.transcodedPixels,i,o)}),t._features.basisNeedsPOT&&(Math.log2(a.width)%1!==0||Math.log2(a.height)%1!==0)&&(k.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),a._cachedWrapU=Z.CLAMP_ADDRESSMODE,a._cachedWrapV=Z.CLAMP_ADDRESSMODE)}}},fh={JSModuleURL:is.JSModuleURL,WasmModuleURL:is.WasmModuleURL,GetInternalFormatFromBasisFormat:ox,TranscodeAsync:Al,LoadTextureFromTranscodeResult:Rl};Object.defineProperty(fh,"JSModuleURL",{get:function(){return is.JSModuleURL},set:function(a){is.JSModuleURL=a}});Object.defineProperty(fh,"WasmModuleURL",{get:function(){return is.WasmModuleURL},set:function(a){is.WasmModuleURL=a}});class fx{constructor(){this.supportCascades=!1}loadCubeData(e,t,i,r,s){if(Array.isArray(e))return;const n=t.getEngine().getCaps(),o={supportedCompressionFormats:{etc1:!!n.etc1,s3tc:!!n.s3tc,pvrtc:!!n.pvrtc,etc2:!!n.etc2,astc:!!n.astc,bc7:!!n.bptc}};Al(e,o).then(l=>{const c=l.fileInfo.images[0].levels.length>1&&t.generateMipMaps;Rl(t,l),t.getEngine()._setCubeMapTextureParams(t,c),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),r&&r()}).catch(l=>{k.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),t.isReady=!0,s&&s(l)})}loadData(e,t,i){const r=t.getEngine().getCaps(),s={supportedCompressionFormats:{etc1:!!r.etc1,s3tc:!!r.s3tc,pvrtc:!!r.pvrtc,etc2:!!r.etc2,astc:!!r.astc,bc7:!!r.bptc}};Al(e,s).then(n=>{const o=n.fileInfo.images[0].levels[0],l=n.fileInfo.images[0].levels.length>1&&t.generateMipMaps;i(o.width,o.height,l,n.format!==-1,()=>{Rl(t,n)})}).catch(n=>{k.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),k.Warn(`Failed to transcode Basis file: ${n}`),i(0,0,!1,!1,()=>{},!0)})}}const ux=Object.freeze(Object.defineProperty({__proto__:null,_BasisTextureLoader:fx},Symbol.toStringTag,{value:"Module"}));function dx(a,e){return e>1023?a*Math.pow(2,1023)*Math.pow(2,e-1023):e<-1074?a*Math.pow(2,-1074)*Math.pow(2,e+1074):a*Math.pow(2,e)}function mE(a,e,t,i,r,s){r>0?(r=dx(1,r-136),a[s+0]=e*r,a[s+1]=t*r,a[s+2]=i*r):(a[s+0]=0,a[s+1]=0,a[s+2]=0)}function Jo(a,e){let t="",i="";for(let r=e;r<a.length-e&&(i=String.fromCharCode(a[r]),i!=`
`);r++)t+=i;return t}function _x(a){let e=0,t=0,i=Jo(a,0);if(i[0]!="#"||i[1]!="?")throw"Bad HDR Format.";let r=!1,s=!1,n=0;do n+=i.length+1,i=Jo(a,n),i=="FORMAT=32-bit_rle_rgbe"?s=!0:i.length==0&&(r=!0);while(!r);if(!s)throw"HDR Bad header format, unsupported FORMAT";n+=i.length+1,i=Jo(a,n);const l=/^-Y (.*) \+X (.*)$/g.exec(i);if(!l||l.length<3)throw"HDR Bad header format, no size";if(t=parseInt(l[2]),e=parseInt(l[1]),t<8||t>32767)throw"HDR Bad header format, unsupported size";return n+=i.length+1,{height:e,width:t,dataPosition:n}}function px(a,e){return mx(a,e)}function mx(a,e){let t=e.height;const i=e.width;let r,s,n,o,l,c=e.dataPosition,h=0,f=0,u=0;const d=new ArrayBuffer(i*4),_=new Uint8Array(d),p=new ArrayBuffer(e.width*e.height*4*3),g=new Float32Array(p);for(;t>0;){if(r=a[c++],s=a[c++],n=a[c++],o=a[c++],r!=2||s!=2||n&128||e.width<8||e.width>32767)return gx(a,e);if((n<<8|o)!=i)throw"HDR Bad header format, wrong scan line width";for(h=0,u=0;u<4;u++)for(f=(u+1)*i;h<f;)if(r=a[c++],s=a[c++],r>128){if(l=r-128,l==0||l>f-h)throw"HDR Bad Format, bad scanline data (run)";for(;l-- >0;)_[h++]=s}else{if(l=r,l==0||l>f-h)throw"HDR Bad Format, bad scanline data (non-run)";if(_[h++]=s,--l>0)for(let E=0;E<l;E++)_[h++]=a[c++]}for(u=0;u<i;u++)r=_[u],s=_[u+i],n=_[u+2*i],o=_[u+3*i],mE(g,r,s,n,o,(e.height-t)*i*3+u*3);t--}return g}function gx(a,e){let t=e.height;const i=e.width;let r,s,n,o,l,c=e.dataPosition;const h=new ArrayBuffer(e.width*e.height*4*3),f=new Float32Array(h);for(;t>0;){for(l=0;l<e.width;l++)r=a[c++],s=a[c++],n=a[c++],o=a[c++],mE(f,r,s,n,o,(e.height-t)*i*3+l*3);t--}return f}class Ex{constructor(){this.supportCascades=!1}loadCubeData(){throw".hdr not supported in Cube."}loadData(e,t,i){const r=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),s=_x(r),n=px(r,s),o=s.width*s.height,l=new Float32Array(o*4);for(let c=0;c<o;c+=1)l[c*4]=n[c*3],l[c*4+1]=n[c*3+1],l[c*4+2]=n[c*3+2],l[c*4+3]=1;i(s.width,s.height,t.generateMipMaps,!1,()=>{const c=t.getEngine();t.type=1,t.format=5,t._gammaSpace=!1,c._uploadDataToTextureDirectly(t,l)})}}const vx=Object.freeze(Object.defineProperty({__proto__:null,_HDRTextureLoader:Ex},Symbol.toStringTag,{value:"Module"})),Tx=1,Sx=2,Ax=3,Rx=9,Cx=10,Ix=11,bx=48,xx=4,yx=0,Mx=1,Px=2,Ox=3;function uh(a){let e=0;return{id_length:a[e++],colormap_type:a[e++],image_type:a[e++],colormap_index:a[e++]|a[e++]<<8,colormap_length:a[e++]|a[e++]<<8,colormap_size:a[e++],origin:[a[e++]|a[e++]<<8,a[e++]|a[e++]<<8],width:a[e++]|a[e++]<<8,height:a[e++]|a[e++]<<8,pixel_size:a[e++],flags:a[e++]}}function gE(a,e){if(e.length<19){B.Error("Unable to load TGA file - Not enough data to contain header");return}let t=18;const i=uh(e);if(i.id_length+t>e.length){B.Error("Unable to load TGA file - Not enough data");return}t+=i.id_length;let r=!1,s=!1,n=!1;switch(i.image_type){case Rx:r=!0;case Tx:s=!0;break;case Cx:r=!0;case Sx:break;case Ix:r=!0;case Ax:n=!0;break}let o;const l=i.pixel_size>>3,c=i.width*i.height*l;let h;if(s&&(h=e.subarray(t,t+=i.colormap_length*(i.colormap_size>>3))),r){o=new Uint8Array(c);let R,S,T,I=0;const O=new Uint8Array(l);for(;t<c&&I<c;)if(R=e[t++],S=(R&127)+1,R&128){for(T=0;T<l;++T)O[T]=e[t++];for(T=0;T<S;++T)o.set(O,I+T*l);I+=l*S}else{for(S*=l,T=0;T<S;++T)o[I+T]=e[t++];I+=S}}else o=e.subarray(t,t+=s?i.width*i.height:c);let f,u,d,_,p,g;switch((i.flags&bx)>>xx){default:case Px:f=0,d=1,g=i.width,u=0,_=1,p=i.height;break;case yx:f=0,d=1,g=i.width,u=i.height-1,_=-1,p=-1;break;case Ox:f=i.width-1,d=-1,g=-1,u=0,_=1,p=i.height;break;case Mx:f=i.width-1,d=-1,g=-1,u=i.height-1,_=-1,p=-1;break}const E="_getImageData"+(n?"Grey":"")+i.pixel_size+"bits",v=Ux[E](i,h,o,u,_,p,f,d,g);a.getEngine()._uploadDataToTextureDirectly(a,v)}function Dx(a,e,t,i,r,s,n,o,l){const c=t,h=e,f=a.width,u=a.height;let d,_=0,p,g;const E=new Uint8Array(f*u*4);for(g=i;g!==s;g+=r)for(p=n;p!==l;p+=o,_++)d=c[_],E[(p+f*g)*4+3]=255,E[(p+f*g)*4+2]=h[d*3+0],E[(p+f*g)*4+1]=h[d*3+1],E[(p+f*g)*4+0]=h[d*3+2];return E}function Lx(a,e,t,i,r,s,n,o,l){const c=t,h=a.width,f=a.height;let u,d=0,_,p;const g=new Uint8Array(h*f*4);for(p=i;p!==s;p+=r)for(_=n;_!==l;_+=o,d+=2){u=c[d+0]+(c[d+1]<<8);const E=((u&31744)>>10)*255/31|0,v=((u&992)>>5)*255/31|0,b=(u&31)*255/31|0;g[(_+h*p)*4+0]=E,g[(_+h*p)*4+1]=v,g[(_+h*p)*4+2]=b,g[(_+h*p)*4+3]=u&32768?0:255}return g}function Nx(a,e,t,i,r,s,n,o,l){const c=t,h=a.width,f=a.height;let u=0,d,_;const p=new Uint8Array(h*f*4);for(_=i;_!==s;_+=r)for(d=n;d!==l;d+=o,u+=3)p[(d+h*_)*4+3]=255,p[(d+h*_)*4+2]=c[u+0],p[(d+h*_)*4+1]=c[u+1],p[(d+h*_)*4+0]=c[u+2];return p}function Fx(a,e,t,i,r,s,n,o,l){const c=t,h=a.width,f=a.height;let u=0,d,_;const p=new Uint8Array(h*f*4);for(_=i;_!==s;_+=r)for(d=n;d!==l;d+=o,u+=4)p[(d+h*_)*4+2]=c[u+0],p[(d+h*_)*4+1]=c[u+1],p[(d+h*_)*4+0]=c[u+2],p[(d+h*_)*4+3]=c[u+3];return p}function wx(a,e,t,i,r,s,n,o,l){const c=t,h=a.width,f=a.height;let u,d=0,_,p;const g=new Uint8Array(h*f*4);for(p=i;p!==s;p+=r)for(_=n;_!==l;_+=o,d++)u=c[d],g[(_+h*p)*4+0]=u,g[(_+h*p)*4+1]=u,g[(_+h*p)*4+2]=u,g[(_+h*p)*4+3]=255;return g}function Bx(a,e,t,i,r,s,n,o,l){const c=t,h=a.width,f=a.height;let u=0,d,_;const p=new Uint8Array(h*f*4);for(_=i;_!==s;_+=r)for(d=n;d!==l;d+=o,u+=2)p[(d+h*_)*4+0]=c[u+0],p[(d+h*_)*4+1]=c[u+0],p[(d+h*_)*4+2]=c[u+0],p[(d+h*_)*4+3]=c[u+1];return p}const Ux={GetTGAHeader:uh,UploadContent:gE,_getImageData8bits:Dx,_getImageData16bits:Lx,_getImageData24bits:Nx,_getImageData32bits:Fx,_getImageDataGrey8bits:wx,_getImageDataGrey16bits:Bx};class Vx{constructor(){this.supportCascades=!1}loadCubeData(){throw".env not supported in Cube."}loadData(e,t,i){const r=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),s=uh(r);i(s.width,s.height,t.generateMipMaps,!1,()=>{gE(t,r)})}}const Gx=Object.freeze(Object.defineProperty({__proto__:null,_TGATextureLoader:Vx},Symbol.toStringTag,{value:"Module"})),EE=4,Cl=4,vE=1,qs=2,kx=8,Pa=65536,Zf=Pa>>3,Wx=16,Zr=14,Tn=(1<<Wx)+1,dh=1<<Zr,Qf=dh-1,Il=59,TE=63,Xx=2+TE-Il;var xr;(function(a){a[a.NO_COMPRESSION=0]="NO_COMPRESSION",a[a.RLE_COMPRESSION=1]="RLE_COMPRESSION",a[a.ZIPS_COMPRESSION=2]="ZIPS_COMPRESSION",a[a.ZIP_COMPRESSION=3]="ZIP_COMPRESSION",a[a.PIZ_COMPRESSION=4]="PIZ_COMPRESSION",a[a.PXR24_COMPRESSION=5]="PXR24_COMPRESSION"})(xr||(xr={}));var bl;(function(a){a[a.INCREASING_Y=0]="INCREASING_Y",a[a.DECREASING_Y=1]="DECREASING_Y"})(bl||(bl={}));const ha=Hx();function Hx(){const a=new ArrayBuffer(4),e=new Float32Array(a),t=new Uint32Array(a),i=new Uint32Array(512),r=new Uint32Array(512);for(let l=0;l<256;++l){const c=l-127;c<-27?(i[l]=0,i[l|256]=32768,r[l]=24,r[l|256]=24):c<-14?(i[l]=1024>>-c-14,i[l|256]=1024>>-c-14|32768,r[l]=-c-1,r[l|256]=-c-1):c<=15?(i[l]=c+15<<10,i[l|256]=c+15<<10|32768,r[l]=13,r[l|256]=13):c<128?(i[l]=31744,i[l|256]=64512,r[l]=24,r[l|256]=24):(i[l]=31744,i[l|256]=64512,r[l]=13,r[l|256]=13)}const s=new Uint32Array(2048),n=new Uint32Array(64),o=new Uint32Array(64);for(let l=1;l<1024;++l){let c=l<<13,h=0;for(;!(c&8388608);)c<<=1,h-=8388608;c&=-8388609,h+=947912704,s[l]=c|h}for(let l=1024;l<2048;++l)s[l]=939524096+(l-1024<<13);for(let l=1;l<31;++l)n[l]=l<<23;n[31]=1199570944,n[32]=2147483648;for(let l=33;l<63;++l)n[l]=2147483648+(l-32<<23);n[63]=3347054592;for(let l=1;l<64;++l)l!==32&&(o[l]=1024);return{floatView:e,uint32View:t,baseTable:i,shiftTable:r,mantissaTable:s,exponentTable:n,offsetTable:o}}function xl(a,e){const t=new Uint8Array(a);let i=0;for(;t[e.value+i]!=0;)i+=1;const r=new TextDecoder().decode(t.slice(e.value,e.value+i));return e.value=e.value+i+1,r}function _r(a,e){const t=a.getInt32(e.value,!0);return e.value+=EE,t}function Nr(a,e){const t=a.getUint32(e.value,!0);return e.value+=EE,t}function So(a,e){const t=a.getUint8(e.value);return e.value+=vE,t}function Oa(a,e){const t=a.getUint16(e.value,!0);return e.value+=qs,t}function SE(a,e){const t=a[e.value];return e.value+=vE,t}function zx(a,e){let t;return"getBigInt64"in DataView.prototype?t=Number(a.getBigInt64(e.value,!0)):t=a.getUint32(e.value+4,!0)+Number(a.getUint32(e.value,!0)<<32),e.value+=kx,t}function ci(a,e){const t=a.getFloat32(e.value,!0);return e.value+=Cl,t}function Yx(a,e){return Kx(Oa(a,e))}function Kx(a){const e=(a&31744)>>10,t=a&1023;return(a>>15?-1:1)*(e?e===31?t?NaN:1/0:Math.pow(2,e-15)*(1+t/1024):6103515625e-14*(t/1024))}function qx(a){if(Math.abs(a)>65504)throw new Error("Value out of range.Consider using float instead of half-float.");a=je(a,-65504,65504),ha.floatView[0]=a;const e=ha.uint32View[0],t=e>>23&511;return ha.baseTable[t]+((e&8388607)>>ha.shiftTable[t])}function jx(a,e){return qx(ci(a,e))}function Zx(a,e,t){const i=new TextDecoder().decode(new Uint8Array(a).slice(e.value,e.value+t));return e.value=e.value+t,i}function Qx(a,e){const t=_r(a,e),i=Nr(a,e);return[t,i]}function $x(a,e){const t=Nr(a,e),i=Nr(a,e);return[t,i]}function Jx(a,e){const t=ci(a,e),i=ci(a,e);return[t,i]}function e0(a,e){const t=ci(a,e),i=ci(a,e),r=ci(a,e);return[t,i,r]}function t0(a,e,t){const i=e.value,r=[];for(;e.value<i+t-1;){const s=xl(a.buffer,e),n=_r(a,e),o=So(a,e);e.value+=3;const l=_r(a,e),c=_r(a,e);r.push({name:s,pixelType:n,pLinear:o,xSampling:l,ySampling:c})}return e.value+=1,r}function i0(a,e){const t=ci(a,e),i=ci(a,e),r=ci(a,e),s=ci(a,e),n=ci(a,e),o=ci(a,e),l=ci(a,e),c=ci(a,e);return{redX:t,redY:i,greenX:r,greenY:s,blueX:n,blueY:o,whiteX:l,whiteY:c}}function r0(a,e){return So(a,e)}function s0(a,e){const t=_r(a,e),i=_r(a,e),r=_r(a,e),s=_r(a,e);return{xMin:t,yMin:i,xMax:r,yMax:s}}function n0(a,e){const t=So(a,e);return bl[t]}function a0(a,e,t,i){switch(t){case"string":case"stringvector":case"iccProfile":return Zx(a.buffer,e,i);case"chlist":return t0(a,e,i);case"chromaticities":return i0(a,e);case"compression":return r0(a,e);case"box2i":return s0(a,e);case"lineOrder":return n0(a,e);case"float":return ci(a,e);case"v2f":return Jx(a,e);case"v3f":return e0(a,e);case"int":return _r(a,e);case"rational":return Qx(a,e);case"timecode":return $x(a,e);case"preview":return e.value+=i,"skipped";default:e.value+=i;return}}function AE(a){for(let e=1;e<a.length;e++){const t=a[e-1]+a[e]-128;a[e]=t}}function RE(a,e){let t=0,i=Math.floor((a.length+1)/2),r=0;const s=a.length-1;for(;!(r>s||(e[r++]=a[t++],r>s));)e[r++]=a[i++]}const o0=20000630;function l0(a,e){if(a.getUint32(0,!0)!=o0)throw new Error("Incorrect OpenEXR format");const t=a.getUint8(4),i=a.getUint8(5),r={singleTile:!!(i&2),longName:!!(i&4),deepFormat:!!(i&8),multiPart:!!(i&16)};e.value=8;const s={};let n=!0;for(;n;){const o=xl(a.buffer,e);if(!o)n=!1;else{const l=xl(a.buffer,e),c=Nr(a,e),h=a0(a,e,l,c);h===void 0?B.Warn(`Unknown header attribute type ${l}'.`):s[o]=h}}if(i&-5)throw new Error("Unsupported file format");return{version:t,spec:r,...s}}const CE=16,c0=1<<CE-1,$f=(1<<CE)-1;function h0(a,e){let t=0;for(let r=0;r<Pa;++r)(r==0||a[r>>3]&1<<(r&7))&&(e[t++]=r);const i=t-1;for(;t<Pa;)e[t++]=0;return i}function f0(a){for(let e=0;e<dh;e++)a[e]={},a[e].len=0,a[e].lit=0,a[e].p=null}function Jf(a,e,t,i,r){for(;t<a;)e=e<<8|SE(i,r),t+=8;return t-=a,{l:e>>t&(1<<a)-1,c:e,lc:t}}function yl(a,e,t,i){return a=a<<8|SE(t,i),e+=8,{c:a,lc:e}}function el(a,e,t,i,r,s,n,o,l){if(a==e){if(i<8){const f=yl(t,i,r,s);t=f.c,i=f.lc}i-=8;let c=t>>i;if(c=new Uint8Array([c])[0],o.value+c>l)return null;const h=n[o.value-1];for(;c-- >0;)n[o.value++]=h}else if(o.value<l)n[o.value++]=a;else return null;return{c:t,lc:i}}const _n=new Array(59);function u0(a){for(let t=0;t<=58;++t)_n[t]=0;for(let t=0;t<Tn;++t)_n[a[t]]+=1;let e=0;for(let t=58;t>0;--t){const i=e+_n[t]>>1;_n[t]=e,e=i}for(let t=0;t<Tn;++t){const i=a[t];i>0&&(a[t]=i|_n[i]++<<6)}}function d0(a,e,t,i,r,s){const n=e;let o=0,l=0;for(;i<=r;i++){if(n.value-e.value>t)return;let c=Jf(6,o,l,a,n);const h=c.l;if(o=c.c,l=c.lc,s[i]=h,h==TE){if(n.value-e.value>t)throw new Error("Error in HufUnpackEncTable");c=Jf(8,o,l,a,n);let f=c.l+Xx;if(o=c.c,l=c.lc,i+f>r+1)throw new Error("Error in HufUnpackEncTable");for(;f--;)s[i++]=0;i--}else if(h>=Il){let f=h-Il+2;if(i+f>r+1)throw new Error("Error in HufUnpackEncTable");for(;f--;)s[i++]=0;i--}}u0(s)}function IE(a){return a&63}function bE(a){return a>>6}function _0(a,e,t,i){for(;e<=t;e++){const r=bE(a[e]),s=IE(a[e]);if(r>>s)throw new Error("Invalid table entry");if(s>Zr){const n=i[r>>s-Zr];if(n.len)throw new Error("Invalid table entry");if(n.lit++,n.p){const o=n.p;n.p=new Array(n.lit);for(let l=0;l<n.lit-1;++l)n.p[l]=o[l]}else n.p=new Array(1);n.p[n.lit-1]=e}else if(s){let n=0;for(let o=1<<Zr-s;o>0;o--){const l=i[(r<<Zr-s)+n];if(l.len||l.p)throw new Error("Invalid table entry");l.len=s,l.lit=e,n++}}}return!0}function p0(a,e,t,i,r,s,n,o,l){let c=0,h=0;const f=n,u=Math.trunc(i.value+(r+7)/8);for(;i.value<u;){let _=yl(c,h,t,i);for(c=_.c,h=_.lc;h>=Zr;){const p=c>>h-Zr&Qf,g=e[p];if(g.len){h-=g.len;const E=el(g.lit,s,c,h,t,i,o,l,f);E&&(c=E.c,h=E.lc)}else{if(!g.p)throw new Error("hufDecode issues");let E;for(E=0;E<g.lit;E++){const v=IE(a[g.p[E]]);for(;h<v&&i.value<u;)_=yl(c,h,t,i),c=_.c,h=_.lc;if(h>=v&&bE(a[g.p[E]])==(c>>h-v&(1<<v)-1)){h-=v;const b=el(g.p[E],s,c,h,t,i,o,l,f);b&&(c=b.c,h=b.lc);break}}if(E==g.lit)throw new Error("HufDecode issues")}}}const d=8-r&7;for(c>>=d,h-=d;h>0;){const _=e[c<<Zr-h&Qf];if(_.len){h-=_.len;const p=el(_.lit,s,c,h,t,i,o,l,f);p&&(c=p.c,h=p.lc)}else throw new Error("HufDecode issues")}return!0}function m0(a,e,t,i,r,s){const n={value:0},o=t.value,l=Nr(e,t),c=Nr(e,t);t.value+=4;const h=Nr(e,t);if(t.value+=4,l<0||l>=Tn||c<0||c>=Tn)throw new Error("Wrong HUF_ENCSIZE");const f=new Array(Tn),u=new Array(dh);f0(u);const d=i-(t.value-o);if(d0(a,t,d,l,c,f),h>8*(i-(t.value-o)))throw new Error("Wrong hufUncompress");_0(f,l,c,u),p0(f,u,a,t,h,c,s,r,n)}function Ml(a){return a&65535}function eu(a){const e=Ml(a);return e>32767?e-65536:e}function Bs(a,e){const t=eu(a),r=eu(e),s=t+(r&1)+(r>>1),n=s,o=s-r;return{a:n,b:o}}function Us(a,e){const t=Ml(a),i=Ml(e),r=t-(i>>1)&$f;return{a:i+r-c0&$f,b:r}}function g0(a,e,t,i,r,s,n){const o=n<16384,l=t>r?r:t;let c=1,h,f;for(;c<=l;)c<<=1;for(c>>=1,h=c,c>>=1;c>=1;){f=0;const u=f+s*(r-h),d=s*c,_=s*h,p=i*c,g=i*h;let E,v,b,R;for(;f<=u;f+=_){let S=f;const T=f+i*(t-h);for(;S<=T;S+=g){const I=S+p,O=S+d,L=O+p;if(o){let w=Bs(a[S+e],a[O+e]);E=w.a,b=w.b,w=Bs(a[I+e],a[L+e]),v=w.a,R=w.b,w=Bs(E,v),a[S+e]=w.a,a[I+e]=w.b,w=Bs(b,R),a[O+e]=w.a,a[L+e]=w.b}else{let w=Us(a[S+e],a[O+e]);E=w.a,b=w.b,w=Us(a[I+e],a[L+e]),v=w.a,R=w.b,w=Us(E,v),a[S+e]=w.a,a[I+e]=w.b,w=Us(b,R),a[O+e]=w.a,a[L+e]=w.b}}if(t&c){const I=S+d;let O;o?O=Bs(a[S+e],a[I+e]):O=Us(a[S+e],a[I+e]),E=O.a,a[I+e]=O.b,a[S+e]=E}}if(r&c){let S=f;const T=f+i*(t-h);for(;S<=T;S+=g){const I=S+p;let O;o?O=Bs(a[S+e],a[I+e]):O=Us(a[S+e],a[I+e]),E=O.a,a[I+e]=O.b,a[S+e]=E}}h=c,c>>=1}return f}function E0(a,e,t){for(let i=0;i<t;++i)e[i]=a[e[i]]}function v0(a){let e=a.byteLength;const t=new Array;let i=0;const r=new DataView(a);for(;e>0;){const s=r.getInt8(i++);if(s<0){const n=-s;e-=n+1;for(let o=0;o<n;o++)t.push(r.getUint8(i++))}else{const n=s;e-=2;const o=r.getUint8(i++);for(let l=0;l<n+1;l++)t.push(o)}}return t}function xE(a){return new DataView(a.array.buffer,a.offset.value,a.size)}function T0(a){const e=a.viewer.buffer.slice(a.offset.value,a.offset.value+a.size),t=new Uint8Array(v0(e)),i=new Uint8Array(t.length);return AE(t),RE(t,i),new DataView(i.buffer)}function tu(a){const e=a.array.slice(a.offset.value,a.offset.value+a.size),t=fflate.unzlibSync(e),i=new Uint8Array(t.length);return AE(t),RE(t,i),new DataView(i.buffer)}function S0(a){const e=a.array.slice(a.offset.value,a.offset.value+a.size),t=fflate.unzlibSync(e),i=a.lines*a.channels*a.width,r=a.type==1?new Uint16Array(i):new Uint32Array(i);let s=0,n=0;const o=new Array(4);for(let l=0;l<a.lines;l++)for(let c=0;c<a.channels;c++){let h=0;switch(a.type){case 1:o[0]=s,o[1]=o[0]+a.width,s=o[1]+a.width;for(let f=0;f<a.width;++f){const u=t[o[0]++]<<8|t[o[1]++];h+=u,r[n]=h,n++}break;case 2:o[0]=s,o[1]=o[0]+a.width,o[2]=o[1]+a.width,s=o[2]+a.width;for(let f=0;f<a.width;++f){const u=t[o[0]++]<<24|t[o[1]++]<<16|t[o[2]++]<<8;h+=u,r[n]=h,n++}break}}return new DataView(r.buffer)}function A0(a){const e=a.viewer,t={value:a.offset.value},i=new Uint16Array(a.width*a.scanlineBlockSize*(a.channels*a.type)),r=new Uint8Array(Zf);let s=0;const n=new Array(a.channels);for(let _=0;_<a.channels;_++)n[_]={},n[_].start=s,n[_].end=n[_].start,n[_].nx=a.width,n[_].ny=a.lines,n[_].size=a.type,s+=n[_].nx*n[_].ny*n[_].size;const o=Oa(e,t),l=Oa(e,t);if(l>=Zf)throw new Error("Wrong PIZ_COMPRESSION BITMAP_SIZE");if(o<=l)for(let _=0;_<l-o+1;_++)r[_+o]=So(e,t);const c=new Uint16Array(Pa),h=h0(r,c),f=Nr(e,t);m0(a.array,e,t,f,i,s);for(let _=0;_<a.channels;++_){const p=n[_];for(let g=0;g<n[_].size;++g)g0(i,p.start+g,p.nx,p.size,p.ny,p.nx*p.size,h)}E0(c,i,s);let u=0;const d=new Uint8Array(i.buffer.byteLength);for(let _=0;_<a.lines;_++)for(let p=0;p<a.channels;p++){const g=n[p],E=g.nx*g.size,v=new Uint8Array(i.buffer,g.end*qs,E*qs);d.set(v,u),u+=E*qs,g.end+=E}return new DataView(d.buffer)}var Pr;(function(a){a[a.Float=0]="Float",a[a.HalfFloat=1]="HalfFloat"})(Pr||(Pr={}));class js{}js.DefaultOutputType=Pr.HalfFloat;js.FFLATEUrl="https://unpkg.com/fflate@0.8.2";async function R0(a,e,t,i){const r={size:0,viewer:e,array:new Uint8Array(e.buffer),offset:t,width:a.dataWindow.xMax-a.dataWindow.xMin+1,height:a.dataWindow.yMax-a.dataWindow.yMin+1,channels:a.channels.length,channelLineOffsets:{},scanOrder:()=>0,bytesPerLine:0,outLineWidth:0,lines:0,scanlineBlockSize:0,inputSize:null,type:0,uncompress:null,getter:()=>0,format:5,outputChannels:0,decodeChannels:{},blockCount:null,byteArray:null,linearSpace:!1,textureType:0};switch(a.compression){case xr.NO_COMPRESSION:r.lines=1,r.uncompress=xE;break;case xr.RLE_COMPRESSION:r.lines=1,r.uncompress=T0;break;case xr.ZIPS_COMPRESSION:r.lines=1,r.uncompress=tu,await k.LoadScriptAsync(js.FFLATEUrl);break;case xr.ZIP_COMPRESSION:r.lines=16,r.uncompress=tu,await k.LoadScriptAsync(js.FFLATEUrl);break;case xr.PIZ_COMPRESSION:r.lines=32,r.uncompress=A0;break;case xr.PXR24_COMPRESSION:r.lines=16,r.uncompress=S0,await k.LoadScriptAsync(js.FFLATEUrl);break;default:throw new Error(xr[a.compression]+" is unsupported")}r.scanlineBlockSize=r.lines;const s={};for(const c of a.channels)switch(c.name){case"Y":case"R":case"G":case"B":case"A":s[c.name]=!0,r.type=c.pixelType}let n=!1;if(s.R&&s.G&&s.B)n=!s.A,r.outputChannels=4,r.decodeChannels={R:0,G:1,B:2,A:3};else if(s.Y)r.outputChannels=1,r.decodeChannels={Y:0};else throw new Error("EXRLoader.parse: file contains unsupported data channels.");if(r.type===1)switch(i){case Pr.Float:r.getter=Yx,r.inputSize=qs;break;case Pr.HalfFloat:r.getter=Oa,r.inputSize=qs;break}else if(r.type===2)switch(i){case Pr.Float:r.getter=ci,r.inputSize=Cl;break;case Pr.HalfFloat:r.getter=jx,r.inputSize=Cl}else throw new Error("Unsupported pixelType "+r.type+" for "+a.compression);r.blockCount=r.height/r.scanlineBlockSize;for(let c=0;c<r.blockCount;c++)zx(e,t);const o=r.width*r.height*r.outputChannels;switch(i){case Pr.Float:r.byteArray=new Float32Array(o),r.textureType=1,n&&r.byteArray.fill(1,0,o);break;case Pr.HalfFloat:r.byteArray=new Uint16Array(o),r.textureType=2,n&&r.byteArray.fill(15360,0,o);break;default:throw new Error("Unsupported type: "+i)}let l=0;for(const c of a.channels)r.decodeChannels[c.name]!==void 0&&(r.channelLineOffsets[c.name]=l*r.width),l+=c.pixelType*2;return r.bytesPerLine=r.width*l,r.outLineWidth=r.width*r.outputChannels,a.lineOrder==="INCREASING_Y"?r.scanOrder=c=>c:r.scanOrder=c=>r.height-1-c,r.outputChannels==4?(r.format=5,r.linearSpace=!0):(r.format=6,r.linearSpace=!1),r}function C0(a,e,t,i){const r={value:0};for(let s=0;s<a.height/a.scanlineBlockSize;s++){const n=_r(t,i)-e.dataWindow.yMin;a.size=Nr(t,i),a.lines=n+a.scanlineBlockSize>a.height?a.height-n:a.scanlineBlockSize;const l=a.size<a.lines*a.bytesPerLine&&a.uncompress?a.uncompress(a):xE(a);i.value+=a.size;for(let c=0;c<a.scanlineBlockSize;c++){const h=s*a.scanlineBlockSize,f=c+a.scanOrder(h);if(f>=a.height)continue;const u=c*a.bytesPerLine,d=(a.height-1-f)*a.outLineWidth;for(let _=0;_<a.channels;_++){const p=e.channels[_].name,g=a.channelLineOffsets[p],E=a.decodeChannels[p];if(E!==void 0){r.value=u+g;for(let v=0;v<a.width;v++){const b=d+v*a.outputChannels+E;a.byteArray&&(a.byteArray[b]=a.getter(l,r))}}}}}}class I0{constructor(){this.supportCascades=!1}loadCubeData(e,t,i,r,s){throw".exr not supported in Cube."}async loadData(e,t,i){const r=new DataView(e.buffer),s={value:0},n=l0(r,s),o=await R0(n,r,s,js.DefaultOutputType);C0(o,n,r,s);const l=n.dataWindow.xMax-n.dataWindow.xMin+1,c=n.dataWindow.yMax-n.dataWindow.yMin+1;i(l,c,t.generateMipMaps,!1,()=>{const h=t.getEngine();t.format=n.format,t.type=o.textureType,t.invertY=!1,t._gammaSpace=!n.linearSpace,o.byteArray&&h._uploadDataToTextureDirectly(t,o.byteArray,0,0,void 0,!0)})}}const b0=Object.freeze(Object.defineProperty({__proto__:null,_ExrTextureLoader:I0},Symbol.toStringTag,{value:"Module"})),iu="sceneUboDeclaration",x0=`struct Scene {viewProjection : mat4x4<f32>,
#ifdef MULTIVIEW
viewProjectionR : mat4x4<f32>,
#endif 
view : mat4x4<f32>,
projection : mat4x4<f32>,
vEyePosition : vec4<f32>,};
#define SCENE_UBO
var<uniform> scene : Scene;
`;C.IncludesShadersStoreWGSL[iu]||(C.IncludesShadersStoreWGSL[iu]=x0);const ru="meshUboDeclaration",y0=`struct Mesh {world : mat4x4<f32>,
visibility : f32,};var<uniform> mesh : Mesh;
#define WORLD_UBO
`;C.IncludesShadersStoreWGSL[ru]||(C.IncludesShadersStoreWGSL[ru]=y0);const su="defaultUboDeclaration",M0=`uniform diffuseLeftColor: vec4f;uniform diffuseRightColor: vec4f;uniform opacityParts: vec4f;uniform reflectionLeftColor: vec4f;uniform reflectionRightColor: vec4f;uniform refractionLeftColor: vec4f;uniform refractionRightColor: vec4f;uniform emissiveLeftColor: vec4f;uniform emissiveRightColor: vec4f;uniform vDiffuseInfos: vec2f;uniform vAmbientInfos: vec2f;uniform vOpacityInfos: vec2f;uniform vReflectionInfos: vec2f;uniform vReflectionPosition: vec3f;uniform vReflectionSize: vec3f;uniform vEmissiveInfos: vec2f;uniform vLightmapInfos: vec2f;uniform vSpecularInfos: vec2f;uniform vBumpInfos: vec3f;uniform diffuseMatrix: mat4x4f;uniform ambientMatrix: mat4x4f;uniform opacityMatrix: mat4x4f;uniform reflectionMatrix: mat4x4f;uniform emissiveMatrix: mat4x4f;uniform lightmapMatrix: mat4x4f;uniform specularMatrix: mat4x4f;uniform bumpMatrix: mat4x4f;uniform vTangentSpaceParams: vec2f;uniform pointSize: f32;uniform alphaCutOff: f32;uniform refractionMatrix: mat4x4f;uniform vRefractionInfos: vec4f;uniform vRefractionPosition: vec3f;uniform vRefractionSize: vec3f;uniform vSpecularColor: vec4f;uniform vEmissiveColor: vec3f;uniform vDiffuseColor: vec4f;uniform vAmbientColor: vec3f;
#define ADDITIONAL_UBO_DECLARATION
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;C.IncludesShadersStoreWGSL[su]||(C.IncludesShadersStoreWGSL[su]=M0);const nu="uvAttributeDeclaration",P0=`#ifdef UV{X}
attribute uv{X}: vec2f;
#endif
`;C.IncludesShadersStoreWGSL[nu]||(C.IncludesShadersStoreWGSL[nu]=P0);const au="helperFunctions",O0=`const PI: f32=3.1415926535897932384626433832795;const TWO_PI: f32=6.283185307179586;const HALF_PI: f32=1.5707963267948966;const RECIPROCAL_PI: f32=0.3183098861837907;const RECIPROCAL_PI2: f32=0.15915494309189535;const RECIPROCAL_PI4: f32=0.07957747154594767;const HALF_MIN: f32=5.96046448e-08; 
const LinearEncodePowerApprox: f32=2.2;const GammaEncodePowerApprox: f32=1.0/LinearEncodePowerApprox;const LuminanceEncodeApprox: vec3f=vec3f(0.2126,0.7152,0.0722);const Epsilon:f32=0.0000001;fn square(x: f32)->f32 {return x*x;}
fn saturate(x: f32)->f32 {return clamp(x,0.0,1.0);}
fn saturateVec3(x: vec3f)->vec3f {return clamp(x,vec3f(),vec3f(1.0));}
fn saturateEps(x: f32)->f32 {return clamp(x,Epsilon,1.0);}
fn maxEps(x: f32)->f32 {return max(x,Epsilon);}
fn maxEpsVec3(x: vec3f)->vec3f {return max(x,vec3f(Epsilon));}
fn absEps(x: f32)->f32 {return abs(x)+Epsilon;}
fn transposeMat3(inMatrix: mat3x3f)->mat3x3f {let i0: vec3f=inMatrix[0];let i1: vec3f=inMatrix[1];let i2: vec3f=inMatrix[2];let outMatrix:mat3x3f=mat3x3f(
vec3(i0.x,i1.x,i2.x),
vec3(i0.y,i1.y,i2.y),
vec3(i0.z,i1.z,i2.z)
);return outMatrix;}
fn inverseMat3(inMatrix: mat3x3f)->mat3x3f {let a00: f32=inMatrix[0][0];let a01: f32=inMatrix[0][1];let a02: f32=inMatrix[0][2];let a10: f32=inMatrix[1][0];let a11: f32=inMatrix[1][1];let a12: f32=inMatrix[1][2];let a20: f32=inMatrix[2][0];let a21: f32=inMatrix[2][1];let a22: f32=inMatrix[2][2];let b01: f32=a22*a11-a12*a21;let b11: f32=-a22*a10+a12*a20;let b21: f32=a21*a10-a11*a20;let det: f32=a00*b01+a01*b11+a02*b21;return mat3x3f(b01/det,(-a22*a01+a02*a21)/det,(a12*a01-a02*a11)/det,
b11/det,(a22*a00-a02*a20)/det,(-a12*a00+a02*a10)/det,
b21/det,(-a21*a00+a01*a20)/det,(a11*a00-a01*a10)/det);}
#if USE_EXACT_SRGB_CONVERSIONS
fn toLinearSpaceExact(color: vec3f)->vec3f
{let nearZeroSection: vec3f=0.0773993808*color;let remainingSection: vec3f=pow(0.947867299*(color+vec3f(0.055)),vec3f(2.4));return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3f(0.04045)));}
fn toGammaSpaceExact(color: vec3f)->vec3f
{let nearZeroSection: vec3f=12.92*color;let remainingSection: vec3f=1.055*pow(color,vec3f(0.41666))-vec3f(0.055);return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3f(0.0031308)));}
#endif
fn toLinearSpace(color: f32)->f32
{
#if USE_EXACT_SRGB_CONVERSIONS
var nearZeroSection=0.0773993808*color;var remainingSection=pow(0.947867299*(color+0.055),2.4);return select(remainingSection,nearZeroSection,color<=0.04045);
#else
return pow(color,LinearEncodePowerApprox);
#endif
}
fn toLinearSpaceVec3(color: vec3f)->vec3f
{
#if USE_EXACT_SRGB_CONVERSIONS
return toLinearSpaceExact(color);
#else
return pow(color,vec3f(LinearEncodePowerApprox));
#endif
}
fn toLinearSpaceVec4(color: vec4<f32>)->vec4<f32>
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4f(toLinearSpaceExact(color.rgb),color.a);
#else
return vec4f(pow(color.rgb,vec3f(LinearEncodePowerApprox)),color.a);
#endif
}
fn toGammaSpace(color: vec4<f32>)->vec4<f32>
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4<f32>(toGammaSpaceExact(color.rgb),color.a);
#else
return vec4<f32>(pow(color.rgb,vec3f(GammaEncodePowerApprox)),color.a);
#endif
}
fn toGammaSpaceVec3(color: vec3f)->vec3f
{
#if USE_EXACT_SRGB_CONVERSIONS
return toGammaSpaceExact(color);
#else
return pow(color,vec3f(GammaEncodePowerApprox));
#endif
}
fn squareVec3(value: vec3f)->vec3f
{return value*value;}
fn pow5(value: f32)->f32 {let sq: f32=value*value;return sq*sq*value;}
fn getLuminance(color: vec3f)->f32
{return saturate(dot(color,LuminanceEncodeApprox));}
fn getRand(seed: vec2<f32>)->f32 {return fract(sin(dot(seed.xy ,vec2<f32>(12.9898,78.233)))*43758.5453);}
fn dither(seed: vec2<f32>,varianceAmount: f32)->f32 {let rand: f32=getRand(seed);let normVariance: f32=varianceAmount/255.0;let dither: f32=mix(-normVariance,normVariance,rand);return dither;}
const rgbdMaxRange: f32=255.0;fn toRGBD(color: vec3f)->vec4<f32> {let maxRGB: f32=max(max(color.r,max(color.g,color.b)),Epsilon);var D: f32 =max(rgbdMaxRange/maxRGB,1.);D =clamp(floor(D)/255.0,0.,1.);var rgb: vec3f =color.rgb*D;rgb=toGammaSpaceVec3(rgb);return vec4<f32>(saturateVec3(rgb),D);}
fn fromRGBD(rgbd: vec4<f32>)->vec3f {let rgb=toLinearSpaceVec3(rgbd.rgb);return rgb/rgbd.a;}
fn parallaxCorrectNormal(vertexPos: vec3f,origVec: vec3f,cubeSize: vec3f,cubePos: vec3f)->vec3f {let invOrigVec: vec3f=vec3f(1.)/origVec;let halfSize: vec3f=cubeSize*0.5;let intersecAtMaxPlane: vec3f=(cubePos+halfSize-vertexPos)*invOrigVec;let intersecAtMinPlane: vec3f=(cubePos-halfSize-vertexPos)*invOrigVec;let largestIntersec: vec3f=max(intersecAtMaxPlane,intersecAtMinPlane);let distance: f32=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);let intersectPositionWS: vec3f=vertexPos+origVec*distance;return intersectPositionWS-cubePos;}
fn equirectangularToCubemapDirection(uv : vec2f)->vec3f {var longitude : f32=uv.x*TWO_PI-PI;var latitude : f32=HALF_PI-uv.y*PI;var direction : vec3f;direction.x=cos(latitude)*sin(longitude);direction.y=sin(latitude);direction.z=cos(latitude)*cos(longitude);return direction;}
fn sqrtClamped(value: f32)->f32 {return sqrt(max(value,0.));}
fn avg(value: vec3f)->f32 {return dot(value,vec3f(0.333333333));}
`;C.IncludesShadersStoreWGSL[au]||(C.IncludesShadersStoreWGSL[au]=O0);const ou="bonesDeclaration",D0=`#if NUM_BONE_INFLUENCERS>0
attribute matricesIndices : vec4<f32>;attribute matricesWeights : vec4<f32>;
#if NUM_BONE_INFLUENCERS>4
attribute matricesIndicesExtra : vec4<f32>;attribute matricesWeightsExtra : vec4<f32>;
#endif
#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#ifdef BONETEXTURE
var boneSampler : texture_2d<f32>;uniform boneTextureWidth : f32;
#else
uniform mBones : array<mat4x4,BonesPerMesh>;
#ifdef BONES_VELOCITY_ENABLED
uniform mPreviousBones : array<mat4x4,BonesPerMesh>;
#endif
#endif
#ifdef BONETEXTURE
fn readMatrixFromRawSampler(smp : texture_2d<f32>,index : f32)->mat4x4<f32>
{let offset=i32(index) *4; 
let m0=textureLoad(smp,vec2<i32>(offset+0,0),0);let m1=textureLoad(smp,vec2<i32>(offset+1,0),0);let m2=textureLoad(smp,vec2<i32>(offset+2,0),0);let m3=textureLoad(smp,vec2<i32>(offset+3,0),0);return mat4x4<f32>(m0,m1,m2,m3);}
#endif
#endif
#endif
`;C.IncludesShadersStoreWGSL[ou]||(C.IncludesShadersStoreWGSL[ou]=D0);const lu="bakedVertexAnimationDeclaration",L0=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
uniform bakedVertexAnimationTime: f32;uniform bakedVertexAnimationTextureSizeInverted: vec2<f32>;uniform bakedVertexAnimationSettings: vec4<f32>;var bakedVertexAnimationTexture : texture_2d<f32>;
#ifdef INSTANCES
attribute bakedVertexAnimationSettingsInstanced : vec4<f32>;
#endif
fn readMatrixFromRawSamplerVAT(smp : texture_2d<f32>,index : f32,frame : f32)->mat4x4<f32>
{let offset=i32(index)*4;let frameUV=i32(frame);let m0=textureLoad(smp,vec2<i32>(offset+0,frameUV),0);let m1=textureLoad(smp,vec2<i32>(offset+1,frameUV),0);let m2=textureLoad(smp,vec2<i32>(offset+2,frameUV),0);let m3=textureLoad(smp,vec2<i32>(offset+3,frameUV),0);return mat4x4<f32>(m0,m1,m2,m3);}
#endif
`;C.IncludesShadersStoreWGSL[lu]||(C.IncludesShadersStoreWGSL[lu]=L0);const cu="instancesDeclaration",N0=`#ifdef INSTANCES
attribute world0 : vec4<f32>;attribute world1 : vec4<f32>;attribute world2 : vec4<f32>;attribute world3 : vec4<f32>;
#ifdef INSTANCESCOLOR
attribute instanceColor : vec4<f32>;
#endif
#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)
uniform world : mat4x4<f32>;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
attribute previousWorld0 : vec4<f32>;attribute previousWorld1 : vec4<f32>;attribute previousWorld2 : vec4<f32>;attribute previousWorld3 : vec4<f32>;
#ifdef THIN_INSTANCES
uniform previousWorld : mat4x4<f32>;
#endif
#endif
#else
#if !defined(WORLD_UBO)
uniform world : mat4x4<f32>;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
uniform previousWorld : mat4x4<f32>;
#endif
#endif
`;C.IncludesShadersStoreWGSL[cu]||(C.IncludesShadersStoreWGSL[cu]=N0);const hu="prePassVertexDeclaration",F0=`#ifdef PREPASS
#ifdef PREPASS_LOCAL_POSITION
varying vPosition : vec3f;
#endif
#ifdef PREPASS_DEPTH
varying vViewPos: vec3f;
#endif
#if defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)
uniform previousViewProjection: mat4x4f;varying vCurrentPosition: vec4f;varying vPreviousPosition: vec4f;
#endif
#endif
`;C.IncludesShadersStoreWGSL[hu]||(C.IncludesShadersStoreWGSL[hu]=F0);const fu="mainUVVaryingDeclaration",w0=`#ifdef MAINUV{X}
varying vMainUV{X}: vec2f;
#endif
`;C.IncludesShadersStoreWGSL[fu]||(C.IncludesShadersStoreWGSL[fu]=w0);const uu="samplerVertexDeclaration",B0=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
varying v_VARYINGNAME_UV: vec2f;
#endif
`;C.IncludesShadersStoreWGSL[uu]||(C.IncludesShadersStoreWGSL[uu]=B0);const du="bumpVertexDeclaration",U0=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL) 
varying vTBN0: vec3f;varying vTBN1: vec3f;varying vTBN2: vec3f;
#endif
#endif
`;C.IncludesShadersStoreWGSL[du]||(C.IncludesShadersStoreWGSL[du]=U0);const _u="clipPlaneVertexDeclaration",V0=`#ifdef CLIPPLANE
uniform vClipPlane: vec4<f32>;varying fClipDistance: f32;
#endif
#ifdef CLIPPLANE2
uniform vClipPlane2: vec4<f32>;varying fClipDistance2: f32;
#endif
#ifdef CLIPPLANE3
uniform vClipPlane3: vec4<f32>;varying fClipDistance3: f32;
#endif
#ifdef CLIPPLANE4
uniform vClipPlane4: vec4<f32>;varying fClipDistance4: f32;
#endif
#ifdef CLIPPLANE5
uniform vClipPlane5: vec4<f32>;varying fClipDistance5: f32;
#endif
#ifdef CLIPPLANE6
uniform vClipPlane6: vec4<f32>;varying fClipDistance6: f32;
#endif
`;C.IncludesShadersStoreWGSL[_u]||(C.IncludesShadersStoreWGSL[_u]=V0);const pu="fogVertexDeclaration",G0=`#ifdef FOG
varying vFogDistance: vec3f;
#endif
`;C.IncludesShadersStoreWGSL[pu]||(C.IncludesShadersStoreWGSL[pu]=G0);const mu="lightVxFragmentDeclaration",k0=`#ifdef LIGHT{X}
uniform vLightData{X}: vec4f;uniform vLightDiffuse{X}: vec4f;
#ifdef SPECULARTERM
uniform vLightSpecular{X}: vec4f;
#else
var vLightSpecular{X}: vec4f= vec4f(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform lightMatrix{X}: mat4x4f[SHADOWCSMNUM_CASCADES{X}];varying var vPositionFromLight{X}: vec4f[SHADOWCSMNUM_CASCADES{X}];varying var vDepthMetric{X}: f32[SHADOWCSMNUM_CASCADES{X}];varying var vPositionFromCamera{X}: vec4f;
#elif defined(SHADOWCUBE{X})
#else
varying var vPositionFromLight{X}: vec4f;varying var vDepthMetric{X}: f32;uniform lightMatrix{X}: mat4x4f;
#endif
uniform shadowsInfo{X}: vec4f;uniform depthValues{X}: vec2f;
#endif
#ifdef SPOTLIGHT{X}
uniform vLightDirection{X}: vec4f;uniform vLightFalloff{X}: vec4f;
#elif defined(POINTLIGHT{X})
uniform vLightFalloff{X}: vec4f;
#elif defined(HEMILIGHT{X})
uniform vLightGround{X}: vec3f;
#endif
#if defined(AREALIGHT{X})
uniform vLightWidth{X}: vec4f;uniform vLightHeight{X}: vec4f;
#endif
#endif
`;C.IncludesShadersStoreWGSL[mu]||(C.IncludesShadersStoreWGSL[mu]=k0);const gu="lightVxUboDeclaration",W0=`#ifdef LIGHT{X}
struct Light{X}
{vLightData: vec4f,
vLightDiffuse: vec4f,
vLightSpecular: vec4f,
#ifdef SPOTLIGHT{X}
vLightDirection: vec4f,
vLightFalloff: vec4f,
#elif defined(POINTLIGHT{X})
vLightFalloff: vec4f,
#elif defined(HEMILIGHT{X})
vLightGround: vec3f,
#endif
#if defined(AREALIGHT{X})
vLightWidth: vec4f,
vLightHeight: vec4f,
#endif
shadowsInfo: vec4f,
depthValues: vec2f} ;var<uniform> light{X} : Light{X};
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform lightMatrix{X}: array<mat4x4f,SHADOWCSMNUM_CASCADES{X}>;varying vPositionFromLight{X}_0: vec4f;varying vDepthMetric{X}_0: f32;varying vPositionFromLight{X}_1: vec4f;varying vDepthMetric{X}_1: f32;varying vPositionFromLight{X}_2: vec4f;varying vDepthMetric{X}_2: f32;varying vPositionFromLight{X}_3: vec4f;varying vDepthMetric{X}_3: f32;varying vPositionFromCamera{X}: vec4f;
#elif defined(SHADOWCUBE{X})
#else
varying vPositionFromLight{X}: vec4f;varying vDepthMetric{X}: f32;uniform lightMatrix{X}: mat4x4f;
#endif
#endif
#endif
`;C.IncludesShadersStoreWGSL[gu]||(C.IncludesShadersStoreWGSL[gu]=W0);const Eu="morphTargetsVertexGlobalDeclaration",X0=`#ifdef MORPHTARGETS
uniform morphTargetInfluences : array<f32,NUM_MORPH_INFLUENCERS>;
#ifdef MORPHTARGETS_TEXTURE 
uniform morphTargetTextureIndices : array<f32,NUM_MORPH_INFLUENCERS>;uniform morphTargetTextureInfo : vec3<f32>;var morphTargets : texture_2d_array<f32>;var morphTargetsSampler : sampler;fn readVector3FromRawSampler(targetIndex : i32,vertexIndex : f32)->vec3<f32>
{ 
let y=floor(vertexIndex/uniforms.morphTargetTextureInfo.y);let x=vertexIndex-y*uniforms.morphTargetTextureInfo.y;let textureUV=vec2<f32>((x+0.5)/uniforms.morphTargetTextureInfo.y,(y+0.5)/uniforms.morphTargetTextureInfo.z);return textureSampleLevel(morphTargets,morphTargetsSampler,textureUV,i32(uniforms.morphTargetTextureIndices[targetIndex]),0.0).xyz;}
fn readVector4FromRawSampler(targetIndex : i32,vertexIndex : f32)->vec4<f32>
{ 
let y=floor(vertexIndex/uniforms.morphTargetTextureInfo.y);let x=vertexIndex-y*uniforms.morphTargetTextureInfo.y;let textureUV=vec2<f32>((x+0.5)/uniforms.morphTargetTextureInfo.y,(y+0.5)/uniforms.morphTargetTextureInfo.z);return textureSampleLevel(morphTargets,morphTargetsSampler,textureUV,i32(uniforms.morphTargetTextureIndices[targetIndex]),0.0);}
#endif
#endif
`;C.IncludesShadersStoreWGSL[Eu]||(C.IncludesShadersStoreWGSL[Eu]=X0);const vu="morphTargetsVertexDeclaration",H0=`#ifdef MORPHTARGETS
#ifndef MORPHTARGETS_TEXTURE
#ifdef MORPHTARGETS_POSITION
attribute position{X} : vec3<f32>;
#endif
#ifdef MORPHTARGETS_NORMAL
attribute normal{X} : vec3<f32>;
#endif
#ifdef MORPHTARGETS_TANGENT
attribute tangent{X} : vec3<f32>;
#endif
#ifdef MORPHTARGETS_UV
attribute uv_{X} : vec2<f32>;
#endif
#ifdef MORPHTARGETS_UV2
attribute uv2_{X} : vec2<f32>;
#endif
#elif {X}==0
uniform morphTargetCount: i32;
#endif
#endif
`;C.IncludesShadersStoreWGSL[vu]||(C.IncludesShadersStoreWGSL[vu]=H0);const Tu="logDepthDeclaration",z0=`#ifdef LOGARITHMICDEPTH
uniform logarithmicDepthConstant: f32;varying vFragmentDepth: f32;
#endif
`;C.IncludesShadersStoreWGSL[Tu]||(C.IncludesShadersStoreWGSL[Tu]=z0);const Su="morphTargetsVertexGlobal",Y0=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE
var vertexID : f32;
#endif
#endif
`;C.IncludesShadersStoreWGSL[Su]||(C.IncludesShadersStoreWGSL[Su]=Y0);const Au="morphTargetsVertex",K0=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE
#if {X}==0
for (var i=0; i<NUM_MORPH_INFLUENCERS; i=i+1) {if (i>=uniforms.morphTargetCount) {break;}
vertexID=f32(vertexInputs.vertexIndex)*uniforms.morphTargetTextureInfo.x;
#ifdef MORPHTARGETS_POSITION
positionUpdated=positionUpdated+(readVector3FromRawSampler(i,vertexID)-vertexInputs.position)*uniforms.morphTargetInfluences[i];
#endif
#ifdef MORPHTARGETTEXTURE_HASPOSITIONS
vertexID=vertexID+1.0;
#endif
#ifdef MORPHTARGETS_NORMAL
normalUpdated=normalUpdated+(readVector3FromRawSampler(i,vertexID) -vertexInputs.normal)*uniforms.morphTargetInfluences[i];
#endif
#ifdef MORPHTARGETTEXTURE_HASNORMALS
vertexID=vertexID+1.0;
#endif
#ifdef MORPHTARGETS_UV
uvUpdated=uvUpdated+(readVector3FromRawSampler(i,vertexID).xy-vertexInputs.uv)*uniforms.morphTargetInfluences[i];
#endif
#ifdef MORPHTARGETTEXTURE_HASUVS
vertexID=vertexID+1.0;
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated=vec4f(tangentUpdated.xyz+(readVector3FromRawSampler(i,vertexID) -vertexInputs.tangent.xyz)*uniforms.morphTargetInfluences[i],tangentUpdated.a);
#endif
#ifdef MORPHTARGETTEXTURE_HASTANGENTS
vertexID=vertexID+1.0;
#endif
#ifdef MORPHTARGETS_UV2
uv2Updated=uv2Updated+(readVector3FromRawSampler(i,vertexID).xy-vertexInputs.uv2)*uniforms.morphTargetInfluences[i];
#endif
#ifdef MORPHTARGETS_COLOR
colorUpdated=colorUpdated+(readVector4FromRawSampler(i,vertexID)-vertexInputs.color)*uniforms.morphTargetInfluences[i];
#endif
}
#endif
#else
#ifdef MORPHTARGETS_POSITION
positionUpdated=positionUpdated+(vertexInputs.position{X}-vertexInputs.position)*uniforms.morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_NORMAL
normalUpdated=normalUpdated+(vertexInputs.normal{X}-vertexInputs.normal)*uniforms.morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated=vec4f(tangentUpdated.xyz+(vertexInputs.tangent{X}-vertexInputs.tangent.xyz)*uniforms.morphTargetInfluences[{X}],tangentUpdated.a);
#endif
#ifdef MORPHTARGETS_UV
uvUpdated=uvUpdated+(vertexInputs.uv_{X}-vertexInputs.uv)*uniforms.morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_UV2
uv2Updated=uv2Updated+(vertexInputs.uv2_{X}-vertexInputs.uv2)*uniforms.morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_COLOR
colorUpdated=colorUpdated+(vertexInputs.color{X}-vertexInputs.color)*uniforms.morphTargetInfluences[{X}];
#endif
#endif
#endif
`;C.IncludesShadersStoreWGSL[Au]||(C.IncludesShadersStoreWGSL[Au]=K0);const Ru="instancesVertex",q0=`#ifdef INSTANCES
var finalWorld=mat4x4<f32>(vertexInputs.world0,vertexInputs.world1,vertexInputs.world2,vertexInputs.world3);
#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
var finalPreviousWorld=mat4x4<f32>(
vertexInputs.previousWorld0,vertexInputs.previousWorld1,
vertexInputs.previousWorld2,vertexInputs.previousWorld3);
#endif
#ifdef THIN_INSTANCES
#if !defined(WORLD_UBO)
finalWorld=uniforms.world*finalWorld;
#else
finalWorld=mesh.world*finalWorld;
#endif
#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
finalPreviousWorld=uniforms.previousWorld*finalPreviousWorld;
#endif
#endif
#else
#if !defined(WORLD_UBO)
var finalWorld=uniforms.world;
#else
var finalWorld=mesh.world;
#endif
#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
var finalPreviousWorld=uniforms.previousWorld;
#endif
#endif
`;C.IncludesShadersStoreWGSL[Ru]||(C.IncludesShadersStoreWGSL[Ru]=q0);const Cu="bonesVertex",j0=`#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#if NUM_BONE_INFLUENCERS>0
var influence : mat4x4<f32>;
#ifdef BONETEXTURE
influence=readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[0])*vertexInputs.matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[1])*vertexInputs.matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
influence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[2])*vertexInputs.matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
influence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[3])*vertexInputs.matricesWeights[3];
#endif 
#if NUM_BONE_INFLUENCERS>4
influence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[0])*vertexInputs.matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
influence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[1])*vertexInputs.matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
influence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[2])*vertexInputs.matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
influence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[3])*vertexInputs.matricesWeightsExtra[3];
#endif 
#else 
influence=uniforms.mBones[int(vertexInputs.matricesIndices[0])]*vertexInputs.matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence=influence+uniforms.mBones[int(vertexInputs.matricesIndices[1])]*vertexInputs.matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
influence=influence+uniforms.mBones[int(vertexInputs.matricesIndices[2])]*vertexInputs.matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
influence=influence+uniforms.mBones[int(vertexInputs.matricesIndices[3])]*vertexInputs.matricesWeights[3];
#endif 
#if NUM_BONE_INFLUENCERS>4
influence=influence+uniforms.mBones[int(vertexInputs.matricesIndicesExtra[0])]*vertexInputs.matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
influence=influence+uniforms.mBones[int(vertexInputs.matricesIndicesExtra[1])]*vertexInputs.matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
influence=influence+uniforms.mBones[int(vertexInputs.matricesIndicesExtra[2])]*vertexInputs.matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
influence=influence+uniforms.mBones[int(vertexInputs.matricesIndicesExtra[3])]*vertexInputs.matricesWeightsExtra[3];
#endif 
#endif
finalWorld=finalWorld*influence;
#endif
#endif
`;C.IncludesShadersStoreWGSL[Cu]||(C.IncludesShadersStoreWGSL[Cu]=j0);const Iu="bakedVertexAnimation",Z0=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
{
#ifdef INSTANCES
let VATStartFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.x;let VATEndFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.y;let VATOffsetFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.z;let VATSpeed: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.w;
#else
let VATStartFrame: f32=uniforms.bakedVertexAnimationSettings.x;let VATEndFrame: f32=uniforms.bakedVertexAnimationSettings.y;let VATOffsetFrame: f32=uniforms.bakedVertexAnimationSettings.z;let VATSpeed: f32=uniforms.bakedVertexAnimationSettings.w;
#endif
let totalFrames: f32=VATEndFrame-VATStartFrame+1.0;let time: f32=uniforms.bakedVertexAnimationTime*VATSpeed/totalFrames;let frameCorrection: f32=select(1.0,0.0,time<1.0);let numOfFrames: f32=totalFrames-frameCorrection;var VATFrameNum: f32=fract(time)*numOfFrames;VATFrameNum=(VATFrameNum+VATOffsetFrame) % numOfFrames;VATFrameNum=floor(VATFrameNum);VATFrameNum=VATFrameNum+VATStartFrame+frameCorrection;var VATInfluence : mat4x4<f32>;VATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[0],VATFrameNum)*vertexInputs.matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[1],VATFrameNum)*vertexInputs.matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[2],VATFrameNum)*vertexInputs.matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[3],VATFrameNum)*vertexInputs.matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[0],VATFrameNum)*vertexInputs.matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[1],VATFrameNum)*vertexInputs.matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[2],VATFrameNum)*vertexInputs.matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[3],VATFrameNum)*vertexInputs.matricesWeightsExtra[3];
#endif
finalWorld=finalWorld*VATInfluence;}
#endif
`;C.IncludesShadersStoreWGSL[Iu]||(C.IncludesShadersStoreWGSL[Iu]=Z0);const bu="prePassVertex",Q0=`#ifdef PREPASS_DEPTH
vertexOutputs.vViewPos=(scene.view*worldPos).rgb;
#endif
#ifdef PREPASS_LOCAL_POSITION
vertexOutputs.vPosition=positionUpdated.xyz;
#endif
#if (defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && defined(BONES_VELOCITY_ENABLED)
vertexOutputs.vCurrentPosition=scene.viewProjection*worldPos;
#if NUM_BONE_INFLUENCERS>0
var previousInfluence: mat4x4f;previousInfluence=mPreviousBones[ i32(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=mPreviousBones[ i32(matricesIndices[1])]*matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=mPreviousBones[ i32(matricesIndices[2])]*matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=mPreviousBones[ i32(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=mPreviousBones[ i32(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=mPreviousBones[ i32(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=mPreviousBones[ i32(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=mPreviousBones[ i32(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld*previousInfluence* vec4f(positionUpdated,1.0);
#else
vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld* vec4f(positionUpdated,1.0);
#endif
#endif
`;C.IncludesShadersStoreWGSL[bu]||(C.IncludesShadersStoreWGSL[bu]=Q0);const xu="uvVariableDeclaration",$0=`#ifdef MAINUV{X}
#if !defined(UV{X})
var uv{X}: vec2f=vec2f(0.,0.);
#else
var uv{X}: vec2f=vertexInputs.uv{X};
#endif
vertexOutputs.vMainUV{X}=uv{X};
#endif
`;C.IncludesShadersStoreWGSL[xu]||(C.IncludesShadersStoreWGSL[xu]=$0);const yu="samplerVertexImplementation",J0=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
if (uniforms.v_INFONAME_==0.)
{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(uvUpdated,1.0,0.0)).xy;}
#ifdef UV2
else if (uniforms.v_INFONAME_==1.)
{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(uv2Updated,1.0,0.0)).xy;}
#endif
#ifdef UV3
else if (uniforms.v_INFONAME_==2.)
{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(vertexInputs.uv3,1.0,0.0)).xy;}
#endif
#ifdef UV4
else if (uniforms.v_INFONAME_==3.)
{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(vertexInputs.uv4,1.0,0.0)).xy;}
#endif
#ifdef UV5
else if (uniforms.v_INFONAME_==4.)
{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(vertexInputs.uv5,1.0,0.0)).xy;}
#endif
#ifdef UV6
else if (uniforms.v_INFONAME_==5.)
{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(vertexInputs.uv6,1.0,0.0)).xy;}
#endif
#endif
`;C.IncludesShadersStoreWGSL[yu]||(C.IncludesShadersStoreWGSL[yu]=J0);const Mu="bumpVertex",ey=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
var tbnNormal: vec3f=normalize(normalUpdated);var tbnTangent: vec3f=normalize(tangentUpdated.xyz);var tbnBitangent: vec3f=cross(tbnNormal,tbnTangent)*tangentUpdated.w;var matTemp= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz)* mat3x3f(tbnTangent,tbnBitangent,tbnNormal);vertexOutputs.vTBN0=matTemp[0];vertexOutputs.vTBN1=matTemp[1];vertexOutputs.vTBN2=matTemp[2];
#endif
#endif
`;C.IncludesShadersStoreWGSL[Mu]||(C.IncludesShadersStoreWGSL[Mu]=ey);const Pu="clipPlaneVertex",ty=`#ifdef CLIPPLANE
vertexOutputs.fClipDistance=dot(worldPos,uniforms.vClipPlane);
#endif
#ifdef CLIPPLANE2
vertexOutputs.fClipDistance2=dot(worldPos,uniforms.vClipPlane2);
#endif
#ifdef CLIPPLANE3
vertexOutputs.fClipDistance3=dot(worldPos,uniforms.vClipPlane3);
#endif
#ifdef CLIPPLANE4
vertexOutputs.fClipDistance4=dot(worldPos,uniforms.vClipPlane4);
#endif
#ifdef CLIPPLANE5
vertexOutputs.fClipDistance5=dot(worldPos,uniforms.vClipPlane5);
#endif
#ifdef CLIPPLANE6
vertexOutputs.fClipDistance6=dot(worldPos,uniforms.vClipPlane6);
#endif
`;C.IncludesShadersStoreWGSL[Pu]||(C.IncludesShadersStoreWGSL[Pu]=ty);const Ou="fogVertex",iy=`#ifdef FOG
#ifdef SCENE_UBO
vertexOutputs.vFogDistance=(scene.view*worldPos).xyz;
#else
vertexOutputs.vFogDistance=(uniforms.view*worldPos).xyz;
#endif
#endif
`;C.IncludesShadersStoreWGSL[Ou]||(C.IncludesShadersStoreWGSL[Ou]=iy);const Du="shadowsVertex",ry=`#ifdef SHADOWS
#if defined(SHADOWCSM{X})
vertexOutputs.vPositionFromCamera{X}=scene.view*worldPos;
#if SHADOWCSMNUM_CASCADES{X}>0
vertexOutputs.vPositionFromLight{X}_0=uniforms.lightMatrix{X}[0]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetric{X}_0=(-vertexOutputs.vPositionFromLight{X}_0.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vertexOutputs.vDepthMetric{X}_0= (vertexOutputs.vPositionFromLight{X}_0.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif
#if SHADOWCSMNUM_CASCADES{X}>1
vertexOutputs.vPositionFromLight{X}_1=uniforms.lightMatrix{X}[1]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetric{X}_1=(-vertexOutputs.vPositionFromLight{X}_1.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vertexOutputs.vDepthMetric{X}_1= (vertexOutputs.vPositionFromLight{X}_1.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif 
#if SHADOWCSMNUM_CASCADES{X}>2
vertexOutputs.vPositionFromLight{X}_2=uniforms.lightMatrix{X}[2]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetric{X}_2=(-vertexOutputs.vPositionFromLight{X}_2.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vertexOutputs.vDepthMetric{X}_2= (vertexOutputs.vPositionFromLight{X}_2.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif 
#if SHADOWCSMNUM_CASCADES{X}>3
vertexOutputs.vPositionFromLight{X}_3=uniforms.lightMatrix{X}[3]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetric{X}_3=(-vertexOutputs.vPositionFromLight{X}_3.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vertexOutputs.vDepthMetric{X}_3= (vertexOutputs.vPositionFromLight{X}_3.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif 
#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})
vertexOutputs.vPositionFromLight{X}=uniforms.lightMatrix{X}*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetric{X}=(-vertexOutputs.vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vertexOutputs.vDepthMetric{X}=(vertexOutputs.vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif
#endif
`;C.IncludesShadersStoreWGSL[Du]||(C.IncludesShadersStoreWGSL[Du]=ry);const Lu="vertexColorMixing",sy=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
vertexOutputs.vColor=vec4f(1.0);
#ifdef VERTEXCOLOR
#ifdef VERTEXALPHA
vertexOutputs.vColor*=vertexInputs.color;
#else
vertexOutputs.vColor=vec4f(vertexOutputs.vColor.rgb*vertexInputs.color.rgb,vertexOutputs.vColor.a);
#endif
#endif
#ifdef INSTANCESCOLOR
vertexOutputs.vColor*=vertexInputs.instanceColor;
#endif
#endif
`;C.IncludesShadersStoreWGSL[Lu]||(C.IncludesShadersStoreWGSL[Lu]=sy);const Nu="logDepthVertex",ny=`#ifdef LOGARITHMICDEPTH
vertexOutputs.vFragmentDepth=1.0+vertexOutputs.position.w;vertexOutputs.position.z=log2(max(0.000001,vertexOutputs.vFragmentDepth))*uniforms.logarithmicDepthConstant;
#endif
`;C.IncludesShadersStoreWGSL[Nu]||(C.IncludesShadersStoreWGSL[Nu]=ny);const Pl="defaultVertexShader",yE=`#include<defaultUboDeclaration>
#define CUSTOM_VERTEX_BEGIN
attribute position: vec3f;
#ifdef NORMAL
attribute normal: vec3f;
#endif
#ifdef TANGENT
attribute tangent: vec4f;
#endif
#ifdef UV1
attribute uv: vec2f;
#endif
#include<uvAttributeDeclaration>[2..7]
#ifdef VERTEXCOLOR
attribute color: vec4f;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<mainUVVaryingDeclaration>[1..7]
#include<samplerVertexDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#if defined(SPECULARTERM)
#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular)
#endif
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)
varying vPositionW: vec3f;
#ifdef NORMAL
varying vNormalW: vec3f;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vColor: vec4f;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
var positionUpdated: vec3f=vertexInputs.position;
#ifdef NORMAL
var normalUpdated: vec3f=vertexInputs.normal;
#endif
#ifdef TANGENT
var tangentUpdated: vec4f=vertexInputs.tangent;
#endif
#ifdef UV1
var uvUpdated: vec2f=vertexInputs.uv;
#endif
#ifdef UV2
var uv2Updated: vec2f=vertexInputs.uv2;
#endif
#ifdef VERTEXCOLOR
var colorUpdated: vec4f=vertexInputs.color;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vertexOutputs.vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)
vertexOutputs.vCurrentPosition=scene.viewProjection*finalWorld*vec4f(positionUpdated,1.0);vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld*vec4f(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f=finalWorld*vec4f(positionUpdated,1.0);
#ifdef NORMAL
var normalWorld: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vertexOutputs.vNormalW=normalUpdated/ vec3f(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vertexOutputs.vNormalW=normalize(normalWorld*vertexOutputs.vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vertexOutputs.vNormalW=normalize(normalWorld*normalUpdated);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {vertexOutputs.position=scene.viewProjection*worldPos;} else {vertexOutputs.position=scene.viewProjectionR*worldPos;}
#else
vertexOutputs.position=scene.viewProjection*worldPos;
#endif
vertexOutputs.vPositionW= worldPos.xyz;
#ifdef PREPASS
#include<prePassVertex>
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vertexOutputs.vDirectionW=normalize((finalWorld* vec4f(positionUpdated,0.0)).xyz);
#endif
#ifndef UV1
var uvUpdated: vec2f=vec2f(0.,0.);
#endif
#ifdef MAINUV1
vertexOutputs.vMainUV1=uvUpdated;
#endif
#ifndef UV2
var uv2Updated: vec2f=vec2f(0.,0.);
#endif
#ifdef MAINUV2
vertexOutputs.vMainUV2=uv2Updated;
#endif
#include<uvVariableDeclaration>[3..7]
#include<samplerVertexImplementation>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_MATRIXNAME_,diffuse,_INFONAME_,DiffuseInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#if defined(SPECULARTERM)
#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_MATRIXNAME_,specular,_INFONAME_,SpecularInfos.x)
#endif
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;C.ShadersStoreWGSL[Pl]||(C.ShadersStoreWGSL[Pl]=yE);const ay={name:Pl,shader:yE},oy=Object.freeze(Object.defineProperty({__proto__:null,defaultVertexShaderWGSL:ay},Symbol.toStringTag,{value:"Module"})),Fu="prePassDeclaration",ly=`#ifdef PREPASS
#ifdef PREPASS_LOCAL_POSITION
varying vPosition : vec3f;
#endif
#ifdef PREPASS_DEPTH
varying vViewPos: vec3f;
#endif
#if defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)
varying vCurrentPosition: vec4f;varying vPreviousPosition: vec4f;
#endif
#endif
`;C.IncludesShadersStoreWGSL[Fu]||(C.IncludesShadersStoreWGSL[Fu]=ly);const wu="oitDeclaration",cy=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
#define MAX_DEPTH 99999.0
var oitDepthSamplerSampler: sampler;var oitDepthSampler: texture_2d<f32>;var oitFrontColorSamplerSampler: sampler;var oitFrontColorSampler: texture_2d<f32>;
#endif
`;C.IncludesShadersStoreWGSL[wu]||(C.IncludesShadersStoreWGSL[wu]=cy);const Bu="lightUboDeclaration",hy=`#ifdef LIGHT{X}
struct Light{X}
{vLightData: vec4f,
vLightDiffuse: vec4f,
vLightSpecular: vec4f,
#ifdef SPOTLIGHT{X}
vLightDirection: vec4f,
vLightFalloff: vec4f,
#elif defined(POINTLIGHT{X})
vLightFalloff: vec4f,
#elif defined(HEMILIGHT{X})
vLightGround: vec3f,
#endif
#if defined(AREALIGHT{X})
vLightWidth: vec4f,
vLightHeight: vec4f,
#endif
shadowsInfo: vec4f,
depthValues: vec2f} ;var<uniform> light{X} : Light{X};
#ifdef IESLIGHTTEXTURE{X}
var iesLightTexture{X}Sampler: sampler;var iesLightTexture{X}: texture_2d<f32>;
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform textureProjectionMatrix{X}: mat4x4f;var projectionLightTexture{X}Sampler: sampler;var projectionLightTexture{X}: texture_2d<f32>;
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform lightMatrix{X}: array<mat4x4f,SHADOWCSMNUM_CASCADES{X}>;uniform viewFrustumZ{X}: array<f32,SHADOWCSMNUM_CASCADES{X}>;uniform frustumLengths{X}: array<f32,SHADOWCSMNUM_CASCADES{X}>;uniform cascadeBlendFactor{X}: f32;varying vPositionFromLight{X}_0: vec4f;varying vDepthMetric{X}_0: f32;varying vPositionFromLight{X}_1: vec4f;varying vDepthMetric{X}_1: f32;varying vPositionFromLight{X}_2: vec4f;varying vDepthMetric{X}_2: f32;varying vPositionFromLight{X}_3: vec4f;varying vDepthMetric{X}_3: f32;varying vPositionFromCamera{X}: vec4f;var<private> vPositionFromLight{X}: array<vec4f,4>;var<private> vDepthMetric{X} : array<f32,4>;
#if defined(SHADOWPCSS{X})
var shadowTexture{X}Sampler: sampler_comparison; 
var shadowTexture{X}: texture_depth_2d_array;var depthTexture{X}Sampler: sampler;var depthTexture{X}: texture_2d_array<f32>;uniform lightSizeUVCorrection{X}: array<vec2f,SHADOWCSMNUM_CASCADES{X}>;uniform depthCorrection{X}: array<f32,SHADOWCSMNUM_CASCADES{X}>;uniform penumbraDarkness{X}: f32;
#elif defined(SHADOWPCF{X})
var shadowTexture{X}Sampler: sampler_comparison;var shadowTexture{X}: texture_depth_2d_array;
#else 
var shadowTexture{X}Sampler: sampler; 
var shadowTexture{X}: texture_2d_array<f32>;
#endif
#ifdef SHADOWCSMDEBUG{X}
const vCascadeColorsMultiplier{X}: array<vec3f,8>=array<vec3f,8>
(
vec3f ( 1.5,0.0,0.0 ),
vec3f ( 0.0,1.5,0.0 ),
vec3f ( 0.0,0.0,5.5 ),
vec3f ( 1.5,0.0,5.5 ),
vec3f ( 1.5,1.5,0.0 ),
vec3f ( 1.0,1.0,1.0 ),
vec3f ( 0.0,1.0,5.5 ),
vec3f ( 0.5,3.5,0.75 )
);
#endif
#elif defined(SHADOWCUBE{X})
var shadowTexture{X}Sampler: sampler;var shadowTexture{X}: texture_cube<f32>;
#else
varying vPositionFromLight{X}: vec4f;varying vDepthMetric{X}: f32;
#if defined(SHADOWPCSS{X})
var shadowTexture{X}Sampler: sampler_comparison; 
var shadowTexture{X}: texture_depth_2d;var depthTexture{X}Sampler: sampler; 
var depthTexture{X}: texture_2d<f32>;
#elif defined(SHADOWPCF{X})
var shadowTexture{X}Sampler: sampler_comparison;var shadowTexture{X}: texture_depth_2d;
#else
var shadowTexture{X}Sampler: sampler; 
var shadowTexture{X}: texture_2d<f32>;
#endif
uniform lightMatrix{X}: mat4x4f;
#endif
#endif
#endif
`;C.IncludesShadersStoreWGSL[Bu]||(C.IncludesShadersStoreWGSL[Bu]=hy);const Uu="ltcHelperFunctions",fy=`fn LTCUv(N: vec3f,V: vec3f,roughness: f32)->vec2f {var LUTSIZE: f32=64.0;var LUTSCALE: f32=( LUTSIZE-1.0 )/LUTSIZE;var LUTBIAS:f32=0.5/LUTSIZE;var dotNV:f32=saturate( dot( N,V ) );var uv:vec2f=vec2f( roughness,sqrt( 1.0-dotNV ) );uv=uv*LUTSCALE+LUTBIAS;return uv;}
fn LTCClippedSphereFormFactor( f:vec3f )->f32 {var l: f32=length( f );return max( ( l*l+f.z )/( l+1.0 ),0.0 );}
fn LTCEdgeVectorFormFactor( v1:vec3f,v2:vec3f )->vec3f {var x:f32=dot( v1,v2 );var y:f32=abs( x );var a:f32=0.8543985+( 0.4965155+0.0145206*y )*y;var b:f32=3.4175940+( 4.1616724+y )*y;var v:f32=a/b;var thetaSintheta:f32=0.0;if( x>0.0 )
{thetaSintheta=v;}
else
{thetaSintheta=0.5*inverseSqrt( max( 1.0-x*x,0.00000001 ) )-v;}
return cross( v1,v2 )*thetaSintheta;}
fn LTCEvaluate( N:vec3f,V:vec3f,P:vec3f,mInv: mat3x3<f32>,rectCoords0:vec3f,rectCoords1:vec3f,rectCoords2:vec3f,rectCoords3:vec3f )->vec3f {var v1:vec3f=rectCoords1-rectCoords0;var v2:vec3f=rectCoords3-rectCoords0;var lightNormal:vec3f=cross( v1,v2 );if( dot( lightNormal,P-rectCoords0 )<0.0 ){return vec3f( 0.0 );}
var T1:vec3f=normalize( V-N*dot( V,N ) );var T2:vec3f=- cross( N,T1 ); 
var mat: mat3x3<f32>=mInv*transposeMat3( mat3x3<f32>( T1,T2,N ) );var coords0: vec3f=mat*( rectCoords0-P );var coords1: vec3f=mat*( rectCoords1-P );var coords2: vec3f=mat*( rectCoords2-P );var coords3: vec3f=mat*( rectCoords3-P );coords0=normalize( coords0 );coords1=normalize( coords1 );coords2=normalize( coords2 );coords3=normalize( coords3 );var vectorFormFactor:vec3f=vec3( 0.0 );vectorFormFactor+=LTCEdgeVectorFormFactor( coords0,coords1 );vectorFormFactor+=LTCEdgeVectorFormFactor( coords1,coords2 );vectorFormFactor+=LTCEdgeVectorFormFactor( coords2,coords3 );vectorFormFactor+=LTCEdgeVectorFormFactor( coords3,coords0 );var result:f32=LTCClippedSphereFormFactor( vectorFormFactor );return vec3f( result );}
struct areaLightData
{Diffuse: vec3f,
Specular: vec3f,
Fresnel: vec4f};fn computeAreaLightSpecularDiffuseFresnel(ltc1: texture_2d<f32>,ltc1Sampler:sampler,ltc2:texture_2d<f32>,ltc2Sampler:sampler,viewDir: vec3f,normal:vec3f,position:vec3f,lightPos:vec3f,halfWidth:vec3f, halfHeight:vec3f,roughness:f32)->areaLightData {var result: areaLightData;var rectCoords0:vec3f=lightPos+halfWidth-halfHeight; 
var rectCoords1:vec3f=lightPos-halfWidth-halfHeight;var rectCoords2:vec3f=lightPos-halfWidth+halfHeight;var rectCoords3:vec3f=lightPos+halfWidth+halfHeight;
#ifdef SPECULARTERM
var uv:vec2f=LTCUv( normal,viewDir,roughness );var t1:vec4f=textureSample( ltc1,ltc1Sampler,uv );var t2:vec4f=textureSample( ltc2,ltc2Sampler,uv );var mInv:mat3x3<f32>=mat3x3<f32>(
vec3f( t1.x,0,t1.y ),
vec3f( 0,1, 0 ),
vec3f( t1.z,0,t1.w )
);result.Fresnel=t2;result.Specular=LTCEvaluate( normal,viewDir,position,mInv,rectCoords0,rectCoords1,rectCoords2,rectCoords3 );
#endif
var mInvEmpty:mat3x3<f32>=mat3x3<f32>(
vec3f( 1,0,0 ),
vec3f( 0,1,0 ),
vec3f( 0,0,1 )
);result.Diffuse+=LTCEvaluate( normal,viewDir,position,mInvEmpty,rectCoords0,rectCoords1,rectCoords2,rectCoords3 );return result;}`;C.IncludesShadersStoreWGSL[Uu]||(C.IncludesShadersStoreWGSL[Uu]=fy);const Vu="lightsFragmentFunctions",uy=`struct lightingInfo
{diffuse: vec3f,
#ifdef SPECULARTERM
specular: vec3f,
#endif
#ifdef NDOTL
ndl: f32,
#endif
};fn computeLighting(viewDirectionW: vec3f,vNormal: vec3f,lightData: vec4f,diffuseColor: vec3f,specularColor: vec3f,range: f32,glossiness: f32)->lightingInfo {var result: lightingInfo;var lightVectorW: vec3f;var attenuation: f32=1.0;if (lightData.w==0.)
{var direction: vec3f=lightData.xyz-fragmentInputs.vPositionW;var attenuation: f32=max(0.,1.0-length(direction)/range);lightVectorW=normalize(direction);}
else
{lightVectorW=normalize(-lightData.xyz);}
var ndl: f32=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
var angleW: vec3f=normalize(viewDirectionW+lightVectorW);var specComp: f32=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;
#endif
return result;}
fn getAttenuation(cosAngle: f32,exponent: f32)->f32 {return max(0.,pow(cosAngle,exponent));}
fn getIESAttenuation(cosAngle: f32,iesLightTexture: texture_2d<f32>,iesLightTextureSampler: sampler)->f32 {var angle=acos(cosAngle)/PI;return textureSampleLevel(iesLightTexture,iesLightTextureSampler,vec2f(angle,0),0.).r;}
fn computeBasicSpotLighting(viewDirectionW: vec3f,lightVectorW: vec3f,vNormal: vec3f,attenuation: f32,diffuseColor: vec3f,specularColor: vec3f,glossiness: f32)->lightingInfo {var result: lightingInfo;var ndl: f32=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
var angleW: vec3f=normalize(viewDirectionW+lightVectorW);var specComp: f32=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;
#endif
return result;}
fn computeIESSpotLighting(viewDirectionW: vec3f,vNormal: vec3f,lightData: vec4f,lightDirection: vec4f,diffuseColor: vec3f,specularColor: vec3f,range: f32,glossiness: f32,iesLightTexture: texture_2d<f32>,iesLightTextureSampler: sampler)->lightingInfo {var direction: vec3f=lightData.xyz-fragmentInputs.vPositionW;var lightVectorW: vec3f=normalize(direction);var attenuation: f32=max(0.,1.0-length(direction)/range);var dotProduct=dot(lightDirection.xyz,-lightVectorW);var cosAngle: f32=max(0.,dotProduct);if (cosAngle>=lightDirection.w)
{attenuation*=getIESAttenuation(dotProduct,iesLightTexture,iesLightTextureSampler);return computeBasicSpotLighting(viewDirectionW,lightVectorW,vNormal,attenuation,diffuseColor,specularColor,glossiness);}
var result: lightingInfo;result.diffuse=vec3f(0.);
#ifdef SPECULARTERM
result.specular=vec3f(0.);
#endif
#ifdef NDOTL
result.ndl=0.;
#endif
return result;}
fn computeSpotLighting(viewDirectionW: vec3f,vNormal: vec3f ,lightData: vec4f,lightDirection: vec4f,diffuseColor: vec3f,specularColor: vec3f,range: f32,glossiness: f32)->lightingInfo {var direction: vec3f=lightData.xyz-fragmentInputs.vPositionW;var lightVectorW: vec3f=normalize(direction);var attenuation: f32=max(0.,1.0-length(direction)/range);var cosAngle: f32=max(0.,dot(lightDirection.xyz,-lightVectorW));if (cosAngle>=lightDirection.w)
{attenuation*=getAttenuation(cosAngle,lightData.w);return computeBasicSpotLighting(viewDirectionW,lightVectorW,vNormal,attenuation,diffuseColor,specularColor,glossiness);}
var result: lightingInfo;result.diffuse=vec3f(0.);
#ifdef SPECULARTERM
result.specular=vec3f(0.);
#endif
#ifdef NDOTL
result.ndl=0.;
#endif
return result;}
fn computeHemisphericLighting(viewDirectionW: vec3f,vNormal: vec3f,lightData: vec4f,diffuseColor: vec3f,specularColor: vec3f,groundColor: vec3f,glossiness: f32)->lightingInfo {var result: lightingInfo;var ndl: f32=dot(vNormal,lightData.xyz)*0.5+0.5;
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=mix(groundColor,diffuseColor,ndl);
#ifdef SPECULARTERM
var angleW: vec3f=normalize(viewDirectionW+lightData.xyz);var specComp: f32=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor;
#endif
return result;}
fn computeProjectionTextureDiffuseLighting(projectionLightTexture: texture_2d<f32>,projectionLightSampler: sampler,textureProjectionMatrix: mat4x4f,posW: vec3f)->vec3f {var strq: vec4f=textureProjectionMatrix*vec4f(posW,1.0);strq/=strq.w;var textureColor: vec3f=textureSample(projectionLightTexture,projectionLightSampler,strq.xy).rgb;return textureColor;}
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
#include<ltcHelperFunctions>
var areaLightsLTC1SamplerSampler: sampler;var areaLightsLTC1Sampler: texture_2d<f32>;var areaLightsLTC2SamplerSampler: sampler;var areaLightsLTC2Sampler: texture_2d<f32>;fn computeAreaLighting(ltc1: texture_2d<f32>,ltc1Sampler:sampler,ltc2:texture_2d<f32>,ltc2Sampler:sampler,viewDirectionW: vec3f,vNormal:vec3f,vPosition:vec3f,lightPosition:vec3f,halfWidth:vec3f, halfHeight:vec3f,diffuseColor:vec3f,specularColor:vec3f,roughness:f32 )->lightingInfo
{var result: lightingInfo;var data: areaLightData=computeAreaLightSpecularDiffuseFresnel(ltc1,ltc1Sampler,ltc2,ltc2Sampler,viewDirectionW,vNormal,vPosition,lightPosition,halfWidth,halfHeight,roughness);
#ifdef SPECULARTERM
var fresnel:vec3f=( specularColor*data.Fresnel.x+( vec3f( 1.0 )-specularColor )*data.Fresnel.y );result.specular+=specularColor*fresnel*data.Specular;
#endif
result.diffuse+=diffuseColor*data.Diffuse;return result;}
#endif
`;C.IncludesShadersStoreWGSL[Vu]||(C.IncludesShadersStoreWGSL[Vu]=uy);const Gu="shadowsFragmentFunctions",dy=`#ifdef SHADOWS
#ifndef SHADOWFLOAT
fn unpack(color: vec4f)->f32
{const bit_shift: vec4f= vec4f(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}
#endif
fn computeFallOff(value: f32,clipSpace: vec2f,frustumEdgeFalloff: f32)->f32
{var mask: f32=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));return mix(value,1.0,mask);}
fn computeShadowCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,darkness: f32,depthValues: vec2f)->f32
{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
var shadow: f32=unpack(textureSample(shadowTexture,shadowSampler,directionToLight));
#else
var shadow: f32=textureSample(shadowTexture,shadowSampler,directionToLight).x;
#endif
return select(1.0,darkness,depth>shadow);}
fn computeShadowWithPoissonSamplingCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,mapSize: f32,darkness: f32,depthValues: vec2f)->f32
{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;var visibility: f32=1.;var poissonDisk: array<vec3f,4>;poissonDisk[0]= vec3f(-1.0,1.0,-1.0);poissonDisk[1]= vec3f(1.0,-1.0,-1.0);poissonDisk[2]= vec3f(-1.0,-1.0,-1.0);poissonDisk[3]= vec3f(1.0,-1.0,1.0);
#ifndef SHADOWFLOAT
if (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) {visibility-=0.25;};if (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) {visibility-=0.25;};if (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) {visibility-=0.25;};if (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) {visibility-=0.25;};
#else
if (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) {visibility-=0.25;};if (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) {visibility-=0.25;};if (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) {visibility-=0.25;};if (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) {visibility-=0.25;};
#endif
return min(1.0,visibility+darkness);}
fn computeShadowWithESMCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,depthValues: vec2f)->f32
{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);var shadowPixelDepth: f32=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
var shadowMapSample: f32=unpack(textureSample(shadowTexture,shadowSampler,directionToLight));
#else
var shadowMapSample: f32=textureSample(shadowTexture,shadowSampler,directionToLight).x;
#endif
var esm: f32=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return esm;}
fn computeShadowWithCloseESMCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,depthValues: vec2f)->f32
{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);var shadowPixelDepth: f32=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
var shadowMapSample: f32=unpack(textureSample(shadowTexture,shadowSampler,directionToLight));
#else
var shadowMapSample: f32=textureSample(shadowTexture,shadowSampler,directionToLight).x;
#endif
var esm: f32=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return esm;}
fn computeShadowCSM(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d_array<f32>,shadowSampler: sampler,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
var shadow: f32=unpack(textureSample(shadowTexture,shadowSampler,uv,layer));
#else
var shadow: f32=textureSample(shadowTexture,shadowSampler,uv,layer).x;
#endif
return select(1.,computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff),shadowPixelDepth>shadow );}
fn computeShadow(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
var shadow: f32=unpack(textureSampleLevel(shadowTexture,shadowSampler,uv,0.));
#else
var shadow: f32=textureSampleLevel(shadowTexture,shadowSampler,uv,0.).x;
#endif
return select(1.,computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff),shadowPixelDepth>shadow );}}
fn computeShadowWithPoissonSampling(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,mapSize: f32,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);var visibility: f32=1.;var poissonDisk: array<vec2f,4>;poissonDisk[0]= vec2f(-0.94201624,-0.39906216);poissonDisk[1]= vec2f(0.94558609,-0.76890725);poissonDisk[2]= vec2f(-0.094184101,-0.92938870);poissonDisk[3]= vec2f(0.34495938,0.29387760);
#ifndef SHADOWFLOAT
if (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[0]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}
if (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[1]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}
if (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[2]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}
if (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[3]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}
#else
if (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[0]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}
if (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[1]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}
if (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[2]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}
if (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[3]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}
#endif
return computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);}}
fn computeShadowWithESM(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
var shadowMapSample: f32=unpack(textureSampleLevel(shadowTexture,shadowSampler,uv,0.));
#else
var shadowMapSample: f32=textureSampleLevel(shadowTexture,shadowSampler,uv,0.).x;
#endif
var esm: f32=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}
fn computeShadowWithCloseESM(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0); 
#ifndef SHADOWFLOAT
var shadowMapSample: f32=unpack(textureSampleLevel(shadowTexture,shadowSampler,uv,0.));
#else
var shadowMapSample: f32=textureSampleLevel(shadowTexture,shadowSampler,uv,0.).x;
#endif
var esm: f32=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}
fn getZInClip(clipSpace: vec3f,uvDepth: vec3f)->f32
{
#ifdef IS_NDC_HALF_ZRANGE
return clipSpace.z;
#else
return uvDepth.z;
#endif
}
const GREATEST_LESS_THAN_ONE: f32=0.99999994;
#define DISABLE_UNIFORMITY_ANALYSIS
fn computeShadowWithCSMPCF1(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var shadow: f32=textureSampleCompare(shadowTexture,shadowSampler,uvDepth.xy,layer,uvDepth.z);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
fn computeShadowWithCSMPCF3(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
var st: vec2f=fract(uv); 
var base_uv: vec2f=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
var uvw0: vec2f=3.-2.*st;var uvw1: vec2f=1.+2.*st;var u: vec2f= vec2f((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;var v: vec2f= vec2f((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),layer,uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),layer,uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),layer,uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),layer,uvDepth.z);shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
fn computeShadowWithCSMPCF5(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
var st: vec2f=fract(uv); 
var base_uv: vec2f=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
var uvw0: vec2f=4.-3.*st;var uvw1: vec2f= vec2f(7.);var uvw2: vec2f=1.+3.*st;var u: vec3f= vec3f((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;var v: vec3f= vec3f((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),layer,uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),layer,uvDepth.z);shadow+=uvw2.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[0]),layer,uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),layer,uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),layer,uvDepth.z);shadow+=uvw2.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[1]),layer,uvDepth.z);shadow+=uvw0.x*uvw2.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[2]),layer,uvDepth.z);shadow+=uvw1.x*uvw2.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[2]),layer,uvDepth.z);shadow+=uvw2.x*uvw2.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[2]),layer,uvDepth.z);shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
fn computeShadowWithPCF1(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,darkness: f32,frustumEdgeFalloff: f32)->f32
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var shadow: f32=textureSampleCompareLevel(shadowTexture,shadowSampler,uvDepth.xy,uvDepth.z);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
fn computeShadowWithPCF3(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
var st: vec2f=fract(uv); 
var base_uv: vec2f=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
var uvw0: vec2f=3.-2.*st;var uvw1: vec2f=1.+2.*st;var u: vec2f= vec2f((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;var v: vec2f= vec2f((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),uvDepth.z);shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
fn computeShadowWithPCF5(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
var st: vec2f=fract(uv); 
var base_uv: vec2f=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
var uvw0: vec2f=4.-3.*st;var uvw1: vec2f= vec2f(7.);var uvw2: vec2f=1.+3.*st;var u: vec3f= vec3f((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;var v: vec3f= vec3f((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),uvDepth.z);shadow+=uvw2.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[0]),uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),uvDepth.z);shadow+=uvw2.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[1]),uvDepth.z);shadow+=uvw0.x*uvw2.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[2]),uvDepth.z);shadow+=uvw1.x*uvw2.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[2]),uvDepth.z);shadow+=uvw2.x*uvw2.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[2]),uvDepth.z);shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
const PoissonSamplers32: array<vec3f,64>=array<vec3f,64> (
vec3f(0.06407013,0.05409927,0.),
vec3f(0.7366577,0.5789394,0.),
vec3f(-0.6270542,-0.5320278,0.),
vec3f(-0.4096107,0.8411095,0.),
vec3f(0.6849564,-0.4990818,0.),
vec3f(-0.874181,-0.04579735,0.),
vec3f(0.9989998,0.0009880066,0.),
vec3f(-0.004920578,-0.9151649,0.),
vec3f(0.1805763,0.9747483,0.),
vec3f(-0.2138451,0.2635818,0.),
vec3f(0.109845,0.3884785,0.),
vec3f(0.06876755,-0.3581074,0.),
vec3f(0.374073,-0.7661266,0.),
vec3f(0.3079132,-0.1216763,0.),
vec3f(-0.3794335,-0.8271583,0.),
vec3f(-0.203878,-0.07715034,0.),
vec3f(0.5912697,0.1469799,0.),
vec3f(-0.88069,0.3031784,0.),
vec3f(0.5040108,0.8283722,0.),
vec3f(-0.5844124,0.5494877,0.),
vec3f(0.6017799,-0.1726654,0.),
vec3f(-0.5554981,0.1559997,0.),
vec3f(-0.3016369,-0.3900928,0.),
vec3f(-0.5550632,-0.1723762,0.),
vec3f(0.925029,0.2995041,0.),
vec3f(-0.2473137,0.5538505,0.),
vec3f(0.9183037,-0.2862392,0.),
vec3f(0.2469421,0.6718712,0.),
vec3f(0.3916397,-0.4328209,0.),
vec3f(-0.03576927,-0.6220032,0.),
vec3f(-0.04661255,0.7995201,0.),
vec3f(0.4402924,0.3640312,0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.)
);const PoissonSamplers64: array<vec3f,64>=array<vec3f,64> (
vec3f(-0.613392,0.617481,0.),
vec3f(0.170019,-0.040254,0.),
vec3f(-0.299417,0.791925,0.),
vec3f(0.645680,0.493210,0.),
vec3f(-0.651784,0.717887,0.),
vec3f(0.421003,0.027070,0.),
vec3f(-0.817194,-0.271096,0.),
vec3f(-0.705374,-0.668203,0.),
vec3f(0.977050,-0.108615,0.),
vec3f(0.063326,0.142369,0.),
vec3f(0.203528,0.214331,0.),
vec3f(-0.667531,0.326090,0.),
vec3f(-0.098422,-0.295755,0.),
vec3f(-0.885922,0.215369,0.),
vec3f(0.566637,0.605213,0.),
vec3f(0.039766,-0.396100,0.),
vec3f(0.751946,0.453352,0.),
vec3f(0.078707,-0.715323,0.),
vec3f(-0.075838,-0.529344,0.),
vec3f(0.724479,-0.580798,0.),
vec3f(0.222999,-0.215125,0.),
vec3f(-0.467574,-0.405438,0.),
vec3f(-0.248268,-0.814753,0.),
vec3f(0.354411,-0.887570,0.),
vec3f(0.175817,0.382366,0.),
vec3f(0.487472,-0.063082,0.),
vec3f(-0.084078,0.898312,0.),
vec3f(0.488876,-0.783441,0.),
vec3f(0.470016,0.217933,0.),
vec3f(-0.696890,-0.549791,0.),
vec3f(-0.149693,0.605762,0.),
vec3f(0.034211,0.979980,0.),
vec3f(0.503098,-0.308878,0.),
vec3f(-0.016205,-0.872921,0.),
vec3f(0.385784,-0.393902,0.),
vec3f(-0.146886,-0.859249,0.),
vec3f(0.643361,0.164098,0.),
vec3f(0.634388,-0.049471,0.),
vec3f(-0.688894,0.007843,0.),
vec3f(0.464034,-0.188818,0.),
vec3f(-0.440840,0.137486,0.),
vec3f(0.364483,0.511704,0.),
vec3f(0.034028,0.325968,0.),
vec3f(0.099094,-0.308023,0.),
vec3f(0.693960,-0.366253,0.),
vec3f(0.678884,-0.204688,0.),
vec3f(0.001801,0.780328,0.),
vec3f(0.145177,-0.898984,0.),
vec3f(0.062655,-0.611866,0.),
vec3f(0.315226,-0.604297,0.),
vec3f(-0.780145,0.486251,0.),
vec3f(-0.371868,0.882138,0.),
vec3f(0.200476,0.494430,0.),
vec3f(-0.494552,-0.711051,0.),
vec3f(0.612476,0.705252,0.),
vec3f(-0.578845,-0.768792,0.),
vec3f(-0.772454,-0.090976,0.),
vec3f(0.504440,0.372295,0.),
vec3f(0.155736,0.065157,0.),
vec3f(0.391522,0.849605,0.),
vec3f(-0.620106,-0.328104,0.),
vec3f(0.789239,-0.419965,0.),
vec3f(-0.545396,0.538133,0.),
vec3f(-0.178564,-0.596057,0.)
);fn computeShadowWithCSMPCSS(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,searchTapCount: i32,pcfTapCount: i32,poissonSamplers: array<vec3f,64>,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var uvDepthLayer: vec4f= vec4f(uvDepth.x,uvDepth.y,f32(layer),uvDepth.z);var blockerDepth: f32=0.0;var sumBlockerDepth: f32=0.0;var numBlocker: f32=0.0;for (var i: i32=0; i<searchTapCount; i ++) {blockerDepth=textureSample(depthTexture,depthSampler, uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer).r;numBlocker+=select(0.,1.,blockerDepth<depthMetric);sumBlockerDepth+=select(0.,blockerDepth,blockerDepth<depthMetric);}
var avgBlockerDepth: f32=sumBlockerDepth/numBlocker;var AAOffset: f32=shadowMapSizeInverse*10.;var penumbraRatio: f32=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);var filterRadius: vec4f= vec4f(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);var random: f32=getRand(vPositionFromLight.xy);var rotationAngle: f32=random*3.1415926;var rotationVector: vec2f= vec2f(cos(rotationAngle),sin(rotationAngle));var shadow: f32=0.;for (var i: i32=0; i<pcfTapCount; i++) {var offset: vec4f= vec4f(poissonSamplers[i],0.);offset= vec4f(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);let coords=uvDepthLayer+offset*filterRadius;shadow+=textureSampleCompare(shadowTexture,shadowSampler,coords.xy,i32(coords.z),coords.w);}
shadow/= f32(pcfTapCount);shadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));shadow=mix(darkness,1.,shadow);return select(computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff),1.0,numBlocker<1.0);}
fn computeShadowWithPCSS(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,searchTapCount: i32,pcfTapCount: i32,poissonSamplers: array<vec3f,64>)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var blockerDepth: f32=0.0;var sumBlockerDepth: f32=0.0;var numBlocker: f32=0.0;var exitCondition: bool=depthMetric>1.0 || depthMetric<0.0;for (var i: i32=0; i<searchTapCount; i ++) {if (exitCondition) {break;}
blockerDepth=textureSampleLevel(depthTexture,depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy),0).r;numBlocker+=select(0.,1.,blockerDepth<depthMetric);sumBlockerDepth+=select(0.,blockerDepth,blockerDepth<depthMetric);}
exitCondition=exitCondition || numBlocker<1.0;var avgBlockerDepth: f32=sumBlockerDepth/numBlocker;var AAOffset: f32=shadowMapSizeInverse*10.;var penumbraRatio: f32=((depthMetric-avgBlockerDepth)+AAOffset);var filterRadius: f32=penumbraRatio*lightSizeUV*shadowMapSizeInverse;var random: f32=getRand(vPositionFromLight.xy);var rotationAngle: f32=random*3.1415926;var rotationVector: vec2f= vec2f(cos(rotationAngle),sin(rotationAngle));var shadow: f32=0.;for (var i: i32=0; i<pcfTapCount; i++) {if (exitCondition) {break;}
var offset: vec3f=poissonSamplers[i];offset= vec3f(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);let coords=uvDepth+offset*filterRadius;shadow+=textureSampleCompareLevel(shadowTexture,shadowSampler,coords.xy,coords.z);}
shadow/= f32(pcfTapCount);shadow=mix(shadow,1.,depthMetric-avgBlockerDepth);shadow=mix(darkness,1.,shadow);return select(computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff),1.0,exitCondition);}
fn computeShadowWithPCSS16(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32)->f32
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);}
fn computeShadowWithPCSS32(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32)->f32
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);}
fn computeShadowWithPCSS64(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32)->f32
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);}
fn computeShadowWithCSMPCSS16(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
fn computeShadowWithCSMPCSS32(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
fn computeShadowWithCSMPCSS64(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
#endif
`;C.IncludesShadersStoreWGSL[Gu]||(C.IncludesShadersStoreWGSL[Gu]=dy);const ku="samplerFragmentDeclaration",_y=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying v_VARYINGNAME_UV: vec2f;
#endif
var _SAMPLERNAME_SamplerSampler: sampler;var _SAMPLERNAME_Sampler: texture_2d<f32>;
#endif
`;C.IncludesShadersStoreWGSL[ku]||(C.IncludesShadersStoreWGSL[ku]=_y);const Wu="fresnelFunction",py=`#ifdef FRESNEL
fn computeFresnelTerm(viewDirection: vec3f,worldNormal: vec3f,bias: f32,power: f32)->f32
{let fresnelTerm: f32=pow(bias+abs(dot(viewDirection,worldNormal)),power);return clamp(fresnelTerm,0.,1.);}
#endif
`;C.IncludesShadersStoreWGSL[Wu]||(C.IncludesShadersStoreWGSL[Wu]=py);const Xu="reflectionFunction",my=`fn computeFixedEquirectangularCoords(worldPos: vec4f,worldNormal: vec3f,direction: vec3f)->vec3f
{var lon: f32=atan2(direction.z,direction.x);var lat: f32=acos(direction.y);var sphereCoords: vec2f= vec2f(lon,lat)*RECIPROCAL_PI2*2.0;var s: f32=sphereCoords.x*0.5+0.5;var t: f32=sphereCoords.y;return vec3f(s,t,0); }
fn computeMirroredFixedEquirectangularCoords(worldPos: vec4f,worldNormal: vec3f,direction: vec3f)->vec3f
{var lon: f32=atan2(direction.z,direction.x);var lat: f32=acos(direction.y);var sphereCoords: vec2f= vec2f(lon,lat)*RECIPROCAL_PI2*2.0;var s: f32=sphereCoords.x*0.5+0.5;var t: f32=sphereCoords.y;return vec3f(1.0-s,t,0); }
fn computeEquirectangularCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f)->vec3f
{var cameraToVertex: vec3f=normalize(worldPos.xyz-eyePosition);var r: vec3f=normalize(reflect(cameraToVertex,worldNormal));r= (reflectionMatrix* vec4f(r,0)).xyz;var lon: f32=atan2(r.z,r.x);var lat: f32=acos(r.y);var sphereCoords: vec2f= vec2f(lon,lat)*RECIPROCAL_PI2*2.0;var s: f32=sphereCoords.x*0.5+0.5;var t: f32=sphereCoords.y;return vec3f(s,t,0);}
fn computeSphericalCoords(worldPos: vec4f,worldNormal: vec3f,view: mat4x4f,reflectionMatrix: mat4x4f)->vec3f
{var viewDir: vec3f=normalize((view*worldPos).xyz);var viewNormal: vec3f=normalize((view* vec4f(worldNormal,0.0)).xyz);var r: vec3f=reflect(viewDir,viewNormal);r= (reflectionMatrix* vec4f(r,0)).xyz;r.z=r.z-1.0;var m: f32=2.0*length(r);return vec3f(r.x/m+0.5,1.0-r.y/m-0.5,0);}
fn computePlanarCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f)->vec3f
{var viewDir: vec3f=worldPos.xyz-eyePosition;var coords: vec3f=normalize(reflect(viewDir,worldNormal));return (reflectionMatrix* vec4f(coords,1)).xyz;}
fn computeCubicCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f)->vec3f
{var viewDir: vec3f=normalize(worldPos.xyz-eyePosition);var coords: vec3f=reflect(viewDir,worldNormal);coords= (reflectionMatrix* vec4f(coords,0)).xyz;
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;}
fn computeCubicLocalCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f,reflectionSize: vec3f,reflectionPosition: vec3f)->vec3f
{var viewDir: vec3f=normalize(worldPos.xyz-eyePosition);var coords: vec3f=reflect(viewDir,worldNormal);coords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);coords=(reflectionMatrix* vec4f(coords,0)).xyz;
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;}
fn computeProjectionCoords(worldPos: vec4f,view: mat4x4f,reflectionMatrix: mat4x4f)->vec3f
{return (reflectionMatrix*(view*worldPos)).xyz;}
fn computeSkyBoxCoords(positionW: vec3f,reflectionMatrix: mat4x4f)->vec3f
{return (reflectionMatrix* vec4f(positionW,1.)).xyz;}
#ifdef REFLECTION
fn computeReflectionCoords(worldPos: vec4f,worldNormal: vec3f)->vec3f
{
#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED
var direction: vec3f=normalize(fragmentInputs.vDirectionW);return computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED
var direction: vec3f=normalize(fragmentInputs.vDirectionW);return computeFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR
return computeEquirectangularCoords(worldPos,worldNormal,scene.vEyePosition.xyz,uniforms.reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SPHERICAL
return computeSphericalCoords(worldPos,worldNormal,scene.view,uniforms.reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_PLANAR
return computePlanarCoords(worldPos,worldNormal,scene.vEyePosition.xyz,uniforms.reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_CUBIC
#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC
return computeCubicLocalCoords(worldPos,worldNormal,scene.vEyePosition.xyz,uniforms.reflectionMatrix,uniforms.vReflectionSize,uniforms.vReflectionPosition);
#else
return computeCubicCoords(worldPos,worldNormal,scene.vEyePosition.xyz,uniforms.reflectionMatrix);
#endif
#endif
#ifdef REFLECTIONMAP_PROJECTION
return computeProjectionCoords(worldPos,scene.view,uniforms.reflectionMatrix);
#endif
#ifndef REFLECTIONMAP_CUBIC
#ifdef REFLECTIONMAP_SKYBOX
return computeSkyBoxCoords(fragmentInputs.vPositionUVW,uniforms.reflectionMatrix);
#endif
#endif
#ifdef REFLECTIONMAP_EXPLICIT
return vec3f(0,0,0);
#endif
}
#endif
`;C.IncludesShadersStoreWGSL[Xu]||(C.IncludesShadersStoreWGSL[Xu]=my);const Hu="imageProcessingDeclaration",gy=`#ifdef EXPOSURE
uniform exposureLinear: f32;
#endif
#ifdef CONTRAST
uniform contrast: f32;
#endif
#if defined(VIGNETTE) || defined(DITHER)
uniform vInverseScreenSize: vec2f;
#endif
#ifdef VIGNETTE
uniform vignetteSettings1: vec4f;uniform vignetteSettings2: vec4f;
#endif
#ifdef COLORCURVES
uniform vCameraColorCurveNegative: vec4f;uniform vCameraColorCurveNeutral: vec4f;uniform vCameraColorCurvePositive: vec4f;
#endif
#ifdef COLORGRADING
#ifdef COLORGRADING3D
var txColorTransformSampler: sampler;var txColorTransform: texture_3d<f32>;
#else
var txColorTransformSampler: sampler;var txColorTransform: texture_2d<f32>;
#endif
uniform colorTransformSettings: vec4f;
#endif
#ifdef DITHER
uniform ditherIntensity: f32;
#endif
`;C.IncludesShadersStoreWGSL[Hu]||(C.IncludesShadersStoreWGSL[Hu]=gy);const zu="imageProcessingFunctions",Ey=`#if TONEMAPPING==3
const PBRNeutralStartCompression: f32=0.8-0.04;const PBRNeutralDesaturation: f32=0.15;fn PBRNeutralToneMapping( color: vec3f )->vec3f {var x: f32=min(color.r,min(color.g,color.b));var offset: f32=select(0.04,x-6.25*x*x,x<0.08);var result=color;result-=offset;var peak: f32=max(result.r,max(result.g,result.b));if (peak<PBRNeutralStartCompression) {return result;}
var d: f32=1.-PBRNeutralStartCompression;var newPeak: f32=1.-d*d/(peak+d-PBRNeutralStartCompression);result*=newPeak/peak;var g: f32=1.-1./(PBRNeutralDesaturation*(peak-newPeak)+1.);return mix(result,newPeak* vec3f(1,1,1),g);}
#endif
#if TONEMAPPING==2
const ACESInputMat: mat3x3f= mat3x3f(
vec3f(0.59719,0.07600,0.02840),
vec3f(0.35458,0.90834,0.13383),
vec3f(0.04823,0.01566,0.83777)
);const ACESOutputMat: mat3x3f= mat3x3f(
vec3f( 1.60475,-0.10208,-0.00327),
vec3f(-0.53108, 1.10813,-0.07276),
vec3f(-0.07367,-0.00605, 1.07602)
);fn RRTAndODTFit(v: vec3f)->vec3f
{var a: vec3f=v*(v+0.0245786)-0.000090537;var b: vec3f=v*(0.983729*v+0.4329510)+0.238081;return a/b;}
fn ACESFitted(color: vec3f)->vec3f
{var output=ACESInputMat*color;output=RRTAndODTFit(output);output=ACESOutputMat*output;output=saturateVec3(output);return output;}
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_DEFINITIONS
fn applyImageProcessing(result: vec4f)->vec4f {
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATSTART
var rgb=result.rgb;;
#ifdef EXPOSURE
rgb*=uniforms.exposureLinear;
#endif
#ifdef VIGNETTE
var viewportXY: vec2f=fragmentInputs.position.xy*uniforms.vInverseScreenSize;viewportXY=viewportXY*2.0-1.0;var vignetteXY1: vec3f= vec3f(viewportXY*uniforms.vignetteSettings1.xy+uniforms.vignetteSettings1.zw,1.0);var vignetteTerm: f32=dot(vignetteXY1,vignetteXY1);var vignette: f32=pow(vignetteTerm,uniforms.vignetteSettings2.w);var vignetteColor: vec3f=uniforms.vignetteSettings2.rgb;
#ifdef VIGNETTEBLENDMODEMULTIPLY
var vignetteColorMultiplier: vec3f=mix(vignetteColor, vec3f(1,1,1),vignette);rgb*=vignetteColorMultiplier;
#endif
#ifdef VIGNETTEBLENDMODEOPAQUE
rgb=mix(vignetteColor,rgb,vignette);
#endif
#endif
#if TONEMAPPING==3
rgb=PBRNeutralToneMapping(rgb);
#elif TONEMAPPING==2
rgb=ACESFitted(rgb);
#elif TONEMAPPING==1
const tonemappingCalibration: f32=1.590579;rgb=1.0-exp2(-tonemappingCalibration*rgb);
#endif
rgb=toGammaSpaceVec3(rgb);rgb=saturateVec3(rgb);
#ifdef CONTRAST
var resultHighContrast: vec3f=rgb*rgb*(3.0-2.0*rgb);if (uniforms.contrast<1.0) {rgb=mix( vec3f(0.5,0.5,0.5),rgb,uniforms.contrast);} else {rgb=mix(rgb,resultHighContrast,uniforms.contrast-1.0);}
#endif
#ifdef COLORGRADING
var colorTransformInput: vec3f=rgb*uniforms.colorTransformSettings.xxx+uniforms.colorTransformSettings.yyy;
#ifdef COLORGRADING3D
var colorTransformOutput: vec3f=textureSample(txColorTransform,txColorTransformSampler,colorTransformInput).rgb;
#else
var colorTransformOutput: vec3f=textureSample(txColorTransform,txColorTransformSampler,colorTransformInput,uniforms.colorTransformSettings.yz).rgb;
#endif
rgb=mix(rgb,colorTransformOutput,uniforms.colorTransformSettings.www);
#endif
#ifdef COLORCURVES
var luma: f32=getLuminance(rgb);var curveMix: vec2f=clamp( vec2f(luma*3.0-1.5,luma*-3.0+1.5), vec2f(0.0), vec2f(1.0));var colorCurve: vec4f=uniforms.vCameraColorCurveNeutral+curveMix.x*uniforms.vCameraColorCurvePositive-curveMix.y*uniforms.vCameraColorCurveNegative;rgb*=colorCurve.rgb;rgb=mix( vec3f(luma),rgb,colorCurve.a);
#endif
#ifdef DITHER
var rand: f32=getRand(fragmentInputs.position.xy*uniforms.vInverseScreenSize);var dither: f32=mix(-uniforms.ditherIntensity,uniforms.ditherIntensity,rand);rgb=saturateVec3(rgb+ vec3f(dither));
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATEND
return vec4f(rgb,result.a);}`;C.IncludesShadersStoreWGSL[zu]||(C.IncludesShadersStoreWGSL[zu]=Ey);const Yu="bumpFragmentMainFunctions",vy=`#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)
#if defined(TANGENT) && defined(NORMAL) 
varying vTBN0: vec3f;varying vTBN1: vec3f;varying vTBN2: vec3f;
#endif
#ifdef OBJECTSPACE_NORMALMAP
uniform normalMatrix: mat4x4f;fn toNormalMatrix(m: mat4x4f)->mat4x4f
{var a00=m[0][0];var a01=m[0][1];var a02=m[0][2];var a03=m[0][3];var a10=m[1][0];var a11=m[1][1];var a12=m[1][2];var a13=m[1][3];var a20=m[2][0]; 
var a21=m[2][1];var a22=m[2][2];var a23=m[2][3];var a30=m[3][0]; 
var a31=m[3][1];var a32=m[3][2];var a33=m[3][3];var b00=a00*a11-a01*a10;var b01=a00*a12-a02*a10;var b02=a00*a13-a03*a10;var b03=a01*a12-a02*a11;var b04=a01*a13-a03*a11;var b05=a02*a13-a03*a12;var b06=a20*a31-a21*a30;var b07=a20*a32-a22*a30;var b08=a20*a33-a23*a30;var b09=a21*a32-a22*a31;var b10=a21*a33-a23*a31;var b11=a22*a33-a23*a32;var det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;var mi=mat4x4<f32>(
(a11*b11-a12*b10+a13*b09)/det,
(a02*b10-a01*b11-a03*b09)/det,
(a31*b05-a32*b04+a33*b03)/det,
(a22*b04-a21*b05-a23*b03)/det,
(a12*b08-a10*b11-a13*b07)/det,
(a00*b11-a02*b08+a03*b07)/det,
(a32*b02-a30*b05-a33*b01)/det,
(a20*b05-a22*b02+a23*b01)/det,
(a10*b10-a11*b08+a13*b06)/det,
(a01*b08-a00*b10-a03*b06)/det,
(a30*b04-a31*b02+a33*b00)/det,
(a21*b02-a20*b04-a23*b00)/det,
(a11*b07-a10*b09-a12*b06)/det,
(a00*b09-a01*b07+a02*b06)/det,
(a31*b01-a30*b03-a32*b00)/det,
(a20*b03-a21*b01+a22*b00)/det);return mat4x4<f32>(mi[0][0],mi[1][0],mi[2][0],mi[3][0],
mi[0][1],mi[1][1],mi[2][1],mi[3][1],
mi[0][2],mi[1][2],mi[2][2],mi[3][2],
mi[0][3],mi[1][3],mi[2][3],mi[3][3]);}
#endif
fn perturbNormalBase(cotangentFrame: mat3x3f,normal: vec3f,scale: f32)->vec3f
{var output=normal;
#ifdef NORMALXYSCALE
output=normalize(output* vec3f(scale,scale,1.0));
#endif
return normalize(cotangentFrame*output);}
fn perturbNormal(cotangentFrame: mat3x3f,textureSample: vec3f,scale: f32)->vec3f
{return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);}
fn cotangent_frame(normal: vec3f,p: vec3f,uv: vec2f,tangentSpaceParams: vec2f)->mat3x3f
{var dp1: vec3f=dpdx(p);var dp2: vec3f=dpdy(p);var duv1: vec2f=dpdx(uv);var duv2: vec2f=dpdy(uv);var dp2perp: vec3f=cross(dp2,normal);var dp1perp: vec3f=cross(normal,dp1);var tangent: vec3f=dp2perp*duv1.x+dp1perp*duv2.x;var bitangent: vec3f=dp2perp*duv1.y+dp1perp*duv2.y;tangent*=tangentSpaceParams.x;bitangent*=tangentSpaceParams.y;var det: f32=max(dot(tangent,tangent),dot(bitangent,bitangent));var invmax: f32=select(inverseSqrt(det),0.0,det==0.0);return mat3x3f(tangent*invmax,bitangent*invmax,normal);}
#endif
`;C.IncludesShadersStoreWGSL[Yu]||(C.IncludesShadersStoreWGSL[Yu]=vy);const Ku="bumpFragmentFunctions",Ty=`#if defined(BUMP)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)
#endif
#if defined(DETAIL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)
#endif
#if defined(BUMP) && defined(PARALLAX)
const minSamples: f32=4.;const maxSamples: f32=15.;const iMaxSamples: i32=15;fn parallaxOcclusion(vViewDirCoT: vec3f,vNormalCoT: vec3f,texCoord: vec2f,parallaxScale: f32)->vec2f {var parallaxLimit: f32=length(vViewDirCoT.xy)/vViewDirCoT.z;parallaxLimit*=parallaxScale;var vOffsetDir: vec2f=normalize(vViewDirCoT.xy);var vMaxOffset: vec2f=vOffsetDir*parallaxLimit;var numSamples: f32=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));var stepSize: f32=1.0/numSamples;var currRayHeight: f32=1.0;var vCurrOffset: vec2f= vec2f(0,0);var vLastOffset: vec2f= vec2f(0,0);var lastSampledHeight: f32=1.0;var currSampledHeight: f32=1.0;var keepWorking: bool=true;for (var i: i32=0; i<iMaxSamples; i++)
{currSampledHeight=textureSample(bumpSampler,bumpSamplerSampler,texCoord+vCurrOffset).w;if (!keepWorking)
{}
else if (currSampledHeight>currRayHeight)
{var delta1: f32=currSampledHeight-currRayHeight;var delta2: f32=(currRayHeight+stepSize)-lastSampledHeight;var ratio: f32=delta1/(delta1+delta2);vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;keepWorking=false;}
else
{currRayHeight-=stepSize;vLastOffset=vCurrOffset;
#ifdef PARALLAX_RHS
vCurrOffset-=stepSize*vMaxOffset;
#else
vCurrOffset+=stepSize*vMaxOffset;
#endif
lastSampledHeight=currSampledHeight;}}
return vCurrOffset;}
fn parallaxOffset(viewDir: vec3f,heightScale: f32)->vec2f
{var height: f32=textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV).w;var texCoordOffset: vec2f=heightScale*viewDir.xy*height;
#ifdef PARALLAX_RHS
return texCoordOffset;
#else
return -texCoordOffset;
#endif
}
#endif
`;C.IncludesShadersStoreWGSL[Ku]||(C.IncludesShadersStoreWGSL[Ku]=Ty);const qu="clipPlaneFragmentDeclaration",Sy=`#ifdef CLIPPLANE
varying fClipDistance: f32;
#endif
#ifdef CLIPPLANE2
varying fClipDistance2: f32;
#endif
#ifdef CLIPPLANE3
varying fClipDistance3: f32;
#endif
#ifdef CLIPPLANE4
varying fClipDistance4: f32;
#endif
#ifdef CLIPPLANE5
varying fClipDistance5: f32;
#endif
#ifdef CLIPPLANE6
varying fClipDistance6: f32;
#endif
`;C.IncludesShadersStoreWGSL[qu]||(C.IncludesShadersStoreWGSL[qu]=Sy);const ju="fogFragmentDeclaration",Ay=`#ifdef FOG
#define FOGMODE_NONE 0.
#define FOGMODE_EXP 1.
#define FOGMODE_EXP2 2.
#define FOGMODE_LINEAR 3.
const E=2.71828;uniform vFogInfos: vec4f;uniform vFogColor: vec3f;varying vFogDistance: vec3f;fn CalcFogFactor()->f32
{var fogCoeff: f32=1.0;var fogStart: f32=uniforms.vFogInfos.y;var fogEnd: f32=uniforms.vFogInfos.z;var fogDensity: f32=uniforms.vFogInfos.w;var fogDistance: f32=length(fragmentInputs.vFogDistance);if (FOGMODE_LINEAR==uniforms.vFogInfos.x)
{fogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);}
else if (FOGMODE_EXP==uniforms.vFogInfos.x)
{fogCoeff=1.0/pow(E,fogDistance*fogDensity);}
else if (FOGMODE_EXP2==uniforms.vFogInfos.x)
{fogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);}
return clamp(fogCoeff,0.0,1.0);}
#endif
`;C.IncludesShadersStoreWGSL[ju]||(C.IncludesShadersStoreWGSL[ju]=Ay);const Zu="clipPlaneFragment",Ry=`#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
if (false) {}
#endif
#ifdef CLIPPLANE
else if (fragmentInputs.fClipDistance>0.0)
{discard;}
#endif
#ifdef CLIPPLANE2
else if (fragmentInputs.fClipDistance2>0.0)
{discard;}
#endif
#ifdef CLIPPLANE3
else if (fragmentInputs.fClipDistance3>0.0)
{discard;}
#endif
#ifdef CLIPPLANE4
else if (fragmentInputs.fClipDistance4>0.0)
{discard;}
#endif
#ifdef CLIPPLANE5
else if (fragmentInputs.fClipDistance5>0.0)
{discard;}
#endif
#ifdef CLIPPLANE6
else if (fragmentInputs.fClipDistance6>0.0)
{discard;}
#endif
`;C.IncludesShadersStoreWGSL[Zu]||(C.IncludesShadersStoreWGSL[Zu]=Ry);const Qu="bumpFragment",Cy=`var uvOffset: vec2f= vec2f(0.0,0.0);
#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)
#ifdef NORMALXYSCALE
var normalScale: f32=1.0;
#elif defined(BUMP)
var normalScale: f32=uniforms.vBumpInfos.y;
#else
var normalScale: f32=1.0;
#endif
#if defined(TANGENT) && defined(NORMAL)
var TBN: mat3x3f=mat3x3<f32>(input.vTBN0,input.vTBN1,input.vTBN2); 
#elif defined(BUMP)
var TBNUV: vec2f=select(-fragmentInputs.vBumpUV,fragmentInputs.vBumpUV,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW*normalScale,input.vPositionW,TBNUV,uniforms.vTangentSpaceParams);
#else
var TBNUV: vec2f=select(-fragmentInputs.vDetailUV,fragmentInputs.vDetailUV,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW*normalScale,input.vPositionW,TBNUV, vec2f(1.,1.));
#endif
#elif defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
var TBN: mat3x3f=mat3x3<f32>(input.vTBN0,input.vTBN1,input.vTBN2); 
#else
var TBNUV: vec2f=select( -fragmentInputs.vMainUV1,fragmentInputs.vMainUV1,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW,input.vPositionW,TBNUV, vec2f(1.,1.));
#endif
#endif
#ifdef PARALLAX
var invTBN: mat3x3f=transposeMat3(TBN);
#ifdef PARALLAXOCCLUSION
uvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,fragmentInputs.vBumpUV,uniforms.vBumpInfos.z);
#else
uvOffset=parallaxOffset(invTBN*viewDirectionW,uniforms.vBumpInfos.z);
#endif
#endif
#ifdef DETAIL
var detailColor: vec4f=textureSample(detailSampler,detailSamplerSampler,fragmentInputs.vDetailUV+uvOffset);var detailNormalRG: vec2f=detailColor.wy*2.0-1.0;var detailNormalB: f32=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));var detailNormal: vec3f= vec3f(detailNormalRG,detailNormalB);
#endif
#ifdef BUMP
#ifdef OBJECTSPACE_NORMALMAP
#define CUSTOM_FRAGMENT_BUMP_FRAGMENT
normalW=normalize(textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV).xyz *2.0-1.0);normalW=normalize(mat3x3f(uniforms.normalMatrix[0].xyz,uniforms.normalMatrix[1].xyz,uniforms.normalMatrix[2].xyz)*normalW);
#elif !defined(DETAIL)
normalW=perturbNormal(TBN,textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV+uvOffset).xyz,uniforms.vBumpInfos.y);
#else
var bumpNormal: vec3f=textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV+uvOffset).xyz*2.0-1.0;
#if DETAIL_NORMALBLENDMETHOD==0 
detailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);var blendedNormal: vec3f=normalize( vec3f(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));
#elif DETAIL_NORMALBLENDMETHOD==1 
detailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);bumpNormal+= vec3f(0.0,0.0,1.0);detailNormal*= vec3f(-1.0,-1.0,1.0);var blendedNormal: vec3f=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;
#endif
normalW=perturbNormalBase(TBN,blendedNormal,uniforms.vBumpInfos.y);
#endif
#elif defined(DETAIL)
detailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);normalW=perturbNormalBase(TBN,detailNormal,uniforms.vDetailInfos.z);
#endif
`;C.IncludesShadersStoreWGSL[Qu]||(C.IncludesShadersStoreWGSL[Qu]=Cy);const $u="decalFragment",Iy=`#ifdef DECAL
var decalTempColor=decalColor.rgb;var decalTempAlpha=decalColor.a;
#ifdef GAMMADECAL
decalTempColor=toLinearSpaceVec3(decalColor.rgb);
#endif
#ifdef DECAL_SMOOTHALPHA
decalTempAlpha=decalColor.a*decalColor.a;
#endif
surfaceAlbedo=mix(surfaceAlbedo.rgb,decalTempColor,decalTempAlpha);
#endif
`;C.IncludesShadersStoreWGSL[$u]||(C.IncludesShadersStoreWGSL[$u]=Iy);const Ju="depthPrePass",by=`#ifdef DEPTHPREPASS
fragmentOutputs.color= vec4f(0.,0.,0.,1.0);return fragmentOutputs;
#endif
`;C.IncludesShadersStoreWGSL[Ju]||(C.IncludesShadersStoreWGSL[Ju]=by);const ed="lightFragment",xy=`#ifdef LIGHT{X}
#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})
#else
var diffuse{X}: vec4f=light{X}.vLightDiffuse;
#define CUSTOM_LIGHT{X}_COLOR 
#ifdef PBR
#ifdef SPOTLIGHT{X}
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,fragmentInputs.vPositionW);
#elif defined(POINTLIGHT{X})
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,fragmentInputs.vPositionW);
#elif defined(HEMILIGHT{X})
preInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(DIRLIGHT{X})
preInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(AREALIGHT{X}) && defined(AREALIGHTSUPPORTED)
preInfo=computeAreaPreLightingInfo(areaLightsLTC1Sampler,areaLightsLTC1SamplerSampler,areaLightsLTC2Sampler,areaLightsLTC2SamplerSampler,viewDirectionW,normalW,fragmentInputs.vPositionW,light{X}.vLightData.xyz,light{X}.vLightWidth.xyz,light{X}.vLightHeight.xyz,roughness);
#endif
preInfo.NdotV=NdotV;
#ifdef SPOTLIGHT{X}
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
#ifdef IESLIGHTTEXTURE{X}
preInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X},iesLightTexture{X}Sampler);
#else
preInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
#ifdef IESLIGHTTEXTURE{X}
preInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X},iesLightTexture{X}Sampler);
#else
preInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);
#endif
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
#ifdef IESLIGHTTEXTURE{X}
preInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X},iesLightTexture{X}Sampler);
#else
preInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);
#endif
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#ifdef IESLIGHTTEXTURE{X}
preInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X},iesLightTexture{X}Sampler);
#else
preInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif 
#endif 
#elif defined(POINTLIGHT{X})
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#endif
#else
preInfo.attenuation=1.0;
#endif
#if defined(HEMILIGHT{X}) || defined(AREALIGHT{X})
preInfo.roughness=roughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#ifdef IRIDESCENCE
preInfo.iridescenceIntensity=iridescenceIntensity;
#endif
#ifdef HEMILIGHT{X}
info.diffuse=computeHemisphericDiffuseLighting(preInfo,diffuse{X}.rgb,light{X}.vLightGround);
#elif AREALIGHT{X}
info.diffuse=computeAreaDiffuseLighting(preInfo,diffuse{X}.rgb);
#elif defined(SS_TRANSLUCENCY)
info.diffuse=computeDiffuseAndTransmittedLighting(preInfo,diffuse{X}.rgb,subSurfaceOut.transmittance,subSurfaceOut.translucencyIntensity,surfaceAlbedo.rgb);
#else
info.diffuse=computeDiffuseLighting(preInfo,diffuse{X}.rgb);
#endif
#ifdef SPECULARTERM
#if AREALIGHT{X}
info.specular=computeAreaSpecularLighting(preInfo,light{X}.vLightSpecular.rgb);
#else
#ifdef ANISOTROPIC
info.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);
#else
info.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);
#endif
#endif
#endif
#ifndef AREALIGHT{X}
#ifdef SHEEN
#ifdef SHEEN_LINKWITHALBEDO
preInfo.roughness=sheenOut.sheenIntensity;
#else
#ifdef HEMILIGHT{X}
preInfo.roughness=sheenOut.sheenRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#endif
info.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);
#endif
#ifdef CLEARCOAT
#ifdef HEMILIGHT{X}
preInfo.roughness=clearcoatOut.clearCoatRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
info.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,diffuse{X}.rgb);
#ifdef CLEARCOAT_TINT
absorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);info.diffuse*=absorption;
#ifdef SPECULARTERM
info.specular*=absorption;
#endif
#endif
info.diffuse*=info.clearCoat.w;
#ifdef SPECULARTERM
info.specular*=info.clearCoat.w;
#endif
#ifdef SHEEN
info.sheen*=info.clearCoat.w;
#endif
#endif
#endif
#else
#ifdef SPOTLIGHT{X}
#ifdef IESLIGHTTEXTURE{X}
info=computeIESSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness,iesLightTexture{X},iesLightTexture{X}Sampler);
#else
info=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness);
#endif 
#elif defined(HEMILIGHT{X})
info=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);
#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})
info=computeLighting(viewDirectionW,normalW,light{X}.vLightData,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness);
#elif define(AREALIGHT{X}) && defined(AREALIGHTSUPPORTED)
info=computeAreaLighting(areaLightsLTC1Sampler,areaLightsLTC1SamplerSampler,areaLightsLTC2Sampler,areaLightsLTC2SamplerSampler,viewDirectionW,normalW,fragmentInputs.vPositionW,light{X}.vLightData.xyz,light{X}.vLightWidth.xyz,light{X}.vLightHeight.xyz,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,
#ifdef AREALIGHTNOROUGHTNESS
0.5
#else
uniforms.vReflectionInfos.y
#endif
);
#endif
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
info.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightTexture{X},projectionLightTexture{X}Sampler,uniforms.textureProjectionMatrix{X},fragmentInputs.vPositionW);
#endif
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSMDEBUG{X}
var shadowDebug{X}: vec3f;
#endif
#ifdef SHADOWCSM{X}
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
var index{X}: i32=-1;
#else
var index{X}: i32=SHADOWCSMNUM_CASCADES{X}-1;
#endif
var diff{X}: f32=0.;vPositionFromLight{X}[0]=fragmentInputs.vPositionFromLight{X}_0;vPositionFromLight{X}[1]=fragmentInputs.vPositionFromLight{X}_1;vPositionFromLight{X}[2]=fragmentInputs.vPositionFromLight{X}_2;vPositionFromLight{X}[3]=fragmentInputs.vPositionFromLight{X}_3;vDepthMetric{X}[0]=fragmentInputs.vDepthMetric{X}_0;vDepthMetric{X}[1]=fragmentInputs.vDepthMetric{X}_1;vDepthMetric{X}[2]=fragmentInputs.vDepthMetric{X}_2;vDepthMetric{X}[3]=fragmentInputs.vDepthMetric{X}_3;for (var i:i32=0; i<SHADOWCSMNUM_CASCADES{X}; i++) 
{
#ifdef SHADOWCSM_RIGHTHANDED{X}
diff{X}=uniforms.viewFrustumZ{X}[i]+fragmentInputs.vPositionFromCamera{X}.z;
#else
diff{X}=uniforms.viewFrustumZ{X}[i]-fragmentInputs.vPositionFromCamera{X}.z;
#endif
if (diff{X}>=0.) {index{X}=i;break;}}
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
if (index{X}>=0)
#endif
{
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCF1(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCF3(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithCSMPCF5(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCSS16(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCSS32(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#else
shadow=computeShadowWithCSMPCSS64(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#endif
#else
shadow=computeShadowCSM(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=vec3f(shadow)*vCascadeColorsMultiplier{X}[index{X}];
#endif
#ifndef SHADOWCSMNOBLEND{X}
var frustumLength:f32=uniforms.frustumLengths{X}[index{X}];var diffRatio:f32=clamp(diff{X}/frustumLength,0.,1.)*uniforms.cascadeBlendFactor{X};if (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)
{index{X}+=1;var nextShadow: f32=0.;
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCF1(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],,shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCF3(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
nextShadow=computeShadowWithCSMPCF5(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCSS16(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCSS32(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#else
nextShadow=computeShadowWithCSMPCSS64(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#endif
#else
nextShadow=computeShadowCSM(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
shadow=mix(nextShadow,shadow,diffRatio);
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);
#endif
}
#endif
}
#elif defined(SHADOWCLOSEESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithCloseESMCube(fragmentInputs.vPositionW,light{X}.vLightData.xyz,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithCloseESM(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithESMCube(fragmentInputs.vPositionW,light{X}.vLightData.xyz,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithESM(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPOISSON{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithPoissonSamplingCube(fragmentInputs.vPositionW,light{X}.vLightData.xyz,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadowWithPoissonSampling(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCF1(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCF3(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCF5(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCSS16(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCSS32(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCSS64(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#else
#if defined(SHADOWCUBE{X})
shadow=computeShadowCube(fragmentInputs.vPositionW,light{X}.vLightData.xyz,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadow(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#endif
#ifdef SHADOWONLY
#ifndef SHADOWINUSE
#define SHADOWINUSE
#endif
globalShadow+=shadow;shadowLightCount+=1.0;
#endif
#else
shadow=1.;
#endif
aggShadow+=shadow;numLights+=1.0;
#ifndef SHADOWONLY
#ifdef CUSTOMUSERLIGHTING
diffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);
#ifdef SPECULARTERM
specularBase+=computeCustomSpecularLighting(info,specularBase,shadow);
#endif
#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})
diffuseBase+=lightmapColor.rgb*shadow;
#ifdef SPECULARTERM
#ifndef LIGHTMAPNOSPECULAR{X}
specularBase+=info.specular*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef CLEARCOAT
#ifndef LIGHTMAPNOSPECULAR{X}
clearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef SHEEN
#ifndef LIGHTMAPNOSPECULAR{X}
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#else
#ifdef SHADOWCSMDEBUG{X}
diffuseBase+=info.diffuse*shadowDebug{X};
#else 
diffuseBase+=info.diffuse*shadow;
#endif
#ifdef SPECULARTERM
specularBase+=info.specular*shadow;
#endif
#ifdef CLEARCOAT
clearCoatBase+=info.clearCoat.rgb*shadow;
#endif
#ifdef SHEEN
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#endif
#endif
`;C.IncludesShadersStoreWGSL[ed]||(C.IncludesShadersStoreWGSL[ed]=xy);const td="logDepthFragment",yy=`#ifdef LOGARITHMICDEPTH
fragmentOutputs.fragDepth=log2(fragmentInputs.vFragmentDepth)*uniforms.logarithmicDepthConstant*0.5;
#endif
`;C.IncludesShadersStoreWGSL[td]||(C.IncludesShadersStoreWGSL[td]=yy);const id="fogFragment",My=`#ifdef FOG
var fog: f32=CalcFogFactor();
#ifdef PBR
fog=toLinearSpace(fog);
#endif
color= vec4f(mix(uniforms.vFogColor,color.rgb,fog),color.a);
#endif
`;C.IncludesShadersStoreWGSL[id]||(C.IncludesShadersStoreWGSL[id]=My);const rd="oitFragment",Py=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
var fragDepth: f32=fragmentInputs.position.z; 
#ifdef ORDER_INDEPENDENT_TRANSPARENCY_16BITS
var halfFloat: u32=pack2x16float( vec2f(fragDepth));var full: vec2f=unpack2x16float(halfFloat);fragDepth=full.x;
#endif
var fragCoord: vec2i=vec2i(fragmentInputs.position.xy);var lastDepth: vec2f=textureLoad(oitDepthSampler,fragCoord,0).rg;var lastFrontColor: vec4f=textureLoad(oitFrontColorSampler,fragCoord,0);fragmentOutputs.depth=vec2f(-MAX_DEPTH);fragmentOutputs.frontColor=lastFrontColor;fragmentOutputs.backColor= vec4f(0.0);
#ifdef USE_REVERSE_DEPTHBUFFER
var furthestDepth: f32=-lastDepth.x;var nearestDepth: f32=lastDepth.y;
#else
var nearestDepth: f32=-lastDepth.x;var furthestDepth: f32=lastDepth.y;
#endif
var alphaMultiplier: f32=1.0-lastFrontColor.a;
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth>nearestDepth || fragDepth<furthestDepth) {
#else
if (fragDepth<nearestDepth || fragDepth>furthestDepth) {
#endif
return fragmentOutputs;}
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth<nearestDepth && fragDepth>furthestDepth) {
#else
if (fragDepth>nearestDepth && fragDepth<furthestDepth) {
#endif
fragmentOutputs.depth=vec2f(-fragDepth,fragDepth);return fragmentOutputs;}
#endif
`;C.IncludesShadersStoreWGSL[rd]||(C.IncludesShadersStoreWGSL[rd]=Py);const Ol="defaultPixelShader",ME=`#include<defaultUboDeclaration>
#include<prePassDeclaration>[SCENE_MRT_COUNT]
#include<oitDeclaration>
#define CUSTOM_FRAGMENT_BEGIN
varying vPositionW: vec3f;
#ifdef NORMAL
varying vNormalW: vec3f;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vColor: vec4f;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#include<helperFunctions>
#include<lightUboDeclaration>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<samplerFragmentDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_SAMPLERNAME_,diffuse)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef REFRACTION
#ifdef REFRACTIONMAP_3D
var refractionCubeSamplerSampler: sampler;var refractionCubeSampler: texture_cube<f32>;
#else
var refraction2DSamplerSampler: sampler;var refraction2DSampler: texture_2d<f32>;
#endif
#endif
#if defined(SPECULARTERM)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_SAMPLERNAME_,specular)
#endif
#include<fresnelFunction>
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
var reflectionCubeSamplerSampler: sampler;var reflectionCubeSampler: texture_cube<f32>;
#else
var reflection2DSamplerSampler: sampler;var reflection2DSampler: texture_2d<f32>;
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#endif
#include<reflectionFunction>
#endif
#include<imageProcessingDeclaration>
#include<imageProcessingFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
var viewDirectionW: vec3f=normalize(scene.vEyePosition.xyz-fragmentInputs.vPositionW);var baseColor: vec4f= vec4f(1.,1.,1.,1.);var diffuseColor: vec3f=uniforms.vDiffuseColor.rgb;var alpha: f32=uniforms.vDiffuseColor.a;
#ifdef NORMAL
var normalW: vec3f=normalize(fragmentInputs.vNormalW);
#else
var normalW: vec3f=normalize(-cross(dpdx(fragmentInputs.vPositionW),dpdy(fragmentInputs.vPositionW)));
#endif
#include<bumpFragment>
#ifdef TWOSIDEDLIGHTING
normalW=select(-normalW,normalW,fragmentInputs.frontFacing);
#endif
#ifdef DIFFUSE
baseColor=textureSample(diffuseSampler,diffuseSamplerSampler,fragmentInputs.vDiffuseUV+uvOffset);
#if defined(ALPHATEST) && !defined(ALPHATEST_AFTERALLALPHACOMPUTATIONS)
if (baseColor.a<uniforms.alphaCutOff) {discard;}
#endif
#ifdef ALPHAFROMDIFFUSE
alpha*=baseColor.a;
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
baseColor=vec4f(baseColor.rgb*uniforms.vDiffuseInfos.y,baseColor.a);
#endif
#if defined(DECAL) && !defined(DECAL_AFTER_DETAIL)
var decalColor: vec4f=textureSample(decalSampler,decalSamplerSampler,fragmentInputs.vDecalUV+uvOffset);
#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)
#endif
#include<depthPrePass>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
baseColor=vec4f(baseColor.rgb*fragmentInputs.vColor.rgb,baseColor.a);
#endif
#ifdef DETAIL
baseColor=vec4f(baseColor.rgb*2.0*mix(0.5,detailColor.r,uniforms.vDetailInfos.y),baseColor.a);
#endif
#if defined(DECAL) && defined(DECAL_AFTER_DETAIL)
var decalColor: vec4f=textureSample(decalSampler,decalSamplerSampler,fragmentInputs.vDecalUV+uvOffset);
#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)
#endif
#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE
var baseAmbientColor: vec3f= vec3f(1.,1.,1.);
#ifdef AMBIENT
baseAmbientColor=textureSample(ambientSampler,ambientSamplerSampler,fragmentInputs.vAmbientUV+uvOffset).rgb*uniforms.vAmbientInfos.y;
#endif
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
var glossiness: f32=uniforms.vSpecularColor.a;var specularColor: vec3f=uniforms.vSpecularColor.rgb;
#ifdef SPECULARTERM
#ifdef SPECULAR
var specularMapColor: vec4f=textureSample(specularSampler,specularSamplerSampler,fragmentInputs.vSpecularUV+uvOffset);specularColor=specularMapColor.rgb;
#ifdef GLOSSINESS
glossiness=glossiness*specularMapColor.a;
#endif
#endif
#endif
var diffuseBase: vec3f= vec3f(0.,0.,0.);var info: lightingInfo;
#ifdef SPECULARTERM
var specularBase: vec3f= vec3f(0.,0.,0.);
#endif
var shadow: f32=1.;var aggShadow: f32=0.;var numLights: f32=0.;
#ifdef LIGHTMAP
var lightmapColor: vec4f=textureSample(lightmapSampler,lightmapSamplerSampler,fragmentInputs.vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor=vec4f(fromRGBD(lightmapColor),lightmapColor.a);
#endif
lightmapColor=vec4f(lightmapColor.rgb*uniforms.vLightmapInfos.y,lightmapColor.a);
#endif
#include<lightFragment>[0..maxSimultaneousLights]
aggShadow=aggShadow/numLights;var refractionColor: vec4f= vec4f(0.,0.,0.,1.);
#ifdef REFRACTION
var refractionVector: vec3f=normalize(refract(-viewDirectionW,normalW,uniforms.vRefractionInfos.y));
#ifdef REFRACTIONMAP_3D
#ifdef USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(fragmentInputs.vPositionW,refractionVector,uniforms.vRefractionSize,uniforms.vRefractionPosition);
#endif
refractionVector.y=refractionVector.y*uniforms.vRefractionInfos.w;var refractionLookup: vec4f=textureSample(refractionCubeSampler,refractionCubeSamplerSampler,refractionVector);if (dot(refractionVector,viewDirectionW)<1.0) {refractionColor=refractionLookup;}
#else
var vRefractionUVW: vec3f= (uniforms.refractionMatrix*(scene.view* vec4f(fragmentInputs.vPositionW+refractionVector*uniforms.vRefractionInfos.z,1.0))).xyz;var refractionCoords: vec2f=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;refractionColor=textureSample(refraction2DSampler,refraction2DSamplerSampler,refractionCoords);
#endif
#ifdef RGBDREFRACTION
refractionColor=vec4f(fromRGBD(refractionColor),refractionColor.a);
#endif
#ifdef IS_REFRACTION_LINEAR
refractionColor=vec4f(toGammaSpaceVec3(refractionColor.rgb),refractionColor.a);
#endif
refractionColor=vec4f(refractionColor.rgb*uniforms.vRefractionInfos.x,refractionColor.a);
#endif
var reflectionColor: vec4f= vec4f(0.,0.,0.,1.);
#ifdef REFLECTION
var vReflectionUVW: vec3f=computeReflectionCoords( vec4f(fragmentInputs.vPositionW,1.0),normalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
vReflectionUVW=vec3f(vReflectionUVW.x,vReflectionUVW.y,vReflectionUVW.z*-1.0);
#endif
#ifdef REFLECTIONMAP_3D
#ifdef ROUGHNESS
var bias: f32=uniforms.vReflectionInfos.y;
#ifdef SPECULARTERM
#ifdef SPECULAR
#ifdef GLOSSINESS
bias*=(1.0-specularMapColor.a);
#endif
#endif
#endif
reflectionColor=textureSampleLevel(reflectionCubeSampler,reflectionCubeSamplerSampler,vReflectionUVW,bias);
#else
reflectionColor=textureSample(reflectionCubeSampler,reflectionCubeSamplerSampler,vReflectionUVW);
#endif
#else
var coords: vec2f=vReflectionUVW.xy;
#ifdef REFLECTIONMAP_PROJECTION
coords/=vReflectionUVW.z;
#endif
coords.y=1.0-coords.y;reflectionColor=textureSample(reflection2DSampler,reflection2DSamplerSampler,coords);
#endif
#ifdef RGBDREFLECTION
reflectionColor=vec4f(fromRGBD(reflectionColor),reflectionColor.a);
#endif
#ifdef IS_REFLECTION_LINEAR
reflectionColor=vec4f(toGammaSpaceVec3(reflectionColor.rgb),reflectionColor.a);
#endif
reflectionColor=vec4f(reflectionColor.rgb*uniforms.vReflectionInfos.x,reflectionColor.a);
#ifdef REFLECTIONFRESNEL
var reflectionFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.reflectionRightColor.a,uniforms.reflectionLeftColor.a);
#ifdef REFLECTIONFRESNELFROMSPECULAR
#ifdef SPECULARTERM
reflectionColor=vec4f(reflectionColor.rgb*specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*uniforms.reflectionRightColor.rgb,reflectionColor.a);
#else
reflectionColor=vec4f(reflectionColor.rgb*uniforms.reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*uniforms.reflectionRightColor.rgb,reflectionColor.a);
#endif
#else
reflectionColor=vec4f(reflectionColor.rgb*uniforms.reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*uniforms.reflectionRightColor.rgb,reflectionColor.a);
#endif
#endif
#endif
#ifdef REFRACTIONFRESNEL
var refractionFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.refractionRightColor.a,uniforms.refractionLeftColor.a);refractionColor=vec4f(refractionColor.rgb*uniforms.refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*uniforms.refractionRightColor.rgb,refractionColor.a);
#endif
#ifdef OPACITY
var opacityMap: vec4f=textureSample(opacitySampler,opacitySamplerSampler,fragmentInputs.vOpacityUV+uvOffset);
#ifdef OPACITYRGB
opacityMap=vec4f(opacityMap.rgb* vec3f(0.3,0.59,0.11),opacityMap.a);alpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* uniforms.vOpacityInfos.y;
#else
alpha*=opacityMap.a*uniforms.vOpacityInfos.y;
#endif
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=fragmentInputs.vColor.a;
#endif
#ifdef OPACITYFRESNEL
var opacityFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.opacityParts.z,uniforms.opacityParts.w);alpha+=uniforms.opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*uniforms.opacityParts.y;
#endif
#ifdef ALPHATEST
#ifdef ALPHATEST_AFTERALLALPHACOMPUTATIONS
if (alpha<uniforms.alphaCutOff) {discard;}
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
var emissiveColor: vec3f=uniforms.vEmissiveColor;
#ifdef EMISSIVE
emissiveColor+=textureSample(emissiveSampler,emissiveSamplerSampler,fragmentInputs.vEmissiveUV+uvOffset).rgb*uniforms.vEmissiveInfos.y;
#endif
#ifdef EMISSIVEFRESNEL
var emissiveFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.emissiveRightColor.a,uniforms.emissiveLeftColor.a);emissiveColor*=uniforms.emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*uniforms.emissiveRightColor.rgb;
#endif
#ifdef DIFFUSEFRESNEL
var diffuseFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.diffuseRightColor.a,uniforms.diffuseLeftColor.a);diffuseBase*=uniforms.diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*uniforms.diffuseRightColor.rgb;
#endif
#ifdef EMISSIVEASILLUMINATION
var finalDiffuse: vec3f=clamp(diffuseBase*diffuseColor+uniforms.vAmbientColor,vec3f(0.0),vec3f(1.0))*baseColor.rgb;
#else
#ifdef LINKEMISSIVEWITHDIFFUSE
var finalDiffuse: vec3f=clamp((diffuseBase+emissiveColor)*diffuseColor+uniforms.vAmbientColor,vec3f(0.0),vec3f(1.0))*baseColor.rgb;
#else
var finalDiffuse: vec3f=clamp(diffuseBase*diffuseColor+emissiveColor+uniforms.vAmbientColor,vec3f(0.0),vec3f(1.0))*baseColor.rgb;
#endif
#endif
#ifdef SPECULARTERM
var finalSpecular: vec3f=specularBase*specularColor;
#ifdef SPECULAROVERALPHA
alpha=clamp(alpha+dot(finalSpecular, vec3f(0.3,0.59,0.11)),0.0,1.0);
#endif
#else
var finalSpecular: vec3f= vec3f(0.0);
#endif
#ifdef REFLECTIONOVERALPHA
alpha=clamp(alpha+dot(reflectionColor.rgb, vec3f(0.3,0.59,0.11)),0.0,1.0);
#endif
#ifdef EMISSIVEASILLUMINATION
var color: vec4f= vec4f(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+emissiveColor+refractionColor.rgb,0.0,1.0),alpha);
#else
var color: vec4f= vec4f(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+refractionColor.rgb,alpha);
#endif
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
color=vec4f(color.rgb*lightmapColor.rgb,color.a);
#else
color=vec4f(color.rgb+lightmapColor.rgb,color.a);
#endif
#endif
#endif
#define CUSTOM_FRAGMENT_BEFORE_FOG
color=vec4f(max(color.rgb,vec3f(0.)),color.a);
#include<logDepthFragment>
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
color=vec4f(toLinearSpaceVec3(color.rgb),color.a);
#else
#ifdef IMAGEPROCESSING
color=vec4f(toLinearSpaceVec3(color.rgb),color.a);color=applyImageProcessing(color);
#endif
#endif
color=vec4f(color.rgb,color.a*mesh.visibility);
#ifdef PREMULTIPLYALPHA
color=vec4f(color.rgb*color.a, color.a);
#endif
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
var writeGeometryInfo: f32=select(0.0,1.0,color.a>0.4);var fragData: array<vec4<f32>,SCENE_MRT_COUNT>;
#ifdef PREPASS_COLOR
fragData[PREPASS_COLOR_INDEX]=color; 
#endif
#ifdef PREPASS_POSITION
fragData[PREPASS_POSITION_INDEX]=vec4f(fragmentInputs.vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_LOCAL_POSITION
fragData[PREPASS_LOCAL_POSITION_INDEX]=vec4f(fragmentInputs.vPosition,writeGeometryInfo);
#endif
#ifdef PREPASS_VELOCITY
var a: vec2f=(fragmentInputs.vCurrentPosition.xy/fragmentInputs.vCurrentPosition.w)*0.5+0.5;var b: vec2f=(fragmentInputs.vPreviousPosition.xy/fragmentInputs.vPreviousPosition.w)*0.5+0.5;var velocity: vec2f=abs(a-b);velocity= vec2f(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;fragData[PREPASS_VELOCITY_INDEX]= vec4f(velocity,0.0,writeGeometryInfo);
#elif defined(PREPASS_VELOCITY_LINEAR)
var velocity : vec2f=vec2f(0.5)*((fragmentInputs.vPreviousPosition.xy/fragmentInputs.vPreviousPosition.w) -
(fragmentInputs.vCurrentPosition.xy/fragmentInputs.vCurrentPosition.w));fragData[PREPASS_VELOCITY_LINEAR_INDEX]=vec4f(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_IRRADIANCE
fragData[PREPASS_IRRADIANCE_INDEX]=vec4f(0.0,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_DEPTH
fragData[PREPASS_DEPTH_INDEX]=vec4f(fragmentInputs.vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_SCREENSPACE_DEPTH
fragData[PREPASS_SCREENSPACE_DEPTH_INDEX]=vec4f(fragmentInputs.position.z,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMAL
#ifdef PREPASS_NORMAL_WORLDSPACE
fragData[PREPASS_NORMAL_INDEX]=vec4f(normalW,writeGeometryInfo);
#else
fragData[PREPASS_NORMAL_INDEX]=vec4f(normalize((scene.view*vec4f(normalW,0.0)).rgb),writeGeometryInfo);
#endif
#endif
#ifdef PREPASS_WORLD_NORMAL
fragData[PREPASS_WORLD_NORMAL_INDEX]=vec4f(normalW*0.5+0.5,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO
fragData[PREPASS_ALBEDO_INDEX]=vec4f(baseColor.rgb,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
fragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4f(sqrt(baseColor.rgb),writeGeometryInfo);
#endif
#ifdef PREPASS_REFLECTIVITY
#if defined(SPECULAR)
fragData[PREPASS_REFLECTIVITY_INDEX]=vec4f(toLinearSpaceVec4(specularMapColor))*writeGeometryInfo; 
#else
fragData[PREPASS_REFLECTIVITY_INDEX]=vec4f(toLinearSpaceVec3(specularColor),1.0)*writeGeometryInfo;
#endif
#endif
#if SCENE_MRT_COUNT>0
fragmentOutputs.fragData0=fragData[0];
#endif
#if SCENE_MRT_COUNT>1
fragmentOutputs.fragData1=fragData[1];
#endif
#if SCENE_MRT_COUNT>2
fragmentOutputs.fragData2=fragData[2];
#endif
#if SCENE_MRT_COUNT>3
fragmentOutputs.fragData3=fragData[3];
#endif
#if SCENE_MRT_COUNT>4
fragmentOutputs.fragData4=fragData[4];
#endif
#if SCENE_MRT_COUNT>5
fragmentOutputs.fragData5=fragData[5];
#endif
#if SCENE_MRT_COUNT>6
fragmentOutputs.fragData6=fragData[6];
#endif
#if SCENE_MRT_COUNT>7
fragmentOutputs.fragData7=fragData[7];
#endif
#endif
#if !defined(PREPASS) && !defined(ORDER_INDEPENDENT_TRANSPARENCY)
fragmentOutputs.color=color;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {fragmentOutputs.frontColor=vec4f(fragmentOutputs.frontColor.rgb+color.rgb*color.a*alphaMultiplier,1.0-alphaMultiplier*(1.0-color.a));} else {fragmentOutputs.backColor+=color;}
#endif
#define CUSTOM_FRAGMENT_MAIN_END
}
`;C.ShadersStoreWGSL[Ol]||(C.ShadersStoreWGSL[Ol]=ME);const Oy={name:Ol,shader:ME},Dy=Object.freeze(Object.defineProperty({__proto__:null,defaultPixelShaderWGSL:Oy},Symbol.toStringTag,{value:"Module"})),sd="decalVertexDeclaration",Ly=`#ifdef DECAL
uniform vec4 vDecalInfos;uniform mat4 decalMatrix;
#endif
`;C.IncludesShadersStore[sd]||(C.IncludesShadersStore[sd]=Ly);const nd="defaultVertexDeclaration",Ny=`uniform mat4 viewProjection;
#ifdef MULTIVIEW
mat4 viewProjectionR;
#endif 
uniform mat4 view;
#ifdef DIFFUSE
uniform mat4 diffuseMatrix;uniform vec2 vDiffuseInfos;
#endif
#ifdef AMBIENT
uniform mat4 ambientMatrix;uniform vec2 vAmbientInfos;
#endif
#ifdef OPACITY
uniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;uniform mat4 emissiveMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;
#endif
#if defined(SPECULAR) && defined(SPECULARTERM)
uniform vec2 vSpecularInfos;uniform mat4 specularMatrix;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform mat4 bumpMatrix;
#endif
#ifdef REFLECTION
uniform mat4 reflectionMatrix;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;uniform mat4 detailMatrix;
#endif
#include<decalVertexDeclaration>
#define ADDITIONAL_VERTEX_DECLARATION
`;C.IncludesShadersStore[nd]||(C.IncludesShadersStore[nd]=Ny);const ad="sceneUboDeclaration",Fy=`layout(std140,column_major) uniform;uniform Scene {mat4 viewProjection;
#ifdef MULTIVIEW
mat4 viewProjectionR;
#endif 
mat4 view;mat4 projection;vec4 vEyePosition;};
`;C.IncludesShadersStore[ad]||(C.IncludesShadersStore[ad]=Fy);const od="meshUboDeclaration",wy=`#ifdef WEBGL2
uniform mat4 world;uniform float visibility;
#else
layout(std140,column_major) uniform;uniform Mesh
{mat4 world;float visibility;};
#endif
#define WORLD_UBO
`;C.IncludesShadersStore[od]||(C.IncludesShadersStore[od]=wy);const ld="defaultUboDeclaration",By=`layout(std140,column_major) uniform;uniform Material
{vec4 diffuseLeftColor;vec4 diffuseRightColor;vec4 opacityParts;vec4 reflectionLeftColor;vec4 reflectionRightColor;vec4 refractionLeftColor;vec4 refractionRightColor;vec4 emissiveLeftColor;vec4 emissiveRightColor;vec2 vDiffuseInfos;vec2 vAmbientInfos;vec2 vOpacityInfos;vec2 vReflectionInfos;vec3 vReflectionPosition;vec3 vReflectionSize;vec2 vEmissiveInfos;vec2 vLightmapInfos;vec2 vSpecularInfos;vec3 vBumpInfos;mat4 diffuseMatrix;mat4 ambientMatrix;mat4 opacityMatrix;mat4 reflectionMatrix;mat4 emissiveMatrix;mat4 lightmapMatrix;mat4 specularMatrix;mat4 bumpMatrix;vec2 vTangentSpaceParams;float pointSize;float alphaCutOff;mat4 refractionMatrix;vec4 vRefractionInfos;vec3 vRefractionPosition;vec3 vRefractionSize;vec4 vSpecularColor;vec3 vEmissiveColor;vec4 vDiffuseColor;vec3 vAmbientColor;
#define ADDITIONAL_UBO_DECLARATION
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;C.IncludesShadersStore[ld]||(C.IncludesShadersStore[ld]=By);const cd="uvAttributeDeclaration",Uy=`#ifdef UV{X}
attribute vec2 uv{X};
#endif
`;C.IncludesShadersStore[cd]||(C.IncludesShadersStore[cd]=Uy);const hd="helperFunctions",Vy=`const float PI=3.1415926535897932384626433832795;const float TWO_PI=6.283185307179586;const float HALF_PI=1.5707963267948966;const float RECIPROCAL_PI=0.3183098861837907;const float RECIPROCAL_PI2=0.15915494309189535;const float RECIPROCAL_PI4=0.07957747154594767;const float HALF_MIN=5.96046448e-08; 
const float LinearEncodePowerApprox=2.2;const float GammaEncodePowerApprox=1.0/LinearEncodePowerApprox;const vec3 LuminanceEncodeApprox=vec3(0.2126,0.7152,0.0722);const float Epsilon=0.0000001;
#define saturate(x) clamp(x,0.0,1.0)
#define absEps(x) abs(x)+Epsilon
#define maxEps(x) max(x,Epsilon)
#define saturateEps(x) clamp(x,Epsilon,1.0)
mat3 transposeMat3(mat3 inMatrix) {vec3 i0=inMatrix[0];vec3 i1=inMatrix[1];vec3 i2=inMatrix[2];mat3 outMatrix=mat3(
vec3(i0.x,i1.x,i2.x),
vec3(i0.y,i1.y,i2.y),
vec3(i0.z,i1.z,i2.z)
);return outMatrix;}
mat3 inverseMat3(mat3 inMatrix) {float a00=inMatrix[0][0],a01=inMatrix[0][1],a02=inMatrix[0][2];float a10=inMatrix[1][0],a11=inMatrix[1][1],a12=inMatrix[1][2];float a20=inMatrix[2][0],a21=inMatrix[2][1],a22=inMatrix[2][2];float b01=a22*a11-a12*a21;float b11=-a22*a10+a12*a20;float b21=a21*a10-a11*a20;float det=a00*b01+a01*b11+a02*b21;return mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),
b11,(a22*a00-a02*a20),(-a12*a00+a02*a10),
b21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;}
#if USE_EXACT_SRGB_CONVERSIONS
vec3 toLinearSpaceExact(vec3 color)
{vec3 nearZeroSection=0.0773993808*color;vec3 remainingSection=pow(0.947867299*(color+vec3(0.055)),vec3(2.4));
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.04045)));
#else
return
vec3(
color.r<=0.04045 ? nearZeroSection.r : remainingSection.r,
color.g<=0.04045 ? nearZeroSection.g : remainingSection.g,
color.b<=0.04045 ? nearZeroSection.b : remainingSection.b);
#endif
}
vec3 toGammaSpaceExact(vec3 color)
{vec3 nearZeroSection=12.92*color;vec3 remainingSection=1.055*pow(color,vec3(0.41666))-vec3(0.055);
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.0031308)));
#else
return
vec3(
color.r<=0.0031308 ? nearZeroSection.r : remainingSection.r,
color.g<=0.0031308 ? nearZeroSection.g : remainingSection.g,
color.b<=0.0031308 ? nearZeroSection.b : remainingSection.b);
#endif
}
#endif
float toLinearSpace(float color)
{
#if USE_EXACT_SRGB_CONVERSIONS
float nearZeroSection=0.0773993808*color;float remainingSection=pow(0.947867299*(color+0.055),2.4);return color<=0.04045 ? nearZeroSection : remainingSection;
#else
return pow(color,LinearEncodePowerApprox);
#endif
}
vec3 toLinearSpace(vec3 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return toLinearSpaceExact(color);
#else
return pow(color,vec3(LinearEncodePowerApprox));
#endif
}
vec4 toLinearSpace(vec4 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4(toLinearSpaceExact(color.rgb),color.a);
#else
return vec4(pow(color.rgb,vec3(LinearEncodePowerApprox)),color.a);
#endif
}
float toGammaSpace(float color)
{
#if USE_EXACT_SRGB_CONVERSIONS
float nearZeroSection=12.92*color;float remainingSection=1.055*pow(color,0.41666)-0.055;return color<=0.0031308 ? nearZeroSection : remainingSection;
#else
return pow(color,GammaEncodePowerApprox);
#endif
}
vec3 toGammaSpace(vec3 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return toGammaSpaceExact(color);
#else
return pow(color,vec3(GammaEncodePowerApprox));
#endif
}
vec4 toGammaSpace(vec4 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4(toGammaSpaceExact(color.rgb),color.a);
#else
return vec4(pow(color.rgb,vec3(GammaEncodePowerApprox)),color.a);
#endif
}
float square(float value)
{return value*value;}
vec3 square(vec3 value)
{return value*value;}
float pow5(float value) {float sq=value*value;return sq*sq*value;}
float getLuminance(vec3 color)
{return saturate(dot(color,LuminanceEncodeApprox));}
float getRand(vec2 seed) {return fract(sin(dot(seed.xy ,vec2(12.9898,78.233)))*43758.5453);}
float dither(vec2 seed,float varianceAmount) {float rand=getRand(seed);float normVariance=varianceAmount/255.0;float dither=mix(-normVariance,normVariance,rand);return dither;}
const float rgbdMaxRange=255.;vec4 toRGBD(vec3 color) {float maxRGB=maxEps(max(color.r,max(color.g,color.b)));float D =max(rgbdMaxRange/maxRGB,1.);D =saturate(floor(D)/255.);vec3 rgb=color.rgb*D;rgb=toGammaSpace(rgb);return vec4(saturate(rgb),D);}
vec3 fromRGBD(vec4 rgbd) {rgbd.rgb=toLinearSpace(rgbd.rgb);return rgbd.rgb/rgbd.a;}
vec3 parallaxCorrectNormal( vec3 vertexPos,vec3 origVec,vec3 cubeSize,vec3 cubePos ) {vec3 invOrigVec=vec3(1.)/origVec;vec3 halfSize=cubeSize*0.5;vec3 intersecAtMaxPlane=(cubePos+halfSize-vertexPos)*invOrigVec;vec3 intersecAtMinPlane=(cubePos-halfSize-vertexPos)*invOrigVec;vec3 largestIntersec=max(intersecAtMaxPlane,intersecAtMinPlane);float distance=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);vec3 intersectPositionWS=vertexPos+origVec*distance;return intersectPositionWS-cubePos;}
vec3 equirectangularToCubemapDirection(vec2 uv) {float longitude=uv.x*TWO_PI-PI;float latitude=HALF_PI-uv.y*PI;vec3 direction;direction.x=cos(latitude)*sin(longitude);direction.y=sin(latitude);direction.z=cos(latitude)*cos(longitude);return direction;}
float sqrtClamped(float value) {return sqrt(max(value,0.));}
float avg(vec3 value) {return dot(value,vec3(0.333333333));}`;C.IncludesShadersStore[hd]||(C.IncludesShadersStore[hd]=Vy);const fd="bonesDeclaration",Gy=`#if NUM_BONE_INFLUENCERS>0
attribute vec4 matricesIndices;attribute vec4 matricesWeights;
#if NUM_BONE_INFLUENCERS>4
attribute vec4 matricesIndicesExtra;attribute vec4 matricesWeightsExtra;
#endif
#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#ifdef BONETEXTURE
uniform highp sampler2D boneSampler;uniform float boneTextureWidth;
#else
uniform mat4 mBones[BonesPerMesh];
#endif
#ifdef BONES_VELOCITY_ENABLED
uniform mat4 mPreviousBones[BonesPerMesh];
#endif
#ifdef BONETEXTURE
#define inline
mat4 readMatrixFromRawSampler(sampler2D smp,float index)
{float offset=index *4.0;float dx=1.0/boneTextureWidth;vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),0.));vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),0.));vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),0.));vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),0.));return mat4(m0,m1,m2,m3);}
#endif
#endif
#endif
`;C.IncludesShadersStore[fd]||(C.IncludesShadersStore[fd]=Gy);const ud="bakedVertexAnimationDeclaration",ky=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
uniform float bakedVertexAnimationTime;uniform vec2 bakedVertexAnimationTextureSizeInverted;uniform vec4 bakedVertexAnimationSettings;uniform sampler2D bakedVertexAnimationTexture;
#ifdef INSTANCES
attribute vec4 bakedVertexAnimationSettingsInstanced;
#endif
#define inline
mat4 readMatrixFromRawSamplerVAT(sampler2D smp,float index,float frame)
{float offset=index*4.0;float frameUV=(frame+0.5)*bakedVertexAnimationTextureSizeInverted.y;float dx=bakedVertexAnimationTextureSizeInverted.x;vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),frameUV));vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),frameUV));vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),frameUV));vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),frameUV));return mat4(m0,m1,m2,m3);}
#endif
`;C.IncludesShadersStore[ud]||(C.IncludesShadersStore[ud]=ky);const dd="instancesDeclaration",Wy=`#ifdef INSTANCES
attribute vec4 world0;attribute vec4 world1;attribute vec4 world2;attribute vec4 world3;
#ifdef INSTANCESCOLOR
attribute vec4 instanceColor;
#endif
#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)
uniform mat4 world;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
attribute vec4 previousWorld0;attribute vec4 previousWorld1;attribute vec4 previousWorld2;attribute vec4 previousWorld3;
#ifdef THIN_INSTANCES
uniform mat4 previousWorld;
#endif
#endif
#else
#if !defined(WORLD_UBO)
uniform mat4 world;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
uniform mat4 previousWorld;
#endif
#endif
`;C.IncludesShadersStore[dd]||(C.IncludesShadersStore[dd]=Wy);const _d="prePassVertexDeclaration",Xy=`#ifdef PREPASS
#ifdef PREPASS_LOCAL_POSITION
varying vec3 vPosition;
#endif
#ifdef PREPASS_DEPTH
varying vec3 vViewPos;
#endif
#if defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)
uniform mat4 previousViewProjection;varying vec4 vCurrentPosition;varying vec4 vPreviousPosition;
#endif
#endif
`;C.IncludesShadersStore[_d]||(C.IncludesShadersStore[_d]=Xy);const pd="mainUVVaryingDeclaration",Hy=`#ifdef MAINUV{X}
varying vec2 vMainUV{X};
#endif
`;C.IncludesShadersStore[pd]||(C.IncludesShadersStore[pd]=Hy);const md="samplerVertexDeclaration",zy=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
varying vec2 v_VARYINGNAME_UV;
#endif
`;C.IncludesShadersStore[md]||(C.IncludesShadersStore[md]=zy);const gd="bumpVertexDeclaration",Yy=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#endif
`;C.IncludesShadersStore[gd]||(C.IncludesShadersStore[gd]=Yy);const Ed="clipPlaneVertexDeclaration",Ky=`#ifdef CLIPPLANE
uniform vec4 vClipPlane;varying float fClipDistance;
#endif
#ifdef CLIPPLANE2
uniform vec4 vClipPlane2;varying float fClipDistance2;
#endif
#ifdef CLIPPLANE3
uniform vec4 vClipPlane3;varying float fClipDistance3;
#endif
#ifdef CLIPPLANE4
uniform vec4 vClipPlane4;varying float fClipDistance4;
#endif
#ifdef CLIPPLANE5
uniform vec4 vClipPlane5;varying float fClipDistance5;
#endif
#ifdef CLIPPLANE6
uniform vec4 vClipPlane6;varying float fClipDistance6;
#endif
`;C.IncludesShadersStore[Ed]||(C.IncludesShadersStore[Ed]=Ky);const vd="fogVertexDeclaration",qy=`#ifdef FOG
varying vec3 vFogDistance;
#endif
`;C.IncludesShadersStore[vd]||(C.IncludesShadersStore[vd]=qy);const Td="lightVxFragmentDeclaration",jy=`#ifdef LIGHT{X}
uniform vec4 vLightData{X};uniform vec4 vLightDiffuse{X};
#ifdef SPECULARTERM
uniform vec4 vLightSpecular{X};
#else
vec4 vLightSpecular{X}=vec4(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};
#elif defined(SHADOWCUBE{X})
#else
varying vec4 vPositionFromLight{X};varying float vDepthMetric{X};uniform mat4 lightMatrix{X};
#endif
uniform vec4 shadowsInfo{X};uniform vec2 depthValues{X};
#endif
#ifdef SPOTLIGHT{X}
uniform vec4 vLightDirection{X};uniform vec4 vLightFalloff{X};
#elif defined(POINTLIGHT{X})
uniform vec4 vLightFalloff{X};
#elif defined(HEMILIGHT{X})
uniform vec3 vLightGround{X};
#endif
#if defined(AREALIGHT{X})
uniform vec4 vLightWidth{X};uniform vec4 vLightHeight{X};
#endif
#endif
`;C.IncludesShadersStore[Td]||(C.IncludesShadersStore[Td]=jy);const Sd="lightVxUboDeclaration",Zy=`#ifdef LIGHT{X}
uniform Light{X}
{vec4 vLightData;vec4 vLightDiffuse;vec4 vLightSpecular;
#ifdef SPOTLIGHT{X}
vec4 vLightDirection;vec4 vLightFalloff;
#elif defined(POINTLIGHT{X})
vec4 vLightFalloff;
#elif defined(HEMILIGHT{X})
vec3 vLightGround;
#endif
#if defined(AREALIGHT{X})
vec4 vLightWidth;vec4 vLightHeight;
#endif
vec4 shadowsInfo;vec2 depthValues;} light{X};
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};
#elif defined(SHADOWCUBE{X})
#else
varying vec4 vPositionFromLight{X};varying float vDepthMetric{X};uniform mat4 lightMatrix{X};
#endif
#endif
#endif
`;C.IncludesShadersStore[Sd]||(C.IncludesShadersStore[Sd]=Zy);const Ad="morphTargetsVertexGlobalDeclaration",Qy=`#ifdef MORPHTARGETS
uniform float morphTargetInfluences[NUM_MORPH_INFLUENCERS];
#ifdef MORPHTARGETS_TEXTURE 
uniform float morphTargetTextureIndices[NUM_MORPH_INFLUENCERS];uniform vec3 morphTargetTextureInfo;uniform highp sampler2DArray morphTargets;vec3 readVector3FromRawSampler(int targetIndex,float vertexIndex)
{ 
float y=floor(vertexIndex/morphTargetTextureInfo.y);float x=vertexIndex-y*morphTargetTextureInfo.y;vec3 textureUV=vec3((x+0.5)/morphTargetTextureInfo.y,(y+0.5)/morphTargetTextureInfo.z,morphTargetTextureIndices[targetIndex]);return texture(morphTargets,textureUV).xyz;}
vec4 readVector4FromRawSampler(int targetIndex,float vertexIndex)
{ 
float y=floor(vertexIndex/morphTargetTextureInfo.y);float x=vertexIndex-y*morphTargetTextureInfo.y;vec3 textureUV=vec3((x+0.5)/morphTargetTextureInfo.y,(y+0.5)/morphTargetTextureInfo.z,morphTargetTextureIndices[targetIndex]);return texture(morphTargets,textureUV);}
#endif
#endif
`;C.IncludesShadersStore[Ad]||(C.IncludesShadersStore[Ad]=Qy);const Rd="morphTargetsVertexDeclaration",$y=`#ifdef MORPHTARGETS
#ifndef MORPHTARGETS_TEXTURE
#ifdef MORPHTARGETS_POSITION
attribute vec3 position{X};
#endif
#ifdef MORPHTARGETS_NORMAL
attribute vec3 normal{X};
#endif
#ifdef MORPHTARGETS_TANGENT
attribute vec3 tangent{X};
#endif
#ifdef MORPHTARGETS_UV
attribute vec2 uv_{X};
#endif
#ifdef MORPHTARGETS_UV2
attribute vec2 uv2_{X};
#endif
#elif {X}==0
uniform int morphTargetCount;
#endif
#endif
`;C.IncludesShadersStore[Rd]||(C.IncludesShadersStore[Rd]=$y);const Cd="logDepthDeclaration",Jy=`#ifdef LOGARITHMICDEPTH
uniform float logarithmicDepthConstant;varying float vFragmentDepth;
#endif
`;C.IncludesShadersStore[Cd]||(C.IncludesShadersStore[Cd]=Jy);const Id="morphTargetsVertexGlobal",eM=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE
float vertexID;
#endif
#endif
`;C.IncludesShadersStore[Id]||(C.IncludesShadersStore[Id]=eM);const bd="morphTargetsVertex",tM=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE
#if {X}==0
for (int i=0; i<NUM_MORPH_INFLUENCERS; i++) {if (i>=morphTargetCount) break;vertexID=float(gl_VertexID)*morphTargetTextureInfo.x;
#ifdef MORPHTARGETS_POSITION
positionUpdated+=(readVector3FromRawSampler(i,vertexID)-position)*morphTargetInfluences[i];
#endif
#ifdef MORPHTARGETTEXTURE_HASPOSITIONS
vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_NORMAL
normalUpdated+=(readVector3FromRawSampler(i,vertexID) -normal)*morphTargetInfluences[i];
#endif
#ifdef MORPHTARGETTEXTURE_HASNORMALS
vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_UV
uvUpdated+=(readVector3FromRawSampler(i,vertexID).xy-uv)*morphTargetInfluences[i];
#endif
#ifdef MORPHTARGETTEXTURE_HASUVS
vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz+=(readVector3FromRawSampler(i,vertexID) -tangent.xyz)*morphTargetInfluences[i];
#endif
#ifdef MORPHTARGETTEXTURE_HASTANGENTS
vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_UV2
uv2Updated+=(readVector3FromRawSampler(i,vertexID).xy-uv2)*morphTargetInfluences[i];
#endif
#ifdef MORPHTARGETTEXTURE_HASUV2S
vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_COLOR
colorUpdated+=(readVector4FromRawSampler(i,vertexID)-color)*morphTargetInfluences[i];
#endif
}
#endif
#else
#ifdef MORPHTARGETS_POSITION
positionUpdated+=(position{X}-position)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_NORMAL
normalUpdated+=(normal{X}-normal)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz+=(tangent{X}-tangent.xyz)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_UV
uvUpdated+=(uv_{X}-uv)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_UV2
uv2Updated+=(uv2_{X}-uv2)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_COLOR
colorUpdated+=(color{X}-color)*morphTargetInfluences[{X}];
#endif
#endif
#endif
`;C.IncludesShadersStore[bd]||(C.IncludesShadersStore[bd]=tM);const xd="instancesVertex",iM=`#ifdef INSTANCES
mat4 finalWorld=mat4(world0,world1,world2,world3);
#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
mat4 finalPreviousWorld=mat4(previousWorld0,previousWorld1,
previousWorld2,previousWorld3);
#endif
#ifdef THIN_INSTANCES
finalWorld=world*finalWorld;
#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
finalPreviousWorld=previousWorld*finalPreviousWorld;
#endif
#endif
#else
mat4 finalWorld=world;
#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
mat4 finalPreviousWorld=previousWorld;
#endif
#endif
`;C.IncludesShadersStore[xd]||(C.IncludesShadersStore[xd]=iM);const yd="bonesVertex",rM=`#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#if NUM_BONE_INFLUENCERS>0
mat4 influence;
#ifdef BONETEXTURE
influence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[0])*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[1])*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[2])*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[3])*matricesWeightsExtra[3];
#endif
#else
influence=mBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence+=mBones[int(matricesIndices[1])]*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
influence+=mBones[int(matricesIndices[2])]*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
influence+=mBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
influence+=mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
influence+=mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
influence+=mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
influence+=mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
#endif
finalWorld=finalWorld*influence;
#endif
#endif
`;C.IncludesShadersStore[yd]||(C.IncludesShadersStore[yd]=rM);const Md="bakedVertexAnimation",sM=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
{
#ifdef INSTANCES
#define BVASNAME bakedVertexAnimationSettingsInstanced
#else
#define BVASNAME bakedVertexAnimationSettings
#endif
float VATStartFrame=BVASNAME.x;float VATEndFrame=BVASNAME.y;float VATOffsetFrame=BVASNAME.z;float VATSpeed=BVASNAME.w;float totalFrames=VATEndFrame-VATStartFrame+1.0;float time=bakedVertexAnimationTime*VATSpeed/totalFrames;float frameCorrection=time<1.0 ? 0.0 : 1.0;float numOfFrames=totalFrames-frameCorrection;float VATFrameNum=fract(time)*numOfFrames;VATFrameNum=mod(VATFrameNum+VATOffsetFrame,numOfFrames);VATFrameNum=floor(VATFrameNum);VATFrameNum+=VATStartFrame+frameCorrection;mat4 VATInfluence;VATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[0],VATFrameNum)*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[1],VATFrameNum)*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[2],VATFrameNum)*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[3],VATFrameNum)*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[0],VATFrameNum)*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[1],VATFrameNum)*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[2],VATFrameNum)*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[3],VATFrameNum)*matricesWeightsExtra[3];
#endif
finalWorld=finalWorld*VATInfluence;}
#endif
`;C.IncludesShadersStore[Md]||(C.IncludesShadersStore[Md]=sM);const Pd="prePassVertex",nM=`#ifdef PREPASS_DEPTH
vViewPos=(view*worldPos).rgb;
#endif
#ifdef PREPASS_LOCAL_POSITION
vPosition=positionUpdated.xyz;
#endif
#if (defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*worldPos;
#if NUM_BONE_INFLUENCERS>0
mat4 previousInfluence;previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
vPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);
#else
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#endif
`;C.IncludesShadersStore[Pd]||(C.IncludesShadersStore[Pd]=nM);const Od="uvVariableDeclaration",aM=`#if !defined(UV{X}) && defined(MAINUV{X})
vec2 uv{X}=vec2(0.,0.);
#endif
#ifdef MAINUV{X}
vMainUV{X}=uv{X};
#endif
`;C.IncludesShadersStore[Od]||(C.IncludesShadersStore[Od]=aM);const Dd="samplerVertexImplementation",oM=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
if (v_INFONAME_==0.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uvUpdated,1.0,0.0));}
#ifdef UV2
else if (v_INFONAME_==1.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv2Updated,1.0,0.0));}
#endif
#ifdef UV3
else if (v_INFONAME_==2.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv3,1.0,0.0));}
#endif
#ifdef UV4
else if (v_INFONAME_==3.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv4,1.0,0.0));}
#endif
#ifdef UV5
else if (v_INFONAME_==4.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv5,1.0,0.0));}
#endif
#ifdef UV6
else if (v_INFONAME_==5.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv6,1.0,0.0));}
#endif
#endif
`;C.IncludesShadersStore[Dd]||(C.IncludesShadersStore[Dd]=oM);const Ld="bumpVertex",lM=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
vec3 tbnNormal=normalize(normalUpdated);vec3 tbnTangent=normalize(tangentUpdated.xyz);vec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;vTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);
#endif
#endif
`;C.IncludesShadersStore[Ld]||(C.IncludesShadersStore[Ld]=lM);const Nd="clipPlaneVertex",cM=`#ifdef CLIPPLANE
fClipDistance=dot(worldPos,vClipPlane);
#endif
#ifdef CLIPPLANE2
fClipDistance2=dot(worldPos,vClipPlane2);
#endif
#ifdef CLIPPLANE3
fClipDistance3=dot(worldPos,vClipPlane3);
#endif
#ifdef CLIPPLANE4
fClipDistance4=dot(worldPos,vClipPlane4);
#endif
#ifdef CLIPPLANE5
fClipDistance5=dot(worldPos,vClipPlane5);
#endif
#ifdef CLIPPLANE6
fClipDistance6=dot(worldPos,vClipPlane6);
#endif
`;C.IncludesShadersStore[Nd]||(C.IncludesShadersStore[Nd]=cM);const Fd="fogVertex",hM=`#ifdef FOG
vFogDistance=(view*worldPos).xyz;
#endif
`;C.IncludesShadersStore[Fd]||(C.IncludesShadersStore[Fd]=hM);const wd="shadowsVertex",fM=`#ifdef SHADOWS
#if defined(SHADOWCSM{X})
vPositionFromCamera{X}=view*worldPos;for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) {vPositionFromLight{X}[i]=lightMatrix{X}[i]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric{X}[i]=(-vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vDepthMetric{X}[i]=(vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
}
#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})
vPositionFromLight{X}=lightMatrix{X}*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric{X}=(-vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vDepthMetric{X}=(vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif
#endif
`;C.IncludesShadersStore[wd]||(C.IncludesShadersStore[wd]=fM);const Bd="vertexColorMixing",uM=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
vColor=vec4(1.0);
#ifdef VERTEXCOLOR
#ifdef VERTEXALPHA
vColor*=colorUpdated;
#else
vColor.rgb*=colorUpdated.rgb;
#endif
#endif
#ifdef INSTANCESCOLOR
vColor*=instanceColor;
#endif
#endif
`;C.IncludesShadersStore[Bd]||(C.IncludesShadersStore[Bd]=uM);const Ud="pointCloudVertex",dM=`#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
`;C.IncludesShadersStore[Ud]||(C.IncludesShadersStore[Ud]=dM);const Vd="logDepthVertex",_M=`#ifdef LOGARITHMICDEPTH
vFragmentDepth=1.0+gl_Position.w;gl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;
#endif
`;C.IncludesShadersStore[Vd]||(C.IncludesShadersStore[Vd]=_M);const Dl="defaultVertexShader",PE=`#define CUSTOM_VERTEX_EXTENSION
#include<__decl__defaultVertex>
#define CUSTOM_VERTEX_BEGIN
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#include<uvAttributeDeclaration>[2..7]
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<mainUVVaryingDeclaration>[1..7]
#include<samplerVertexDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#if defined(SPECULARTERM)
#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular)
#endif
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#ifdef UV2
vec2 uv2Updated=uv2;
#endif
#ifdef VERTEXCOLOR
vec4 colorUpdated=color;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}
#else
gl_Position=viewProjection*worldPos;
#endif
vPositionW=vec3(worldPos);
#ifdef PREPASS
#include<prePassVertex>
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif
#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifndef UV2
vec2 uv2Updated=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#ifdef MAINUV2
vMainUV2=uv2Updated;
#endif
#include<uvVariableDeclaration>[3..7]
#include<samplerVertexImplementation>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_MATRIXNAME_,diffuse,_INFONAME_,DiffuseInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#if defined(SPECULARTERM)
#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_MATRIXNAME_,specular,_INFONAME_,SpecularInfos.x)
#endif
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#include<pointCloudVertex>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;C.ShadersStore[Dl]||(C.ShadersStore[Dl]=PE);const pM={name:Dl,shader:PE},mM=Object.freeze(Object.defineProperty({__proto__:null,defaultVertexShader:pM},Symbol.toStringTag,{value:"Module"})),Gd="decalFragmentDeclaration",gM=`#ifdef DECAL
uniform vec4 vDecalInfos;
#endif
`;C.IncludesShadersStore[Gd]||(C.IncludesShadersStore[Gd]=gM);const kd="defaultFragmentDeclaration",EM=`uniform vec4 vEyePosition;uniform vec4 vDiffuseColor;uniform vec4 vSpecularColor;uniform vec3 vEmissiveColor;uniform vec3 vAmbientColor;uniform float visibility;
#ifdef DIFFUSE
uniform vec2 vDiffuseInfos;
#endif
#ifdef AMBIENT
uniform vec2 vAmbientInfos;
#endif
#ifdef OPACITY 
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;
#endif
#ifdef ALPHATEST
uniform float alphaCutOff;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif
#ifdef REFRACTION
uniform vec4 vRefractionInfos;
#ifndef REFRACTIONMAP_3D
uniform mat4 refractionMatrix;
#endif
#ifdef REFRACTIONFRESNEL
uniform vec4 refractionLeftColor;uniform vec4 refractionRightColor;
#endif
#if defined(USE_LOCAL_REFRACTIONMAP_CUBIC) && defined(REFRACTIONMAP_3D)
uniform vec3 vRefractionPosition;uniform vec3 vRefractionSize; 
#endif
#endif
#if defined(SPECULAR) && defined(SPECULARTERM)
uniform vec2 vSpecularInfos;
#endif
#ifdef DIFFUSEFRESNEL
uniform vec4 diffuseLeftColor;uniform vec4 diffuseRightColor;
#endif
#ifdef OPACITYFRESNEL
uniform vec4 opacityParts;
#endif
#ifdef EMISSIVEFRESNEL
uniform vec4 emissiveLeftColor;uniform vec4 emissiveRightColor;
#endif
#if defined(REFLECTION) || (defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED))
uniform vec2 vReflectionInfos;
#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION) || defined(REFLECTIONMAP_EQUIRECTANGULAR) || defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_SKYBOX)
uniform mat4 reflectionMatrix;
#endif
#ifndef REFLECTIONMAP_SKYBOX
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;uniform vec3 vReflectionSize; 
#endif
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 reflectionLeftColor;uniform vec4 reflectionRightColor;
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#include<decalFragmentDeclaration>
#define ADDITIONAL_FRAGMENT_DECLARATION
`;C.IncludesShadersStore[kd]||(C.IncludesShadersStore[kd]=EM);const Wd="prePassDeclaration",vM=`#ifdef PREPASS
#extension GL_EXT_draw_buffers : require
layout(location=0) out highp vec4 glFragData[{X}];highp vec4 gl_FragColor;
#ifdef PREPASS_LOCAL_POSITION
varying highp vec3 vPosition;
#endif
#ifdef PREPASS_DEPTH
varying highp vec3 vViewPos;
#endif
#if defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)
varying highp vec4 vCurrentPosition;varying highp vec4 vPreviousPosition;
#endif
#endif
`;C.IncludesShadersStore[Wd]||(C.IncludesShadersStore[Wd]=vM);const Xd="oitDeclaration",TM=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
#extension GL_EXT_draw_buffers : require
layout(location=0) out vec2 depth; 
layout(location=1) out vec4 frontColor;layout(location=2) out vec4 backColor;
#define MAX_DEPTH 99999.0
highp vec4 gl_FragColor;uniform sampler2D oitDepthSampler;uniform sampler2D oitFrontColorSampler;
#endif
`;C.IncludesShadersStore[Xd]||(C.IncludesShadersStore[Xd]=TM);const Hd="lightFragmentDeclaration",SM=`#ifdef LIGHT{X}
uniform vec4 vLightData{X};uniform vec4 vLightDiffuse{X};
#ifdef SPECULARTERM
uniform vec4 vLightSpecular{X};
#else
vec4 vLightSpecular{X}=vec4(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];uniform float cascadeBlendFactor{X};varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DArrayShadow shadowTexture{X};uniform highp sampler2DArray depthTexture{X};uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float penumbraDarkness{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DArrayShadow shadowTexture{X};
#else
uniform highp sampler2DArray shadowTexture{X};
#endif
#ifdef SHADOWCSMDEBUG{X}
const vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]
(
vec3 ( 1.5,0.0,0.0 ),
vec3 ( 0.0,1.5,0.0 ),
vec3 ( 0.0,0.0,5.5 ),
vec3 ( 1.5,0.0,5.5 ),
vec3 ( 1.5,1.5,0.0 ),
vec3 ( 1.0,1.0,1.0 ),
vec3 ( 0.0,1.0,5.5 ),
vec3 ( 0.5,3.5,0.75 )
);vec3 shadowDebug{X};
#endif
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
int index{X}=-1;
#else
int index{X}=SHADOWCSMNUM_CASCADES{X}-1;
#endif
float diff{X}=0.;
#elif defined(SHADOWCUBE{X})
uniform samplerCube shadowTexture{X};
#else
varying vec4 vPositionFromLight{X};varying float vDepthMetric{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DShadow shadowTexture{X};uniform highp sampler2D depthTexture{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DShadow shadowTexture{X};
#else
uniform sampler2D shadowTexture{X};
#endif
uniform mat4 lightMatrix{X};
#endif
uniform vec4 shadowsInfo{X};uniform vec2 depthValues{X};
#endif
#ifdef SPOTLIGHT{X}
uniform vec4 vLightDirection{X};uniform vec4 vLightFalloff{X};
#elif defined(POINTLIGHT{X})
uniform vec4 vLightFalloff{X};
#elif defined(HEMILIGHT{X})
uniform vec3 vLightGround{X};
#endif
#ifdef AREALIGHT{X}
uniform vec4 vLightWidth{X};uniform vec4 vLightHeight{X};
#endif
#ifdef IESLIGHTTEXTURE{X}
uniform sampler2D iesLightTexture{X};
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform mat4 textureProjectionMatrix{X};uniform sampler2D projectionLightTexture{X};
#endif
#endif
`;C.IncludesShadersStore[Hd]||(C.IncludesShadersStore[Hd]=SM);const zd="lightUboDeclaration",AM=`#ifdef LIGHT{X}
uniform Light{X}
{vec4 vLightData;vec4 vLightDiffuse;vec4 vLightSpecular;
#ifdef SPOTLIGHT{X}
vec4 vLightDirection;vec4 vLightFalloff;
#elif defined(POINTLIGHT{X})
vec4 vLightFalloff;
#elif defined(HEMILIGHT{X})
vec3 vLightGround;
#endif
#if defined(AREALIGHT{X})
vec4 vLightWidth;vec4 vLightHeight;
#endif
vec4 shadowsInfo;vec2 depthValues;} light{X};
#ifdef IESLIGHTTEXTURE{X}
uniform sampler2D iesLightTexture{X};
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform mat4 textureProjectionMatrix{X};uniform sampler2D projectionLightTexture{X};
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];uniform float cascadeBlendFactor{X};varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DArrayShadow shadowTexture{X};uniform highp sampler2DArray depthTexture{X};uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float penumbraDarkness{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DArrayShadow shadowTexture{X};
#else
uniform highp sampler2DArray shadowTexture{X};
#endif
#ifdef SHADOWCSMDEBUG{X}
const vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]
(
vec3 ( 1.5,0.0,0.0 ),
vec3 ( 0.0,1.5,0.0 ),
vec3 ( 0.0,0.0,5.5 ),
vec3 ( 1.5,0.0,5.5 ),
vec3 ( 1.5,1.5,0.0 ),
vec3 ( 1.0,1.0,1.0 ),
vec3 ( 0.0,1.0,5.5 ),
vec3 ( 0.5,3.5,0.75 )
);vec3 shadowDebug{X};
#endif
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
int index{X}=-1;
#else
int index{X}=SHADOWCSMNUM_CASCADES{X}-1;
#endif
float diff{X}=0.;
#elif defined(SHADOWCUBE{X})
uniform samplerCube shadowTexture{X}; 
#else
varying vec4 vPositionFromLight{X};varying float vDepthMetric{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DShadow shadowTexture{X};uniform highp sampler2D depthTexture{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DShadow shadowTexture{X};
#else
uniform sampler2D shadowTexture{X};
#endif
uniform mat4 lightMatrix{X};
#endif
#endif
#endif
`;C.IncludesShadersStore[zd]||(C.IncludesShadersStore[zd]=AM);const Yd="ltcHelperFunctions",RM=`vec2 LTCUv( const in vec3 N,const in vec3 V,const in float roughness ) {const float LUTSIZE=64.0;const float LUTSCALE=( LUTSIZE-1.0 )/LUTSIZE;const float LUTBIAS=0.5/LUTSIZE;float dotNV=saturate( dot( N,V ) );vec2 uv=vec2( roughness,sqrt( 1.0-dotNV ) );uv=uv*LUTSCALE+LUTBIAS;return uv;}
float LTCClippedSphereFormFactor( const in vec3 f ) {float l=length( f );return max( ( l*l+f.z )/( l+1.0 ),0.0 );}
vec3 LTCEdgeVectorFormFactor( const in vec3 v1,const in vec3 v2 ) {float x=dot( v1,v2 );float y=abs( x );float a=0.8543985+( 0.4965155+0.0145206*y )*y;float b=3.4175940+( 4.1616724+y )*y;float v=a/b;float thetaSintheta=0.0;if( x>0.0 )
{thetaSintheta=v;}
else
{thetaSintheta=0.5*inversesqrt( max( 1.0-x*x,1e-7 ) )-v;}
return cross( v1,v2 )*thetaSintheta;}
vec3 LTCEvaluate( const in vec3 N,const in vec3 V,const in vec3 P,const in mat3 mInv,const in vec3 rectCoords[ 4 ] ) {vec3 v1=rectCoords[ 1 ]-rectCoords[ 0 ];vec3 v2=rectCoords[ 3 ]-rectCoords[ 0 ];vec3 lightNormal=cross( v1,v2 );if( dot( lightNormal,P-rectCoords[ 0 ] )<0.0 ) return vec3( 0.0 );vec3 T1,T2;T1=normalize( V-N*dot( V,N ) );T2=- cross( N,T1 ); 
mat3 mat=mInv*transposeMat3( mat3( T1,T2,N ) );vec3 coords[ 4 ];coords[ 0 ]=mat*( rectCoords[ 0 ]-P );coords[ 1 ]=mat*( rectCoords[ 1 ]-P );coords[ 2 ]=mat*( rectCoords[ 2 ]-P );coords[ 3 ]=mat*( rectCoords[ 3 ]-P );coords[ 0 ]=normalize( coords[ 0 ] );coords[ 1 ]=normalize( coords[ 1 ] );coords[ 2 ]=normalize( coords[ 2 ] );coords[ 3 ]=normalize( coords[ 3 ] );vec3 vectorFormFactor=vec3( 0.0 );vectorFormFactor+=LTCEdgeVectorFormFactor( coords[ 0 ],coords[ 1 ] );vectorFormFactor+=LTCEdgeVectorFormFactor( coords[ 1 ],coords[ 2 ] );vectorFormFactor+=LTCEdgeVectorFormFactor( coords[ 2 ],coords[ 3 ] );vectorFormFactor+=LTCEdgeVectorFormFactor( coords[ 3 ],coords[ 0 ] );float result=LTCClippedSphereFormFactor( vectorFormFactor );return vec3( result );}
struct areaLightData
{vec3 Diffuse;vec3 Specular;vec4 Fresnel;};
#define inline
areaLightData computeAreaLightSpecularDiffuseFresnel(const in sampler2D ltc1,const in sampler2D ltc2,const in vec3 viewDir,const in vec3 normal,const in vec3 position,const in vec3 lightPos,const in vec3 halfWidth,const in vec3 halfHeight,const in float roughness) 
{areaLightData result;vec3 rectCoords[ 4 ];rectCoords[ 0 ]=lightPos+halfWidth-halfHeight; 
rectCoords[ 1 ]=lightPos-halfWidth-halfHeight;rectCoords[ 2 ]=lightPos-halfWidth+halfHeight;rectCoords[ 3 ]=lightPos+halfWidth+halfHeight;
#ifdef SPECULARTERM
vec2 uv=LTCUv( normal,viewDir,roughness );vec4 t1=texture2D( ltc1,uv );vec4 t2=texture2D( ltc2,uv );mat3 mInv=mat3(
vec3( t1.x,0,t1.y ),
vec3( 0,1, 0 ),
vec3( t1.z,0,t1.w )
);result.Specular=LTCEvaluate( normal,viewDir,position,mInv,rectCoords );result.Fresnel=t2;
#endif
result.Diffuse=LTCEvaluate( normal,viewDir,position,mat3( 1.0 ),rectCoords );return result;}`;C.IncludesShadersStore[Yd]||(C.IncludesShadersStore[Yd]=RM);const Kd="lightsFragmentFunctions",CM=`struct lightingInfo
{vec3 diffuse;
#ifdef SPECULARTERM
vec3 specular;
#endif
#ifdef NDOTL
float ndl;
#endif
};lightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {lightingInfo result;vec3 lightVectorW;float attenuation=1.0;if (lightData.w==0.)
{vec3 direction=lightData.xyz-vPositionW;attenuation=max(0.,1.0-length(direction)/range);lightVectorW=normalize(direction);}
else
{lightVectorW=normalize(-lightData.xyz);}
float ndl=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightVectorW);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;
#endif
return result;}
float getAttenuation(float cosAngle,float exponent) {return max(0.,pow(cosAngle,exponent));}
float getIESAttenuation(float cosAngle,sampler2D iesLightSampler) {float angle=acos(cosAngle)/PI;return texture2D(iesLightSampler,vec2(angle,0.)).r;}
lightingInfo basicSpotLighting(vec3 viewDirectionW,vec3 lightVectorW,vec3 vNormal,float attenuation,vec3 diffuseColor,vec3 specularColor,float glossiness) {lightingInfo result; 
float ndl=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightVectorW);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;
#endif
return result;}
lightingInfo computeIESSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness,sampler2D iesLightSampler) { 
vec3 direction=lightData.xyz-vPositionW;vec3 lightVectorW=normalize(direction);float attenuation=max(0.,1.0-length(direction)/range);float dotProduct=dot(lightDirection.xyz,-lightVectorW);float cosAngle=max(0.,dotProduct);if (cosAngle>=lightDirection.w)
{ 
attenuation*=getIESAttenuation(dotProduct,iesLightSampler);return basicSpotLighting(viewDirectionW,lightVectorW,vNormal,attenuation,diffuseColor,specularColor,glossiness);}
lightingInfo result;result.diffuse=vec3(0.);
#ifdef SPECULARTERM
result.specular=vec3(0.);
#endif
#ifdef NDOTL
result.ndl=0.;
#endif
return result;}
lightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {vec3 direction=lightData.xyz-vPositionW;vec3 lightVectorW=normalize(direction);float attenuation=max(0.,1.0-length(direction)/range);float cosAngle=max(0.,dot(lightDirection.xyz,-lightVectorW));if (cosAngle>=lightDirection.w)
{ 
attenuation*=getAttenuation(cosAngle,lightData.w);return basicSpotLighting(viewDirectionW,lightVectorW,vNormal,attenuation,diffuseColor,specularColor,glossiness);}
lightingInfo result;result.diffuse=vec3(0.);
#ifdef SPECULARTERM
result.specular=vec3(0.);
#endif
#ifdef NDOTL
result.ndl=0.;
#endif
return result;}
lightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {lightingInfo result;float ndl=dot(vNormal,lightData.xyz)*0.5+0.5;
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=mix(groundColor,diffuseColor,ndl);
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightData.xyz);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor;
#endif
return result;}
#define inline
vec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix,vec3 posW){vec4 strq=textureProjectionMatrix*vec4(posW,1.0);strq/=strq.w;vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;return textureColor;}
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
#include<ltcHelperFunctions>
uniform sampler2D areaLightsLTC1Sampler;uniform sampler2D areaLightsLTC2Sampler;
#define inline
lightingInfo computeAreaLighting(sampler2D ltc1,sampler2D ltc2,vec3 viewDirectionW,vec3 vNormal,vec3 vPosition,vec3 lightPosition,vec3 halfWidth,vec3 halfHeight,vec3 diffuseColor,vec3 specularColor,float roughness) 
{lightingInfo result;areaLightData data=computeAreaLightSpecularDiffuseFresnel(ltc1,ltc2,viewDirectionW,vNormal,vPosition,lightPosition,halfWidth,halfHeight,roughness);
#ifdef SPECULARTERM
vec3 fresnel=( specularColor*data.Fresnel.x+( vec3( 1.0 )-specularColor )*data.Fresnel.y );result.specular+=specularColor*fresnel*data.Specular;
#endif
result.diffuse+=diffuseColor*data.Diffuse;return result;}
#endif
`;C.IncludesShadersStore[Kd]||(C.IncludesShadersStore[Kd]=CM);const qd="shadowsFragmentFunctions",IM=`#ifdef SHADOWS
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)
#else
#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)
#endif
#ifndef SHADOWFLOAT
float unpack(vec4 color)
{const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}
#endif
float computeFallOff(float value,vec2 clipSpace,float frustumEdgeFalloff)
{float mask=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));return mix(value,1.0,mask);}
#define inline
float computeShadowCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,vec2 depthValues)
{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadow=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadow=textureCube(shadowSampler,directionToLight).x;
#endif
return depth>shadow ? darkness : 1.0;}
#define inline
float computeShadowWithPoissonSamplingCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float mapSize,float darkness,vec2 depthValues)
{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;float visibility=1.;vec3 poissonDisk[4];poissonDisk[0]=vec3(-1.0,1.0,-1.0);poissonDisk[1]=vec3(1.0,-1.0,-1.0);poissonDisk[2]=vec3(-1.0,-1.0,-1.0);poissonDisk[3]=vec3(1.0,-1.0,1.0);
#ifndef SHADOWFLOAT
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) visibility-=0.25;
#else
if (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) visibility-=0.25;
#endif
return min(1.0,visibility+darkness);}
#define inline
float computeShadowWithESMCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)
{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadowMapSample=textureCube(shadowSampler,directionToLight).x;
#endif
float esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return esm;}
#define inline
float computeShadowWithCloseESMCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)
{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadowMapSample=textureCube(shadowSampler,directionToLight).x;
#endif
float esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return esm;}
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define inline
float computeShadowCSM(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray shadowSampler,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);vec3 uvLayer=vec3(uv.x,uv.y,layer);float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadow=unpack(texture2D(shadowSampler,uvLayer));
#else
float shadow=texture2D(shadowSampler,uvLayer).x;
#endif
return shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;}
#endif
#define inline
float computeShadow(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadow=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadow=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
return shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;}}
#define inline
float computeShadowWithPoissonSampling(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float mapSize,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{float shadowPixelDepth=clamp(depthMetric,0.,1.0);float visibility=1.;vec2 poissonDisk[4];poissonDisk[0]=vec2(-0.94201624,-0.39906216);poissonDisk[1]=vec2(0.94558609,-0.76890725);poissonDisk[2]=vec2(-0.094184101,-0.92938870);poissonDisk[3]=vec2(0.34495938,0.29387760);
#ifndef SHADOWFLOAT
if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;
#else
if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;
#endif
return computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
float esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithCloseESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{float shadowPixelDepth=clamp(depthMetric,0.,1.0); 
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
float esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}
#ifdef IS_NDC_HALF_ZRANGE
#define ZINCLIP clipSpace.z
#else
#define ZINCLIP uvDepth.z
#endif
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define GREATEST_LESS_THAN_ONE 0.99999994
#define DISABLE_UNIFORMITY_ANALYSIS
#define inline
float computeShadowWithCSMPCF1(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);float shadow=texture2D(shadowSampler,uvDepthLayer);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
#define inline
float computeShadowWithCSMPCF3(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=3.-2.*st;vec2 uvw1=1.+2.*st;vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
#define inline
float computeShadowWithCSMPCF5(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=4.-3.*st;vec2 uvw1=vec2(7.);vec2 uvw2=1.+3.*st;vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));shadow+=uvw2.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[0]),layer,uvDepth.z));shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));shadow+=uvw2.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[1]),layer,uvDepth.z));shadow+=uvw0.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[2]),layer,uvDepth.z));shadow+=uvw1.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[2]),layer,uvDepth.z));shadow+=uvw2.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[2]),layer,uvDepth.z));shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
#define inline
float computeShadowWithPCF1(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,float darkness,float frustumEdgeFalloff)
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;float shadow=TEXTUREFUNC(shadowSampler,uvDepth,0.);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithPCF3(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=3.-2.*st;vec2 uvw1=1.+2.*st;vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithPCF5(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=4.-3.*st;vec2 uvw1=vec2(7.);vec2 uvw2=1.+3.*st;vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);shadow+=uvw2.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[0]),uvDepth.z),0.);shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);shadow+=uvw2.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[1]),uvDepth.z),0.);shadow+=uvw0.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[2]),uvDepth.z),0.);shadow+=uvw1.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[2]),uvDepth.z),0.);shadow+=uvw2.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[2]),uvDepth.z),0.);shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
const vec3 PoissonSamplers32[64]=vec3[64](
vec3(0.06407013,0.05409927,0.),
vec3(0.7366577,0.5789394,0.),
vec3(-0.6270542,-0.5320278,0.),
vec3(-0.4096107,0.8411095,0.),
vec3(0.6849564,-0.4990818,0.),
vec3(-0.874181,-0.04579735,0.),
vec3(0.9989998,0.0009880066,0.),
vec3(-0.004920578,-0.9151649,0.),
vec3(0.1805763,0.9747483,0.),
vec3(-0.2138451,0.2635818,0.),
vec3(0.109845,0.3884785,0.),
vec3(0.06876755,-0.3581074,0.),
vec3(0.374073,-0.7661266,0.),
vec3(0.3079132,-0.1216763,0.),
vec3(-0.3794335,-0.8271583,0.),
vec3(-0.203878,-0.07715034,0.),
vec3(0.5912697,0.1469799,0.),
vec3(-0.88069,0.3031784,0.),
vec3(0.5040108,0.8283722,0.),
vec3(-0.5844124,0.5494877,0.),
vec3(0.6017799,-0.1726654,0.),
vec3(-0.5554981,0.1559997,0.),
vec3(-0.3016369,-0.3900928,0.),
vec3(-0.5550632,-0.1723762,0.),
vec3(0.925029,0.2995041,0.),
vec3(-0.2473137,0.5538505,0.),
vec3(0.9183037,-0.2862392,0.),
vec3(0.2469421,0.6718712,0.),
vec3(0.3916397,-0.4328209,0.),
vec3(-0.03576927,-0.6220032,0.),
vec3(-0.04661255,0.7995201,0.),
vec3(0.4402924,0.3640312,0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.)
);const vec3 PoissonSamplers64[64]=vec3[64](
vec3(-0.613392,0.617481,0.),
vec3(0.170019,-0.040254,0.),
vec3(-0.299417,0.791925,0.),
vec3(0.645680,0.493210,0.),
vec3(-0.651784,0.717887,0.),
vec3(0.421003,0.027070,0.),
vec3(-0.817194,-0.271096,0.),
vec3(-0.705374,-0.668203,0.),
vec3(0.977050,-0.108615,0.),
vec3(0.063326,0.142369,0.),
vec3(0.203528,0.214331,0.),
vec3(-0.667531,0.326090,0.),
vec3(-0.098422,-0.295755,0.),
vec3(-0.885922,0.215369,0.),
vec3(0.566637,0.605213,0.),
vec3(0.039766,-0.396100,0.),
vec3(0.751946,0.453352,0.),
vec3(0.078707,-0.715323,0.),
vec3(-0.075838,-0.529344,0.),
vec3(0.724479,-0.580798,0.),
vec3(0.222999,-0.215125,0.),
vec3(-0.467574,-0.405438,0.),
vec3(-0.248268,-0.814753,0.),
vec3(0.354411,-0.887570,0.),
vec3(0.175817,0.382366,0.),
vec3(0.487472,-0.063082,0.),
vec3(-0.084078,0.898312,0.),
vec3(0.488876,-0.783441,0.),
vec3(0.470016,0.217933,0.),
vec3(-0.696890,-0.549791,0.),
vec3(-0.149693,0.605762,0.),
vec3(0.034211,0.979980,0.),
vec3(0.503098,-0.308878,0.),
vec3(-0.016205,-0.872921,0.),
vec3(0.385784,-0.393902,0.),
vec3(-0.146886,-0.859249,0.),
vec3(0.643361,0.164098,0.),
vec3(0.634388,-0.049471,0.),
vec3(-0.688894,0.007843,0.),
vec3(0.464034,-0.188818,0.),
vec3(-0.440840,0.137486,0.),
vec3(0.364483,0.511704,0.),
vec3(0.034028,0.325968,0.),
vec3(0.099094,-0.308023,0.),
vec3(0.693960,-0.366253,0.),
vec3(0.678884,-0.204688,0.),
vec3(0.001801,0.780328,0.),
vec3(0.145177,-0.898984,0.),
vec3(0.062655,-0.611866,0.),
vec3(0.315226,-0.604297,0.),
vec3(-0.780145,0.486251,0.),
vec3(-0.371868,0.882138,0.),
vec3(0.200476,0.494430,0.),
vec3(-0.494552,-0.711051,0.),
vec3(0.612476,0.705252,0.),
vec3(-0.578845,-0.768792,0.),
vec3(-0.772454,-0.090976,0.),
vec3(0.504440,0.372295,0.),
vec3(0.155736,0.065157,0.),
vec3(0.391522,0.849605,0.),
vec3(-0.620106,-0.328104,0.),
vec3(0.789239,-0.419965,0.),
vec3(-0.545396,0.538133,0.),
vec3(-0.178564,-0.596057,0.)
);
#define inline
float computeShadowWithCSMPCSS(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);float blockerDepth=0.0;float sumBlockerDepth=0.0;float numBlocker=0.0;for (int i=0; i<searchTapCount; i ++) {blockerDepth=texture2D(depthSampler,vec3(uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer)).r;if (blockerDepth<depthMetric) {sumBlockerDepth+=blockerDepth;numBlocker++;}}
float avgBlockerDepth=sumBlockerDepth/numBlocker;float AAOffset=shadowMapSizeInverse*10.;float penumbraRatio=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);vec4 filterRadius=vec4(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);float random=getRand(vPositionFromLight.xy);float rotationAngle=random*3.1415926;vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));float shadow=0.;for (int i=0; i<pcfTapCount; i++) {vec4 offset=vec4(poissonSamplers[i],0.);offset=vec4(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);shadow+=texture2D(shadowSampler,uvDepthLayer+offset*filterRadius);}
shadow/=float(pcfTapCount);shadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));shadow=mix(darkness,1.,shadow);if (numBlocker<1.0) {return 1.0;}
else
{return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithPCSS(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers)
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;float blockerDepth=0.0;float sumBlockerDepth=0.0;float numBlocker=0.0;for (int i=0; i<searchTapCount; i ++) {blockerDepth=TEXTUREFUNC(depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy),0.).r;if (blockerDepth<depthMetric) {sumBlockerDepth+=blockerDepth;numBlocker++;}}
if (numBlocker<1.0) {return 1.0;}
else
{float avgBlockerDepth=sumBlockerDepth/numBlocker;float AAOffset=shadowMapSizeInverse*10.;float penumbraRatio=((depthMetric-avgBlockerDepth)+AAOffset);float filterRadius=penumbraRatio*lightSizeUV*shadowMapSizeInverse;float random=getRand(vPositionFromLight.xy);float rotationAngle=random*3.1415926;vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));float shadow=0.;for (int i=0; i<pcfTapCount; i++) {vec3 offset=poissonSamplers[i];offset=vec3(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);shadow+=TEXTUREFUNC(shadowSampler,uvDepth+offset*filterRadius,0.);}
shadow/=float(pcfTapCount);shadow=mix(shadow,1.,depthMetric-avgBlockerDepth);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}}
#define inline
float computeShadowWithPCSS16(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);}
#define inline
float computeShadowWithPCSS32(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);}
#define inline
float computeShadowWithPCSS64(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);}
#define inline
float computeShadowWithCSMPCSS16(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
#define inline
float computeShadowWithCSMPCSS32(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
#define inline
float computeShadowWithCSMPCSS64(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
#endif
#endif
`;C.IncludesShadersStore[qd]||(C.IncludesShadersStore[qd]=IM);const jd="samplerFragmentDeclaration",bM=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying vec2 v_VARYINGNAME_UV;
#endif
uniform sampler2D _SAMPLERNAME_Sampler;
#endif
`;C.IncludesShadersStore[jd]||(C.IncludesShadersStore[jd]=bM);const Zd="fresnelFunction",xM=`#ifdef FRESNEL
float computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)
{float fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);return clamp(fresnelTerm,0.,1.);}
#endif
`;C.IncludesShadersStore[Zd]||(C.IncludesShadersStore[Zd]=xM);const Qd="reflectionFunction",yM=`vec3 computeFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)
{float lon=atan(direction.z,direction.x);float lat=acos(direction.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(s,t,0); }
vec3 computeMirroredFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)
{float lon=atan(direction.z,direction.x);float lat=acos(direction.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(1.0-s,t,0); }
vec3 computeEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{vec3 cameraToVertex=normalize(worldPos.xyz-eyePosition);vec3 r=normalize(reflect(cameraToVertex,worldNormal));r=vec3(reflectionMatrix*vec4(r,0));float lon=atan(r.z,r.x);float lat=acos(r.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(s,t,0);}
vec3 computeSphericalCoords(vec4 worldPos,vec3 worldNormal,mat4 view,mat4 reflectionMatrix)
{vec3 viewDir=normalize(vec3(view*worldPos));vec3 viewNormal=normalize(vec3(view*vec4(worldNormal,0.0)));vec3 r=reflect(viewDir,viewNormal);r=vec3(reflectionMatrix*vec4(r,0));r.z=r.z-1.0;float m=2.0*length(r);return vec3(r.x/m+0.5,1.0-r.y/m-0.5,0);}
vec3 computePlanarCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{vec3 viewDir=worldPos.xyz-eyePosition;vec3 coords=normalize(reflect(viewDir,worldNormal));return vec3(reflectionMatrix*vec4(coords,1));}
vec3 computeCubicCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{vec3 viewDir=normalize(worldPos.xyz-eyePosition);vec3 coords=reflect(viewDir,worldNormal);coords=vec3(reflectionMatrix*vec4(coords,0));
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;}
vec3 computeCubicLocalCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix,vec3 reflectionSize,vec3 reflectionPosition)
{vec3 viewDir=normalize(worldPos.xyz-eyePosition);vec3 coords=reflect(viewDir,worldNormal);coords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);coords=vec3(reflectionMatrix*vec4(coords,0));
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;}
vec3 computeProjectionCoords(vec4 worldPos,mat4 view,mat4 reflectionMatrix)
{return vec3(reflectionMatrix*(view*worldPos));}
vec3 computeSkyBoxCoords(vec3 positionW,mat4 reflectionMatrix)
{return vec3(reflectionMatrix*vec4(positionW,1.));}
#ifdef REFLECTION
vec3 computeReflectionCoords(vec4 worldPos,vec3 worldNormal)
{
#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED
vec3 direction=normalize(vDirectionW);return computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED
vec3 direction=normalize(vDirectionW);return computeFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR
return computeEquirectangularCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SPHERICAL
return computeSphericalCoords(worldPos,worldNormal,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_PLANAR
return computePlanarCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_CUBIC
#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC
return computeCubicLocalCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix,vReflectionSize,vReflectionPosition);
#else
return computeCubicCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#endif
#ifdef REFLECTIONMAP_PROJECTION
return computeProjectionCoords(worldPos,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SKYBOX
return computeSkyBoxCoords(vPositionUVW,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_EXPLICIT
return vec3(0,0,0);
#endif
}
#endif
`;C.IncludesShadersStore[Qd]||(C.IncludesShadersStore[Qd]=yM);const $d="imageProcessingDeclaration",MM=`#ifdef EXPOSURE
uniform float exposureLinear;
#endif
#ifdef CONTRAST
uniform float contrast;
#endif
#if defined(VIGNETTE) || defined(DITHER)
uniform vec2 vInverseScreenSize;
#endif
#ifdef VIGNETTE
uniform vec4 vignetteSettings1;uniform vec4 vignetteSettings2;
#endif
#ifdef COLORCURVES
uniform vec4 vCameraColorCurveNegative;uniform vec4 vCameraColorCurveNeutral;uniform vec4 vCameraColorCurvePositive;
#endif
#ifdef COLORGRADING
#ifdef COLORGRADING3D
uniform highp sampler3D txColorTransform;
#else
uniform sampler2D txColorTransform;
#endif
uniform vec4 colorTransformSettings;
#endif
#ifdef DITHER
uniform float ditherIntensity;
#endif
`;C.IncludesShadersStore[$d]||(C.IncludesShadersStore[$d]=MM);const Jd="imageProcessingFunctions",PM=`#if defined(COLORGRADING) && !defined(COLORGRADING3D)
/** 
* Polyfill for SAMPLE_TEXTURE_3D,which is unsupported in WebGL.
* sampler3dSetting.x=textureOffset (0.5/textureSize).
* sampler3dSetting.y=textureSize.
*/
#define inline
vec3 sampleTexture3D(sampler2D colorTransform,vec3 color,vec2 sampler3dSetting)
{float sliceSize=2.0*sampler3dSetting.x; 
#ifdef SAMPLER3DGREENDEPTH
float sliceContinuous=(color.g-sampler3dSetting.x)*sampler3dSetting.y;
#else
float sliceContinuous=(color.b-sampler3dSetting.x)*sampler3dSetting.y;
#endif
float sliceInteger=floor(sliceContinuous);float sliceFraction=sliceContinuous-sliceInteger;
#ifdef SAMPLER3DGREENDEPTH
vec2 sliceUV=color.rb;
#else
vec2 sliceUV=color.rg;
#endif
sliceUV.x*=sliceSize;sliceUV.x+=sliceInteger*sliceSize;sliceUV=saturate(sliceUV);vec4 slice0Color=texture2D(colorTransform,sliceUV);sliceUV.x+=sliceSize;sliceUV=saturate(sliceUV);vec4 slice1Color=texture2D(colorTransform,sliceUV);vec3 result=mix(slice0Color.rgb,slice1Color.rgb,sliceFraction);
#ifdef SAMPLER3DBGRMAP
color.rgb=result.rgb;
#else
color.rgb=result.bgr;
#endif
return color;}
#endif
#if TONEMAPPING==3
const float PBRNeutralStartCompression=0.8-0.04;const float PBRNeutralDesaturation=0.15;vec3 PBRNeutralToneMapping( vec3 color ) {float x=min(color.r,min(color.g,color.b));float offset=x<0.08 ? x-6.25*x*x : 0.04;color-=offset;float peak=max(color.r,max(color.g,color.b));if (peak<PBRNeutralStartCompression) return color;float d=1.-PBRNeutralStartCompression;float newPeak=1.-d*d/(peak+d-PBRNeutralStartCompression);color*=newPeak/peak;float g=1.-1./(PBRNeutralDesaturation*(peak-newPeak)+1.);return mix(color,newPeak*vec3(1,1,1),g);}
#endif
#if TONEMAPPING==2
const mat3 ACESInputMat=mat3(
vec3(0.59719,0.07600,0.02840),
vec3(0.35458,0.90834,0.13383),
vec3(0.04823,0.01566,0.83777)
);const mat3 ACESOutputMat=mat3(
vec3( 1.60475,-0.10208,-0.00327),
vec3(-0.53108, 1.10813,-0.07276),
vec3(-0.07367,-0.00605, 1.07602)
);vec3 RRTAndODTFit(vec3 v)
{vec3 a=v*(v+0.0245786)-0.000090537;vec3 b=v*(0.983729*v+0.4329510)+0.238081;return a/b;}
vec3 ACESFitted(vec3 color)
{color=ACESInputMat*color;color=RRTAndODTFit(color);color=ACESOutputMat*color;color=saturate(color);return color;}
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_DEFINITIONS
vec4 applyImageProcessing(vec4 result) {
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATSTART
#ifdef EXPOSURE
result.rgb*=exposureLinear;
#endif
#ifdef VIGNETTE
vec2 viewportXY=gl_FragCoord.xy*vInverseScreenSize;viewportXY=viewportXY*2.0-1.0;vec3 vignetteXY1=vec3(viewportXY*vignetteSettings1.xy+vignetteSettings1.zw,1.0);float vignetteTerm=dot(vignetteXY1,vignetteXY1);float vignette=pow(vignetteTerm,vignetteSettings2.w);vec3 vignetteColor=vignetteSettings2.rgb;
#ifdef VIGNETTEBLENDMODEMULTIPLY
vec3 vignetteColorMultiplier=mix(vignetteColor,vec3(1,1,1),vignette);result.rgb*=vignetteColorMultiplier;
#endif
#ifdef VIGNETTEBLENDMODEOPAQUE
result.rgb=mix(vignetteColor,result.rgb,vignette);
#endif
#endif
#if TONEMAPPING==3
result.rgb=PBRNeutralToneMapping(result.rgb);
#elif TONEMAPPING==2
result.rgb=ACESFitted(result.rgb);
#elif TONEMAPPING==1
const float tonemappingCalibration=1.590579;result.rgb=1.0-exp2(-tonemappingCalibration*result.rgb);
#endif
result.rgb=toGammaSpace(result.rgb);result.rgb=saturate(result.rgb);
#ifdef CONTRAST
vec3 resultHighContrast=result.rgb*result.rgb*(3.0-2.0*result.rgb);if (contrast<1.0) {result.rgb=mix(vec3(0.5,0.5,0.5),result.rgb,contrast);} else {result.rgb=mix(result.rgb,resultHighContrast,contrast-1.0);}
#endif
#ifdef COLORGRADING
vec3 colorTransformInput=result.rgb*colorTransformSettings.xxx+colorTransformSettings.yyy;
#ifdef COLORGRADING3D
vec3 colorTransformOutput=texture(txColorTransform,colorTransformInput).rgb;
#else
vec3 colorTransformOutput=sampleTexture3D(txColorTransform,colorTransformInput,colorTransformSettings.yz).rgb;
#endif
result.rgb=mix(result.rgb,colorTransformOutput,colorTransformSettings.www);
#endif
#ifdef COLORCURVES
float luma=getLuminance(result.rgb);vec2 curveMix=clamp(vec2(luma*3.0-1.5,luma*-3.0+1.5),vec2(0.0),vec2(1.0));vec4 colorCurve=vCameraColorCurveNeutral+curveMix.x*vCameraColorCurvePositive-curveMix.y*vCameraColorCurveNegative;result.rgb*=colorCurve.rgb;result.rgb=mix(vec3(luma),result.rgb,colorCurve.a);
#endif
#ifdef DITHER
float rand=getRand(gl_FragCoord.xy*vInverseScreenSize);float dither=mix(-ditherIntensity,ditherIntensity,rand);result.rgb=saturate(result.rgb+vec3(dither));
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATEND
return result;}`;C.IncludesShadersStore[Jd]||(C.IncludesShadersStore[Jd]=PM);const e_="bumpFragmentMainFunctions",OM=`#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#ifdef OBJECTSPACE_NORMALMAP
uniform mat4 normalMatrix;
#if defined(WEBGL2) || defined(WEBGPU)
mat4 toNormalMatrix(mat4 wMatrix)
{mat4 ret=inverse(wMatrix);ret=transpose(ret);ret[0][3]=0.;ret[1][3]=0.;ret[2][3]=0.;ret[3]=vec4(0.,0.,0.,1.);return ret;}
#else
mat4 toNormalMatrix(mat4 m)
{float
a00=m[0][0],a01=m[0][1],a02=m[0][2],a03=m[0][3],
a10=m[1][0],a11=m[1][1],a12=m[1][2],a13=m[1][3],
a20=m[2][0],a21=m[2][1],a22=m[2][2],a23=m[2][3],
a30=m[3][0],a31=m[3][1],a32=m[3][2],a33=m[3][3],
b00=a00*a11-a01*a10,
b01=a00*a12-a02*a10,
b02=a00*a13-a03*a10,
b03=a01*a12-a02*a11,
b04=a01*a13-a03*a11,
b05=a02*a13-a03*a12,
b06=a20*a31-a21*a30,
b07=a20*a32-a22*a30,
b08=a20*a33-a23*a30,
b09=a21*a32-a22*a31,
b10=a21*a33-a23*a31,
b11=a22*a33-a23*a32,
det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;mat4 mi=mat4(
a11*b11-a12*b10+a13*b09,
a02*b10-a01*b11-a03*b09,
a31*b05-a32*b04+a33*b03,
a22*b04-a21*b05-a23*b03,
a12*b08-a10*b11-a13*b07,
a00*b11-a02*b08+a03*b07,
a32*b02-a30*b05-a33*b01,
a20*b05-a22*b02+a23*b01,
a10*b10-a11*b08+a13*b06,
a01*b08-a00*b10-a03*b06,
a30*b04-a31*b02+a33*b00,
a21*b02-a20*b04-a23*b00,
a11*b07-a10*b09-a12*b06,
a00*b09-a01*b07+a02*b06,
a31*b01-a30*b03-a32*b00,
a20*b03-a21*b01+a22*b00)/det;return mat4(mi[0][0],mi[1][0],mi[2][0],mi[3][0],
mi[0][1],mi[1][1],mi[2][1],mi[3][1],
mi[0][2],mi[1][2],mi[2][2],mi[3][2],
mi[0][3],mi[1][3],mi[2][3],mi[3][3]);}
#endif
#endif
vec3 perturbNormalBase(mat3 cotangentFrame,vec3 normal,float scale)
{
#ifdef NORMALXYSCALE
normal=normalize(normal*vec3(scale,scale,1.0));
#endif
return normalize(cotangentFrame*normal);}
vec3 perturbNormal(mat3 cotangentFrame,vec3 textureSample,float scale)
{return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);}
mat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv,vec2 tangentSpaceParams)
{vec3 dp1=dFdx(p);vec3 dp2=dFdy(p);vec2 duv1=dFdx(uv);vec2 duv2=dFdy(uv);vec3 dp2perp=cross(dp2,normal);vec3 dp1perp=cross(normal,dp1);vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;vec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;tangent*=tangentSpaceParams.x;bitangent*=tangentSpaceParams.y;float det=max(dot(tangent,tangent),dot(bitangent,bitangent));float invmax=det==0.0 ? 0.0 : inversesqrt(det);return mat3(tangent*invmax,bitangent*invmax,normal);}
#endif
`;C.IncludesShadersStore[e_]||(C.IncludesShadersStore[e_]=OM);const t_="bumpFragmentFunctions",DM=`#if defined(BUMP)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)
#endif
#if defined(DETAIL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)
#endif
#if defined(BUMP) && defined(PARALLAX)
const float minSamples=4.;const float maxSamples=15.;const int iMaxSamples=15;vec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {float parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;parallaxLimit*=parallaxScale;vec2 vOffsetDir=normalize(vViewDirCoT.xy);vec2 vMaxOffset=vOffsetDir*parallaxLimit;float numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));float stepSize=1.0/numSamples;float currRayHeight=1.0;vec2 vCurrOffset=vec2(0,0);vec2 vLastOffset=vec2(0,0);float lastSampledHeight=1.0;float currSampledHeight=1.0;bool keepWorking=true;for (int i=0; i<iMaxSamples; i++)
{currSampledHeight=texture2D(bumpSampler,texCoord+vCurrOffset).w;if (!keepWorking)
{}
else if (currSampledHeight>currRayHeight)
{float delta1=currSampledHeight-currRayHeight;float delta2=(currRayHeight+stepSize)-lastSampledHeight;float ratio=delta1/(delta1+delta2);vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;keepWorking=false;}
else
{currRayHeight-=stepSize;vLastOffset=vCurrOffset;
#ifdef PARALLAX_RHS
vCurrOffset-=stepSize*vMaxOffset;
#else
vCurrOffset+=stepSize*vMaxOffset;
#endif
lastSampledHeight=currSampledHeight;}}
return vCurrOffset;}
vec2 parallaxOffset(vec3 viewDir,float heightScale)
{float height=texture2D(bumpSampler,vBumpUV).w;vec2 texCoordOffset=heightScale*viewDir.xy*height;
#ifdef PARALLAX_RHS
return texCoordOffset;
#else
return -texCoordOffset;
#endif
}
#endif
`;C.IncludesShadersStore[t_]||(C.IncludesShadersStore[t_]=DM);const i_="clipPlaneFragmentDeclaration",LM=`#ifdef CLIPPLANE
varying float fClipDistance;
#endif
#ifdef CLIPPLANE2
varying float fClipDistance2;
#endif
#ifdef CLIPPLANE3
varying float fClipDistance3;
#endif
#ifdef CLIPPLANE4
varying float fClipDistance4;
#endif
#ifdef CLIPPLANE5
varying float fClipDistance5;
#endif
#ifdef CLIPPLANE6
varying float fClipDistance6;
#endif
`;C.IncludesShadersStore[i_]||(C.IncludesShadersStore[i_]=LM);const r_="fogFragmentDeclaration",NM=`#ifdef FOG
#define FOGMODE_NONE 0.
#define FOGMODE_EXP 1.
#define FOGMODE_EXP2 2.
#define FOGMODE_LINEAR 3.
#define E 2.71828
uniform vec4 vFogInfos;uniform vec3 vFogColor;varying vec3 vFogDistance;float CalcFogFactor()
{float fogCoeff=1.0;float fogStart=vFogInfos.y;float fogEnd=vFogInfos.z;float fogDensity=vFogInfos.w;float fogDistance=length(vFogDistance);if (FOGMODE_LINEAR==vFogInfos.x)
{fogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);}
else if (FOGMODE_EXP==vFogInfos.x)
{fogCoeff=1.0/pow(E,fogDistance*fogDensity);}
else if (FOGMODE_EXP2==vFogInfos.x)
{fogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);}
return clamp(fogCoeff,0.0,1.0);}
#endif
`;C.IncludesShadersStore[r_]||(C.IncludesShadersStore[r_]=NM);const s_="clipPlaneFragment",FM=`#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
if (false) {}
#endif
#ifdef CLIPPLANE
else if (fClipDistance>0.0)
{discard;}
#endif
#ifdef CLIPPLANE2
else if (fClipDistance2>0.0)
{discard;}
#endif
#ifdef CLIPPLANE3
else if (fClipDistance3>0.0)
{discard;}
#endif
#ifdef CLIPPLANE4
else if (fClipDistance4>0.0)
{discard;}
#endif
#ifdef CLIPPLANE5
else if (fClipDistance5>0.0)
{discard;}
#endif
#ifdef CLIPPLANE6
else if (fClipDistance6>0.0)
{discard;}
#endif
`;C.IncludesShadersStore[s_]||(C.IncludesShadersStore[s_]=FM);const n_="bumpFragment",wM=`vec2 uvOffset=vec2(0.0,0.0);
#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)
#ifdef NORMALXYSCALE
float normalScale=1.0;
#elif defined(BUMP)
float normalScale=vBumpInfos.y;
#else
float normalScale=1.0;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#elif defined(BUMP)
vec2 TBNUV=gl_FrontFacing ? vBumpUV : -vBumpUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vTangentSpaceParams);
#else
vec2 TBNUV=gl_FrontFacing ? vDetailUV : -vDetailUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vec2(1.,1.));
#endif
#elif defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#else
vec2 TBNUV=gl_FrontFacing ? vMainUV1 : -vMainUV1;mat3 TBN=cotangent_frame(normalW,vPositionW,TBNUV,vec2(1.,1.));
#endif
#endif
#ifdef PARALLAX
mat3 invTBN=transposeMat3(TBN);
#ifdef PARALLAXOCCLUSION
uvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);
#else
uvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);
#endif
#endif
#ifdef DETAIL
vec4 detailColor=texture2D(detailSampler,vDetailUV+uvOffset);vec2 detailNormalRG=detailColor.wy*2.0-1.0;float detailNormalB=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));vec3 detailNormal=vec3(detailNormalRG,detailNormalB);
#endif
#ifdef BUMP
#ifdef OBJECTSPACE_NORMALMAP
#define CUSTOM_FRAGMENT_BUMP_FRAGMENT
normalW=normalize(texture2D(bumpSampler,vBumpUV).xyz *2.0-1.0);normalW=normalize(mat3(normalMatrix)*normalW);
#elif !defined(DETAIL)
normalW=perturbNormal(TBN,texture2D(bumpSampler,vBumpUV+uvOffset).xyz,vBumpInfos.y);
#else
vec3 bumpNormal=texture2D(bumpSampler,vBumpUV+uvOffset).xyz*2.0-1.0;
#if DETAIL_NORMALBLENDMETHOD==0 
detailNormal.xy*=vDetailInfos.z;vec3 blendedNormal=normalize(vec3(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));
#elif DETAIL_NORMALBLENDMETHOD==1 
detailNormal.xy*=vDetailInfos.z;bumpNormal+=vec3(0.0,0.0,1.0);detailNormal*=vec3(-1.0,-1.0,1.0);vec3 blendedNormal=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;
#endif
normalW=perturbNormalBase(TBN,blendedNormal,vBumpInfos.y);
#endif
#elif defined(DETAIL)
detailNormal.xy*=vDetailInfos.z;normalW=perturbNormalBase(TBN,detailNormal,vDetailInfos.z);
#endif
`;C.IncludesShadersStore[n_]||(C.IncludesShadersStore[n_]=wM);const a_="decalFragment",BM=`#ifdef DECAL
#ifdef GAMMADECAL
decalColor.rgb=toLinearSpace(decalColor.rgb);
#endif
#ifdef DECAL_SMOOTHALPHA
decalColor.a*=decalColor.a;
#endif
surfaceAlbedo.rgb=mix(surfaceAlbedo.rgb,decalColor.rgb,decalColor.a);
#endif
`;C.IncludesShadersStore[a_]||(C.IncludesShadersStore[a_]=BM);const o_="depthPrePass",UM=`#ifdef DEPTHPREPASS
gl_FragColor=vec4(0.,0.,0.,1.0);return;
#endif
`;C.IncludesShadersStore[o_]||(C.IncludesShadersStore[o_]=UM);const l_="lightFragment",VM=`#ifdef LIGHT{X}
#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})
#else
vec4 diffuse{X}=light{X}.vLightDiffuse;
#define CUSTOM_LIGHT{X}_COLOR 
#ifdef PBR
#ifdef SPOTLIGHT{X}
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,vPositionW);
#elif defined(POINTLIGHT{X})
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,vPositionW);
#elif defined(HEMILIGHT{X})
preInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(DIRLIGHT{X})
preInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(AREALIGHT{X}) && defined(AREALIGHTSUPPORTED)
preInfo=computeAreaPreLightingInfo(areaLightsLTC1Sampler,areaLightsLTC2Sampler,viewDirectionW,normalW,vPositionW,light{X}.vLightData,light{X}.vLightWidth.xyz,light{X}.vLightHeight.xyz,roughness);
#endif
preInfo.NdotV=NdotV;
#ifdef SPOTLIGHT{X}
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
#ifdef IESLIGHTTEXTURE{X}
preInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X});
#else
preInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
#ifdef IESLIGHTTEXTURE{X}
preInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X});
#else
preInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);
#endif
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
#ifdef IESLIGHTTEXTURE{X}
preInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X});
#else
preInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);
#endif
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#ifdef IESLIGHTTEXTURE{X}
preInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X});
#else
preInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif 
#endif
#elif defined(POINTLIGHT{X})
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#endif
#else
preInfo.attenuation=1.0;
#endif
#if defined(HEMILIGHT{X}) || defined(AREALIGHT{X})
preInfo.roughness=roughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#ifdef IRIDESCENCE
preInfo.iridescenceIntensity=iridescenceIntensity;
#endif
#ifdef HEMILIGHT{X}
info.diffuse=computeHemisphericDiffuseLighting(preInfo,diffuse{X}.rgb,light{X}.vLightGround);
#elif defined(AREALIGHT{X})
info.diffuse=computeAreaDiffuseLighting(preInfo,diffuse{X}.rgb);
#elif defined(SS_TRANSLUCENCY)
info.diffuse=computeDiffuseAndTransmittedLighting(preInfo,diffuse{X}.rgb,subSurfaceOut.transmittance,subSurfaceOut.translucencyIntensity,surfaceAlbedo.rgb);
#else
info.diffuse=computeDiffuseLighting(preInfo,diffuse{X}.rgb);
#endif
#ifdef SPECULARTERM
#if AREALIGHT{X}
info.specular=computeAreaSpecularLighting(preInfo,light{X}.vLightSpecular.rgb);
#else
#ifdef ANISOTROPIC
info.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);
#else
info.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);
#endif
#endif
#endif
#ifndef AREALIGHT{X}
#ifdef SHEEN
#ifdef SHEEN_LINKWITHALBEDO
preInfo.roughness=sheenOut.sheenIntensity;
#else
#ifdef HEMILIGHT{X}
preInfo.roughness=sheenOut.sheenRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#endif
info.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);
#endif
#ifdef CLEARCOAT
#ifdef HEMILIGHT{X}
preInfo.roughness=clearcoatOut.clearCoatRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
info.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,diffuse{X}.rgb);
#ifdef CLEARCOAT_TINT
absorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);info.diffuse*=absorption;
#ifdef SPECULARTERM
info.specular*=absorption;
#endif
#endif
info.diffuse*=info.clearCoat.w;
#ifdef SPECULARTERM
info.specular*=info.clearCoat.w;
#endif
#ifdef SHEEN
info.sheen*=info.clearCoat.w;
#endif
#endif
#endif
#else
#ifdef SPOTLIGHT{X}
#ifdef IESLIGHTTEXTURE{X}
info=computeIESSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness,iesLightTexture{X});
#else
info=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness);
#endif
#elif defined(HEMILIGHT{X})
info=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);
#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})
info=computeLighting(viewDirectionW,normalW,light{X}.vLightData,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness);
#elif defined(AREALIGHT{X}) && defined(AREALIGHTSUPPORTED)
info=computeAreaLighting(areaLightsLTC1Sampler,areaLightsLTC2Sampler,viewDirectionW,normalW,vPositionW,light{X}.vLightData.xyz,light{X}.vLightWidth.rgb,light{X}.vLightHeight.rgb,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,
#ifdef AREALIGHTNOROUGHTNESS
0.5
#else
vReflectionInfos.y
#endif
);
#endif
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
info.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightTexture{X},textureProjectionMatrix{X},vPositionW);
#endif
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) 
{
#ifdef SHADOWCSM_RIGHTHANDED{X}
diff{X}=viewFrustumZ{X}[i]+vPositionFromCamera{X}.z;
#else
diff{X}=viewFrustumZ{X}[i]-vPositionFromCamera{X}.z;
#endif
if (diff{X}>=0.) {index{X}=i;break;}}
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
if (index{X}>=0)
#endif
{
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#else
shadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#endif
#else
shadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=vec3(shadow)*vCascadeColorsMultiplier{X}[index{X}];
#endif
#ifndef SHADOWCSMNOBLEND{X}
float frustumLength=frustumLengths{X}[index{X}];float diffRatio=clamp(diff{X}/frustumLength,0.,1.)*cascadeBlendFactor{X};if (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)
{index{X}+=1;float nextShadow=0.;
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
nextShadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#else
nextShadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#endif
#else
nextShadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
shadow=mix(nextShadow,shadow,diffRatio);
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);
#endif
}
#endif
}
#elif defined(SHADOWCLOSEESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithCloseESMCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithCloseESM(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithESMCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithESM(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPOISSON{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithPoissonSamplingCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadowWithPoissonSampling(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCF1(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCF3(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCF5(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCSS16(vPositionFromLight{X},vDepthMetric{X},depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCSS32(vPositionFromLight{X},vDepthMetric{X},depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCSS64(vPositionFromLight{X},vDepthMetric{X},depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#else
#if defined(SHADOWCUBE{X})
shadow=computeShadowCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadow(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#endif
#ifdef SHADOWONLY
#ifndef SHADOWINUSE
#define SHADOWINUSE
#endif
globalShadow+=shadow;shadowLightCount+=1.0;
#endif
#else
shadow=1.;
#endif
aggShadow+=shadow;numLights+=1.0;
#ifndef SHADOWONLY
#ifdef CUSTOMUSERLIGHTING
diffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);
#ifdef SPECULARTERM
specularBase+=computeCustomSpecularLighting(info,specularBase,shadow);
#endif
#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})
diffuseBase+=lightmapColor.rgb*shadow;
#ifdef SPECULARTERM
#ifndef LIGHTMAPNOSPECULAR{X}
specularBase+=info.specular*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef CLEARCOAT
#ifndef LIGHTMAPNOSPECULAR{X}
clearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef SHEEN
#ifndef LIGHTMAPNOSPECULAR{X}
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#else
#ifdef SHADOWCSMDEBUG{X}
diffuseBase+=info.diffuse*shadowDebug{X};
#else 
diffuseBase+=info.diffuse*shadow;
#endif
#ifdef SPECULARTERM
specularBase+=info.specular*shadow;
#endif
#ifdef CLEARCOAT
clearCoatBase+=info.clearCoat.rgb*shadow;
#endif
#ifdef SHEEN
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#endif
#endif
`;C.IncludesShadersStore[l_]||(C.IncludesShadersStore[l_]=VM);const c_="logDepthFragment",GM=`#ifdef LOGARITHMICDEPTH
gl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;
#endif
`;C.IncludesShadersStore[c_]||(C.IncludesShadersStore[c_]=GM);const h_="fogFragment",kM=`#ifdef FOG
float fog=CalcFogFactor();
#ifdef PBR
fog=toLinearSpace(fog);
#endif
color.rgb=mix(vFogColor,color.rgb,fog);
#endif
`;C.IncludesShadersStore[h_]||(C.IncludesShadersStore[h_]=kM);const f_="oitFragment",WM=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
float fragDepth=gl_FragCoord.z; 
#ifdef ORDER_INDEPENDENT_TRANSPARENCY_16BITS
uint halfFloat=packHalf2x16(vec2(fragDepth));vec2 full=unpackHalf2x16(halfFloat);fragDepth=full.x;
#endif
ivec2 fragCoord=ivec2(gl_FragCoord.xy);vec2 lastDepth=texelFetch(oitDepthSampler,fragCoord,0).rg;vec4 lastFrontColor=texelFetch(oitFrontColorSampler,fragCoord,0);depth.rg=vec2(-MAX_DEPTH);frontColor=lastFrontColor;backColor=vec4(0.0);
#ifdef USE_REVERSE_DEPTHBUFFER
float furthestDepth=-lastDepth.x;float nearestDepth=lastDepth.y;
#else
float nearestDepth=-lastDepth.x;float furthestDepth=lastDepth.y;
#endif
float alphaMultiplier=1.0-lastFrontColor.a;
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth>nearestDepth || fragDepth<furthestDepth) {
#else
if (fragDepth<nearestDepth || fragDepth>furthestDepth) {
#endif
return;}
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth<nearestDepth && fragDepth>furthestDepth) {
#else
if (fragDepth>nearestDepth && fragDepth<furthestDepth) {
#endif
depth.rg=vec2(-fragDepth,fragDepth);return;}
#endif
`;C.IncludesShadersStore[f_]||(C.IncludesShadersStore[f_]=WM);const Ll="defaultPixelShader",OE=`#define CUSTOM_FRAGMENT_EXTENSION
#include<__decl__defaultFragment>
#if defined(BUMP) || !defined(NORMAL)
#extension GL_OES_standard_derivatives : enable
#endif
#include<prePassDeclaration>[SCENE_MRT_COUNT]
#include<oitDeclaration>
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#include<helperFunctions>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<samplerFragmentDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_SAMPLERNAME_,diffuse)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef REFRACTION
#ifdef REFRACTIONMAP_3D
uniform samplerCube refractionCubeSampler;
#else
uniform sampler2D refraction2DSampler;
#endif
#endif
#if defined(SPECULARTERM)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_SAMPLERNAME_,specular)
#endif
#include<fresnelFunction>
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
uniform samplerCube reflectionCubeSampler;
#else
uniform sampler2D reflection2DSampler;
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#include<reflectionFunction>
#endif
#include<imageProcessingDeclaration>
#include<imageProcessingFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);vec4 baseColor=vec4(1.,1.,1.,1.);vec3 diffuseColor=vDiffuseColor.rgb;float alpha=vDiffuseColor.a;
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=normalize(-cross(dFdx(vPositionW),dFdy(vPositionW)));
#endif
#include<bumpFragment>
#ifdef TWOSIDEDLIGHTING
normalW=gl_FrontFacing ? normalW : -normalW;
#endif
#ifdef DIFFUSE
baseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);
#if defined(ALPHATEST) && !defined(ALPHATEST_AFTERALLALPHACOMPUTATIONS)
if (baseColor.a<alphaCutOff)
discard;
#endif
#ifdef ALPHAFROMDIFFUSE
alpha*=baseColor.a;
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
baseColor.rgb*=vDiffuseInfos.y;
#endif
#if defined(DECAL) && !defined(DECAL_AFTER_DETAIL)
vec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);
#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)
#endif
#include<depthPrePass>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
baseColor.rgb*=vColor.rgb;
#endif
#ifdef DETAIL
baseColor.rgb=baseColor.rgb*2.0*mix(0.5,detailColor.r,vDetailInfos.y);
#endif
#if defined(DECAL) && defined(DECAL_AFTER_DETAIL)
vec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);
#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)
#endif
#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE
vec3 baseAmbientColor=vec3(1.,1.,1.);
#ifdef AMBIENT
baseAmbientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;
#endif
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
float glossiness=vSpecularColor.a;vec3 specularColor=vSpecularColor.rgb;
#ifdef SPECULARTERM
#ifdef SPECULAR
vec4 specularMapColor=texture2D(specularSampler,vSpecularUV+uvOffset);specularColor=specularMapColor.rgb;
#ifdef GLOSSINESS
glossiness=glossiness*specularMapColor.a;
#endif
#endif
#endif
vec3 diffuseBase=vec3(0.,0.,0.);lightingInfo info;
#ifdef SPECULARTERM
vec3 specularBase=vec3(0.,0.,0.);
#endif
float shadow=1.;float aggShadow=0.;float numLights=0.;
#ifdef LIGHTMAP
vec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor.rgb=fromRGBD(lightmapColor);
#endif
lightmapColor.rgb*=vLightmapInfos.y;
#endif
#include<lightFragment>[0..maxSimultaneousLights]
aggShadow=aggShadow/numLights;vec4 refractionColor=vec4(0.,0.,0.,1.);
#ifdef REFRACTION
vec3 refractionVector=normalize(refract(-viewDirectionW,normalW,vRefractionInfos.y));
#ifdef REFRACTIONMAP_3D
#ifdef USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,vRefractionSize,vRefractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;vec4 refractionLookup=textureCube(refractionCubeSampler,refractionVector);if (dot(refractionVector,viewDirectionW)<1.0) {refractionColor=refractionLookup;}
#else
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;refractionColor=texture2D(refraction2DSampler,refractionCoords);
#endif
#ifdef RGBDREFRACTION
refractionColor.rgb=fromRGBD(refractionColor);
#endif
#ifdef IS_REFRACTION_LINEAR
refractionColor.rgb=toGammaSpace(refractionColor.rgb);
#endif
refractionColor.rgb*=vRefractionInfos.x;
#endif
vec4 reflectionColor=vec4(0.,0.,0.,1.);
#ifdef REFLECTION
vec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
vReflectionUVW.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
#ifdef ROUGHNESS
float bias=vReflectionInfos.y;
#ifdef SPECULARTERM
#ifdef SPECULAR
#ifdef GLOSSINESS
bias*=(1.0-specularMapColor.a);
#endif
#endif
#endif
reflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW,bias);
#else
reflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW);
#endif
#else
vec2 coords=vReflectionUVW.xy;
#ifdef REFLECTIONMAP_PROJECTION
coords/=vReflectionUVW.z;
#endif
coords.y=1.0-coords.y;reflectionColor=texture2D(reflection2DSampler,coords);
#endif
#ifdef RGBDREFLECTION
reflectionColor.rgb=fromRGBD(reflectionColor);
#endif
#ifdef IS_REFLECTION_LINEAR
reflectionColor.rgb=toGammaSpace(reflectionColor.rgb);
#endif
reflectionColor.rgb*=vReflectionInfos.x;
#ifdef REFLECTIONFRESNEL
float reflectionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,reflectionRightColor.a,reflectionLeftColor.a);
#ifdef REFLECTIONFRESNELFROMSPECULAR
#ifdef SPECULARTERM
reflectionColor.rgb*=specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#else
reflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#endif
#else
reflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#endif
#endif
#endif
#ifdef REFRACTIONFRESNEL
float refractionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,refractionRightColor.a,refractionLeftColor.a);refractionColor.rgb*=refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*refractionRightColor.rgb;
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);
#ifdef OPACITYRGB
opacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);alpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;
#else
alpha*=opacityMap.a*vOpacityInfos.y;
#endif
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=vColor.a;
#endif
#ifdef OPACITYFRESNEL
float opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);alpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;
#endif
#ifdef ALPHATEST
#ifdef ALPHATEST_AFTERALLALPHACOMPUTATIONS
if (alpha<alphaCutOff)
discard;
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
vec3 emissiveColor=vEmissiveColor;
#ifdef EMISSIVE
emissiveColor+=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb*vEmissiveInfos.y;
#endif
#ifdef EMISSIVEFRESNEL
float emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);emissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;
#endif
#ifdef DIFFUSEFRESNEL
float diffuseFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,diffuseRightColor.a,diffuseLeftColor.a);diffuseBase*=diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*diffuseRightColor.rgb;
#endif
#ifdef EMISSIVEASILLUMINATION
vec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#else
#ifdef LINKEMISSIVEWITHDIFFUSE
vec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#else
vec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#endif
#endif
#ifdef SPECULARTERM
vec3 finalSpecular=specularBase*specularColor;
#ifdef SPECULAROVERALPHA
alpha=clamp(alpha+dot(finalSpecular,vec3(0.3,0.59,0.11)),0.,1.);
#endif
#else
vec3 finalSpecular=vec3(0.0);
#endif
#ifdef REFLECTIONOVERALPHA
alpha=clamp(alpha+dot(reflectionColor.rgb,vec3(0.3,0.59,0.11)),0.,1.);
#endif
#ifdef EMISSIVEASILLUMINATION
vec4 color=vec4(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+emissiveColor+refractionColor.rgb,0.0,1.0),alpha);
#else
vec4 color=vec4(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+refractionColor.rgb,alpha);
#endif
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
color.rgb*=lightmapColor.rgb;
#else
color.rgb+=lightmapColor.rgb;
#endif
#endif
#endif
#define CUSTOM_FRAGMENT_BEFORE_FOG
color.rgb=max(color.rgb,0.);
#include<logDepthFragment>
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
color.rgb=toLinearSpace(color.rgb);
#else
#ifdef IMAGEPROCESSING
color.rgb=toLinearSpace(color.rgb);color=applyImageProcessing(color);
#endif
#endif
color.a*=visibility;
#ifdef PREMULTIPLYALPHA
color.rgb*=color.a;
#endif
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
float writeGeometryInfo=color.a>0.4 ? 1.0 : 0.0;
#ifdef PREPASS_COLOR
gl_FragData[PREPASS_COLOR_INDEX]=color; 
#endif
#ifdef PREPASS_POSITION
gl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_LOCAL_POSITION
gl_FragData[PREPASS_LOCAL_POSITION_INDEX]=vec4(vPosition,writeGeometryInfo);
#endif
#if defined(PREPASS_VELOCITY)
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#elif defined(PREPASS_VELOCITY_LINEAR)
vec2 velocity=vec2(0.5)*((vPreviousPosition.xy/vPreviousPosition.w)-(vCurrentPosition.xy/vCurrentPosition.w));gl_FragData[PREPASS_VELOCITY_LINEAR_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_IRRADIANCE
gl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_DEPTH
gl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_SCREENSPACE_DEPTH
gl_FragData[PREPASS_SCREENSPACE_DEPTH_INDEX]=vec4(gl_FragCoord.z,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMAL
#ifdef PREPASS_NORMAL_WORLDSPACE
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalW,writeGeometryInfo);
#else
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo);
#endif
#endif
#ifdef PREPASS_WORLD_NORMAL
gl_FragData[PREPASS_WORLD_NORMAL_INDEX]=vec4(normalW*0.5+0.5,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO
gl_FragData[PREPASS_ALBEDO_INDEX]=vec4(baseColor.rgb,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
gl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(sqrt(baseColor.rgb),writeGeometryInfo);
#endif
#ifdef PREPASS_REFLECTIVITY
#if defined(SPECULAR)
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularMapColor))*writeGeometryInfo; 
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularColor),1.0)*writeGeometryInfo;
#endif
#endif
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=color;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {frontColor.rgb+=color.rgb*color.a*alphaMultiplier;frontColor.a=1.0-alphaMultiplier*(1.0-color.a);} else {backColor+=color;}
#endif
#define CUSTOM_FRAGMENT_MAIN_END
}
`;C.ShadersStore[Ll]||(C.ShadersStore[Ll]=OE);const XM={name:Ll,shader:OE},HM=Object.freeze(Object.defineProperty({__proto__:null,defaultPixelShader:XM},Symbol.toStringTag,{value:"Module"})),Nl="postprocessVertexShader",DE=`attribute position: vec2<f32>;uniform scale: vec2<f32>;varying vUV: vec2<f32>;const madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
vertexOutputs.vUV=(vertexInputs.position*madd+madd)*uniforms.scale;vertexOutputs.position=vec4(vertexInputs.position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}
`;C.ShadersStoreWGSL[Nl]||(C.ShadersStoreWGSL[Nl]=DE);const zM={name:Nl,shader:DE},LE=Object.freeze(Object.defineProperty({__proto__:null,postprocessVertexShaderWGSL:zM},Symbol.toStringTag,{value:"Module"})),Fl="passPixelShader",NE=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);}`;C.ShadersStoreWGSL[Fl]||(C.ShadersStoreWGSL[Fl]=NE);const YM={name:Fl,shader:NE},KM=Object.freeze(Object.defineProperty({__proto__:null,passPixelShaderWGSL:YM},Symbol.toStringTag,{value:"Module"})),wl="passPixelShader",FE=`varying vec2 vUV;uniform sampler2D textureSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{gl_FragColor=texture2D(textureSampler,vUV);}`;C.ShadersStore[wl]||(C.ShadersStore[wl]=FE);const qM={name:wl,shader:FE},wE=Object.freeze(Object.defineProperty({__proto__:null,passPixelShader:qM},Symbol.toStringTag,{value:"Module"})),Bl="passCubePixelShader",BE=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_cube<f32>;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var uv: vec2f=input.vUV*2.0-1.0;
#ifdef POSITIVEX
fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(1.001,uv.y,uv.x));
#endif
#ifdef NEGATIVEX
fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(-1.001,uv.y,uv.x));
#endif
#ifdef POSITIVEY
fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv.y,1.001,uv.x));
#endif
#ifdef NEGATIVEY
fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv.y,-1.001,uv.x));
#endif
#ifdef POSITIVEZ
fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv,1.001));
#endif
#ifdef NEGATIVEZ
fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv,-1.001));
#endif
}`;C.ShadersStoreWGSL[Bl]||(C.ShadersStoreWGSL[Bl]=BE);const jM={name:Bl,shader:BE},ZM=Object.freeze(Object.defineProperty({__proto__:null,passCubePixelShaderWGSL:jM},Symbol.toStringTag,{value:"Module"})),Ul="passCubePixelShader",UE=`varying vec2 vUV;uniform samplerCube textureSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{vec2 uv=vUV*2.0-1.0;
#ifdef POSITIVEX
gl_FragColor=textureCube(textureSampler,vec3(1.001,uv.y,uv.x));
#endif
#ifdef NEGATIVEX
gl_FragColor=textureCube(textureSampler,vec3(-1.001,uv.y,uv.x));
#endif
#ifdef POSITIVEY
gl_FragColor=textureCube(textureSampler,vec3(uv.y,1.001,uv.x));
#endif
#ifdef NEGATIVEY
gl_FragColor=textureCube(textureSampler,vec3(uv.y,-1.001,uv.x));
#endif
#ifdef POSITIVEZ
gl_FragColor=textureCube(textureSampler,vec3(uv,1.001));
#endif
#ifdef NEGATIVEZ
gl_FragColor=textureCube(textureSampler,vec3(uv,-1.001));
#endif
}`;C.ShadersStore[Ul]||(C.ShadersStore[Ul]=UE);const QM={name:Ul,shader:UE},$M=Object.freeze(Object.defineProperty({__proto__:null,passCubePixelShader:QM},Symbol.toStringTag,{value:"Module"})),Vl="rgbdDecodePixelShader",VE=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=vec4f(fromRGBD(textureSample(textureSampler,textureSamplerSampler,input.vUV)),1.0);}`;C.ShadersStoreWGSL[Vl]||(C.ShadersStoreWGSL[Vl]=VE);const JM={name:Vl,shader:VE},GE=Object.freeze(Object.defineProperty({__proto__:null,rgbdDecodePixelShaderWGSL:JM},Symbol.toStringTag,{value:"Module"})),Gl="rgbdDecodePixelShader",kE=`varying vec2 vUV;uniform sampler2D textureSampler;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{gl_FragColor=vec4(fromRGBD(texture2D(textureSampler,vUV)),1.0);}`;C.ShadersStore[Gl]||(C.ShadersStore[Gl]=kE);const eP={name:Gl,shader:kE},WE=Object.freeze(Object.defineProperty({__proto__:null,rgbdDecodePixelShader:eP},Symbol.toStringTag,{value:"Module"})),kl="rgbdEncodePixelShader",XE=`varying vec2 vUV;uniform sampler2D textureSampler;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{gl_FragColor=toRGBD(texture2D(textureSampler,vUV).rgb);}`;C.ShadersStore[kl]||(C.ShadersStore[kl]=XE);const tP={name:kl,shader:XE},iP=Object.freeze(Object.defineProperty({__proto__:null,rgbdEncodePixelShader:tP},Symbol.toStringTag,{value:"Module"})),Wl="rgbdEncodePixelShader",HE=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=toRGBD(textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb);}`;C.ShadersStoreWGSL[Wl]||(C.ShadersStoreWGSL[Wl]=HE);const rP={name:Wl,shader:HE},sP=Object.freeze(Object.defineProperty({__proto__:null,rgbdEncodePixelShaderWGSL:rP},Symbol.toStringTag,{value:"Module"})),u_="pbrUboDeclaration",nP=`uniform vAlbedoInfos: vec2f;uniform vBaseWeightInfos: vec2f;uniform vAmbientInfos: vec4f;uniform vOpacityInfos: vec2f;uniform vEmissiveInfos: vec2f;uniform vLightmapInfos: vec2f;uniform vReflectivityInfos: vec3f;uniform vMicroSurfaceSamplerInfos: vec2f;uniform vReflectionInfos: vec2f;uniform vReflectionFilteringInfo: vec2f;uniform vReflectionPosition: vec3f;uniform vReflectionSize: vec3f;uniform vBumpInfos: vec3f;uniform albedoMatrix: mat4x4f;uniform baseWeightMatrix: mat4x4f;uniform ambientMatrix: mat4x4f;uniform opacityMatrix: mat4x4f;uniform emissiveMatrix: mat4x4f;uniform lightmapMatrix: mat4x4f;uniform reflectivityMatrix: mat4x4f;uniform microSurfaceSamplerMatrix: mat4x4f;uniform bumpMatrix: mat4x4f;uniform vTangentSpaceParams: vec2f;uniform reflectionMatrix: mat4x4f;uniform vReflectionColor: vec3f;uniform vAlbedoColor: vec4f;uniform baseWeight: f32;uniform vLightingIntensity: vec4f;uniform vReflectionMicrosurfaceInfos: vec3f;uniform pointSize: f32;uniform vReflectivityColor: vec4f;uniform vEmissiveColor: vec3f;uniform vAmbientColor: vec3f;uniform vDebugMode: vec2f;uniform vMetallicReflectanceFactors: vec4f;uniform vMetallicReflectanceInfos: vec2f;uniform metallicReflectanceMatrix: mat4x4f;uniform vReflectanceInfos: vec2f;uniform reflectanceMatrix: mat4x4f;uniform vSphericalL00: vec3f;uniform vSphericalL1_1: vec3f;uniform vSphericalL10: vec3f;uniform vSphericalL11: vec3f;uniform vSphericalL2_2: vec3f;uniform vSphericalL2_1: vec3f;uniform vSphericalL20: vec3f;uniform vSphericalL21: vec3f;uniform vSphericalL22: vec3f;uniform vSphericalX: vec3f;uniform vSphericalY: vec3f;uniform vSphericalZ: vec3f;uniform vSphericalXX_ZZ: vec3f;uniform vSphericalYY_ZZ: vec3f;uniform vSphericalZZ: vec3f;uniform vSphericalXY: vec3f;uniform vSphericalYZ: vec3f;uniform vSphericalZX: vec3f;
#define ADDITIONAL_UBO_DECLARATION
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;C.IncludesShadersStoreWGSL[u_]||(C.IncludesShadersStoreWGSL[u_]=nP);const d_="harmonicsFunctions",aP=`#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
fn computeEnvironmentIrradiance(normal: vec3f)->vec3f {return uniforms.vSphericalL00
+ uniforms.vSphericalL1_1*(normal.y)
+ uniforms.vSphericalL10*(normal.z)
+ uniforms.vSphericalL11*(normal.x)
+ uniforms.vSphericalL2_2*(normal.y*normal.x)
+ uniforms.vSphericalL2_1*(normal.y*normal.z)
+ uniforms.vSphericalL20*((3.0*normal.z*normal.z)-1.0)
+ uniforms.vSphericalL21*(normal.z*normal.x)
+ uniforms.vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));}
#else
fn computeEnvironmentIrradiance(normal: vec3f)->vec3f {var Nx: f32=normal.x;var Ny: f32=normal.y;var Nz: f32=normal.z;var C1: vec3f=uniforms.vSphericalZZ.rgb;var Cx: vec3f=uniforms.vSphericalX.rgb;var Cy: vec3f=uniforms.vSphericalY.rgb;var Cz: vec3f=uniforms.vSphericalZ.rgb;var Cxx_zz: vec3f=uniforms.vSphericalXX_ZZ.rgb;var Cyy_zz: vec3f=uniforms.vSphericalYY_ZZ.rgb;var Cxy: vec3f=uniforms.vSphericalXY.rgb;var Cyz: vec3f=uniforms.vSphericalYZ.rgb;var Czx: vec3f=uniforms.vSphericalZX.rgb;var a1: vec3f=Cyy_zz*Ny+Cy;var a2: vec3f=Cyz*Nz+a1;var b1: vec3f=Czx*Nz+Cx;var b2: vec3f=Cxy*Ny+b1;var b3: vec3f=Cxx_zz*Nx+b2;var t1: vec3f=Cz *Nz+C1;var t2: vec3f=a2 *Ny+t1;var t3: vec3f=b3 *Nx+t2;return t3;}
#endif
#endif
`;C.IncludesShadersStoreWGSL[d_]||(C.IncludesShadersStoreWGSL[d_]=aP);const Xl="pbrVertexShader",zE=`#include<pbrUboDeclaration>
#define CUSTOM_VERTEX_BEGIN
attribute position: vec3f;
#ifdef NORMAL
attribute normal: vec3f;
#endif
#ifdef TANGENT
attribute tangent: vec4f;
#endif
#ifdef UV1
attribute uv: vec2f;
#endif
#include<uvAttributeDeclaration>[2..7]
#include<mainUVVaryingDeclaration>[1..7]
#ifdef VERTEXCOLOR
attribute color: vec4f;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)
#include<samplerVertexDeclaration>(_DEFINENAME_,BASEWEIGHT,_VARYINGNAME_,BaseWeight)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)
#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)
#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)
#ifdef CLEARCOAT
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)
#endif
#ifdef SUBSURFACE
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor)
#endif
varying vPositionW: vec3f;
#if DEBUGMODE>0
varying vClipSpacePosition: vec4f;
#endif
#ifdef NORMAL
varying vNormalW: vec3f;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vEnvironmentIrradiance: vec3f;
#include<harmonicsFunctions>
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vColor: vec4f;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<lightVxUboDeclaration>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
var positionUpdated: vec3f=vertexInputs.position;
#ifdef NORMAL
var normalUpdated: vec3f=vertexInputs.normal;
#endif
#ifdef TANGENT
var tangentUpdated: vec4f=vertexInputs.tangent;
#endif
#ifdef UV1
var uvUpdated: vec2f=vertexInputs.uv;
#endif
#ifdef UV2
var uv2Updated: vec2f=vertexInputs.uv2;
#endif
#ifdef VERTEXCOLOR
var colorUpdated: vec4f=vertexInputs.color;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vertexOutputs.vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)
vertexOutputs.vCurrentPosition=scene.viewProjection*finalWorld*vec4f(positionUpdated,1.0);vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld*vec4f(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);vertexOutputs.vPositionW= worldPos.xyz;
#ifdef PREPASS
#include<prePassVertex>
#endif
#ifdef NORMAL
var normalWorld: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vertexOutputs.vNormalW=normalUpdated/ vec3f(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vertexOutputs.vNormalW=normalize(normalWorld*vertexOutputs.vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vertexOutputs.vNormalW=normalize(normalWorld*normalUpdated);
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
var reflectionVector: vec3f= (uniforms.reflectionMatrix* vec4f(vertexOutputs.vNormalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
vertexOutputs.vEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {vertexOutputs.position=scene.viewProjection*worldPos;} else {vertexOutputs.position=scene.viewProjectionR*worldPos;}
#else
vertexOutputs.position=scene.viewProjection*worldPos;
#endif
#if DEBUGMODE>0
vertexOutputs.vClipSpacePosition=vertexOutputs.position;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vertexOutputs.vDirectionW=normalize((finalWorld*vec4f(positionUpdated,0.0)).xyz);
#endif
#ifndef UV1
var uvUpdated: vec2f= vec2f(0.,0.);
#endif
#ifdef MAINUV1
vertexOutputs.vMainUV1=uvUpdated;
#endif
#ifndef UV2
var uv2Updated: vec2f= vec2f(0.,0.);
#endif
#ifdef MAINUV2
vertexOutputs.vMainUV2=uv2Updated;
#endif
#include<uvVariableDeclaration>[3..7]
#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BASEWEIGHT,_VARYINGNAME_,BaseWeight,_MATRIXNAME_,baseWeight,_INFONAME_,BaseWeightInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)
#ifdef CLEARCOAT
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)
#endif
#ifdef SHEEN
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheenRoughness,_INFONAME_,SheenInfos.z)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)
#endif
#ifdef SUBSURFACE
#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_MATRIXNAME_,translucencyColor,_INFONAME_,TranslucencyColorInfos.x)
#endif
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;C.ShadersStoreWGSL[Xl]||(C.ShadersStoreWGSL[Xl]=zE);const oP={name:Xl,shader:zE},lP=Object.freeze(Object.defineProperty({__proto__:null,pbrVertexShaderWGSL:oP},Symbol.toStringTag,{value:"Module"})),__="pbrFragmentExtraDeclaration",cP=`varying vPositionW: vec3f;
#if DEBUGMODE>0
varying vClipSpacePosition: vec4f;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#ifdef NORMAL
varying vNormalW: vec3f;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vEnvironmentIrradiance: vec3f;
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vColor: vec4f;
#endif
`;C.IncludesShadersStoreWGSL[__]||(C.IncludesShadersStoreWGSL[__]=cP);const p_="samplerFragmentAlternateDeclaration",hP=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying v_VARYINGNAME_UV: vec2f;
#endif
#endif
`;C.IncludesShadersStoreWGSL[p_]||(C.IncludesShadersStoreWGSL[p_]=hP);const m_="pbrFragmentSamplersDeclaration",fP=`#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BASEWEIGHT,_VARYINGNAME_,BaseWeight,_SAMPLERNAME_,baseWeight)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)
#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef CLEARCOAT
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS)
var clearCoatRoughnessSamplerSampler: sampler;var clearCoatRoughnessSampler: texture_2d<f32>;
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_SAMPLERNAME_,iridescence)
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_SAMPLERNAME_,iridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS)
var sheenRoughnessSamplerSampler: sampler;var sheenRoughnessSampler: texture_2d<f32>;
#endif
#endif
#ifdef ANISOTROPIC
#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
var reflectionSamplerSampler: sampler;var reflectionSampler: texture_cube<f32>;
#ifdef LODBASEDMICROSFURACE
#else
var reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_cube<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_cube<f32>;
#endif
#ifdef USEIRRADIANCEMAP
var irradianceSamplerSampler: sampler;var irradianceSampler: texture_cube<f32>;
#endif
#else
var reflectionSamplerSampler: sampler;var reflectionSampler: texture_2d<f32>;
#ifdef LODBASEDMICROSFURACE
#else
var reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_2d<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_2d<f32>;
#endif
#ifdef USEIRRADIANCEMAP
var irradianceSamplerSampler: sampler;var irradianceSampler: texture_2d<f32>;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#endif
#endif
#ifdef ENVIRONMENTBRDF
var environmentBrdfSamplerSampler: sampler;var environmentBrdfSampler: texture_2d<f32>;
#endif
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
var areaLightsLTC1SamplerSampler: sampler;var areaLightsLTC1Sampler: texture_2d<f32>;var areaLightsLTC2SamplerSampler: sampler;var areaLightsLTC2Sampler: texture_2d<f32>;
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#ifdef SS_REFRACTIONMAP_3D
var refractionSamplerSampler: sampler;var refractionSampler: texture_cube<f32>;
#ifdef LODBASEDMICROSFURACE
#else
var refractionLowSamplerSampler: sampler;var refractionLowSampler: texture_cube<f32>;var refractionHighSamplerSampler: sampler;var refractionHighSampler: texture_cube<f32>;
#endif
#else
var refractionSamplerSampler: sampler;var refractionSampler: texture_2d<f32>;
#ifdef LODBASEDMICROSFURACE
#else
var refractionLowSamplerSampler: sampler;var refractionLowSampler: texture_2d<f32>;var refractionHighSamplerSampler: sampler;var refractionHighSampler: texture_2d<f32>;
#endif
#endif
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_SAMPLERNAME_,translucencyColor)
#endif
#ifdef IBL_CDF_FILTERING
var icdfSamplerSampler: sampler;var icdfSampler: texture_2d<f32>;
#endif
`;C.IncludesShadersStoreWGSL[m_]||(C.IncludesShadersStoreWGSL[m_]=fP);const g_="subSurfaceScatteringFunctions",uP=`fn testLightingForSSS(diffusionProfile: f32)->bool
{return diffusionProfile<1.;}`;C.IncludesShadersStoreWGSL[g_]||(C.IncludesShadersStoreWGSL[g_]=uP);const E_="importanceSampling",dP=`fn hemisphereCosSample(u: vec2f)->vec3f {var phi: f32=2.*PI*u.x;var cosTheta2: f32=1.-u.y;var cosTheta: f32=sqrt(cosTheta2);var sinTheta: f32=sqrt(1.-cosTheta2);return vec3f(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
fn hemisphereImportanceSampleDggx(u: vec2f,a: f32)->vec3f {var phi: f32=2.*PI*u.x;var cosTheta2: f32=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));var cosTheta: f32=sqrt(cosTheta2);var sinTheta: f32=sqrt(1.-cosTheta2);return vec3f(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
fn hemisphereImportanceSampleDCharlie(u: vec2f,a: f32)->vec3f { 
var phi: f32=2.*PI*u.x;var sinTheta: f32=pow(u.y,a/(2.*a+1.));var cosTheta: f32=sqrt(1.-sinTheta*sinTheta);return vec3f(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}`;C.IncludesShadersStoreWGSL[E_]||(C.IncludesShadersStoreWGSL[E_]=dP);const v_="pbrHelperFunctions",_P=`#define MINIMUMVARIANCE 0.0005
fn convertRoughnessToAverageSlope(roughness: f32)->f32
{return roughness*roughness+MINIMUMVARIANCE;}
fn fresnelGrazingReflectance(reflectance0: f32)->f32 {var reflectance90: f32=saturate(reflectance0*25.0);return reflectance90;}
fn getAARoughnessFactors(normalVector: vec3f)->vec2f {
#ifdef SPECULARAA
var nDfdx: vec3f=dpdx(normalVector.xyz);var nDfdy: vec3f=dpdy(normalVector.xyz);var slopeSquare: f32=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));var geometricRoughnessFactor: f32=pow(saturate(slopeSquare),0.333);var geometricAlphaGFactor: f32=sqrt(slopeSquare);geometricAlphaGFactor*=0.75;return vec2f(geometricRoughnessFactor,geometricAlphaGFactor);
#else
return vec2f(0.);
#endif
}
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_LEGACY
fn getAnisotropicRoughness(alphaG: f32,anisotropy: f32)->vec2f {var alphaT: f32=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);var alphaB: f32=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);return vec2f(alphaT,alphaB);}
fn getAnisotropicBentNormals(T: vec3f,B: vec3f,N: vec3f,V: vec3f,anisotropy: f32,roughness: f32)->vec3f {var anisotropicFrameDirection: vec3f=select(T,B,anisotropy>=0.0);var anisotropicFrameTangent: vec3f=cross(normalize(anisotropicFrameDirection),V);var anisotropicFrameNormal: vec3f=cross(anisotropicFrameTangent,anisotropicFrameDirection);var anisotropicNormal: vec3f=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));return anisotropicNormal;}
#else
fn getAnisotropicRoughness(alphaG: f32,anisotropy: f32)->vec2f {var alphaT: f32=max(mix(alphaG,1.0,anisotropy*anisotropy),MINIMUMVARIANCE);var alphaB: f32=max(alphaG,MINIMUMVARIANCE);return vec2f(alphaT,alphaB);}
fn getAnisotropicBentNormals(T: vec3f,B: vec3f,N: vec3f,V: vec3f,anisotropy: f32,roughness: f32)->vec3f {var bentNormal: vec3f=cross(B,V);bentNormal=normalize(cross(bentNormal,B));var sq=1.0-anisotropy*(1.0-roughness);var a: f32=sq*sq*sq*sq;bentNormal=normalize(mix(bentNormal,N,a));return bentNormal;}
#endif
#endif
#if defined(CLEARCOAT) || defined(SS_REFRACTION)
fn cocaLambertVec3(alpha: vec3f,distance: f32)->vec3f {return exp(-alpha*distance);}
fn cocaLambert(NdotVRefract: f32,NdotLRefract: f32,alpha: vec3f,thickness: f32)->vec3f {return cocaLambertVec3(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));}
fn computeColorAtDistanceInMedia(color: vec3f,distance: f32)->vec3f {return -log(color)/distance;}
fn computeClearCoatAbsorption(NdotVRefract: f32,NdotLRefract: f32,clearCoatColor: vec3f,clearCoatThickness: f32,clearCoatIntensity: f32)->vec3f {var clearCoatAbsorption: vec3f=mix( vec3f(1.0),
cocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),
clearCoatIntensity);return clearCoatAbsorption;}
#endif
#ifdef MICROSURFACEAUTOMATIC
fn computeDefaultMicroSurface(microSurface: f32,reflectivityColor: vec3f)->f32
{const kReflectivityNoAlphaWorkflow_SmoothnessMax: f32=0.95;var reflectivityLuminance: f32=getLuminance(reflectivityColor);var reflectivityLuma: f32=sqrt(reflectivityLuminance);var resultMicroSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;return resultMicroSurface;}
#endif
`;C.IncludesShadersStoreWGSL[v_]||(C.IncludesShadersStoreWGSL[v_]=_P);const T_="pbrDirectLightingSetupFunctions",pP=`struct preLightingInfo
{lightOffset: vec3f,
lightDistanceSquared: f32,
lightDistance: f32,
attenuation: f32,
L: vec3f,
H: vec3f,
NdotV: f32,
NdotLUnclamped: f32,
NdotL: f32,
VdotH: f32,
roughness: f32,
#ifdef IRIDESCENCE
iridescenceIntensity: f32
#endif
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
areaLightDiffuse: vec3f,
#ifdef SPECULARTERM
areaLightSpecular: vec3f,
areaLightFresnel: vec4f
#endif
#endif
};fn computePointAndSpotPreLightingInfo(lightData: vec4f,V: vec3f,N: vec3f,posW: vec3f)->preLightingInfo {var result: preLightingInfo;result.lightOffset=lightData.xyz-posW;result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);result.lightDistance=sqrt(result.lightDistanceSquared);result.L=normalize(result.lightOffset);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}
fn computeDirectionalPreLightingInfo(lightData: vec4f,V: vec3f,N: vec3f)->preLightingInfo {var result: preLightingInfo;result.lightDistance=length(-lightData.xyz);result.L=normalize(-lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}
fn computeHemisphericPreLightingInfo(lightData: vec4f,V: vec3f,N: vec3f)->preLightingInfo {var result: preLightingInfo;result.NdotL=dot(N,lightData.xyz)*0.5+0.5;result.NdotL=saturateEps(result.NdotL);result.NdotLUnclamped=result.NdotL;
#ifdef SPECULARTERM
result.L=normalize(lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));
#endif
return result;}
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
#include<ltcHelperFunctions>
fn computeAreaPreLightingInfo(ltc1: texture_2d<f32>,ltc1Sampler:sampler,ltc2:texture_2d<f32>,ltc2Sampler:sampler,viewDirectionW: vec3f,vNormal:vec3f,vPosition:vec3f,lightCenter:vec3f,halfWidth:vec3f, halfHeight:vec3f,roughness:f32)->preLightingInfo {var result: preLightingInfo;var data: areaLightData=computeAreaLightSpecularDiffuseFresnel(ltc1,ltc1Sampler,ltc2,ltc2Sampler,viewDirectionW,vNormal,vPosition,lightCenter,halfWidth,halfHeight,roughness);
#ifdef SPECULARTERM
result.areaLightFresnel=data.Fresnel;result.areaLightSpecular=data.Specular;
#endif
result.areaLightDiffuse+=data.Diffuse;return result;}
#endif
`;C.IncludesShadersStoreWGSL[T_]||(C.IncludesShadersStoreWGSL[T_]=pP);const S_="pbrDirectLightingFalloffFunctions",mP=`fn computeDistanceLightFalloff_Standard(lightOffset: vec3f,range: f32)->f32
{return max(0.,1.0-length(lightOffset)/range);}
fn computeDistanceLightFalloff_Physical(lightDistanceSquared: f32)->f32
{return 1.0/maxEps(lightDistanceSquared);}
fn computeDistanceLightFalloff_GLTF(lightDistanceSquared: f32,inverseSquaredRange: f32)->f32
{var lightDistanceFalloff: f32=1.0/maxEps(lightDistanceSquared);var factor: f32=lightDistanceSquared*inverseSquaredRange;var attenuation: f32=saturate(1.0-factor*factor);attenuation*=attenuation;lightDistanceFalloff*=attenuation;return lightDistanceFalloff;}
fn computeDirectionalLightFalloff_IES(lightDirection: vec3f,directionToLightCenterW: vec3f,iesLightTexture: texture_2d<f32>,iesLightTextureSampler: sampler)->f32
{var cosAngle: f32=dot(-lightDirection,directionToLightCenterW);var angle=acos(cosAngle)/PI;return textureSampleLevel(iesLightTexture,iesLightTextureSampler,vec2f(angle,0),0.).r;}
fn computeDistanceLightFalloff(lightOffset: vec3f,lightDistanceSquared: f32,range: f32,inverseSquaredRange: f32)->f32
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDistanceLightFalloff_Physical(lightDistanceSquared);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);
#else
return computeDistanceLightFalloff_Standard(lightOffset,range);
#endif
}
fn computeDirectionalLightFalloff_Standard(lightDirection: vec3f,directionToLightCenterW: vec3f,cosHalfAngle: f32,exponent: f32)->f32
{var falloff: f32=0.0;var cosAngle: f32=maxEps(dot(-lightDirection,directionToLightCenterW));if (cosAngle>=cosHalfAngle)
{falloff=max(0.,pow(cosAngle,exponent));}
return falloff;}
fn computeDirectionalLightFalloff_Physical(lightDirection: vec3f,directionToLightCenterW: vec3f,cosHalfAngle: f32)->f32
{const kMinusLog2ConeAngleIntensityRatio: f32=6.64385618977; 
var concentrationKappa: f32=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);var lightDirectionSpreadSG: vec4f= vec4f(-lightDirection*concentrationKappa,-concentrationKappa);var falloff: f32=exp2(dot( vec4f(directionToLightCenterW,1.0),lightDirectionSpreadSG));return falloff;}
fn computeDirectionalLightFalloff_GLTF(lightDirection: vec3f,directionToLightCenterW: vec3f,lightAngleScale: f32,lightAngleOffset: f32)->f32
{var cd: f32=dot(-lightDirection,directionToLightCenterW);var falloff: f32=saturate(cd*lightAngleScale+lightAngleOffset);falloff*=falloff;return falloff;}
fn computeDirectionalLightFalloff(lightDirection: vec3f,directionToLightCenterW: vec3f,cosHalfAngle: f32,exponent: f32,lightAngleScale: f32,lightAngleOffset: f32)->f32
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);
#else
return computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);
#endif
}`;C.IncludesShadersStoreWGSL[S_]||(C.IncludesShadersStoreWGSL[S_]=mP);const A_="pbrBRDFFunctions",gP=`#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
#ifdef MS_BRDF_ENERGY_CONSERVATION
fn getEnergyConservationFactor(specularEnvironmentR0: vec3f,environmentBrdf: vec3f)->vec3f {return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);}
#endif
#ifdef ENVIRONMENTBRDF
fn getBRDFLookup(NdotV: f32,perceptualRoughness: f32)->vec3f {var UV: vec2f= vec2f(NdotV,perceptualRoughness);var brdfLookup: vec4f= textureSample(environmentBrdfSampler,environmentBrdfSamplerSampler,UV);
#ifdef ENVIRONMENTBRDF_RGBD
brdfLookup=vec4f(fromRGBD(brdfLookup.rgba),brdfLookup.a);
#endif
return brdfLookup.rgb;}
fn getReflectanceFromBRDFWithEnvLookup(specularEnvironmentR0: vec3f,specularEnvironmentR90: vec3f,environmentBrdf: vec3f)->vec3f {
#ifdef BRDF_V_HEIGHT_CORRELATED
var reflectance: vec3f=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;
#else
var reflectance: vec3f=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;
#endif
return reflectance;}
fn getReflectanceFromBRDFLookup(specularEnvironmentR0: vec3f,environmentBrdf: vec3f)->vec3f {
#ifdef BRDF_V_HEIGHT_CORRELATED
var reflectance: vec3f=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);
#else
var reflectance: vec3f=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;
#endif
return reflectance;}
#endif
/* NOT USED
#if defined(SHEEN) && defined(SHEEN_SOFTER)
fn getBRDFLookupCharlieSheen(NdotV: f32,perceptualRoughness: f32)->f32
{var c: f32=1.0-NdotV;var c3: f32=c*c*c;return 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));}
#endif
*/
#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)
fn getReflectanceFromAnalyticalBRDFLookup_Jones(VdotN: f32,reflectance0: vec3f,reflectance90: vec3f,smoothness: f32)->vec3f
{var weight: f32=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
/**
* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.
* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table
*/
fn getSheenReflectanceFromBRDFLookup(reflectance0: vec3f,environmentBrdf: vec3f)->vec3f {var sheenEnvironmentReflectance: vec3f=reflectance0*environmentBrdf.b;return sheenEnvironmentReflectance;}
#endif
fn fresnelSchlickGGXVec3(VdotH: f32,reflectance0: vec3f,reflectance90: vec3f)->vec3f
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
fn fresnelSchlickGGX(VdotH: f32,reflectance0: f32,reflectance90: f32)->f32
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
#ifdef CLEARCOAT
fn getR0RemappedForClearCoat(f0: vec3f)->vec3f {
#ifdef CLEARCOAT_DEFAULTIOR
#ifdef MOBILE
return saturateVec3(f0*(f0*0.526868+0.529324)-0.0482256);
#else
return saturateVec3(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);
#endif
#else
var s: vec3f=sqrt(f0);var t: vec3f=(uniforms.vClearCoatRefractionParams.z+uniforms.vClearCoatRefractionParams.w*s)/(uniforms.vClearCoatRefractionParams.w+uniforms.vClearCoatRefractionParams.z*s);return squareVec3(t);
#endif
}
#endif
#ifdef IRIDESCENCE
const XYZ_TO_REC709: mat3x3f= mat3x3f(
3.2404542,-0.9692660, 0.0556434,
-1.5371385, 1.8760108,-0.2040259,
-0.4985314, 0.0415560, 1.0572252
);fn getIORTfromAirToSurfaceR0(f0: vec3f)->vec3f {var sqrtF0: vec3f=sqrt(f0);return (1.+sqrtF0)/(1.-sqrtF0);}
fn getR0fromIORsVec3(iorT: vec3f,iorI: f32)->vec3f {return squareVec3((iorT- vec3f(iorI))/(iorT+ vec3f(iorI)));}
fn getR0fromIORs(iorT: f32,iorI: f32)->f32 {return square((iorT-iorI)/(iorT+iorI));}
fn evalSensitivity(opd: f32,shift: vec3f)->vec3f {var phase: f32=2.0*PI*opd*1.0e-9;const val: vec3f= vec3f(5.4856e-13,4.4201e-13,5.2481e-13);const pos: vec3f= vec3f(1.6810e+06,1.7953e+06,2.2084e+06);const vr: vec3f= vec3f(4.3278e+09,9.3046e+09,6.6121e+09);var xyz: vec3f=val*sqrt(2.0*PI*vr)*cos(pos*phase+shift)*exp(-square(phase)*vr);xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));xyz/=1.0685e-7;var srgb: vec3f=XYZ_TO_REC709*xyz;return srgb;}
fn evalIridescence(outsideIOR: f32,eta2: f32,cosTheta1: f32,thinFilmThickness: f32,baseF0: vec3f)->vec3f {var I: vec3f= vec3f(1.0);var iridescenceIOR: f32=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));var sinTheta2Sq: f32=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));var cosTheta2Sq: f32=1.0-sinTheta2Sq;if (cosTheta2Sq<0.0) {return I;}
var cosTheta2: f32=sqrt(cosTheta2Sq);var R0: f32=getR0fromIORs(iridescenceIOR,outsideIOR);var R12: f32=fresnelSchlickGGX(cosTheta1,R0,1.);var R21: f32=R12;var T121: f32=1.0-R12;var phi12: f32=0.0;if (iridescenceIOR<outsideIOR) {phi12=PI;}
var phi21: f32=PI-phi12;var baseIOR: vec3f=getIORTfromAirToSurfaceR0(clamp(baseF0,vec3f(0.0),vec3f(0.9999))); 
var R1: vec3f=getR0fromIORsVec3(baseIOR,iridescenceIOR);var R23: vec3f=fresnelSchlickGGXVec3(cosTheta2,R1, vec3f(1.));var phi23: vec3f= vec3f(0.0);if (baseIOR[0]<iridescenceIOR) {phi23[0]=PI;}
if (baseIOR[1]<iridescenceIOR) {phi23[1]=PI;}
if (baseIOR[2]<iridescenceIOR) {phi23[2]=PI;}
var opd: f32=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;var phi: vec3f= vec3f(phi21)+phi23;var R123: vec3f=clamp(R12*R23,vec3f(1e-5),vec3f(0.9999));var r123: vec3f=sqrt(R123);var Rs: vec3f=(T121*T121)*R23/( vec3f(1.0)-R123);var C0: vec3f=R12+Rs;I=C0;var Cm: vec3f=Rs-T121;for (var m: i32=1; m<=2; m++)
{Cm*=r123;var Sm: vec3f=2.0*evalSensitivity( f32(m)*opd, f32(m)*phi);I+=Cm*Sm;}
return max(I, vec3f(0.0));}
#endif
fn normalDistributionFunction_TrowbridgeReitzGGX(NdotH: f32,alphaG: f32)->f32
{var a2: f32=alphaG*alphaG;var d: f32=NdotH*NdotH*(a2-1.0)+1.0;return a2/(PI*d*d);}
#ifdef SHEEN
fn normalDistributionFunction_CharlieSheen(NdotH: f32,alphaG: f32)->f32
{var invR: f32=1./alphaG;var cos2h: f32=NdotH*NdotH;var sin2h: f32=1.-cos2h;return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);}
#endif
#ifdef ANISOTROPIC
fn normalDistributionFunction_BurleyGGX_Anisotropic(NdotH: f32,TdotH: f32,BdotH: f32,alphaTB: vec2f)->f32 {var a2: f32=alphaTB.x*alphaTB.y;var v: vec3f= vec3f(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);var v2: f32=dot(v,v);var w2: f32=a2/v2;return a2*w2*w2*RECIPROCAL_PI;}
#endif
#ifdef BRDF_V_HEIGHT_CORRELATED
fn smithVisibility_GGXCorrelated(NdotL: f32,NdotV: f32,alphaG: f32)->f32 {
#ifdef MOBILE
var GGXV: f32=NdotL*(NdotV*(1.0-alphaG)+alphaG);var GGXL: f32=NdotV*(NdotL*(1.0-alphaG)+alphaG);return 0.5/(GGXV+GGXL);
#else
var a2: f32=alphaG*alphaG;var GGXV: f32=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);var GGXL: f32=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);return 0.5/(GGXV+GGXL);
#endif
}
#else
fn smithVisibilityG1_TrowbridgeReitzGGXFast(dot: f32,alphaG: f32)->f32
{
#ifdef MOBILE
return 1.0/(dot+alphaG+(1.0-alphaG)*dot ));
#else
var alphaSquared: f32=alphaG*alphaG;return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));
#endif
}
fn smithVisibility_TrowbridgeReitzGGXFast(NdotL: f32,NdotV: f32,alphaG: f32)->f32
{var visibility: f32=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);return visibility;}
#endif
#ifdef ANISOTROPIC
fn smithVisibility_GGXCorrelated_Anisotropic(NdotL: f32,NdotV: f32,TdotV: f32,BdotV: f32,TdotL: f32,BdotL: f32,alphaTB: vec2f)->f32 {var lambdaV: f32=NdotL*length( vec3f(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));var lambdaL: f32=NdotV*length( vec3f(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));var v: f32=0.5/(lambdaV+lambdaL);return v;}
#endif
#ifdef CLEARCOAT
fn visibility_Kelemen(VdotH: f32)->f32 {return 0.25/(VdotH*VdotH); }
#endif
#ifdef SHEEN
fn visibility_Ashikhmin(NdotL: f32,NdotV: f32)->f32
{return 1./(4.*(NdotL+NdotV-NdotL*NdotV));}
/* NOT USED
#ifdef SHEEN_SOFTER
fn l(x: f32,alphaG: f32)->f32
{var oneMinusAlphaSq: f32=(1.0-alphaG)*(1.0-alphaG);var a: f32=mix(21.5473,25.3245,oneMinusAlphaSq);var b: f32=mix(3.82987,3.32435,oneMinusAlphaSq);var c: f32=mix(0.19823,0.16801,oneMinusAlphaSq);var d: f32=mix(-1.97760,-1.27393,oneMinusAlphaSq);var e: f32=mix(-4.32054,-4.85967,oneMinusAlphaSq);return a/(1.0+b*pow(x,c))+d*x+e;}
fn lambdaSheen(cosTheta: f32,alphaG: f32)->f32
{return abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));}
fn visibility_CharlieSheen(NdotL: f32,NdotV: f32,alphaG: f32)->f32
{var G: f32=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));return G/(4.0*NdotV*NdotL);}
#endif
*/
#endif
fn diffuseBRDF_Burley(NdotL: f32,NdotV: f32,VdotH: f32,roughness: f32)->f32 {var diffuseFresnelNV: f32=pow5(saturateEps(1.0-NdotL));var diffuseFresnelNL: f32=pow5(saturateEps(1.0-NdotV));var diffuseFresnel90: f32=0.5+2.0*VdotH*VdotH*roughness;var fresnel: f32 =
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);return fresnel/PI;}
#ifdef SS_TRANSLUCENCY
fn transmittanceBRDF_Burley(tintColor: vec3f,diffusionDistance: vec3f,thickness: f32)->vec3f {var S: vec3f=1./maxEpsVec3(diffusionDistance);var temp: vec3f=exp((-0.333333333*thickness)*S);return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);}
fn computeWrappedDiffuseNdotL(NdotL: f32,w: f32)->f32 {var t: f32=1.0+w;var invt2: f32=1.0/(t*t);return saturate((NdotL+w)*invt2);}
#endif
`;C.IncludesShadersStoreWGSL[A_]||(C.IncludesShadersStoreWGSL[A_]=gP);const R_="hdrFilteringFunctions",EP=`#ifdef NUM_SAMPLES
#if NUM_SAMPLES>0
fn radicalInverse_VdC(value: u32)->f32 
{var bits=(value<<16u) | (value>>16u);bits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);bits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);bits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);bits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);return f32(bits)*2.3283064365386963e-10; }
fn hammersley(i: u32,N: u32)->vec2f
{return vec2f( f32(i)/ f32(N),radicalInverse_VdC(i));}
fn log4(x: f32)->f32 {return log2(x)/2.;}
fn uv_to_normal(uv: vec2f)->vec3f {var N: vec3f;var uvRange: vec2f=uv;var theta: f32=uvRange.x*2.0*PI;var phi: f32=uvRange.y*PI;N.x=cos(theta)*sin(phi);N.z=sin(theta)*sin(phi);N.y=cos(phi);return N;}
const NUM_SAMPLES_FLOAT: f32= f32(NUM_SAMPLES);const NUM_SAMPLES_FLOAT_INVERSED: f32=1./NUM_SAMPLES_FLOAT;const K: f32=4.;fn irradiance(inputTexture: texture_cube<f32>,inputSampler: sampler,inputN: vec3f,filteringInfo: vec2f
#ifdef IBL_CDF_FILTERING
,icdfSampler: texture_2d<f32>,icdfSamplerSampler: sampler
#endif
)->vec3f
{var n: vec3f=normalize(inputN);var result: vec3f= vec3f(0.0);
#ifndef IBL_CDF_FILTERING
var tangent: vec3f=select(vec3f(1.,0.,0.),vec3f(0.,0.,1.),abs(n.z)<0.999);tangent=normalize(cross(tangent,n));var bitangent: vec3f=cross(n,tangent);var tbn: mat3x3f= mat3x3f(tangent,bitangent,n);
#endif
var maxLevel: f32=filteringInfo.y;var dim0: f32=filteringInfo.x;var omegaP: f32=(4.*PI)/(6.*dim0*dim0);for(var i: u32=0u; i<NUM_SAMPLES; i++)
{var Xi: vec2f=hammersley(i,NUM_SAMPLES);
#ifdef IBL_CDF_FILTERING
var T: vec2f;T.x=textureSampleLevel(icdfSampler,icdfSamplerSampler,vec2(Xi.x,0.0),0.0).x;T.y=textureSampleLevel(icdfSampler,icdfSamplerSampler,vec2(T.x,Xi.y),0.0).y;var Ls: vec3f=uv_to_normal(vec2f(1.0-fract(T.x+0.25),T.y));var NoL: f32=dot(n,Ls);
#else
var Ls: vec3f=hemisphereCosSample(Xi);Ls=normalize(Ls);var Ns: vec3f= vec3f(0.,0.,1.);var NoL: f32=dot(Ns,Ls);
#endif
if (NoL>0.) {
#ifdef IBL_CDF_FILTERING
var pdf: f32=textureSampleLevel(icdfSampler,icdfSamplerSampler,T,0.0).z;var c: vec3f=textureSampleLevel(inputTexture,inputSampler,Ls,0.0).rgb;
#else
var pdf_inversed: f32=PI/NoL;var omegaS: f32=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;var l: f32=log4(omegaS)-log4(omegaP)+log4(K);var mipLevel: f32=clamp(l,0.0,maxLevel);var c: vec3f=textureSampleLevel(inputTexture,inputSampler,tbn*Ls,mipLevel).rgb;
#endif
#ifdef GAMMA_INPUT
c=toLinearSpaceVec3(c);
#endif
#ifdef IBL_CDF_FILTERING
var light: vec3f=vec3f(0.0);if (pdf>1e-6) {light=vec3f(1.0)/vec3f(pdf)*c;}
result+=NoL*light;
#else
result+=c;
#endif
}}
result=result*NUM_SAMPLES_FLOAT_INVERSED;return result;}
fn radiance(alphaG: f32,inputTexture: texture_cube<f32>,inputSampler: sampler,inputN: vec3f,filteringInfo: vec2f)->vec3f
{var n: vec3f=normalize(inputN);var c: vec3f=textureSample(inputTexture,inputSampler,n).rgb; 
if (alphaG==0.) {
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
return c;} else {var result: vec3f= vec3f(0.);var tangent: vec3f=select(vec3f(1.,0.,0.),vec3f(0.,0.,1.),abs(n.z)<0.999);tangent=normalize(cross(tangent,n));var bitangent: vec3f=cross(n,tangent);var tbn: mat3x3f= mat3x3f(tangent,bitangent,n);var maxLevel: f32=filteringInfo.y;var dim0: f32=filteringInfo.x;var omegaP: f32=(4.*PI)/(6.*dim0*dim0);var weight: f32=0.;for(var i: u32=0u; i<NUM_SAMPLES; i++)
{var Xi: vec2f=hammersley(i,NUM_SAMPLES);var H: vec3f=hemisphereImportanceSampleDggx(Xi,alphaG);var NoV: f32=1.;var NoH: f32=H.z;var NoH2: f32=H.z*H.z;var NoL: f32=2.*NoH2-1.;var L: vec3f= vec3f(2.*NoH*H.x,2.*NoH*H.y,NoL);L=normalize(L);if (NoL>0.) {var pdf_inversed: f32=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);var omegaS: f32=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;var l: f32=log4(omegaS)-log4(omegaP)+log4(K);var mipLevel: f32=clamp( f32(l),0.0,maxLevel);weight+=NoL;var c: vec3f=textureSampleLevel(inputTexture,inputSampler,tbn*L,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c*NoL;}}
result=result/weight;return result;}}
#endif
#endif
`;C.IncludesShadersStoreWGSL[R_]||(C.IncludesShadersStoreWGSL[R_]=EP);const C_="pbrDirectLightingFunctions",vP=`#define CLEARCOATREFLECTANCE90 1.0
struct lightingInfo
{diffuse: vec3f,
#ifdef SPECULARTERM
specular: vec3f,
#endif
#ifdef CLEARCOAT
clearCoat: vec4f,
#endif
#ifdef SHEEN
sheen: vec3f
#endif
};fn adjustRoughnessFromLightProperties(roughness: f32,lightRadius: f32,lightDistance: f32)->f32 {
#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)
var lightRoughness: f32=lightRadius/lightDistance;var totalRoughness: f32=saturate(lightRoughness+roughness);return totalRoughness;
#else
return roughness;
#endif
}
fn computeHemisphericDiffuseLighting(info: preLightingInfo,lightColor: vec3f,groundColor: vec3f)->vec3f {return mix(groundColor,lightColor,info.NdotL);}
fn computeDiffuseLighting(info: preLightingInfo,lightColor: vec3f)->vec3f {var diffuseTerm: f32=diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*info.attenuation*info.NdotL*lightColor;}
fn computeProjectionTextureDiffuseLighting(projectionLightTexture: texture_2d<f32>,projectionLightSampler: sampler,textureProjectionMatrix: mat4x4f,posW: vec3f)->vec3f{var strq: vec4f=textureProjectionMatrix* vec4f(posW,1.0);strq/=strq.w;var textureColor: vec3f=textureSample(projectionLightTexture,projectionLightSampler,strq.xy).rgb;return toLinearSpaceVec3(textureColor);}
#ifdef SS_TRANSLUCENCY
fn computeDiffuseAndTransmittedLighting(info: preLightingInfo,lightColor: vec3f,transmittance: vec3f,transmittanceIntensity: f32,surfaceAlbedo: vec3f)->vec3f {var transmittanceNdotL=vec3f(0.0);var NdotL: f32=absEps(info.NdotLUnclamped);if (info.NdotLUnclamped<0.0) {var wrapNdotL: f32=computeWrappedDiffuseNdotL(NdotL,0.02);var trAdapt: f32=step(0.,info.NdotLUnclamped);transmittanceNdotL=mix(transmittance*wrapNdotL, vec3f(wrapNdotL),trAdapt);}
var diffuseTerm: f32=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);return (transmittanceNdotL/PI+(1.0-transmittanceIntensity)*diffuseTerm*surfaceAlbedo*info.NdotL)*info.attenuation*lightColor;}
#endif
#ifdef SPECULARTERM
fn computeSpecularLighting(info: preLightingInfo,N: vec3f,reflectance0: vec3f,reflectance90: vec3f,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var roughness: f32=max(info.roughness,geometricRoughnessFactor);var alphaG: f32=convertRoughnessToAverageSlope(roughness);var fresnel: vec3f=fresnelSchlickGGXVec3(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
var distribution: f32=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);
#ifdef BRDF_V_HEIGHT_CORRELATED
var smithVisibility: f32=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);
#else
var smithVisibility: f32=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);
#endif
var specTerm: vec3f=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#endif
#ifdef ANISOTROPIC
fn computeAnisotropicSpecularLighting(info: preLightingInfo,V: vec3f,N: vec3f,T: vec3f,B: vec3f,anisotropy: f32,reflectance0: vec3f,reflectance90: vec3f,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var TdotH: f32=dot(T,info.H);var BdotH: f32=dot(B,info.H);var TdotV: f32=dot(T,V);var BdotV: f32=dot(B,V);var TdotL: f32=dot(T,info.L);var BdotL: f32=dot(B,info.L);var alphaG: f32=convertRoughnessToAverageSlope(info.roughness);var alphaTB: vec2f=getAnisotropicRoughness(alphaG,anisotropy);alphaTB=max(alphaTB,vec2f(geometricRoughnessFactor*geometricRoughnessFactor));var fresnel: vec3f=fresnelSchlickGGXVec3(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
var distribution: f32=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);var smithVisibility: f32=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);var specTerm: vec3f=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#endif
#ifdef CLEARCOAT
fn computeClearCoatLighting(info: preLightingInfo,Ncc: vec3f,geometricRoughnessFactor: f32,clearCoatIntensity: f32,lightColor: vec3f)->vec4f {var NccdotL: f32=saturateEps(dot(Ncc,info.L));var NccdotH: f32=saturateEps(dot(Ncc,info.H));var clearCoatRoughness: f32=max(info.roughness,geometricRoughnessFactor);var alphaG: f32=convertRoughnessToAverageSlope(clearCoatRoughness);var fresnel: f32=fresnelSchlickGGX(info.VdotH,uniforms.vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnel*=clearCoatIntensity;var distribution: f32=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);var kelemenVisibility: f32=visibility_Kelemen(info.VdotH);var clearCoatTerm: f32=fresnel*distribution*kelemenVisibility;return vec4f(
clearCoatTerm*info.attenuation*NccdotL*lightColor,
1.0-fresnel
);}
fn computeClearCoatLightingAbsorption(NdotVRefract: f32,L: vec3f,Ncc: vec3f,clearCoatColor: vec3f,clearCoatThickness: f32,clearCoatIntensity: f32)->vec3f {var LRefract: vec3f=-refract(L,Ncc,uniforms.vClearCoatRefractionParams.y);var NdotLRefract: f32=saturateEps(dot(Ncc,LRefract));var absorption: vec3f=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);return absorption;}
#endif
#ifdef SHEEN
fn computeSheenLighting(info: preLightingInfo,N: vec3f,reflectance0: vec3f,reflectance90: vec3f,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var roughness: f32=max(info.roughness,geometricRoughnessFactor);var alphaG: f32=convertRoughnessToAverageSlope(roughness);var fresnel: f32=1.;var distribution: f32=normalDistributionFunction_CharlieSheen(NdotH,alphaG);/*#ifdef SHEEN_SOFTER
var visibility: f32=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);
#else */
var visibility: f32=visibility_Ashikhmin(info.NdotL,info.NdotV);/* #endif */
var sheenTerm: f32=fresnel*distribution*visibility;return sheenTerm*info.attenuation*info.NdotL*lightColor;}
#endif
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
fn computeAreaDiffuseLighting(info: preLightingInfo,lightColor: vec3f)->vec3f {return info.areaLightDiffuse*lightColor;}
fn computeAreaSpecularLighting(info: preLightingInfo,specularColor: vec3f)->vec3f {var fresnel:vec3f =( specularColor*info.areaLightFresnel.x+( vec3f( 1.0 )-specularColor )*info.areaLightFresnel.y );return specularColor*fresnel*info.areaLightSpecular;}
#endif
`;C.IncludesShadersStoreWGSL[C_]||(C.IncludesShadersStoreWGSL[C_]=vP);const I_="pbrIBLFunctions",TP=`#if defined(REFLECTION) || defined(SS_REFRACTION)
fn getLodFromAlphaG(cubeMapDimensionPixels: f32,microsurfaceAverageSlope: f32)->f32 {var microsurfaceAverageSlopeTexels: f32=cubeMapDimensionPixels*microsurfaceAverageSlope;var lod: f32=log2(microsurfaceAverageSlopeTexels);return lod;}
fn getLinearLodFromRoughness(cubeMapDimensionPixels: f32,roughness: f32)->f32 {var lod: f32=log2(cubeMapDimensionPixels)*roughness;return lod;}
#endif
#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)
fn environmentRadianceOcclusion(ambientOcclusion: f32,NdotVUnclamped: f32)->f32 {var temp: f32=NdotVUnclamped+ambientOcclusion;return saturate(temp*temp-1.0+ambientOcclusion);}
#endif
#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)
fn environmentHorizonOcclusion(view: vec3f,normal: vec3f,geometricNormal: vec3f)->f32 {var reflection: vec3f=reflect(view,normal);var temp: f32=saturate(1.0+1.1*dot(reflection,geometricNormal));return temp*temp;}
#endif
#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)
fn UNPACK_LOD(x: f32)->f32 {return (1.0-x)*255.0;}
fn getLodFromAlphaGNdotV(cubeMapDimensionPixels: f32,alphaG: f32,NdotV: f32)->f32 {var microsurfaceAverageSlope: f32=alphaG;microsurfaceAverageSlope*=sqrt(abs(NdotV));return getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);}
#endif
`;C.IncludesShadersStoreWGSL[I_]||(C.IncludesShadersStoreWGSL[I_]=TP);const b_="pbrBlockAlbedoOpacity",SP=`struct albedoOpacityOutParams
{surfaceAlbedo: vec3f,
alpha: f32};
#define pbr_inline
fn albedoOpacityBlock(
vAlbedoColor: vec4f
#ifdef ALBEDO
,albedoTexture: vec4f
,albedoInfos: vec2f
#endif
,baseWeight: f32
#ifdef BASEWEIGHT
,baseWeightTexture: vec4f
,vBaseWeightInfos: vec2f
#endif
#ifdef OPACITY
,opacityMap: vec4f
,vOpacityInfos: vec2f
#endif
#ifdef DETAIL
,detailColor: vec4f
,vDetailInfos: vec4f
#endif
#ifdef DECAL
,decalColor: vec4f
,vDecalInfos: vec4f
#endif
)->albedoOpacityOutParams
{var outParams: albedoOpacityOutParams;var surfaceAlbedo: vec3f=vAlbedoColor.rgb;var alpha: f32=vAlbedoColor.a;
#ifdef ALBEDO
#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)
alpha*=albedoTexture.a;
#endif
#ifdef GAMMAALBEDO
surfaceAlbedo*=toLinearSpaceVec3(albedoTexture.rgb);
#else
surfaceAlbedo*=albedoTexture.rgb;
#endif
surfaceAlbedo*=albedoInfos.y;
#endif
#ifndef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
surfaceAlbedo*=fragmentInputs.vColor.rgb;
#endif
#ifdef DETAIL
var detailAlbedo: f32=2.0*mix(0.5,detailColor.r,vDetailInfos.y);surfaceAlbedo=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; 
#endif
#ifdef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALBEDO
surfaceAlbedo*=baseWeight;
#ifdef BASEWEIGHT
surfaceAlbedo*=baseWeightTexture.r;
#endif
#ifdef OPACITY
#ifdef OPACITYRGB
alpha=getLuminance(opacityMap.rgb);
#else
alpha*=opacityMap.a;
#endif
alpha*=vOpacityInfos.y;
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=fragmentInputs.vColor.a;
#endif
#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)
#ifdef ALPHATEST
#if DEBUGMODE != 88
if (alpha<ALPHATESTVALUE) {discard;}
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
#endif
outParams.surfaceAlbedo=surfaceAlbedo;outParams.alpha=alpha;return outParams;}
`;C.IncludesShadersStoreWGSL[b_]||(C.IncludesShadersStoreWGSL[b_]=SP);const x_="pbrBlockReflectivity",AP=`struct reflectivityOutParams
{microSurface: f32,
roughness: f32,
surfaceReflectivityColor: vec3f,
#ifdef METALLICWORKFLOW
surfaceAlbedo: vec3f,
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
ambientOcclusionColor: vec3f,
#endif
#if DEBUGMODE>0
#ifdef METALLICWORKFLOW
metallicRoughness: vec2f,
#ifdef REFLECTIVITY
surfaceMetallicColorMap: vec4f,
#endif
#ifndef FROSTBITE_REFLECTANCE
metallicF0: vec3f,
#endif
#else
#ifdef REFLECTIVITY
surfaceReflectivityColorMap: vec4f,
#endif
#endif
#endif
};
#define pbr_inline
fn reflectivityBlock(
vReflectivityColor: vec4f
#ifdef METALLICWORKFLOW
,surfaceAlbedo: vec3f
,metallicReflectanceFactors: vec4f
#endif
#ifdef REFLECTIVITY
,reflectivityInfos: vec3f
,surfaceMetallicOrReflectivityColorMap: vec4f
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
,ambientOcclusionColorIn: vec3f
#endif
#ifdef MICROSURFACEMAP
,microSurfaceTexel: vec4f
#endif
#ifdef DETAIL
,detailColor: vec4f
,vDetailInfos: vec4f
#endif
)->reflectivityOutParams
{var outParams: reflectivityOutParams;var microSurface: f32=vReflectivityColor.a;var surfaceReflectivityColor: vec3f=vReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
var metallicRoughness: vec2f=surfaceReflectivityColor.rg;
#ifdef REFLECTIVITY
#if DEBUGMODE>0
outParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef AOSTOREINMETALMAPRED
var aoStoreInMetalMap: vec3f= vec3f(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);outParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);
#endif
#ifdef METALLNESSSTOREINMETALMAPBLUE
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;
#else
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;
#endif
#ifdef ROUGHNESSSTOREINMETALMAPALPHA
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;
#else
#ifdef ROUGHNESSSTOREINMETALMAPGREEN
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;
#endif
#endif
#endif
#ifdef DETAIL
var detailRoughness: f32=mix(0.5,detailColor.b,vDetailInfos.w);var loLerp: f32=mix(0.,metallicRoughness.g,detailRoughness*2.);var hiLerp: f32=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);metallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));
#endif
#ifdef MICROSURFACEMAP
metallicRoughness.g*=microSurfaceTexel.r;
#endif
#if DEBUGMODE>0
outParams.metallicRoughness=metallicRoughness;
#endif
#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS
microSurface=1.0-metallicRoughness.g;var baseColor: vec3f=surfaceAlbedo;
#ifdef FROSTBITE_REFLECTANCE
outParams.surfaceAlbedo=baseColor.rgb*(1.0-metallicRoughness.r);surfaceReflectivityColor=mix(0.16*reflectance*reflectance,baseColor,metallicRoughness.r);
#else
var metallicF0: vec3f=metallicReflectanceFactors.rgb;
#if DEBUGMODE>0
outParams.metallicF0=metallicF0;
#endif
outParams.surfaceAlbedo=mix(baseColor.rgb*(1.0-metallicF0), vec3f(0.,0.,0.),metallicRoughness.r);surfaceReflectivityColor=mix(metallicF0,baseColor,metallicRoughness.r);
#endif
#else
#ifdef REFLECTIVITY
surfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;
#if DEBUGMODE>0
outParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef MICROSURFACEFROMREFLECTIVITYMAP
microSurface*=surfaceMetallicOrReflectivityColorMap.a;microSurface*=reflectivityInfos.z;
#else
#ifdef MICROSURFACEAUTOMATIC
microSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);
#endif
#ifdef MICROSURFACEMAP
microSurface*=microSurfaceTexel.r;
#endif
#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE
#endif
#endif
#endif
microSurface=saturate(microSurface);var roughness: f32=1.-microSurface;outParams.microSurface=microSurface;outParams.roughness=roughness;outParams.surfaceReflectivityColor=surfaceReflectivityColor;return outParams;}
`;C.IncludesShadersStoreWGSL[x_]||(C.IncludesShadersStoreWGSL[x_]=AP);const y_="pbrBlockAmbientOcclusion",RP=`struct ambientOcclusionOutParams
{ambientOcclusionColor: vec3f,
#if DEBUGMODE>0 && defined(AMBIENT)
ambientOcclusionColorMap: vec3f
#endif
};
#define pbr_inline
fn ambientOcclusionBlock(
#ifdef AMBIENT
ambientOcclusionColorMap_: vec3f,
vAmbientInfos: vec4f
#endif
)->ambientOcclusionOutParams
{ 
var outParams: ambientOcclusionOutParams;var ambientOcclusionColor: vec3f= vec3f(1.,1.,1.);
#ifdef AMBIENT
var ambientOcclusionColorMap: vec3f=ambientOcclusionColorMap_*vAmbientInfos.y;
#ifdef AMBIENTINGRAYSCALE
ambientOcclusionColorMap= vec3f(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);
#endif
ambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);
#if DEBUGMODE>0
outParams.ambientOcclusionColorMap=ambientOcclusionColorMap;
#endif
#endif
outParams.ambientOcclusionColor=ambientOcclusionColor;return outParams;}
`;C.IncludesShadersStoreWGSL[y_]||(C.IncludesShadersStoreWGSL[y_]=RP);const M_="pbrBlockAlphaFresnel",CP=`#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
struct alphaFresnelOutParams
{alpha: f32};fn faceforward(N: vec3<f32>,I: vec3<f32>,Nref: vec3<f32>)->vec3<f32> {return select(N,-N,dot(Nref,I)>0.0);}
#define pbr_inline
fn alphaFresnelBlock(
normalW: vec3f,
viewDirectionW: vec3f,
alpha: f32,
microSurface: f32
)->alphaFresnelOutParams
{var outParams: alphaFresnelOutParams;var opacityPerceptual: f32=alpha;
#ifdef LINEARALPHAFRESNEL
var opacity0: f32=opacityPerceptual;
#else
var opacity0: f32=opacityPerceptual*opacityPerceptual;
#endif
var opacity90: f32=fresnelGrazingReflectance(opacity0);var normalForward: vec3f=faceforward(normalW,-viewDirectionW,normalW);outParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)), vec3f(opacity0), vec3f(opacity90),sqrt(microSurface)).x;
#ifdef ALPHATEST
if (outParams.alpha<ALPHATESTVALUE) {discard;}
#ifndef ALPHABLEND
outParams.alpha=1.0;
#endif
#endif
return outParams;}
#endif
#endif
`;C.IncludesShadersStoreWGSL[M_]||(C.IncludesShadersStoreWGSL[M_]=CP);const P_="pbrBlockAnisotropic",IP=`#ifdef ANISOTROPIC
struct anisotropicOutParams
{anisotropy: f32,
anisotropicTangent: vec3f,
anisotropicBitangent: vec3f,
anisotropicNormal: vec3f,
#if DEBUGMODE>0 && defined(ANISOTROPIC_TEXTURE)
anisotropyMapData: vec3f
#endif
};
#define pbr_inline
fn anisotropicBlock(
vAnisotropy: vec3f,
roughness: f32,
#ifdef ANISOTROPIC_TEXTURE
anisotropyMapData: vec3f,
#endif
TBN: mat3x3f,
normalW: vec3f,
viewDirectionW: vec3f
)->anisotropicOutParams
{ 
var outParams: anisotropicOutParams;var anisotropy: f32=vAnisotropy.b;var anisotropyDirection: vec3f= vec3f(vAnisotropy.xy,0.);
#ifdef ANISOTROPIC_TEXTURE
var amd=anisotropyMapData.rg;anisotropy*=anisotropyMapData.b;
#if DEBUGMODE>0
outParams.anisotropyMapData=anisotropyMapData;
#endif
amd=amd*2.0-1.0;
#ifdef ANISOTROPIC_LEGACY
anisotropyDirection=vec3f(anisotropyDirection.xy*amd,anisotropyDirection.z);
#else
anisotropyDirection=vec3f(mat2x2f(anisotropyDirection.x,anisotropyDirection.y,-anisotropyDirection.y,anisotropyDirection.x)*normalize(amd),anisotropyDirection.z);
#endif
#endif
var anisoTBN: mat3x3f= mat3x3f(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));var anisotropicTangent: vec3f=normalize(anisoTBN*anisotropyDirection);var anisotropicBitangent: vec3f=normalize(cross(anisoTBN[2],anisotropicTangent));outParams.anisotropy=anisotropy;outParams.anisotropicTangent=anisotropicTangent;outParams.anisotropicBitangent=anisotropicBitangent;outParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy,roughness);return outParams;}
#endif
`;C.IncludesShadersStoreWGSL[P_]||(C.IncludesShadersStoreWGSL[P_]=IP);const O_="pbrBlockReflection",bP=`#ifdef REFLECTION
struct reflectionOutParams
{environmentRadiance: vec4f
,environmentIrradiance: vec3f
#ifdef REFLECTIONMAP_3D
,reflectionCoords: vec3f
#else
,reflectionCoords: vec2f
#endif
#ifdef SS_TRANSLUCENCY
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,irradianceVector: vec3f
#endif
#endif
#endif
};
#define pbr_inline
#ifdef REFLECTIONMAP_3D
fn createReflectionCoords(
vPositionW: vec3f,
normalW: vec3f,
#ifdef ANISOTROPIC
anisotropicOut: anisotropicOutParams,
#endif
)->vec3f
{var reflectionCoords: vec3f;
#else
fn createReflectionCoords(
vPositionW: vec3f,
normalW: vec3f,
#ifdef ANISOTROPIC
anisotropicOut: anisotropicOutParams,
#endif
)->vec2f
{ 
var reflectionCoords: vec2f;
#endif
#ifdef ANISOTROPIC
var reflectionVector: vec3f=computeReflectionCoords( vec4f(vPositionW,1.0),anisotropicOut.anisotropicNormal);
#else
var reflectionVector: vec3f=computeReflectionCoords( vec4f(vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
reflectionCoords=reflectionVector;
#else
reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
return reflectionCoords;}
#define pbr_inline
fn sampleReflectionTexture(
alphaG: f32
,vReflectionMicrosurfaceInfos: vec3f
,vReflectionInfos: vec2f
,vReflectionColor: vec3f
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped: f32
#endif
#ifdef LINEARSPECULARREFLECTION
,roughness: f32
#endif
#ifdef REFLECTIONMAP_3D
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
,reflectionCoords: vec3f
#else
,reflectionSampler: texture_2d<f32>
,reflectionSamplerSampler: sampler
,reflectionCoords: vec2f
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,reflectionLowSampler: texture_cube<f32>
,reflectionLowSamplerSampler: sampler
,reflectionHighSampler: texture_cube<f32>
,reflectionHighSamplerSampler: sampler
#else
,reflectionLowSampler: texture_2d<f32>
,reflectionLowSamplerSampler: sampler
,reflectionHighSampler: texture_2d<f32>
,reflectionHighSamplerSampler: sampler
#endif
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo: vec2f
#endif 
)->vec4f
{var environmentRadiance: vec4f;
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
var reflectionLOD: f32=getLodFromAlphaGNdotV(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);
#elif defined(LINEARSPECULARREFLECTION)
var reflectionLOD: f32=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);
#else
var reflectionLOD: f32=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);
#endif
#ifdef LODBASEDMICROSFURACE
reflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
#ifdef LODINREFLECTIONALPHA
var automaticReflectionLOD: f32=UNPACK_LOD(textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords).a);var requestedReflectionLOD: f32=max(automaticReflectionLOD,reflectionLOD);
#else
var requestedReflectionLOD: f32=reflectionLOD;
#endif
#ifdef REALTIME_FILTERING
environmentRadiance= vec4f(radiance(alphaG,reflectionSampler,reflectionSamplerSampler,reflectionCoords,vReflectionFilteringInfo),1.0);
#else
environmentRadiance=textureSampleLevel(reflectionSampler,reflectionSamplerSampler,reflectionCoords,reflectionLOD);
#endif
#else
var lodReflectionNormalized: f32=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));var lodReflectionNormalizedDoubled: f32=lodReflectionNormalized*2.0;var environmentMid: vec4f=textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords);if (lodReflectionNormalizedDoubled<1.0){environmentRadiance=mix(
textureSample(reflectionHighSampler,reflectionHighSamplerSampler,reflectionCoords),
environmentMid,
lodReflectionNormalizedDoubled
);} else {environmentRadiance=mix(
environmentMid,
textureSample(reflectionLowSampler,reflectionLowSamplerSampler,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);}
#endif
var envRadiance=environmentRadiance.rgb;
#ifdef RGBDREFLECTION
envRadiance=fromRGBD(environmentRadiance);
#endif
#ifdef GAMMAREFLECTION
envRadiance=toLinearSpaceVec3(environmentRadiance.rgb);
#endif
envRadiance*=vReflectionInfos.x;envRadiance*=vReflectionColor.rgb;return vec4f(envRadiance,environmentRadiance.a);}
#define pbr_inline
fn reflectionBlock(
vPositionW: vec3f
,normalW: vec3f
,alphaG: f32
,vReflectionMicrosurfaceInfos: vec3f
,vReflectionInfos: vec2f
,vReflectionColor: vec3f
#ifdef ANISOTROPIC
,anisotropicOut: anisotropicOutParams
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped: f32
#endif
#ifdef LINEARSPECULARREFLECTION
,roughness: f32
#endif
#ifdef REFLECTIONMAP_3D
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
#else
,reflectionSampler: texture_2d<f32>
,reflectionSamplerSampler: sampler
#endif
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,vEnvironmentIrradiance: vec3f
#endif
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
,reflectionMatrix: mat4x4f
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
,irradianceSampler: texture_cube<f32>
,irradianceSamplerSampler: sampler 
#else
,irradianceSampler: texture_2d<f32>
,irradianceSamplerSampler: sampler 
#endif
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,reflectionLowSampler: texture_cube<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_cube<f32>
,reflectionHighSamplerSampler: sampler 
#else
,reflectionLowSampler: texture_2d<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_2d<f32>
,reflectionHighSamplerSampler: sampler 
#endif
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo: vec2f
#ifdef IBL_CDF_FILTERING
,icdfSampler: texture_2d<f32>
,icdfSamplerSampler: sampler
#endif
#endif
)->reflectionOutParams
{var outParams: reflectionOutParams;var environmentRadiance: vec4f= vec4f(0.,0.,0.,0.);
#ifdef REFLECTIONMAP_3D
var reflectionCoords: vec3f= vec3f(0.);
#else
var reflectionCoords: vec2f= vec2f(0.);
#endif
reflectionCoords=createReflectionCoords(
vPositionW,
normalW,
#ifdef ANISOTROPIC
anisotropicOut,
#endif 
);environmentRadiance=sampleReflectionTexture(
alphaG
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,roughness
#endif
#ifdef REFLECTIONMAP_3D
,reflectionSampler
,reflectionSamplerSampler
,reflectionCoords
#else
,reflectionSampler
,reflectionSamplerSampler
,reflectionCoords
#endif
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif 
);var environmentIrradiance: vec3f= vec3f(0.,0.,0.);
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
#ifdef ANISOTROPIC
var irradianceVector: vec3f= (reflectionMatrix* vec4f(anisotropicOut.anisotropicNormal,0)).xyz;
#else
var irradianceVector: vec3f= (reflectionMatrix* vec4f(normalW,0)).xyz;
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
environmentIrradiance=vEnvironmentIrradiance;
#else
#if defined(REALTIME_FILTERING)
environmentIrradiance=irradiance(reflectionSampler,reflectionSamplerSampler,irradianceVector,vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,icdfSampler
,icdfSamplerSampler
#endif
);
#else
environmentIrradiance=computeEnvironmentIrradiance(irradianceVector);
#endif
#ifdef SS_TRANSLUCENCY
outParams.irradianceVector=irradianceVector;
#endif
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
var environmentIrradiance4: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,irradianceVector);
#else
var environmentIrradiance4: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,reflectionCoords);
#endif
environmentIrradiance=environmentIrradiance4.rgb;
#ifdef RGBDREFLECTION
environmentIrradiance=fromRGBD(environmentIrradiance4);
#endif
#ifdef GAMMAREFLECTION
environmentIrradiance=toLinearSpaceVec3(environmentIrradiance.rgb);
#endif
#endif
environmentIrradiance*=vReflectionColor.rgb;
#ifdef MIX_IBL_RADIANCE_WITH_IRRADIANCE
outParams.environmentRadiance=vec4f(mix(environmentRadiance.rgb,environmentIrradiance,alphaG),environmentRadiance.a);
#else
outParams.environmentRadiance=environmentRadiance;
#endif
outParams.environmentIrradiance=environmentIrradiance;outParams.reflectionCoords=reflectionCoords;return outParams;}
#endif
`;C.IncludesShadersStoreWGSL[O_]||(C.IncludesShadersStoreWGSL[O_]=bP);const D_="pbrBlockSheen",xP=`#ifdef SHEEN
struct sheenOutParams
{sheenIntensity: f32
,sheenColor: vec3f
,sheenRoughness: f32
#ifdef SHEEN_LINKWITHALBEDO
,surfaceAlbedo: vec3f
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
,sheenAlbedoScaling: f32
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,finalSheenRadianceScaled: vec3f
#endif
#if DEBUGMODE>0
#ifdef SHEEN_TEXTURE
,sheenMapData: vec4f
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,sheenEnvironmentReflectance: vec3f
#endif
#endif
};
#define pbr_inline
fn sheenBlock(
vSheenColor: vec4f
#ifdef SHEEN_ROUGHNESS
,vSheenRoughness: f32
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
,sheenMapRoughnessData: vec4f
#endif
#endif
,roughness: f32
#ifdef SHEEN_TEXTURE
,sheenMapData: vec4f
,sheenMapLevel: f32
#endif
,reflectance: f32
#ifdef SHEEN_LINKWITHALBEDO
,baseColor: vec3f
,surfaceAlbedo: vec3f
#endif
#ifdef ENVIRONMENTBRDF
,NdotV: f32
,environmentBrdf: vec3f
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,AARoughnessFactors: vec2f
,vReflectionMicrosurfaceInfos: vec3f
,vReflectionInfos: vec2f
,vReflectionColor: vec3f
,vLightingIntensity: vec4f
#ifdef REFLECTIONMAP_3D
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
,reflectionCoords: vec3f
#else
,reflectionSampler: texture_2d<f32>
,reflectionSamplerSampler: sampler
,reflectionCoords: vec2f
#endif
,NdotVUnclamped: f32
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,reflectionLowSampler: texture_cube<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_cube<f32>
,reflectionHighSamplerSampler: sampler 
#else
,reflectionLowSampler: texture_2d<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_2d<f32>
,reflectionHighSamplerSampler: sampler 
#endif
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo: vec2f
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
,seo: f32
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
,eho: f32
#endif
#endif
)->sheenOutParams
{var outParams: sheenOutParams;var sheenIntensity: f32=vSheenColor.a;
#ifdef SHEEN_TEXTURE
#if DEBUGMODE>0
outParams.sheenMapData=sheenMapData;
#endif
#endif
#ifdef SHEEN_LINKWITHALBEDO
var sheenFactor: f32=pow5(1.0-sheenIntensity);var sheenColor: vec3f=baseColor.rgb*(1.0-sheenFactor);var sheenRoughness: f32=sheenIntensity;outParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#else
var sheenColor: vec3f=vSheenColor.rgb;
#ifdef SHEEN_TEXTURE
#ifdef SHEEN_GAMMATEXTURE
sheenColor*=toLinearSpaceVec3(sheenMapData.rgb);
#else
sheenColor*=sheenMapData.rgb;
#endif
sheenColor*=sheenMapLevel;
#endif
#ifdef SHEEN_ROUGHNESS
var sheenRoughness: f32=vSheenRoughness;
#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE
#if defined(SHEEN_TEXTURE)
sheenRoughness*=sheenMapData.a;
#endif
#elif defined(SHEEN_TEXTURE_ROUGHNESS)
sheenRoughness*=sheenMapRoughnessData.a;
#endif
#else
var sheenRoughness: f32=roughness;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#endif
#if !defined(SHEEN_ALBEDOSCALING)
sheenIntensity*=(1.-reflectance);
#endif
sheenColor*=sheenIntensity;
#endif
#ifdef ENVIRONMENTBRDF
/*#ifdef SHEEN_SOFTER
var environmentSheenBrdf: vec3f= vec3f(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));
#else*/
#ifdef SHEEN_ROUGHNESS
var environmentSheenBrdf: vec3f=getBRDFLookup(NdotV,sheenRoughness);
#else
var environmentSheenBrdf: vec3f=environmentBrdf;
#endif
/*#endif*/
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
var sheenAlphaG: f32=convertRoughnessToAverageSlope(sheenRoughness);
#ifdef SPECULARAA
sheenAlphaG+=AARoughnessFactors.y;
#endif
var environmentSheenRadiance: vec4f= vec4f(0.,0.,0.,0.);environmentSheenRadiance=sampleReflectionTexture(
sheenAlphaG
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,sheenRoughness
#endif
,reflectionSampler
,reflectionSamplerSampler
,reflectionCoords
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
);var sheenEnvironmentReflectance: vec3f=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
sheenEnvironmentReflectance*=seo;
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
sheenEnvironmentReflectance*=eho;
#endif
#if DEBUGMODE>0
outParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;
#endif
outParams.finalSheenRadianceScaled=
environmentSheenRadiance.rgb *
sheenEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
outParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;
#endif
outParams.sheenIntensity=sheenIntensity;outParams.sheenColor=sheenColor;outParams.sheenRoughness=sheenRoughness;return outParams;}
#endif
`;C.IncludesShadersStoreWGSL[D_]||(C.IncludesShadersStoreWGSL[D_]=xP);const L_="pbrBlockClearcoat",yP=`struct clearcoatOutParams
{specularEnvironmentR0: vec3f,
conservationFactor: f32,
clearCoatNormalW: vec3f,
clearCoatAARoughnessFactors: vec2f,
clearCoatIntensity: f32,
clearCoatRoughness: f32,
#ifdef REFLECTION
finalClearCoatRadianceScaled: vec3f,
#endif
#ifdef CLEARCOAT_TINT
absorption: vec3f,
clearCoatNdotVRefract: f32,
clearCoatColor: vec3f,
clearCoatThickness: f32,
#endif
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
energyConservationFactorClearCoat: vec3f,
#endif
#if DEBUGMODE>0
#ifdef CLEARCOAT_BUMP
TBNClearCoat: mat3x3f,
#endif
#ifdef CLEARCOAT_TEXTURE
clearCoatMapData: vec2f,
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
clearCoatTintMapData: vec4f,
#endif
#ifdef REFLECTION
environmentClearCoatRadiance: vec4f,
clearCoatEnvironmentReflectance: vec3f,
#endif
clearCoatNdotV: f32
#endif
};
#ifdef CLEARCOAT
#define pbr_inline
fn clearcoatBlock(
vPositionW: vec3f
,geometricNormalW: vec3f
,viewDirectionW: vec3f
,vClearCoatParams: vec2f
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
,clearCoatMapRoughnessData: vec4f
#endif
,specularEnvironmentR0: vec3f
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData: vec2f
#endif
#ifdef CLEARCOAT_TINT
,vClearCoatTintParams: vec4f
,clearCoatColorAtDistance: f32
,vClearCoatRefractionParams: vec4f
#ifdef CLEARCOAT_TINT_TEXTURE
,clearCoatTintMapData: vec4f
#endif
#endif
#ifdef CLEARCOAT_BUMP
,vClearCoatBumpInfos: vec2f
,clearCoatBumpMapData: vec4f
,vClearCoatBumpUV: vec2f
#if defined(TANGENT) && defined(NORMAL)
,vTBN: mat3x3f
#else
,vClearCoatTangentSpaceParams: vec2f
#endif
#ifdef OBJECTSPACE_NORMALMAP
,normalMatrix: mat4x4f
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
,faceNormal: vec3f
#endif
#ifdef REFLECTION
,vReflectionMicrosurfaceInfos: vec3f
,vReflectionInfos: vec2f
,vReflectionColor: vec3f
,vLightingIntensity: vec4f
#ifdef REFLECTIONMAP_3D
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
#else
,reflectionSampler: texture_2d<f32>
,reflectionSamplerSampler: sampler
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,reflectionLowSampler: texture_cube<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_cube<f32>
,reflectionHighSamplerSampler: sampler 
#else
,reflectionLowSampler: texture_2d<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_2d<f32>
,reflectionHighSamplerSampler: sampler 
#endif
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo: vec2f
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
,frontFacingMultiplier: f32
#endif 
)->clearcoatOutParams
{var outParams: clearcoatOutParams;var clearCoatIntensity: f32=vClearCoatParams.x;var clearCoatRoughness: f32=vClearCoatParams.y;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE
clearCoatRoughness*=clearCoatMapData.y;
#endif
#if DEBUGMODE>0
outParams.clearCoatMapData=clearCoatMapData;
#endif
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
clearCoatRoughness*=clearCoatMapRoughnessData.y;
#endif
outParams.clearCoatIntensity=clearCoatIntensity;outParams.clearCoatRoughness=clearCoatRoughness;
#ifdef CLEARCOAT_TINT
var clearCoatColor: vec3f=vClearCoatTintParams.rgb;var clearCoatThickness: f32=vClearCoatTintParams.a;
#ifdef CLEARCOAT_TINT_TEXTURE
#ifdef CLEARCOAT_TINT_GAMMATEXTURE
clearCoatColor*=toLinearSpaceVec3(clearCoatTintMapData.rgb);
#else
clearCoatColor*=clearCoatTintMapData.rgb;
#endif
clearCoatThickness*=clearCoatTintMapData.a;
#if DEBUGMODE>0
outParams.clearCoatTintMapData=clearCoatTintMapData;
#endif
#endif
outParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);outParams.clearCoatThickness=clearCoatThickness;
#endif
#ifdef CLEARCOAT_REMAP_F0
var specularEnvironmentR0Updated: vec3f=getR0RemappedForClearCoat(specularEnvironmentR0);
#else
var specularEnvironmentR0Updated: vec3f=specularEnvironmentR0;
#endif
outParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);var clearCoatNormalW: vec3f=geometricNormalW;
#ifdef CLEARCOAT_BUMP
#ifdef NORMALXYSCALE
var clearCoatNormalScale: f32=1.0;
#else
var clearCoatNormalScale: f32=vClearCoatBumpInfos.y;
#endif
#if defined(TANGENT) && defined(NORMAL)
var TBNClearCoat: mat3x3f=vTBN;
#else
var TBNClearCoatUV: vec2f=vClearCoatBumpUV*frontFacingMultiplier;var TBNClearCoat: mat3x3f=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);
#endif
#if DEBUGMODE>0
outParams.TBNClearCoat=TBNClearCoat;
#endif
#ifdef OBJECTSPACE_NORMALMAP
clearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);clearCoatNormalW=normalize( mat3x3f(normalMatrix[0].xyz,normalMatrix[1].xyz,normalMatrix[2].xyz)*clearCoatNormalW);
#else
clearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
clearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
clearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;
#endif
outParams.clearCoatNormalW=clearCoatNormalW;outParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);var clearCoatNdotVUnclamped: f32=dot(clearCoatNormalW,viewDirectionW);var clearCoatNdotV: f32=absEps(clearCoatNdotVUnclamped);
#if DEBUGMODE>0
outParams.clearCoatNdotV=clearCoatNdotV;
#endif
#ifdef CLEARCOAT_TINT
var clearCoatVRefract: vec3f=refract(-viewDirectionW,clearCoatNormalW,vClearCoatRefractionParams.y);outParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));
#endif
#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))
var environmentClearCoatBrdf: vec3f=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);
#endif
#if defined(REFLECTION)
var clearCoatAlphaG: f32=convertRoughnessToAverageSlope(clearCoatRoughness);
#ifdef SPECULARAA
clearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;
#endif
var environmentClearCoatRadiance: vec4f= vec4f(0.,0.,0.,0.);var clearCoatReflectionVector: vec3f=computeReflectionCoords( vec4f(vPositionW,1.0),clearCoatNormalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
clearCoatReflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
var clearCoatReflectionCoords: vec3f=clearCoatReflectionVector;
#else
var clearCoatReflectionCoords: vec2f=clearCoatReflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
clearCoatReflectionCoords/=clearCoatReflectionVector.z;
#endif
clearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;
#endif
environmentClearCoatRadiance=sampleReflectionTexture(
clearCoatAlphaG
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,clearCoatNdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,clearCoatRoughness
#endif
,reflectionSampler
,reflectionSamplerSampler
,clearCoatReflectionCoords
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif 
);
#if DEBUGMODE>0
outParams.environmentClearCoatRadiance=environmentClearCoatRadiance;
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
var clearCoatEnvironmentReflectance: vec3f=getReflectanceFromBRDFLookup(vec3f(uniforms.vClearCoatRefractionParams.x),environmentClearCoatBrdf);
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
var clearCoatEho: f32=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);clearCoatEnvironmentReflectance*=clearCoatEho;
#endif
#endif
#endif
#else
var clearCoatEnvironmentReflectance: vec3f=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV, vec3f(1.), vec3f(1.),sqrt(1.-clearCoatRoughness));
#endif
clearCoatEnvironmentReflectance*=clearCoatIntensity;
#if DEBUGMODE>0
outParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;
#endif
outParams.finalClearCoatRadianceScaled=
environmentClearCoatRadiance.rgb *
clearCoatEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(CLEARCOAT_TINT)
outParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);
#endif
var fresnelIBLClearCoat: f32=fresnelSchlickGGX(clearCoatNdotV,uniforms.vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnelIBLClearCoat*=clearCoatIntensity;outParams.conservationFactor=(1.-fresnelIBLClearCoat);
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
outParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);
#endif
return outParams;}
#endif
`;C.IncludesShadersStoreWGSL[L_]||(C.IncludesShadersStoreWGSL[L_]=yP);const N_="pbrBlockIridescence",MP=`struct iridescenceOutParams
{iridescenceIntensity: f32,
iridescenceIOR: f32,
iridescenceThickness: f32,
specularEnvironmentR0: vec3f};
#ifdef IRIDESCENCE
fn iridescenceBlock(
vIridescenceParams: vec4f
,viewAngle_: f32
,specularEnvironmentR0: vec3f
#ifdef IRIDESCENCE_TEXTURE
,iridescenceMapData: vec2f
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
,iridescenceThicknessMapData: vec2f
#endif
#ifdef CLEARCOAT
,NdotVUnclamped: f32
,vClearCoatParams: vec2f
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData: vec2f
#endif
#endif
)->iridescenceOutParams
{var outParams: iridescenceOutParams;var iridescenceIntensity: f32=vIridescenceParams.x;var iridescenceIOR: f32=vIridescenceParams.y;var iridescenceThicknessMin: f32=vIridescenceParams.z;var iridescenceThicknessMax: f32=vIridescenceParams.w;var iridescenceThicknessWeight: f32=1.;var viewAngle=viewAngle_;
#ifdef IRIDESCENCE_TEXTURE
iridescenceIntensity*=iridescenceMapData.x;
#endif
#if defined(IRIDESCENCE_THICKNESS_TEXTURE)
iridescenceThicknessWeight=iridescenceThicknessMapData.g;
#endif
var iridescenceThickness: f32=mix(iridescenceThicknessMin,iridescenceThicknessMax,iridescenceThicknessWeight);var topIor: f32=1.; 
#ifdef CLEARCOAT
var clearCoatIntensity: f32=vClearCoatParams.x;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#endif
topIor=mix(1.0,uniforms.vClearCoatRefractionParams.w-1.,clearCoatIntensity);viewAngle=sqrt(1.0+((1.0/topIor)*(1.0/topIor))*((NdotVUnclamped*NdotVUnclamped)-1.0));
#endif
var iridescenceFresnel: vec3f=evalIridescence(topIor,iridescenceIOR,viewAngle,iridescenceThickness,specularEnvironmentR0);outParams.specularEnvironmentR0=mix(specularEnvironmentR0,iridescenceFresnel,iridescenceIntensity);outParams.iridescenceIntensity=iridescenceIntensity;outParams.iridescenceThickness=iridescenceThickness;outParams.iridescenceIOR=iridescenceIOR;return outParams;}
#endif
`;C.IncludesShadersStoreWGSL[N_]||(C.IncludesShadersStoreWGSL[N_]=MP);const F_="pbrBlockSubSurface",PP=`struct subSurfaceOutParams
{specularEnvironmentReflectance: vec3f,
#ifdef SS_REFRACTION
finalRefraction: vec3f,
surfaceAlbedo: vec3f,
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha: f32,
#endif
#ifdef REFLECTION
refractionFactorForIrradiance: f32,
#endif
#endif
#ifdef SS_TRANSLUCENCY
transmittance: vec3f,
translucencyIntensity: f32,
#ifdef REFLECTION
refractionIrradiance: vec3f,
#endif
#endif
#if DEBUGMODE>0
#ifdef SS_THICKNESSANDMASK_TEXTURE
thicknessMap: vec4f,
#endif
#ifdef SS_REFRACTION
environmentRefraction: vec4f,
refractionTransmittance: vec3f
#endif
#endif
};
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#define pbr_inline
fn sampleEnvironmentRefraction(
ior: f32
,thickness: f32
,refractionLOD: f32
,normalW: vec3f
,vPositionW: vec3f
,viewDirectionW: vec3f
,view: mat4x4f
,vRefractionInfos: vec4f
,refractionMatrix: mat4x4f
,vRefractionMicrosurfaceInfos: vec4f
,alphaG: f32
#ifdef SS_REFRACTIONMAP_3D
,refractionSampler: texture_cube<f32>
,refractionSamplerSampler: sampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler: texture_cube<f32>
,refractionLowSamplerSampler: sampler
,refractionHighSampler: texture_cube<f32>
,refractionHighSamplerSampler: sampler 
#endif
#else
,refractionSampler: texture_2d<f32>
,refractionSamplerSampler: sampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler: texture_2d<f32>
,refractionLowSamplerSampler: sampler
,refractionHighSampler: texture_2d<f32>
,refractionHighSamplerSampler: sampler 
#endif
#endif
#ifdef ANISOTROPIC
,anisotropicOut: anisotropicOutParams
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo: vec2f
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,refractionPosition: vec3f
,refractionSize: vec3f
#endif
)->vec4f {var environmentRefraction: vec4f= vec4f(0.,0.,0.,0.);
#ifdef ANISOTROPIC
var refractionVector: vec3f=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,ior);
#else
var refractionVector: vec3f=refract(-viewDirectionW,normalW,ior);
#endif
#ifdef SS_REFRACTIONMAP_OPPOSITEZ
refractionVector.z*=-1.0;
#endif
#ifdef SS_REFRACTIONMAP_3D
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;var refractionCoords: vec3f=refractionVector;refractionCoords= (refractionMatrix* vec4f(refractionCoords,0)).xyz;
#else
#ifdef SS_USE_THICKNESS_AS_DEPTH
var vRefractionUVW: vec3f= (refractionMatrix*(view* vec4f(vPositionW+refractionVector*thickness,1.0))).xyz;
#else
var vRefractionUVW: vec3f= (refractionMatrix*(view* vec4f(vPositionW+refractionVector*vRefractionInfos.z,1.0))).xyz;
#endif
var refractionCoords: vec2f=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;
#endif
#ifdef LODBASEDMICROSFURACE
var lod=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;
#ifdef SS_LODINREFRACTIONALPHA
var automaticRefractionLOD: f32=UNPACK_LOD(textureSample(refractionSampler,refractionSamplerSampler,refractionCoords).a);var requestedRefractionLOD: f32=max(automaticRefractionLOD,lod);
#else
var requestedRefractionLOD: f32=lod;
#endif
#if defined(REALTIME_FILTERING) && defined(SS_REFRACTIONMAP_3D)
environmentRefraction= vec4f(radiance(alphaG,refractionSampler,refractionSamplerSampler,refractionCoords,vRefractionFilteringInfo),1.0);
#else
environmentRefraction=textureSampleLevel(refractionSampler,refractionSamplerSampler,refractionCoords,requestedRefractionLOD);
#endif
#else
var lodRefractionNormalized: f32=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));var lodRefractionNormalizedDoubled: f32=lodRefractionNormalized*2.0;var environmentRefractionMid: vec4f=textureSample(refractionSampler,refractionSamplerSampler,refractionCoords);if (lodRefractionNormalizedDoubled<1.0){environmentRefraction=mix(
textureSample(refractionHighSampler,refractionHighSamplerSampler,refractionCoords),
environmentRefractionMid,
lodRefractionNormalizedDoubled
);} else {environmentRefraction=mix(
environmentRefractionMid,
textureSample(refractionLowSampler,refractionLowSamplerSampler,refractionCoords),
lodRefractionNormalizedDoubled-1.0
);}
#endif
var refraction=environmentRefraction.rgb;
#ifdef SS_RGBDREFRACTION
refraction=fromRGBD(environmentRefraction);
#endif
#ifdef SS_GAMMAREFRACTION
refraction=toLinearSpaceVec3(environmentRefraction.rgb);
#endif
return vec4f(refraction,environmentRefraction.a);}
#endif
#define pbr_inline
fn subSurfaceBlock(
vSubSurfaceIntensity: vec3f
,vThicknessParam: vec2f
,vTintColor: vec4f
,normalW: vec3f
,specularEnvironmentReflectance: vec3f
#ifdef SS_THICKNESSANDMASK_TEXTURE
,thicknessMap: vec4f
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
,refractionIntensityMap: vec4f
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
,translucencyIntensityMap: vec4f
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
,reflectionMatrix: mat4x4f
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,irradianceVector_: vec3f
#endif
#if defined(REALTIME_FILTERING)
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
,vReflectionFilteringInfo: vec2f
#ifdef IBL_CDF_FILTERING
,icdfSampler: texture_2d<f32>
,icdfSamplerSampler: sampler
#endif
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
,irradianceSampler: texture_cube<f32>
,irradianceSamplerSampler: sampler
#else
,irradianceSampler: texture_2d<f32>
,irradianceSamplerSampler: sampler
#endif
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
,surfaceAlbedo: vec3f
#endif
#ifdef SS_REFRACTION
,vPositionW: vec3f
,viewDirectionW: vec3f
,view: mat4x4f
,vRefractionInfos: vec4f
,refractionMatrix: mat4x4f
,vRefractionMicrosurfaceInfos: vec4f
,vLightingIntensity: vec4f
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
,alpha: f32
#endif
#ifdef SS_LODINREFRACTIONALPHA
,NdotVUnclamped: f32
#endif
#ifdef SS_LINEARSPECULARREFRACTION
,roughness: f32
#endif
,alphaG: f32
#ifdef SS_REFRACTIONMAP_3D
,refractionSampler: texture_cube<f32>
,refractionSamplerSampler: sampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler: texture_cube<f32>
,refractionLowSamplerSampler: sampler
,refractionHighSampler: texture_cube<f32>
,refractionHighSamplerSampler: sampler 
#endif
#else
,refractionSampler: texture_2d<f32>
,refractionSamplerSampler: sampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler: texture_2d<f32>
,refractionLowSamplerSampler: sampler
,refractionHighSampler: texture_2d<f32>
,refractionHighSamplerSampler: sampler 
#endif
#endif
#ifdef ANISOTROPIC
,anisotropicOut: anisotropicOutParams
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo: vec2f
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,refractionPosition: vec3f
,refractionSize: vec3f
#endif
#ifdef SS_DISPERSION
,dispersion: f32
#endif
#endif
#ifdef SS_TRANSLUCENCY
,vDiffusionDistance: vec3f
,vTranslucencyColor: vec4f
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
,translucencyColorMap: vec4f
#endif
#endif
)->subSurfaceOutParams
{var outParams: subSurfaceOutParams;outParams.specularEnvironmentReflectance=specularEnvironmentReflectance;
#ifdef SS_REFRACTION
var refractionIntensity: f32=vSubSurfaceIntensity.x;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
refractionIntensity*=(1.0-alpha);outParams.alpha=1.0;
#endif
#endif
#ifdef SS_TRANSLUCENCY
var translucencyIntensity: f32=vSubSurfaceIntensity.y;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
#ifdef SS_USE_GLTF_TEXTURES
var thickness: f32=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;
#else
var thickness: f32=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;
#endif
#if DEBUGMODE>0
outParams.thicknessMap=thicknessMap;
#endif
#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS)
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=thicknessMap.r;
#else
refractionIntensity*=thicknessMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS)
#ifdef SS_USE_GLTF_TEXTURES
translucencyIntensity*=thicknessMap.a;
#else
translucencyIntensity*=thicknessMap.b;
#endif
#endif
#else
var thickness: f32=vThicknessParam.y;
#endif
#if defined(SS_REFRACTION) && defined(SS_REFRACTIONINTENSITY_TEXTURE)
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=refractionIntensityMap.r;
#else
refractionIntensity*=refractionIntensityMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCYINTENSITY_TEXTURE)
#ifdef SS_USE_GLTF_TEXTURES
translucencyIntensity*=translucencyIntensityMap.a;
#else
translucencyIntensity*=translucencyIntensityMap.b;
#endif
#endif
#ifdef SS_TRANSLUCENCY
thickness=maxEps(thickness);var translucencyColor: vec4f=vTranslucencyColor;
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
translucencyColor*=translucencyColorMap;
#endif
var transmittance: vec3f=transmittanceBRDF_Burley(translucencyColor.rgb,vDiffusionDistance,thickness);transmittance*=translucencyIntensity;outParams.transmittance=transmittance;outParams.translucencyIntensity=translucencyIntensity;
#endif
#ifdef SS_REFRACTION
var environmentRefraction: vec4f= vec4f(0.,0.,0.,0.);
#ifdef SS_HAS_THICKNESS
var ior: f32=vRefractionInfos.y;
#else
var ior: f32=vRefractionMicrosurfaceInfos.w;
#endif
#ifdef SS_LODINREFRACTIONALPHA
var refractionAlphaG: f32=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));var refractionLOD: f32=getLodFromAlphaGNdotV(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);
#elif defined(SS_LINEARSPECULARREFRACTION)
var refractionRoughness: f32=alphaG;refractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));var refractionLOD: f32=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);
#else
var refractionAlphaG: f32=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));var refractionLOD: f32=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);
#endif
var refraction_ior: f32=vRefractionInfos.y;
#ifdef SS_DISPERSION
var realIOR: f32=1.0/refraction_ior;var iorDispersionSpread: f32=0.04*dispersion*(realIOR-1.0);var iors: vec3f= vec3f(1.0/(realIOR-iorDispersionSpread),refraction_ior,1.0/(realIOR+iorDispersionSpread));for (var i: i32=0; i<3; i++) {refraction_ior=iors[i];
#endif
var envSample: vec4f=sampleEnvironmentRefraction(refraction_ior,thickness,refractionLOD,normalW,vPositionW,viewDirectionW,view,vRefractionInfos,refractionMatrix,vRefractionMicrosurfaceInfos,alphaG
#ifdef SS_REFRACTIONMAP_3D
,refractionSampler
,refractionSamplerSampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler
,refractionLowSamplerSampler
,refractionHighSampler
,refractionHighSamplerSampler
#endif
#else
,refractionSampler
,refractionSamplerSampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler
,refractionLowSamplerSampler
,refractionHighSampler
,refractionHighSamplerSampler
#endif
#endif
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,refractionPosition
,refractionSize
#endif
);
#ifdef SS_DISPERSION
environmentRefraction[i]=envSample[i];}
#else
environmentRefraction=envSample;
#endif
environmentRefraction=vec4f(environmentRefraction.rgb*vRefractionInfos.x,environmentRefraction.a);
#endif
#ifdef SS_REFRACTION
var refractionTransmittance: vec3f= vec3f(refractionIntensity);
#ifdef SS_THICKNESSANDMASK_TEXTURE
var volumeAlbedo: vec3f=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambertVec3(volumeAlbedo,thickness);
#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)
var maxChannel: f32=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);var volumeAlbedo: vec3f=saturateVec3(maxChannel*surfaceAlbedo);environmentRefraction=vec4f(environmentRefraction.rgb*volumeAlbedo,environmentRefraction.a);
#else
var volumeAlbedo: vec3f=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambertVec3(volumeAlbedo,vThicknessParam.y);
#endif
#ifdef SS_ALBEDOFORREFRACTIONTINT
environmentRefraction=vec4f(environmentRefraction.rgb*surfaceAlbedo.rgb,environmentRefraction.a);
#endif
outParams.surfaceAlbedo=surfaceAlbedo*(1.-refractionIntensity);
#ifdef REFLECTION
outParams.refractionFactorForIrradiance=(1.-refractionIntensity);
#endif
#ifdef UNUSED_MULTIPLEBOUNCES
var bounceSpecularEnvironmentReflectance: vec3f=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);outParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,refractionIntensity);
#endif
refractionTransmittance*=1.0-max(outParams.specularEnvironmentReflectance.r,max(outParams.specularEnvironmentReflectance.g,outParams.specularEnvironmentReflectance.b));
#if DEBUGMODE>0
outParams.refractionTransmittance=refractionTransmittance;
#endif
outParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;
#if DEBUGMODE>0
outParams.environmentRefraction=environmentRefraction;
#endif
#endif
#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)
#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)
var irradianceVector: vec3f= (reflectionMatrix* vec4f(normalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#else
var irradianceVector: vec3f=irradianceVector_;
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP)
#if defined(REALTIME_FILTERING)
var refractionIrradiance: vec3f=irradiance(reflectionSampler,reflectionSamplerSampler,-irradianceVector,vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,icdfSampler
,icdfSamplerSampler
#endif
);
#else
var refractionIrradiance: vec3f=computeEnvironmentIrradiance(-irradianceVector);
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
var irradianceCoords: vec3f=irradianceVector;
#else
var irradianceCoords: vec2f=irradianceVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
irradianceCoords/=irradianceVector.z;
#endif
irradianceCoords.y=1.0-irradianceCoords.y;
#endif
var temp: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,-irradianceCoords);var refractionIrradiance=temp.rgb;
#ifdef RGBDREFLECTION
refractionIrradiance=fromRGBD(temp).rgb;
#endif
#ifdef GAMMAREFLECTION
refractionIrradiance=toLinearSpaceVec3(refractionIrradiance);
#endif
#else
var refractionIrradiance: vec3f= vec3f(0.);
#endif
refractionIrradiance*=transmittance;
#ifdef SS_ALBEDOFORTRANSLUCENCYTINT
refractionIrradiance*=surfaceAlbedo.rgb;
#endif
outParams.refractionIrradiance=refractionIrradiance;
#endif
return outParams;}
#endif
`;C.IncludesShadersStoreWGSL[F_]||(C.IncludesShadersStoreWGSL[F_]=PP);const w_="pbrBlockNormalGeometric",OP=`var viewDirectionW: vec3f=normalize(scene.vEyePosition.xyz-input.vPositionW);
#ifdef NORMAL
var normalW: vec3f=normalize(input.vNormalW);
#else
var normalW: vec3f=normalize(cross(dpdx(input.vPositionW),dpdy(input.vPositionW)))*scene.vEyePosition.w;
#endif
var geometricNormalW: vec3f=normalW;
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
geometricNormalW=select(-geometricNormalW,geometricNormalW,fragmentInputs.frontFacing);
#endif
`;C.IncludesShadersStoreWGSL[w_]||(C.IncludesShadersStoreWGSL[w_]=OP);const B_="pbrBlockNormalFinal",DP=`#if defined(FORCENORMALFORWARD) && defined(NORMAL)
var faceNormal: vec3f=normalize(cross(dpdx(fragmentInputs.vPositionW),dpdy(fragmentInputs.vPositionW)))*scene.vEyePosition.w;
#if defined(TWOSIDEDLIGHTING)
faceNormal=select(-faceNormal,faceNormal,fragmentInputs.frontFacing);
#endif
normalW*=sign(dot(normalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
normalW=select(-normalW,normalW,fragmentInputs.frontFacing);
#endif
`;C.IncludesShadersStoreWGSL[B_]||(C.IncludesShadersStoreWGSL[B_]=DP);const U_="pbrBlockLightmapInit",LP=`#ifdef LIGHTMAP
var lightmapColor: vec4f=textureSample(lightmapSampler,lightmapSamplerSampler,fragmentInputs.vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor=vec4f(fromRGBD(lightmapColor),lightmapColor.a);
#endif
#ifdef GAMMALIGHTMAP
lightmapColor=vec4f(toLinearSpaceVec3(lightmapColor.rgb),lightmapColor.a);
#endif
lightmapColor=vec4f(lightmapColor.rgb*uniforms.vLightmapInfos.y,lightmapColor.a);
#endif
`;C.IncludesShadersStoreWGSL[U_]||(C.IncludesShadersStoreWGSL[U_]=LP);const V_="pbrBlockGeometryInfo",NP=`var NdotVUnclamped: f32=dot(normalW,viewDirectionW);var NdotV: f32=absEps(NdotVUnclamped);var alphaG: f32=convertRoughnessToAverageSlope(roughness);var AARoughnessFactors: vec2f=getAARoughnessFactors(normalW.xyz);
#ifdef SPECULARAA
alphaG+=AARoughnessFactors.y;
#endif
#if defined(ENVIRONMENTBRDF)
var environmentBrdf: vec3f=getBRDFLookup(NdotV,roughness);
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
#ifdef AMBIENTINGRAYSCALE
var ambientMonochrome: f32=aoOut.ambientOcclusionColor.r;
#else
var ambientMonochrome: f32=getLuminance(aoOut.ambientOcclusionColor);
#endif
var seo: f32=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
var eho: f32=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);
#endif
#endif
#endif
#endif
`;C.IncludesShadersStoreWGSL[V_]||(C.IncludesShadersStoreWGSL[V_]=NP);const G_="pbrBlockReflectance0",FP=`var reflectance: f32=max(max(reflectivityOut.surfaceReflectivityColor.r,reflectivityOut.surfaceReflectivityColor.g),reflectivityOut.surfaceReflectivityColor.b);var specularEnvironmentR0: vec3f=reflectivityOut.surfaceReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
var specularEnvironmentR90: vec3f= vec3f(metallicReflectanceFactors.a);
#else 
var specularEnvironmentR90: vec3f= vec3f(1.0,1.0,1.0);
#endif
#ifdef ALPHAFRESNEL
var reflectance90: f32=fresnelGrazingReflectance(reflectance);specularEnvironmentR90=specularEnvironmentR90*reflectance90;
#endif
`;C.IncludesShadersStoreWGSL[G_]||(C.IncludesShadersStoreWGSL[G_]=FP);const k_="pbrBlockReflectance",wP=`#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
var specularEnvironmentReflectance: vec3f=getReflectanceFromBRDFWithEnvLookup(clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,environmentBrdf);
#ifdef RADIANCEOCCLUSION
specularEnvironmentReflectance*=seo;
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
specularEnvironmentReflectance*=eho;
#endif
#endif
#endif
#else
var specularEnvironmentReflectance: vec3f=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));
#endif
#ifdef CLEARCOAT
specularEnvironmentReflectance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
specularEnvironmentReflectance*=clearcoatOut.absorption;
#endif
#endif
`;C.IncludesShadersStoreWGSL[k_]||(C.IncludesShadersStoreWGSL[k_]=wP);const W_="pbrBlockDirectLighting",BP=`var diffuseBase: vec3f=vec3f(0.,0.,0.);
#ifdef SPECULARTERM
var specularBase: vec3f=vec3f(0.,0.,0.);
#endif
#ifdef CLEARCOAT
var clearCoatBase: vec3f=vec3f(0.,0.,0.);
#endif
#ifdef SHEEN
var sheenBase: vec3f=vec3f(0.,0.,0.);
#endif
var preInfo: preLightingInfo;var info: lightingInfo;var shadow: f32=1.; 
var aggShadow: f32=0.;var numLights: f32=0.;
#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
var absorption: vec3f=vec3f(0.);
#endif
`;C.IncludesShadersStoreWGSL[W_]||(C.IncludesShadersStoreWGSL[W_]=BP);const X_="pbrBlockFinalLitComponents",UP=`aggShadow=aggShadow/numLights;
#if defined(ENVIRONMENTBRDF)
#ifdef MS_BRDF_ENERGY_CONSERVATION
var energyConservationFactor: vec3f=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);
#endif
#endif
#ifndef METALLICWORKFLOW
#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION
surfaceAlbedo=(1.-reflectance)*surfaceAlbedo.rgb;
#endif
#endif
#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)
surfaceAlbedo=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;
#endif
#ifdef REFLECTION
var finalIrradiance: vec3f=reflectionOut.environmentIrradiance;
#if defined(CLEARCOAT)
finalIrradiance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
finalIrradiance*=clearcoatOut.absorption;
#endif
#endif
finalIrradiance*=surfaceAlbedo.rgb;
#if defined(SS_REFRACTION)
finalIrradiance*=subSurfaceOut.refractionFactorForIrradiance;
#endif
#if defined(SS_TRANSLUCENCY)
finalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);finalIrradiance+=subSurfaceOut.refractionIrradiance;
#endif
finalIrradiance*=uniforms.vLightingIntensity.z;finalIrradiance*=aoOut.ambientOcclusionColor;
#endif
#ifdef SPECULARTERM
var finalSpecular: vec3f=specularBase;finalSpecular=max(finalSpecular,vec3f(0.0));var finalSpecularScaled: vec3f=finalSpecular*uniforms.vLightingIntensity.x*uniforms.vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalSpecularScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalSpecularScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef REFLECTION
var finalRadiance: vec3f=reflectionOut.environmentRadiance.rgb;finalRadiance*=subSurfaceOut.specularEnvironmentReflectance;var finalRadianceScaled: vec3f=finalRadiance*uniforms.vLightingIntensity.z;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalRadianceScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalRadianceScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef SHEEN
var finalSheen: vec3f=sheenBase*sheenOut.sheenColor;finalSheen=max(finalSheen,vec3f(0.0));var finalSheenScaled: vec3f=finalSheen*uniforms.vLightingIntensity.x*uniforms.vLightingIntensity.w;
#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef CLEARCOAT
var finalClearCoat: vec3f=clearCoatBase;finalClearCoat=max(finalClearCoat,vec3f(0.0));var finalClearCoatScaled: vec3f=finalClearCoat*uniforms.vLightingIntensity.x*uniforms.vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;
#ifdef CLEARCOAT_TINT
subSurfaceOut.finalRefraction*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef ALPHABLEND
var luminanceOverAlpha: f32=0.0;
#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)
luminanceOverAlpha+=getLuminance(finalRadianceScaled);
#if defined(CLEARCOAT)
luminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);
#endif
#endif
#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)
luminanceOverAlpha+=getLuminance(finalSpecularScaled);
#endif
#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)
luminanceOverAlpha+=getLuminance(finalClearCoatScaled);
#endif
#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)
alpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);
#endif
#endif
`;C.IncludesShadersStoreWGSL[X_]||(C.IncludesShadersStoreWGSL[X_]=UP);const H_="pbrBlockFinalUnlitComponents",VP=`var finalDiffuse: vec3f=diffuseBase;
#if !defined(SS_TRANSLUCENCY)
finalDiffuse*=surfaceAlbedo.rgb;
#endif
finalDiffuse=max(finalDiffuse,vec3f(0.0));finalDiffuse*=uniforms.vLightingIntensity.x;var finalAmbient: vec3f=uniforms.vAmbientColor;finalAmbient*=surfaceAlbedo.rgb;var finalEmissive: vec3f=uniforms.vEmissiveColor;
#ifdef EMISSIVE
var emissiveColorTex: vec3f=textureSample(emissiveSampler,emissiveSamplerSampler,fragmentInputs.vEmissiveUV+uvOffset).rgb;
#ifdef GAMMAEMISSIVE
finalEmissive*=toLinearSpaceVec3(emissiveColorTex.rgb);
#else
finalEmissive*=emissiveColorTex.rgb;
#endif
finalEmissive*= uniforms.vEmissiveInfos.y;
#endif
finalEmissive*=uniforms.vLightingIntensity.y;
#ifdef AMBIENT
var ambientOcclusionForDirectDiffuse: vec3f=mix( vec3f(1.),aoOut.ambientOcclusionColor,uniforms.vAmbientInfos.w);
#else
var ambientOcclusionForDirectDiffuse: vec3f=aoOut.ambientOcclusionColor;
#endif
finalAmbient*=aoOut.ambientOcclusionColor;finalDiffuse*=ambientOcclusionForDirectDiffuse;
`;C.IncludesShadersStoreWGSL[H_]||(C.IncludesShadersStoreWGSL[H_]=VP);const z_="pbrBlockFinalColorComposition",GP=`var finalColor: vec4f= vec4f(
#ifndef UNLIT
#ifdef REFLECTION
finalIrradiance +
#endif
#ifdef SPECULARTERM
finalSpecularScaled +
#endif
#ifdef SHEEN
finalSheenScaled +
#endif
#ifdef CLEARCOAT
finalClearCoatScaled +
#endif
#ifdef REFLECTION
finalRadianceScaled +
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled +
#endif
#ifdef CLEARCOAT
clearcoatOut.finalClearCoatRadianceScaled +
#endif
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction +
#endif
#endif
finalAmbient +
finalDiffuse,
alpha);
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
finalColor=vec4f(finalColor.rgb*lightmapColor.rgb,finalColor.a);
#else
finalColor=vec4f(finalColor.rgb+lightmapColor.rgb,finalColor.a);
#endif
#endif
#endif
finalColor=vec4f(finalColor.rgb+finalEmissive,finalColor.a);
#define CUSTOM_FRAGMENT_BEFORE_FOG
finalColor=max(finalColor,vec4f(0.0));
`;C.IncludesShadersStoreWGSL[z_]||(C.IncludesShadersStoreWGSL[z_]=GP);const Y_="pbrBlockImageProcessing",kP=`#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)
#if !defined(SKIPFINALCOLORCLAMP)
finalColor=vec4f(clamp(finalColor.rgb,vec3f(0.),vec3f(30.0)),finalColor.a);
#endif
#else
finalColor=applyImageProcessing(finalColor);
#endif
finalColor=vec4f(finalColor.rgb,finalColor.a*mesh.visibility);
#ifdef PREMULTIPLYALPHA
finalColor=vec4f(finalColor.rgb*finalColor.a,finalColor.a);;
#endif
`;C.IncludesShadersStoreWGSL[Y_]||(C.IncludesShadersStoreWGSL[Y_]=kP);const K_="pbrBlockPrePass",WP=`var writeGeometryInfo: f32=select(0.0,1.0,finalColor.a>ALPHATESTVALUE);var fragData: array<vec4<f32>,SCENE_MRT_COUNT>;
#ifdef PREPASS_POSITION
fragData[PREPASS_POSITION_INDEX]= vec4f(fragmentInputs.vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_LOCAL_POSITION
fragData[PREPASS_LOCAL_POSITION_INDEX]=vec4f(fragmentInputs.vPosition,writeGeometryInfo);
#endif
#ifdef PREPASS_VELOCITY
var a: vec2f=(fragmentInputs.vCurrentPosition.xy/fragmentInputs.vCurrentPosition.w)*0.5+0.5;var b: vec2f=(fragmentInputs.vPreviousPosition.xy/fragmentInputs.vPreviousPosition.w)*0.5+0.5;var velocity: vec2f=abs(a-b);velocity= vec2f(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;fragData[PREPASS_VELOCITY_INDEX]= vec4f(velocity,0.0,writeGeometryInfo);
#elif defined(PREPASS_VELOCITY_LINEAR)
var velocity : vec2f=vec2f(0.5)*((fragmentInputs.vPreviousPosition.xy/fragmentInputs.vPreviousPosition.w) -
(fragmentInputs.vCurrentPosition.xy/fragmentInputs.vCurrentPosition.w));fragData[PREPASS_VELOCITY_LINEAR_INDEX]=vec4f(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO
fragData[PREPASS_ALBEDO_INDEX]=vec4f(surfaceAlbedo,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
var sqAlbedo : vec3f=sqrt(surfaceAlbedo); 
#endif
#ifdef PREPASS_IRRADIANCE
var irradiance : vec3f=finalDiffuse;
#ifndef UNLIT
#ifdef REFLECTION
irradiance+=finalIrradiance;
#endif
#endif
#ifdef SS_SCATTERING
#ifdef PREPASS_COLOR
fragData[PREPASS_COLOR_INDEX]=vec4f(finalColor.rgb-irradiance,finalColor.a); 
#endif
irradiance/=sqAlbedo;fragData[PREPASS_IRRADIANCE_INDEX]=vec4f(clamp(irradiance,vec3f(0.),vec3f(1.)),writeGeometryInfo*uniforms.scatteringDiffusionProfile/255.); 
#else
#ifdef PREPASS_COLOR
fragData[PREPASS_COLOR_INDEX]=finalColor; 
#endif
fragData[PREPASS_IRRADIANCE_INDEX]=vec4f(clamp(irradiance,vec3f(0.),vec3f(1.)),writeGeometryInfo); 
#endif
#elif defined(PREPASS_COLOR)
fragData[PREPASS_COLOR_INDEX]=vec4f(finalColor.rgb,finalColor.a);
#endif
#ifdef PREPASS_DEPTH
fragData[PREPASS_DEPTH_INDEX]=vec4f(fragmentInputs.vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_SCREENSPACE_DEPTH
fragData[PREPASS_SCREENSPACE_DEPTH_INDEX]=vec4f(fragmentInputs.position.z,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMAL
#ifdef PREPASS_NORMAL_WORLDSPACE
fragData[PREPASS_NORMAL_INDEX]=vec4f(normalW,writeGeometryInfo);
#else
fragData[PREPASS_NORMAL_INDEX]=vec4f(normalize((scene.view*vec4f(normalW,0.0)).rgb),writeGeometryInfo);
#endif
#endif
#ifdef PREPASS_WORLD_NORMAL
fragData[PREPASS_WORLD_NORMAL_INDEX]=vec4f(normalW*0.5+0.5,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
fragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4f(sqAlbedo,writeGeometryInfo);
#endif
#ifdef PREPASS_REFLECTIVITY
#ifndef UNLIT
fragData[PREPASS_REFLECTIVITY_INDEX]=vec4f(specularEnvironmentR0,microSurface)*writeGeometryInfo;
#else
fragData[PREPASS_REFLECTIVITY_INDEX]=vec4f(0.0,0.0,0.0,1.0)*writeGeometryInfo;
#endif
#endif
#if SCENE_MRT_COUNT>0
fragmentOutputs.fragData0=fragData[0];
#endif
#if SCENE_MRT_COUNT>1
fragmentOutputs.fragData1=fragData[1];
#endif
#if SCENE_MRT_COUNT>2
fragmentOutputs.fragData2=fragData[2];
#endif
#if SCENE_MRT_COUNT>3
fragmentOutputs.fragData3=fragData[3];
#endif
#if SCENE_MRT_COUNT>4
fragmentOutputs.fragData4=fragData[4];
#endif
#if SCENE_MRT_COUNT>5
fragmentOutputs.fragData5=fragData[5];
#endif
#if SCENE_MRT_COUNT>6
fragmentOutputs.fragData6=fragData[6];
#endif
#if SCENE_MRT_COUNT>7
fragmentOutputs.fragData7=fragData[7];
#endif
`;C.IncludesShadersStoreWGSL[K_]||(C.IncludesShadersStoreWGSL[K_]=WP);const q_="pbrDebug",XP=`#if DEBUGMODE>0
if (input.vClipSpacePosition.x/input.vClipSpacePosition.w>=uniforms.vDebugMode.x) {var color: vec3f;
#if DEBUGMODE==1
color=fragmentInputs.vPositionW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==2 && defined(NORMAL)
color=fragmentInputs.vNormalW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)
color=TBN[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)
color=TBN[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==5
color=normalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==6 && defined(MAINUV1)
color= vec3f(input.vMainUV1,0.0);
#elif DEBUGMODE==7 && defined(MAINUV2)
color= vec3f(input.vMainUV2,0.0);
#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
color=clearcoatOut.TBNClearCoat[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
color=clearcoatOut.TBNClearCoat[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==10 && defined(CLEARCOAT)
color=clearcoatOut.clearCoatNormalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==11 && defined(ANISOTROPIC)
color=anisotropicOut.anisotropicNormal;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==12 && defined(ANISOTROPIC)
color=anisotropicOut.anisotropicTangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==13 && defined(ANISOTROPIC)
color=anisotropicOut.anisotropicBitangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==20 && defined(ALBEDO)
color=albedoTexture.rgb;
#ifndef GAMMAALBEDO
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==21 && defined(AMBIENT)
color=aoOut.ambientOcclusionColorMap.rgb;
#elif DEBUGMODE==22 && defined(OPACITY)
color=opacityMap.rgb;
#elif DEBUGMODE==23 && defined(EMISSIVE)
color=emissiveColorTex.rgb;
#ifndef GAMMAEMISSIVE
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==24 && defined(LIGHTMAP)
color=lightmapColor;
#ifndef GAMMALIGHTMAP
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)
color=reflectivityOut.surfaceMetallicColorMap.rgb;
#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)
color=reflectivityOut.surfaceReflectivityColorMap.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)
color= vec3f(clearcoatOut.clearCoatMapData.rg,0.0);
#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
color=clearcoatOut.clearCoatTintMapData.rgb;
#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)
color=sheenOut.sheenMapData.rgb;
#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)
color=anisotropicOut.anisotropyMapData.rgb;
#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)
color=subSurfaceOut.thicknessMap.rgb;
#elif DEBUGMODE==32 && defined(BUMP)
color=textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV).rgb;
#elif DEBUGMODE==40 && defined(SS_REFRACTION)
color=subSurfaceOut.environmentRefraction.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==41 && defined(REFLECTION)
color=reflectionOut.environmentRadiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)
color=clearcoatOut.environmentClearCoatRadiance.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==50
color=diffuseBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==51 && defined(SPECULARTERM)
color=specularBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==52 && defined(CLEARCOAT)
color=clearCoatBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==53 && defined(SHEEN)
color=sheenBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==54 && defined(REFLECTION)
color=reflectionOut.environmentIrradiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==60
color=surfaceAlbedo.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==61
color=clearcoatOut.specularEnvironmentR0;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)
color= vec3f(reflectivityOut.metallicRoughness.r);
#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)
color=reflectivityOut.metallicF0;
#elif DEBUGMODE==63
color= vec3f(roughness);
#elif DEBUGMODE==64
color= vec3f(alphaG);
#elif DEBUGMODE==65
color= vec3f(NdotV);
#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
color=clearcoatOut.clearCoatColor;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==67 && defined(CLEARCOAT)
color= vec3f(clearcoatOut.clearCoatRoughness);
#elif DEBUGMODE==68 && defined(CLEARCOAT)
color= vec3f(clearcoatOut.clearCoatNdotV);
#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)
color=subSurfaceOut.transmittance;
#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)
color=subSurfaceOut.refractionTransmittance;
#elif DEBUGMODE==72
color= vec3f(microSurface);
#elif DEBUGMODE==73
color=uniforms.vAlbedoColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==74 && !defined(METALLICWORKFLOW)
color=uniforms.vReflectivityColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==75
color=uniforms.vEmissiveColor;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)
color= vec3f(seo);
#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
color= vec3f(eho);
#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)
color= vec3f(energyConservationFactor);
#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
color=specularEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
color=clearcoatOut.clearCoatEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)
color=sheenOut.sheenEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==86 && defined(ALPHABLEND)
color= vec3f(luminanceOverAlpha);
#elif DEBUGMODE==87
color= vec3f(alpha);
#elif DEBUGMODE==88 && defined(ALBEDO)
color= vec3f(albedoTexture.a);
#elif DEBUGMODE==89
color=aoOut.ambientOcclusionColor;
#else
var stripeWidth: f32=30.;var stripePos: f32=abs(floor(input.position.x/stripeWidth));var whichColor: f32=((stripePos)%(2.));var color1: vec3f= vec3f(.6,.2,.2);var color2: vec3f= vec3f(.3,.1,.1);color=mix(color1,color2,whichColor);
#endif
color*=uniforms.vDebugMode.y;
#ifdef DEBUGMODE_NORMALIZE
color=normalize(color)*0.5+0.5;
#endif
#ifdef DEBUGMODE_GAMMA
color=toGammaSpaceVec3(color);
#endif
fragmentOutputs.color=vec4f(color,1.0);
#ifdef PREPASS
fragmentOutputs.fragData0=toLinearSpaceVec3(color); 
fragmentOutputs.fragData1=vec4f(0.,0.,0.,0.); 
#endif
#ifdef DEBUGMODE_FORCERETURN
return fragmentOutputs;
#endif
}
#endif
`;C.IncludesShadersStoreWGSL[q_]||(C.IncludesShadersStoreWGSL[q_]=XP);const Hl="pbrPixelShader",YE=`#define CUSTOM_FRAGMENT_BEGIN
#include<prePassDeclaration>[SCENE_MRT_COUNT]
#include<oitDeclaration>
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE
#endif
#include<pbrUboDeclaration>
#include<pbrFragmentExtraDeclaration>
#include<lightUboDeclaration>[0..maxSimultaneousLights]
#include<pbrFragmentSamplersDeclaration>
#include<imageProcessingDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#include<helperFunctions>
#include<subSurfaceScatteringFunctions>
#include<importanceSampling>
#include<pbrHelperFunctions>
#include<imageProcessingFunctions>
#include<shadowsFragmentFunctions>
#include<harmonicsFunctions>
#include<pbrDirectLightingSetupFunctions>
#include<pbrDirectLightingFalloffFunctions>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
#include<pbrDirectLightingFunctions>
#include<pbrIBLFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#ifdef REFLECTION
#include<reflectionFunction>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
#include<pbrBlockAlbedoOpacity>
#include<pbrBlockReflectivity>
#include<pbrBlockAmbientOcclusion>
#include<pbrBlockAlphaFresnel>
#include<pbrBlockAnisotropic>
#include<pbrBlockReflection>
#include<pbrBlockSheen>
#include<pbrBlockClearcoat>
#include<pbrBlockIridescence>
#include<pbrBlockSubSurface>
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#include<pbrBlockNormalGeometric>
#include<bumpFragment>
#include<pbrBlockNormalFinal>
var albedoOpacityOut: albedoOpacityOutParams;
#ifdef ALBEDO
var albedoTexture: vec4f=textureSample(albedoSampler,albedoSamplerSampler,fragmentInputs.vAlbedoUV+uvOffset);
#endif
#ifdef BASEWEIGHT
var baseWeightTexture: vec4f=textureSample(baseWeightSampler,baseWeightSamplerSampler,fragmentInputs.vBaseWeightUV+uvOffset);
#endif
#ifdef OPACITY
var opacityMap: vec4f=textureSample(opacitySampler,opacitySamplerSampler,fragmentInputs.vOpacityUV+uvOffset);
#endif
#ifdef DECAL
var decalColor: vec4f=textureSample(decalSampler,decalSamplerSampler,fragmentInputs.vDecalUV+uvOffset);
#endif
albedoOpacityOut=albedoOpacityBlock(
uniforms.vAlbedoColor
#ifdef ALBEDO
,albedoTexture
,uniforms.vAlbedoInfos
#endif
,uniforms.baseWeight
#ifdef BASEWEIGHT
,baseWeightTexture
,uniforms.vBaseWeightInfos
#endif
#ifdef OPACITY
,opacityMap
,uniforms.vOpacityInfos
#endif
#ifdef DETAIL
,detailColor
,uniforms.vDetailInfos
#endif
#ifdef DECAL
,decalColor
,uniforms.vDecalInfos
#endif
);var surfaceAlbedo: vec3f=albedoOpacityOut.surfaceAlbedo;var alpha: f32=albedoOpacityOut.alpha;
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
#include<depthPrePass>
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
var aoOut: ambientOcclusionOutParams;
#ifdef AMBIENT
var ambientOcclusionColorMap: vec3f=textureSample(ambientSampler,ambientSamplerSampler,fragmentInputs.vAmbientUV+uvOffset).rgb;
#endif
aoOut=ambientOcclusionBlock(
#ifdef AMBIENT
ambientOcclusionColorMap,
uniforms.vAmbientInfos
#endif
);
#include<pbrBlockLightmapInit>
#ifdef UNLIT
var diffuseBase: vec3f= vec3f(1.,1.,1.);
#else
var baseColor: vec3f=surfaceAlbedo;var reflectivityOut: reflectivityOutParams;
#if defined(REFLECTIVITY)
var surfaceMetallicOrReflectivityColorMap: vec4f=textureSample(reflectivitySampler,reflectivitySamplerSampler,fragmentInputs.vReflectivityUV+uvOffset);var baseReflectivity: vec4f=surfaceMetallicOrReflectivityColorMap;
#ifndef METALLICWORKFLOW
#ifdef REFLECTIVITY_GAMMA
surfaceMetallicOrReflectivityColorMap=toLinearSpaceVec4(surfaceMetallicOrReflectivityColorMap);
#endif
surfaceMetallicOrReflectivityColorMap=vec4f(surfaceMetallicOrReflectivityColorMap.rgb*uniforms.vReflectivityInfos.y,surfaceMetallicOrReflectivityColorMap.a);
#endif
#endif
#if defined(MICROSURFACEMAP)
var microSurfaceTexel: vec4f=textureSample(microSurfaceSampler,microSurfaceSamplerSampler,fragmentInputs.vMicroSurfaceSamplerUV+uvOffset)*uniforms.vMicroSurfaceSamplerInfos.y;
#endif
#ifdef METALLICWORKFLOW
var metallicReflectanceFactors: vec4f=uniforms.vMetallicReflectanceFactors;
#ifdef REFLECTANCE
var reflectanceFactorsMap: vec4f=textureSample(reflectanceSampler,reflectanceSamplerSampler,fragmentInputs.vReflectanceUV+uvOffset);
#ifdef REFLECTANCE_GAMMA
reflectanceFactorsMap=toLinearSpaceVec4(reflectanceFactorsMap);
#endif
metallicReflectanceFactors=vec4f(metallicReflectanceFactors.rgb*reflectanceFactorsMap.rgb,metallicReflectanceFactors.a);
#endif
#ifdef METALLIC_REFLECTANCE
var metallicReflectanceFactorsMap: vec4f=textureSample(metallicReflectanceSampler,metallicReflectanceSamplerSampler,fragmentInputs.vMetallicReflectanceUV+uvOffset);
#ifdef METALLIC_REFLECTANCE_GAMMA
metallicReflectanceFactorsMap=toLinearSpaceVec4(metallicReflectanceFactorsMap);
#endif
#ifndef METALLIC_REFLECTANCE_USE_ALPHA_ONLY
metallicReflectanceFactors=vec4f(metallicReflectanceFactors.rgb*metallicReflectanceFactorsMap.rgb,metallicReflectanceFactors.a);
#endif
metallicReflectanceFactors*=metallicReflectanceFactorsMap.a;
#endif
#endif
reflectivityOut=reflectivityBlock(
uniforms.vReflectivityColor
#ifdef METALLICWORKFLOW
,surfaceAlbedo
,metallicReflectanceFactors
#endif
#ifdef REFLECTIVITY
,uniforms.vReflectivityInfos
,surfaceMetallicOrReflectivityColorMap
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
,aoOut.ambientOcclusionColor
#endif
#ifdef MICROSURFACEMAP
,microSurfaceTexel
#endif
#ifdef DETAIL
,detailColor
,uniforms.vDetailInfos
#endif
);var microSurface: f32=reflectivityOut.microSurface;var roughness: f32=reflectivityOut.roughness;
#ifdef METALLICWORKFLOW
surfaceAlbedo=reflectivityOut.surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
aoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;
#endif
#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
var alphaFresnelOut: alphaFresnelOutParams;alphaFresnelOut=alphaFresnelBlock(
normalW,
viewDirectionW,
alpha,
microSurface
);alpha=alphaFresnelOut.alpha;
#endif
#endif
#include<pbrBlockGeometryInfo>
#ifdef ANISOTROPIC
var anisotropicOut: anisotropicOutParams;
#ifdef ANISOTROPIC_TEXTURE
var anisotropyMapData: vec3f=textureSample(anisotropySampler,anisotropySamplerSampler,fragmentInputs.vAnisotropyUV+uvOffset).rgb*uniforms.vAnisotropyInfos.y;
#endif
anisotropicOut=anisotropicBlock(
uniforms.vAnisotropy,
roughness,
#ifdef ANISOTROPIC_TEXTURE
anisotropyMapData,
#endif
TBN,
normalW,
viewDirectionW
);
#endif
#ifdef REFLECTION
var reflectionOut: reflectionOutParams;
#ifndef USE_CUSTOM_REFLECTION
reflectionOut=reflectionBlock(
fragmentInputs.vPositionW
,normalW
,alphaG
,uniforms.vReflectionMicrosurfaceInfos
,uniforms.vReflectionInfos
,uniforms.vReflectionColor
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,roughness
#endif
,reflectionSampler
,reflectionSamplerSampler
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,fragmentInputs.vEnvironmentIrradiance
#endif
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
,uniforms.reflectionMatrix
#endif
#ifdef USEIRRADIANCEMAP
,irradianceSampler
,irradianceSamplerSampler
#endif
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,uniforms.vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,icdfSampler
,icdfSamplerSampler
#endif
#endif
);
#else
#define CUSTOM_REFLECTION
#endif
#endif
#include<pbrBlockReflectance0>
#ifdef SHEEN
var sheenOut: sheenOutParams;
#ifdef SHEEN_TEXTURE
var sheenMapData: vec4f=textureSample(sheenSampler,sheenSamplerSampler,fragmentInputs.vSheenUV+uvOffset);
#endif
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
var sheenMapRoughnessData: vec4f=textureSample(sheenRoughnessSampler,sheenRoughnessSamplerSampler,fragmentInputs.vSheenRoughnessUV+uvOffset)*uniforms.vSheenInfos.w;
#endif
sheenOut=sheenBlock(
uniforms.vSheenColor
#ifdef SHEEN_ROUGHNESS
,uniforms.vSheenRoughness
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
,sheenMapRoughnessData
#endif
#endif
,roughness
#ifdef SHEEN_TEXTURE
,sheenMapData
,uniforms.vSheenInfos.y
#endif
,reflectance
#ifdef SHEEN_LINKWITHALBEDO
,baseColor
,surfaceAlbedo
#endif
#ifdef ENVIRONMENTBRDF
,NdotV
,environmentBrdf
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,AARoughnessFactors
,uniforms.vReflectionMicrosurfaceInfos
,uniforms.vReflectionInfos
,uniforms.vReflectionColor
,uniforms.vLightingIntensity
,reflectionSampler
,reflectionSamplerSampler
,reflectionOut.reflectionCoords
,NdotVUnclamped
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
,seo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
,eho
#endif
#endif
);
#ifdef SHEEN_LINKWITHALBEDO
surfaceAlbedo=sheenOut.surfaceAlbedo;
#endif
#endif
#ifdef CLEARCOAT
#ifdef CLEARCOAT_TEXTURE
var clearCoatMapData: vec2f=textureSample(clearCoatSampler,clearCoatSamplerSampler,fragmentInputs.vClearCoatUV+uvOffset).rg*uniforms.vClearCoatInfos.y;
#endif
#endif
#ifdef IRIDESCENCE
var iridescenceOut: iridescenceOutParams;
#ifdef IRIDESCENCE_TEXTURE
var iridescenceMapData: vec2f=textureSample(iridescenceSampler,iridescenceSamplerSampler,fragmentInputs.vIridescenceUV+uvOffset).rg*uniforms.vIridescenceInfos.y;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
var iridescenceThicknessMapData: vec2f=textureSample(iridescenceThicknessSampler,iridescenceThicknessSamplerSampler,fragmentInputs.vIridescenceThicknessUV+uvOffset).rg*uniforms.vIridescenceInfos.w;
#endif
iridescenceOut=iridescenceBlock(
uniforms.vIridescenceParams
,NdotV
,specularEnvironmentR0
#ifdef IRIDESCENCE_TEXTURE
,iridescenceMapData
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
,iridescenceThicknessMapData
#endif
#ifdef CLEARCOAT
,NdotVUnclamped
,uniforms.vClearCoatParams
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData
#endif
#endif
);var iridescenceIntensity: f32=iridescenceOut.iridescenceIntensity;specularEnvironmentR0=iridescenceOut.specularEnvironmentR0;
#endif
var clearcoatOut: clearcoatOutParams;
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
var clearCoatMapRoughnessData: vec4f=textureSample(clearCoatRoughnessSampler,clearCoatRoughnessSamplerSampler,fragmentInputs.vClearCoatRoughnessUV+uvOffset)*uniforms.vClearCoatInfos.w;
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
var clearCoatTintMapData: vec4f=textureSample(clearCoatTintSampler,clearCoatTintSamplerSampler,fragmentInputs.vClearCoatTintUV+uvOffset);
#endif
#ifdef CLEARCOAT_BUMP
var clearCoatBumpMapData: vec4f=textureSample(clearCoatBumpSampler,clearCoatBumpSamplerSampler,fragmentInputs.vClearCoatBumpUV+uvOffset);
#endif
clearcoatOut=clearcoatBlock(
fragmentInputs.vPositionW
,geometricNormalW
,viewDirectionW
,uniforms.vClearCoatParams
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
,clearCoatMapRoughnessData
#endif
,specularEnvironmentR0
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData
#endif
#ifdef CLEARCOAT_TINT
,uniforms.vClearCoatTintParams
,uniforms.clearCoatColorAtDistance
,uniforms.vClearCoatRefractionParams
#ifdef CLEARCOAT_TINT_TEXTURE
,clearCoatTintMapData
#endif
#endif
#ifdef CLEARCOAT_BUMP
,uniforms.vClearCoatBumpInfos
,clearCoatBumpMapData
,fragmentInputs.vClearCoatBumpUV
#if defined(TANGENT) && defined(NORMAL)
,mat3x3<f32>(input.vTBN0,input.vTBN1,input.vTBN2)
#else
,uniforms.vClearCoatTangentSpaceParams
#endif
#ifdef OBJECTSPACE_NORMALMAP
,uniforms.normalMatrix
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
,faceNormal
#endif
#ifdef REFLECTION
,uniforms.vReflectionMicrosurfaceInfos
,uniforms.vReflectionInfos
,uniforms.vReflectionColor
,uniforms.vLightingIntensity
,reflectionSampler
,reflectionSamplerSampler
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,uniforms.vReflectionFilteringInfo
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
,select(-1.,1.,fragmentInputs.frontFacing)
#endif
);
#else
clearcoatOut.specularEnvironmentR0=specularEnvironmentR0;
#endif
#include<pbrBlockReflectance>
var subSurfaceOut: subSurfaceOutParams;
#ifdef SUBSURFACE
#ifdef SS_THICKNESSANDMASK_TEXTURE
var thicknessMap: vec4f=textureSample(thicknessSampler,thicknessSamplerSampler,fragmentInputs.vThicknessUV+uvOffset);
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
var refractionIntensityMap: vec4f=textureSample(refractionIntensitySampler,refractionIntensitySamplerSampler,fragmentInputs.vRefractionIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
var translucencyIntensityMap: vec4f=textureSample(translucencyIntensitySampler,translucencyIntensitySamplerSampler,fragmentInputs.vTranslucencyIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
var translucencyColorMap: vec4f=textureSample(translucencyColorSampler,translucencyColorSamplerSampler,fragmentInputs.vTranslucencyColorUV+uvOffset);
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE_GAMMA
translucencyColorMap=toLinearSpaceVec4(translucencyColorMap);
#endif
#endif
subSurfaceOut=subSurfaceBlock(
uniforms.vSubSurfaceIntensity
,uniforms.vThicknessParam
,uniforms.vTintColor
,normalW
,specularEnvironmentReflectance
#ifdef SS_THICKNESSANDMASK_TEXTURE
,thicknessMap
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
,refractionIntensityMap
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
,translucencyIntensityMap
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
,uniforms.reflectionMatrix
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,reflectionOut.irradianceVector
#endif
#if defined(REALTIME_FILTERING)
,reflectionSampler
,reflectionSamplerSampler
,vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,icdfSampler
,icdfSamplerSampler
#endif
#endif
#endif
#ifdef USEIRRADIANCEMAP
,irradianceSampler
,irradianceSamplerSampler
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
,surfaceAlbedo
#endif
#ifdef SS_REFRACTION
,fragmentInputs.vPositionW
,viewDirectionW
,scene.view
,uniforms.vRefractionInfos
,uniforms.refractionMatrix
,uniforms.vRefractionMicrosurfaceInfos
,uniforms.vLightingIntensity
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
,alpha
#endif
#ifdef SS_LODINREFRACTIONALPHA
,NdotVUnclamped
#endif
#ifdef SS_LINEARSPECULARREFRACTION
,roughness
#endif
,alphaG
,refractionSampler
,refractionSamplerSampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler
,refractionLowSamplerSampler
,refractionHighSampler
,refractionHighSamplerSampler
#endif
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,uniforms.vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,uniforms.vRefractionPosition
,uniforms.vRefractionSize
#endif
#ifdef SS_DISPERSION
,dispersion
#endif
#endif
#ifdef SS_TRANSLUCENCY
,uniforms.vDiffusionDistance
,uniforms.vTranslucencyColor
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
,translucencyColorMap
#endif
#endif
);
#ifdef SS_REFRACTION
surfaceAlbedo=subSurfaceOut.surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha=subSurfaceOut.alpha;
#endif
#endif
#else
subSurfaceOut.specularEnvironmentReflectance=specularEnvironmentReflectance;
#endif
#include<pbrBlockDirectLighting>
#include<lightFragment>[0..maxSimultaneousLights]
#include<pbrBlockFinalLitComponents>
#endif 
#include<pbrBlockFinalUnlitComponents>
#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION
#include<pbrBlockFinalColorComposition>
#include<logDepthFragment>
#include<fogFragment>(color,finalColor)
#include<pbrBlockImageProcessing>
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
#include<pbrBlockPrePass>
#endif
#if !defined(PREPASS) && !defined(ORDER_INDEPENDENT_TRANSPARENCY)
fragmentOutputs.color=finalColor;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {fragmentOutputs.frontColor=vec4f(fragmentOutputs.frontColor.rgb+finalColor.rgb*finalColor.a*alphaMultiplier,1.0-alphaMultiplier*(1.0-finalColor.a));} else {fragmentOutputs.backColor+=finalColor;}
#endif
#include<pbrDebug>
#define CUSTOM_FRAGMENT_MAIN_END
}
`;C.ShadersStoreWGSL[Hl]||(C.ShadersStoreWGSL[Hl]=YE);const HP={name:Hl,shader:YE},zP=Object.freeze(Object.defineProperty({__proto__:null,pbrPixelShaderWGSL:HP},Symbol.toStringTag,{value:"Module"})),j_="pbrVertexDeclaration",YP=`uniform mat4 view;uniform mat4 viewProjection;
#ifdef MULTIVIEW
mat4 viewProjectionR;
#endif
#ifdef ALBEDO
uniform mat4 albedoMatrix;uniform vec2 vAlbedoInfos;
#endif
#ifdef BASEWEIGHT
uniform mat4 baseWeightMatrix;uniform vec2 vBaseWeightInfos;
#endif
#ifdef AMBIENT
uniform mat4 ambientMatrix;uniform vec4 vAmbientInfos;
#endif
#ifdef OPACITY
uniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;uniform mat4 emissiveMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;
#endif
#ifdef REFLECTIVITY
uniform vec3 vReflectivityInfos;uniform mat4 reflectivityMatrix;
#endif
#ifdef METALLIC_REFLECTANCE
uniform vec2 vMetallicReflectanceInfos;uniform mat4 metallicReflectanceMatrix;
#endif
#ifdef REFLECTANCE
uniform vec2 vReflectanceInfos;uniform mat4 reflectanceMatrix;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;uniform mat4 microSurfaceSamplerMatrix;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform mat4 bumpMatrix;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;
#endif
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;uniform mat4 clearCoatTintMatrix;
#endif
#endif
#ifdef IRIDESCENCE
#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)
uniform vec4 vIridescenceInfos;
#endif
#ifdef IRIDESCENCE_TEXTURE
uniform mat4 iridescenceMatrix;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
uniform mat4 iridescenceThicknessMatrix;
#endif
#endif
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;uniform mat4 anisotropyMatrix;
#endif
#endif
#ifdef SHEEN
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec4 vRefractionInfos;uniform mat4 refractionMatrix;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;uniform mat4 thicknessMatrix;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
uniform vec2 vRefractionIntensityInfos;uniform mat4 refractionIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
uniform vec2 vTranslucencyIntensityInfos;uniform mat4 translucencyIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
uniform vec2 vTranslucencyColorInfos;uniform mat4 translucencyColorMatrix;
#endif
#endif
#ifdef NORMAL
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;
#endif
#endif
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;uniform mat4 detailMatrix;
#endif
#include<decalVertexDeclaration>
#define ADDITIONAL_VERTEX_DECLARATION
`;C.IncludesShadersStore[j_]||(C.IncludesShadersStore[j_]=YP);const Z_="pbrUboDeclaration",KP=`layout(std140,column_major) uniform;uniform Material {vec2 vAlbedoInfos;vec2 vBaseWeightInfos;vec4 vAmbientInfos;vec2 vOpacityInfos;vec2 vEmissiveInfos;vec2 vLightmapInfos;vec3 vReflectivityInfos;vec2 vMicroSurfaceSamplerInfos;vec2 vReflectionInfos;vec2 vReflectionFilteringInfo;vec3 vReflectionPosition;vec3 vReflectionSize;vec3 vBumpInfos;mat4 albedoMatrix;mat4 baseWeightMatrix;mat4 ambientMatrix;mat4 opacityMatrix;mat4 emissiveMatrix;mat4 lightmapMatrix;mat4 reflectivityMatrix;mat4 microSurfaceSamplerMatrix;mat4 bumpMatrix;vec2 vTangentSpaceParams;mat4 reflectionMatrix;vec3 vReflectionColor;vec4 vAlbedoColor;float baseWeight;vec4 vLightingIntensity;vec3 vReflectionMicrosurfaceInfos;float pointSize;vec4 vReflectivityColor;vec3 vEmissiveColor;vec3 vAmbientColor;vec2 vDebugMode;vec4 vMetallicReflectanceFactors;vec2 vMetallicReflectanceInfos;mat4 metallicReflectanceMatrix;vec2 vReflectanceInfos;mat4 reflectanceMatrix;vec3 vSphericalL00;vec3 vSphericalL1_1;vec3 vSphericalL10;vec3 vSphericalL11;vec3 vSphericalL2_2;vec3 vSphericalL2_1;vec3 vSphericalL20;vec3 vSphericalL21;vec3 vSphericalL22;vec3 vSphericalX;vec3 vSphericalY;vec3 vSphericalZ;vec3 vSphericalXX_ZZ;vec3 vSphericalYY_ZZ;vec3 vSphericalZZ;vec3 vSphericalXY;vec3 vSphericalYZ;vec3 vSphericalZX;
#define ADDITIONAL_UBO_DECLARATION
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;C.IncludesShadersStore[Z_]||(C.IncludesShadersStore[Z_]=KP);const Q_="harmonicsFunctions",qP=`#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
vec3 computeEnvironmentIrradiance(vec3 normal) {return vSphericalL00
+ vSphericalL1_1*(normal.y)
+ vSphericalL10*(normal.z)
+ vSphericalL11*(normal.x)
+ vSphericalL2_2*(normal.y*normal.x)
+ vSphericalL2_1*(normal.y*normal.z)
+ vSphericalL20*((3.0*normal.z*normal.z)-1.0)
+ vSphericalL21*(normal.z*normal.x)
+ vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));}
#else
vec3 computeEnvironmentIrradiance(vec3 normal) {float Nx=normal.x;float Ny=normal.y;float Nz=normal.z;vec3 C1=vSphericalZZ.rgb;vec3 Cx=vSphericalX.rgb;vec3 Cy=vSphericalY.rgb;vec3 Cz=vSphericalZ.rgb;vec3 Cxx_zz=vSphericalXX_ZZ.rgb;vec3 Cyy_zz=vSphericalYY_ZZ.rgb;vec3 Cxy=vSphericalXY.rgb;vec3 Cyz=vSphericalYZ.rgb;vec3 Czx=vSphericalZX.rgb;vec3 a1=Cyy_zz*Ny+Cy;vec3 a2=Cyz*Nz+a1;vec3 b1=Czx*Nz+Cx;vec3 b2=Cxy*Ny+b1;vec3 b3=Cxx_zz*Nx+b2;vec3 t1=Cz *Nz+C1;vec3 t2=a2 *Ny+t1;vec3 t3=b3 *Nx+t2;return t3;}
#endif
#endif
`;C.IncludesShadersStore[Q_]||(C.IncludesShadersStore[Q_]=qP);const zl="pbrVertexShader",KE=`#define CUSTOM_VERTEX_EXTENSION
precision highp float;
#include<__decl__pbrVertex>
#define CUSTOM_VERTEX_BEGIN
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#include<uvAttributeDeclaration>[2..7]
#include<mainUVVaryingDeclaration>[1..7]
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)
#include<samplerVertexDeclaration>(_DEFINENAME_,BASEWEIGHT,_VARYINGNAME_,BaseWeight)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)
#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)
#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)
#ifdef CLEARCOAT
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)
#endif
#ifdef SUBSURFACE
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor)
#endif
varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#include<harmonicsFunctions>
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#ifdef UV2
vec2 uv2Updated=uv2;
#endif
#ifdef VERTEXCOLOR
vec4 colorUpdated=color;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);vPositionW=vec3(worldPos);
#ifdef PREPASS
#include<prePassVertex>
#endif
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
vec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
vEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}
#else
gl_Position=viewProjection*worldPos;
#endif
#if DEBUGMODE>0
vClipSpacePosition=gl_Position;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif
#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifndef UV2
vec2 uv2Updated=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#ifdef MAINUV2
vMainUV2=uv2Updated;
#endif
#include<uvVariableDeclaration>[3..7]
#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BASEWEIGHT,_VARYINGNAME_,BaseWeight,_MATRIXNAME_,baseWeight,_INFONAME_,BaseWeightInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)
#ifdef CLEARCOAT
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)
#endif
#ifdef SHEEN
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheenRoughness,_INFONAME_,SheenInfos.z)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)
#endif
#ifdef SUBSURFACE
#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_MATRIXNAME_,translucencyColor,_INFONAME_,TranslucencyColorInfos.x)
#endif
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;C.ShadersStore[zl]||(C.ShadersStore[zl]=KE);const jP={name:zl,shader:KE},ZP=Object.freeze(Object.defineProperty({__proto__:null,pbrVertexShader:jP},Symbol.toStringTag,{value:"Module"})),$_="pbrFragmentDeclaration",QP=`uniform vec4 vEyePosition;uniform vec3 vReflectionColor;uniform vec4 vAlbedoColor;uniform float baseWeight;uniform vec4 vLightingIntensity;uniform vec4 vReflectivityColor;uniform vec4 vMetallicReflectanceFactors;uniform vec3 vEmissiveColor;uniform float visibility;uniform vec3 vAmbientColor;
#ifdef ALBEDO
uniform vec2 vAlbedoInfos;
#endif
#ifdef BASEWEIGHT
uniform vec2 vBaseWeightInfos;
#endif
#ifdef AMBIENT
uniform vec4 vAmbientInfos;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;
#endif
#ifdef OPACITY
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
#endif
#ifdef REFLECTIVITY
uniform vec3 vReflectivityInfos;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(SS_REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
#ifdef REALTIME_FILTERING
uniform vec2 vReflectionFilteringInfo;
#endif
uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;uniform vec3 vReflectionSize;
#endif
#endif
#if defined(SS_REFRACTION) && defined(SS_USE_LOCAL_REFRACTIONMAP_CUBIC)
uniform vec3 vRefractionPosition;uniform vec3 vRefractionSize;
#endif
#ifdef CLEARCOAT
uniform vec2 vClearCoatParams;uniform vec4 vClearCoatRefractionParams;
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;uniform vec2 vClearCoatTangentSpaceParams;uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT
uniform vec4 vClearCoatTintParams;uniform float clearCoatColorAtDistance;
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;uniform mat4 clearCoatTintMatrix;
#endif
#endif
#endif
#ifdef IRIDESCENCE
uniform vec4 vIridescenceParams;
#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)
uniform vec4 vIridescenceInfos;
#endif
#ifdef IRIDESCENCE_TEXTURE
uniform mat4 iridescenceMatrix;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
uniform mat4 iridescenceThicknessMatrix;
#endif
#endif
#ifdef ANISOTROPIC
uniform vec3 vAnisotropy;
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;uniform mat4 anisotropyMatrix;
#endif
#endif
#ifdef SHEEN
uniform vec4 vSheenColor;
#ifdef SHEEN_ROUGHNESS
uniform float vSheenRoughness;
#endif
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec4 vRefractionMicrosurfaceInfos;uniform vec4 vRefractionInfos;uniform mat4 refractionMatrix;
#ifdef REALTIME_FILTERING
uniform vec2 vRefractionFilteringInfo;
#endif
#ifdef SS_DISPERSION
uniform float dispersion;
#endif
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;uniform mat4 thicknessMatrix;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
uniform vec2 vRefractionIntensityInfos;uniform mat4 refractionIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
uniform vec2 vTranslucencyIntensityInfos;uniform mat4 translucencyIntensityMatrix;
#endif
uniform vec2 vThicknessParam;uniform vec3 vDiffusionDistance;uniform vec4 vTintColor;uniform vec3 vSubSurfaceIntensity;uniform vec4 vTranslucencyColor;
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
uniform vec2 vTranslucencyColorInfos;uniform mat4 translucencyColorMatrix;
#endif
#endif
#ifdef PREPASS
#ifdef SS_SCATTERING
uniform float scatteringDiffusionProfile;
#endif
#endif
#if DEBUGMODE>0
uniform vec2 vDebugMode;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#include<decalFragmentDeclaration>
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;
#endif
#endif
#define ADDITIONAL_FRAGMENT_DECLARATION
`;C.IncludesShadersStore[$_]||(C.IncludesShadersStore[$_]=QP);const J_="pbrFragmentExtraDeclaration",$P=`varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
`;C.IncludesShadersStore[J_]||(C.IncludesShadersStore[J_]=$P);const ep="samplerFragmentAlternateDeclaration",JP=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying vec2 v_VARYINGNAME_UV;
#endif
#endif
`;C.IncludesShadersStore[ep]||(C.IncludesShadersStore[ep]=JP);const tp="pbrFragmentSamplersDeclaration",eO=`#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BASEWEIGHT,_VARYINGNAME_,BaseWeight,_SAMPLERNAME_,baseWeight)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)
#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef CLEARCOAT
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform sampler2D clearCoatRoughnessSampler;
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_SAMPLERNAME_,iridescence)
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_SAMPLERNAME_,iridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS)
uniform sampler2D sheenRoughnessSampler;
#endif
#endif
#ifdef ANISOTROPIC
#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform samplerCube irradianceSampler;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D reflectionSamplerLow;uniform sampler2D reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform sampler2D irradianceSampler;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#endif
#ifdef ENVIRONMENTBRDF
uniform sampler2D environmentBrdfSampler;
#endif
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
uniform sampler2D areaLightsLTC1Sampler;uniform sampler2D areaLightsLTC2Sampler;
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#ifdef SS_REFRACTIONMAP_3D
#define sampleRefraction(s,c) textureCube(s,c)
uniform samplerCube refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube refractionSamplerLow;uniform samplerCube refractionSamplerHigh;
#endif
#else
#define sampleRefraction(s,c) texture2D(s,c)
uniform sampler2D refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D refractionSamplerLow;uniform sampler2D refractionSamplerHigh;
#endif
#endif
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_SAMPLERNAME_,translucencyColor)
#endif
#ifdef IBL_CDF_FILTERING
uniform sampler2D icdfSampler;
#endif
`;C.IncludesShadersStore[tp]||(C.IncludesShadersStore[tp]=eO);const ip="subSurfaceScatteringFunctions",tO=`bool testLightingForSSS(float diffusionProfile)
{return diffusionProfile<1.;}`;C.IncludesShadersStore[ip]||(C.IncludesShadersStore[ip]=tO);const rp="importanceSampling",iO=`vec3 hemisphereCosSample(vec2 u) {float phi=2.*PI*u.x;float cosTheta2=1.-u.y;float cosTheta=sqrt(cosTheta2);float sinTheta=sqrt(1.-cosTheta2);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
vec3 hemisphereImportanceSampleDggx(vec2 u,float a) {float phi=2.*PI*u.x;float cosTheta2=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));float cosTheta=sqrt(cosTheta2);float sinTheta=sqrt(1.-cosTheta2);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
vec3 hemisphereImportanceSampleDCharlie(vec2 u,float a) { 
float phi=2.*PI*u.x;float sinTheta=pow(u.y,a/(2.*a+1.));float cosTheta=sqrt(1.-sinTheta*sinTheta);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}`;C.IncludesShadersStore[rp]||(C.IncludesShadersStore[rp]=iO);const sp="pbrHelperFunctions",rO=`#define MINIMUMVARIANCE 0.0005
float convertRoughnessToAverageSlope(float roughness)
{return square(roughness)+MINIMUMVARIANCE;}
float fresnelGrazingReflectance(float reflectance0) {float reflectance90=saturate(reflectance0*25.0);return reflectance90;}
vec2 getAARoughnessFactors(vec3 normalVector) {
#ifdef SPECULARAA
vec3 nDfdx=dFdx(normalVector.xyz);vec3 nDfdy=dFdy(normalVector.xyz);float slopeSquare=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));float geometricRoughnessFactor=pow(saturate(slopeSquare),0.333);float geometricAlphaGFactor=sqrt(slopeSquare);geometricAlphaGFactor*=0.75;return vec2(geometricRoughnessFactor,geometricAlphaGFactor);
#else
return vec2(0.);
#endif
}
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_LEGACY
vec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);float alphaB=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);return vec2(alphaT,alphaB);}
vec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy,float roughness) {vec3 anisotropicFrameDirection;if (anisotropy>=0.0) {anisotropicFrameDirection=B;} else {anisotropicFrameDirection=T;}
vec3 anisotropicFrameTangent=cross(normalize(anisotropicFrameDirection),V);vec3 anisotropicFrameNormal=cross(anisotropicFrameTangent,anisotropicFrameDirection);vec3 anisotropicNormal=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));return anisotropicNormal;}
#else
vec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=max(mix(alphaG,1.0,anisotropy*anisotropy),MINIMUMVARIANCE);float alphaB=max(alphaG,MINIMUMVARIANCE);return vec2(alphaT,alphaB);}
vec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy,float roughness) {vec3 bentNormal=cross(B,V);bentNormal=normalize(cross(bentNormal,B));float a=square(square(1.0-anisotropy*(1.0-roughness)));bentNormal=normalize(mix(bentNormal,N,a));return bentNormal;}
#endif
#endif
#if defined(CLEARCOAT) || defined(SS_REFRACTION)
vec3 cocaLambert(vec3 alpha,float distance) {return exp(-alpha*distance);}
vec3 cocaLambert(float NdotVRefract,float NdotLRefract,vec3 alpha,float thickness) {return cocaLambert(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));}
vec3 computeColorAtDistanceInMedia(vec3 color,float distance) {return -log(color)/distance;}
vec3 computeClearCoatAbsorption(float NdotVRefract,float NdotLRefract,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {vec3 clearCoatAbsorption=mix(vec3(1.0),
cocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),
clearCoatIntensity);return clearCoatAbsorption;}
#endif
#ifdef MICROSURFACEAUTOMATIC
float computeDefaultMicroSurface(float microSurface,vec3 reflectivityColor)
{const float kReflectivityNoAlphaWorkflow_SmoothnessMax=0.95;float reflectivityLuminance=getLuminance(reflectivityColor);float reflectivityLuma=sqrt(reflectivityLuminance);microSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;return microSurface;}
#endif
`;C.IncludesShadersStore[sp]||(C.IncludesShadersStore[sp]=rO);const np="pbrDirectLightingSetupFunctions",sO=`struct preLightingInfo
{vec3 lightOffset;float lightDistanceSquared;float lightDistance;float attenuation;vec3 L;vec3 H;float NdotV;float NdotLUnclamped;float NdotL;float VdotH;float roughness;
#ifdef IRIDESCENCE
float iridescenceIntensity;
#endif
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
vec3 areaLightDiffuse;
#ifdef SPECULARTERM
vec3 areaLightSpecular;vec4 areaLightFresnel;
#endif
#endif
};preLightingInfo computePointAndSpotPreLightingInfo(vec4 lightData,vec3 V,vec3 N,vec3 posW) {preLightingInfo result;result.lightOffset=lightData.xyz-posW;result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);result.lightDistance=sqrt(result.lightDistanceSquared);result.L=normalize(result.lightOffset);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}
preLightingInfo computeDirectionalPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.lightDistance=length(-lightData.xyz);result.L=normalize(-lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}
preLightingInfo computeHemisphericPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.NdotL=dot(N,lightData.xyz)*0.5+0.5;result.NdotL=saturateEps(result.NdotL);result.NdotLUnclamped=result.NdotL;
#ifdef SPECULARTERM
result.L=normalize(lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));
#endif
return result;}
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
#include<ltcHelperFunctions>
preLightingInfo computeAreaPreLightingInfo(sampler2D ltc1,sampler2D ltc2,vec3 viewDirectionW,vec3 vNormal,vec3 vPosition,vec4 lightData,vec3 halfWidth,vec3 halfHeight,float roughness ) 
{preLightingInfo result;result.lightOffset=lightData.xyz-vPosition;result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);result.lightDistance=sqrt(result.lightDistanceSquared);areaLightData data=computeAreaLightSpecularDiffuseFresnel(ltc1,ltc2,viewDirectionW,vNormal,vPosition,lightData.xyz,halfWidth,halfHeight,roughness);
#ifdef SPECULARTERM
result.areaLightFresnel=data.Fresnel;result.areaLightSpecular=data.Specular; 
#endif
result.areaLightDiffuse=data.Diffuse;return result;}
#endif
`;C.IncludesShadersStore[np]||(C.IncludesShadersStore[np]=sO);const ap="pbrDirectLightingFalloffFunctions",nO=`float computeDistanceLightFalloff_Standard(vec3 lightOffset,float range)
{return max(0.,1.0-length(lightOffset)/range);}
float computeDistanceLightFalloff_Physical(float lightDistanceSquared)
{return 1.0/maxEps(lightDistanceSquared);}
float computeDistanceLightFalloff_GLTF(float lightDistanceSquared,float inverseSquaredRange)
{float lightDistanceFalloff=1.0/maxEps(lightDistanceSquared);float factor=lightDistanceSquared*inverseSquaredRange;float attenuation=saturate(1.0-factor*factor);attenuation*=attenuation;lightDistanceFalloff*=attenuation;return lightDistanceFalloff;}
float computeDistanceLightFalloff(vec3 lightOffset,float lightDistanceSquared,float range,float inverseSquaredRange)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDistanceLightFalloff_Physical(lightDistanceSquared);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);
#else
return computeDistanceLightFalloff_Standard(lightOffset,range);
#endif
}
float computeDirectionalLightFalloff_Standard(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent)
{float falloff=0.0;float cosAngle=maxEps(dot(-lightDirection,directionToLightCenterW));if (cosAngle>=cosHalfAngle)
{falloff=max(0.,pow(cosAngle,exponent));}
return falloff;}
float computeDirectionalLightFalloff_IES(vec3 lightDirection,vec3 directionToLightCenterW,sampler2D iesLightSampler)
{float cosAngle=dot(-lightDirection,directionToLightCenterW);float angle=acos(cosAngle)/PI;return texture2D(iesLightSampler,vec2(angle,0.)).r;}
float computeDirectionalLightFalloff_Physical(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle)
{const float kMinusLog2ConeAngleIntensityRatio=6.64385618977; 
float concentrationKappa=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);vec4 lightDirectionSpreadSG=vec4(-lightDirection*concentrationKappa,-concentrationKappa);float falloff=exp2(dot(vec4(directionToLightCenterW,1.0),lightDirectionSpreadSG));return falloff;}
float computeDirectionalLightFalloff_GLTF(vec3 lightDirection,vec3 directionToLightCenterW,float lightAngleScale,float lightAngleOffset)
{float cd=dot(-lightDirection,directionToLightCenterW);float falloff=saturate(cd*lightAngleScale+lightAngleOffset);falloff*=falloff;return falloff;}
float computeDirectionalLightFalloff(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent,float lightAngleScale,float lightAngleOffset)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);
#else
return computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);
#endif
}`;C.IncludesShadersStore[ap]||(C.IncludesShadersStore[ap]=nO);const op="pbrBRDFFunctions",aO=`#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
#ifdef MS_BRDF_ENERGY_CONSERVATION
vec3 getEnergyConservationFactor(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);}
#endif
#ifdef ENVIRONMENTBRDF
vec3 getBRDFLookup(float NdotV,float perceptualRoughness) {vec2 UV=vec2(NdotV,perceptualRoughness);vec4 brdfLookup=texture2D(environmentBrdfSampler,UV);
#ifdef ENVIRONMENTBRDF_RGBD
brdfLookup.rgb=fromRGBD(brdfLookup.rgba);
#endif
return brdfLookup.rgb;}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 specularEnvironmentR90,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;
#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;
#endif
return reflectance;}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);
#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;
#endif
return reflectance;}
#endif
/* NOT USED
#if defined(SHEEN) && defined(SHEEN_SOFTER)
float getBRDFLookupCharlieSheen(float NdotV,float perceptualRoughness)
{float c=1.0-NdotV;float c3=c*c*c;return 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));}
#endif
*/
#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)
vec3 getReflectanceFromAnalyticalBRDFLookup_Jones(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)
{float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
/**
* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.
* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table
*/
vec3 getSheenReflectanceFromBRDFLookup(const vec3 reflectance0,const vec3 environmentBrdf) {vec3 sheenEnvironmentReflectance=reflectance0*environmentBrdf.b;return sheenEnvironmentReflectance;}
#endif
vec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
float fresnelSchlickGGX(float VdotH,float reflectance0,float reflectance90)
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
#ifdef CLEARCOAT
vec3 getR0RemappedForClearCoat(vec3 f0) {
#ifdef CLEARCOAT_DEFAULTIOR
#ifdef MOBILE
return saturate(f0*(f0*0.526868+0.529324)-0.0482256);
#else
return saturate(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);
#endif
#else
vec3 s=sqrt(f0);vec3 t=(vClearCoatRefractionParams.z+vClearCoatRefractionParams.w*s)/(vClearCoatRefractionParams.w+vClearCoatRefractionParams.z*s);return square(t);
#endif
}
#endif
#ifdef IRIDESCENCE
const mat3 XYZ_TO_REC709=mat3(
3.2404542,-0.9692660, 0.0556434,
-1.5371385, 1.8760108,-0.2040259,
-0.4985314, 0.0415560, 1.0572252
);vec3 getIORTfromAirToSurfaceR0(vec3 f0) {vec3 sqrtF0=sqrt(f0);return (1.+sqrtF0)/(1.-sqrtF0);}
vec3 getR0fromIORs(vec3 iorT,float iorI) {return square((iorT-vec3(iorI))/(iorT+vec3(iorI)));}
float getR0fromIORs(float iorT,float iorI) {return square((iorT-iorI)/(iorT+iorI));}
vec3 evalSensitivity(float opd,vec3 shift) {float phase=2.0*PI*opd*1.0e-9;const vec3 val=vec3(5.4856e-13,4.4201e-13,5.2481e-13);const vec3 pos=vec3(1.6810e+06,1.7953e+06,2.2084e+06);const vec3 var=vec3(4.3278e+09,9.3046e+09,6.6121e+09);vec3 xyz=val*sqrt(2.0*PI*var)*cos(pos*phase+shift)*exp(-square(phase)*var);xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));xyz/=1.0685e-7;vec3 srgb=XYZ_TO_REC709*xyz;return srgb;}
vec3 evalIridescence(float outsideIOR,float eta2,float cosTheta1,float thinFilmThickness,vec3 baseF0) {vec3 I=vec3(1.0);float iridescenceIOR=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));float sinTheta2Sq=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));float cosTheta2Sq=1.0-sinTheta2Sq;if (cosTheta2Sq<0.0) {return I;}
float cosTheta2=sqrt(cosTheta2Sq);float R0=getR0fromIORs(iridescenceIOR,outsideIOR);float R12=fresnelSchlickGGX(cosTheta1,R0,1.);float R21=R12;float T121=1.0-R12;float phi12=0.0;if (iridescenceIOR<outsideIOR) phi12=PI;float phi21=PI-phi12;vec3 baseIOR=getIORTfromAirToSurfaceR0(clamp(baseF0,0.0,0.9999)); 
vec3 R1=getR0fromIORs(baseIOR,iridescenceIOR);vec3 R23=fresnelSchlickGGX(cosTheta2,R1,vec3(1.));vec3 phi23=vec3(0.0);if (baseIOR[0]<iridescenceIOR) phi23[0]=PI;if (baseIOR[1]<iridescenceIOR) phi23[1]=PI;if (baseIOR[2]<iridescenceIOR) phi23[2]=PI;float opd=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;vec3 phi=vec3(phi21)+phi23;vec3 R123=clamp(R12*R23,1e-5,0.9999);vec3 r123=sqrt(R123);vec3 Rs=square(T121)*R23/(vec3(1.0)-R123);vec3 C0=R12+Rs;I=C0;vec3 Cm=Rs-T121;for (int m=1; m<=2; ++m)
{Cm*=r123;vec3 Sm=2.0*evalSensitivity(float(m)*opd,float(m)*phi);I+=Cm*Sm;}
return max(I,vec3(0.0));}
#endif
float normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)
{float a2=square(alphaG);float d=NdotH*NdotH*(a2-1.0)+1.0;return a2/(PI*d*d);}
#ifdef SHEEN
float normalDistributionFunction_CharlieSheen(float NdotH,float alphaG)
{float invR=1./alphaG;float cos2h=NdotH*NdotH;float sin2h=1.-cos2h;return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);}
#endif
#ifdef ANISOTROPIC
float normalDistributionFunction_BurleyGGX_Anisotropic(float NdotH,float TdotH,float BdotH,const vec2 alphaTB) {float a2=alphaTB.x*alphaTB.y;vec3 v=vec3(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);float v2=dot(v,v);float w2=a2/v2;return a2*w2*w2*RECIPROCAL_PI;}
#endif
#ifdef BRDF_V_HEIGHT_CORRELATED
float smithVisibility_GGXCorrelated(float NdotL,float NdotV,float alphaG) {
#ifdef MOBILE
float GGXV=NdotL*(NdotV*(1.0-alphaG)+alphaG);float GGXL=NdotV*(NdotL*(1.0-alphaG)+alphaG);return 0.5/(GGXV+GGXL);
#else
float a2=alphaG*alphaG;float GGXV=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);float GGXL=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);return 0.5/(GGXV+GGXL);
#endif
}
#else
float smithVisibilityG1_TrowbridgeReitzGGXFast(float dot,float alphaG)
{
#ifdef MOBILE
return 1.0/(dot+alphaG+(1.0-alphaG)*dot ));
#else
float alphaSquared=alphaG*alphaG;return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));
#endif
}
float smithVisibility_TrowbridgeReitzGGXFast(float NdotL,float NdotV,float alphaG)
{float visibility=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);return visibility;}
#endif
#ifdef ANISOTROPIC
float smithVisibility_GGXCorrelated_Anisotropic(float NdotL,float NdotV,float TdotV,float BdotV,float TdotL,float BdotL,const vec2 alphaTB) {float lambdaV=NdotL*length(vec3(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));float lambdaL=NdotV*length(vec3(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));float v=0.5/(lambdaV+lambdaL);return v;}
#endif
#ifdef CLEARCOAT
float visibility_Kelemen(float VdotH) {return 0.25/(VdotH*VdotH); }
#endif
#ifdef SHEEN
float visibility_Ashikhmin(float NdotL,float NdotV)
{return 1./(4.*(NdotL+NdotV-NdotL*NdotV));}
/* NOT USED
#ifdef SHEEN_SOFTER
float l(float x,float alphaG)
{float oneMinusAlphaSq=(1.0-alphaG)*(1.0-alphaG);float a=mix(21.5473,25.3245,oneMinusAlphaSq);float b=mix(3.82987,3.32435,oneMinusAlphaSq);float c=mix(0.19823,0.16801,oneMinusAlphaSq);float d=mix(-1.97760,-1.27393,oneMinusAlphaSq);float e=mix(-4.32054,-4.85967,oneMinusAlphaSq);return a/(1.0+b*pow(x,c))+d*x+e;}
float lambdaSheen(float cosTheta,float alphaG)
{return abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));}
float visibility_CharlieSheen(float NdotL,float NdotV,float alphaG)
{float G=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));return G/(4.0*NdotV*NdotL);}
#endif
*/
#endif
float diffuseBRDF_Burley(float NdotL,float NdotV,float VdotH,float roughness) {float diffuseFresnelNV=pow5(saturateEps(1.0-NdotL));float diffuseFresnelNL=pow5(saturateEps(1.0-NdotV));float diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;float fresnel =
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);return fresnel/PI;}
#ifdef SS_TRANSLUCENCY
vec3 transmittanceBRDF_Burley(const vec3 tintColor,const vec3 diffusionDistance,float thickness) {vec3 S=1./maxEps(diffusionDistance);vec3 temp=exp((-0.333333333*thickness)*S);return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);}
float computeWrappedDiffuseNdotL(float NdotL,float w) {float t=1.0+w;float invt2=1.0/square(t);return saturate((NdotL+w)*invt2);}
#endif
`;C.IncludesShadersStore[op]||(C.IncludesShadersStore[op]=aO);const lp="hdrFilteringFunctions",oO=`#ifdef NUM_SAMPLES
#if NUM_SAMPLES>0
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
float radicalInverse_VdC(uint bits) 
{bits=(bits<<16u) | (bits>>16u);bits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);bits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);bits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);bits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);return float(bits)*2.3283064365386963e-10; }
vec2 hammersley(uint i,uint N)
{return vec2(float(i)/float(N),radicalInverse_VdC(i));}
#else
float vanDerCorpus(int n,int base)
{float invBase=1.0/float(base);float denom =1.0;float result =0.0;for(int i=0; i<32; ++i)
{if(n>0)
{denom =mod(float(n),2.0);result+=denom*invBase;invBase=invBase/2.0;n =int(float(n)/2.0);}}
return result;}
vec2 hammersley(int i,int N)
{return vec2(float(i)/float(N),vanDerCorpus(i,2));}
#endif
float log4(float x) {return log2(x)/2.;}
vec3 uv_to_normal(vec2 uv) {vec3 N;vec2 uvRange=uv;float theta=uvRange.x*2.0*PI;float phi=uvRange.y*PI;N.x=cos(theta)*sin(phi);N.z=sin(theta)*sin(phi);N.y=cos(phi);return N;}
const float NUM_SAMPLES_FLOAT=float(NUM_SAMPLES);const float NUM_SAMPLES_FLOAT_INVERSED=1./NUM_SAMPLES_FLOAT;const float K=4.;
#define inline
vec3 irradiance(samplerCube inputTexture,vec3 inputN,vec2 filteringInfo
#ifdef IBL_CDF_FILTERING
,sampler2D icdfSampler
#endif
)
{vec3 n=normalize(inputN);vec3 result=vec3(0.0);
#ifndef IBL_CDF_FILTERING
vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);tangent=normalize(cross(tangent,n));vec3 bitangent=cross(n,tangent);mat3 tbn=mat3(tangent,bitangent,n);
#endif
float maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float omegaP=(4.*PI)/(6.*dim0*dim0);
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{vec2 Xi=hammersley(i,NUM_SAMPLES);
#ifdef IBL_CDF_FILTERING
vec2 T;T.x=textureLod(icdfSampler,vec2(Xi.x,0.0),0.0).x;T.y=textureLod(icdfSampler,vec2(T.x,Xi.y),0.0).y;vec3 Ls=uv_to_normal(vec2(1.0-fract(T.x+0.25),T.y));float NoL=dot(n,Ls);
#else
vec3 Ls=hemisphereCosSample(Xi);Ls=normalize(Ls);vec3 Ns=vec3(0.,0.,1.);float NoL=dot(Ns,Ls);
#endif
if (NoL>0.) {
#ifdef IBL_CDF_FILTERING
float pdf=textureLod(icdfSampler,T,0.0).z;vec3 c=textureCubeLodEXT(inputTexture,Ls,0.0).rgb;
#else
float pdf_inversed=PI/NoL;float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(l,0.0,maxLevel);vec3 c=textureCubeLodEXT(inputTexture,tbn*Ls,mipLevel).rgb;
#endif
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
#ifdef IBL_CDF_FILTERING
vec3 light=pdf<1e-6 ? vec3(0.0) : vec3(1.0)/vec3(pdf)*c;result+=NoL*light;
#else
result+=c;
#endif
}}
result=result*NUM_SAMPLES_FLOAT_INVERSED;return result;}
#define inline
vec3 radiance(float alphaG,samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)
{vec3 n=normalize(inputN);vec3 c=textureCube(inputTexture,n).rgb; 
if (alphaG==0.) {
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
return c;} else {vec3 result=vec3(0.);vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);tangent=normalize(cross(tangent,n));vec3 bitangent=cross(n,tangent);mat3 tbn=mat3(tangent,bitangent,n);float maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float omegaP=(4.*PI)/(6.*dim0*dim0);float weight=0.;
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{vec2 Xi=hammersley(i,NUM_SAMPLES);vec3 H=hemisphereImportanceSampleDggx(Xi,alphaG);float NoV=1.;float NoH=H.z;float NoH2=H.z*H.z;float NoL=2.*NoH2-1.;vec3 L=vec3(2.*NoH*H.x,2.*NoH*H.y,NoL);L=normalize(L);if (NoL>0.) {float pdf_inversed=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(float(l),0.0,maxLevel);weight+=NoL;vec3 c=textureCubeLodEXT(inputTexture,tbn*L,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c*NoL;}}
result=result/weight;return result;}}
#endif
#endif
`;C.IncludesShadersStore[lp]||(C.IncludesShadersStore[lp]=oO);const cp="pbrDirectLightingFunctions",lO=`#define CLEARCOATREFLECTANCE90 1.0
struct lightingInfo
{vec3 diffuse;
#ifdef SPECULARTERM
vec3 specular;
#endif
#ifdef CLEARCOAT
vec4 clearCoat;
#endif
#ifdef SHEEN
vec3 sheen;
#endif
};float adjustRoughnessFromLightProperties(float roughness,float lightRadius,float lightDistance) {
#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)
float lightRoughness=lightRadius/lightDistance;float totalRoughness=saturate(lightRoughness+roughness);return totalRoughness;
#else
return roughness;
#endif
}
vec3 computeHemisphericDiffuseLighting(preLightingInfo info,vec3 lightColor,vec3 groundColor) {return mix(groundColor,lightColor,info.NdotL);}
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
vec3 computeAreaDiffuseLighting(preLightingInfo info,vec3 lightColor) {return info.areaLightDiffuse*lightColor;}
#endif
vec3 computeDiffuseLighting(preLightingInfo info,vec3 lightColor) {float diffuseTerm=diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*info.attenuation*info.NdotL*lightColor;}
#define inline
vec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix,vec3 posW){vec4 strq=textureProjectionMatrix*vec4(posW,1.0);strq/=strq.w;vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;return toLinearSpace(textureColor);}
#ifdef SS_TRANSLUCENCY
vec3 computeDiffuseAndTransmittedLighting(preLightingInfo info,vec3 lightColor,vec3 transmittance,float transmittanceIntensity,vec3 surfaceAlbedo) {vec3 transmittanceNdotL=vec3(0.);float NdotL=absEps(info.NdotLUnclamped);if (info.NdotLUnclamped<0.0) {float wrapNdotL=computeWrappedDiffuseNdotL(NdotL,0.02);float trAdapt=step(0.,info.NdotLUnclamped);transmittanceNdotL=mix(transmittance*wrapNdotL,vec3(wrapNdotL),trAdapt);}
float diffuseTerm=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);return (transmittanceNdotL/PI+(1.0-transmittanceIntensity)*diffuseTerm*surfaceAlbedo*info.NdotL)*info.attenuation*lightColor;}
#endif
#ifdef SPECULARTERM
vec3 computeSpecularLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float roughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(roughness);vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);
#ifdef BRDF_V_HEIGHT_CORRELATED
float smithVisibility=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);
#else
float smithVisibility=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);
#endif
vec3 specTerm=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
vec3 computeAreaSpecularLighting(preLightingInfo info,vec3 specularColor) {vec3 fresnel=( specularColor*info.areaLightFresnel.x+( vec3( 1.0 )-specularColor )*info.areaLightFresnel.y );return specularColor*fresnel*info.areaLightSpecular;}
#endif
#endif
#ifdef ANISOTROPIC
vec3 computeAnisotropicSpecularLighting(preLightingInfo info,vec3 V,vec3 N,vec3 T,vec3 B,float anisotropy,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float TdotH=dot(T,info.H);float BdotH=dot(B,info.H);float TdotV=dot(T,V);float BdotV=dot(B,V);float TdotL=dot(T,info.L);float BdotL=dot(B,info.L);float alphaG=convertRoughnessToAverageSlope(info.roughness);vec2 alphaTB=getAnisotropicRoughness(alphaG,anisotropy);alphaTB=max(alphaTB,square(geometricRoughnessFactor));vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
float distribution=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);float smithVisibility=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);vec3 specTerm=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#endif
#ifdef CLEARCOAT
vec4 computeClearCoatLighting(preLightingInfo info,vec3 Ncc,float geometricRoughnessFactor,float clearCoatIntensity,vec3 lightColor) {float NccdotL=saturateEps(dot(Ncc,info.L));float NccdotH=saturateEps(dot(Ncc,info.H));float clearCoatRoughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(clearCoatRoughness);float fresnel=fresnelSchlickGGX(info.VdotH,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnel*=clearCoatIntensity;float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);float kelemenVisibility=visibility_Kelemen(info.VdotH);float clearCoatTerm=fresnel*distribution*kelemenVisibility;return vec4(
clearCoatTerm*info.attenuation*NccdotL*lightColor,
1.0-fresnel
);}
vec3 computeClearCoatLightingAbsorption(float NdotVRefract,vec3 L,vec3 Ncc,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {vec3 LRefract=-refract(L,Ncc,vClearCoatRefractionParams.y);float NdotLRefract=saturateEps(dot(Ncc,LRefract));vec3 absorption=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);return absorption;}
#endif
#ifdef SHEEN
vec3 computeSheenLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float roughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(roughness);float fresnel=1.;float distribution=normalDistributionFunction_CharlieSheen(NdotH,alphaG);/*#ifdef SHEEN_SOFTER
float visibility=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);
#else */
float visibility=visibility_Ashikhmin(info.NdotL,info.NdotV);/* #endif */
float sheenTerm=fresnel*distribution*visibility;return sheenTerm*info.attenuation*info.NdotL*lightColor;}
#endif
`;C.IncludesShadersStore[cp]||(C.IncludesShadersStore[cp]=lO);const hp="pbrIBLFunctions",cO=`#if defined(REFLECTION) || defined(SS_REFRACTION)
float getLodFromAlphaG(float cubeMapDimensionPixels,float microsurfaceAverageSlope) {float microsurfaceAverageSlopeTexels=cubeMapDimensionPixels*microsurfaceAverageSlope;float lod=log2(microsurfaceAverageSlopeTexels);return lod;}
float getLinearLodFromRoughness(float cubeMapDimensionPixels,float roughness) {float lod=log2(cubeMapDimensionPixels)*roughness;return lod;}
#endif
#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)
float environmentRadianceOcclusion(float ambientOcclusion,float NdotVUnclamped) {float temp=NdotVUnclamped+ambientOcclusion;return saturate(square(temp)-1.0+ambientOcclusion);}
#endif
#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)
float environmentHorizonOcclusion(vec3 view,vec3 normal,vec3 geometricNormal) {vec3 reflection=reflect(view,normal);float temp=saturate(1.0+1.1*dot(reflection,geometricNormal));return square(temp);}
#endif
#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)
#define UNPACK_LOD(x) (1.0-x)*255.0
float getLodFromAlphaG(float cubeMapDimensionPixels,float alphaG,float NdotV) {float microsurfaceAverageSlope=alphaG;microsurfaceAverageSlope*=sqrt(abs(NdotV));return getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);}
#endif
`;C.IncludesShadersStore[hp]||(C.IncludesShadersStore[hp]=cO);const fp="pbrBlockAlbedoOpacity",hO=`struct albedoOpacityOutParams
{vec3 surfaceAlbedo;float alpha;};
#define pbr_inline
albedoOpacityOutParams albedoOpacityBlock(
in vec4 vAlbedoColor
#ifdef ALBEDO
,in vec4 albedoTexture
,in vec2 albedoInfos
#endif
,in float baseWeight
#ifdef BASEWEIGHT
,in vec4 baseWeightTexture
,in vec2 vBaseWeightInfos
#endif
#ifdef OPACITY
,in vec4 opacityMap
,in vec2 vOpacityInfos
#endif
#ifdef DETAIL
,in vec4 detailColor
,in vec4 vDetailInfos
#endif
#ifdef DECAL
,in vec4 decalColor
,in vec4 vDecalInfos
#endif
)
{albedoOpacityOutParams outParams;vec3 surfaceAlbedo=vAlbedoColor.rgb;float alpha=vAlbedoColor.a;
#ifdef ALBEDO
#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)
alpha*=albedoTexture.a;
#endif
#ifdef GAMMAALBEDO
surfaceAlbedo*=toLinearSpace(albedoTexture.rgb);
#else
surfaceAlbedo*=albedoTexture.rgb;
#endif
surfaceAlbedo*=albedoInfos.y;
#endif
#ifndef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
surfaceAlbedo*=vColor.rgb;
#endif
#ifdef DETAIL
float detailAlbedo=2.0*mix(0.5,detailColor.r,vDetailInfos.y);surfaceAlbedo.rgb=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; 
#endif
#ifdef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALBEDO
surfaceAlbedo*=baseWeight;
#ifdef BASEWEIGHT
surfaceAlbedo*=baseWeightTexture.r;
#endif
#ifdef OPACITY
#ifdef OPACITYRGB
alpha=getLuminance(opacityMap.rgb);
#else
alpha*=opacityMap.a;
#endif
alpha*=vOpacityInfos.y;
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=vColor.a;
#endif
#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)
#ifdef ALPHATEST
#if DEBUGMODE != 88
if (alpha<ALPHATESTVALUE)
discard;
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
#endif
outParams.surfaceAlbedo=surfaceAlbedo;outParams.alpha=alpha;return outParams;}
`;C.IncludesShadersStore[fp]||(C.IncludesShadersStore[fp]=hO);const up="pbrBlockReflectivity",fO=`struct reflectivityOutParams
{float microSurface;float roughness;vec3 surfaceReflectivityColor;
#ifdef METALLICWORKFLOW
vec3 surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
vec3 ambientOcclusionColor;
#endif
#if DEBUGMODE>0
#ifdef METALLICWORKFLOW
vec2 metallicRoughness;
#ifdef REFLECTIVITY
vec4 surfaceMetallicColorMap;
#endif
#ifndef FROSTBITE_REFLECTANCE
vec3 metallicF0;
#endif
#else
#ifdef REFLECTIVITY
vec4 surfaceReflectivityColorMap;
#endif
#endif
#endif
};
#define pbr_inline
reflectivityOutParams reflectivityBlock(
in vec4 vReflectivityColor
#ifdef METALLICWORKFLOW
,in vec3 surfaceAlbedo
,in vec4 metallicReflectanceFactors
#endif
#ifdef REFLECTIVITY
,in vec3 reflectivityInfos
,in vec4 surfaceMetallicOrReflectivityColorMap
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
,in vec3 ambientOcclusionColorIn
#endif
#ifdef MICROSURFACEMAP
,in vec4 microSurfaceTexel
#endif
#ifdef DETAIL
,in vec4 detailColor
,in vec4 vDetailInfos
#endif
)
{reflectivityOutParams outParams;float microSurface=vReflectivityColor.a;vec3 surfaceReflectivityColor=vReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
vec2 metallicRoughness=surfaceReflectivityColor.rg;
#ifdef REFLECTIVITY
#if DEBUGMODE>0
outParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef AOSTOREINMETALMAPRED
vec3 aoStoreInMetalMap=vec3(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);outParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);
#endif
#ifdef METALLNESSSTOREINMETALMAPBLUE
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;
#else
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;
#endif
#ifdef ROUGHNESSSTOREINMETALMAPALPHA
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;
#else
#ifdef ROUGHNESSSTOREINMETALMAPGREEN
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;
#endif
#endif
#endif
#ifdef DETAIL
float detailRoughness=mix(0.5,detailColor.b,vDetailInfos.w);float loLerp=mix(0.,metallicRoughness.g,detailRoughness*2.);float hiLerp=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);metallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));
#endif
#ifdef MICROSURFACEMAP
metallicRoughness.g*=microSurfaceTexel.r;
#endif
#if DEBUGMODE>0
outParams.metallicRoughness=metallicRoughness;
#endif
#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS
microSurface=1.0-metallicRoughness.g;vec3 baseColor=surfaceAlbedo;
#ifdef FROSTBITE_REFLECTANCE
outParams.surfaceAlbedo=baseColor.rgb*(1.0-metallicRoughness.r);surfaceReflectivityColor=mix(0.16*reflectance*reflectance,baseColor,metallicRoughness.r);
#else
vec3 metallicF0=metallicReflectanceFactors.rgb;
#if DEBUGMODE>0
outParams.metallicF0=metallicF0;
#endif
outParams.surfaceAlbedo=mix(baseColor.rgb*(1.0-metallicF0),vec3(0.,0.,0.),metallicRoughness.r);surfaceReflectivityColor=mix(metallicF0,baseColor,metallicRoughness.r);
#endif
#else
#ifdef REFLECTIVITY
surfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;
#if DEBUGMODE>0
outParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef MICROSURFACEFROMREFLECTIVITYMAP
microSurface*=surfaceMetallicOrReflectivityColorMap.a;microSurface*=reflectivityInfos.z;
#else
#ifdef MICROSURFACEAUTOMATIC
microSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);
#endif
#ifdef MICROSURFACEMAP
microSurface*=microSurfaceTexel.r;
#endif
#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE
#endif
#endif
#endif
microSurface=saturate(microSurface);float roughness=1.-microSurface;outParams.microSurface=microSurface;outParams.roughness=roughness;outParams.surfaceReflectivityColor=surfaceReflectivityColor;return outParams;}
`;C.IncludesShadersStore[up]||(C.IncludesShadersStore[up]=fO);const dp="pbrBlockAmbientOcclusion",uO=`struct ambientOcclusionOutParams
{vec3 ambientOcclusionColor;
#if DEBUGMODE>0 && defined(AMBIENT)
vec3 ambientOcclusionColorMap;
#endif
};ambientOcclusionOutParams ambientOcclusionBlock(
#ifdef AMBIENT
in vec3 ambientOcclusionColorMap_,
in vec4 vAmbientInfos
#endif
)
{ambientOcclusionOutParams outParams;vec3 ambientOcclusionColor=vec3(1.,1.,1.);
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=ambientOcclusionColorMap_*vAmbientInfos.y;
#ifdef AMBIENTINGRAYSCALE
ambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);
#endif
ambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);
#if DEBUGMODE>0
outParams.ambientOcclusionColorMap=ambientOcclusionColorMap;
#endif
#endif
outParams.ambientOcclusionColor=ambientOcclusionColor;return outParams;}
`;C.IncludesShadersStore[dp]||(C.IncludesShadersStore[dp]=uO);const _p="pbrBlockAlphaFresnel",dO=`#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
struct alphaFresnelOutParams
{float alpha;};
#define pbr_inline
alphaFresnelOutParams alphaFresnelBlock(
in vec3 normalW,
in vec3 viewDirectionW,
in float alpha,
in float microSurface
)
{alphaFresnelOutParams outParams;float opacityPerceptual=alpha;
#ifdef LINEARALPHAFRESNEL
float opacity0=opacityPerceptual;
#else
float opacity0=opacityPerceptual*opacityPerceptual;
#endif
float opacity90=fresnelGrazingReflectance(opacity0);vec3 normalForward=faceforward(normalW,-viewDirectionW,normalW);outParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)),vec3(opacity0),vec3(opacity90),sqrt(microSurface)).x;
#ifdef ALPHATEST
if (outParams.alpha<ALPHATESTVALUE)
discard;
#ifndef ALPHABLEND
outParams.alpha=1.0;
#endif
#endif
return outParams;}
#endif
#endif
`;C.IncludesShadersStore[_p]||(C.IncludesShadersStore[_p]=dO);const pp="pbrBlockAnisotropic",_O=`#ifdef ANISOTROPIC
struct anisotropicOutParams
{float anisotropy;vec3 anisotropicTangent;vec3 anisotropicBitangent;vec3 anisotropicNormal;
#if DEBUGMODE>0 && defined(ANISOTROPIC_TEXTURE)
vec3 anisotropyMapData;
#endif
};
#define pbr_inline
anisotropicOutParams anisotropicBlock(
in vec3 vAnisotropy,
in float roughness,
#ifdef ANISOTROPIC_TEXTURE
in vec3 anisotropyMapData,
#endif
in mat3 TBN,
in vec3 normalW,
in vec3 viewDirectionW
)
{anisotropicOutParams outParams;float anisotropy=vAnisotropy.b;vec3 anisotropyDirection=vec3(vAnisotropy.xy,0.);
#ifdef ANISOTROPIC_TEXTURE
anisotropy*=anisotropyMapData.b;
#if DEBUGMODE>0
outParams.anisotropyMapData=anisotropyMapData;
#endif
anisotropyMapData.rg=anisotropyMapData.rg*2.0-1.0;
#ifdef ANISOTROPIC_LEGACY
anisotropyDirection.rg*=anisotropyMapData.rg;
#else
anisotropyDirection.xy=mat2(anisotropyDirection.x,anisotropyDirection.y,-anisotropyDirection.y,anisotropyDirection.x)*normalize(anisotropyMapData.rg);
#endif
#endif
mat3 anisoTBN=mat3(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));vec3 anisotropicTangent=normalize(anisoTBN*anisotropyDirection);vec3 anisotropicBitangent=normalize(cross(anisoTBN[2],anisotropicTangent));outParams.anisotropy=anisotropy;outParams.anisotropicTangent=anisotropicTangent;outParams.anisotropicBitangent=anisotropicBitangent;outParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy,roughness);return outParams;}
#endif
`;C.IncludesShadersStore[pp]||(C.IncludesShadersStore[pp]=_O);const mp="pbrBlockReflection",pO=`#ifdef REFLECTION
struct reflectionOutParams
{vec4 environmentRadiance;vec3 environmentIrradiance;
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords;
#else
vec2 reflectionCoords;
#endif
#ifdef SS_TRANSLUCENCY
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
vec3 irradianceVector;
#endif
#endif
#endif
};
#define pbr_inline
void createReflectionCoords(
in vec3 vPositionW,
in vec3 normalW,
#ifdef ANISOTROPIC
in anisotropicOutParams anisotropicOut,
#endif
#ifdef REFLECTIONMAP_3D
out vec3 reflectionCoords
#else
out vec2 reflectionCoords
#endif
)
{
#ifdef ANISOTROPIC
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),anisotropicOut.anisotropicNormal);
#else
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
reflectionCoords=reflectionVector;
#else
reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
}
#define pbr_inline
#define inline
void sampleReflectionTexture(
in float alphaG,
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
in float NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
in float roughness,
#endif
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
const vec3 reflectionCoords,
#else
in sampler2D reflectionSampler,
const vec2 reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
out vec4 environmentRadiance
)
{
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);
#elif defined(LINEARSPECULARREFLECTION)
float reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);
#else
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);
#endif
#ifdef LODBASEDMICROSFURACE
reflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
#ifdef LODINREFLECTIONALPHA
float automaticReflectionLOD=UNPACK_LOD(sampleReflection(reflectionSampler,reflectionCoords).a);float requestedReflectionLOD=max(automaticReflectionLOD,reflectionLOD);
#else
float requestedReflectionLOD=reflectionLOD;
#endif
#ifdef REALTIME_FILTERING
environmentRadiance=vec4(radiance(alphaG,reflectionSampler,reflectionCoords,vReflectionFilteringInfo),1.0);
#else
environmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#endif
#else
float lodReflectionNormalized=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;vec4 environmentMid=sampleReflection(reflectionSampler,reflectionCoords);if (lodReflectionNormalizedDoubled<1.0){environmentRadiance=mix(
sampleReflection(reflectionSamplerHigh,reflectionCoords),
environmentMid,
lodReflectionNormalizedDoubled
);} else {environmentRadiance=mix(
environmentMid,
sampleReflection(reflectionSamplerLow,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);}
#endif
#ifdef RGBDREFLECTION
environmentRadiance.rgb=fromRGBD(environmentRadiance);
#endif
#ifdef GAMMAREFLECTION
environmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);
#endif
environmentRadiance.rgb*=vReflectionInfos.x;environmentRadiance.rgb*=vReflectionColor.rgb;}
#define pbr_inline
#define inline
reflectionOutParams reflectionBlock(
in vec3 vPositionW
,in vec3 normalW
,in float alphaG
,in vec3 vReflectionMicrosurfaceInfos
,in vec2 vReflectionInfos
,in vec3 vReflectionColor
#ifdef ANISOTROPIC
,in anisotropicOutParams anisotropicOut
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,in float NdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,in float roughness
#endif
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSampler
#else
,in sampler2D reflectionSampler
#endif
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,in vec3 vEnvironmentIrradiance
#endif
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
,in mat4 reflectionMatrix
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
,in samplerCube irradianceSampler
#else
,in sampler2D irradianceSampler
#endif
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSamplerLow
,in samplerCube reflectionSamplerHigh
#else
,in sampler2D reflectionSamplerLow
,in sampler2D reflectionSamplerHigh
#endif
#endif
#ifdef REALTIME_FILTERING
,in vec2 vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,in sampler2D icdfSampler
#endif
#endif
)
{reflectionOutParams outParams;vec4 environmentRadiance=vec4(0.,0.,0.,0.);
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=vec3(0.);
#else
vec2 reflectionCoords=vec2(0.);
#endif
createReflectionCoords(
vPositionW,
normalW,
#ifdef ANISOTROPIC
anisotropicOut,
#endif
reflectionCoords
);sampleReflectionTexture(
alphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
roughness,
#endif
#ifdef REFLECTIONMAP_3D
reflectionSampler,
reflectionCoords,
#else
reflectionSampler,
reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentRadiance
);vec3 environmentIrradiance=vec3(0.,0.,0.);
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
#ifdef ANISOTROPIC
vec3 irradianceVector=vec3(reflectionMatrix*vec4(anisotropicOut.anisotropicNormal,0)).xyz;
#else
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
environmentIrradiance=vEnvironmentIrradiance;
#else
#if defined(REALTIME_FILTERING)
environmentIrradiance=irradiance(reflectionSampler,irradianceVector,vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,icdfSampler
#endif
);
#else
environmentIrradiance=computeEnvironmentIrradiance(irradianceVector);
#endif
#ifdef SS_TRANSLUCENCY
outParams.irradianceVector=irradianceVector;
#endif
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
vec4 environmentIrradiance4=sampleReflection(irradianceSampler,irradianceVector);
#else
vec4 environmentIrradiance4=sampleReflection(irradianceSampler,reflectionCoords);
#endif
environmentIrradiance=environmentIrradiance4.rgb;
#ifdef RGBDREFLECTION
environmentIrradiance.rgb=fromRGBD(environmentIrradiance4);
#endif
#ifdef GAMMAREFLECTION
environmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);
#endif
#endif
environmentIrradiance*=vReflectionColor.rgb*vReflectionInfos.x;
#ifdef MIX_IBL_RADIANCE_WITH_IRRADIANCE
outParams.environmentRadiance=vec4(mix(environmentRadiance.rgb,environmentIrradiance,alphaG),environmentRadiance.a);
#else
outParams.environmentRadiance=environmentRadiance;
#endif
outParams.environmentIrradiance=environmentIrradiance;outParams.reflectionCoords=reflectionCoords;return outParams;}
#endif
`;C.IncludesShadersStore[mp]||(C.IncludesShadersStore[mp]=pO);const gp="pbrBlockSheen",mO=`#ifdef SHEEN
struct sheenOutParams
{float sheenIntensity;vec3 sheenColor;float sheenRoughness;
#ifdef SHEEN_LINKWITHALBEDO
vec3 surfaceAlbedo;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
float sheenAlbedoScaling;
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
vec3 finalSheenRadianceScaled;
#endif
#if DEBUGMODE>0
#ifdef SHEEN_TEXTURE
vec4 sheenMapData;
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
vec3 sheenEnvironmentReflectance;
#endif
#endif
};
#define pbr_inline
#define inline
sheenOutParams sheenBlock(
in vec4 vSheenColor
#ifdef SHEEN_ROUGHNESS
,in float vSheenRoughness
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
,in vec4 sheenMapRoughnessData
#endif
#endif
,in float roughness
#ifdef SHEEN_TEXTURE
,in vec4 sheenMapData
,in float sheenMapLevel
#endif
,in float reflectance
#ifdef SHEEN_LINKWITHALBEDO
,in vec3 baseColor
,in vec3 surfaceAlbedo
#endif
#ifdef ENVIRONMENTBRDF
,in float NdotV
,in vec3 environmentBrdf
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,in vec2 AARoughnessFactors
,in vec3 vReflectionMicrosurfaceInfos
,in vec2 vReflectionInfos
,in vec3 vReflectionColor
,in vec4 vLightingIntensity
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSampler
,in vec3 reflectionCoords
#else
,in sampler2D reflectionSampler
,in vec2 reflectionCoords
#endif
,in float NdotVUnclamped
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSamplerLow
,in samplerCube reflectionSamplerHigh
#else
,in sampler2D reflectionSamplerLow
,in sampler2D reflectionSamplerHigh
#endif
#endif
#ifdef REALTIME_FILTERING
,in vec2 vReflectionFilteringInfo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
,in float seo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
,in float eho
#endif
#endif
)
{sheenOutParams outParams;float sheenIntensity=vSheenColor.a;
#ifdef SHEEN_TEXTURE
#if DEBUGMODE>0
outParams.sheenMapData=sheenMapData;
#endif
#endif
#ifdef SHEEN_LINKWITHALBEDO
float sheenFactor=pow5(1.0-sheenIntensity);vec3 sheenColor=baseColor.rgb*(1.0-sheenFactor);float sheenRoughness=sheenIntensity;outParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#else
vec3 sheenColor=vSheenColor.rgb;
#ifdef SHEEN_TEXTURE
#ifdef SHEEN_GAMMATEXTURE
sheenColor.rgb*=toLinearSpace(sheenMapData.rgb);
#else
sheenColor.rgb*=sheenMapData.rgb;
#endif
sheenColor.rgb*=sheenMapLevel;
#endif
#ifdef SHEEN_ROUGHNESS
float sheenRoughness=vSheenRoughness;
#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE
#if defined(SHEEN_TEXTURE)
sheenRoughness*=sheenMapData.a;
#endif
#elif defined(SHEEN_TEXTURE_ROUGHNESS)
sheenRoughness*=sheenMapRoughnessData.a;
#endif
#else
float sheenRoughness=roughness;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#endif
#if !defined(SHEEN_ALBEDOSCALING)
sheenIntensity*=(1.-reflectance);
#endif
sheenColor*=sheenIntensity;
#endif
#ifdef ENVIRONMENTBRDF
/*#ifdef SHEEN_SOFTER
vec3 environmentSheenBrdf=vec3(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));
#else*/
#ifdef SHEEN_ROUGHNESS
vec3 environmentSheenBrdf=getBRDFLookup(NdotV,sheenRoughness);
#else
vec3 environmentSheenBrdf=environmentBrdf;
#endif
/*#endif*/
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
float sheenAlphaG=convertRoughnessToAverageSlope(sheenRoughness);
#ifdef SPECULARAA
sheenAlphaG+=AARoughnessFactors.y;
#endif
vec4 environmentSheenRadiance=vec4(0.,0.,0.,0.);sampleReflectionTexture(
sheenAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
sheenRoughness,
#endif
reflectionSampler,
reflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentSheenRadiance
);vec3 sheenEnvironmentReflectance=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
sheenEnvironmentReflectance*=seo;
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
sheenEnvironmentReflectance*=eho;
#endif
#if DEBUGMODE>0
outParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;
#endif
outParams.finalSheenRadianceScaled=
environmentSheenRadiance.rgb *
sheenEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
outParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;
#endif
outParams.sheenIntensity=sheenIntensity;outParams.sheenColor=sheenColor;outParams.sheenRoughness=sheenRoughness;return outParams;}
#endif
`;C.IncludesShadersStore[gp]||(C.IncludesShadersStore[gp]=mO);const Ep="pbrBlockClearcoat",gO=`struct clearcoatOutParams
{vec3 specularEnvironmentR0;float conservationFactor;vec3 clearCoatNormalW;vec2 clearCoatAARoughnessFactors;float clearCoatIntensity;float clearCoatRoughness;
#ifdef REFLECTION
vec3 finalClearCoatRadianceScaled;
#endif
#ifdef CLEARCOAT_TINT
vec3 absorption;float clearCoatNdotVRefract;vec3 clearCoatColor;float clearCoatThickness;
#endif
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
vec3 energyConservationFactorClearCoat;
#endif
#if DEBUGMODE>0
#ifdef CLEARCOAT_BUMP
mat3 TBNClearCoat;
#endif
#ifdef CLEARCOAT_TEXTURE
vec2 clearCoatMapData;
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
vec4 clearCoatTintMapData;
#endif
#ifdef REFLECTION
vec4 environmentClearCoatRadiance;vec3 clearCoatEnvironmentReflectance;
#endif
float clearCoatNdotV;
#endif
};
#ifdef CLEARCOAT
#define pbr_inline
#define inline
clearcoatOutParams clearcoatBlock(
in vec3 vPositionW
,in vec3 geometricNormalW
,in vec3 viewDirectionW
,in vec2 vClearCoatParams
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
,in vec4 clearCoatMapRoughnessData
#endif
,in vec3 specularEnvironmentR0
#ifdef CLEARCOAT_TEXTURE
,in vec2 clearCoatMapData
#endif
#ifdef CLEARCOAT_TINT
,in vec4 vClearCoatTintParams
,in float clearCoatColorAtDistance
,in vec4 vClearCoatRefractionParams
#ifdef CLEARCOAT_TINT_TEXTURE
,in vec4 clearCoatTintMapData
#endif
#endif
#ifdef CLEARCOAT_BUMP
,in vec2 vClearCoatBumpInfos
,in vec4 clearCoatBumpMapData
,in vec2 vClearCoatBumpUV
#if defined(TANGENT) && defined(NORMAL)
,in mat3 vTBN
#else
,in vec2 vClearCoatTangentSpaceParams
#endif
#ifdef OBJECTSPACE_NORMALMAP
,in mat4 normalMatrix
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
,in vec3 faceNormal
#endif
#ifdef REFLECTION
,in vec3 vReflectionMicrosurfaceInfos
,in vec2 vReflectionInfos
,in vec3 vReflectionColor
,in vec4 vLightingIntensity
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSampler
#else
,in sampler2D reflectionSampler
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSamplerLow
,in samplerCube reflectionSamplerHigh
#else
,in sampler2D reflectionSamplerLow
,in sampler2D reflectionSamplerHigh
#endif
#endif
#ifdef REALTIME_FILTERING
,in vec2 vReflectionFilteringInfo
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
,in float frontFacingMultiplier
#endif
)
{clearcoatOutParams outParams;float clearCoatIntensity=vClearCoatParams.x;float clearCoatRoughness=vClearCoatParams.y;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE
clearCoatRoughness*=clearCoatMapData.y;
#endif
#if DEBUGMODE>0
outParams.clearCoatMapData=clearCoatMapData;
#endif
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
clearCoatRoughness*=clearCoatMapRoughnessData.y;
#endif
outParams.clearCoatIntensity=clearCoatIntensity;outParams.clearCoatRoughness=clearCoatRoughness;
#ifdef CLEARCOAT_TINT
vec3 clearCoatColor=vClearCoatTintParams.rgb;float clearCoatThickness=vClearCoatTintParams.a;
#ifdef CLEARCOAT_TINT_TEXTURE
#ifdef CLEARCOAT_TINT_GAMMATEXTURE
clearCoatColor*=toLinearSpace(clearCoatTintMapData.rgb);
#else
clearCoatColor*=clearCoatTintMapData.rgb;
#endif
clearCoatThickness*=clearCoatTintMapData.a;
#if DEBUGMODE>0
outParams.clearCoatTintMapData=clearCoatTintMapData;
#endif
#endif
outParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);outParams.clearCoatThickness=clearCoatThickness;
#endif
#ifdef CLEARCOAT_REMAP_F0
vec3 specularEnvironmentR0Updated=getR0RemappedForClearCoat(specularEnvironmentR0);
#else
vec3 specularEnvironmentR0Updated=specularEnvironmentR0;
#endif
outParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);vec3 clearCoatNormalW=geometricNormalW;
#ifdef CLEARCOAT_BUMP
#ifdef NORMALXYSCALE
float clearCoatNormalScale=1.0;
#else
float clearCoatNormalScale=vClearCoatBumpInfos.y;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBNClearCoat=vTBN;
#else
vec2 TBNClearCoatUV=vClearCoatBumpUV*frontFacingMultiplier;mat3 TBNClearCoat=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);
#endif
#if DEBUGMODE>0
outParams.TBNClearCoat=TBNClearCoat;
#endif
#ifdef OBJECTSPACE_NORMALMAP
clearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);clearCoatNormalW=normalize(mat3(normalMatrix)*clearCoatNormalW);
#else
clearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
clearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
clearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;
#endif
outParams.clearCoatNormalW=clearCoatNormalW;outParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);float clearCoatNdotVUnclamped=dot(clearCoatNormalW,viewDirectionW);float clearCoatNdotV=absEps(clearCoatNdotVUnclamped);
#if DEBUGMODE>0
outParams.clearCoatNdotV=clearCoatNdotV;
#endif
#ifdef CLEARCOAT_TINT
vec3 clearCoatVRefract=refract(-viewDirectionW,clearCoatNormalW,vClearCoatRefractionParams.y);outParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));
#endif
#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))
vec3 environmentClearCoatBrdf=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);
#endif
#if defined(REFLECTION)
float clearCoatAlphaG=convertRoughnessToAverageSlope(clearCoatRoughness);
#ifdef SPECULARAA
clearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;
#endif
vec4 environmentClearCoatRadiance=vec4(0.,0.,0.,0.);vec3 clearCoatReflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),clearCoatNormalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
clearCoatReflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
vec3 clearCoatReflectionCoords=clearCoatReflectionVector;
#else
vec2 clearCoatReflectionCoords=clearCoatReflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
clearCoatReflectionCoords/=clearCoatReflectionVector.z;
#endif
clearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;
#endif
sampleReflectionTexture(
clearCoatAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
clearCoatNdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
clearCoatRoughness,
#endif
reflectionSampler,
clearCoatReflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentClearCoatRadiance
);
#if DEBUGMODE>0
outParams.environmentClearCoatRadiance=environmentClearCoatRadiance;
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 clearCoatEnvironmentReflectance=getReflectanceFromBRDFLookup(vec3(vClearCoatRefractionParams.x),environmentClearCoatBrdf);
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float clearCoatEho=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);clearCoatEnvironmentReflectance*=clearCoatEho;
#endif
#endif
#endif
#else
vec3 clearCoatEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV,vec3(1.),vec3(1.),sqrt(1.-clearCoatRoughness));
#endif
clearCoatEnvironmentReflectance*=clearCoatIntensity;
#if DEBUGMODE>0
outParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;
#endif
outParams.finalClearCoatRadianceScaled=
environmentClearCoatRadiance.rgb *
clearCoatEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(CLEARCOAT_TINT)
outParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);
#endif
float fresnelIBLClearCoat=fresnelSchlickGGX(clearCoatNdotV,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnelIBLClearCoat*=clearCoatIntensity;outParams.conservationFactor=(1.-fresnelIBLClearCoat);
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
outParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);
#endif
return outParams;}
#endif
`;C.IncludesShadersStore[Ep]||(C.IncludesShadersStore[Ep]=gO);const vp="pbrBlockIridescence",EO=`struct iridescenceOutParams
{float iridescenceIntensity;float iridescenceIOR;float iridescenceThickness;vec3 specularEnvironmentR0;};
#ifdef IRIDESCENCE
#define pbr_inline
#define inline
iridescenceOutParams iridescenceBlock(
in vec4 vIridescenceParams
,in float viewAngle
,in vec3 specularEnvironmentR0
#ifdef IRIDESCENCE_TEXTURE
,in vec2 iridescenceMapData
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
,in vec2 iridescenceThicknessMapData
#endif
#ifdef CLEARCOAT
,in float NdotVUnclamped
,in vec2 vClearCoatParams
#ifdef CLEARCOAT_TEXTURE
,in vec2 clearCoatMapData
#endif
#endif
)
{iridescenceOutParams outParams;float iridescenceIntensity=vIridescenceParams.x;float iridescenceIOR=vIridescenceParams.y;float iridescenceThicknessMin=vIridescenceParams.z;float iridescenceThicknessMax=vIridescenceParams.w;float iridescenceThicknessWeight=1.;
#ifdef IRIDESCENCE_TEXTURE
iridescenceIntensity*=iridescenceMapData.x;
#endif
#if defined(IRIDESCENCE_THICKNESS_TEXTURE)
iridescenceThicknessWeight=iridescenceThicknessMapData.g;
#endif
float iridescenceThickness=mix(iridescenceThicknessMin,iridescenceThicknessMax,iridescenceThicknessWeight);float topIor=1.; 
#ifdef CLEARCOAT
float clearCoatIntensity=vClearCoatParams.x;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#endif
topIor=mix(1.0,vClearCoatRefractionParams.w-1.,clearCoatIntensity);viewAngle=sqrt(1.0+square(1.0/topIor)*(square(NdotVUnclamped)-1.0));
#endif
vec3 iridescenceFresnel=evalIridescence(topIor,iridescenceIOR,viewAngle,iridescenceThickness,specularEnvironmentR0);outParams.specularEnvironmentR0=mix(specularEnvironmentR0,iridescenceFresnel,iridescenceIntensity);outParams.iridescenceIntensity=iridescenceIntensity;outParams.iridescenceThickness=iridescenceThickness;outParams.iridescenceIOR=iridescenceIOR;return outParams;}
#endif
`;C.IncludesShadersStore[vp]||(C.IncludesShadersStore[vp]=EO);const Tp="pbrBlockSubSurface",vO=`struct subSurfaceOutParams
{vec3 specularEnvironmentReflectance;
#ifdef SS_REFRACTION
vec3 finalRefraction;vec3 surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
float alpha;
#endif
#ifdef REFLECTION
float refractionFactorForIrradiance;
#endif
#endif
#ifdef SS_TRANSLUCENCY
vec3 transmittance;float translucencyIntensity;
#ifdef REFLECTION
vec3 refractionIrradiance;
#endif
#endif
#if DEBUGMODE>0
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec4 thicknessMap;
#endif
#ifdef SS_REFRACTION
vec4 environmentRefraction;vec3 refractionTransmittance;
#endif
#endif
};
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#define pbr_inline
#define inline
vec4 sampleEnvironmentRefraction(
in float ior
,in float thickness
,in float refractionLOD
,in vec3 normalW
,in vec3 vPositionW
,in vec3 viewDirectionW
,in mat4 view
,in vec4 vRefractionInfos
,in mat4 refractionMatrix
,in vec4 vRefractionMicrosurfaceInfos
,in float alphaG
#ifdef SS_REFRACTIONMAP_3D
,in samplerCube refractionSampler
#ifndef LODBASEDMICROSFURACE
,in samplerCube refractionSamplerLow
,in samplerCube refractionSamplerHigh
#endif
#else
,in sampler2D refractionSampler
#ifndef LODBASEDMICROSFURACE
,in sampler2D refractionSamplerLow
,in sampler2D refractionSamplerHigh
#endif
#endif
#ifdef ANISOTROPIC
,in anisotropicOutParams anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,in vec2 vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,in vec3 refractionPosition
,in vec3 refractionSize
#endif
) {vec4 environmentRefraction=vec4(0.,0.,0.,0.);
#ifdef ANISOTROPIC
vec3 refractionVector=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,ior);
#else
vec3 refractionVector=refract(-viewDirectionW,normalW,ior);
#endif
#ifdef SS_REFRACTIONMAP_OPPOSITEZ
refractionVector.z*=-1.0;
#endif
#ifdef SS_REFRACTIONMAP_3D
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;vec3 refractionCoords=refractionVector;refractionCoords=vec3(refractionMatrix*vec4(refractionCoords,0));
#else
#ifdef SS_USE_THICKNESS_AS_DEPTH
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*thickness,1.0)));
#else
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));
#endif
vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;
#endif
#ifdef LODBASEDMICROSFURACE
refractionLOD=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;
#ifdef SS_LODINREFRACTIONALPHA
float automaticRefractionLOD=UNPACK_LOD(sampleRefraction(refractionSampler,refractionCoords).a);float requestedRefractionLOD=max(automaticRefractionLOD,refractionLOD);
#else
float requestedRefractionLOD=refractionLOD;
#endif
#if defined(REALTIME_FILTERING) && defined(SS_REFRACTIONMAP_3D)
environmentRefraction=vec4(radiance(alphaG,refractionSampler,refractionCoords,vRefractionFilteringInfo),1.0);
#else
environmentRefraction=sampleRefractionLod(refractionSampler,refractionCoords,requestedRefractionLOD);
#endif
#else
float lodRefractionNormalized=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));float lodRefractionNormalizedDoubled=lodRefractionNormalized*2.0;vec4 environmentRefractionMid=sampleRefraction(refractionSampler,refractionCoords);if (lodRefractionNormalizedDoubled<1.0){environmentRefraction=mix(
sampleRefraction(refractionSamplerHigh,refractionCoords),
environmentRefractionMid,
lodRefractionNormalizedDoubled
);} else {environmentRefraction=mix(
environmentRefractionMid,
sampleRefraction(refractionSamplerLow,refractionCoords),
lodRefractionNormalizedDoubled-1.0
);}
#endif
#ifdef SS_RGBDREFRACTION
environmentRefraction.rgb=fromRGBD(environmentRefraction);
#endif
#ifdef SS_GAMMAREFRACTION
environmentRefraction.rgb=toLinearSpace(environmentRefraction.rgb);
#endif
return environmentRefraction;}
#endif
#define pbr_inline
#define inline
subSurfaceOutParams subSurfaceBlock(
in vec3 vSubSurfaceIntensity
,in vec2 vThicknessParam
,in vec4 vTintColor
,in vec3 normalW
,in vec3 specularEnvironmentReflectance
#ifdef SS_THICKNESSANDMASK_TEXTURE
,in vec4 thicknessMap
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
,in vec4 refractionIntensityMap
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
,in vec4 translucencyIntensityMap
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
,in mat4 reflectionMatrix
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,in vec3 irradianceVector_
#endif
#if defined(REALTIME_FILTERING)
,in samplerCube reflectionSampler
,in vec2 vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,in sampler2D icdfSampler
#endif
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
,in samplerCube irradianceSampler
#else
,in sampler2D irradianceSampler
#endif
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
,in vec3 surfaceAlbedo
#endif
#ifdef SS_REFRACTION
,in vec3 vPositionW
,in vec3 viewDirectionW
,in mat4 view
,in vec4 vRefractionInfos
,in mat4 refractionMatrix
,in vec4 vRefractionMicrosurfaceInfos
,in vec4 vLightingIntensity
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
,in float alpha
#endif
#ifdef SS_LODINREFRACTIONALPHA
,in float NdotVUnclamped
#endif
#ifdef SS_LINEARSPECULARREFRACTION
,in float roughness
#endif
,in float alphaG
#ifdef SS_REFRACTIONMAP_3D
,in samplerCube refractionSampler
#ifndef LODBASEDMICROSFURACE
,in samplerCube refractionSamplerLow
,in samplerCube refractionSamplerHigh
#endif
#else
,in sampler2D refractionSampler
#ifndef LODBASEDMICROSFURACE
,in sampler2D refractionSamplerLow
,in sampler2D refractionSamplerHigh
#endif
#endif
#ifdef ANISOTROPIC
,in anisotropicOutParams anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,in vec2 vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,in vec3 refractionPosition
,in vec3 refractionSize
#endif
#ifdef SS_DISPERSION
,in float dispersion
#endif
#endif
#ifdef SS_TRANSLUCENCY
,in vec3 vDiffusionDistance
,in vec4 vTranslucencyColor
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
,in vec4 translucencyColorMap
#endif
#endif
)
{subSurfaceOutParams outParams;outParams.specularEnvironmentReflectance=specularEnvironmentReflectance;
#ifdef SS_REFRACTION
float refractionIntensity=vSubSurfaceIntensity.x;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
refractionIntensity*=(1.0-alpha);outParams.alpha=1.0;
#endif
#endif
#ifdef SS_TRANSLUCENCY
float translucencyIntensity=vSubSurfaceIntensity.y;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
#ifdef SS_USE_GLTF_TEXTURES
float thickness=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;
#else
float thickness=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;
#endif
#if DEBUGMODE>0
outParams.thicknessMap=thicknessMap;
#endif
#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS)
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=thicknessMap.r;
#else
refractionIntensity*=thicknessMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS)
#ifdef SS_USE_GLTF_TEXTURES
translucencyIntensity*=thicknessMap.a;
#else
translucencyIntensity*=thicknessMap.b;
#endif
#endif
#else
float thickness=vThicknessParam.y;
#endif
#if defined(SS_REFRACTION) && defined(SS_REFRACTIONINTENSITY_TEXTURE)
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=refractionIntensityMap.r;
#else
refractionIntensity*=refractionIntensityMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCYINTENSITY_TEXTURE)
#ifdef SS_USE_GLTF_TEXTURES
translucencyIntensity*=translucencyIntensityMap.a;
#else
translucencyIntensity*=translucencyIntensityMap.b;
#endif
#endif
#ifdef SS_TRANSLUCENCY
thickness=maxEps(thickness);vec4 translucencyColor=vTranslucencyColor;
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
translucencyColor*=translucencyColorMap;
#endif
vec3 transmittance=transmittanceBRDF_Burley(translucencyColor.rgb,vDiffusionDistance,thickness);transmittance*=translucencyIntensity;outParams.transmittance=transmittance;outParams.translucencyIntensity=translucencyIntensity;
#endif
#ifdef SS_REFRACTION
vec4 environmentRefraction=vec4(0.,0.,0.,0.);
#ifdef SS_HAS_THICKNESS
float ior=vRefractionInfos.y;
#else
float ior=vRefractionMicrosurfaceInfos.w;
#endif
#ifdef SS_LODINREFRACTIONALPHA
float refractionAlphaG=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);
#elif defined(SS_LINEARSPECULARREFRACTION)
float refractionRoughness=alphaG;refractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);
#else
float refractionAlphaG=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);
#endif
float refraction_ior=vRefractionInfos.y;
#ifdef SS_DISPERSION
float realIOR=1.0/refraction_ior;float iorDispersionSpread=0.04*dispersion*(realIOR-1.0);vec3 iors=vec3(1.0/(realIOR-iorDispersionSpread),refraction_ior,1.0/(realIOR+iorDispersionSpread));for (int i=0; i<3; i++) {refraction_ior=iors[i];
#endif
vec4 envSample=sampleEnvironmentRefraction(refraction_ior,thickness,refractionLOD,normalW,vPositionW,viewDirectionW,view,vRefractionInfos,refractionMatrix,vRefractionMicrosurfaceInfos,alphaG
#ifdef SS_REFRACTIONMAP_3D
,refractionSampler
#ifndef LODBASEDMICROSFURACE
,refractionSamplerLow
,refractionSamplerHigh
#endif
#else
,refractionSampler
#ifndef LODBASEDMICROSFURACE
,refractionSamplerLow
,refractionSamplerHigh
#endif
#endif
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,refractionPosition
,refractionSize
#endif
);
#ifdef SS_DISPERSION
environmentRefraction[i]=envSample[i];}
#else
environmentRefraction=envSample;
#endif
environmentRefraction.rgb*=vRefractionInfos.x;
#endif
#ifdef SS_REFRACTION
vec3 refractionTransmittance=vec3(refractionIntensity);
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambert(volumeAlbedo,thickness);
#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)
float maxChannel=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);vec3 volumeAlbedo=saturate(maxChannel*surfaceAlbedo);environmentRefraction.rgb*=volumeAlbedo;
#else
vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambert(volumeAlbedo,vThicknessParam.y);
#endif
#ifdef SS_ALBEDOFORREFRACTIONTINT
environmentRefraction.rgb*=surfaceAlbedo.rgb;
#endif
outParams.surfaceAlbedo=surfaceAlbedo*(1.-refractionIntensity);
#ifdef REFLECTION
outParams.refractionFactorForIrradiance=(1.-refractionIntensity);
#endif
#ifdef UNUSED_MULTIPLEBOUNCES
vec3 bounceSpecularEnvironmentReflectance=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);outParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,refractionIntensity);
#endif
refractionTransmittance*=1.0-max(outParams.specularEnvironmentReflectance.r,max(outParams.specularEnvironmentReflectance.g,outParams.specularEnvironmentReflectance.b));
#if DEBUGMODE>0
outParams.refractionTransmittance=refractionTransmittance;
#endif
outParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;
#if DEBUGMODE>0
outParams.environmentRefraction=environmentRefraction;
#endif
#endif
#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)
#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#else
vec3 irradianceVector=irradianceVector_;
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP)
#if defined(REALTIME_FILTERING)
vec3 refractionIrradiance=irradiance(reflectionSampler,-irradianceVector,vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,icdfSampler
#endif
);
#else
vec3 refractionIrradiance=computeEnvironmentIrradiance(-irradianceVector);
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
vec3 irradianceCoords=irradianceVector;
#else
vec2 irradianceCoords=irradianceVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
irradianceCoords/=irradianceVector.z;
#endif
irradianceCoords.y=1.0-irradianceCoords.y;
#endif
vec4 refractionIrradiance=sampleReflection(irradianceSampler,-irradianceCoords);
#ifdef RGBDREFLECTION
refractionIrradiance.rgb=fromRGBD(refractionIrradiance);
#endif
#ifdef GAMMAREFLECTION
refractionIrradiance.rgb=toLinearSpace(refractionIrradiance.rgb);
#endif
#else
vec4 refractionIrradiance=vec4(0.);
#endif
refractionIrradiance.rgb*=transmittance;
#ifdef SS_ALBEDOFORTRANSLUCENCYTINT
refractionIrradiance.rgb*=surfaceAlbedo.rgb;
#endif
outParams.refractionIrradiance=refractionIrradiance.rgb;
#endif
return outParams;}
#endif
`;C.IncludesShadersStore[Tp]||(C.IncludesShadersStore[Tp]=vO);const Sp="pbrBlockNormalGeometric",TO=`vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#endif
vec3 geometricNormalW=normalW;
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
geometricNormalW=gl_FrontFacing ? geometricNormalW : -geometricNormalW;
#endif
`;C.IncludesShadersStore[Sp]||(C.IncludesShadersStore[Sp]=TO);const Ap="pbrBlockNormalFinal",SO=`#if defined(FORCENORMALFORWARD) && defined(NORMAL)
vec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#if defined(TWOSIDEDLIGHTING)
faceNormal=gl_FrontFacing ? faceNormal : -faceNormal;
#endif
normalW*=sign(dot(normalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
normalW=gl_FrontFacing ? normalW : -normalW;
#endif
`;C.IncludesShadersStore[Ap]||(C.IncludesShadersStore[Ap]=SO);const Rp="pbrBlockLightmapInit",AO=`#ifdef LIGHTMAP
vec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor.rgb=fromRGBD(lightmapColor);
#endif
#ifdef GAMMALIGHTMAP
lightmapColor.rgb=toLinearSpace(lightmapColor.rgb);
#endif
lightmapColor.rgb*=vLightmapInfos.y;
#endif
`;C.IncludesShadersStore[Rp]||(C.IncludesShadersStore[Rp]=AO);const Cp="pbrBlockGeometryInfo",RO=`float NdotVUnclamped=dot(normalW,viewDirectionW);float NdotV=absEps(NdotVUnclamped);float alphaG=convertRoughnessToAverageSlope(roughness);vec2 AARoughnessFactors=getAARoughnessFactors(normalW.xyz);
#ifdef SPECULARAA
alphaG+=AARoughnessFactors.y;
#endif
#if defined(ENVIRONMENTBRDF)
vec3 environmentBrdf=getBRDFLookup(NdotV,roughness);
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
#ifdef AMBIENTINGRAYSCALE
float ambientMonochrome=aoOut.ambientOcclusionColor.r;
#else
float ambientMonochrome=getLuminance(aoOut.ambientOcclusionColor);
#endif
float seo=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float eho=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);
#endif
#endif
#endif
#endif
`;C.IncludesShadersStore[Cp]||(C.IncludesShadersStore[Cp]=RO);const Ip="pbrBlockReflectance0",CO=`float reflectance=max(max(reflectivityOut.surfaceReflectivityColor.r,reflectivityOut.surfaceReflectivityColor.g),reflectivityOut.surfaceReflectivityColor.b);vec3 specularEnvironmentR0=reflectivityOut.surfaceReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
vec3 specularEnvironmentR90=vec3(metallicReflectanceFactors.a);
#else 
vec3 specularEnvironmentR90=vec3(1.0,1.0,1.0);
#endif
#ifdef ALPHAFRESNEL
float reflectance90=fresnelGrazingReflectance(reflectance);specularEnvironmentR90=specularEnvironmentR90*reflectance90;
#endif
`;C.IncludesShadersStore[Ip]||(C.IncludesShadersStore[Ip]=CO);const bp="pbrBlockReflectance",IO=`#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 specularEnvironmentReflectance=getReflectanceFromBRDFLookup(clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,environmentBrdf);
#ifdef RADIANCEOCCLUSION
specularEnvironmentReflectance*=seo;
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
specularEnvironmentReflectance*=eho;
#endif
#endif
#endif
#else
vec3 specularEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));
#endif
#ifdef CLEARCOAT
specularEnvironmentReflectance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
specularEnvironmentReflectance*=clearcoatOut.absorption;
#endif
#endif
`;C.IncludesShadersStore[bp]||(C.IncludesShadersStore[bp]=IO);const xp="pbrBlockDirectLighting",bO=`vec3 diffuseBase=vec3(0.,0.,0.);
#ifdef SPECULARTERM
vec3 specularBase=vec3(0.,0.,0.);
#endif
#ifdef CLEARCOAT
vec3 clearCoatBase=vec3(0.,0.,0.);
#endif
#ifdef SHEEN
vec3 sheenBase=vec3(0.,0.,0.);
#endif
preLightingInfo preInfo;lightingInfo info;float shadow=1.; 
float aggShadow=0.;float numLights=0.;
#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
vec3 absorption=vec3(0.);
#endif
`;C.IncludesShadersStore[xp]||(C.IncludesShadersStore[xp]=bO);const yp="pbrBlockFinalLitComponents",xO=`aggShadow=aggShadow/numLights;
#if defined(ENVIRONMENTBRDF)
#ifdef MS_BRDF_ENERGY_CONSERVATION
vec3 energyConservationFactor=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);
#endif
#endif
#ifndef METALLICWORKFLOW
#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION
surfaceAlbedo.rgb=(1.-reflectance)*surfaceAlbedo.rgb;
#endif
#endif
#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)
surfaceAlbedo.rgb=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;
#endif
#ifdef REFLECTION
vec3 finalIrradiance=reflectionOut.environmentIrradiance;
#if defined(CLEARCOAT)
finalIrradiance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
finalIrradiance*=clearcoatOut.absorption;
#endif
#endif
finalIrradiance*=surfaceAlbedo.rgb;
#if defined(SS_REFRACTION)
finalIrradiance*=subSurfaceOut.refractionFactorForIrradiance;
#endif
#if defined(SS_TRANSLUCENCY)
finalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);finalIrradiance+=subSurfaceOut.refractionIrradiance;
#endif
finalIrradiance*=vLightingIntensity.z;finalIrradiance*=aoOut.ambientOcclusionColor;
#endif
#ifdef SPECULARTERM
vec3 finalSpecular=specularBase;finalSpecular=max(finalSpecular,0.0);vec3 finalSpecularScaled=finalSpecular*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalSpecularScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalSpecularScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef REFLECTION
vec3 finalRadiance=reflectionOut.environmentRadiance.rgb;finalRadiance*=subSurfaceOut.specularEnvironmentReflectance;vec3 finalRadianceScaled=finalRadiance*vLightingIntensity.z;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalRadianceScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalRadianceScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef SHEEN
vec3 finalSheen=sheenBase*sheenOut.sheenColor;finalSheen=max(finalSheen,0.0);vec3 finalSheenScaled=finalSheen*vLightingIntensity.x*vLightingIntensity.w;
#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef CLEARCOAT
vec3 finalClearCoat=clearCoatBase;finalClearCoat=max(finalClearCoat,0.0);vec3 finalClearCoatScaled=finalClearCoat*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;
#ifdef CLEARCOAT_TINT
subSurfaceOut.finalRefraction*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef ALPHABLEND
float luminanceOverAlpha=0.0;
#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)
luminanceOverAlpha+=getLuminance(finalRadianceScaled);
#if defined(CLEARCOAT)
luminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);
#endif
#endif
#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)
luminanceOverAlpha+=getLuminance(finalSpecularScaled);
#endif
#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)
luminanceOverAlpha+=getLuminance(finalClearCoatScaled);
#endif
#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)
alpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);
#endif
#endif
`;C.IncludesShadersStore[yp]||(C.IncludesShadersStore[yp]=xO);const Mp="pbrBlockFinalUnlitComponents",yO=`vec3 finalDiffuse=diffuseBase;
#if !defined(SS_TRANSLUCENCY)
finalDiffuse*=surfaceAlbedo.rgb;
#endif
finalDiffuse=max(finalDiffuse,0.0);finalDiffuse*=vLightingIntensity.x;vec3 finalAmbient=vAmbientColor;finalAmbient*=surfaceAlbedo.rgb;vec3 finalEmissive=vEmissiveColor;
#ifdef EMISSIVE
vec3 emissiveColorTex=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb;
#ifdef GAMMAEMISSIVE
finalEmissive*=toLinearSpace(emissiveColorTex.rgb);
#else
finalEmissive*=emissiveColorTex.rgb;
#endif
finalEmissive*= vEmissiveInfos.y;
#endif
finalEmissive*=vLightingIntensity.y;
#ifdef AMBIENT
vec3 ambientOcclusionForDirectDiffuse=mix(vec3(1.),aoOut.ambientOcclusionColor,vAmbientInfos.w);
#else
vec3 ambientOcclusionForDirectDiffuse=aoOut.ambientOcclusionColor;
#endif
finalAmbient*=aoOut.ambientOcclusionColor;finalDiffuse*=ambientOcclusionForDirectDiffuse;
`;C.IncludesShadersStore[Mp]||(C.IncludesShadersStore[Mp]=yO);const Pp="pbrBlockFinalColorComposition",MO=`vec4 finalColor=vec4(
#ifndef UNLIT
#ifdef REFLECTION
finalIrradiance +
#endif
#ifdef SPECULARTERM
finalSpecularScaled +
#endif
#ifdef SHEEN
finalSheenScaled +
#endif
#ifdef CLEARCOAT
finalClearCoatScaled +
#endif
#ifdef REFLECTION
finalRadianceScaled +
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled +
#endif
#ifdef CLEARCOAT
clearcoatOut.finalClearCoatRadianceScaled +
#endif
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction +
#endif
#endif
finalAmbient +
finalDiffuse,
alpha);
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
finalColor.rgb*=lightmapColor.rgb;
#else
finalColor.rgb+=lightmapColor.rgb;
#endif
#endif
#endif
finalColor.rgb+=finalEmissive;
#define CUSTOM_FRAGMENT_BEFORE_FOG
finalColor=max(finalColor,0.0);
`;C.IncludesShadersStore[Pp]||(C.IncludesShadersStore[Pp]=MO);const Op="pbrBlockImageProcessing",PO=`#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)
#if !defined(SKIPFINALCOLORCLAMP)
finalColor.rgb=clamp(finalColor.rgb,0.,30.0);
#endif
#else
finalColor=applyImageProcessing(finalColor);
#endif
finalColor.a*=visibility;
#ifdef PREMULTIPLYALPHA
finalColor.rgb*=finalColor.a;
#endif
`;C.IncludesShadersStore[Op]||(C.IncludesShadersStore[Op]=PO);const Dp="pbrBlockPrePass",OO=`float writeGeometryInfo=finalColor.a>ALPHATESTVALUE ? 1.0 : 0.0;
#ifdef PREPASS_POSITION
gl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_LOCAL_POSITION
gl_FragData[PREPASS_LOCAL_POSITION_INDEX]=vec4(vPosition,writeGeometryInfo);
#endif
#if defined(PREPASS_VELOCITY)
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#elif defined(PREPASS_VELOCITY_LINEAR)
vec2 velocity=vec2(0.5)*((vPreviousPosition.xy/vPreviousPosition.w)-(vCurrentPosition.xy/vCurrentPosition.w));gl_FragData[PREPASS_VELOCITY_LINEAR_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO
gl_FragData[PREPASS_ALBEDO_INDEX]=vec4(surfaceAlbedo,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
vec3 sqAlbedo=sqrt(surfaceAlbedo); 
#endif
#ifdef PREPASS_IRRADIANCE
vec3 irradiance=finalDiffuse;
#ifndef UNLIT
#ifdef REFLECTION
irradiance+=finalIrradiance;
#endif
#endif
#ifdef SS_SCATTERING
#ifdef PREPASS_COLOR
gl_FragData[PREPASS_COLOR_INDEX]=vec4(finalColor.rgb-irradiance,finalColor.a); 
#endif
irradiance/=sqAlbedo;
#else
#ifdef PREPASS_COLOR
gl_FragData[PREPASS_COLOR_INDEX]=finalColor; 
#endif
float scatteringDiffusionProfile=255.;
#endif
gl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(clamp(irradiance,vec3(0.),vec3(1.)),writeGeometryInfo*scatteringDiffusionProfile/255.); 
#elif defined(PREPASS_COLOR)
gl_FragData[PREPASS_COLOR_INDEX]=vec4(finalColor.rgb,finalColor.a);
#endif
#ifdef PREPASS_DEPTH
gl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_SCREENSPACE_DEPTH
gl_FragData[PREPASS_SCREENSPACE_DEPTH_INDEX]=vec4(gl_FragCoord.z,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMAL
#ifdef PREPASS_NORMAL_WORLDSPACE
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalW,writeGeometryInfo);
#else
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo);
#endif
#endif
#ifdef PREPASS_WORLD_NORMAL
gl_FragData[PREPASS_WORLD_NORMAL_INDEX]=vec4(normalW*0.5+0.5,writeGeometryInfo); 
#endif
#ifdef PREPASS_ALBEDO_SQRT
gl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(sqAlbedo,writeGeometryInfo); 
#endif
#ifdef PREPASS_REFLECTIVITY
#ifndef UNLIT
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(specularEnvironmentR0,microSurface)*writeGeometryInfo;
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4( 0.0,0.0,0.0,1.0 )*writeGeometryInfo;
#endif
#endif
`;C.IncludesShadersStore[Dp]||(C.IncludesShadersStore[Dp]=OO);const Lp="pbrDebug",DO=`#if DEBUGMODE>0
if (vClipSpacePosition.x/vClipSpacePosition.w>=vDebugMode.x) {
#if DEBUGMODE==1
gl_FragColor.rgb=vPositionW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==2 && defined(NORMAL)
gl_FragColor.rgb=vNormalW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)
gl_FragColor.rgb=TBN[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)
gl_FragColor.rgb=TBN[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==5
gl_FragColor.rgb=normalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==6 && defined(MAINUV1)
gl_FragColor.rgb=vec3(vMainUV1,0.0);
#elif DEBUGMODE==7 && defined(MAINUV2)
gl_FragColor.rgb=vec3(vMainUV2,0.0);
#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
gl_FragColor.rgb=clearcoatOut.TBNClearCoat[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
gl_FragColor.rgb=clearcoatOut.TBNClearCoat[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==10 && defined(CLEARCOAT)
gl_FragColor.rgb=clearcoatOut.clearCoatNormalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==11 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicNormal;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==12 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicTangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==13 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicBitangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==20 && defined(ALBEDO)
gl_FragColor.rgb=albedoTexture.rgb;
#ifndef GAMMAALBEDO
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==21 && defined(AMBIENT)
gl_FragColor.rgb=aoOut.ambientOcclusionColorMap.rgb;
#elif DEBUGMODE==22 && defined(OPACITY)
gl_FragColor.rgb=opacityMap.rgb;
#elif DEBUGMODE==23 && defined(EMISSIVE)
gl_FragColor.rgb=emissiveColorTex.rgb;
#ifndef GAMMAEMISSIVE
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==24 && defined(LIGHTMAP)
gl_FragColor.rgb=lightmapColor.rgb;
#ifndef GAMMALIGHTMAP
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceMetallicColorMap.rgb;
#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceReflectivityColorMap.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatMapData.rg,0.0);
#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
gl_FragColor.rgb=clearcoatOut.clearCoatTintMapData.rgb;
#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)
gl_FragColor.rgb=sheenOut.sheenMapData.rgb;
#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)
gl_FragColor.rgb=anisotropicOut.anisotropyMapData.rgb;
#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)
gl_FragColor.rgb=subSurfaceOut.thicknessMap.rgb;
#elif DEBUGMODE==32 && defined(BUMP)
gl_FragColor.rgb=texture2D(bumpSampler,vBumpUV).rgb;
#elif DEBUGMODE==40 && defined(SS_REFRACTION)
gl_FragColor.rgb=subSurfaceOut.environmentRefraction.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==41 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentRadiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)
gl_FragColor.rgb=clearcoatOut.environmentClearCoatRadiance.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==50
gl_FragColor.rgb=diffuseBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==51 && defined(SPECULARTERM)
gl_FragColor.rgb=specularBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==52 && defined(CLEARCOAT)
gl_FragColor.rgb=clearCoatBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==53 && defined(SHEEN)
gl_FragColor.rgb=sheenBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==54 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentIrradiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==60
gl_FragColor.rgb=surfaceAlbedo.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==61
gl_FragColor.rgb=clearcoatOut.specularEnvironmentR0;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=vec3(reflectivityOut.metallicRoughness.r);
#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.metallicF0;
#elif DEBUGMODE==63
gl_FragColor.rgb=vec3(roughness);
#elif DEBUGMODE==64
gl_FragColor.rgb=vec3(alphaG);
#elif DEBUGMODE==65
gl_FragColor.rgb=vec3(NdotV);
#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
gl_FragColor.rgb=clearcoatOut.clearCoatColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==67 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatRoughness);
#elif DEBUGMODE==68 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatNdotV);
#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)
gl_FragColor.rgb=subSurfaceOut.transmittance;
#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)
gl_FragColor.rgb=subSurfaceOut.refractionTransmittance;
#elif DEBUGMODE==72
gl_FragColor.rgb=vec3(microSurface);
#elif DEBUGMODE==73
gl_FragColor.rgb=vAlbedoColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==74 && !defined(METALLICWORKFLOW)
gl_FragColor.rgb=vReflectivityColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==75
gl_FragColor.rgb=vEmissiveColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)
gl_FragColor.rgb=vec3(seo);
#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
gl_FragColor.rgb=vec3(eho);
#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)
gl_FragColor.rgb=vec3(energyConservationFactor);
#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=specularEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=clearcoatOut.clearCoatEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)
gl_FragColor.rgb=sheenOut.sheenEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==86 && defined(ALPHABLEND)
gl_FragColor.rgb=vec3(luminanceOverAlpha);
#elif DEBUGMODE==87
gl_FragColor.rgb=vec3(alpha);
#elif DEBUGMODE==88 && defined(ALBEDO)
gl_FragColor.rgb=vec3(albedoTexture.a);
#elif DEBUGMODE==89
gl_FragColor.rgb=aoOut.ambientOcclusionColor.rgb;
#else
float stripeWidth=30.;float stripePos=floor(gl_FragCoord.x/stripeWidth);float whichColor=mod(stripePos,2.);vec3 color1=vec3(.6,.2,.2);vec3 color2=vec3(.3,.1,.1);gl_FragColor.rgb=mix(color1,color2,whichColor);
#endif
gl_FragColor.rgb*=vDebugMode.y;
#ifdef DEBUGMODE_NORMALIZE
gl_FragColor.rgb=normalize(gl_FragColor.rgb)*0.5+0.5;
#endif
#ifdef DEBUGMODE_GAMMA
gl_FragColor.rgb=toGammaSpace(gl_FragColor.rgb);
#endif
gl_FragColor.a=1.0;
#ifdef PREPASS
gl_FragData[0]=toLinearSpace(gl_FragColor); 
gl_FragData[1]=vec4(0.,0.,0.,0.); 
#endif
#ifdef DEBUGMODE_FORCERETURN
return;
#endif
}
#endif
`;C.IncludesShadersStore[Lp]||(C.IncludesShadersStore[Lp]=DO);const Yl="pbrPixelShader",qE=`#define CUSTOM_FRAGMENT_EXTENSION
#if defined(BUMP) || !defined(NORMAL) || defined(FORCENORMALFORWARD) || defined(SPECULARAA) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#extension GL_OES_standard_derivatives : enable
#endif
#ifdef LODBASEDMICROSFURACE
#extension GL_EXT_shader_texture_lod : enable
#endif
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<prePassDeclaration>[SCENE_MRT_COUNT]
precision highp float;
#include<oitDeclaration>
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE
#endif
#include<__decl__pbrFragment>
#include<pbrFragmentExtraDeclaration>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<pbrFragmentSamplersDeclaration>
#include<imageProcessingDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#include<helperFunctions>
#include<subSurfaceScatteringFunctions>
#include<importanceSampling>
#include<pbrHelperFunctions>
#include<imageProcessingFunctions>
#include<shadowsFragmentFunctions>
#include<harmonicsFunctions>
#include<pbrDirectLightingSetupFunctions>
#include<pbrDirectLightingFalloffFunctions>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
#include<pbrDirectLightingFunctions>
#include<pbrIBLFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#ifdef REFLECTION
#include<reflectionFunction>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
#include<pbrBlockAlbedoOpacity>
#include<pbrBlockReflectivity>
#include<pbrBlockAmbientOcclusion>
#include<pbrBlockAlphaFresnel>
#include<pbrBlockAnisotropic>
#include<pbrBlockReflection>
#include<pbrBlockSheen>
#include<pbrBlockClearcoat>
#include<pbrBlockIridescence>
#include<pbrBlockSubSurface>
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#include<pbrBlockNormalGeometric>
#include<bumpFragment>
#include<pbrBlockNormalFinal>
albedoOpacityOutParams albedoOpacityOut;
#ifdef ALBEDO
vec4 albedoTexture=texture2D(albedoSampler,vAlbedoUV+uvOffset);
#endif
#ifdef BASEWEIGHT
vec4 baseWeightTexture=texture2D(baseWeightSampler,vBaseWeightUV+uvOffset);
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);
#endif
#ifdef DECAL
vec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);
#endif
albedoOpacityOut=albedoOpacityBlock(
vAlbedoColor
#ifdef ALBEDO
,albedoTexture
,vAlbedoInfos
#endif
,baseWeight
#ifdef BASEWEIGHT
,baseWeightTexture
,vBaseWeightInfos
#endif
#ifdef OPACITY
,opacityMap
,vOpacityInfos
#endif
#ifdef DETAIL
,detailColor
,vDetailInfos
#endif
#ifdef DECAL
,decalColor
,vDecalInfos
#endif
);vec3 surfaceAlbedo=albedoOpacityOut.surfaceAlbedo;float alpha=albedoOpacityOut.alpha;
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
#include<depthPrePass>
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
ambientOcclusionOutParams aoOut;
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb;
#endif
aoOut=ambientOcclusionBlock(
#ifdef AMBIENT
ambientOcclusionColorMap,
vAmbientInfos
#endif
);
#include<pbrBlockLightmapInit>
#ifdef UNLIT
vec3 diffuseBase=vec3(1.,1.,1.);
#else 
vec3 baseColor=surfaceAlbedo;reflectivityOutParams reflectivityOut;
#if defined(REFLECTIVITY)
vec4 surfaceMetallicOrReflectivityColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);vec4 baseReflectivity=surfaceMetallicOrReflectivityColorMap;
#ifndef METALLICWORKFLOW
#ifdef REFLECTIVITY_GAMMA
surfaceMetallicOrReflectivityColorMap=toLinearSpace(surfaceMetallicOrReflectivityColorMap);
#endif
surfaceMetallicOrReflectivityColorMap.rgb*=vReflectivityInfos.y;
#endif
#endif
#if defined(MICROSURFACEMAP)
vec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;
#endif
#ifdef METALLICWORKFLOW
vec4 metallicReflectanceFactors=vMetallicReflectanceFactors;
#ifdef REFLECTANCE
vec4 reflectanceFactorsMap=texture2D(reflectanceSampler,vReflectanceUV+uvOffset);
#ifdef REFLECTANCE_GAMMA
reflectanceFactorsMap=toLinearSpace(reflectanceFactorsMap);
#endif
metallicReflectanceFactors.rgb*=reflectanceFactorsMap.rgb;
#endif
#ifdef METALLIC_REFLECTANCE
vec4 metallicReflectanceFactorsMap=texture2D(metallicReflectanceSampler,vMetallicReflectanceUV+uvOffset);
#ifdef METALLIC_REFLECTANCE_GAMMA
metallicReflectanceFactorsMap=toLinearSpace(metallicReflectanceFactorsMap);
#endif
#ifndef METALLIC_REFLECTANCE_USE_ALPHA_ONLY
metallicReflectanceFactors.rgb*=metallicReflectanceFactorsMap.rgb;
#endif
metallicReflectanceFactors*=metallicReflectanceFactorsMap.a;
#endif
#endif
reflectivityOut=reflectivityBlock(
vReflectivityColor
#ifdef METALLICWORKFLOW
,surfaceAlbedo
,metallicReflectanceFactors
#endif
#ifdef REFLECTIVITY
,vReflectivityInfos
,surfaceMetallicOrReflectivityColorMap
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
,aoOut.ambientOcclusionColor
#endif
#ifdef MICROSURFACEMAP
,microSurfaceTexel
#endif
#ifdef DETAIL
,detailColor
,vDetailInfos
#endif
);float microSurface=reflectivityOut.microSurface;float roughness=reflectivityOut.roughness;
#ifdef METALLICWORKFLOW
surfaceAlbedo=reflectivityOut.surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
aoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;
#endif
#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
alphaFresnelOutParams alphaFresnelOut;alphaFresnelOut=alphaFresnelBlock(
normalW,
viewDirectionW,
alpha,
microSurface
);alpha=alphaFresnelOut.alpha;
#endif
#endif
#include<pbrBlockGeometryInfo>
#ifdef ANISOTROPIC
anisotropicOutParams anisotropicOut;
#ifdef ANISOTROPIC_TEXTURE
vec3 anisotropyMapData=texture2D(anisotropySampler,vAnisotropyUV+uvOffset).rgb*vAnisotropyInfos.y;
#endif
anisotropicOut=anisotropicBlock(
vAnisotropy,
roughness,
#ifdef ANISOTROPIC_TEXTURE
anisotropyMapData,
#endif
TBN,
normalW,
viewDirectionW
);
#endif
#ifdef REFLECTION
reflectionOutParams reflectionOut;
#ifndef USE_CUSTOM_REFLECTION
reflectionOut=reflectionBlock(
vPositionW
,normalW
,alphaG
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,roughness
#endif
,reflectionSampler
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,vEnvironmentIrradiance
#endif
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
,reflectionMatrix
#endif
#ifdef USEIRRADIANCEMAP
,irradianceSampler
#endif
#ifndef LODBASEDMICROSFURACE
,reflectionSamplerLow
,reflectionSamplerHigh
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,icdfSampler
#endif
#endif
);
#else
#define CUSTOM_REFLECTION
#endif
#endif
#include<pbrBlockReflectance0>
#ifdef SHEEN
sheenOutParams sheenOut;
#ifdef SHEEN_TEXTURE
vec4 sheenMapData=texture2D(sheenSampler,vSheenUV+uvOffset);
#endif
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 sheenMapRoughnessData=texture2D(sheenRoughnessSampler,vSheenRoughnessUV+uvOffset)*vSheenInfos.w;
#endif
sheenOut=sheenBlock(
vSheenColor
#ifdef SHEEN_ROUGHNESS
,vSheenRoughness
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
,sheenMapRoughnessData
#endif
#endif
,roughness
#ifdef SHEEN_TEXTURE
,sheenMapData
,vSheenInfos.y
#endif
,reflectance
#ifdef SHEEN_LINKWITHALBEDO
,baseColor
,surfaceAlbedo
#endif
#ifdef ENVIRONMENTBRDF
,NdotV
,environmentBrdf
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,AARoughnessFactors
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
,vLightingIntensity
,reflectionSampler
,reflectionOut.reflectionCoords
,NdotVUnclamped
#ifndef LODBASEDMICROSFURACE
,reflectionSamplerLow
,reflectionSamplerHigh
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
,seo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
,eho
#endif
#endif
);
#ifdef SHEEN_LINKWITHALBEDO
surfaceAlbedo=sheenOut.surfaceAlbedo;
#endif
#endif
#ifdef CLEARCOAT
#ifdef CLEARCOAT_TEXTURE
vec2 clearCoatMapData=texture2D(clearCoatSampler,vClearCoatUV+uvOffset).rg*vClearCoatInfos.y;
#endif
#endif
#ifdef IRIDESCENCE
iridescenceOutParams iridescenceOut;
#ifdef IRIDESCENCE_TEXTURE
vec2 iridescenceMapData=texture2D(iridescenceSampler,vIridescenceUV+uvOffset).rg*vIridescenceInfos.y;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
vec2 iridescenceThicknessMapData=texture2D(iridescenceThicknessSampler,vIridescenceThicknessUV+uvOffset).rg*vIridescenceInfos.w;
#endif
iridescenceOut=iridescenceBlock(
vIridescenceParams
,NdotV
,specularEnvironmentR0
#ifdef IRIDESCENCE_TEXTURE
,iridescenceMapData
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
,iridescenceThicknessMapData
#endif
#ifdef CLEARCOAT
,NdotVUnclamped
,vClearCoatParams
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData
#endif
#endif
);float iridescenceIntensity=iridescenceOut.iridescenceIntensity;specularEnvironmentR0=iridescenceOut.specularEnvironmentR0;
#endif
clearcoatOutParams clearcoatOut;
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 clearCoatMapRoughnessData=texture2D(clearCoatRoughnessSampler,vClearCoatRoughnessUV+uvOffset)*vClearCoatInfos.w;
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
vec4 clearCoatTintMapData=texture2D(clearCoatTintSampler,vClearCoatTintUV+uvOffset);
#endif
#ifdef CLEARCOAT_BUMP
vec4 clearCoatBumpMapData=texture2D(clearCoatBumpSampler,vClearCoatBumpUV+uvOffset);
#endif
clearcoatOut=clearcoatBlock(
vPositionW
,geometricNormalW
,viewDirectionW
,vClearCoatParams
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
,clearCoatMapRoughnessData
#endif
,specularEnvironmentR0
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData
#endif
#ifdef CLEARCOAT_TINT
,vClearCoatTintParams
,clearCoatColorAtDistance
,vClearCoatRefractionParams
#ifdef CLEARCOAT_TINT_TEXTURE
,clearCoatTintMapData
#endif
#endif
#ifdef CLEARCOAT_BUMP
,vClearCoatBumpInfos
,clearCoatBumpMapData
,vClearCoatBumpUV
#if defined(TANGENT) && defined(NORMAL)
,vTBN
#else
,vClearCoatTangentSpaceParams
#endif
#ifdef OBJECTSPACE_NORMALMAP
,normalMatrix
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
,faceNormal
#endif
#ifdef REFLECTION
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
,vLightingIntensity
,reflectionSampler
#ifndef LODBASEDMICROSFURACE
,reflectionSamplerLow
,reflectionSamplerHigh
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
,(gl_FrontFacing ? 1. : -1.)
#endif
);
#else
clearcoatOut.specularEnvironmentR0=specularEnvironmentR0;
#endif
#include<pbrBlockReflectance>
subSurfaceOutParams subSurfaceOut;
#ifdef SUBSURFACE
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec4 thicknessMap=texture2D(thicknessSampler,vThicknessUV+uvOffset);
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
vec4 refractionIntensityMap=texture2D(refractionIntensitySampler,vRefractionIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
vec4 translucencyIntensityMap=texture2D(translucencyIntensitySampler,vTranslucencyIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
vec4 translucencyColorMap=texture2D(translucencyColorSampler,vTranslucencyColorUV+uvOffset);
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE_GAMMA
translucencyColorMap=toLinearSpace(translucencyColorMap);
#endif
#endif
subSurfaceOut=subSurfaceBlock(
vSubSurfaceIntensity
,vThicknessParam
,vTintColor
,normalW
,specularEnvironmentReflectance
#ifdef SS_THICKNESSANDMASK_TEXTURE
,thicknessMap
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
,refractionIntensityMap
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
,translucencyIntensityMap
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
,reflectionMatrix
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,reflectionOut.irradianceVector
#endif
#if defined(REALTIME_FILTERING)
,reflectionSampler
,vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,icdfSampler
#endif
#endif
#endif
#ifdef USEIRRADIANCEMAP
,irradianceSampler
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
,surfaceAlbedo
#endif
#ifdef SS_REFRACTION
,vPositionW
,viewDirectionW
,view
,vRefractionInfos
,refractionMatrix
,vRefractionMicrosurfaceInfos
,vLightingIntensity
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
,alpha
#endif
#ifdef SS_LODINREFRACTIONALPHA
,NdotVUnclamped
#endif
#ifdef SS_LINEARSPECULARREFRACTION
,roughness
#endif
,alphaG
,refractionSampler
#ifndef LODBASEDMICROSFURACE
,refractionSamplerLow
,refractionSamplerHigh
#endif
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,vRefractionPosition
,vRefractionSize
#endif
#ifdef SS_DISPERSION
,dispersion
#endif
#endif
#ifdef SS_TRANSLUCENCY
,vDiffusionDistance
,vTranslucencyColor
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
,translucencyColorMap
#endif
#endif
);
#ifdef SS_REFRACTION
surfaceAlbedo=subSurfaceOut.surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha=subSurfaceOut.alpha;
#endif
#endif
#else
subSurfaceOut.specularEnvironmentReflectance=specularEnvironmentReflectance;
#endif
#include<pbrBlockDirectLighting>
#include<lightFragment>[0..maxSimultaneousLights]
#include<pbrBlockFinalLitComponents>
#endif 
#include<pbrBlockFinalUnlitComponents>
#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION
#include<pbrBlockFinalColorComposition>
#include<logDepthFragment>
#include<fogFragment>(color,finalColor)
#include<pbrBlockImageProcessing>
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
#include<pbrBlockPrePass>
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=finalColor;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {frontColor.rgb+=finalColor.rgb*finalColor.a*alphaMultiplier;frontColor.a=1.0-alphaMultiplier*(1.0-finalColor.a);} else {backColor+=finalColor;}
#endif
#include<pbrDebug>
#define CUSTOM_FRAGMENT_MAIN_END
}
`;C.ShadersStore[Yl]||(C.ShadersStore[Yl]=qE);const LO={name:Yl,shader:qE},NO=Object.freeze(Object.defineProperty({__proto__:null,pbrPixelShader:LO},Symbol.toStringTag,{value:"Module"}));function Np(a){return Math.floor(a/8)}function Fp(a){return 1<<a%8}class FO{constructor(e){this.size=e,this._byteArray=new Uint8Array(Math.ceil(this.size/8))}get(e){if(e>=this.size)throw new RangeError("Bit index out of range");const t=Np(e),i=Fp(e);return(this._byteArray[t]&i)!==0}set(e,t){if(e>=this.size)throw new RangeError("Bit index out of range");const i=Np(e),r=Fp(e);t?this._byteArray[i]|=r:this._byteArray[i]&=~r}}function wO(a){const e=[],t=a.length/3;for(let l=0;l<t;l++)e.push([a[l*3],a[l*3+1],a[l*3+2]]);const i=new Map;e.forEach((l,c)=>{l.forEach(h=>{let f=i.get(h);f||i.set(h,f=[]),f.push(c)})});const r=new FO(t),s=[],n=l=>{const c=[l];for(;c.length>0;){const h=c.pop();r.get(h)||(r.set(h,!0),s.push(e[h]),e[h].forEach(f=>{const u=i.get(f);u&&u.forEach(d=>{r.get(d)||c.push(d)})}))}};for(let l=0;l<t;l++)r.get(l)||n(l);let o=0;s.forEach(l=>{a[o++]=l[0],a[o++]=l[1],a[o++]=l[2]})}const BO=Object.freeze(Object.defineProperty({__proto__:null,OptimizeIndices:wO},Symbol.toStringTag,{value:"Module"})),wp="kernelBlurVaryingDeclaration",UO="varying sampleCoord{X}: vec2f;";C.IncludesShadersStoreWGSL[wp]||(C.IncludesShadersStoreWGSL[wp]=UO);const Bp="packingFunctions",VO=`fn pack(depth: f32)->vec4f
{const bit_shift: vec4f= vec4f(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const bit_mask: vec4f= vec4f(0.0,1.0/255.0,1.0/255.0,1.0/255.0);var res: vec4f=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
fn unpack(color: vec4f)->f32
{const bit_shift: vec4f= vec4f(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}`;C.IncludesShadersStoreWGSL[Bp]||(C.IncludesShadersStoreWGSL[Bp]=VO);const Up="kernelBlurFragment",GO=`#ifdef DOF
factor=sampleCoC(fragmentInputs.sampleCoord{X}); 
computedWeight=KERNEL_WEIGHT{X}*factor;sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCoord{X}))*computedWeight;
#else
blend+=textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCoord{X})*computedWeight;
#endif
`;C.IncludesShadersStoreWGSL[Up]||(C.IncludesShadersStoreWGSL[Up]=GO);const Vp="kernelBlurFragment2",kO=`#ifdef DOF
factor=sampleCoC(fragmentInputs.sampleCenter+uniforms.delta*KERNEL_DEP_OFFSET{X});computedWeight=KERNEL_DEP_WEIGHT{X}*factor;sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_DEP_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCenter+uniforms.delta*KERNEL_DEP_OFFSET{X}))*computedWeight;
#else
blend+=textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCenter+uniforms.delta*KERNEL_DEP_OFFSET{X})*computedWeight;
#endif
`;C.IncludesShadersStoreWGSL[Vp]||(C.IncludesShadersStoreWGSL[Vp]=kO);const Kl="kernelBlurPixelShader",jE=`var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform delta: vec2f;varying sampleCenter: vec2f;
#ifdef DOF
var circleOfConfusionSamplerSampler: sampler;var circleOfConfusionSampler: texture_2d<f32>;fn sampleCoC(offset: vec2f)->f32 {var coc: f32=textureSample(circleOfConfusionSampler,circleOfConfusionSamplerSampler,offset).r;return coc; }
#endif
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
#ifdef PACKEDFLOAT
#include<packingFunctions>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var computedWeight: f32=0.0;
#ifdef PACKEDFLOAT
var blend: f32=0.;
#else
var blend: vec4f= vec4f(0.);
#endif
#ifdef DOF
var sumOfWeights: f32=CENTER_WEIGHT; 
var factor: f32=0.0;
#ifdef PACKEDFLOAT
blend+=unpack(textureSample(textureSampler,textureSamplerSampler,input.sampleCenter))*CENTER_WEIGHT;
#else
blend+=textureSample(textureSampler,textureSamplerSampler,input.sampleCenter)*CENTER_WEIGHT;
#endif
#endif
#include<kernelBlurFragment>[0..varyingCount]
#include<kernelBlurFragment2>[0..depCount]
#ifdef PACKEDFLOAT
fragmentOutputs.color=pack(blend);
#else
fragmentOutputs.color=blend;
#endif
#ifdef DOF
fragmentOutputs.color/=sumOfWeights;
#endif
}`;C.ShadersStoreWGSL[Kl]||(C.ShadersStoreWGSL[Kl]=jE);const WO={name:Kl,shader:jE},XO=Object.freeze(Object.defineProperty({__proto__:null,kernelBlurPixelShaderWGSL:WO},Symbol.toStringTag,{value:"Module"})),Gp="kernelBlurVertex",HO="vertexOutputs.sampleCoord{X}=vertexOutputs.sampleCenter+uniforms.delta*KERNEL_OFFSET{X};";C.IncludesShadersStoreWGSL[Gp]||(C.IncludesShadersStoreWGSL[Gp]=HO);const ql="kernelBlurVertexShader",ZE=`attribute position: vec2f;uniform delta: vec2f;varying sampleCenter: vec2f;
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {const madd: vec2f= vec2f(0.5,0.5);
#define CUSTOM_VERTEX_MAIN_BEGIN
vertexOutputs.sampleCenter=(input.position*madd+madd);
#include<kernelBlurVertex>[0..varyingCount]
vertexOutputs.position= vec4f(input.position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;C.ShadersStoreWGSL[ql]||(C.ShadersStoreWGSL[ql]=ZE);const zO={name:ql,shader:ZE},YO=Object.freeze(Object.defineProperty({__proto__:null,kernelBlurVertexShaderWGSL:zO},Symbol.toStringTag,{value:"Module"})),kp="kernelBlurVaryingDeclaration",KO="varying vec2 sampleCoord{X};";C.IncludesShadersStore[kp]||(C.IncludesShadersStore[kp]=KO);const Wp="packingFunctions",qO=`vec4 pack(float depth)
{const vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
float unpack(vec4 color)
{const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}`;C.IncludesShadersStore[Wp]||(C.IncludesShadersStore[Wp]=qO);const Xp="kernelBlurFragment",jO=`#ifdef DOF
factor=sampleCoC(sampleCoord{X}); 
computedWeight=KERNEL_WEIGHT{X}*factor;sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCoord{X}))*computedWeight;
#else
blend+=texture2D(textureSampler,sampleCoord{X})*computedWeight;
#endif
`;C.IncludesShadersStore[Xp]||(C.IncludesShadersStore[Xp]=jO);const Hp="kernelBlurFragment2",ZO=`#ifdef DOF
factor=sampleCoC(sampleCenter+delta*KERNEL_DEP_OFFSET{X});computedWeight=KERNEL_DEP_WEIGHT{X}*factor;sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_DEP_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X}))*computedWeight;
#else
blend+=texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X})*computedWeight;
#endif
`;C.IncludesShadersStore[Hp]||(C.IncludesShadersStore[Hp]=ZO);const jl="kernelBlurPixelShader",QE=`uniform sampler2D textureSampler;uniform vec2 delta;varying vec2 sampleCenter;
#ifdef DOF
uniform sampler2D circleOfConfusionSampler;float sampleCoC(in vec2 offset) {float coc=texture2D(circleOfConfusionSampler,offset).r;return coc; }
#endif
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
#ifdef PACKEDFLOAT
#include<packingFunctions>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{float computedWeight=0.0;
#ifdef PACKEDFLOAT
float blend=0.;
#else
vec4 blend=vec4(0.);
#endif
#ifdef DOF
float sumOfWeights=CENTER_WEIGHT; 
float factor=0.0;
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCenter))*CENTER_WEIGHT;
#else
blend+=texture2D(textureSampler,sampleCenter)*CENTER_WEIGHT;
#endif
#endif
#include<kernelBlurFragment>[0..varyingCount]
#include<kernelBlurFragment2>[0..depCount]
#ifdef PACKEDFLOAT
gl_FragColor=pack(blend);
#else
gl_FragColor=blend;
#endif
#ifdef DOF
gl_FragColor/=sumOfWeights;
#endif
}`;C.ShadersStore[jl]||(C.ShadersStore[jl]=QE);const QO={name:jl,shader:QE},$O=Object.freeze(Object.defineProperty({__proto__:null,kernelBlurPixelShader:QO},Symbol.toStringTag,{value:"Module"})),zp="kernelBlurVertex",JO="sampleCoord{X}=sampleCenter+delta*KERNEL_OFFSET{X};";C.IncludesShadersStore[zp]||(C.IncludesShadersStore[zp]=JO);const Zl="kernelBlurVertexShader",$E=`attribute vec2 position;uniform vec2 delta;varying vec2 sampleCenter;
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
sampleCenter=(position*madd+madd);
#include<kernelBlurVertex>[0..varyingCount]
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;C.ShadersStore[Zl]||(C.ShadersStore[Zl]=$E);const eD={name:Zl,shader:$E},tD=Object.freeze(Object.defineProperty({__proto__:null,kernelBlurVertexShader:eD},Symbol.toStringTag,{value:"Module"})),Yp="backgroundUboDeclaration",iD=`uniform vPrimaryColor: vec4f;uniform vPrimaryColorShadow: vec4f;uniform vDiffuseInfos: vec2f;uniform vReflectionInfos: vec2f;uniform diffuseMatrix: mat4x4f;uniform reflectionMatrix: mat4x4f;uniform vReflectionMicrosurfaceInfos: vec3f;uniform fFovMultiplier: f32;uniform pointSize: f32;uniform shadowLevel: f32;uniform alpha: f32;uniform vBackgroundCenter: vec3f;uniform vReflectionControl: vec4f;uniform projectedGroundInfos: vec2f;
#include<sceneUboDeclaration>
`;C.IncludesShadersStoreWGSL[Yp]||(C.IncludesShadersStoreWGSL[Yp]=iD);const Ql="backgroundVertexShader",JE=`#include<backgroundUboDeclaration>
#include<helperFunctions>
attribute position: vec3f;
#ifdef NORMAL
attribute normal: vec3f;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
varying vPositionW: vec3f;
#ifdef NORMAL
varying vNormalW: vec3f;
#endif
#ifdef UV1
attribute uv: vec2f;
#endif
#ifdef UV2
attribute uv2: vec2f;
#endif
#ifdef MAINUV1
varying vMainUV1: vec2f;
#endif
#ifdef MAINUV2
varying vMainUV2: vec2f;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
varying vDiffuseUV: vec2f;
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<lightVxUboDeclaration>[0..maxSimultaneousLights]
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
#ifdef REFLECTIONMAP_SKYBOX
vertexOutputs.vPositionUVW=input.position;
#endif
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {vertexOutputs.position=scene.viewProjection*finalWorld* vec4f(input.position,1.0);} else {vertexOutputs.position=scene.viewProjectionR*finalWorld* vec4f(input.position,1.0);}
#else
vertexOutputs.position=scene.viewProjection*finalWorld* vec4f(input.position,1.0);
#endif
var worldPos: vec4f=finalWorld* vec4f(input.position,1.0);vertexOutputs.vPositionW= worldPos.xyz;
#ifdef NORMAL
var normalWorld: mat3x3f=mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vertexOutputs.vNormalW=normalize(normalWorld*input.normal);
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vertexOutputs.vDirectionW=normalize((finalWorld*vec4f(input.position,0.0)).xyz);
#ifdef EQUIRECTANGULAR_RELFECTION_FOV
var screenToWorld: mat3x3f=inverseMat3( mat3x3f(finalWorld*scene.viewProjection));var segment: vec3f=mix(vertexOutputs.vDirectionW,screenToWorld* vec3f(0.0,0.0,1.0),abs(fFovMultiplier-1.0));if (fFovMultiplier<=1.0) {vertexOutputs.vDirectionW=normalize(segment);} else {vertexOutputs.vDirectionW=normalize(vertexOutputs.vDirectionW+(vertexOutputs.vDirectionW-segment));}
#endif
#endif
#ifndef UV1
var uv: vec2f=vec2f(0.,0.);
#else
var uv=input.uv;
#endif
#ifndef UV2
var uv2: vec2f=vec2f(0.,0.);
#else
var uv2=input.uv2;
#endif
#ifdef MAINUV1
vertexOutputs.vMainUV1=uv;
#endif
#ifdef MAINUV2
vertexOutputs.vMainUV2=uv2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
if (uniforms.vDiffuseInfos.x==0.)
{vertexOutputs.vDiffuseUV= (uniforms.diffuseMatrix* vec4f(uv,1.0,0.0)).xy;}
else
{vertexOutputs.vDiffuseUV= (uniforms.diffuseMatrix* vec4f(uv2,1.0,0.0)).xy;}
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#ifdef VERTEXCOLOR
vertexOutputs.vColor=vertexInputs.color;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;C.ShadersStoreWGSL[Ql]||(C.ShadersStoreWGSL[Ql]=JE);const rD={name:Ql,shader:JE},sD=Object.freeze(Object.defineProperty({__proto__:null,backgroundVertexShaderWGSL:rD},Symbol.toStringTag,{value:"Module"})),Kp="intersectionFunctions",nD=`fn diskIntersectWithBackFaceCulling(ro: vec3f,rd: vec3f,c: vec3f,r: f32)->f32 {var d: f32=rd.y;if(d>0.0) { return 1e6; }
var o: vec3f=ro-c;var t: f32=-o.y/d;var q: vec3f=o+rd*t;return select(1e6,t,(dot(q,q)<r*r));}
fn sphereIntersect(ro: vec3f,rd: vec3f,ce: vec3f,ra: f32)->vec2f {var oc: vec3f=ro-ce;var b: f32=dot(oc,rd);var c: f32=dot(oc,oc)-ra*ra;var h: f32=b*b-c;if(h<0.0) { return vec2f(-1.,-1.); }
h=sqrt(h);return vec2f(-b+h,-b-h);}
fn sphereIntersectFromOrigin(ro: vec3f,rd: vec3f,ra: f32)->vec2f {var b: f32=dot(ro,rd);var c: f32=dot(ro,ro)-ra*ra;var h: f32=b*b-c;if(h<0.0) { return vec2f(-1.,-1.); }
h=sqrt(h);return vec2f(-b+h,-b-h);}`;C.IncludesShadersStoreWGSL[Kp]||(C.IncludesShadersStoreWGSL[Kp]=nD);const $l="backgroundPixelShader",ev=`#include<backgroundUboDeclaration>
#include<helperFunctions>
varying vPositionW: vec3f;
#ifdef MAINUV1
varying vMainUV1: vec2f;
#endif 
#ifdef MAINUV2 
varying vMainUV2: vec2f; 
#endif 
#ifdef NORMAL
varying vNormalW: vec3f;
#endif
#ifdef DIFFUSE
#if DIFFUSEDIRECTUV==1
#define vDiffuseUV vMainUV1
#elif DIFFUSEDIRECTUV==2
#define vDiffuseUV vMainUV2
#else
varying vDiffuseUV: vec2f;
#endif
var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
var reflectionSamplerSampler: sampler;var reflectionSampler: texture_cube<f32>;
#ifdef TEXTURELODSUPPORT
#else
var reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_cube<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_cube<f32>;
#endif
#else
var reflectionSamplerSampler: sampler;var reflectionSampler: texture_2d<f32>;
#ifdef TEXTURELODSUPPORT
#else
var reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_2d<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_2d<f32>;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#endif
#include<reflectionFunction>
#endif
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE;
#endif
#ifndef SHADOWONLY
#define SHADOWONLY;
#endif
#include<imageProcessingDeclaration>
#include<lightUboDeclaration>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<imageProcessingFunctions>
#include<logDepthDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<fogFragmentDeclaration>
#ifdef REFLECTIONFRESNEL
#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
fn fresnelSchlickEnvironmentGGX(VdotN: f32,reflectance0: vec3f,reflectance90: vec3f,smoothness: f32)->vec3f
{var weight: f32=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}
#endif
#ifdef PROJECTED_GROUND
#include<intersectionFunctions>
fn project(viewDirectionW: vec3f,eyePosition: vec3f)->vec3f {var radius: f32=uniforms.projectedGroundInfos.x;var height: f32=uniforms.projectedGroundInfos.y;var camDir: vec3f=-viewDirectionW;var skySphereDistance: f32=sphereIntersectFromOrigin(eyePosition,camDir,radius).x;var skySpherePositionW: vec3f=eyePosition+camDir*skySphereDistance;var p: vec3f=normalize(skySpherePositionW);var upEyePosition=vec3f(eyePosition.x,eyePosition.y-height,eyePosition.z);var sIntersection: f32=sphereIntersectFromOrigin(upEyePosition,p,radius).x;var h: vec3f= vec3f(0.0,-height,0.0);var dIntersection: f32=diskIntersectWithBackFaceCulling(upEyePosition,p,h,radius);p=(upEyePosition+min(sIntersection,dIntersection)*p);return p;}
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
var viewDirectionW: vec3f=normalize(scene.vEyePosition.xyz-input.vPositionW);
#ifdef NORMAL
var normalW: vec3f=normalize(fragmentInputs.vNormalW);
#else
var normalW: vec3f= vec3f(0.0,1.0,0.0);
#endif
var shadow: f32=1.;var globalShadow: f32=0.;var shadowLightCount: f32=0.;var aggShadow: f32=0.;var numLights: f32=0.;
#include<lightFragment>[0..maxSimultaneousLights]
#ifdef SHADOWINUSE
globalShadow/=shadowLightCount;
#else
globalShadow=1.0;
#endif
#ifndef BACKMAT_SHADOWONLY
var reflectionColor: vec4f= vec4f(1.,1.,1.,1.);
#ifdef REFLECTION
#ifdef PROJECTED_GROUND
var reflectionVector: vec3f=project(viewDirectionW,scene.vEyePosition.xyz);reflectionVector= (uniforms.reflectionMatrix*vec4f(reflectionVector,1.)).xyz;
#else
var reflectionVector: vec3f=computeReflectionCoords( vec4f(fragmentInputs.vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
var reflectionCoords: vec3f=reflectionVector;
#else
var reflectionCoords: vec2f=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
#ifdef REFLECTIONBLUR
var reflectionLOD: f32=uniforms.vReflectionInfos.y;
#ifdef TEXTURELODSUPPORT
reflectionLOD=reflectionLOD*log2(vReflectionMicrosurfaceInfos.x)*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;reflectionColor=textureSampleLevel(reflectionSampler,reflectionSamplerSampler,reflectionCoords,reflectionLOD);
#else
var lodReflectionNormalized: f32=saturate(reflectionLOD);var lodReflectionNormalizedDoubled: f32=lodReflectionNormalized*2.0;var reflectionSpecularMid: vec4f=textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords);if(lodReflectionNormalizedDoubled<1.0){reflectionColor=mix(
textureSample(reflectionrHighSampler,reflectionrHighSamplerSampler,reflectionCoords),
reflectionSpecularMid,
lodReflectionNormalizedDoubled
);} else {reflectionColor=mix(
reflectionSpecularMid,
textureSample(reflectionLowSampler,reflectionLowSamplerSampler,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);}
#endif
#else
var reflectionSample: vec4f=textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords);reflectionColor=reflectionSample;
#endif
#ifdef RGBDREFLECTION
reflectionColor=vec4f(fromRGBD(reflectionColor).rgb,reflectionColor.a);
#endif
#ifdef GAMMAREFLECTION
reflectionColor=vec4f(toLinearSpaceVec3(reflectionColor.rgb),reflectionColor.a);
#endif
#ifdef REFLECTIONBGR
reflectionColor=vec4f(reflectionColor.bgr,reflectionColor.a);
#endif
reflectionColor=vec4f(reflectionColor.rgb*uniforms.vReflectionInfos.x,reflectionColor.a);
#endif
var diffuseColor: vec3f= vec3f(1.,1.,1.);var finalAlpha: f32=uniforms.alpha;
#ifdef DIFFUSE
var diffuseMap: vec4f=textureSample(diffuseSampler,diffuseSamplerSampler,input.vDiffuseUV);
#ifdef GAMMADIFFUSE
diffuseMap=vec4f(toLinearSpaceVec3(diffuseMap.rgb),diffuseMap.a);
#endif
diffuseMap=vec4f(diffuseMap.rgb *uniforms.vDiffuseInfos.y,diffuseMap.a);
#ifdef DIFFUSEHASALPHA
finalAlpha*=diffuseMap.a;
#endif
diffuseColor=diffuseMap.rgb;
#endif
#ifdef REFLECTIONFRESNEL
var colorBase: vec3f=diffuseColor;
#else
var colorBase: vec3f=reflectionColor.rgb*diffuseColor;
#endif
colorBase=max(colorBase,vec3f(0.0));
#ifdef USERGBCOLOR
var finalColor: vec3f=colorBase;
#else
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
var mainColor: vec3f=mix(uniforms.vPrimaryColorShadow.rgb,uniforms.vPrimaryColor.rgb,colorBase);
#else
var mainColor: vec3f=uniforms.vPrimaryColor.rgb;
#endif
var finalColor: vec3f=colorBase*mainColor;
#endif
#ifdef REFLECTIONFRESNEL
var reflectionAmount: vec3f=uniforms.vReflectionControl.xxx;var reflectionReflectance0: vec3f=uniforms.vReflectionControl.yyy;var reflectionReflectance90: vec3f=uniforms.vReflectionControl.zzz;var VdotN: f32=dot(normalize(scene.vEyePosition.xyz),normalW);var planarReflectionFresnel: vec3f=fresnelSchlickEnvironmentGGX(saturate(VdotN),reflectionReflectance0,reflectionReflectance90,1.0);reflectionAmount*=planarReflectionFresnel;
#ifdef REFLECTIONFALLOFF
var reflectionDistanceFalloff: f32=1.0-saturate(length(vPositionW.xyz-uniforms.vBackgroundCenter)*uniforms.vReflectionControl.w);reflectionDistanceFalloff*=reflectionDistanceFalloff;reflectionAmount*=reflectionDistanceFalloff;
#endif
finalColor=mix(finalColor,reflectionColor.rgb,saturateVec3(reflectionAmount));
#endif
#ifdef OPACITYFRESNEL
var viewAngleToFloor: f32=dot(normalW,normalize(scene.vEyePosition.xyz-uniforms.vBackgroundCenter));const startAngle: f32=0.1;var fadeFactor: f32=saturate(viewAngleToFloor/startAngle);finalAlpha*=fadeFactor*fadeFactor;
#endif
#ifdef SHADOWINUSE
finalColor=mix(finalColor*uniforms.shadowLevel,finalColor,globalShadow);
#endif
var color: vec4f= vec4f(finalColor,finalAlpha);
#else
var color: vec4f= vec4f(uniforms.vPrimaryColor.rgb,(1.0-clamp(globalShadow,0.,1.))*uniforms.alpha);
#endif
#include<logDepthFragment>
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
#if !defined(SKIPFINALCOLORCLAMP)
color=vec4f(clamp(color.rgb,vec3f(0.),vec3f(30.0)),color.a);
#endif
#else
color=applyImageProcessing(color);
#endif
#ifdef PREMULTIPLYALPHA
color=vec4f(color.rgb *color.a,color.a);
#endif
#ifdef NOISE
color=vec4f(color.rgb+dither(fragmentInputs.vPositionW.xy,0.5),color.a);color=max(color,vec4f(0.0));
#endif
fragmentOutputs.color=color;
#define CUSTOM_FRAGMENT_MAIN_END
}
`;C.ShadersStoreWGSL[$l]||(C.ShadersStoreWGSL[$l]=ev);const aD={name:$l,shader:ev},oD=Object.freeze(Object.defineProperty({__proto__:null,backgroundPixelShaderWGSL:aD},Symbol.toStringTag,{value:"Module"})),qp="backgroundVertexDeclaration",lD=`uniform mat4 view;uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
uniform float shadowLevel;
#ifdef DIFFUSE
uniform mat4 diffuseMatrix;uniform vec2 vDiffuseInfos;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;uniform float fFovMultiplier;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
`;C.IncludesShadersStore[qp]||(C.IncludesShadersStore[qp]=lD);const jp="backgroundUboDeclaration",cD=`layout(std140,column_major) uniform;uniform Material
{uniform vec4 vPrimaryColor;uniform vec4 vPrimaryColorShadow;uniform vec2 vDiffuseInfos;uniform vec2 vReflectionInfos;uniform mat4 diffuseMatrix;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;uniform float fFovMultiplier;uniform float pointSize;uniform float shadowLevel;uniform float alpha;uniform vec3 vBackgroundCenter;uniform vec4 vReflectionControl;uniform vec2 projectedGroundInfos;};
#include<sceneUboDeclaration>
`;C.IncludesShadersStore[jp]||(C.IncludesShadersStore[jp]=cD);const Jl="backgroundVertexShader",tv=`precision highp float;
#include<__decl__backgroundVertex>
#include<helperFunctions>
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif
#ifdef MAINUV2
varying vec2 vMainUV2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
varying vec2 vDiffuseUV;
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=position;
#endif
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*finalWorld*vec4(position,1.0);} else {gl_Position=viewProjectionR*finalWorld*vec4(position,1.0);}
#else
gl_Position=viewProjection*finalWorld*vec4(position,1.0);
#endif
vec4 worldPos=finalWorld*vec4(position,1.0);vPositionW=vec3(worldPos);
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normal);
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(position,0.0)));
#ifdef EQUIRECTANGULAR_RELFECTION_FOV
mat3 screenToWorld=inverseMat3(mat3(finalWorld*viewProjection));vec3 segment=mix(vDirectionW,screenToWorld*vec3(0.0,0.0,1.0),abs(fFovMultiplier-1.0));if (fFovMultiplier<=1.0) {vDirectionW=normalize(segment);} else {vDirectionW=normalize(vDirectionW+(vDirectionW-segment));}
#endif
#endif
#ifndef UV1
vec2 uv=vec2(0.,0.);
#endif
#ifndef UV2
vec2 uv2=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uv;
#endif
#ifdef MAINUV2
vMainUV2=uv2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
if (vDiffuseInfos.x==0.)
{vDiffuseUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));}
else
{vDiffuseUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));}
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#ifdef VERTEXCOLOR
vColor=colorUpdated;
#endif
#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;C.ShadersStore[Jl]||(C.ShadersStore[Jl]=tv);const hD={name:Jl,shader:tv},fD=Object.freeze(Object.defineProperty({__proto__:null,backgroundVertexShader:hD},Symbol.toStringTag,{value:"Module"})),Zp="backgroundFragmentDeclaration",uD=`uniform vec4 vEyePosition;uniform vec4 vPrimaryColor;
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
uniform vec4 vPrimaryColorShadow;
#endif
uniform float shadowLevel;uniform float alpha;
#ifdef DIFFUSE
uniform vec2 vDiffuseInfos;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;
#endif
#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)
uniform vec3 vBackgroundCenter;
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 vReflectionControl;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)
uniform mat4 view;
#endif
#ifdef PROJECTED_GROUND
uniform vec2 projectedGroundInfos;
#endif
`;C.IncludesShadersStore[Zp]||(C.IncludesShadersStore[Zp]=uD);const Qp="intersectionFunctions",dD=`float diskIntersectWithBackFaceCulling(vec3 ro,vec3 rd,vec3 c,float r) {float d=rd.y;if(d>0.0) { return 1e6; }
vec3 o=ro-c;float t=-o.y/d;vec3 q=o+rd*t;return (dot(q,q)<r*r) ? t : 1e6;}
vec2 sphereIntersect(vec3 ro,vec3 rd,vec3 ce,float ra) {vec3 oc=ro-ce;float b=dot(oc,rd);float c=dot(oc,oc)-ra*ra;float h=b*b-c;if(h<0.0) { return vec2(-1.0,-1.0); }
h=sqrt(h);return vec2(-b+h,-b-h);}
vec2 sphereIntersectFromOrigin(vec3 ro,vec3 rd,float ra) {float b=dot(ro,rd);float c=dot(ro,ro)-ra*ra;float h=b*b-c;if(h<0.0) { return vec2(-1.0,-1.0); }
h=sqrt(h);return vec2(-b+h,-b-h);}`;C.IncludesShadersStore[Qp]||(C.IncludesShadersStore[Qp]=dD);const ec="backgroundPixelShader",iv=`#ifdef TEXTURELODSUPPORT
#extension GL_EXT_shader_texture_lod : enable
#endif
precision highp float;
#include<__decl__backgroundFragment>
#include<helperFunctions>
varying vec3 vPositionW;
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif 
#ifdef MAINUV2 
varying vec2 vMainUV2; 
#endif 
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#ifdef DIFFUSE
#if DIFFUSEDIRECTUV==1
#define vDiffuseUV vMainUV1
#elif DIFFUSEDIRECTUV==2
#define vDiffuseUV vMainUV2
#else
varying vec2 vDiffuseUV;
#endif
uniform sampler2D diffuseSampler;
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef TEXTURELODSUPPORT
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef TEXTURELODSUPPORT
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#include<reflectionFunction>
#endif
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE;
#endif
#ifndef SHADOWONLY
#define SHADOWONLY;
#endif
#include<imageProcessingDeclaration>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<imageProcessingFunctions>
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<logDepthDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<fogFragmentDeclaration>
#ifdef REFLECTIONFRESNEL
#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
vec3 fresnelSchlickEnvironmentGGX(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)
{float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}
#endif
#ifdef PROJECTED_GROUND
#include<intersectionFunctions>
vec3 project(vec3 viewDirectionW,vec3 eyePosition) {float radius=projectedGroundInfos.x;float height=projectedGroundInfos.y;vec3 camDir=-viewDirectionW;float skySphereDistance=sphereIntersectFromOrigin(eyePosition,camDir,radius).x;vec3 skySpherePositionW=eyePosition+camDir*skySphereDistance;vec3 p=normalize(skySpherePositionW);eyePosition.y-=height;float sIntersection=sphereIntersectFromOrigin(eyePosition,p,radius).x;vec3 h=vec3(0.0,-height,0.0);float dIntersection=diskIntersectWithBackFaceCulling(eyePosition,p,h,radius);p=(eyePosition+min(sIntersection,dIntersection)*p);return p;}
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=vec3(0.0,1.0,0.0);
#endif
float shadow=1.;float globalShadow=0.;float shadowLightCount=0.;float aggShadow=0.;float numLights=0.;
#include<lightFragment>[0..maxSimultaneousLights]
#ifdef SHADOWINUSE
globalShadow/=shadowLightCount;
#else
globalShadow=1.0;
#endif
#ifndef BACKMAT_SHADOWONLY
vec4 reflectionColor=vec4(1.,1.,1.,1.);
#ifdef REFLECTION
#ifdef PROJECTED_GROUND
vec3 reflectionVector=project(viewDirectionW,vEyePosition.xyz);reflectionVector=vec3(reflectionMatrix*vec4(reflectionVector,1.));
#else
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=reflectionVector;
#else
vec2 reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
#ifdef REFLECTIONBLUR
float reflectionLOD=vReflectionInfos.y;
#ifdef TEXTURELODSUPPORT
reflectionLOD=reflectionLOD*log2(vReflectionMicrosurfaceInfos.x)*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;reflectionColor=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#else
float lodReflectionNormalized=saturate(reflectionLOD);float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;vec4 reflectionSpecularMid=sampleReflection(reflectionSampler,reflectionCoords);if(lodReflectionNormalizedDoubled<1.0){reflectionColor=mix(
sampleReflection(reflectionSamplerHigh,reflectionCoords),
reflectionSpecularMid,
lodReflectionNormalizedDoubled
);} else {reflectionColor=mix(
reflectionSpecularMid,
sampleReflection(reflectionSamplerLow,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);}
#endif
#else
vec4 reflectionSample=sampleReflection(reflectionSampler,reflectionCoords);reflectionColor=reflectionSample;
#endif
#ifdef RGBDREFLECTION
reflectionColor.rgb=fromRGBD(reflectionColor);
#endif
#ifdef GAMMAREFLECTION
reflectionColor.rgb=toLinearSpace(reflectionColor.rgb);
#endif
#ifdef REFLECTIONBGR
reflectionColor.rgb=reflectionColor.bgr;
#endif
reflectionColor.rgb*=vReflectionInfos.x;
#endif
vec3 diffuseColor=vec3(1.,1.,1.);float finalAlpha=alpha;
#ifdef DIFFUSE
vec4 diffuseMap=texture2D(diffuseSampler,vDiffuseUV);
#ifdef GAMMADIFFUSE
diffuseMap.rgb=toLinearSpace(diffuseMap.rgb);
#endif
diffuseMap.rgb*=vDiffuseInfos.y;
#ifdef DIFFUSEHASALPHA
finalAlpha*=diffuseMap.a;
#endif
diffuseColor=diffuseMap.rgb;
#endif
#ifdef REFLECTIONFRESNEL
vec3 colorBase=diffuseColor;
#else
vec3 colorBase=reflectionColor.rgb*diffuseColor;
#endif
colorBase=max(colorBase,0.0);
#ifdef USERGBCOLOR
vec3 finalColor=colorBase;
#else
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
vec3 mainColor=mix(vPrimaryColorShadow.rgb,vPrimaryColor.rgb,colorBase);
#else
vec3 mainColor=vPrimaryColor.rgb;
#endif
vec3 finalColor=colorBase*mainColor;
#endif
#ifdef REFLECTIONFRESNEL
vec3 reflectionAmount=vReflectionControl.xxx;vec3 reflectionReflectance0=vReflectionControl.yyy;vec3 reflectionReflectance90=vReflectionControl.zzz;float VdotN=dot(normalize(vEyePosition.xyz),normalW);vec3 planarReflectionFresnel=fresnelSchlickEnvironmentGGX(saturate(VdotN),reflectionReflectance0,reflectionReflectance90,1.0);reflectionAmount*=planarReflectionFresnel;
#ifdef REFLECTIONFALLOFF
float reflectionDistanceFalloff=1.0-saturate(length(vPositionW.xyz-vBackgroundCenter)*vReflectionControl.w);reflectionDistanceFalloff*=reflectionDistanceFalloff;reflectionAmount*=reflectionDistanceFalloff;
#endif
finalColor=mix(finalColor,reflectionColor.rgb,saturate(reflectionAmount));
#endif
#ifdef OPACITYFRESNEL
float viewAngleToFloor=dot(normalW,normalize(vEyePosition.xyz-vBackgroundCenter));const float startAngle=0.1;float fadeFactor=saturate(viewAngleToFloor/startAngle);finalAlpha*=fadeFactor*fadeFactor;
#endif
#ifdef SHADOWINUSE
finalColor=mix(finalColor*shadowLevel,finalColor,globalShadow);
#endif
vec4 color=vec4(finalColor,finalAlpha);
#else
vec4 color=vec4(vPrimaryColor.rgb,(1.0-clamp(globalShadow,0.,1.))*alpha);
#endif
#include<logDepthFragment>
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
#if !defined(SKIPFINALCOLORCLAMP)
color.rgb=clamp(color.rgb,0.,30.0);
#endif
#else
color=applyImageProcessing(color);
#endif
#ifdef PREMULTIPLYALPHA
color.rgb*=color.a;
#endif
#ifdef NOISE
color.rgb+=dither(vPositionW.xy,0.5);color=max(color,0.0);
#endif
gl_FragColor=color;
#define CUSTOM_FRAGMENT_MAIN_END
}
`;C.ShadersStore[ec]||(C.ShadersStore[ec]=iv);const _D={name:ec,shader:iv},pD=Object.freeze(Object.defineProperty({__proto__:null,backgroundPixelShader:_D},Symbol.toStringTag,{value:"Module"})),tc="vrDistortionCorrectionPixelShader",rv=`#define DISABLE_UNIFORMITY_ANALYSIS
varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform LensCenter: vec2f;uniform Scale: vec2f;uniform ScaleIn: vec2f;uniform HmdWarpParam: vec4f;fn HmdWarp(in01: vec2f)->vec2f {var theta: vec2f=(in01-uniforms.LensCenter)*uniforms.ScaleIn; 
var rSq: f32=theta.x*theta.x+theta.y*theta.y;var rvector: vec2f=theta*(uniforms.HmdWarpParam.x+uniforms.HmdWarpParam.y*rSq+uniforms.HmdWarpParam.z*rSq*rSq+uniforms.HmdWarpParam.w*rSq*rSq*rSq);return uniforms.LensCenter+uniforms.Scale*rvector;}
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var tc: vec2f=HmdWarp(input.vUV);if (tc.x <0.0 || tc.x>1.0 || tc.y<0.0 || tc.y>1.0) {fragmentOutputs.color=vec4f(0.0,0.0,0.0,0.0);}
else{fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,tc);}}`;C.ShadersStoreWGSL[tc]||(C.ShadersStoreWGSL[tc]=rv);const mD={name:tc,shader:rv},gD=Object.freeze(Object.defineProperty({__proto__:null,vrDistortionCorrectionPixelShaderWGSL:mD},Symbol.toStringTag,{value:"Module"})),ic="vrDistortionCorrectionPixelShader",sv=`varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 LensCenter;uniform vec2 Scale;uniform vec2 ScaleIn;uniform vec4 HmdWarpParam;vec2 HmdWarp(vec2 in01) {vec2 theta=(in01-LensCenter)*ScaleIn; 
float rSq=theta.x*theta.x+theta.y*theta.y;vec2 rvector=theta*(HmdWarpParam.x+HmdWarpParam.y*rSq+HmdWarpParam.z*rSq*rSq+HmdWarpParam.w*rSq*rSq*rSq);return LensCenter+Scale*rvector;}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec2 tc=HmdWarp(vUV);if (tc.x <0.0 || tc.x>1.0 || tc.y<0.0 || tc.y>1.0)
gl_FragColor=vec4(0.0,0.0,0.0,0.0);else{gl_FragColor=texture2D(textureSampler,tc);}}`;C.ShadersStore[ic]||(C.ShadersStore[ic]=sv);const ED={name:ic,shader:sv},vD=Object.freeze(Object.defineProperty({__proto__:null,vrDistortionCorrectionPixelShader:ED},Symbol.toStringTag,{value:"Module"})),rc="proceduralVertexShader",nv=`attribute position: vec2f;varying vPosition: vec2f;varying vUV: vec2f;const madd: vec2f= vec2f(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
vertexOutputs.vPosition=input.position;vertexOutputs.vUV=input.position*madd+madd;vertexOutputs.position= vec4f(input.position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;C.ShadersStoreWGSL[rc]||(C.ShadersStoreWGSL[rc]=nv);const TD={name:rc,shader:nv},$p=Object.freeze(Object.defineProperty({__proto__:null,proceduralVertexShaderWGSL:TD},Symbol.toStringTag,{value:"Module"})),sc="proceduralVertexShader",av=`attribute vec2 position;varying vec2 vPosition;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vPosition=position;vUV=position*madd+madd;gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;C.ShadersStore[sc]||(C.ShadersStore[sc]=av);const SD={name:sc,shader:av},Jp=Object.freeze(Object.defineProperty({__proto__:null,proceduralVertexShader:SD},Symbol.toStringTag,{value:"Module"})),nc="colorVertexShader",ov=`attribute position: vec3f;
#ifdef VERTEXCOLOR
attribute color: vec4f;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#ifdef FOG
uniform view: mat4x4f;
#endif
#include<instancesDeclaration>
uniform viewProjection: mat4x4f;
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vColor: vec4f;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
#ifdef VERTEXCOLOR
var colorUpdated: vec4f=vertexInputs.color;
#endif
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f=finalWorld* vec4f(input.position,1.0);vertexOutputs.position=uniforms.viewProjection*worldPos;
#include<clipPlaneVertex>
#include<fogVertex>
#include<vertexColorMixing>
#define CUSTOM_VERTEX_MAIN_END
}`;C.ShadersStoreWGSL[nc]||(C.ShadersStoreWGSL[nc]=ov);const AD={name:nc,shader:ov},RD=Object.freeze(Object.defineProperty({__proto__:null,colorVertexShaderWGSL:AD},Symbol.toStringTag,{value:"Module"})),ac="colorPixelShader",lv=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
#define VERTEXCOLOR
varying vColor: vec4f;
#else
uniform color: vec4f;
#endif
#include<clipPlaneFragmentDeclaration>
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
fragmentOutputs.color=input.vColor;
#else
fragmentOutputs.color=uniforms.color;
#endif
#include<fogFragment>(color,fragmentOutputs.color)
#define CUSTOM_FRAGMENT_MAIN_END
}`;C.ShadersStoreWGSL[ac]||(C.ShadersStoreWGSL[ac]=lv);const CD={name:ac,shader:lv},ID=Object.freeze(Object.defineProperty({__proto__:null,colorPixelShaderWGSL:CD},Symbol.toStringTag,{value:"Module"})),oc="colorVertexShader",cv=`attribute vec3 position;
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#ifdef FOG
uniform mat4 view;
#endif
#include<instancesDeclaration>
uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#ifdef VERTEXCOLOR
vec4 colorUpdated=color;
#endif
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(position,1.0);
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}
#else
gl_Position=viewProjection*worldPos;
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<vertexColorMixing>
#define CUSTOM_VERTEX_MAIN_END
}`;C.ShadersStore[oc]||(C.ShadersStore[oc]=cv);const bD={name:oc,shader:cv},xD=Object.freeze(Object.defineProperty({__proto__:null,colorVertexShader:bD},Symbol.toStringTag,{value:"Module"})),lc="colorPixelShader",hv=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
#define VERTEXCOLOR
varying vec4 vColor;
#else
uniform vec4 color;
#endif
#include<clipPlaneFragmentDeclaration>
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
gl_FragColor=vColor;
#else
gl_FragColor=color;
#endif
#include<fogFragment>(color,gl_FragColor)
#define CUSTOM_FRAGMENT_MAIN_END
}`;C.ShadersStore[lc]||(C.ShadersStore[lc]=hv);const yD={name:lc,shader:hv},MD=Object.freeze(Object.defineProperty({__proto__:null,colorPixelShader:yD},Symbol.toStringTag,{value:"Module"}));class fv extends Eo{constructor(e){super(e,["animationLoop","animationEnd","animationGroupLoop"]),this.config=e,this.speed=this.registerDataInput("speed",Ie),this.loop=this.registerDataInput("loop",$t),this.from=this.registerDataInput("from",Ie,0),this.to=this.registerDataInput("to",Ie),this.currentFrame=this.registerDataOutput("currentFrame",Ie),this.currentTime=this.registerDataOutput("currentTime",Ie),this.currentAnimationGroup=this.registerDataOutput("currentAnimationGroup",te),this.animationGroup=this.registerDataInput("animationGroup",te,e==null?void 0:e.animationGroup),this.animation=this.registerDataInput("animation",te),this.object=this.registerDataInput("object",te)}_preparePendingTasks(e){const t=this.animationGroup.getValue(e),i=this.animation.getValue(e);if(!t&&!i)return this._reportError(e,"No animation or animation group provided");{const r=this.currentAnimationGroup.getValue(e);r&&r!==t&&r.dispose();let s=t;if(i&&!s){const f=this.object.getValue(e);if(!f)return this._reportError(e,"No target object provided");const u=Array.isArray(i)?i:[i],d=u[0].name;s=new cr("flowGraphAnimationGroup-"+d+"-"+f.name,e.configuration.scene);let _=!1;const p=e._getGlobalContextVariable("interpolationAnimations",[]);for(const g of u)s.addTargetedAnimation(g,f),p.indexOf(g.uniqueId)!==-1&&(_=!0);_&&this._checkInterpolationDuplications(e,u,f)}const n=this.speed.getValue(e)||1,o=this.from.getValue(e)??0,l=this.to.getValue(e)||s.to,c=!isFinite(l)||this.loop.getValue(e);this.currentAnimationGroup.setValue(s,e);const h=e._getGlobalContextVariable("currentlyRunningAnimationGroups",[]);h.indexOf(s.uniqueId)!==-1&&s.stop();try{s.start(c,n,o,l),s.onAnimationGroupEndObservable.add(()=>this._onAnimationGroupEnd(e)),s.onAnimationEndObservable.add(()=>this._eventsSignalOutputs.animationEnd._activateSignal(e)),s.onAnimationLoopObservable.add(()=>this._eventsSignalOutputs.animationLoop._activateSignal(e)),s.onAnimationGroupLoopObservable.add(()=>this._eventsSignalOutputs.animationGroupLoop._activateSignal(e)),h.push(s.uniqueId),e._setGlobalContextVariable("currentlyRunningAnimationGroups",h)}catch(f){this._reportError(e,f)}}}_reportError(e,t){super._reportError(e,t),this.currentFrame.setValue(-1,e),this.currentTime.setValue(-1,e)}_executeOnTick(e){var i;const t=this.currentAnimationGroup.getValue(e);t&&(this.currentFrame.setValue(t.getCurrentFrame(),e),this.currentTime.setValue(((i=t.animatables[0])==null?void 0:i.elapsedTime)??0,e))}_execute(e){this._startPendingTasks(e)}_onAnimationGroupEnd(e){this._removeFromCurrentlyRunning(e,this.currentAnimationGroup.getValue(e)),this._resetAfterCanceled(e),this.done._activateSignal(e)}_checkInterpolationDuplications(e,t,i){const r=e._getGlobalContextVariable("currentlyRunningAnimationGroups",[]);for(const s of r){const n=e.assetsContext.animationGroups.find(o=>o.uniqueId===s);if(n)for(const o of n.targetedAnimations)for(const l of t)o.animation.targetProperty===l.targetProperty&&o.target===i&&this._stopAnimationGroup(e,n)}}_stopAnimationGroup(e,t){t.stop(!0),t.dispose(),this._removeFromCurrentlyRunning(e,t)}_removeFromCurrentlyRunning(e,t){const i=e._getGlobalContextVariable("currentlyRunningAnimationGroups",[]),r=i.indexOf(t.uniqueId);r!==-1&&(i.splice(r,1),e._setGlobalContextVariable("currentlyRunningAnimationGroups",i))}_cancelPendingTasks(e){const t=this.currentAnimationGroup.getValue(e);t&&this._stopAnimationGroup(e,t)}getClassName(){return"FlowGraphPlayAnimationBlock"}}Y("FlowGraphPlayAnimationBlock",fv);const PD=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphPlayAnimationBlock:fv},Symbol.toStringTag,{value:"Module"}));class uv extends Eo{constructor(e){super(e),this.animationGroup=this.registerDataInput("animationGroup",te),this.stopAtFrame=this.registerDataInput("stopAtFrame",Ie,-1)}_preparePendingTasks(e){const t=this.animationGroup.getValue(e),i=this.stopAtFrame.getValue(e)??-1,r=e._getGlobalContextVariable("pendingStopAnimations",[]);r.push({uniqueId:t.uniqueId,stopAtFrame:i}),e._setGlobalContextVariable("pendingStopAnimations",r)}_cancelPendingTasks(e){const t=this.animationGroup.getValue(e),i=e._getGlobalContextVariable("pendingStopAnimations",[]);for(let r=0;r<i.length;r++)if(i[r].uniqueId===t.uniqueId){i.splice(r,1),e._setGlobalContextVariable("pendingStopAnimations",i);break}}_execute(e){const t=this.animationGroup.getValue(e),i=this.stopAtFrame.getValue(e)??-1;if(!t)return B.Warn("No animation group provided to stop."),this._reportError(e,"No animation group provided to stop.");if(isNaN(i))return this._reportError(e,"Invalid stop time.");i>0?this._startPendingTasks(e):this._stopAnimation(t,e),this.out._activateSignal(e)}_executeOnTick(e){const t=this.animationGroup.getValue(e),i=e._getGlobalContextVariable("pendingStopAnimations",[]);for(let r=0;r<i.length;r++)if(i[r].uniqueId===t.uniqueId&&t.getCurrentFrame()>=i[r].stopAtFrame){this._stopAnimation(t,e),i.splice(r,1),e._setGlobalContextVariable("pendingStopAnimations",i),this.done._activateSignal(e),e._removePendingBlock(this);break}}getClassName(){return"FlowGraphStopAnimationBlock"}_stopAnimation(e,t){const i=t._getGlobalContextVariable("currentlyRunningAnimationGroups",[]),r=i.indexOf(e.uniqueId);r!==-1&&(e.stop(),i.splice(r,1),t._setGlobalContextVariable("currentlyRunningAnimationGroups",i))}}Y("FlowGraphStopAnimationBlock",uv);const OD=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphStopAnimationBlock:uv},Symbol.toStringTag,{value:"Module"}));class dv extends Di{constructor(e){super(e),this.animationToPause=this.registerDataInput("animationToPause",te)}_execute(e){this.animationToPause.getValue(e).pause(),this.out._activateSignal(e)}getClassName(){return"FlowGraphPauseAnimationBlock"}}Y("FlowGraphPauseAnimationBlock",dv);const DD=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphPauseAnimationBlock:dv},Symbol.toStringTag,{value:"Module"}));class _v extends ti{constructor(e={}){super(e),this.keyFrames=[];const t=typeof(e==null?void 0:e.animationType)=="string"?ot(e.animationType):Ab((e==null?void 0:e.animationType)??0),i=(e==null?void 0:e.keyFramesCount)??1,r=this.registerDataInput("duration_0",Ie,0),s=this.registerDataInput("value_0",t);this.keyFrames.push({duration:r,value:s});for(let n=1;n<i+1;n++){const o=this.registerDataInput(`duration_${n}`,Ie,n===i?e.duration:void 0),l=this.registerDataInput(`value_${n}`,t);this.keyFrames.push({duration:o,value:l})}this.initialValue=this.keyFrames[0].value,this.endValue=this.keyFrames[i].value,this.easingFunction=this.registerDataInput("easingFunction",te),this.animation=this.registerDataOutput("animation",te),this.propertyName=this.registerDataInput("propertyName",te,e==null?void 0:e.propertyName),this.customBuildAnimation=this.registerDataInput("customBuildAnimation",te)}_updateOutputs(e){const t=e._getGlobalContextVariable("interpolationAnimations",[]),i=this.propertyName.getValue(e),r=this.easingFunction.getValue(e),s=this._createAnimation(e,i,r);if(this.animation.setValue(s,e),Array.isArray(s))for(const n of s)t.push(n.uniqueId);else t.push(s.uniqueId);e._setGlobalContextVariable("interpolationAnimations",t)}_createAnimation(e,t,i){var c,h,f;const r=this.initialValue.richType,s=[],n=this.initialValue.getValue(e)||r.defaultValue;s.push({frame:0,value:n});const o=((c=this.config)==null?void 0:c.numberOfKeyFrames)??1;for(let u=1;u<o+1;u++){const d=(h=this.keyFrames[u].duration)==null?void 0:h.getValue(e);let _=(f=this.keyFrames[u].value)==null?void 0:f.getValue(e);u===o-1&&(_=_||r.defaultValue),d!==void 0&&_&&s.push({frame:d*60,value:_})}const l=this.customBuildAnimation.getValue(e);if(l)return l()(s,60,r.animationType,i);if(typeof t=="string"){const u=W.CreateAnimation(t,r.animationType,60,i);return u.setKeys(s),[u]}else return t.map(d=>{const _=W.CreateAnimation(d,r.animationType,60,i);return _.setKeys(s),_})}getClassName(){return"FlowGraphInterpolationBlock"}}Y("FlowGraphInterpolationBlock",_v);const LD=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphInterpolationBlock:_v},Symbol.toStringTag,{value:"Module"}));class pv extends Ms{constructor(){super(...arguments),this.initPriority=-1,this.type="SceneReady"}_executeEvent(e,t){return this._execute(e),!0}_preparePendingTasks(e){}_cancelPendingTasks(e){}getClassName(){return"FlowGraphSceneReadyEventBlock"}}Y("FlowGraphSceneReadyEventBlock",pv);const ND=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphSceneReadyEventBlock:pv},Symbol.toStringTag,{value:"Module"}));class mv extends Ms{constructor(){super(),this.type="SceneBeforeRender",this.timeSinceStart=this.registerDataOutput("timeSinceStart",Ie),this.deltaTime=this.registerDataOutput("deltaTime",Ie)}_preparePendingTasks(e){}_executeEvent(e,t){return this.timeSinceStart.setValue(t.timeSinceStart,e),this.deltaTime.setValue(t.deltaTime,e),this._execute(e),!0}_cancelPendingTasks(e){}getClassName(){return"FlowGraphSceneTickEventBlock"}}Y("FlowGraphSceneTickEventBlock",mv);const FD=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphSceneTickEventBlock:mv},Symbol.toStringTag,{value:"Module"}));class gv extends Di{constructor(e){super(e),this.config=e;for(const t in this.config.eventData)this.registerDataInput(t,this.config.eventData[t].type,this.config.eventData[t].value)}_execute(e){const t=this.config.eventId,i={};this.dataInputs.forEach(r=>{i[r.name]=r.getValue(e)}),e.configuration.coordinator.notifyCustomEvent(t,i),this.out._activateSignal(e)}getClassName(){return"FlowGraphReceiveCustomEventBlock"}}Y("FlowGraphReceiveCustomEventBlock",gv);const wD=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphSendCustomEventBlock:gv},Symbol.toStringTag,{value:"Module"}));class Ev extends Ms{constructor(e){super(e),this.config=e,this.initPriority=1;for(const t in this.config.eventData)this.registerDataOutput(t,this.config.eventData[t].type)}_preparePendingTasks(e){const t=e.configuration.coordinator.getCustomEventObservable(this.config.eventId);if(t&&t.hasObservers()&&t.observers.length>dr.MaxEventsPerType){this._reportError(e,`FlowGraphReceiveCustomEventBlock: Too many observers for event ${this.config.eventId}. Max is ${dr.MaxEventsPerType}.`);return}const i=t.add(r=>{Object.keys(r).forEach(s=>{var n;(n=this.getDataOutput(s))==null||n.setValue(r[s],e)}),this._execute(e)});e._setExecutionVariable(this,"_eventObserver",i)}_cancelPendingTasks(e){const t=e.configuration.coordinator.getCustomEventObservable(this.config.eventId);if(t){const i=e._getExecutionVariable(this,"_eventObserver",null);t.remove(i)}else k.Warn(`FlowGraphReceiveCustomEventBlock: Missing observable for event ${this.config.eventId}`)}_executeEvent(e,t){return!0}getClassName(){return"FlowGraphReceiveCustomEventBlock"}}Y("FlowGraphReceiveCustomEventBlock",Ev);const BD=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphReceiveCustomEventBlock:Ev},Symbol.toStringTag,{value:"Module"}));class vv extends Ms{constructor(e){super(e),this.config=e,this.type="MeshPick",this.asset=this.registerDataInput("asset",te,e==null?void 0:e.targetMesh),this.pickedPoint=this.registerDataOutput("pickedPoint",zt),this.pickOrigin=this.registerDataOutput("pickOrigin",zt),this.pointerId=this.registerDataOutput("pointerId",Ie),this.pickedMesh=this.registerDataOutput("pickedMesh",te),this.pointerType=this.registerDataInput("pointerType",te,ge.POINTERPICK)}_getReferencedMesh(e){return this.asset.getValue(e)}_executeEvent(e,t){var s,n,o,l,c;if(this.pointerType.getValue(e)!==t.type)return!0;const r=this._getReferencedMesh(e);return r&&((s=t.pickInfo)!=null&&s.pickedMesh)&&(((n=t.pickInfo)==null?void 0:n.pickedMesh)===r||Cs((o=t.pickInfo)==null?void 0:o.pickedMesh,r))?(this.pointerId.setValue(t.event.pointerId,e),this.pickOrigin.setValue((l=t.pickInfo.ray)==null?void 0:l.origin,e),this.pickedPoint.setValue(t.pickInfo.pickedPoint,e),this.pickedMesh.setValue(t.pickInfo.pickedMesh,e),this._execute(e),!((c=this.config)!=null&&c.stopPropagation)):(this.pointerId.resetToDefaultValue(e),this.pickOrigin.resetToDefaultValue(e),this.pickedPoint.resetToDefaultValue(e),this.pickedMesh.resetToDefaultValue(e),!0)}_preparePendingTasks(e){}_cancelPendingTasks(e){}getClassName(){return"FlowGraphMeshPickEventBlock"}}Y("FlowGraphMeshPickEventBlock",vv);const UD=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphMeshPickEventBlock:vv},Symbol.toStringTag,{value:"Module"})),em="cachedOperationValue",tm="cachedExecutionId";class Ps extends ti{constructor(e,t){super(t),this.value=this.registerDataOutput("value",e),this.isValid=this.registerDataOutput("isValid",$t)}_updateOutputs(e){const t=e._getExecutionVariable(this,tm,-1),i=e._getExecutionVariable(this,em,null);if(i!=null&&t===e.executionId)this.isValid.setValue(!0,e),this.value.setValue(i,e);else try{const r=this._doOperation(e);if(r==null){this.isValid.setValue(!1,e);return}e._setExecutionVariable(this,em,r),e._setExecutionVariable(this,tm,e.executionId),this.value.setValue(r,e),this.isValid.setValue(!0,e)}catch{this.isValid.setValue(!1,e)}}}class Ft extends Ps{constructor(e,t,i,r,s,n){super(i,n),this._operation=r,this._className=s,this.a=this.registerDataInput("a",e),this.b=this.registerDataInput("b",t)}_doOperation(e){const t=this.a.getValue(e),i=this.b.getValue(e);return this._operation(t,i)}getClassName(){return this._className}}class jn extends Ps{constructor(e,t,i,r){super(e,r),this._operation=t,this._className=i}_doOperation(e){return this._operation(e)}getClassName(){return this._className}}class Ze extends Ps{constructor(e,t,i,r,s){super(t,s),this._operation=i,this._className=r,this.a=this.registerDataInput("a",e)}_doOperation(e){return this._operation(this.a.getValue(e))}getClassName(){return this._className}}class _h extends Ps{constructor(e,t,i,r,s,n,o){super(r,o),this._operation=s,this._className=n,this.a=this.registerDataInput("a",e),this.b=this.registerDataInput("b",t),this.c=this.registerDataInput("c",i)}_doOperation(e){return this._operation(this.a.getValue(e),this.b.getValue(e),this.c.getValue(e))}getClassName(){return this._className}}class Tv extends Ft{constructor(e){super(ot(e==null?void 0:e.type),ot(e==null?void 0:e.type),ot(e==null?void 0:e.type),(t,i)=>this._polymorphicAdd(t,i),"FlowGraphAddBlock",e)}_polymorphicAdd(e,t){const i=li(e),r=li(t);return Yn(i,r)||Kn(i,r)||qn(i,r)||i==="Quaternion"||r==="Quaternion"?e.add(t):e+t}}Y("FlowGraphAddBlock",Tv);class Sv extends Ft{constructor(e){super(ot(e==null?void 0:e.type),ot(e==null?void 0:e.type),ot(e==null?void 0:e.type),(t,i)=>this._polymorphicSubtract(t,i),"FlowGraphSubtractBlock",e)}_polymorphicSubtract(e,t){const i=li(e),r=li(t);return Yn(i,r)||qn(i,r)||Kn(i,r)||i==="Quaternion"||r==="Quaternion"?e.subtract(t):e-t}}Y("FlowGraphSubtractBlock",Sv);class Av extends Ft{constructor(e){super(ot(e==null?void 0:e.type),ot(e==null?void 0:e.type),ot(e==null?void 0:e.type),(t,i)=>this._polymorphicMultiply(t,i),"FlowGraphMultiplyBlock",e)}_polymorphicMultiply(e,t){var s;const i=li(e),r=li(t);if(Yn(i,r)||qn(i,r))return e.multiply(t);if(i==="Quaternion"||r==="Quaternion"){const n=e.clone();return n.x*=t.x,n.y*=t.y,n.z*=t.z,n.w*=t.w,n}else if(Kn(i,r))if((s=this.config)!=null&&s.useMatrixPerComponent){const n=e.m;for(let o=0;o<n.length;o++)n[o]*=t.m[o];return i==="Matrix2D"?new fi(n):i==="Matrix3D"?new ui(n):P.FromArray(n)}else return e=e,t=t,t.multiply(e);else return e*t}}Y("FlowGraphMultiplyBlock",Av);class Rv extends Ft{constructor(e){super(ot(e==null?void 0:e.type),ot(e==null?void 0:e.type),ot(e==null?void 0:e.type),(t,i)=>this._polymorphicDivide(t,i),"FlowGraphDivideBlock",e)}_polymorphicDivide(e,t){var s;const i=li(e),r=li(t);if(Yn(i,r)||qn(i,r))return e.divide(t);if(i==="Quaternion"||r==="Quaternion"){const n=e.clone();return n.x/=t.x,n.y/=t.y,n.z/=t.z,n.w/=t.w,n}else if(Kn(i,r))if((s=this.config)!=null&&s.useMatrixPerComponent){const n=e.m;for(let o=0;o<n.length;o++)n[o]/=t.m[o];return i==="Matrix2D"?new fi(n):i==="Matrix3D"?new ui(n):P.FromArray(n)}else return e=e,t=t,e.divide(t);else return e/t}}Y("FlowGraphDivideBlock",Rv);class Cv extends jn{constructor(e){super(Ie,t=>this._random(t),"FlowGraphRandomBlock",e),this.min=this.registerDataInput("min",Ie,(e==null?void 0:e.min)??0),this.max=this.registerDataInput("max",Ie,(e==null?void 0:e.max)??1),e!=null&&e.seed&&(this._seed=e.seed)}_isSeed(e=this._seed){return e!==void 0}_getRandomValue(){if(this._isSeed(this._seed)){const e=Math.sin(this._seed++)*1e4;return e-Math.floor(e)}return Math.random()}_random(e){const t=this.min.getValue(e),i=this.max.getValue(e);return this._getRandomValue()*(i-t)+t}}Y("FlowGraphRandomBlock",Cv);class Iv extends jn{constructor(e){super(Ie,()=>Math.E,"FlowGraphEBlock",e)}}Y("FlowGraphEBlock",Iv);class bv extends jn{constructor(e){super(Ie,()=>Math.PI,"FlowGraphPIBlock",e)}}Y("FlowGraphPIBlock",bv);class xv extends jn{constructor(e){super(Ie,()=>Number.POSITIVE_INFINITY,"FlowGraphInfBlock",e)}}Y("FlowGraphInfBlock",xv);class yv extends jn{constructor(e){super(Ie,()=>Number.NaN,"FlowGraphNaNBlock",e)}}Y("FlowGraphNaNBlock",yv);function bt(a,e){switch(li(a)){case"FlowGraphInteger":return a=a,new et(e(a.value));case"Vector2":return a=a,new ne(e(a.x),e(a.y));case"Vector3":return a=a,new m(e(a.x),e(a.y),e(a.z));case"Vector4":return a=a,new Fe(e(a.x),e(a.y),e(a.z),e(a.w));case"Quaternion":return a=a,new z(e(a.x),e(a.y),e(a.z),e(a.w));case"Matrix":return a=a,P.FromArray(a.m.map(e));case"Matrix2D":return a=a,new fi(a.m.map(e));case"Matrix3D":return a=a,new ui(a.m.map(e));default:return a=a,e(a)}}class Mv extends Ze{constructor(e){super(Ie,Ie,t=>this._polymorphicAbs(t),"FlowGraphAbsBlock",e)}_polymorphicAbs(e){return bt(e,Math.abs)}}Y("FlowGraphAbsBlock",Mv);class Pv extends Ze{constructor(e){super(Ie,Ie,t=>this._polymorphicSign(t),"FlowGraphSignBlock",e)}_polymorphicSign(e){return bt(e,Math.sign)}}Y("FlowGraphSignBlock",Pv);class Ov extends Ze{constructor(e){super(Ie,Ie,t=>this._polymorphicTrunc(t),"FlowGraphTruncBlock",e)}_polymorphicTrunc(e){return bt(e,Math.trunc)}}Y("FlowGraphTruncBlock",Ov);class Dv extends Ze{constructor(e){super(Ie,Ie,t=>this._polymorphicFloor(t),"FlowGraphFloorBlock",e)}_polymorphicFloor(e){return bt(e,Math.floor)}}Y("FlowGraphFloorBlock",Dv);class Lv extends Ze{constructor(e){super(te,te,t=>this._polymorphicCeiling(t),"FlowGraphCeilBlock",e)}_polymorphicCeiling(e){return bt(e,Math.ceil)}}Y("FlowGraphCeilBlock",Lv);class Nv extends Ze{constructor(e){super(te,te,t=>this._polymorphicRound(t),"FlowGraphRoundBlock",e)}_polymorphicRound(e){return bt(e,t=>{var i;return t<0&&((i=this.config)!=null&&i.roundHalfAwayFromZero)?-Math.round(-t):Math.round(t)})}}Y("FlowGraphRoundBlock",Nv);class Fv extends Ze{constructor(e){super(te,te,t=>this._polymorphicFraction(t),"FlowGraphFractBlock",e)}_polymorphicFraction(e){return bt(e,t=>t-Math.floor(t))}}Y("FlowGraphFractBlock",Fv);class wv extends Ze{constructor(e){super(te,te,t=>this._polymorphicNeg(t),"FlowGraphNegationBlock",e)}_polymorphicNeg(e){return bt(e,t=>-t)}}Y("FlowGraphNegationBlock",wv);function Zn(a,e,t){switch(li(a)){case"FlowGraphInteger":return a=a,e=e,new et(t(a.value,e.value));case"Vector2":return a=a,e=e,new ne(t(a.x,e.x),t(a.y,e.y));case"Vector3":return a=a,e=e,new m(t(a.x,e.x),t(a.y,e.y),t(a.z,e.z));case"Vector4":return a=a,e=e,new Fe(t(a.x,e.x),t(a.y,e.y),t(a.z,e.z),t(a.w,e.w));case"Quaternion":return a=a,e=e,new z(t(a.x,e.x),t(a.y,e.y),t(a.z,e.z),t(a.w,e.w));case"Matrix":return a=a,P.FromArray(a.m.map((r,s)=>t(r,e.m[s])));case"Matrix2D":return a=a,new fi(a.m.map((r,s)=>t(r,e.m[s])));case"Matrix3D":return a=a,new ui(a.m.map((r,s)=>t(r,e.m[s])));default:return t(a,e)}}class Bv extends Ft{constructor(e){super(te,te,te,(t,i)=>this._polymorphicRemainder(t,i),"FlowGraphModuloBlock",e)}_polymorphicRemainder(e,t){return Zn(e,t,(i,r)=>i%r)}}Y("FlowGraphModuloBlock",Bv);class Uv extends Ft{constructor(e){super(te,te,te,(t,i)=>this._polymorphicMin(t,i),"FlowGraphMinBlock",e)}_polymorphicMin(e,t){return Zn(e,t,Math.min)}}Y("FlowGraphMinBlock",Uv);class Vv extends Ft{constructor(e){super(te,te,te,(t,i)=>this._polymorphicMax(t,i),"FlowGraphMaxBlock",e)}_polymorphicMax(e,t){return Zn(e,t,Math.max)}}Y("FlowGraphMaxBlock",Vv);function VD(a,e,t){return Math.min(Math.max(a,Math.min(e,t)),Math.max(e,t))}function Gv(a,e,t,i){switch(li(a)){case"FlowGraphInteger":return a=a,e=e,t=t,new et(i(a.value,e.value,t.value));case"Vector2":return a=a,e=e,t=t,new ne(i(a.x,e.x,t.x),i(a.y,e.y,t.y));case"Vector3":return a=a,e=e,t=t,new m(i(a.x,e.x,t.x),i(a.y,e.y,t.y),i(a.z,e.z,t.z));case"Vector4":return a=a,e=e,t=t,new Fe(i(a.x,e.x,t.x),i(a.y,e.y,t.y),i(a.z,e.z,t.z),i(a.w,e.w,t.w));case"Quaternion":return a=a,e=e,t=t,new z(i(a.x,e.x,t.x),i(a.y,e.y,t.y),i(a.z,e.z,t.z),i(a.w,e.w,t.w));case"Matrix":return P.FromArray(a.m.map((s,n)=>i(s,e.m[n],t.m[n])));case"Matrix2D":return new fi(a.m.map((s,n)=>i(s,e.m[n],t.m[n])));case"Matrix3D":return new ui(a.m.map((s,n)=>i(s,e.m[n],t.m[n])));default:return i(a,e,t)}}class kv extends _h{constructor(e){super(te,te,te,te,(t,i,r)=>this._polymorphicClamp(t,i,r),"FlowGraphClampBlock",e)}_polymorphicClamp(e,t,i){return Gv(e,t,i,VD)}}Y("FlowGraphClampBlock",kv);function GD(a){return Math.min(Math.max(a,0),1)}class Wv extends Ze{constructor(e){super(te,te,t=>this._polymorphicSaturate(t),"FlowGraphSaturateBlock",e)}_polymorphicSaturate(e){return bt(e,GD)}}Y("FlowGraphSaturateBlock",Wv);function kD(a,e,t){return(1-t)*a+t*e}class Xv extends _h{constructor(e){super(te,te,te,te,(t,i,r)=>this._polymorphicInterpolate(t,i,r),"FlowGraphMathInterpolationBlock",e)}_polymorphicInterpolate(e,t,i){return Gv(e,t,i,kD)}}Y("FlowGraphMathInterpolationBlock",Xv);class Hv extends Ft{constructor(e){super(te,te,$t,(t,i)=>this._polymorphicEq(t,i),"FlowGraphEqualityBlock",e)}_polymorphicEq(e,t){const i=li(e),r=li(t);return Yn(i,r)||Kn(i,r)||qn(i,r)?e.equals(t):e===t}}Y("FlowGraphEqualityBlock",Hv);function Ao(a,e,t){if(rn(a)&&rn(e))return t(vi(a),vi(e));throw new Error(`Cannot compare ${a} and ${e}`)}class zv extends Ft{constructor(e){super(te,te,$t,(t,i)=>this._polymorphicLessThan(t,i),"FlowGraphLessThanBlock",e)}_polymorphicLessThan(e,t){return Ao(e,t,(i,r)=>i<r)}}Y("FlowGraphLessThanBlock",zv);class Yv extends Ft{constructor(e){super(te,te,$t,(t,i)=>this._polymorphicLessThanOrEqual(t,i),"FlowGraphLessThanOrEqualBlock",e)}_polymorphicLessThanOrEqual(e,t){return Ao(e,t,(i,r)=>i<=r)}}Y("FlowGraphLessThanOrEqualBlock",Yv);class Kv extends Ft{constructor(e){super(te,te,$t,(t,i)=>this._polymorphicGreaterThan(t,i),"FlowGraphGreaterThanBlock",e)}_polymorphicGreaterThan(e,t){return Ao(e,t,(i,r)=>i>r)}}Y("FlowGraphGreaterThanBlock",Kv);class qv extends Ft{constructor(e){super(te,te,$t,(t,i)=>this._polymorphicGreaterThanOrEqual(t,i),"FlowGraphGreaterThanOrEqualBlock",e)}_polymorphicGreaterThanOrEqual(e,t){return Ao(e,t,(i,r)=>i>=r)}}Y("FlowGraphGreaterThanOrEqualBlock",qv);class jv extends Ze{constructor(e){super(te,$t,t=>this._polymorphicIsNan(t),"FlowGraphIsNaNBlock",e)}_polymorphicIsNan(e){if(rn(e))return isNaN(vi(e));throw new Error(`Cannot get NaN of ${e}`)}}Y("FlowGraphIsNaNBlock",jv);class Zv extends Ze{constructor(e){super(te,$t,t=>this._polymorphicIsInf(t),"FlowGraphIsInfBlock",e)}_polymorphicIsInf(e){if(rn(e))return!isFinite(vi(e));throw new Error(`Cannot get isInf of ${e}`)}}Y("FlowGraphIsInfBlock",Zv);class Qv extends Ze{constructor(e){super(te,te,t=>this._polymorphicDegToRad(t),"FlowGraphDegToRadBlock",e)}_degToRad(e){return e*Math.PI/180}_polymorphicDegToRad(e){return bt(e,this._degToRad)}}Y("FlowGraphDegToRadBlock",Qv);class $v extends Ze{constructor(e){super(te,te,t=>this._polymorphicRadToDeg(t),"FlowGraphRadToDegBlock",e)}_radToDeg(e){return e*180/Math.PI}_polymorphicRadToDeg(e){return bt(e,this._radToDeg)}}Y("FlowGraphRadToDegBlock",$v);class WD extends Ze{constructor(e){super(Ie,Ie,t=>this._polymorphicSin(t),"FlowGraphSinBlock",e)}_polymorphicSin(e){return bt(e,Math.sin)}}class XD extends Ze{constructor(e){super(Ie,Ie,t=>this._polymorphicCos(t),"FlowGraphCosBlock",e)}_polymorphicCos(e){return bt(e,Math.cos)}}class HD extends Ze{constructor(e){super(Ie,Ie,t=>this._polymorphicTan(t),"FlowGraphTanBlock",e)}_polymorphicTan(e){return bt(e,Math.tan)}}class Jv extends Ze{constructor(e){super(Ie,Ie,t=>this._polymorphicAsin(t),"FlowGraphASinBlock",e)}_polymorphicAsin(e){return bt(e,Math.asin)}}Y("FlowGraphASinBlock",Jv);class eT extends Ze{constructor(e){super(Ie,Ie,t=>this._polymorphicAcos(t),"FlowGraphACosBlock",e)}_polymorphicAcos(e){return bt(e,Math.acos)}}Y("FlowGraphACosBlock",eT);class tT extends Ze{constructor(e){super(Ie,Ie,t=>this._polymorphicAtan(t),"FlowGraphATanBlock",e)}_polymorphicAtan(e){return bt(e,Math.atan)}}Y("FlowGraphATanBlock",tT);class iT extends Ft{constructor(e){super(te,te,te,(t,i)=>this._polymorphicAtan2(t,i),"FlowGraphATan2Block",e)}_polymorphicAtan2(e,t){return Zn(e,t,Math.atan2)}}Y("FlowGraphATan2Block",iT);class rT extends Ze{constructor(e){super(te,te,t=>this._polymorphicSinh(t),"FlowGraphSinhBlock",e)}_polymorphicSinh(e){return bt(e,Math.sinh)}}Y("FlowGraphSinhBlock",rT);class sT extends Ze{constructor(e){super(te,te,t=>this._polymorphicCosh(t),"FlowGraphCoshBlock",e)}_polymorphicCosh(e){return bt(e,Math.cosh)}}Y("FlowGraphCoshBlock",sT);class nT extends Ze{constructor(e){super(te,te,t=>this._polymorphicTanh(t),"FlowGraphTanhBlock",e)}_polymorphicTanh(e){return bt(e,Math.tanh)}}Y("FlowGraphTanhBlock",nT);class aT extends Ze{constructor(e){super(te,Ie,t=>this._polymorphicAsinh(t),"FlowGraphASinhBlock",e)}_polymorphicAsinh(e){return bt(e,Math.asinh)}}Y("FlowGraphASinhBlock",aT);class oT extends Ze{constructor(e){super(te,Ie,t=>this._polymorphicAcosh(t),"FlowGraphACoshBlock",e)}_polymorphicAcosh(e){return bt(e,Math.acosh)}}Y("FlowGraphACoshBlock",oT);class lT extends Ze{constructor(e){super(te,Ie,t=>this._polymorphicAtanh(t),"FlowGraphATanhBlock",e)}_polymorphicAtanh(e){return bt(e,Math.atanh)}}Y("FlowGraphATanhBlock",lT);class cT extends Ze{constructor(e){super(te,Ie,t=>this._polymorphicExp(t),"FlowGraphExponentialBlock",e)}_polymorphicExp(e){return bt(e,Math.exp)}}Y("FlowGraphExponentialBlock",cT);class hT extends Ze{constructor(e){super(te,Ie,t=>this._polymorphicLog(t),"FlowGraphLogBlock",e)}_polymorphicLog(e){return bt(e,Math.log)}}Y("FlowGraphLogBlock",hT);class fT extends Ze{constructor(e){super(te,Ie,t=>this._polymorphicLog2(t),"FlowGraphLog2Block",e)}_polymorphicLog2(e){return bt(e,Math.log2)}}Y("FlowGraphLog2Block",fT);class uT extends Ze{constructor(e){super(te,Ie,t=>this._polymorphicLog10(t),"FlowGraphLog10Block",e)}_polymorphicLog10(e){return bt(e,Math.log10)}}Y("FlowGraphLog10Block",uT);class dT extends Ze{constructor(e){super(te,Ie,t=>this._polymorphicSqrt(t),"FlowGraphSquareRootBlock",e)}_polymorphicSqrt(e){return bt(e,Math.sqrt)}}Y("FlowGraphSquareRootBlock",dT);class _T extends Ze{constructor(e){super(te,Ie,t=>this._polymorphicCubeRoot(t),"FlowGraphCubeRootBlock",e)}_polymorphicCubeRoot(e){return bt(e,Math.cbrt)}}Y("FlowGraphCubeRootBlock",_T);class pT extends Ft{constructor(e){super(te,Ie,Ie,(t,i)=>this._polymorphicPow(t,i),"FlowGraphPowerBlock",e)}_polymorphicPow(e,t){return Zn(e,t,Math.pow)}}Y("FlowGraphPowerBlock",pT);class mT extends Ze{constructor(e){super(ot((e==null?void 0:e.valueType)||"FlowGraphInteger"),ot((e==null?void 0:e.valueType)||"FlowGraphInteger"),t=>typeof t=="boolean"?!t:typeof t=="number"?~t:new et(~t.value),"FlowGraphBitwiseNotBlock",e)}}Y("FlowGraphBitwiseNotBlock",mT);class gT extends Ft{constructor(e){super(ot((e==null?void 0:e.valueType)||"FlowGraphInteger"),ot((e==null?void 0:e.valueType)||"FlowGraphInteger"),ot((e==null?void 0:e.valueType)||"FlowGraphInteger"),(t,i)=>{if(typeof t=="boolean"&&typeof i=="boolean")return t&&i;if(typeof t=="number"&&typeof i=="number")return t&i;if(typeof t=="object"&&typeof i=="object")return new et(t.value&i.value);throw new Error(`Cannot perform bitwise AND on ${t} and ${i}`)},"FlowGraphBitwiseAndBlock",e)}}Y("FlowGraphBitwiseAndBlock",gT);class ET extends Ft{constructor(e){super(ot((e==null?void 0:e.valueType)||"FlowGraphInteger"),ot((e==null?void 0:e.valueType)||"FlowGraphInteger"),ot((e==null?void 0:e.valueType)||"FlowGraphInteger"),(t,i)=>{if(typeof t=="boolean"&&typeof i=="boolean")return t||i;if(typeof t=="number"&&typeof i=="number")return t|i;if(typeof t=="object"&&typeof i=="object")return new et(t.value|i.value);throw new Error(`Cannot perform bitwise OR on ${t} and ${i}`)},"FlowGraphBitwiseOrBlock",e)}}Y("FlowGraphBitwiseOrBlock",ET);class vT extends Ft{constructor(e){super(ot((e==null?void 0:e.valueType)||"FlowGraphInteger"),ot((e==null?void 0:e.valueType)||"FlowGraphInteger"),ot((e==null?void 0:e.valueType)||"FlowGraphInteger"),(t,i)=>{if(typeof t=="boolean"&&typeof i=="boolean")return t!==i;if(typeof t=="number"&&typeof i=="number")return t^i;if(typeof t=="object"&&typeof i=="object")return new et(t.value^i.value);throw new Error(`Cannot perform bitwise XOR on ${t} and ${i}`)},"FlowGraphBitwiseXorBlock",e)}}Y("FlowGraphBitwiseXorBlock",vT);class TT extends Ft{constructor(e){super(Ut,Ut,Ut,(t,i)=>new et(t.value<<i.value),"FlowGraphBitwiseLeftShiftBlock",e)}}Y("FlowGraphBitwiseLeftShiftBlock",TT);class ST extends Ft{constructor(e){super(Ut,Ut,Ut,(t,i)=>new et(t.value>>i.value),"FlowGraphBitwiseRightShiftBlock",e)}}Y("FlowGraphBitwiseRightShiftBlock",ST);class AT extends Ze{constructor(e){super(Ut,Ut,t=>new et(Math.clz32(t.value)),"FlowGraphLeadingZerosBlock",e)}}Y("FlowGraphLeadingZerosBlock",AT);class RT extends Ze{constructor(e){super(Ut,Ut,t=>new et(t.value?31-Math.clz32(t.value&-t.value):32),"FlowGraphTrailingZerosBlock",e)}}Y("FlowGraphTrailingZerosBlock",RT);function zD(a){let e=0;for(;a;)e+=a&1,a>>=1;return e}class CT extends Ze{constructor(e){super(Ut,Ut,t=>new et(zD(t.value)),"FlowGraphOneBitsCounterBlock",e)}}Y("FlowGraphOneBitsCounterBlock",CT);const Ve=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphAbsBlock:Mv,FlowGraphAcosBlock:eT,FlowGraphAcoshBlock:oT,FlowGraphAddBlock:Tv,FlowGraphAsinBlock:Jv,FlowGraphAsinhBlock:aT,FlowGraphAtan2Block:iT,FlowGraphAtanBlock:tT,FlowGraphAtanhBlock:lT,FlowGraphBitwiseAndBlock:gT,FlowGraphBitwiseLeftShiftBlock:TT,FlowGraphBitwiseNotBlock:mT,FlowGraphBitwiseOrBlock:ET,FlowGraphBitwiseRightShiftBlock:ST,FlowGraphBitwiseXorBlock:vT,FlowGraphCeilBlock:Lv,FlowGraphClampBlock:kv,FlowGraphCosBlock:XD,FlowGraphCoshBlock:sT,FlowGraphCubeRootBlock:_T,FlowGraphDegToRadBlock:Qv,FlowGraphDivideBlock:Rv,FlowGraphEBlock:Iv,FlowGraphEqualityBlock:Hv,FlowGraphExpBlock:cT,FlowGraphFloorBlock:Dv,FlowGraphFractionBlock:Fv,FlowGraphGreaterThanBlock:Kv,FlowGraphGreaterThanOrEqualBlock:qv,FlowGraphInfBlock:xv,FlowGraphIsInfinityBlock:Zv,FlowGraphIsNanBlock:jv,FlowGraphLeadingZerosBlock:AT,FlowGraphLessThanBlock:zv,FlowGraphLessThanOrEqualBlock:Yv,FlowGraphLog10Block:uT,FlowGraphLog2Block:fT,FlowGraphLogBlock:hT,FlowGraphMathInterpolationBlock:Xv,FlowGraphMaxBlock:Vv,FlowGraphMinBlock:Uv,FlowGraphModuloBlock:Bv,FlowGraphMultiplyBlock:Av,FlowGraphNaNBlock:yv,FlowGraphNegationBlock:wv,FlowGraphOneBitsCounterBlock:CT,FlowGraphPiBlock:bv,FlowGraphPowerBlock:pT,FlowGraphRadToDegBlock:$v,FlowGraphRandomBlock:Cv,FlowGraphRoundBlock:Nv,FlowGraphSaturateBlock:Wv,FlowGraphSignBlock:Pv,FlowGraphSinBlock:WD,FlowGraphSinhBlock:rT,FlowGraphSquareRootBlock:dT,FlowGraphSubtractBlock:Sv,FlowGraphTanBlock:HD,FlowGraphTanhBlock:nT,FlowGraphTrailingZerosBlock:RT,FlowGraphTruncBlock:Ov},Symbol.toStringTag,{value:"Module"}));class IT extends Ze{constructor(e){super(te,Ie,t=>this._polymorphicLength(t),"FlowGraphLengthBlock",e)}_polymorphicLength(e){switch(li(e)){case"Vector2":case"Vector3":case"Vector4":case"Quaternion":return e.length();default:throw new Error(`Cannot compute length of value ${e}`)}}}Y("FlowGraphLengthBlock",IT);class bT extends Ze{constructor(e){super(te,te,t=>this._polymorphicNormalize(t),"FlowGraphNormalizeBlock",e)}_polymorphicNormalize(e){var r;const t=li(e);let i;switch(t){case"Vector2":case"Vector3":case"Vector4":case"Quaternion":return i=e.normalizeToNew(),(r=this.config)!=null&&r.nanOnZeroLength&&e.length()===0&&i.setAll(NaN),i;default:throw new Error(`Cannot normalize value ${e}`)}}}Y("FlowGraphNormalizeBlock",bT);class xT extends Ft{constructor(e){super(te,te,Ie,(t,i)=>this._polymorphicDot(t,i),"FlowGraphDotBlock",e)}_polymorphicDot(e,t){switch(li(e)){case"Vector2":case"Vector3":case"Vector4":case"Quaternion":return e.dot(t);default:throw new Error(`Cannot get dot product of ${e} and ${t}`)}}}Y("FlowGraphDotBlock",xT);class yT extends Ft{constructor(e){super(zt,zt,zt,(t,i)=>m.Cross(t,i),"FlowGraphCrossBlock",e)}}Y("FlowGraphCrossBlock",yT);class MT extends Ft{constructor(e){super(Br,Ie,Br,(t,i)=>ne.Transform(t,P.RotationZ(i)),"FlowGraphRotate2DBlock",e)}}Y("FlowGraphRotate2DBlock",MT);class PT extends _h{constructor(e){super(zt,zt,Ie,zt,(t,i,r)=>m.TransformCoordinates(t,P.RotationAxis(i,r)),"FlowGraphRotate3DBlock",e)}}Y("FlowGraphRotate3DBlock",PT);function YD(a,e){switch(li(a)){case"Vector2":return e.transformVector(a);case"Vector3":return e.transformVector(a);case"Vector4":return a=a,new Fe(a.x*e.m[0]+a.y*e.m[1]+a.z*e.m[2]+a.w*e.m[3],a.x*e.m[4]+a.y*e.m[5]+a.z*e.m[6]+a.w*e.m[7],a.x*e.m[8]+a.y*e.m[9]+a.z*e.m[10]+a.w*e.m[11],a.x*e.m[12]+a.y*e.m[13]+a.z*e.m[14]+a.w*e.m[15]);default:throw new Error(`Cannot transform value ${a}`)}}class OT extends Ft{constructor(e){const t=(e==null?void 0:e.vectorType)||"Vector3",i=t==="Vector2"?"Matrix2D":t==="Vector3"?"Matrix3D":"Matrix";super(ot(t),ot(i),ot(t),YD,"FlowGraphTransformVectorBlock",e)}}Y("FlowGraphTransformVectorBlock",OT);class DT extends Ft{constructor(e){super(zt,ns,zt,(t,i)=>m.TransformCoordinates(t,i),"FlowGraphTransformCoordinatesBlock",e)}}Y("FlowGraphTransformCoordinatesBlock",DT);const Hr=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphCrossBlock:yT,FlowGraphDotBlock:xT,FlowGraphLengthBlock:IT,FlowGraphNormalizeBlock:bT,FlowGraphRotate2DBlock:MT,FlowGraphRotate3DBlock:PT,FlowGraphTransformBlock:OT,FlowGraphTransformCoordinatesBlock:DT},Symbol.toStringTag,{value:"Module"}));class LT extends Ze{constructor(e){super(ot((e==null?void 0:e.matrixType)||"Matrix"),ot((e==null?void 0:e.matrixType)||"Matrix"),t=>t.transpose?t.transpose():P.Transpose(t),"FlowGraphTransposeBlock",e)}}Y("FlowGraphTransposeBlock",LT);class NT extends Ze{constructor(e){super(ot((e==null?void 0:e.matrixType)||"Matrix"),Ie,t=>t.determinant(),"FlowGraphDeterminantBlock",e)}}Y("FlowGraphDeterminantBlock",NT);class FT extends Ze{constructor(e){super(ot((e==null?void 0:e.matrixType)||"Matrix"),ot((e==null?void 0:e.matrixType)||"Matrix"),t=>t.inverse?t.inverse():P.Invert(t),"FlowGraphInvertMatrixBlock",e)}}Y("FlowGraphInvertMatrixBlock",FT);class wT extends Ft{constructor(e){super(ot((e==null?void 0:e.matrixType)||"Matrix"),ot((e==null?void 0:e.matrixType)||"Matrix"),ot((e==null?void 0:e.matrixType)||"Matrix"),(t,i)=>i.multiply(t),"FlowGraphMatrixMultiplicationBlock",e)}}Y("FlowGraphMatrixMultiplicationBlock",wT);class BT extends ti{constructor(e){super(e),this.input=this.registerDataInput("input",ns),this.position=this.registerDataOutput("position",zt),this.rotationQuaternion=this.registerDataOutput("rotationQuaternion",ln),this.scaling=this.registerDataOutput("scaling",zt),this.isValid=this.registerDataOutput("isValid",$t,!1)}_updateOutputs(e){const t=e._getExecutionVariable(this,"executionId",-1),i=e._getExecutionVariable(this,"cachedPosition",null),r=e._getExecutionVariable(this,"cachedRotation",null),s=e._getExecutionVariable(this,"cachedScaling",null);if(t===e.executionId&&i&&r&&s)this.position.setValue(i,e),this.rotationQuaternion.setValue(r,e),this.scaling.setValue(s,e);else{const n=this.input.getValue(e),o=i||new m,l=r||new z,c=s||new m,h=Math.round(n.m[3]*1e4)/1e4,f=Math.round(n.m[7]*1e4)/1e4,u=Math.round(n.m[11]*1e4)/1e4,d=Math.round(n.m[15]*1e4)/1e4;if(h!==0||f!==0||u!==0||d!==1){this.isValid.setValue(!1,e),this.position.setValue(m.Zero(),e),this.rotationQuaternion.setValue(z.Identity(),e),this.scaling.setValue(m.One(),e);return}const _=n.decompose(c,l,o);this.isValid.setValue(_,e),this.position.setValue(o,e),this.rotationQuaternion.setValue(l,e),this.scaling.setValue(c,e),e._setExecutionVariable(this,"cachedPosition",o),e._setExecutionVariable(this,"cachedRotation",l),e._setExecutionVariable(this,"cachedScaling",c),e._setExecutionVariable(this,"executionId",e.executionId)}}getClassName(){return"FlowGraphMatrixDecompose"}}Y("FlowGraphMatrixDecompose",BT);class UT extends ti{constructor(e){super(e),this.position=this.registerDataInput("position",zt),this.rotationQuaternion=this.registerDataInput("rotationQuaternion",ln),this.scaling=this.registerDataInput("scaling",zt),this.value=this.registerDataOutput("value",ns)}_updateOutputs(e){const t=e._getExecutionVariable(this,"executionId",-1),i=e._getExecutionVariable(this,"cachedMatrix",null);if(t===e.executionId&&i)this.value.setValue(i,e);else{const r=P.Compose(this.scaling.getValue(e),this.rotationQuaternion.getValue(e),this.position.getValue(e));this.value.setValue(r,e),e._setExecutionVariable(this,"cachedMatrix",r),e._setExecutionVariable(this,"executionId",e.executionId)}}getClassName(){return"FlowGraphMatrixCompose"}}Y("FlowGraphMatrixCompose",UT);const Vs=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphDeterminantBlock:NT,FlowGraphInvertMatrixBlock:FT,FlowGraphMatrixComposeBlock:UT,FlowGraphMatrixDecomposeBlock:BT,FlowGraphMatrixMultiplicationBlock:wT,FlowGraphTransposeBlock:LT},Symbol.toStringTag,{value:"Module"}));class VT extends kr{constructor(e){super(e),this.condition=this.registerDataInput("condition",$t),this.onTrue=this._registerSignalOutput("onTrue"),this.onFalse=this._registerSignalOutput("onFalse")}_execute(e){this.condition.getValue(e)?this.onTrue._activateSignal(e):this.onFalse._activateSignal(e)}getClassName(){return"FlowGraphBranchBlock"}}Y("FlowGraphBranchBlock",VT);const KD=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphBranchBlock:VT},Symbol.toStringTag,{value:"Module"}));class Qn extends Eo{constructor(e){super(e),this.cancel=this._registerSignalInput("cancel"),this.duration=this.registerDataInput("duration",Ie),this.lastDelayIndex=this.registerDataOutput("lastDelayIndex",Ie,-1)}_preparePendingTasks(e){const t=this.duration.getValue(e);if(t<0||isNaN(t)||!isFinite(t))return this._reportError(e,"Invalid duration in SetDelay block");if(e._getGlobalContextVariable("activeDelays",0)>=Qn.MaxParallelDelayCount)return this._reportError(e,"Max parallel delays reached");const r=e._getGlobalContextVariable("lastDelayIndex",-1),s=e._getExecutionVariable(this,"pendingDelays",[]),n=e.configuration.scene,o=new lb({timeout:t*1e3,contextObservable:n.onBeforeRenderObservable,onEnded:()=>this._onEnded(o,e)});o.start();const l=r+1;this.lastDelayIndex.setValue(l,e),e._setGlobalContextVariable("lastDelayIndex",l),s[l]=o,e._setExecutionVariable(this,"pendingDelays",s)}_cancelPendingTasks(e){const t=e._getExecutionVariable(this,"pendingDelays",[]);for(const i of t)i==null||i.dispose();e._deleteExecutionVariable(this,"pendingDelays"),this.lastDelayIndex.setValue(-1,e)}_execute(e,t){if(t===this.cancel){this._cancelPendingTasks(e);return}else this._preparePendingTasks(e),this.out._activateSignal(e)}getClassName(){return"FlowGraphSetDelayBlock"}_onEnded(e,t){const i=t._getExecutionVariable(this,"pendingDelays",[]),r=i.indexOf(e);r!==-1?i.splice(r,1):B.Warn("FlowGraphTimerBlock: Timer ended but was not found in the running timers list"),t._removePendingBlock(this),this.done._activateSignal(t)}}Qn.MaxParallelDelayCount=100;Y("FlowGraphSetDelayBlock",Qn);const qD=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphSetDelayBlock:Qn},Symbol.toStringTag,{value:"Module"}));class GT extends Di{constructor(e){super(e),this.delayIndex=this.registerDataInput("delayIndex",Ie)}_execute(e,t){const i=this.delayIndex.getValue(e);if(i<=0||isNaN(i)||!isFinite(i))return this._reportError(e,"Invalid delay index");const s=e._getExecutionVariable(this,"pendingDelays",[])[i];s&&s.dispose(),this.out._activateSignal(e)}getClassName(){return"FlowGraphCancelDelayBlock"}}Y("FlowGraphCancelDelayBlock",GT);const jD=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphCancelDelayBlock:GT},Symbol.toStringTag,{value:"Module"}));class kT extends Di{constructor(e){super(e),this.count=this.registerDataOutput("count",Ie),this.reset=this._registerSignalInput("reset")}_execute(e,t){if(t===this.reset){e._setExecutionVariable(this,"count",0),this.count.setValue(0,e);return}const i=e._getExecutionVariable(this,"count",0)+1;e._setExecutionVariable(this,"count",i),this.count.setValue(i,e),this.out._activateSignal(e)}getClassName(){return"FlowGraphCallCounterBlock"}}Y("FlowGraphCallCounterBlock",kT);const ZD=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphCallCounterBlock:kT},Symbol.toStringTag,{value:"Module"}));class WT extends Di{constructor(e){super(e),this.count=this.registerDataInput("count",Ie),this.reset=this._registerSignalInput("reset"),this.currentCount=this.registerDataOutput("currentCount",Ie)}_execute(e,t){if(t===this.reset){e._setExecutionVariable(this,"debounceCount",0);return}const i=this.count.getValue(e),s=e._getExecutionVariable(this,"debounceCount",0)+1;this.currentCount.setValue(s,e),e._setExecutionVariable(this,"debounceCount",s),s>=i&&(this.out._activateSignal(e),e._setExecutionVariable(this,"debounceCount",0))}getClassName(){return"FlowGraphDebounceBlock"}}Y("FlowGraphDebounceBlock",WT);const QD=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphDebounceBlock:WT},Symbol.toStringTag,{value:"Module"}));class XT extends Di{constructor(e){super(e),this.reset=this._registerSignalInput("reset"),this.duration=this.registerDataInput("duration",Ie),this.lastRemainingTime=this.registerDataOutput("lastRemainingTime",Ie,NaN)}_execute(e,t){if(t===this.reset){this.lastRemainingTime.setValue(NaN,e),e._setExecutionVariable(this,"lastRemainingTime",NaN),e._setExecutionVariable(this,"timestamp",0);return}const i=this.duration.getValue(e);if(i<=0||isNaN(i)||!isFinite(i))return this._reportError(e,"Invalid duration in Throttle block");const r=e._getExecutionVariable(this,"lastRemainingTime",NaN),s=Date.now();if(isNaN(r))return this.lastRemainingTime.setValue(0,e),e._setExecutionVariable(this,"lastRemainingTime",0),e._setExecutionVariable(this,"timestamp",s),this.out._activateSignal(e);{const n=s-e._getExecutionVariable(this,"timestamp",0),o=i*1e3;if(o<=n)return this.lastRemainingTime.setValue(0,e),e._setExecutionVariable(this,"lastRemainingTime",0),e._setExecutionVariable(this,"timestamp",s),this.out._activateSignal(e);{const l=o-n;this.lastRemainingTime.setValue(l/1e3,e),e._setExecutionVariable(this,"lastRemainingTime",l)}}}getClassName(){return"FlowGraphThrottleBlock"}}Y("FlowGraphThrottleBlock",XT);const $D=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphThrottleBlock:XT},Symbol.toStringTag,{value:"Module"}));class HT extends Di{constructor(e={}){super(e),this.config=e,this.config.startIndex=e.startIndex??new et(0),this.reset=this._registerSignalInput("reset"),this.maxExecutions=this.registerDataInput("maxExecutions",Ut),this.executionCount=this.registerDataOutput("executionCount",Ut,new et(0))}_execute(e,t){if(t===this.reset)this.executionCount.setValue(this.config.startIndex,e);else{const i=this.executionCount.getValue(e);i.value<this.maxExecutions.getValue(e).value&&(this.executionCount.setValue(new et(i.value+1),e),this.out._activateSignal(e))}}getClassName(){return"FlowGraphDoNBlock"}}Y("FlowGraphDoNBlock",HT);const JD=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphDoNBlock:HT},Symbol.toStringTag,{value:"Module"}));class zT extends kr{constructor(e){super(e),this.onOn=this._registerSignalOutput("onOn"),this.onOff=this._registerSignalOutput("onOff"),this.value=this.registerDataOutput("value",$t)}_execute(e,t){var r;let i=e._getExecutionVariable(this,"value",typeof((r=this.config)==null?void 0:r.startValue)=="boolean"?!this.config.startValue:!1);i=!i,e._setExecutionVariable(this,"value",i),this.value.setValue(i,e),i?this.onOn._activateSignal(e):this.onOff._activateSignal(e)}getClassName(){return"FlowGraphFlipFlopBlock"}}Y("FlowGraphFlipFlopBlock",zT);const eL=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphFlipFlopBlock:zT},Symbol.toStringTag,{value:"Module"}));class $n extends Di{constructor(e){super(e),this.startIndex=this.registerDataInput("startIndex",te,0),this.endIndex=this.registerDataInput("endIndex",te),this.step=this.registerDataInput("step",Ie,1),this.index=this.registerDataOutput("index",Ut,new et(vi((e==null?void 0:e.initialIndex)??0))),this.executionFlow=this._registerSignalOutput("executionFlow"),this.completed=this._registerSignalOutput("completed"),this._unregisterSignalOutput("out")}_execute(e){const t=vi(this.startIndex.getValue(e)),i=this.step.getValue(e);let r=vi(this.endIndex.getValue(e));for(let s=t;s<r&&(this.index.setValue(new et(s),e),this.executionFlow._activateSignal(e),r=vi(this.endIndex.getValue(e)),!(s>$n.MaxLoopIterations));s+=i);this.completed._activateSignal(e)}getClassName(){return"FlowGraphForLoopBlock"}}$n.MaxLoopIterations=1e3;Y("FlowGraphForLoopBlock",$n);const tL=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphForLoopBlock:$n},Symbol.toStringTag,{value:"Module"}));class YT extends kr{constructor(e){super(e),this.config=e,this.outputSignals=[],this.reset=this._registerSignalInput("reset"),this.lastIndex=this.registerDataOutput("lastIndex",Ut,new et(-1)),this.setNumberOfOutputSignals(e==null?void 0:e.outputSignalCount)}_getNextIndex(e){if(e.includes(!1)||this.config.isLoop&&e.fill(!1),this.config.isRandom){const t=e.map((i,r)=>i?-1:r).filter(i=>i!==-1);return t.length?t[Math.floor(Math.random()*t.length)]:-1}else return e.indexOf(!1)}setNumberOfOutputSignals(e=1){for(;this.outputSignals.length>e;){const t=this.outputSignals.pop();t&&(t.disconnectFromAll(),this._unregisterSignalOutput(t.name))}for(;this.outputSignals.length<e;)this.outputSignals.push(this._registerSignalOutput(`out_${this.outputSignals.length}`))}_execute(e,t){if(e._hasExecutionVariable(this,"indexesUsed")||e._setExecutionVariable(this,"indexesUsed",this.outputSignals.map(()=>!1)),t===this.reset){e._deleteExecutionVariable(this,"indexesUsed"),this.lastIndex.setValue(new et(-1),e);return}const i=e._getExecutionVariable(this,"indexesUsed",[]),r=this._getNextIndex(i);r>-1&&(this.lastIndex.setValue(new et(r),e),i[r]=!0,e._setExecutionVariable(this,"indexesUsed",i),this.outputSignals[r]._activateSignal(e))}getClassName(){return"FlowGraphMultiGateBlock"}serialize(e){super.serialize(e),e.config.outputSignalCount=this.config.outputSignalCount,e.config.isRandom=this.config.isRandom,e.config.loop=this.config.isLoop,e.config.startIndex=this.config.startIndex}}Y("FlowGraphMultiGateBlock",YT);const iL=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphMultiGateBlock:YT},Symbol.toStringTag,{value:"Module"}));class KT extends kr{constructor(e){super(e),this.config=e,this.executionSignals=[],this.setNumberOfOutputSignals(this.config.outputSignalCount)}_execute(e){for(let t=0;t<this.executionSignals.length;t++)this.executionSignals[t]._activateSignal(e)}setNumberOfOutputSignals(e=1){for(;this.executionSignals.length>e;){const t=this.executionSignals.pop();t&&(t.disconnectFromAll(),this._unregisterSignalOutput(t.name))}for(;this.executionSignals.length<e;)this.executionSignals.push(this._registerSignalOutput(`out_${this.executionSignals.length}`))}getClassName(){return"FlowGraphSequenceBlock"}}Y("FlowGraphSequenceBlock",KT);const rL=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphSequenceBlock:KT},Symbol.toStringTag,{value:"Module"}));class qT extends kr{constructor(e){super(e),this.config=e,this.default=this._registerSignalOutput("default"),this._caseToOutputFlow=new Map,this.case=this.registerDataInput("case",te),(this.config.cases||[]).forEach(t=>{this._caseToOutputFlow.set(t,this._registerSignalOutput(`out_${t}`))})}_execute(e,t){const i=this.case.getValue(e);let r;rn(i)?r=this._getOutputFlowForCase(vi(i)):r=this._getOutputFlowForCase(i),r?r._activateSignal(e):this.default._activateSignal(e)}addCase(e){this.config.cases.includes(e)||(this.config.cases.push(e),this._caseToOutputFlow.set(e,this._registerSignalOutput(`out_${e}`)))}removeCase(e){if(!this.config.cases.includes(e))return;const t=this.config.cases.indexOf(e);this.config.cases.splice(t,1),this._caseToOutputFlow.delete(e)}_getOutputFlowForCase(e){return this._caseToOutputFlow.get(e)}getClassName(){return"FlowGraphSwitchBlock"}serialize(e){super.serialize(e),e.cases=this.config.cases}}Y("FlowGraphSwitchBlock",qT);const sL=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphSwitchBlock:qT},Symbol.toStringTag,{value:"Module"}));class jT extends Di{constructor(e){super(e),this.config=e,this.inFlows=[],this._cachedActivationState=[],this.reset=this._registerSignalInput("reset"),this.completed=this._registerSignalOutput("completed"),this.remainingInputs=this.registerDataOutput("remainingInputs",Ie,this.config.inputSignalCount||0);for(let t=0;t<this.config.inputSignalCount;t++)this.inFlows.push(this._registerSignalInput(`in_${t}`));this._unregisterSignalInput("in")}_getCurrentActivationState(e){const t=this._cachedActivationState;if(t.length=0,e._hasExecutionVariable(this,"activationState")){const i=e._getExecutionVariable(this,"activationState",[]);for(let r=0;r<i.length;r++)t.push(i[r])}else for(let i=0;i<this.config.inputSignalCount;i++)t.push(!1);return t}_execute(e,t){const i=this._getCurrentActivationState(e);if(t===this.reset)for(let r=0;r<this.config.inputSignalCount;r++)i[r]=!1;else{const r=this.inFlows.indexOf(t);r>=0&&(i[r]=!0)}if(this.remainingInputs.setValue(i.filter(r=>!r).length,e),e._setExecutionVariable(this,"activationState",i.slice()),i.includes(!1))t!==this.reset&&this.out._activateSignal(e);else{this.completed._activateSignal(e);for(let r=0;r<this.config.inputSignalCount;r++)i[r]=!1}}getClassName(){return"FlowGraphWaitAllBlock"}serialize(e){super.serialize(e),e.config.inputFlows=this.config.inputSignalCount}}Y("FlowGraphWaitAllBlock",jT);const nL=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphWaitAllBlock:jT},Symbol.toStringTag,{value:"Module"}));class Jn extends Di{constructor(e){super(e),this.config=e,this.condition=this.registerDataInput("condition",$t),this.executionFlow=this._registerSignalOutput("executionFlow"),this.completed=this._registerSignalOutput("completed"),this._unregisterSignalOutput("out")}_execute(e,t){var s;let i=this.condition.getValue(e);(s=this.config)!=null&&s.doWhile&&!i&&this.executionFlow._activateSignal(e);let r=0;for(;i;){if(this.executionFlow._activateSignal(e),++r,r>=Jn.MaxLoopCount){B.Warn("FlowGraphWhileLoopBlock: Max loop count reached. Breaking.");break}i=this.condition.getValue(e)}this.completed._activateSignal(e)}getClassName(){return"FlowGraphWhileLoopBlock"}}Jn.MaxLoopCount=1e3;Y("FlowGraphWhileLoopBlock",Jn);const aL=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphWhileLoopBlock:Jn},Symbol.toStringTag,{value:"Module"}));class ZT extends Di{constructor(e){if(super(e),this.message=this.registerDataInput("message",te),this.logType=this.registerDataInput("logType",te,"log"),e!=null&&e.messageTemplate){const t=this._getTemplateMatches(e.messageTemplate);for(const i of t)this.registerDataInput(i,te)}}_execute(e){const t=this.logType.getValue(e),i=this._getMessageValue(e);t==="warn"?B.Warn(i):t==="error"?B.Error(i):B.Log(i),this.out._activateSignal(e)}getClassName(){return"FlowGraphConsoleLogBlock"}_getMessageValue(e){var t,i;if((t=this.config)!=null&&t.messageTemplate){let r=this.config.messageTemplate;const s=this._getTemplateMatches(r);for(const n of s){const o=(i=this.getDataInput(n))==null?void 0:i.getValue(e);o!==void 0&&(r=r.replace(new RegExp(`\\{${n}\\}`,"g"),o.toString()))}return r}else return this.message.getValue(e)}_getTemplateMatches(e){const t=/\{([^}]+)\}/g,i=[];let r;for(;(r=t.exec(e))!==null;)i.push(r[1]);return i}}Y("FlowGraphConsoleLogBlock",ZT);const oL=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphConsoleLogBlock:ZT},Symbol.toStringTag,{value:"Module"}));class QT extends ti{constructor(e){super(e),this.condition=this.registerDataInput("condition",$t),this.onTrue=this.registerDataInput("onTrue",te),this.onFalse=this.registerDataInput("onFalse",te),this.output=this.registerDataOutput("output",te)}_updateOutputs(e){const t=this.condition.getValue(e);this.output.setValue(t?this.onTrue.getValue(e):this.onFalse.getValue(e),e)}getClassName(){return"FlowGraphConditionalBlock"}}Y("FlowGraphConditionalBlock",QT);const lL=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphConditionalDataBlock:QT},Symbol.toStringTag,{value:"Module"}));class $T extends ti{constructor(e){super(e),this.config=e,this.output=this.registerDataOutput("output",Sb(e.value))}_updateOutputs(e){this.output.setValue(this.config.value,e)}getClassName(){return"FlowGraphConstantBlock"}serialize(e={},t=mo){super.serialize(e),t("value",this.config.value,e.config)}}Y("FlowGraphConstantBlock",$T);const cL=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphConstantBlock:$T},Symbol.toStringTag,{value:"Module"}));class JT extends ti{constructor(e){super(e),this.sourceSystem=this.registerDataInput("sourceSystem",te),this.destinationSystem=this.registerDataInput("destinationSystem",te),this.inputCoordinates=this.registerDataInput("inputCoordinates",zt),this.outputCoordinates=this.registerDataOutput("outputCoordinates",zt)}_updateOutputs(e){const t=this.sourceSystem.getValue(e),i=this.destinationSystem.getValue(e),r=this.inputCoordinates.getValue(e),s=t.getWorldMatrix(),n=i.getWorldMatrix(),o=F.Matrix[0].copyFrom(n);o.invert();const l=F.Matrix[1];o.multiplyToRef(s,l);const c=this.outputCoordinates.getValue(e);m.TransformCoordinatesToRef(r,l,c)}getClassName(){return"FlowGraphTransformCoordinatesSystemBlock"}}Y("FlowGraphTransformCoordinatesSystemBlock",JT);const hL=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphTransformCoordinatesSystemBlock:JT},Symbol.toStringTag,{value:"Module"}));class eS extends ti{constructor(e){super(e),this.config=e,this.type=this.registerDataInput("type",te,e.type),this.value=this.registerDataOutput("value",te),this.index=this.registerDataInput("index",te,new et(vi(e.index??-1)))}_updateOutputs(e){const t=this.type.getValue(e),i=this.index.getValue(e),r=jg(e.assetsContext,t,vi(i),this.config.useIndexAsUniqueId);this.value.setValue(r,e)}getClassName(){return"FlowGraphGetAssetBlock"}}Y("FlowGraphGetAssetBlock",eS);const fL=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphGetAssetBlock:eS},Symbol.toStringTag,{value:"Module"}));class tS extends Ps{constructor(e){super(te,e),this.config=e,this.object=this.registerDataInput("object",te,e.object),this.propertyName=this.registerDataInput("propertyName",te,e.propertyName),this.customGetFunction=this.registerDataInput("customGetFunction",te)}_doOperation(e){const t=this.customGetFunction.getValue(e);let i;if(t)i=t(this.object.getValue(e),this.propertyName.getValue(e),e);else{const r=this.object.getValue(e),s=this.propertyName.getValue(e);i=r&&s?this._getPropertyValue(r,s):void 0}return i}_getPropertyValue(e,t){const i=t.split(".");let r=e;for(const s of i)if(r=r[s],r===void 0)return;return r}getClassName(){return"FlowGraphGetPropertyBlock"}}Y("FlowGraphGetPropertyBlock",tS);const uL=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphGetPropertyBlock:tS},Symbol.toStringTag,{value:"Module"}));class iS extends Di{constructor(e){super(e),this.config=e,this.object=this.registerDataInput("object",te,e.target),this.value=this.registerDataInput("value",te),this.propertyName=this.registerDataInput("propertyName",te,e.propertyName),this.customSetFunction=this.registerDataInput("customSetFunction",te)}_execute(e,t){try{const i=this.object.getValue(e),r=this.value.getValue(e),s=this.customSetFunction.getValue(e);s?s(i,this.propertyName.getValue(e),r,e):this._setPropertyValue(i,this.propertyName.getValue(e),r)}catch(i){this._reportError(e,i)}this.out._activateSignal(e)}_setPropertyValue(e,t,i){const r=t.split(".");let s=e;for(let n=0;n<r.length-1;n++){const o=r[n];s[o]===void 0&&(s[o]={}),s=s[o]}s[r[r.length-1]]=i}getClassName(){return"FlowGraphSetPropertyBlock"}}Y("FlowGraphSetPropertyBlock",iS);const dL=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphSetPropertyBlock:iS},Symbol.toStringTag,{value:"Module"}));class rS extends ti{constructor(e){super(e),this.config=e,this.value=this.registerDataOutput("value",te,e.initialValue)}_updateOutputs(e){const t=this.config.variable;e.hasVariable(t)&&this.value.setValue(e.getVariable(t),e)}serialize(e){super.serialize(e),e.config.variable=this.config.variable}getClassName(){return"FlowGraphGetVariableBlock"}}Y("FlowGraphGetVariableBlock",rS);const _L=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphGetVariableBlock:rS},Symbol.toStringTag,{value:"Module"}));class sS extends Di{constructor(e){if(super(e),!e.variable&&!e.variables)throw new Error("FlowGraphSetVariableBlock: variable/variables is not defined");if(e.variables&&e.variable)throw new Error("FlowGraphSetVariableBlock: variable and variables are both defined");if(e.variables)for(const t of e.variables)this.registerDataInput(t,te);else this.registerDataInput("value",te)}_execute(e,t){var i,r;if((i=this.config)!=null&&i.variables)for(const s of this.config.variables)this._saveVariable(e,s);else this._saveVariable(e,(r=this.config)==null?void 0:r.variable,"value");this.out._activateSignal(e)}_saveVariable(e,t,i){var n;const r=e._getGlobalContextVariable("currentlyRunningAnimationGroups",[]);for(const o of r){const l=e.assetsContext.animationGroups[o];for(const c of l.targetedAnimations)if(c.target===e&&c.target===e&&c.animation.targetProperty===t){l.stop();const h=r.indexOf(o);h>-1&&r.splice(h,1),e._setGlobalContextVariable("currentlyRunningAnimationGroups",r);break}}const s=(n=this.getDataInput(i||t))==null?void 0:n.getValue(e);e.setVariable(t,s)}getClassName(){return"FlowGraphSetVariableBlock"}serialize(e){var t;super.serialize(e),e.config.variable=(t=this.config)==null?void 0:t.variable}}Y("FlowGraphSetVariableBlock",sS);const pL=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphSetVariableBlock:sS},Symbol.toStringTag,{value:"Module"})),im=new RegExp(/\/\{(\w+)\}\//g);class mL{constructor(e,t){this.path=e,this.ownerBlock=t,this.templatedInputs=[];let i=im.exec(e);const r=new Set;for(;i;){const[,s]=i;if(r.has(s))throw new Error("Duplicate template variable detected.");r.add(s),this.templatedInputs.push(t.registerDataInput(s,Ut,new et(0))),i=im.exec(e)}}getAccessor(e,t){let i=this.path;for(const r of this.templatedInputs){const s=r.getValue(t).value;if(typeof s!="number"||s<0)throw new Error("Invalid value for templated input.");i=i.replace(`{${r.name}}`,s.toString())}return e.convert(i)}}class nS extends Ps{constructor(e){super(te,e),this.config=e,this.object=this.registerDataOutput("object",te),this.propertyName=this.registerDataOutput("propertyName",te),this.setterFunction=this.registerDataOutput("setFunction",te,this._setPropertyValue.bind(this)),this.getterFunction=this.registerDataOutput("getFunction",te,this._getPropertyValue.bind(this)),this.generateAnimationsFunction=this.registerDataOutput("generateAnimationsFunction",te,this._getInterpolationAnimationPropertyInfo.bind(this)),this.templateComponent=new mL(e.jsonPointer,this)}_doOperation(e){var n,o,l;const t=this.templateComponent.getAccessor(this.config.pathConverter,e),i=t.info.get(t.object),r=(o=(n=t.info).getTarget)==null?void 0:o.call(n,t.object),s=(l=t.info.getPropertyName)==null?void 0:l[0](t.object);if(r)this.object.setValue(r,e),s&&this.propertyName.setValue(s,e);else throw new Error("Object is undefined");return i}_setPropertyValue(e,t,i,r){var o,l;const s=this.templateComponent.getAccessor(this.config.pathConverter,r),n=s.info.type;n.startsWith("Color")&&(i=rm(i,n)),(l=(o=s.info).set)==null||l.call(o,i,s.object)}_getPropertyValue(e,t,i){const r=this.templateComponent.getAccessor(this.config.pathConverter,i);return r.info.get(r.object)}_getInterpolationAnimationPropertyInfo(e,t,i){const r=this.templateComponent.getAccessor(this.config.pathConverter,i);return(s,n,o,l)=>{var f;const c=[],h=r.info.type;return h.startsWith("Color")&&(s=s.map(u=>({frame:u.frame,value:rm(u.value,h)}))),(f=r.info.interpolation)==null||f.forEach((u,d)=>{var E;const _=((E=r.info.getPropertyName)==null?void 0:E[d](r.object))||"Animation-interpolation-"+d;let p=s;o!==u.type&&(p=s.map(v=>({frame:v.frame,value:u.getValue(void 0,v.value.asArray?v.value.asArray():[v.value],0,1)}))),u.buildAnimations(r.object,_,60,p).forEach(v=>{l&&v.babylonAnimation.setEasingFunction(l),c.push(v.babylonAnimation)})}),c}}getClassName(){return"FlowGraphJsonPointerParserBlock"}}function rm(a,e){return a.getClassName().startsWith("Color")?a:e==="Color3"?new ae(a.x,a.y,a.z):e==="Color4"?new Ne(a.x,a.y,a.z,a.w):a}Y("FlowGraphJsonPointerParserBlock",nS);const gL=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphJsonPointerParserBlock:nS},Symbol.toStringTag,{value:"Module"}));class cn extends Ps{constructor(e,t,i){super(t,i);for(let r=0;r<e;r++)this.registerDataInput(`input_${r}`,Ie,0)}}class hn extends ti{constructor(e,t,i){super(i),this.registerDataInput("input",t);for(let r=0;r<e;r++)this.registerDataOutput(`output_${r}`,Ie,0)}}class aS extends cn{constructor(e){super(2,Br,e)}_doOperation(e){e._hasExecutionVariable(this,"cachedVector")||e._setExecutionVariable(this,"cachedVector",new ne);const t=e._getExecutionVariable(this,"cachedVector",null);return t.set(this.getDataInput("input_0").getValue(e),this.getDataInput("input_1").getValue(e)),t}getClassName(){return"FlowGraphCombineVector2Block"}}Y("FlowGraphCombineVector2Block",aS);class oS extends cn{constructor(e){super(3,zt,e)}_doOperation(e){e._hasExecutionVariable(this,"cachedVector")||e._setExecutionVariable(this,"cachedVector",new m);const t=e._getExecutionVariable(this,"cachedVector",null);return t.set(this.getDataInput("input_0").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_2").getValue(e)),t}getClassName(){return"FlowGraphCombineVector3Block"}}Y("FlowGraphCombineVector3Block",oS);class lS extends cn{constructor(e){super(4,uo,e)}_doOperation(e){e._hasExecutionVariable(this,"cachedVector")||e._setExecutionVariable(this,"cachedVector",new Fe);const t=e._getExecutionVariable(this,"cachedVector",null);return t.set(this.getDataInput("input_0").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_2").getValue(e),this.getDataInput("input_3").getValue(e)),t}getClassName(){return"FlowGraphCombineVector4Block"}}Y("FlowGraphCombineVector4Block",lS);class cS extends cn{constructor(e){super(16,ns,e)}_doOperation(e){var i;e._hasExecutionVariable(this,"cachedMatrix")||e._setExecutionVariable(this,"cachedMatrix",new P);const t=e._getExecutionVariable(this,"cachedMatrix",null);return(i=this.config)!=null&&i.inputIsColumnMajor?t.set(this.getDataInput("input_0").getValue(e),this.getDataInput("input_4").getValue(e),this.getDataInput("input_8").getValue(e),this.getDataInput("input_12").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_5").getValue(e),this.getDataInput("input_9").getValue(e),this.getDataInput("input_13").getValue(e),this.getDataInput("input_2").getValue(e),this.getDataInput("input_6").getValue(e),this.getDataInput("input_10").getValue(e),this.getDataInput("input_14").getValue(e),this.getDataInput("input_3").getValue(e),this.getDataInput("input_7").getValue(e),this.getDataInput("input_11").getValue(e),this.getDataInput("input_15").getValue(e)):t.set(this.getDataInput("input_0").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_2").getValue(e),this.getDataInput("input_3").getValue(e),this.getDataInput("input_4").getValue(e),this.getDataInput("input_5").getValue(e),this.getDataInput("input_6").getValue(e),this.getDataInput("input_7").getValue(e),this.getDataInput("input_8").getValue(e),this.getDataInput("input_9").getValue(e),this.getDataInput("input_10").getValue(e),this.getDataInput("input_11").getValue(e),this.getDataInput("input_12").getValue(e),this.getDataInput("input_13").getValue(e),this.getDataInput("input_14").getValue(e),this.getDataInput("input_15").getValue(e)),t}getClassName(){return"FlowGraphCombineMatrixBlock"}}Y("FlowGraphCombineMatrixBlock",cS);class hS extends cn{constructor(e){super(4,_o,e)}_doOperation(e){var r;e._hasExecutionVariable(this,"cachedMatrix")||e._setExecutionVariable(this,"cachedMatrix",new fi);const t=e._getExecutionVariable(this,"cachedMatrix",null),i=(r=this.config)!=null&&r.inputIsColumnMajor?[this.getDataInput("input_0").getValue(e),this.getDataInput("input_2").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_3").getValue(e)]:[this.getDataInput("input_0").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_2").getValue(e),this.getDataInput("input_3").getValue(e)];return t.fromArray(i),t}getClassName(){return"FlowGraphCombineMatrix2DBlock"}}Y("FlowGraphCombineMatrix2DBlock",hS);class fS extends cn{constructor(e){super(9,po,e)}_doOperation(e){var r;e._hasExecutionVariable(this,"cachedMatrix")||e._setExecutionVariable(this,"cachedMatrix",new ui);const t=e._getExecutionVariable(this,"cachedMatrix",null),i=(r=this.config)!=null&&r.inputIsColumnMajor?[this.getDataInput("input_0").getValue(e),this.getDataInput("input_3").getValue(e),this.getDataInput("input_6").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_4").getValue(e),this.getDataInput("input_7").getValue(e),this.getDataInput("input_2").getValue(e),this.getDataInput("input_5").getValue(e),this.getDataInput("input_8").getValue(e)]:[this.getDataInput("input_0").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_2").getValue(e),this.getDataInput("input_3").getValue(e),this.getDataInput("input_4").getValue(e),this.getDataInput("input_5").getValue(e),this.getDataInput("input_6").getValue(e),this.getDataInput("input_7").getValue(e),this.getDataInput("input_8").getValue(e)];return t.fromArray(i),t}getClassName(){return"FlowGraphCombineMatrix3DBlock"}}Y("FlowGraphCombineMatrix3DBlock",fS);class uS extends hn{constructor(e){super(2,Br,e)}_updateOutputs(e){var i;let t=(i=this.getDataInput("input"))==null?void 0:i.getValue(e);t||(t=ne.Zero(),this.getDataInput("input").setValue(t,e)),this.getDataOutput("output_0").setValue(t.x,e),this.getDataOutput("output_1").setValue(t.y,e)}getClassName(){return"FlowGraphExtractVector2Block"}}Y("FlowGraphExtractVector2Block",uS);class dS extends hn{constructor(e){super(3,zt,e)}_updateOutputs(e){var i;let t=(i=this.getDataInput("input"))==null?void 0:i.getValue(e);t||(t=m.Zero(),this.getDataInput("input").setValue(t,e)),this.getDataOutput("output_0").setValue(t.x,e),this.getDataOutput("output_1").setValue(t.y,e),this.getDataOutput("output_2").setValue(t.z,e)}getClassName(){return"FlowGraphExtractVector3Block"}}Y("FlowGraphExtractVector3Block",dS);class _S extends hn{constructor(e){super(4,uo,e)}_updateOutputs(e){var i;let t=(i=this.getDataInput("input"))==null?void 0:i.getValue(e);t||(t=Fe.Zero(),this.getDataInput("input").setValue(t,e)),this.getDataOutput("output_0").setValue(t.x,e),this.getDataOutput("output_1").setValue(t.y,e),this.getDataOutput("output_2").setValue(t.z,e),this.getDataOutput("output_3").setValue(t.w,e)}getClassName(){return"FlowGraphExtractVector4Block"}}Y("FlowGraphExtractVector4Block",_S);class pS extends hn{constructor(e){super(16,ns,e)}_updateOutputs(e){var i;let t=(i=this.getDataInput("input"))==null?void 0:i.getValue(e);t||(t=P.Identity(),this.getDataInput("input").setValue(t,e));for(let r=0;r<16;r++)this.getDataOutput(`output_${r}`).setValue(t.m[r],e)}getClassName(){return"FlowGraphExtractMatrixBlock"}}Y("FlowGraphExtractMatrixBlock",pS);class mS extends hn{constructor(e){super(4,_o,e)}_updateOutputs(e){var i;let t=(i=this.getDataInput("input"))==null?void 0:i.getValue(e);t||(t=new fi,this.getDataInput("input").setValue(t,e));for(let r=0;r<4;r++)this.getDataOutput(`output_${r}`).setValue(t.m[r],e)}getClassName(){return"FlowGraphExtractMatrix2DBlock"}}Y("FlowGraphExtractMatrix2DBlock",mS);class gS extends hn{constructor(e){super(9,po,e)}_updateOutputs(e){var i;let t=(i=this.getDataInput("input"))==null?void 0:i.getValue(e);t||(t=new ui,this.getDataInput("input").setValue(t,e));for(let r=0;r<9;r++)this.getDataOutput(`output_${r}`).setValue(t.m[r],e)}getClassName(){return"FlowGraphExtractMatrix3DBlock"}}Y("FlowGraphExtractMatrix3DBlock",gS);const zr=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphCombineMatrix2DBlock:hS,FlowGraphCombineMatrix3DBlock:fS,FlowGraphCombineMatrixBlock:cS,FlowGraphCombineVector2Block:aS,FlowGraphCombineVector3Block:oS,FlowGraphCombineVector4Block:lS,FlowGraphExtractMatrix2DBlock:mS,FlowGraphExtractMatrix3DBlock:gS,FlowGraphExtractMatrixBlock:pS,FlowGraphExtractVector2Block:uS,FlowGraphExtractVector3Block:dS,FlowGraphExtractVector4Block:_S},Symbol.toStringTag,{value:"Module"}));class ES extends Ze{constructor(e){super($t,Ie,t=>+t,"FlowGraphBooleanToFloat",e)}}Y("FlowGraphBooleanToFloat",ES);class vS extends Ze{constructor(e){super($t,Ut,t=>et.FromValue(+t),"FlowGraphBooleanToInt",e)}}Y("FlowGraphBooleanToInt",vS);class TS extends Ze{constructor(e){super(Ie,$t,t=>!!t,"FlowGraphFloatToBoolean",e)}}Y("FlowGraphFloatToBoolean",TS);class SS extends Ze{constructor(e){super(Ut,$t,t=>!!t.value,"FlowGraphIntToBoolean",e)}}Y("FlowGraphIntToBoolean",SS);class AS extends Ze{constructor(e){super(Ut,Ie,t=>t.value,"FlowGraphIntToFloat",e)}}Y("FlowGraphIntToFloat",AS);class RS extends Ze{constructor(e){super(Ie,Ut,t=>{switch(e==null?void 0:e.roundingMode){case"floor":return et.FromValue(Math.floor(t));case"ceil":return et.FromValue(Math.ceil(t));case"round":return et.FromValue(Math.round(t));default:return et.FromValue(t)}},"FlowGraphFloatToInt",e)}}Y("FlowGraphFloatToInt",RS);const Gs=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphBooleanToFloat:ES,FlowGraphBooleanToInt:vS,FlowGraphFloatToBoolean:TS,FlowGraphFloatToInt:RS,FlowGraphIntToBoolean:SS,FlowGraphIntToFloat:AS},Symbol.toStringTag,{value:"Module"}));var cc;(function(a){a[a.CircleEase=0]="CircleEase",a[a.BackEase=1]="BackEase",a[a.BounceEase=2]="BounceEase",a[a.CubicEase=3]="CubicEase",a[a.ElasticEase=4]="ElasticEase",a[a.ExponentialEase=5]="ExponentialEase",a[a.PowerEase=6]="PowerEase",a[a.QuadraticEase=7]="QuadraticEase",a[a.QuarticEase=8]="QuarticEase",a[a.QuinticEase=9]="QuinticEase",a[a.SineEase=10]="SineEase",a[a.BezierCurveEase=11]="BezierCurveEase"})(cc||(cc={}));function EL(a,...e){switch(a){case 11:return new Jm(...e);case 0:return new jm;case 1:return new Zm(...e);case 2:return new vC(...e);case 3:return new TC;case 4:return new SC(...e);case 5:return new Qm(...e);default:throw new Error("Easing type not yet implemented")}}class CS extends ti{constructor(e){super(e),this.config=e,this._easingFunctions={},this.type=this.registerDataInput("type",te,11),this.mode=this.registerDataInput("mode",Ie,0),this.parameters=this.registerDataInput("parameters",te,[1,0,0,1]),this.easingFunction=this.registerDataOutput("easingFunction",te)}_updateOutputs(e){const t=this.type.getValue(e),i=this.mode.getValue(e),r=this.parameters.getValue(e);if(t===void 0||i===void 0)return;const s=`${t}-${i}-${r.join("-")}`;if(!this._easingFunctions[s]){const n=EL(t,...r);n.setEasingMode(i),this._easingFunctions[s]=n}this.easingFunction.setValue(this._easingFunctions[s],e)}getClassName(){return"FlowGraphEasingBlock"}}Y("FlowGraphEasingBlock",CS);const vL=Object.freeze(Object.defineProperty({__proto__:null,get EasingFunctionType(){return cc},FlowGraphEasingBlock:CS},Symbol.toStringTag,{value:"Module"}));class IS extends ti{constructor(e){super(e),this.config=e,this._easingFunctions={},this.mode=this.registerDataInput("mode",Ie,0),this.controlPoint1=this.registerDataInput("controlPoint1",Br),this.controlPoint2=this.registerDataInput("controlPoint2",Br),this.easingFunction=this.registerDataOutput("easingFunction",te)}_updateOutputs(e){const t=this.mode.getValue(e),i=this.controlPoint1.getValue(e),r=this.controlPoint2.getValue(e);if(t===void 0)return;const s=`${t}-${i.x}-${i.y}-${r.x}-${r.y}`;if(!this._easingFunctions[s]){const n=new Jm(i.x,i.y,r.x,r.y);n.setEasingMode(t),this._easingFunctions[s]=n}this.easingFunction.setValue(this._easingFunctions[s],e)}getClassName(){return"FlowGraphBezierCurveEasing"}}Y("FlowGraphBezierCurveEasing",IS);const TL=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphBezierCurveEasingBlock:IS},Symbol.toStringTag,{value:"Module"}));class bS extends Ms{constructor(e){super(e),this.type="PointerOver",this.pointerId=this.registerDataOutput("pointerId",Ie),this.targetMesh=this.registerDataInput("targetMesh",te,e==null?void 0:e.targetMesh),this.meshUnderPointer=this.registerDataOutput("meshUnderPointer",te)}_executeEvent(e,t){var s;const i=this.targetMesh.getValue(e);this.meshUnderPointer.setValue(t.mesh,e);const r=t.out&&Cs(t.out,i);return this.pointerId.setValue(t.pointerId,e),!r&&(t.mesh===i||Cs(t.mesh,i))?(this._execute(e),!((s=this.config)!=null&&s.stopPropagation)):!0}_preparePendingTasks(e){}_cancelPendingTasks(e){}getClassName(){return"FlowGraphPointerOverEventBlock"}}Y("FlowGraphPointerOverEventBlock",bS);const SL=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphPointerOverEventBlock:bS},Symbol.toStringTag,{value:"Module"}));class xS extends Ms{constructor(e){super(e),this.type="PointerOut",this.pointerId=this.registerDataOutput("pointerId",Ie),this.targetMesh=this.registerDataInput("targetMesh",te,e==null?void 0:e.targetMesh),this.meshOutOfPointer=this.registerDataOutput("meshOutOfPointer",te)}_executeEvent(e,t){var s;const i=this.targetMesh.getValue(e);return this.meshOutOfPointer.setValue(t.mesh,e),this.pointerId.setValue(t.pointerId,e),!(t.over&&Cs(t.mesh,i))&&(t.mesh===i||Cs(t.mesh,i))?(this._execute(e),!((s=this.config)!=null&&s.stopPropagation)):!0}_preparePendingTasks(e){}_cancelPendingTasks(e){}getClassName(){return"FlowGraphPointerOutEventBlock"}}Y("FlowGraphPointerOutEventBlock",xS);const AL=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphPointerOutEventBlock:xS},Symbol.toStringTag,{value:"Module"}));class yS extends ti{constructor(e){super(e),this.userVariables=this.registerDataOutput("userVariables",te),this.executionId=this.registerDataOutput("executionId",Ie)}_updateOutputs(e){this.userVariables.setValue(e.userVariables,e),this.executionId.setValue(e.executionId,e)}serialize(e){super.serialize(e)}getClassName(){return"FlowGraphContextBlock"}}Y("FlowGraphContextBlock",yS);const RL=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphContextBlock:yS},Symbol.toStringTag,{value:"Module"}));class MS extends ti{constructor(e){super(e),this.config=e,this.array=this.registerDataInput("array",te),this.index=this.registerDataInput("index",te,new et(-1)),this.value=this.registerDataOutput("value",te)}_updateOutputs(e){const t=this.array.getValue(e),i=vi(this.index.getValue(e));t&&i>=0&&i<t.length?this.value.setValue(t[i],e):this.value.setValue(null,e)}serialize(e){super.serialize(e)}getClassName(){return"FlowGraphArrayIndexBlock"}}Y("FlowGraphArrayIndexBlock",MS);const CL=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphArrayIndexBlock:MS},Symbol.toStringTag,{value:"Module"}));class IL extends ti{constructor(e){super(e),this.config=e,this.executionFunction=this.registerDataInput("function",te),this.value=this.registerDataInput("value",te),this.result=this.registerDataOutput("result",te)}_updateOutputs(e){const t=this.executionFunction.getValue(e),i=this.value.getValue(e);t&&this.result.setValue(t(i,e),e)}getClassName(){return"FlowGraphCodeExecutionBlock"}}const bL=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphCodeExecutionBlock:IL},Symbol.toStringTag,{value:"Module"}));class PS extends ti{constructor(e){super(e),this.config=e,this.object=this.registerDataInput("object",te),this.array=this.registerDataInput("array",te),this.index=this.registerDataOutput("index",Ut,new et(-1))}_updateOutputs(e){const t=this.object.getValue(e),i=this.array.getValue(e);i&&this.index.setValue(new et(i.indexOf(t)),e)}serialize(e){super.serialize(e)}getClassName(){return"FlowGraphIndexOfBlock"}}Y("FlowGraphIndexOfBlock",PS);const xL=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphIndexOfBlock:PS},Symbol.toStringTag,{value:"Module"}));class OS extends ti{constructor(e){super(e),this.functionName=this.registerDataInput("functionName",nh),this.object=this.registerDataInput("object",te),this.context=this.registerDataInput("context",te,null),this.output=this.registerDataOutput("output",te)}_updateOutputs(e){const t=this.functionName.getValue(e),i=this.object.getValue(e),r=this.context.getValue(e);if(i&&t){const s=i[t];s&&typeof s=="function"&&this.output.setValue(s.bind(r),e)}}getClassName(){return"FlowGraphFunctionReference"}}Y("FlowGraphFunctionReference",OS);const yL=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphFunctionReferenceBlock:OS},Symbol.toStringTag,{value:"Module"}));class DS extends ti{constructor(e){super(e),this.config=e,this._inputCases=new Map,this.case=this.registerDataInput("case",te,NaN),this.default=this.registerDataInput("default",te),this.value=this.registerDataOutput("value",te),(this.config.cases||[]).forEach(t=>{t=vi(t),!(this.config.treatCasesAsIntegers&&(t=t|0,this._inputCases.has(t)))&&this._inputCases.set(t,this.registerDataInput(`in_${t}`,te))})}_updateOutputs(e){const t=this.case.getValue(e);let i;rn(t)?i=this._getOutputValueForCase(vi(t),e):i=this.default.getValue(e),this.value.setValue(i,e)}_getOutputValueForCase(e,t){var i;return(i=this._inputCases.get(e))==null?void 0:i.getValue(t)}getClassName(){return"FlowGraphDataSwitchBlock"}}Y("FlowGraphDataSwitchBlock",DS);const ML=Object.freeze(Object.defineProperty({__proto__:null,FlowGraphDataSwitchBlock:DS},Symbol.toStringTag,{value:"Module"}));export{Ss as $,OL as A,mt as B,Ne as C,DL as D,bs as E,sr as F,ri as G,an as H,be as I,LL as J,pc as K,B as L,P as M,Sa as N,U as O,rh as P,z as Q,WI as R,ts as S,k as T,PL as U,Fe as V,F as W,Mi as X,Yg as Y,yn as Z,X as _,mc as a,Kr as a0,ke as a1,zi as a2,rr as a3,jr as a4,NL as a5,Kg as a6,FL as a7,xs as a8,dr as a9,BL as aa,wL as ab,ti as ac,te as ad,he as ae,Ge as af,wr as ag,UL as ah,cr as ai,GL as aj,He as ak,dt as al,VL as am,Ur as b,m as c,ne as d,Z as e,lt as f,ei as g,pl as h,se as i,ae as j,q as k,D as l,W as m,Ar as n,Pi as o,Ce as p,N as q,ee as r,Js as s,Ei as t,x as u,we as v,db as w,ms as x,Ks as y,Cn as z};
