import{E as H,S as ae,a as S,C,V as l,M as L,b as x,B as Z,T as re,A as O,c as E,d as w,R as se,e as le,H as ce,D as de}from"./babylon-core-CPh0TrEW.js";function ue(){const t=document.getElementById("renderCanvas");if(!t)throw new Error("Render canvas not found.");const e={preserveDrawingBuffer:!0,stencil:!0};let i;try{i=new H(t,!0,{...e,disableWebGL2Support:!1})}catch{i=new H(t,!0,{...e,disableWebGL2Support:!0})}const n=new ae(i);return{canvas:t,engine:i,scene:n}}const me=new URL("../../Assets/Medieval Village MegaKit[Standard]/glTF/",import.meta.url).href,fe="https://cdn.jsdelivr.net/npm/babylonjs-loaders@7.54.3/babylonjs.loaders.min.js";let F=null;function pe(){return x.IsPluginForExtensionAvailable(".gltf")?Promise.resolve():(F||(F=new Promise((t,e)=>{globalThis.BABYLON=globalThis.BABYLON??Z;const i=document.createElement("script");i.src=fe,i.async=!0,i.onload=()=>t(),i.onerror=()=>e(new Error("Failed to load Babylon glTF loader script.")),document.head.appendChild(i)})),F)}function N(t,e,i,n,s,o=!0){const a=L.CreateBox(e,i,t);return a.position=n,a.material=s,a.isVisible=o,a.checkCollisions=!0,a}function K(t){const e=t.getChildMeshes(!1);if(e.length===0)return null;let i=e[0].getBoundingInfo().boundingBox.minimumWorld.clone(),n=e[0].getBoundingInfo().boundingBox.maximumWorld.clone();for(let a=1;a<e.length;a+=1){const r=e[a].getBoundingInfo().boundingBox;i=l.Minimize(i,r.minimumWorld),n=l.Maximize(n,r.maximumWorld)}const s=n.subtract(i),o=i.add(n).scale(.5);return{min:i,max:n,size:s,center:o}}function he(t,e,i,n=0){t.rotation.set(0,n,0),t.scaling.set(1,1,1),t.position.set(0,0,0),t.computeWorldMatrix(!0);let s=K(t);if(!s)return;const o=new l(Math.max(s.size.x,.001),Math.max(s.size.y,.001),Math.max(s.size.z,.001)),a=Math.min(e.x/o.x,e.y/o.y,e.z/o.z);if(t.scaling.setAll(a),t.computeWorldMatrix(!0),s=K(t),!s)return;const r=new l(s.center.x,s.min.y,s.center.z);t.position.copyFrom(i.subtract(r)),t.computeWorldMatrix(!0)}async function ge(t,e){const i=new URL(e,me).href,n=await x.LoadAssetContainerAsync("",i,t,void 0,".gltf");return n.removeAllFromScene(),n}function v(t,e,i,n,s=!1){const o=e.instantiateModelsToScene(r=>`${i}_${r}`,!1),a=new re(`${i}_root`,t);return o.rootNodes.forEach(r=>{r.parent||(r.parent=a)}),he(a,n.size,n.position,n.rotationY??0),s&&a.getChildMeshes(!1).forEach(r=>{r.checkCollisions=!0}),a}async function we(t){const e={wallWood:"Wall_Plaster_WoodGrid.gltf",wallBrick:"Wall_UnevenBrick_Straight.gltf",roofHouse:"Roof_RoundTiles_8x10.gltf",stairs:"Stairs_Exterior_Straight.gltf",fence:"Prop_WoodenFence_Single.gltf",crate:"Prop_Crate.gltf"},i=await Promise.all(Object.entries(e).map(async([a,r])=>[a,await ge(t,r)])),n=Object.fromEntries(i),s=new l(0,0,-8),o=new l(18,12,14);v(t,n.wallWood,"mainBuildingFront",{size:new l(o.x,7,1.6),position:new l(s.x,0,s.z-6.6),rotationY:0}),v(t,n.wallBrick,"mainBuildingBack",{size:new l(o.x,7,1.6),position:new l(s.x,0,s.z+6.6),rotationY:Math.PI}),v(t,n.wallWood,"mainBuildingLeft",{size:new l(o.z,7,1.6),position:new l(s.x-8.6,0,s.z),rotationY:-Math.PI/2}),v(t,n.wallBrick,"mainBuildingRight",{size:new l(o.z,7,1.6),position:new l(s.x+8.6,0,s.z),rotationY:Math.PI/2}),v(t,n.roofHouse,"mainBuildingRoof",{size:new l(20,6.2,16),position:new l(s.x,6,s.z),rotationY:0}),v(t,n.stairs,"mainBuildingStairs",{size:new l(6,3,4),position:new l(s.x,0,s.z+8.8),rotationY:Math.PI});for(let a=-5;a<=5;a+=1)v(t,n.fence,`roadFenceLeft_${a}`,{size:new l(3.2,1.6,.7),position:new l(-7.5,0,a*4),rotationY:Math.PI/2}),v(t,n.fence,`roadFenceRight_${a}`,{size:new l(3.2,1.6,.7),position:new l(7.5,0,a*4),rotationY:-Math.PI/2});v(t,n.crate,"roadCrateA",{size:new l(1.2,1.2,1.2),position:new l(-5.4,0,9.4),rotationY:.2}),v(t,n.crate,"roadCrateB",{size:new l(1.2,1.2,1.2),position:new l(5.1,0,10.5),rotationY:-.35})}function ye(t,e,i,n){const s=L.CreateGround("villageGround",{width:96,height:96},t);s.material=e,s.checkCollisions=!0;const o=L.CreateGround("mainRoad",{width:11.5,height:88},t);return o.position.y=.01,o.material=i,o.checkCollisions=!1,N(t,"mainBuildingCollider",{width:17.6,height:7.5,depth:13.4},new l(0,3.75,-8),n,!1),[{name:"boundWest",pos:new l(-48.5,3,0),size:new l(1,6,97)},{name:"boundEast",pos:new l(48.5,3,0),size:new l(1,6,97)},{name:"boundNorth",pos:new l(0,3,-48.5),size:new l(97,6,1)},{name:"boundSouth",pos:new l(0,3,48.5),size:new l(97,6,1)}].forEach(r=>{N(t,r.name,{width:r.size.x,height:r.size.y,depth:r.size.z},r.pos,n,!1)}),s}async function be(t){t.collisionsEnabled=!0,await pe();const e=new S("terrainMaterial",t);e.diffuseColor=new C(.25,.5,.24);const i=new S("roadMaterial",t);i.diffuseColor=new C(.4,.28,.17);const n=new S("hiddenCollisionMaterial",t);n.diffuseColor=new C(.35,.35,.35),n.alpha=0;const s=new S("markerMaterial",t);s.diffuseColor=new C(.84,.67,.33);const o=new l(-4.2,0,-16.5),a=new l(0,0,42),r=new l(4.8,0,9.8),d=ye(t,e,i,n);await we(t);const u=N(t,"shrineMarker",{width:1.2,depth:1.2,height:2.8},new l(o.x,1.4,o.z),s,!1);u.checkCollisions=!1,u.isPickable=!1;const c=L.CreateSphere("incenseFlame",{diameter:.22,segments:12},t);return c.material=s,c.isVisible=!1,c.checkCollisions=!1,{ground:d,shrinePosition:o,gatePosition:a,interactablePosition:r,interactableFlame:c}}const h={movement:{walkSpeed:5.8,sprintSpeed:8.8,acceleration:24,deceleration:16,airAcceleration:7,jumpSpeed:7.6,gravity:-19,fallGravityMultiplier:1.22,lowJumpGravityMultiplier:1.1,coyoteTime:.08,jumpBufferTime:.12,rotationLerp:11,playerHeight:1.8,spawnPosition:{x:0,y:1.1,z:20}},camera:{distance:2.1,minDistance:1.2,maxDistance:3.4,heightOffset:1.9,mouseSensitivity:.0011,pitchMin:-.7,pitchMax:.95,followLerp:12,lookAheadDistance:.9,lookAheadLerp:6,cameraRotationFollowLerp:5,cameraRotationMoveThreshold:.25,collisionRadius:.34,inertia:.62},effects:{dustMotes:{count:24,radius:20,minHeight:.7,maxHeight:3.4,driftSpeed:.18,bobAmplitude:.14,size:.055}},audio:{ambientVolume:.06,bellVolume:.2},world:{shrineTriggerRadius:2.4,gateTriggerRadius:2.8,interactRange:2.2,checkpointResetCooldown:.35}},_={idle:["idle","breath","stand"],run:["run","walk","jog"],jump:["jump","fall"]};function j(t,e){const i=e.map(n=>n.toLowerCase());return t.find(n=>{var o;const s=((o=n.name)==null?void 0:o.toLowerCase())??"";return i.some(a=>s.includes(a))})??null}function Ae(t){if(!t)return null;const e=t.clone("jumpProxyGroup");return e.speedRatio=.7,e.stop(),e}function $(t=[]){const e=j(t,_.idle),i=j(t,_.run),n=j(t,_.jump)??Ae(i),s={idle:e,run:i,jump:n},o={idle:0,run:0,jump:0};let a="idle",r=!1;Object.values(s).forEach(c=>{!c||!(c instanceof O)||(c.play(!0),c.setWeightForAllAnimatables(0),c.enableBlending=!0,c.blendingSpeed=.08,r=!0)}),r&&s.idle&&(o.idle=1,s.idle.setWeightForAllAnimatables(1));function d(c){r&&(a=c)}function u(c,y){if(!r)return;const f={idle:a==="idle"?1:0,run:a==="run"?1:0,jump:a==="jump"?1:0},g=E.Clamp(c*10,0,1);s.idle&&(o.idle=E.Lerp(o.idle,f.idle,g),s.idle.setWeightForAllAnimatables(o.idle)),s.run&&(o.run=E.Lerp(o.run,f.run,g),s.run.speedRatio=E.Lerp(.9,1.35,E.Clamp(y.normalizedSpeed,0,1)),s.run.setWeightForAllAnimatables(o.run)),s.jump&&(o.jump=E.Lerp(o.jump,f.jump,g),s.jump.setWeightForAllAnimatables(o.jump))}return{isReady:()=>r,setState:d,update:u}}const Me="https://cdn.jsdelivr.net/npm/babylonjs-loaders@7.54.3/babylonjs.loaders.min.js",Le=new URL(""+new URL("Meshy_AI_Monastic_Contemplatio_0223043241_texture-De5dN5g8.glb",import.meta.url).href,import.meta.url).href,Pe=new URL(""+new URL("Meshy_AI_Animation_Walking_withSkin-BPaoHyrO.glb",import.meta.url).href,import.meta.url).href,ve=new URL(""+new URL("Meshy_AI_Animation_Running_withSkin-BvKtgFaU.glb",import.meta.url).href,import.meta.url).href;let G=null,q=!1;function Ce(t){if(q)return;q=!0;const e=t instanceof Error?t.message:String(t??"unknown reason");console.warn(`Falling back to procedural monk character: ${e}`)}function Se(){return x.IsPluginForExtensionAvailable(".glb")?Promise.resolve():(G||(G=new Promise((t,e)=>{globalThis.BABYLON=globalThis.BABYLON??Z;const i=document.createElement("script");i.src=Me,i.async=!0,i.onload=()=>t(),i.onerror=()=>e(new Error("Failed to load Babylon UMD loaders script.")),document.head.appendChild(i)})),G)}function xe(t,e){const i=new S("monkSkinMaterial",e);i.diffuseColor=new C(.86,.73,.58);const n=new S("monkRobeMaterial",e);n.diffuseColor=new C(.71,.42,.2);const s=new S("monkSashMaterial",e);s.diffuseColor=new C(.6,.22,.18);const o=L.CreateBox("monkRoot",{size:.01},e);o.parent=t,o.position=new l(0,-.1,0),o.isVisible=!1;const a=L.CreateCylinder("monkRobe",{height:1.14,diameterTop:.42,diameterBottom:.76,tessellation:18},e);a.material=n,a.parent=o,a.position=new l(0,.32,0);const r=L.CreateSphere("monkHead",{diameter:.42,segments:20},e);r.material=i,r.parent=o,r.position=new l(0,1.05,0);const d=L.CreateTorus("monkSash",{diameter:.5,thickness:.08,tessellation:24},e);d.material=s,d.parent=o,d.position=new l(0,.45,0),d.rotation.x=Math.PI/2;const u=L.CreateCapsule("monkArmLeft",{radius:.08,height:.65,tessellation:12},e);u.material=n,u.parent=o,u.position=new l(-.28,.63,0),u.rotation.z=.22;const c=L.CreateCapsule("monkArmRight",{radius:.08,height:.65,tessellation:12},e);return c.material=n,c.parent=o,c.position=new l(.28,.63,0),c.rotation.z=-.22,{root:o,armLeft:u,armRight:c}}function ke(t,e){const i=new w("idle-bob","position.y",30,w.ANIMATIONTYPE_FLOAT,w.ANIMATIONLOOPMODE_CYCLE);i.setKeys([{frame:0,value:e.root.position.y},{frame:15,value:e.root.position.y+.03},{frame:30,value:e.root.position.y}]);const n=new w("run-bob","position.y",30,w.ANIMATIONTYPE_FLOAT,w.ANIMATIONLOOPMODE_CYCLE);n.setKeys([{frame:0,value:e.root.position.y-.04},{frame:8,value:e.root.position.y+.06},{frame:15,value:e.root.position.y-.04},{frame:22,value:e.root.position.y+.06},{frame:30,value:e.root.position.y-.04}]);const s=new w("run-arm-left","rotation.x",30,w.ANIMATIONTYPE_FLOAT,w.ANIMATIONLOOPMODE_CYCLE);s.setKeys([{frame:0,value:-.6},{frame:15,value:.6},{frame:30,value:-.6}]);const o=new w("run-arm-right","rotation.x",30,w.ANIMATIONTYPE_FLOAT,w.ANIMATIONLOOPMODE_CYCLE);o.setKeys([{frame:0,value:.6},{frame:15,value:-.6},{frame:30,value:.6}]);const a=new w("jump-lift","position.y",30,w.ANIMATIONTYPE_FLOAT,w.ANIMATIONLOOPMODE_CYCLE);a.setKeys([{frame:0,value:e.root.position.y},{frame:12,value:e.root.position.y+.24},{frame:22,value:e.root.position.y+.16},{frame:30,value:e.root.position.y}]);const r=new w("jump-arms","rotation.x",30,w.ANIMATIONTYPE_FLOAT,w.ANIMATIONLOOPMODE_CYCLE);r.setKeys([{frame:0,value:0},{frame:12,value:-.8},{frame:30,value:0}]);const d=new O("idle");d.addTargetedAnimation(i,e.root);const u=new O("run");u.addTargetedAnimation(n,e.root),u.addTargetedAnimation(s,e.armLeft),u.addTargetedAnimation(o,e.armRight);const c=new O("jump");return c.addTargetedAnimation(a,e.root),c.addTargetedAnimation(r,e.armLeft),c.addTargetedAnimation(r.clone(),e.armRight),[d,u,c]}function Ee(t){return t.targetedAnimations.every(e=>!!e.target)}function D(t,e){return t.animationGroups.filter(i=>!e.has(i.name))}function Te(t,e,i=.02){const n=e.getChildMeshes(!1);if(n.length===0)return;e.computeWorldMatrix(!0);let s=Number.POSITIVE_INFINITY;n.forEach(a=>{const r=a.getBoundingInfo().boundingBox.minimumWorld.y;r<s&&(s=r)});const o=t.position.y-.9+i;e.position.y+=o-s,e.computeWorldMatrix(!0)}async function Ie(t,e){if(await Se(),!x.IsPluginForExtensionAvailable(".glb"))throw new Error("GLTF loader script did not register a .glb plugin.");const i=new Set(e.animationGroups.map(o=>o.name));let n=null,s=null;try{n=await x.ImportMeshAsync("","",Le,e,void 0,".glb");const o=n.meshes.find(a=>!a.parent)??n.meshes[0];if(!o)throw new Error("Unable to find GLB model root mesh for monk character.");o.parent=t,o.position=new l(0,0,0),o.scaling=new l(.9,.9,.9),o.rotationQuaternion=null,Te(t,o),s=new Map,n.meshes.forEach(a=>s.set(a.name,a)),n.transformNodes.forEach(a=>s.set(a.name,a)),n.skeletons.forEach(a=>s.set(a.name,a))}catch(o){throw n&&(n.meshes.forEach(r=>{r&&!r.isDisposed()&&r.dispose(!1,!0)}),n.transformNodes.forEach(r=>{r&&!r.isDisposed()&&r.dispose(!1,!0)}),n.skeletons.forEach(r=>{r&&!r.isDisposed()&&r.dispose()})),D(e,i).forEach(r=>r.dispose()),o}try{const o=d=>d!=null&&d.name?s.get(d.name)??null:null;return await x.ImportAnimationsAsync("",Pe,e,!1,void 0,o,void 0,void 0,void 0,".glb"),await x.ImportAnimationsAsync("",ve,e,!1,void 0,o,void 0,void 0,void 0,".glb"),D(e,i).filter(Ee)}catch(o){return D(e,i).forEach(r=>r.dispose()),console.warn(`Monk GLB loaded but animation import failed. Using static model. ${o instanceof Error?o.message:String(o)}`),[]}}async function ze(t,e){try{const i=await Ie(t,e),n=$(i);return{setAnimationState:n.setState,update:(s,o)=>n.update(s,o),loadedFromGlb:!0}}catch(i){Ce(i);const n=xe(t,e),s=ke(e,n),o=$(s);return{setAnimationState:o.setState,update:(a,r)=>o.update(a,r),loadedFromGlb:!1}}}function Re(t){const e=L.CreateCapsule("playerCapsule",{radius:.45,height:1.8,tessellation:12},t);e.isVisible=!1,e.ellipsoid=new l(.45,.9,.45),e.ellipsoidOffset=new l(0,.9,0),e.checkCollisions=!0;const i=h.movement.spawnPosition;return e.position=new l(i.x,i.y,i.z),e}async function Oe(t,e){return ze(t,e)}const T=new l,R=new l,P=new l,J=new l,Q=new l,Be=new l(0,-1,0),X=new l(0,0,1);function Fe(t,e,i){const n=Re(t),s={setAnimationState:()=>{},update:()=>{},loadedFromGlb:!1};Oe(n,t).then(m=>{s.setAnimationState=m.setAnimationState,s.update=m.update,s.loadedFromGlb=m.loadedFromGlb});const o=new l(0,0,0),a=h.movement.playerHeight/2,r=.03,d=.14,u=new se(Q,Be,a+.3);let c=!1,y=0,f=0,g=0;function A(){Q.set(n.position.x,n.position.y+.05,n.position.z),u.length=a+.35;const m=t.pickWithRay(u,z=>z!==n&&z.checkCollisions===!0);if(!(m!=null&&m.hit)||!m.pickedPoint){c=!1;return}const b=n.position.y-a,M=m.pickedPoint.y;c=b-M<=d,c&&o.y<=0&&(o.y=0,n.position.y=M+a+r)}function p(m){y+=m;const b=t.activeCamera;if(!b)return;T.copyFrom(b.getForwardRay().direction),T.y=0,T.normalize(),l.CrossToRef(l.UpReadOnly,T,R),R.normalize(),P.setAll(0),i.keys.forward&&P.addInPlace(T),i.keys.back&&P.subtractInPlace(T),i.keys.left&&P.subtractInPlace(R),i.keys.right&&P.addInPlace(R);const M=P.lengthSquared()>0;M&&P.normalize();const k=i.keys.sprint?h.movement.sprintSpeed:h.movement.walkSpeed,z=M?P.x*k:0,ee=M?P.z*k:0;let Y=M?h.movement.acceleration:h.movement.deceleration;!c&&M&&(Y=h.movement.airAcceleration);const W=Math.min(1,Y*m);o.x+=(z-o.x)*W,o.z+=(ee-o.z)*W,A(),c?f=h.movement.coyoteTime:f=Math.max(0,f-m),i.consumeJumpPress()?g=h.movement.jumpBufferTime:g=Math.max(0,g-m),g>0&&(c||f>0)&&(o.y=h.movement.jumpSpeed,c=!1,f=0,g=0);let B=1;o.y<0?B=h.movement.fallGravityMultiplier:o.y>0&&!i.keys.jump&&(B=h.movement.lowJumpGravityMultiplier),o.y+=h.movement.gravity*B*m,J.set(o.x*m,o.y*m,o.z*m),n.moveWithCollisions(J),A();const V=Math.hypot(o.x,o.z),te=V/h.movement.sprintSpeed,ne=c?V>.35?"run":"idle":"jump";if(s.setAnimationState(ne),s.update(m,{elapsedTime:y,normalizedSpeed:te,isGrounded:c}),M){const U=Math.atan2(P.x,P.z),oe=Math.min(1,h.movement.rotationLerp*m),ie=Math.atan2(Math.sin(U-n.rotation.y),Math.cos(U-n.rotation.y));n.rotation.y+=ie*oe,X.set(Math.sin(n.rotation.y),0,Math.cos(n.rotation.y))}}return{mesh:n,update:p,getPosition:()=>n.position,setPosition:m=>{n.position.copyFrom(m),o.set(0,0,0),c=!1},isGrounded:()=>c,getFacingDirection:()=>X,getHorizontalSpeed:()=>Math.hypot(o.x,o.z),usesGlbCharacter:()=>s.loadedFromGlb}}function _e(t){const e={forward:!1,back:!1,left:!1,right:!1,sprint:!1,jump:!1};let i=!1;const n=new Map([["KeyW","forward"],["KeyS","back"],["KeyA","left"],["KeyD","right"],["ShiftLeft","sprint"],["ShiftRight","sprint"]]);function s(){e.forward=!1,e.back=!1,e.left=!1,e.right=!1,e.sprint=!1,e.jump=!1,i=!1}function o(d){n.has(d.code)&&(e[n.get(d.code)]=!0),d.code==="Space"&&(d.repeat||(i=!0),e.jump=!0,d.preventDefault())}function a(d){n.has(d.code)&&(e[n.get(d.code)]=!1),d.code==="Space"&&(e.jump=!1,d.preventDefault())}function r(){s()}return window.addEventListener("keydown",o),window.addEventListener("keyup",a),window.addEventListener("blur",r),t.setAttribute("tabindex","0"),{keys:e,consumeJumpPress(){const d=i;return i=!1,d},dispose(){window.removeEventListener("keydown",o),window.removeEventListener("keyup",a),window.removeEventListener("blur",r),s()}}}function je(t,e,i){const n=h.camera,s=new l,o=new l,a=new le("playerCamera",Math.PI*1.4,1.1,n.distance,i.getPosition(),t);a.attachControl(e,!0),a.lowerBetaLimit=n.pitchMin+Math.PI/2,a.upperBetaLimit=n.pitchMax+Math.PI/2,a.lowerRadiusLimit=n.minDistance,a.upperRadiusLimit=n.maxDistance,a.wheelDeltaPercentage=.01,a.angularSensibilityX=1/n.mouseSensitivity,a.angularSensibilityY=1/n.mouseSensitivity,a.inertia=n.inertia,a.checkCollisions=!0,a.collisionRadius=new l(n.collisionRadius,n.collisionRadius,n.collisionRadius),t.activeCamera=a;function r(){var u;document.pointerLockElement!==e&&((u=e.requestPointerLock)==null||u.call(e))}function d(u){const c=i.getPosition(),y=i.getFacingDirection();o.set(y.x*n.lookAheadDistance,0,y.z*n.lookAheadDistance);const f=Math.min(1,n.lookAheadLerp*u);if(s.x+=(c.x+o.x-s.x)*f,s.z+=(c.z+o.z-s.z)*f,s.y=c.y+n.heightOffset,i.getHorizontalSpeed()>n.cameraRotationMoveThreshold){const A=c?i.mesh.rotation.y+Math.PI:a.alpha,p=Math.atan2(Math.sin(A-a.alpha),Math.cos(A-a.alpha)),m=Math.min(1,n.cameraRotationFollowLerp*u);a.alpha+=p*m}const g=Math.min(1,n.followLerp*u);a.target=l.Lerp(a.target,s,g)}return{camera:a,activatePointerLock:r,update:d}}function Ge(){const t=document.getElementById("startScreen"),e=document.getElementById("playButton"),i=document.getElementById("hud"),n=document.getElementById("objectiveText"),s=document.getElementById("storyBox"),o=document.getElementById("interactPrompt");let a=!1,r=!1;function d(p){a||(a=!0,setTimeout(()=>{t.classList.remove("visible"),i.classList.remove("hidden"),p==null||p()},120))}function u(p){e.addEventListener("click",()=>d(p))}function c(p){s.textContent=p,s.classList.remove("hidden")}function y(p){n.textContent=`Objective: ${p}`}function f(p){o.textContent=p,o.classList.remove("hidden")}function g(){o.classList.add("hidden")}function A(p){p.code==="KeyE"&&!p.repeat&&(r=!0)}return window.addEventListener("keydown",A),{bindStart:u,showStory:c,setObjective:y,showInteractPrompt:f,hideInteractPrompt:g,consumeInteractPressed(){const p=r;return r=!1,p},isPlaying:()=>a,dispose(){window.removeEventListener("keydown",A)}}}function De(t,e,i){let n=!1,s=!1,o=e.getPosition().clone(),a=0,r=!1,d=()=>{};function u(f){d=f}function c(f){a>0&&(a=Math.max(0,a-f));const g=e.getPosition();n||l.Distance(g,t.shrinePosition)<=h.world.shrineTriggerRadius&&(n=!0,o=t.shrinePosition.clone(),o.y=g.y,i.showStory("A distant bell rings. Something calls you beyond the monastery."),i.setObjective("Find the sealed gate"),d()),!s&&t.gatePosition&&l.Distance(g,t.gatePosition)<=h.world.gateTriggerRadius&&(s=!0,o=t.gatePosition.clone(),o.y=g.y,i.showStory("Beyond the gate, mountain winds carry distant chanting. The world is waiting."),i.setObjective("Offer incense (E) and continue your journey")),r&&a<=0&&(r=!1,a=h.world.checkpointResetCooldown,e.setPosition(o),i.showStory("You center your breath and return to your last point of calm."),i.showInteractPrompt("Checkpoint restored"),window.setTimeout(()=>{i.hideInteractPrompt()},900))}function y(f){f.code==="KeyR"&&!f.repeat&&(r=!0)}return window.addEventListener("keydown",y),{update:c,setOnShrineTriggered:u,isShrineTriggered:()=>n,isGateTriggered:()=>s,dispose(){window.removeEventListener("keydown",y)}}}function I(t,e){return t+Math.random()*(e-t)}function Ne(t){const e=h.effects.dustMotes,i=[],n=new S("dustMoteMaterial",t);n.diffuseColor=new C(.95,.89,.75),n.emissiveColor=new C(.12,.1,.06),n.alpha=.5,n.disableLighting=!0;for(let o=0;o<e.count;o+=1){const a=L.CreateSphere(`dustMote${o}`,{diameter:e.size,segments:6},t),r=new l(I(-20,e.radius),I(e.minHeight,e.maxHeight),I(-20,e.radius));a.position.copyFrom(r),a.material=n,a.isPickable=!1,a.checkCollisions=!1,i.push({mesh:a,basePos:r,phase:Math.random()*Math.PI*2,driftDir:new l(I(-1,1),0,I(-1,1)).normalize()})}function s(o){const a=performance.now()*.001;for(const r of i)r.mesh.position.x+=r.driftDir.x*e.driftSpeed*o,r.mesh.position.z+=r.driftDir.z*e.driftSpeed*o,r.mesh.position.y=r.basePos.y+Math.sin(a+r.phase)*e.bobAmplitude,Math.abs(r.mesh.position.x)>e.radius&&(r.mesh.position.x=-r.mesh.position.x*.9),Math.abs(r.mesh.position.z)>e.radius&&(r.mesh.position.z=-r.mesh.position.z*.9)}return{update:s}}function Ye(){let t,e,i,n=!1;function s(){t||(t=new window.AudioContext),t.state==="suspended"&&t.resume()}function o(){if(n)return;s(),e=t.createOscillator(),i=t.createGain();const r=t.createBiquadFilter();e.type="triangle",e.frequency.value=110,r.type="lowpass",r.frequency.value=320,r.Q.value=.4,i.gain.value=h.audio.ambientVolume,e.connect(r),r.connect(i),i.connect(t.destination),e.start(),n=!0}function a(){if(!n)return;const r=t.currentTime,d=t.createGain(),u=t.createOscillator(),c=t.createOscillator();u.type="sine",c.type="sine",u.frequency.setValueAtTime(784,r),c.frequency.setValueAtTime(1176,r),d.gain.setValueAtTime(h.audio.bellVolume,r),d.gain.exponentialRampToValueAtTime(.001,r+2.1),u.connect(d),c.connect(d),d.connect(t.destination),u.start(r),c.start(r+.01),u.stop(r+2.2),c.stop(r+2.2)}return{start:o,playShrineBell:a}}const We=new l(0,1,0);function Ve(t,e,i){let n=!1;function s(){if(!t.interactablePosition||n)return;const o=e.getPosition();if(l.Distance(o,t.interactablePosition)>h.world.interactRange){i.hideInteractPrompt();return}i.showInteractPrompt("Press E to light incense"),i.consumeInteractPressed()&&(n=!0,i.hideInteractPrompt(),i.showStory("You light the incense bowl. Smoke curls upward, and the silence deepens."),t.interactableFlame&&(t.interactableFlame.isVisible=!0,t.interactableFlame.position.copyFrom(t.interactablePosition).addInPlace(We)))}return{update:s,isCompleted:()=>n}}function Ue(){const t=document.createElement("div");return t.style.position="fixed",t.style.right="12px",t.style.top="10px",t.style.padding="4px 8px",t.style.fontSize="12px",t.style.background="rgba(0,0,0,0.4)",t.style.border="1px solid rgba(255,255,255,0.15)",t.style.borderRadius="4px",t.style.color="#d8dde9",t.style.pointerEvents="none",t.textContent="FPS: --",document.body.appendChild(t),{update(e){t.textContent=`FPS: ${Math.round(e)}`}}}async function Ke(){const{canvas:t,engine:e,scene:i}=ue();i.clearColor.set(.56,.62,.72,1);const n=new ce("hemiLight",new l(0,1,0),i);n.intensity=.68,n.groundColor=new C(.26,.22,.16);const s=new de("sunLight",new l(-.4,-1,.35),i);s.intensity=1.6,s.position=new l(15,30,-10);const o=await be(i),a=_e(t),r=Fe(i,o,a),d=je(i,t,r),u=Ge(),c=De(o,r,u),y=Ne(i),f=Ye(),g=Ve(o,r,u),A=Ue();u.bindStart(()=>{t.focus(),d.activatePointerLock(),f.start()}),c.setOnShrineTriggered(()=>{f.playShrineBell()}),i.onBeforeRenderObservable.add(()=>{if(!u.isPlaying())return;const b=i.getEngine().getDeltaTime()/1e3;r.update(b),d.update(b),y.update(b),c.update(b),g.update(b),A.update(i.getEngine().getFps())}),e.runRenderLoop(()=>{i.render()}),window.addEventListener("resize",()=>{e.resize()});let p=!1;const m=()=>{var b,M,k;p||(p=!0,(b=a.dispose)==null||b.call(a),(M=c.dispose)==null||M.call(c),(k=u.dispose)==null||k.call(u))};i.onDisposeObservable.add(m),window.addEventListener("beforeunload",m,{once:!0})}export{Ke as createGame};
