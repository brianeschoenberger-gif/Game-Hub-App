import{ae as H,af as le,ag as B,i as T,j as k,c as l,ah as P,v as ce,ai as C,aj as O,m,B as ue,ak as de,al as me,H as fe,n as pe}from"./babylon-core-DMb_Dqn1.js";import"./vendor-BYH7yu4g.js";function he(){const t=document.getElementById("renderCanvas");if(!t)throw new Error("Render canvas not found.");const e={preserveDrawingBuffer:!0,stencil:!0};let o;try{o=new H(t,!0,{...e,disableWebGL2Support:!1})}catch{o=new H(t,!0,{...e,disableWebGL2Support:!0})}const n=new le(o);return{canvas:t,engine:o,scene:n}}function we(){const t=new URL(".",import.meta.url);return new URL("../../Assets/Medieval%20Village%20MegaKit%5BStandard%5D/glTF/",t).href}const ge=we();function Y(t,e,o,n,a,i=!0){const r=P.CreateBox(e,o,t);return r.position=n,r.material=a,r.isVisible=i,r.checkCollisions=!0,r}function U(t){const e=t.getChildMeshes(!1);if(e.length===0)return null;let o=e[0].getBoundingInfo().boundingBox.minimumWorld.clone(),n=e[0].getBoundingInfo().boundingBox.maximumWorld.clone();for(let r=1;r<e.length;r+=1){const s=e[r].getBoundingInfo().boundingBox;o=l.Minimize(o,s.minimumWorld),n=l.Maximize(n,s.maximumWorld)}const a=n.subtract(o),i=o.add(n).scale(.5);return{min:o,max:n,size:a,center:i}}function ye(t,e,o,n=0){t.rotation.set(0,n,0),t.scaling.set(1,1,1),t.position.set(0,0,0),t.computeWorldMatrix(!0);let a=U(t);if(!a)return;const i=new l(Math.max(a.size.x,.001),Math.max(a.size.y,.001),Math.max(a.size.z,.001)),r=Math.min(e.x/i.x,e.y/i.y,e.z/i.z);if(t.scaling.setAll(r),t.computeWorldMatrix(!0),a=U(t),!a)return;const s=new l(a.center.x,a.min.y,a.center.z);t.position.copyFrom(o.subtract(s)),t.computeWorldMatrix(!0)}async function Ae(t,e){const o=await B.LoadAssetContainerAsync(ge,e,t,void 0,".gltf");return o.removeAllFromScene(),o}function b(t,e,o,n,a=!1){const i=e.instantiateModelsToScene(s=>`${o}_${s}`,!1),r=new ce(`${o}_root`,t);return i.rootNodes.forEach(s=>{s.parent||(s.parent=r)}),ye(r,n.size,n.position,n.rotationY??0),a&&r.getChildMeshes(!1).forEach(s=>{s.checkCollisions=!0}),r}async function be(t){const e={corner:"Corner_ExteriorWide_Brick.gltf",wallBrick:"Wall_UnevenBrick_Straight.gltf",wallPlain:"Wall_Plaster_Straight.gltf",floor:"Floor_WoodDark.gltf",roofHouse:"Roof_RoundTiles_8x14.gltf",roofFront:"Roof_Front_Brick8.gltf",stairs:"Stairs_Exterior_Straight.gltf",fence:"Prop_WoodenFence_Single.gltf",crate:"Prop_Crate.gltf"},o=await Promise.all(Object.entries(e).map(async([c,p])=>[c,await Ae(t,p)])),n=Object.fromEntries(o),a=new l(0,0,-10),i=7.2,r=6.2,s=3.9;b(t,n.floor,"mainBuildingFloorLower",{size:new l(14.8,.6,12.8),position:new l(a.x,.05,a.z),rotationY:0}),b(t,n.floor,"mainBuildingFloorUpper",{size:new l(14.8,.6,12.8),position:new l(a.x,4,a.z),rotationY:0}),[0,s].forEach((c,p)=>{const f=p===0?"Lower":"Upper";b(t,n.wallPlain,`mainBuildingFront${f}`,{size:new l(14.6,4,1.3),position:new l(a.x,c,a.z+r),rotationY:Math.PI}),b(t,n.wallBrick,`mainBuildingBack${f}`,{size:new l(14.6,4,1.3),position:new l(a.x,c,a.z-r),rotationY:0}),b(t,n.wallBrick,`mainBuildingLeft${f}`,{size:new l(12.8,4,1.3),position:new l(a.x-i,c,a.z),rotationY:-Math.PI/2}),b(t,n.wallBrick,`mainBuildingRight${f}`,{size:new l(12.8,4,1.3),position:new l(a.x+i,c,a.z),rotationY:Math.PI/2})}),[new l(-i,0,-r),new l(i,0,-r),new l(-i,0,r),new l(i,0,r),new l(-i,s,-r),new l(i,s,-r),new l(-i,s,r),new l(i,s,r)].forEach((c,p)=>{b(t,n.corner,`mainBuildingCorner_${p}`,{size:new l(1.5,4,1.5),position:a.add(c),rotationY:p%4*(Math.PI/2)})}),b(t,n.roofHouse,"mainBuildingRoofMain",{size:new l(18.6,7.5,16),position:new l(a.x,7.2,a.z),rotationY:0}),b(t,n.roofFront,"mainBuildingRoofFront",{size:new l(8.2,2.8,1.2),position:new l(a.x,6.3,a.z+r+.45),rotationY:Math.PI}),b(t,n.stairs,"mainBuildingStairs",{size:new l(6.2,3.2,4.6),position:new l(a.x,0,a.z+r+4.4),rotationY:Math.PI});for(let c=-5;c<=5;c+=1)b(t,n.fence,`roadFenceLeft_${c}`,{size:new l(3.2,1.6,.7),position:new l(-7.5,0,c*4),rotationY:Math.PI/2}),b(t,n.fence,`roadFenceRight_${c}`,{size:new l(3.2,1.6,.7),position:new l(7.5,0,c*4),rotationY:-Math.PI/2});b(t,n.crate,"roadCrateA",{size:new l(1.2,1.2,1.2),position:new l(-5.4,0,9.4),rotationY:.2}),b(t,n.crate,"roadCrateB",{size:new l(1.2,1.2,1.2),position:new l(5.1,0,10.5),rotationY:-.35})}function Me(t,e,o,n){const a=P.CreateGround("villageGround",{width:96,height:96},t);a.material=e,a.checkCollisions=!0;const i=P.CreateGround("mainRoad",{width:11.5,height:88},t);return i.position.y=.01,i.material=o,i.checkCollisions=!1,Y(t,"mainBuildingCollider",{width:18.8,height:10.6,depth:14.8},new l(0,5.3,-10),n,!1),[{name:"boundWest",pos:new l(-48.5,3,0),size:new l(1,6,97)},{name:"boundEast",pos:new l(48.5,3,0),size:new l(1,6,97)},{name:"boundNorth",pos:new l(0,3,-48.5),size:new l(97,6,1)},{name:"boundSouth",pos:new l(0,3,48.5),size:new l(97,6,1)}].forEach(s=>{Y(t,s.name,{width:s.size.x,height:s.size.y,depth:s.size.z},s.pos,n,!1)}),a}async function ve(t){if(t.collisionsEnabled=!0,!B.IsPluginForExtensionAvailable(".gltf"))throw new Error("GLTF loader plugin is not available.");const e=new T("terrainMaterial",t);e.diffuseColor=new k(.25,.5,.24);const o=new T("roadMaterial",t);o.diffuseColor=new k(.4,.28,.17);const n=new T("hiddenCollisionMaterial",t);n.diffuseColor=new k(.35,.35,.35),n.alpha=0;const a=new T("markerMaterial",t);a.diffuseColor=new k(.84,.67,.33);const i=new l(-4.2,0,-16.5),r=new l(0,0,42),s=new l(4.8,0,9.8),u=Me(t,e,o,n);await be(t);const d=Y(t,"shrineMarker",{width:1.2,depth:1.2,height:2.8},new l(i.x,1.4,i.z),a,!1);d.checkCollisions=!1,d.isPickable=!1;const c=P.CreateSphere("incenseFlame",{diameter:.22,segments:12},t);return c.material=a,c.isVisible=!1,c.checkCollisions=!1,{ground:u,shrinePosition:i,gatePosition:r,interactablePosition:s,interactableFlame:c}}const A={movement:{walkSpeed:5.8,sprintSpeed:8.8,acceleration:24,deceleration:16,airAcceleration:7,jumpSpeed:7.6,gravity:-19,fallGravityMultiplier:1.22,lowJumpGravityMultiplier:1.1,coyoteTime:.08,jumpBufferTime:.12,rotationLerp:11,playerHeight:1.8,spawnPosition:{x:0,y:1.1,z:20}},camera:{distance:2.1,minDistance:1.2,maxDistance:3.4,heightOffset:1.9,mouseSensitivity:.0011,pitchMin:-.7,pitchMax:.95,followLerp:12,lookAheadDistance:.9,lookAheadLerp:6,cameraRotationFollowLerp:5,cameraRotationMoveThreshold:.25,collisionRadius:.34,inertia:.62},effects:{dustMotes:{count:24,radius:20,minHeight:.7,maxHeight:3.4,driftSpeed:.18,bobAmplitude:.14,size:.055}},audio:{ambientVolume:.06,bellVolume:.2},world:{shrineTriggerRadius:2.4,gateTriggerRadius:2.8,interactRange:2.2,checkpointResetCooldown:.35}},z={idle:["idle","breath","stand"],walk:["walk","stride"],run:["run","sprint","jog"],jump:["jump","fall"]};function N(t,e){const o=e.map(n=>n.toLowerCase());return t.find(n=>{var i;const a=((i=n.name)==null?void 0:i.toLowerCase())??"";return o.some(r=>a.includes(r))})??null}function Pe(t){if(!t)return null;const e=t.clone("jumpProxyGroup");return e.speedRatio=.7,e.stop(),e}function $(t=[]){const e=N(t,z.idle),o=N(t,z.walk),n=N(t,z.run),a=N(t,z.jump)??Pe(n??o),i={idle:e,walk:o,run:n,jump:a},r={idle:0,walk:0,run:0,jump:0};let s="idle",u=!1;Object.values(i).forEach(p=>{!p||!(p instanceof C)||(p.play(!0),p.setWeightForAllAnimatables(0),p.enableBlending=!0,p.blendingSpeed=.08,u=!0)}),u&&i.idle&&(r.idle=1,i.idle.setWeightForAllAnimatables(1));function d(p){u&&(s=p)}function c(p,f){if(!u)return;const h={idle:s==="idle"?1:0,walk:s==="walk"?1:0,run:s==="run"?1:0,jump:s==="jump"?1:0},g=O.Clamp(p*10,0,1);i.idle&&(r.idle=O.Lerp(r.idle,h.idle,g),i.idle.setWeightForAllAnimatables(r.idle)),i.walk&&(r.walk=O.Lerp(r.walk,h.walk,g),i.walk.speedRatio=O.Lerp(.8,1.1,O.Clamp(f.normalizedSpeed,0,.75)/.75),i.walk.setWeightForAllAnimatables(r.walk)),i.run&&(r.run=O.Lerp(r.run,h.run,g),i.run.speedRatio=O.Lerp(.9,1.35,O.Clamp(f.normalizedSpeed,0,1)),i.run.setWeightForAllAnimatables(r.run)),i.jump&&(r.jump=O.Lerp(r.jump,h.jump,g),i.jump.setWeightForAllAnimatables(r.jump))}return{isReady:()=>u,setState:d,update:c}}const Le=new URL(""+new URL("Meshy_AI_Animation_Walking_withSkin-BPaoHyrO.glb",import.meta.url).href,import.meta.url).href,ke=Le,Ce=new URL(""+new URL("Meshy_AI_Animation_Running_withSkin-BvKtgFaU.glb",import.meta.url).href,import.meta.url).href;let q=!1;function Oe(t){if(q)return;q=!0;const e=t instanceof Error?t.message:String(t??"unknown reason");console.warn(`Falling back to procedural monk character: ${e}`)}function Te(t,e){const o=new T("monkSkinMaterial",e);o.diffuseColor=new k(.86,.73,.58);const n=new T("monkRobeMaterial",e);n.diffuseColor=new k(.71,.42,.2);const a=new T("monkSashMaterial",e);a.diffuseColor=new k(.6,.22,.18);const i=P.CreateBox("monkRoot",{size:.01},e);i.parent=t,i.position=new l(0,-.1,0),i.isVisible=!1;const r=P.CreateCylinder("monkRobe",{height:1.14,diameterTop:.42,diameterBottom:.76,tessellation:18},e);r.material=n,r.parent=i,r.position=new l(0,.32,0);const s=P.CreateSphere("monkHead",{diameter:.42,segments:20},e);s.material=o,s.parent=i,s.position=new l(0,1.05,0);const u=P.CreateTorus("monkSash",{diameter:.5,thickness:.08,tessellation:24},e);u.material=a,u.parent=i,u.position=new l(0,.45,0),u.rotation.x=Math.PI/2;const d=P.CreateCapsule("monkArmLeft",{radius:.08,height:.65,tessellation:12},e);d.material=n,d.parent=i,d.position=new l(-.28,.63,0),d.rotation.z=.22;const c=P.CreateCapsule("monkArmRight",{radius:.08,height:.65,tessellation:12},e);return c.material=n,c.parent=i,c.position=new l(.28,.63,0),c.rotation.z=-.22,{root:i,armLeft:d,armRight:c}}function Ie(t,e){const o=new m("idle-bob","position.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);o.setKeys([{frame:0,value:e.root.position.y},{frame:15,value:e.root.position.y+.03},{frame:30,value:e.root.position.y}]);const n=new m("run-bob","position.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);n.setKeys([{frame:0,value:e.root.position.y-.04},{frame:8,value:e.root.position.y+.06},{frame:15,value:e.root.position.y-.04},{frame:22,value:e.root.position.y+.06},{frame:30,value:e.root.position.y-.04}]);const a=new m("run-arm-left","rotation.x",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);a.setKeys([{frame:0,value:-.6},{frame:15,value:.6},{frame:30,value:-.6}]);const i=new m("run-arm-right","rotation.x",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);i.setKeys([{frame:0,value:.6},{frame:15,value:-.6},{frame:30,value:.6}]);const r=new m("walk-bob","position.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);r.setKeys([{frame:0,value:e.root.position.y-.02},{frame:8,value:e.root.position.y+.03},{frame:15,value:e.root.position.y-.02},{frame:22,value:e.root.position.y+.03},{frame:30,value:e.root.position.y-.02}]);const s=new m("walk-arm-left","rotation.x",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);s.setKeys([{frame:0,value:-.35},{frame:15,value:.35},{frame:30,value:-.35}]);const u=new m("walk-arm-right","rotation.x",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);u.setKeys([{frame:0,value:.35},{frame:15,value:-.35},{frame:30,value:.35}]);const d=new m("jump-lift","position.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);d.setKeys([{frame:0,value:e.root.position.y},{frame:12,value:e.root.position.y+.24},{frame:22,value:e.root.position.y+.16},{frame:30,value:e.root.position.y}]);const c=new m("jump-arms","rotation.x",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);c.setKeys([{frame:0,value:0},{frame:12,value:-.8},{frame:30,value:0}]);const p=new C("idle");p.addTargetedAnimation(o,e.root);const f=new C("run");f.addTargetedAnimation(n,e.root),f.addTargetedAnimation(a,e.armLeft),f.addTargetedAnimation(i,e.armRight);const h=new C("walk");h.addTargetedAnimation(r,e.root),h.addTargetedAnimation(s,e.armLeft),h.addTargetedAnimation(u,e.armRight);const g=new C("jump");return g.addTargetedAnimation(d,e.root),g.addTargetedAnimation(c,e.armLeft),g.addTargetedAnimation(c.clone(),e.armRight),[p,h,f,g]}function J(t,e){const o=e.position.y,n=new m("idle-bob-proxy","position.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);n.setKeys([{frame:0,value:o},{frame:15,value:o+.025},{frame:30,value:o}]);const a=new m("jump-lift-proxy","position.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);a.setKeys([{frame:0,value:o},{frame:12,value:o+.16},{frame:22,value:o+.08},{frame:30,value:o}]);const i=new C("idle");i.addTargetedAnimation(n,e);const r=new C("jump");return r.addTargetedAnimation(a,e),[i,r]}function Q(t,e){const o=e.position.y,n=new m("run-bob-proxy","position.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);n.setKeys([{frame:0,value:o-.03},{frame:8,value:o+.045},{frame:15,value:o-.03},{frame:22,value:o+.045},{frame:30,value:o-.03}]);const a=new m("run-sway-proxy","rotation.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);a.setKeys([{frame:0,value:-.03},{frame:15,value:.03},{frame:30,value:-.03}]);const i=new C("run");return i.addTargetedAnimation(n,e),i.addTargetedAnimation(a,e),i}function X(t,e){const o=e.position.y,n=new m("walk-bob-proxy","position.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);n.setKeys([{frame:0,value:o-.02},{frame:8,value:o+.03},{frame:15,value:o-.02},{frame:22,value:o+.03},{frame:30,value:o-.02}]);const a=new m("walk-sway-proxy","rotation.y",30,m.ANIMATIONTYPE_FLOAT,m.ANIMATIONLOOPMODE_CYCLE);a.setKeys([{frame:0,value:-.02},{frame:15,value:.02},{frame:30,value:-.02}]);const i=new C("walk");return i.addTargetedAnimation(n,e),i.addTargetedAnimation(a,e),i}function D(t,e){return t.animationGroups.filter(o=>!e.has(o.name))}function xe(t,e,o=.02){const n=e.getChildMeshes(!1);if(n.length===0)return;e.computeWorldMatrix(!0);let a=Number.POSITIVE_INFINITY;n.forEach(r=>{const s=r.getBoundingInfo().boundingBox.minimumWorld.y;s<a&&(a=s)});const i=t.position.y-.9+o;e.position.y+=i-a,e.computeWorldMatrix(!0)}function j(t){var e,o,n;t&&((e=t.meshes)==null||e.forEach(a=>{a&&!a.isDisposed()&&a.dispose(!1,!0)}),(o=t.transformNodes)==null||o.forEach(a=>{a&&!a.isDisposed()&&a.dispose(!1,!0)}),(n=t.skeletons)==null||n.forEach(a=>{a&&!a.isDisposed()&&a.dispose()}))}function Ee(t){const e=new Map;return t.meshes.forEach(o=>e.set(o.name,o)),t.transformNodes.forEach(o=>e.set(o.name,o)),t.skeletons.forEach(o=>e.set(o.name,o)),e}function ne(t,e){const o=e.toLowerCase();return t.find(n=>{var a;return(a=n.name)==null?void 0:a.toLowerCase().includes(o)})??t.find(n=>n.targetedAnimations.length>0)??null}function Se(t,e,o,n,a){const i=new C(o,t),r=new Map(((a==null?void 0:a.bones)??[]).map(s=>[s.name,s]));return e.targetedAnimations.forEach(s=>{var c;const u=s.target;let d=null;u instanceof ue||((c=u==null?void 0:u.getClassName)==null?void 0:c.call(u))==="Bone"?d=r.get(u.name)??null:u!=null&&u.name&&(d=n.get(u.name)??null),d&&i.addTargetedAnimation(s.animation.clone(`${o}_${s.animation.name||"anim"}`),d)}),i.targetedAnimations.length===0?(i.dispose(),null):i}async function ze(t,e,o,n,a){const i=new Set(t.animationGroups.map(s=>s.name));let r=null;try{r=await B.ImportMeshAsync("","",e,t,void 0,".glb");const s=D(t,i),u=ne(s,o),d=u?Se(t,u,o,n,a):null;return s.forEach(c=>c.dispose()),j(r),d}catch(s){return D(t,i).forEach(d=>d.dispose()),j(r),console.warn(`Failed to import/retarget ${o} clip. ${s instanceof Error?s.message:String(s)}`),null}}async function Ne(t,e){let o=null,n=null;try{const a=new Set(e.animationGroups.map(g=>g.name));o=await B.ImportMeshAsync("","",ke,e,void 0,".glb");const i=D(e,a);if(n=o.meshes.find(g=>!g.parent)??o.meshes[0],!n)throw new Error("Unable to find GLB model root mesh for monk character.");n.parent=t,n.position=new l(0,0,0),n.scaling=new l(.9,.9,.9),n.rotationQuaternion=null,xe(t,n);const r=Ee(o),s=o.skeletons[0]??null;if(!s)throw new Error("Monk character does not include a usable skeleton.");const u=ne(i,"walk");u&&(u.name="walk");const d=await ze(e,Ce,"run",r,s),[c,p]=J(e,n),f=u??X(e,n),h=d??Q(e,n);return f.name="walk",h.name="run",[c,f,h,p]}catch(a){if(n&&!n.isDisposed()){const[i,r]=J(e,n),s=X(e,n),u=Q(e,n);return[i,s,u,r]}throw j(o),a}}async function Fe(t,e){try{const o=await Ne(t,e),n=$(o);return{setAnimationState:n.setState,update:(a,i)=>n.update(a,i),loadedFromGlb:!0}}catch(o){Oe(o);const n=Te(t,e),a=Ie(e,n),i=$(a);return{setAnimationState:i.setState,update:(r,s)=>i.update(r,s),loadedFromGlb:!1}}}function Be(t){const e=P.CreateCapsule("playerCapsule",{radius:.45,height:1.8,tessellation:12},t);e.isVisible=!1,e.ellipsoid=new l(.45,.9,.45),e.ellipsoidOffset=new l(0,.9,0),e.checkCollisions=!0;const o=A.movement.spawnPosition;return e.position=new l(o.x,o.y,o.z),e}async function Re(t,e){return Fe(t,e)}const x=new l,F=new l,L=new l,Z=new l,ee=new l,_e=new l(0,-1,0),te=new l(0,0,1);function Ye(t,e,o){const n=Be(t),a={setAnimationState:()=>{},update:()=>{},loadedFromGlb:!1};Re(n,t).then(w=>{a.setAnimationState=w.setAnimationState,a.update=w.update,a.loadedFromGlb=w.loadedFromGlb});const i=new l(0,0,0),r=A.movement.playerHeight/2,s=.03,u=.14,d=new de(ee,_e,r+.3);let c=!1,p=0,f=0,h=0;function g(){ee.set(n.position.x,n.position.y+.05,n.position.z),d.length=r+.35;const w=t.pickWithRay(d,S=>S!==n&&S.checkCollisions===!0);if(!(w!=null&&w.hit)||!w.pickedPoint){c=!1;return}const M=n.position.y-r,v=w.pickedPoint.y;c=M-v<=u,c&&i.y<=0&&(i.y=0,n.position.y=v+r+s)}function y(w){p+=w;const M=t.activeCamera;if(!M)return;x.copyFrom(M.getForwardRay().direction),x.y=0,x.normalize(),l.CrossToRef(l.UpReadOnly,x,F),F.normalize(),L.setAll(0),o.keys.forward&&L.addInPlace(x),o.keys.back&&L.subtractInPlace(x),o.keys.left&&L.subtractInPlace(F),o.keys.right&&L.addInPlace(F);const v=L.lengthSquared()>0;v&&L.normalize();const I=o.keys.sprint?A.movement.sprintSpeed:A.movement.walkSpeed,S=v?L.x*I:0,oe=v?L.z*I:0;let G=v?A.movement.acceleration:A.movement.deceleration;!c&&v&&(G=A.movement.airAcceleration);const W=Math.min(1,G*w);i.x+=(S-i.x)*W,i.z+=(oe-i.z)*W,g(),c?f=A.movement.coyoteTime:f=Math.max(0,f-w),o.consumeJumpPress()?h=A.movement.jumpBufferTime:h=Math.max(0,h-w),h>0&&(c||f>0)&&(i.y=A.movement.jumpSpeed,c=!1,f=0,h=0);let R=1;i.y<0?R=A.movement.fallGravityMultiplier:i.y>0&&!o.keys.jump&&(R=A.movement.lowJumpGravityMultiplier),i.y+=A.movement.gravity*R*w,Z.set(i.x*w,i.y*w,i.z*w),n.moveWithCollisions(Z),g();const K=Math.hypot(i.x,i.z),ie=K/A.movement.sprintSpeed,ae=.35;let _="idle";if(c?K>ae&&(_=o.keys.sprint?"run":"walk"):_="jump",a.setAnimationState(_),a.update(w,{elapsedTime:p,normalizedSpeed:ie,isGrounded:c}),v){const V=Math.atan2(L.x,L.z),re=Math.min(1,A.movement.rotationLerp*w),se=Math.atan2(Math.sin(V-n.rotation.y),Math.cos(V-n.rotation.y));n.rotation.y+=se*re,te.set(Math.sin(n.rotation.y),0,Math.cos(n.rotation.y))}}return{mesh:n,update:y,getPosition:()=>n.position,setPosition:w=>{n.position.copyFrom(w),i.set(0,0,0),c=!1},isGrounded:()=>c,getFacingDirection:()=>te,getHorizontalSpeed:()=>Math.hypot(i.x,i.z),usesGlbCharacter:()=>a.loadedFromGlb}}function De(t){const e={forward:!1,back:!1,left:!1,right:!1,sprint:!1,jump:!1};let o=!1;const n=new Map([["KeyW","forward"],["KeyS","back"],["KeyA","left"],["KeyD","right"],["ShiftLeft","sprint"],["ShiftRight","sprint"]]);function a(){e.forward=!1,e.back=!1,e.left=!1,e.right=!1,e.sprint=!1,e.jump=!1,o=!1}function i(u){n.has(u.code)&&(e[n.get(u.code)]=!0),u.code==="Space"&&(u.repeat||(o=!0),e.jump=!0,u.preventDefault())}function r(u){n.has(u.code)&&(e[n.get(u.code)]=!1),u.code==="Space"&&(e.jump=!1,u.preventDefault())}function s(){a()}return window.addEventListener("keydown",i),window.addEventListener("keyup",r),window.addEventListener("blur",s),t.setAttribute("tabindex","0"),{keys:e,consumeJumpPress(){const u=o;return o=!1,u},dispose(){window.removeEventListener("keydown",i),window.removeEventListener("keyup",r),window.removeEventListener("blur",s),a()}}}function je(t,e,o){const n=A.camera,a=new l,i=new l,r=new me("playerCamera",Math.PI*1.4,1.1,n.distance,o.getPosition(),t);r.attachControl(e,!0),r.lowerBetaLimit=n.pitchMin+Math.PI/2,r.upperBetaLimit=n.pitchMax+Math.PI/2,r.lowerRadiusLimit=n.minDistance,r.upperRadiusLimit=n.maxDistance,r.wheelDeltaPercentage=.01,r.angularSensibilityX=1/n.mouseSensitivity,r.angularSensibilityY=1/n.mouseSensitivity,r.inertia=n.inertia,r.checkCollisions=!0,r.collisionRadius=new l(n.collisionRadius,n.collisionRadius,n.collisionRadius),t.activeCamera=r;function s(){var d;document.pointerLockElement!==e&&((d=e.requestPointerLock)==null||d.call(e))}function u(d){const c=o.getPosition(),p=o.getFacingDirection();i.set(p.x*n.lookAheadDistance,0,p.z*n.lookAheadDistance);const f=Math.min(1,n.lookAheadLerp*d);if(a.x+=(c.x+i.x-a.x)*f,a.z+=(c.z+i.z-a.z)*f,a.y=c.y+n.heightOffset,o.getHorizontalSpeed()>n.cameraRotationMoveThreshold){const g=c?o.mesh.rotation.y+Math.PI:r.alpha,y=Math.atan2(Math.sin(g-r.alpha),Math.cos(g-r.alpha)),w=Math.min(1,n.cameraRotationFollowLerp*d);r.alpha+=y*w}const h=Math.min(1,n.followLerp*d);r.target=l.Lerp(r.target,a,h)}return{camera:r,activatePointerLock:s,update:u}}function Ge(){const t=document.getElementById("startScreen"),e=document.getElementById("playButton"),o=document.getElementById("hud"),n=document.getElementById("objectiveText"),a=document.getElementById("storyBox"),i=document.getElementById("interactPrompt");let r=!1,s=!1;function u(y){r||(r=!0,setTimeout(()=>{t.classList.remove("visible"),o.classList.remove("hidden"),y==null||y()},120))}function d(y){e.addEventListener("click",()=>u(y))}function c(y){a.textContent=y,a.classList.remove("hidden")}function p(y){n.textContent=`Objective: ${y}`}function f(y){i.textContent=y,i.classList.remove("hidden")}function h(){i.classList.add("hidden")}function g(y){y.code==="KeyE"&&!y.repeat&&(s=!0)}return window.addEventListener("keydown",g),{bindStart:d,showStory:c,setObjective:p,showInteractPrompt:f,hideInteractPrompt:h,consumeInteractPressed(){const y=s;return s=!1,y},isPlaying:()=>r,dispose(){window.removeEventListener("keydown",g)}}}function We(t,e,o){let n=!1,a=!1,i=e.getPosition().clone(),r=0,s=!1,u=()=>{};function d(f){u=f}function c(f){r>0&&(r=Math.max(0,r-f));const h=e.getPosition();n||l.Distance(h,t.shrinePosition)<=A.world.shrineTriggerRadius&&(n=!0,i=t.shrinePosition.clone(),i.y=h.y,o.showStory("A distant bell rings. Something calls you beyond the monastery."),o.setObjective("Find the sealed gate"),u()),!a&&t.gatePosition&&l.Distance(h,t.gatePosition)<=A.world.gateTriggerRadius&&(a=!0,i=t.gatePosition.clone(),i.y=h.y,o.showStory("Beyond the gate, mountain winds carry distant chanting. The world is waiting."),o.setObjective("Offer incense (E) and continue your journey")),s&&r<=0&&(s=!1,r=A.world.checkpointResetCooldown,e.setPosition(i),o.showStory("You center your breath and return to your last point of calm."),o.showInteractPrompt("Checkpoint restored"),window.setTimeout(()=>{o.hideInteractPrompt()},900))}function p(f){f.code==="KeyR"&&!f.repeat&&(s=!0)}return window.addEventListener("keydown",p),{update:c,setOnShrineTriggered:d,isShrineTriggered:()=>n,isGateTriggered:()=>a,dispose(){window.removeEventListener("keydown",p)}}}function E(t,e){return t+Math.random()*(e-t)}function Ke(t){const e=A.effects.dustMotes,o=[],n=new T("dustMoteMaterial",t);n.diffuseColor=new k(.95,.89,.75),n.emissiveColor=new k(.12,.1,.06),n.alpha=.5,n.disableLighting=!0;for(let i=0;i<e.count;i+=1){const r=P.CreateSphere(`dustMote${i}`,{diameter:e.size,segments:6},t),s=new l(E(-20,e.radius),E(e.minHeight,e.maxHeight),E(-20,e.radius));r.position.copyFrom(s),r.material=n,r.isPickable=!1,r.checkCollisions=!1,o.push({mesh:r,basePos:s,phase:Math.random()*Math.PI*2,driftDir:new l(E(-1,1),0,E(-1,1)).normalize()})}function a(i){const r=performance.now()*.001;for(const s of o)s.mesh.position.x+=s.driftDir.x*e.driftSpeed*i,s.mesh.position.z+=s.driftDir.z*e.driftSpeed*i,s.mesh.position.y=s.basePos.y+Math.sin(r+s.phase)*e.bobAmplitude,Math.abs(s.mesh.position.x)>e.radius&&(s.mesh.position.x=-s.mesh.position.x*.9),Math.abs(s.mesh.position.z)>e.radius&&(s.mesh.position.z=-s.mesh.position.z*.9)}return{update:a}}function Ve(){let t,e,o,n=!1;function a(){t||(t=new window.AudioContext),t.state==="suspended"&&t.resume()}function i(){if(n)return;a(),e=t.createOscillator(),o=t.createGain();const s=t.createBiquadFilter();e.type="triangle",e.frequency.value=110,s.type="lowpass",s.frequency.value=320,s.Q.value=.4,o.gain.value=A.audio.ambientVolume,e.connect(s),s.connect(o),o.connect(t.destination),e.start(),n=!0}function r(){if(!n)return;const s=t.currentTime,u=t.createGain(),d=t.createOscillator(),c=t.createOscillator();d.type="sine",c.type="sine",d.frequency.setValueAtTime(784,s),c.frequency.setValueAtTime(1176,s),u.gain.setValueAtTime(A.audio.bellVolume,s),u.gain.exponentialRampToValueAtTime(.001,s+2.1),d.connect(u),c.connect(u),u.connect(t.destination),d.start(s),c.start(s+.01),d.stop(s+2.2),c.stop(s+2.2)}return{start:i,playShrineBell:r}}const He=new l(0,1,0);function Ue(t,e,o){let n=!1;function a(){if(!t.interactablePosition||n)return;const i=e.getPosition();if(l.Distance(i,t.interactablePosition)>A.world.interactRange){o.hideInteractPrompt();return}o.showInteractPrompt("Press E to light incense"),o.consumeInteractPressed()&&(n=!0,o.hideInteractPrompt(),o.showStory("You light the incense bowl. Smoke curls upward, and the silence deepens."),t.interactableFlame&&(t.interactableFlame.isVisible=!0,t.interactableFlame.position.copyFrom(t.interactablePosition).addInPlace(He)))}return{update:a,isCompleted:()=>n}}function $e(){const t=document.createElement("div");return t.style.position="fixed",t.style.right="12px",t.style.top="10px",t.style.padding="4px 8px",t.style.fontSize="12px",t.style.background="rgba(0,0,0,0.4)",t.style.border="1px solid rgba(255,255,255,0.15)",t.style.borderRadius="4px",t.style.color="#d8dde9",t.style.pointerEvents="none",t.textContent="FPS: --",document.body.appendChild(t),{update(e){t.textContent=`FPS: ${Math.round(e)}`}}}async function Qe(){const{canvas:t,engine:e,scene:o}=he();o.clearColor.set(.56,.62,.72,1);const n=new fe("hemiLight",new l(0,1,0),o);n.intensity=.68,n.groundColor=new k(.26,.22,.16);const a=new pe("sunLight",new l(-.4,-1,.35),o);a.intensity=1.6,a.position=new l(15,30,-10);const i=await ve(o),r=De(t),s=Ye(o,i,r),u=je(o,t,s),d=Ge(),c=We(i,s,d),p=Ke(o),f=Ve(),h=Ue(i,s,d),g=$e();d.bindStart(()=>{t.focus(),u.activatePointerLock(),f.start()}),c.setOnShrineTriggered(()=>{f.playShrineBell()}),o.onBeforeRenderObservable.add(()=>{if(!d.isPlaying())return;const M=o.getEngine().getDeltaTime()/1e3;s.update(M),u.update(M),p.update(M),c.update(M),h.update(M),g.update(o.getEngine().getFps())}),e.runRenderLoop(()=>{o.render()}),window.addEventListener("resize",()=>{e.resize()});let y=!1;const w=()=>{var M,v,I;y||(y=!0,(M=r.dispose)==null||M.call(r),(v=c.dispose)==null||v.call(c),(I=d.dispose)==null||I.call(d))};o.onDisposeObservable.add(w),window.addEventListener("beforeunload",w,{once:!0})}export{Qe as createGame};
