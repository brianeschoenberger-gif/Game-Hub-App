import{E as j,S as O,a as C,C as b,M as k,V as s,R as F,A as I,H as G,D as T}from"./babylon-core-CPYENeWg.js";function A(){const e=document.getElementById("renderCanvas"),t=new j(e,!0,{preserveDrawingBuffer:!0,stencil:!0,disableWebGL2Support:!1}),n=new O(t);return{canvas:e,engine:t,scene:n}}function w(e,t,n,o,r){const i=k.CreateBox(t,n,e);return i.position=o,i.material=r,i.checkCollisions=!0,i}function K(e){e.collisionsEnabled=!0;const t=new C("stoneMaterial",e);t.diffuseColor=new b(.57,.55,.52);const n=new C("woodMaterial",e);n.diffuseColor=new b(.46,.34,.23);const o=new C("clothMaterial",e);o.diffuseColor=new b(.69,.61,.48);const r=k.CreateGround("ground",{width:42,height:42},e);r.material=t,r.checkCollisions=!0,w(e,"cellFloor",{width:8,depth:6,height:.5},new s(-10,.25,0),t),w(e,"hallFloor",{width:12,depth:5,height:.5},new s(-3.5,.25,0),t),w(e,"courtyardFloor",{width:20,depth:14,height:.5},new s(7,.25,0),t),w(e,"shrineFloor",{width:6,depth:6,height:.5},new s(14,.25,0),t),[{name:"cellWallWest",size:{width:.6,height:3,depth:6},pos:new s(-14,1.5,0)},{name:"cellWallNorth",size:{width:8.6,height:3,depth:.6},pos:new s(-10,1.5,-3.3)},{name:"cellWallSouth",size:{width:8.6,height:3,depth:.6},pos:new s(-10,1.5,3.3)},{name:"hallWallNorth",size:{width:12.2,height:3,depth:.6},pos:new s(-3.5,1.5,-2.8)},{name:"hallWallSouth",size:{width:12.2,height:3,depth:.6},pos:new s(-3.5,1.5,2.8)},{name:"courtyardWallNorth",size:{width:20.4,height:3,depth:.6},pos:new s(7,1.5,-7.2)},{name:"courtyardWallSouth",size:{width:20.4,height:3,depth:.6},pos:new s(7,1.5,7.2)},{name:"courtyardWallEast",size:{width:.6,height:3,depth:14.4},pos:new s(17.2,1.5,0)}].forEach(d=>{w(e,d.name,d.size,d.pos,t)}),w(e,"cellBed",{width:2.5,depth:1.2,height:.5},new s(-12,.7,1.2),n),w(e,"clothRoll",{width:1.7,depth:.7,height:.25},new s(-12,1.08,1.2),o),w(e,"altarBase",{width:2.2,depth:1.4,height:1.1},new s(14,.8,0),n);const l=w(e,"shrineMarker",{width:.9,depth:.9,height:2.1},new s(14,1.8,0),o);return l.isPickable=!1,{ground:r,shrinePosition:l.position.clone()}}const m={movement:{walkSpeed:6,sprintSpeed:9.5,acceleration:28,deceleration:20,jumpSpeed:7.2,gravity:-18,rotationLerp:10,playerHeight:1.8},camera:{distance:6,minDistance:2.2,maxDistance:7.5,heightOffset:2.2,mouseSensitivity:.0026,pitchMin:-.7,pitchMax:.95,followLerp:14},world:{shrineTriggerRadius:2.4}};function H(e){const t=k.CreateCapsule("playerCapsule",{radius:.45,height:1.8,tessellation:12},e),n=new C("playerMaterial",e);return n.diffuseColor=new b(.89,.79,.61),t.material=n,t.ellipsoid=new s(.45,.9,.45),t.ellipsoidOffset=new s(0,.9,0),t.checkCollisions=!0,t.position=new s(-11.5,1.1,0),t}const S=new s,L=new s,f=new s,E=new s,z=new s,Y=new s(0,-1,0);function V(e,t,n){const o=H(e),r=new s(0,0,0),i=m.movement.playerHeight/2,l=.03,d=.14,a=new F(z,Y,i+.3);let c=!1;function g(){z.set(o.position.x,o.position.y+.05,o.position.z),a.length=i+.35;const h=e.pickWithRay(a,v=>v!==o&&v.checkCollisions===!0);if(!(h!=null&&h.hit)||!h.pickedPoint){c=!1;return}const y=o.position.y-i,u=h.pickedPoint.y;c=y-u<=d,c&&r.y<=0&&(r.y=0,o.position.y=u+i+l)}function p(h){const y=e.activeCamera;if(!y)return;S.copyFrom(y.getForwardRay().direction),S.y=0,S.normalize(),s.CrossToRef(s.UpReadOnly,S,L),L.normalize(),f.setAll(0),n.keys.forward&&f.addInPlace(S),n.keys.back&&f.subtractInPlace(S),n.keys.left&&f.subtractInPlace(L),n.keys.right&&f.addInPlace(L);const u=f.lengthSquared()>0;u&&f.normalize();const P=n.keys.sprint?m.movement.sprintSpeed:m.movement.walkSpeed,v=u?f.x*P:0,R=u?f.z*P:0,D=u?m.movement.acceleration:m.movement.deceleration,x=Math.min(1,D*h);if(r.x+=(v-r.x)*x,r.z+=(R-r.z)*x,g(),c&&n.consumeJumpPress()&&(r.y=m.movement.jumpSpeed,c=!1),r.y+=m.movement.gravity*h,E.set(r.x*h,r.y*h,r.z*h),o.moveWithCollisions(E),g(),u){const M=Math.atan2(f.x,f.z),B=Math.min(1,m.movement.rotationLerp*h),W=Math.atan2(Math.sin(M-o.rotation.y),Math.cos(M-o.rotation.y));o.rotation.y+=W*B}}return{mesh:o,update:p,getPosition:()=>o.position,isGrounded:()=>c}}function J(e){const t={forward:!1,back:!1,left:!1,right:!1,sprint:!1,jump:!1};let n=!1;const o=new Map([["KeyW","forward"],["KeyS","back"],["KeyA","left"],["KeyD","right"],["ShiftLeft","sprint"],["ShiftRight","sprint"]]);function r(){t.forward=!1,t.back=!1,t.left=!1,t.right=!1,t.sprint=!1,t.jump=!1,n=!1}function i(a){o.has(a.code)&&(t[o.get(a.code)]=!0),a.code==="Space"&&(a.repeat||(n=!0),t.jump=!0,a.preventDefault())}function l(a){o.has(a.code)&&(t[o.get(a.code)]=!1),a.code==="Space"&&(t.jump=!1,a.preventDefault())}function d(){r()}return window.addEventListener("keydown",i),window.addEventListener("keyup",l),window.addEventListener("blur",d),e.setAttribute("tabindex","0"),{keys:t,consumeJumpPress(){const a=n;return n=!1,a},dispose(){window.removeEventListener("keydown",i),window.removeEventListener("keyup",l),window.removeEventListener("blur",d),r()}}}function N(e,t,n){const o=m.camera,r=new s,i=new I("playerCamera",Math.PI*1.4,1.1,o.distance,n.getPosition(),e);i.attachControl(t,!0),i.lowerBetaLimit=o.pitchMin+Math.PI/2,i.upperBetaLimit=o.pitchMax+Math.PI/2,i.lowerRadiusLimit=o.minDistance,i.upperRadiusLimit=o.maxDistance,i.wheelDeltaPercentage=.01,i.angularSensibilityX=1/o.mouseSensitivity,i.angularSensibilityY=1/o.mouseSensitivity,i.checkCollisions=!0,i.collisionRadius=new s(.4,.4,.4),e.activeCamera=i;function l(){var a;document.pointerLockElement!==t&&((a=t.requestPointerLock)==null||a.call(t))}function d(a){const c=n.getPosition();r.set(c.x,c.y+o.heightOffset,c.z);const g=Math.min(1,o.followLerp*a);i.target=s.Lerp(i.target,r,g)}return{camera:i,activatePointerLock:l,update:d}}function U(){const e=document.getElementById("startScreen"),t=document.getElementById("playButton"),n=document.getElementById("hud"),o=document.getElementById("objectiveText"),r=document.getElementById("storyBox"),i=document.getElementById("fadeLayer");let l=!1;function d(p){l||(l=!0,i.classList.add("active"),setTimeout(()=>{e.classList.remove("visible"),n.classList.remove("hidden"),i.classList.remove("active"),p==null||p()},450))}function a(p){t.addEventListener("click",()=>d(p))}function c(p){r.textContent=p,r.classList.remove("hidden")}function g(p){o.textContent=`Objective: ${p}`}return{bindStart:a,showStory:c,setObjective:g,isPlaying:()=>l}}function q(e,t,n){let o=!1;function r(){if(o)return;const i=t.getPosition();s.Distance(i,e.shrinePosition)<=m.world.shrineTriggerRadius&&(o=!0,n.showStory("A distant bell rings. Something calls you beyond the monastery."),n.setObjective("Prototype complete"))}return{update:r,isShrineTriggered:()=>o}}function X(){const e=document.createElement("div");return e.style.position="fixed",e.style.right="12px",e.style.top="10px",e.style.padding="4px 8px",e.style.fontSize="12px",e.style.background="rgba(0,0,0,0.4)",e.style.border="1px solid rgba(255,255,255,0.15)",e.style.borderRadius="4px",e.style.color="#d8dde9",e.style.pointerEvents="none",e.textContent="FPS: --",document.body.appendChild(e),{update(t){e.textContent=`FPS: ${Math.round(t)}`}}}function Z(){const{canvas:e,engine:t,scene:n}=A();n.clearColor.set(.56,.62,.72,1);const o=new G("hemiLight",new s(0,1,0),n);o.intensity=.68,o.groundColor=new b(.26,.22,.16);const r=new T("sunLight",new s(-.4,-1,.35),n);r.intensity=1.6,r.position=new s(15,30,-10);const i=K(n),l=J(e),d=V(n,i,l),a=N(n,e,d),c=U(),g=q(i,d,c),p=X();c.bindStart(()=>{e.focus(),a.activatePointerLock()}),n.onBeforeRenderObservable.add(()=>{if(!c.isPlaying())return;const u=n.getEngine().getDeltaTime()/1e3;d.update(u),a.update(u),g.update(),p.update(n.getEngine().getFps())}),t.runRenderLoop(()=>{n.render()}),window.addEventListener("resize",()=>{t.resize()});let h=!1;const y=()=>{var u;h||(h=!0,(u=l.dispose)==null||u.call(l))};n.onDisposeObservable.add(y),window.addEventListener("beforeunload",y,{once:!0})}export{Z as createGame};
