import{E,S as O,a as C,C as b,M as L,V as r,R as F,A as G,H as I,D as T}from"./babylon-core-CPYENeWg.js";function A(){const e=document.getElementById("renderCanvas");if(!e)throw new Error("Render canvas not found.");const t={preserveDrawingBuffer:!0,stencil:!0};let n;try{n=new E(e,!0,{...t,disableWebGL2Support:!1})}catch{n=new E(e,!0,{...t,disableWebGL2Support:!0})}const o=new O(n);return{canvas:e,engine:n,scene:o}}function m(e,t,n,o,s){const i=L.CreateBox(t,n,e);return i.position=o,i.material=s,i.checkCollisions=!0,i}function K(e){e.collisionsEnabled=!0;const t=new C("stoneMaterial",e);t.diffuseColor=new b(.57,.55,.52);const n=new C("woodMaterial",e);n.diffuseColor=new b(.46,.34,.23);const o=new C("clothMaterial",e);o.diffuseColor=new b(.69,.61,.48);const s=L.CreateGround("ground",{width:42,height:42},e);s.material=t,s.checkCollisions=!0,m(e,"cellFloor",{width:8,depth:6,height:.5},new r(-10,.25,0),t),m(e,"hallFloor",{width:12,depth:5,height:.5},new r(-3.5,.25,0),t),m(e,"courtyardFloor",{width:20,depth:14,height:.5},new r(7,.25,0),t),m(e,"shrineFloor",{width:6,depth:6,height:.5},new r(14,.25,0),t),[{name:"cellWallWest",size:{width:.6,height:3,depth:6},pos:new r(-14,1.5,0)},{name:"cellWallNorth",size:{width:8.6,height:3,depth:.6},pos:new r(-10,1.5,-3.3)},{name:"cellWallSouth",size:{width:8.6,height:3,depth:.6},pos:new r(-10,1.5,3.3)},{name:"hallWallNorth",size:{width:12.2,height:3,depth:.6},pos:new r(-3.5,1.5,-2.8)},{name:"hallWallSouth",size:{width:12.2,height:3,depth:.6},pos:new r(-3.5,1.5,2.8)},{name:"courtyardWallNorth",size:{width:20.4,height:3,depth:.6},pos:new r(7,1.5,-7.2)},{name:"courtyardWallSouth",size:{width:20.4,height:3,depth:.6},pos:new r(7,1.5,7.2)},{name:"courtyardWallEast",size:{width:.6,height:3,depth:14.4},pos:new r(17.2,1.5,0)}].forEach(d=>{m(e,d.name,d.size,d.pos,t)}),m(e,"cellBed",{width:2.5,depth:1.2,height:.5},new r(-12,.7,1.2),n),m(e,"clothRoll",{width:1.7,depth:.7,height:.25},new r(-12,1.08,1.2),o),m(e,"altarBase",{width:2.2,depth:1.4,height:1.1},new r(14,.8,0),n);const l=m(e,"shrineMarker",{width:.9,depth:.9,height:2.1},new r(14,1.8,0),o);return l.isPickable=!1,{ground:s,shrinePosition:l.position.clone()}}const w={movement:{walkSpeed:6,sprintSpeed:9.5,acceleration:28,deceleration:20,jumpSpeed:7.2,gravity:-18,rotationLerp:10,playerHeight:1.8},camera:{distance:6,minDistance:2.2,maxDistance:7.5,heightOffset:2.2,mouseSensitivity:.0026,pitchMin:-.7,pitchMax:.95,followLerp:14},world:{shrineTriggerRadius:2.4}};function H(e){const t=L.CreateCapsule("playerCapsule",{radius:.45,height:1.8,tessellation:12},e),n=new C("playerMaterial",e);return n.diffuseColor=new b(.89,.79,.61),t.material=n,t.ellipsoid=new r(.45,.9,.45),t.ellipsoidOffset=new r(0,.9,0),t.checkCollisions=!0,t.position=new r(-11.5,1.1,0),t}const y=new r,v=new r,f=new r,z=new r,R=new r,Y=new r(0,-1,0);function V(e,t,n){const o=H(e),s=new r(0,0,0),i=w.movement.playerHeight/2,l=.03,d=.14,a=new F(R,Y,i+.3);let c=!1;function h(){R.set(o.position.x,o.position.y+.05,o.position.z),a.length=i+.35;const u=e.pickWithRay(a,S=>S!==o&&S.checkCollisions===!0);if(!(u!=null&&u.hit)||!u.pickedPoint){c=!1;return}const g=o.position.y-i,p=u.pickedPoint.y;c=g-p<=d,c&&s.y<=0&&(s.y=0,o.position.y=p+i+l)}function P(u){const g=e.activeCamera;if(!g)return;y.copyFrom(g.getForwardRay().direction),y.y=0,y.normalize(),r.CrossToRef(r.UpReadOnly,y,v),v.normalize(),f.setAll(0),n.keys.forward&&f.addInPlace(y),n.keys.back&&f.subtractInPlace(y),n.keys.left&&f.subtractInPlace(v),n.keys.right&&f.addInPlace(v);const p=f.lengthSquared()>0;p&&f.normalize();const k=n.keys.sprint?w.movement.sprintSpeed:w.movement.walkSpeed,S=p?f.x*k:0,D=p?f.z*k:0,B=p?w.movement.acceleration:w.movement.deceleration,x=Math.min(1,B*u);if(s.x+=(S-s.x)*x,s.z+=(D-s.z)*x,h(),c&&n.consumeJumpPress()&&(s.y=w.movement.jumpSpeed,c=!1),s.y+=w.movement.gravity*u,z.set(s.x*u,s.y*u,s.z*u),o.moveWithCollisions(z),h(),p){const M=Math.atan2(f.x,f.z),W=Math.min(1,w.movement.rotationLerp*u),j=Math.atan2(Math.sin(M-o.rotation.y),Math.cos(M-o.rotation.y));o.rotation.y+=j*W}}return{mesh:o,update:P,getPosition:()=>o.position,isGrounded:()=>c}}function J(e){const t={forward:!1,back:!1,left:!1,right:!1,sprint:!1,jump:!1};let n=!1;const o=new Map([["KeyW","forward"],["KeyS","back"],["KeyA","left"],["KeyD","right"],["ShiftLeft","sprint"],["ShiftRight","sprint"]]);function s(){t.forward=!1,t.back=!1,t.left=!1,t.right=!1,t.sprint=!1,t.jump=!1,n=!1}function i(a){o.has(a.code)&&(t[o.get(a.code)]=!0),a.code==="Space"&&(a.repeat||(n=!0),t.jump=!0,a.preventDefault())}function l(a){o.has(a.code)&&(t[o.get(a.code)]=!1),a.code==="Space"&&(t.jump=!1,a.preventDefault())}function d(){s()}return window.addEventListener("keydown",i),window.addEventListener("keyup",l),window.addEventListener("blur",d),e.setAttribute("tabindex","0"),{keys:t,consumeJumpPress(){const a=n;return n=!1,a},dispose(){window.removeEventListener("keydown",i),window.removeEventListener("keyup",l),window.removeEventListener("blur",d),s()}}}function N(e,t,n){const o=w.camera,s=new r,i=new G("playerCamera",Math.PI*1.4,1.1,o.distance,n.getPosition(),e);i.attachControl(t,!0),i.lowerBetaLimit=o.pitchMin+Math.PI/2,i.upperBetaLimit=o.pitchMax+Math.PI/2,i.lowerRadiusLimit=o.minDistance,i.upperRadiusLimit=o.maxDistance,i.wheelDeltaPercentage=.01,i.angularSensibilityX=1/o.mouseSensitivity,i.angularSensibilityY=1/o.mouseSensitivity,i.checkCollisions=!0,i.collisionRadius=new r(.4,.4,.4),e.activeCamera=i;function l(){var a;document.pointerLockElement!==t&&((a=t.requestPointerLock)==null||a.call(t))}function d(a){const c=n.getPosition();s.set(c.x,c.y+o.heightOffset,c.z);const h=Math.min(1,o.followLerp*a);i.target=r.Lerp(i.target,s,h)}return{camera:i,activatePointerLock:l,update:d}}function U(){const e=document.getElementById("startScreen"),t=document.getElementById("playButton"),n=document.getElementById("hud"),o=document.getElementById("objectiveText"),s=document.getElementById("storyBox");let i=!1;function l(h){i||(i=!0,setTimeout(()=>{e.classList.remove("visible"),n.classList.remove("hidden"),h==null||h()},120))}function d(h){t.addEventListener("click",()=>l(h))}function a(h){s.textContent=h,s.classList.remove("hidden")}function c(h){o.textContent=`Objective: ${h}`}return{bindStart:d,showStory:a,setObjective:c,isPlaying:()=>i}}function q(e,t,n){let o=!1;function s(){if(o)return;const i=t.getPosition();r.Distance(i,e.shrinePosition)<=w.world.shrineTriggerRadius&&(o=!0,n.showStory("A distant bell rings. Something calls you beyond the monastery."),n.setObjective("Prototype complete"))}return{update:s,isShrineTriggered:()=>o}}function X(){const e=document.createElement("div");return e.style.position="fixed",e.style.right="12px",e.style.top="10px",e.style.padding="4px 8px",e.style.fontSize="12px",e.style.background="rgba(0,0,0,0.4)",e.style.border="1px solid rgba(255,255,255,0.15)",e.style.borderRadius="4px",e.style.color="#d8dde9",e.style.pointerEvents="none",e.textContent="FPS: --",document.body.appendChild(e),{update(t){e.textContent=`FPS: ${Math.round(t)}`}}}function Z(){const{canvas:e,engine:t,scene:n}=A();n.clearColor.set(.56,.62,.72,1);const o=new I("hemiLight",new r(0,1,0),n);o.intensity=.68,o.groundColor=new b(.26,.22,.16);const s=new T("sunLight",new r(-.4,-1,.35),n);s.intensity=1.6,s.position=new r(15,30,-10);const i=K(n),l=J(e),d=V(n,i,l),a=N(n,e,d),c=U(),h=q(i,d,c),P=X();c.bindStart(()=>{e.focus(),a.activatePointerLock()}),n.onBeforeRenderObservable.add(()=>{if(!c.isPlaying())return;const p=n.getEngine().getDeltaTime()/1e3;d.update(p),a.update(p),h.update(),P.update(n.getEngine().getFps())}),t.runRenderLoop(()=>{n.render()}),window.addEventListener("resize",()=>{t.resize()});let u=!1;const g=()=>{var p;u||(u=!0,(p=l.dispose)==null||p.call(l))};n.onDisposeObservable.add(g),window.addEventListener("beforeunload",g,{once:!0})}export{Z as createGame};
